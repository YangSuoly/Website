<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Crawler-JD</title>
    <url>/2021/10/02/Crawler-JD/</url>
    <content><![CDATA[<h1 id="introduciton">1. Introduciton</h1>
<h2 id="job-description">1.1 Job description</h2>
<p>本项目为京东评论数据爬虫。随着电子商务的发展，有如京东、淘宝等网站，在线评论作为电子口碑显著影响着产品的营销策略。</p>
<a id="more"></a>
<p>商品评论文本具有如下特点：</p>
<ol type="1">
<li>短文本。商品评论的文本一般比较简短，大部分包括用户对产品整体的评论，也包括用户对喜欢的商品属性的评价。以手机产品为例，包括“系统不错啊”、“屏幕非常清晰”、“外观时尚大气”等等的评价；</li>
<li>情感倾向明显。商品评论是针对产品整体或属性进行评价，这样是商品评论文本有着很明显的情感倾向，如“喜欢”、“差”等；</li>
<li>数据量大。电子商务网站的交易量非常大，网上的评论数据以秒为单位的速度不断的刷新，增大。面对无限大的数据，通常在分析是取一段时间内旳文本进行分析，即可获得相对全面的产品评论信息；</li>
<li>不规范性。语法不规范，口语化严重是互联网语言的一大特点，而且包含很多时下流行词汇。例如“木有”代表没有，“撒米”代表什么等等。口语化严重还包括出现很多新鲜的词汇，包括“坑爹”、“不明觉厉”、“我伙呆”等等。这些都给文本分析带来很多困难；</li>
<li>易获取性。商品评论信息比较容易获取，各大电子商务网站例如京东、淘宝、亚马逊等都提供，方便获取到评论信息。 本文所有涉及到的商品评论文本，均为京东商城牛肉产品的评论文本。</li>
</ol>
<p>本研究中，以京东商城的生牛肉类产品为例子，爬取其评论信息。</p>
<h2 id="task-analysis">1.2 Task analysis</h2>
<p>首先，我们打开我们需要提取的商品链接（<a href="https://item.jd.com/2925506.html#comment">恒都牛腱子</a>），打开开发者模式，可以发现其评论以 <code>json</code> 的形式进行存储，其链接的形式如下：<a href="https://club.jd.com/comment/productPageComments.action?callback=fetchJSON_comment98&amp;productId=2925506&amp;score=0&amp;sortType=5&amp;page=1&amp;pageSize=10&amp;isShadowSku=0&amp;rid=0&amp;fold=1">https://club.jd.com/comment/productPageComments.action?callback=fetchJSON_comment98&amp;productId=2925506&amp;score=0&amp;sortType=5&amp;page=1&amp;pageSize=10&amp;isShadowSku=0&amp;rid=0&amp;fold=1</a>。因此我们可以通过爬取该地址进行评论的筛选和处理。</p>
<p>进一步分析可以发现，该链接所对应的评论页面主要由如下参数进行控制：</p>
<ul>
<li>productId：商品 id；</li>
<li>score：评论星级数；</li>
<li>page：评论页数；</li>
</ul>
<p>了解这些信息之后，我们可以通过控制上面上个参数，用 <code>loop</code> 循环获取所有评论的数据。</p>
<h2 id="reviews-analysis">1.3 Reviews analysis</h2>
<ul>
<li><p>热评</p>
<p>通过比对文本，我们可以发现热评信息在字段 <code>hotCommentTagStatistics</code> 下，且仅有在 <code>page=1</code> 时，也就是说时在第一页评论中，才会出现热评，后面的页数不会出现热评。</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bwZLj.md.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 1 热评信息</p>
</center></li>
<li><p>用户评论</p>
<p>每个用户对商品的评论均保存在响应的字段中，如下图。读者可以根据连接中的字段和网页中的评论信息一一比对，此处便不再进行罗列。</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bwmes.md.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 2 评论信息及其字段</p>
</center></li>
</ul>
<h1 id="static-crawler">2. Static crawler</h1>
<p>由于评论信息均储存在 <code>json</code> 文件中，我们此处我们便使用静态爬虫进行爬取。</p>
<h2 id="configuration">2.1 configuration</h2>
<ul>
<li><p>Load modules</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br></pre></td></tr></table></figure></li>
<li><p>Request headers</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_head</span>():</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">            <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate, br&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh,zh-CN;q=0.9,en;q=0.8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.77 Safari/537.36&quot;</span>   </span><br><span class="line">            &#125;</span><br><span class="line">    <span class="keyword">return</span> headers</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="self-function">2.2 Self-function</h2>
<p>为了更为方便进行爬取，此处我们定义一些自定义函数。</p>
<ul>
<li><p>请求网页</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_one_url</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:        </span><br><span class="line">        response = requests.get(url)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:  <span class="comment"># 判断状态码  如果是200则请求成功            </span></span><br><span class="line">            <span class="keyword">return</span> response.text  <span class="comment"># 返回文档信息        </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>    </span><br><span class="line">    <span class="keyword">except</span> RequestException:  <span class="comment"># 捕捉异常</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure></li>
<li><p>得到 <code>productiId</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_product_id</span>(<span class="params">url</span>):</span></span><br><span class="line">    temp = url.split(<span class="string">&#x27;.htm&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    item_id = temp[<span class="number">0</span>].split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> item_id</span><br></pre></td></tr></table></figure></li>
<li><p>得到 <code>json</code> 文件的文本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_message</span>(<span class="params">url, i</span>):</span></span><br><span class="line">    r = requests.get(url, headers=get_head())</span><br><span class="line">    rtext = r.text</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        jsondata=re.search(<span class="string">&#x27;^[^(]*?\((.*)\)[^)]*$&#x27;</span>, rtext).group(<span class="number">1</span>)</span><br><span class="line">        data = json.loads(jsondata)</span><br><span class="line">        print(<span class="string">&#x27;解析第&#123;&#125;页成功!!!!&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="提取评论文本">2.3 提取评论文本</h2>
<h3 id="数据界定">2.3.1 数据界定</h3>
<p>针对评论数据，我们主要爬取两部分数据：</p>
<ol type="1">
<li><p>商品热评</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bwEQg.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 3 热评信息</p>
</center></li>
<li><p>商品评论</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bwVyQ.md.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 4 评论信息</p>
</center>
<p>针对商品评论，我们会尽可能多的保留评论的信息，所以我们保存了如下信息：</p>
<ul>
<li><code>id</code>： 评论者的 <code>id</code>；</li>
<li><code>guid</code>：评论的 <code>id</code>；</li>
<li><code>nickname</code>：昵称；</li>
<li><code>content</code>：评论内容；</li>
<li><code>creationTime</code>：评论时间 ；</li>
<li><code>score</code>：评论星级；</li>
<li><code>productColor</code>：产品颜色；</li>
<li><code>referenceName</code>；</li>
<li><code>videos_url</code>：评论视频的链接；</li>
<li><code>image_url</code>：评论图片的链接；</li>
<li><code>reply</code>；回复；</li>
</ul></li>
</ol>
<p>最终期望得到成品如下：</p>
<ol type="1">
<li>商品热评</li>
</ol>
<img src = 'https://z3.ax1x.com/2021/10/02/4bwnwn.png' style="zoom:80%;" />
<center>
Fig. 5 热评样例
</center>
<ol start="2" type="1">
<li>商品评论 <img src = 'https://z3.ax1x.com/2021/10/02/4bwMF0.png' style="zoom:80%;" /></li>
</ol>
<center>
Fig. 6 评论样例
</center>
<h3 id="定义爬取所需信息的函数">2.3.2 定义爬取所需信息的函数</h3>
<ul>
<li><p>得到评论</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_type_comments</span>(<span class="params">url</span>):</span></span><br><span class="line">    product_id = get_product_id(url)</span><br><span class="line">    pd_comments = pd.DataFrame()</span><br><span class="line">    pd_hot_comments = pd.DataFrame()</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> score <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="number">8</span>):</span><br><span class="line">        page = <span class="number">0</span></span><br><span class="line">        print(<span class="string">&#x27;---------score:&#123;&#125;---------------&#x27;</span>.<span class="built_in">format</span>(score))</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            start = pd_comments.shape[<span class="number">0</span>]</span><br><span class="line">            comment_url = <span class="string">&#x27;https://club.jd.com/comment/productPageComments.action?&#x27;</span> \</span><br><span class="line">                    <span class="string">&#x27;callback=fetchJSON_comment98&amp;productId=&#123;&#125;&amp;score=&#123;&#125;&#x27;</span> \</span><br><span class="line">                    <span class="string">&#x27;&amp;sortType=5&amp;page=&#123;&#125;&amp;pageSize=10&amp;isShadowSku=0&amp;rid=0&amp;fold=1&#x27;</span></span><br><span class="line">            comment_url = comment_url.<span class="built_in">format</span>(product_id, score, page)</span><br><span class="line">            <span class="comment"># comment_url = comment_url.format(product_id, 5, page)</span></span><br><span class="line">            comment_detail = find_message(comment_url, page)</span><br><span class="line">            <span class="keyword">if</span> comment_detail == -<span class="number">1</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">            comments = comment_detail[<span class="string">&#x27;comments&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> page == <span class="number">1</span> <span class="keyword">and</span> score == <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># 提取热点评论</span></span><br><span class="line">                np_hot_comments = np.array([<span class="string">&#x27;Hot Comments&#x27;</span>, <span class="string">&#x27;Counts&#x27;</span>])</span><br><span class="line">                hot_comments = comment_detail[<span class="string">&#x27;hotCommentTagStatistics&#x27;</span>]</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(hot_comments)):</span><br><span class="line">                    comment_name = hot_comments[i][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                    count = hot_comments[i][<span class="string">&#x27;count&#x27;</span>]</span><br><span class="line">                    np_hot_comments = np.vstack((np_hot_comments, np.array([comment_name, count])))</span><br><span class="line">                    pd_hot_comments = pd.DataFrame(np_hot_comments[<span class="number">1</span>:, :],</span><br><span class="line">                                                  columns = np_hot_comments[<span class="number">0</span>, :])         </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(comments) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(comments)):</span><br><span class="line">                need_keys = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;guid&#x27;</span>, <span class="string">&#x27;nickname&#x27;</span>, <span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;creationTime&#x27;</span>, <span class="string">&#x27;score&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;productColor&#x27;</span>, <span class="string">&#x27;referenceName&#x27;</span>]</span><br><span class="line">                <span class="keyword">for</span> key <span class="keyword">in</span> need_keys:</span><br><span class="line">                    pd_comments.loc[start+i, key] = comments[i][key]</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;afterUserComment&#x27;</span> <span class="keyword">in</span> <span class="built_in">list</span>(comments[i].keys()):</span><br><span class="line">                    after_comments_info = comments[i][<span class="string">&#x27;afterUserComment&#x27;</span>]</span><br><span class="line">                    pd_comments.loc[start+i, <span class="string">&#x27;Zhuiping_content&#x27;</span>] = after_comments_info[<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">                    pd_comments.loc[start+i, <span class="string">&#x27;Zhuiping_time&#x27;</span>] = after_comments_info[<span class="string">&#x27;created&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;replies&#x27;</span> <span class="keyword">in</span> <span class="built_in">list</span>(comments[i].keys()):</span><br><span class="line">                    replies_info = comments[i][<span class="string">&#x27;replies&#x27;</span>]</span><br><span class="line">                    length = <span class="built_in">len</span>(replies_info)</span><br><span class="line">                    <span class="keyword">if</span> length != <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">                            reply_info = replies_info[i]</span><br><span class="line">                            pd_comments.loc[start+i, <span class="string">f&#x27;Reply_<span class="subst">&#123;i&#125;</span>_content&#x27;</span>] = reply_info[<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">                            pd_comments.loc[start+i, <span class="string">f&#x27;Reply_<span class="subst">&#123;i&#125;</span>_time&#x27;</span>] = reply_info[<span class="string">&#x27;creationTime&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;images&#x27;</span> <span class="keyword">in</span> <span class="built_in">list</span>(comments[i].keys()):</span><br><span class="line">                    images_info = comments[i][<span class="string">&#x27;images&#x27;</span>]</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(images_info)):</span><br><span class="line">                        pd_comments.loc[start+i, <span class="string">f&#x27;IMG_url_<span class="subst">&#123;j&#125;</span>&#x27;</span>] = images_info[j][<span class="string">&#x27;imgUrl&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;videos&#x27;</span> <span class="keyword">in</span> <span class="built_in">list</span>(comments[i].keys()):</span><br><span class="line">                    videos_info = comments[i][<span class="string">&#x27;videos&#x27;</span>]</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(videos_info)):</span><br><span class="line">                        pd_comments.loc[start+i, <span class="string">f&#x27;Video_mainpic_<span class="subst">&#123;i&#125;</span>&#x27;</span>] = videos_info[j][<span class="string">&#x27;mainUrl&#x27;</span>]</span><br><span class="line">                        pd_comments.loc[start+i, <span class="string">f&#x27;Video_url_<span class="subst">&#123;i&#125;</span>&#x27;</span>] = videos_info[j][<span class="string">&#x27;remark&#x27;</span>]</span><br><span class="line">            count += <span class="number">1</span>         </span><br><span class="line">            page += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> count &lt;= <span class="number">50</span>:</span><br><span class="line">                time.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                count = <span class="number">0</span></span><br><span class="line">                time.sleep(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pd_comments, pd_hot_comments</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="开始爬取">2.4 开始爬取</h2>
<p>考虑到我们的项目处理并不仅仅爬取一个网址，也需要多个商品的评论数据，因此，我们对主函数做一定的修改，使之不仅可以爬取单个商品的评论，也可以爬取多个商品的评论，并保存在不同的 <code>csv</code> 文件中。</p>
<ul>
<li><p>单链爬取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">is_single = <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> is_single == <span class="literal">True</span>:  </span><br><span class="line">    url = <span class="string">&#x27;https://item.jd.com/2925506.html#comment&#x27;</span></span><br><span class="line">    pd_type_comments, pd_hot_comments = get_type_comments(url)</span><br><span class="line">    pd_type_comments.to_csv(<span class="string">&#x27;./Comments_type_1.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>, errors = <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">    pd_hot_comments.to_excel(<span class="string">&#x27;./Hot_comments.xlsx&#x27;</span>, sheet_name = get_product_id(url))</span><br></pre></td></tr></table></figure></li>
<li><p>多链接爬取</p>
<p>在实际操作过程中，我们发现多链接爬取由于 <code>request</code> 的次数太多，容易导致如下问题：</p>
<ol type="1">
<li><code>ip</code> 容易被服务器暂时拉黑（大约半小时，可以换个网继续操作）；</li>
<li>容易达到端口的最大访问次数</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">is_multi = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> is_multi == <span class="literal">True</span>:</span><br><span class="line">    urls = [<span class="string">&#x27;https://item.jd.com/2925506.html#comment&#x27;</span>, <span class="string">&#x27;https://item.jd.com/2925506.html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https://item.jd.com/100007810155.html&#x27;</span>, <span class="string">&#x27;https://item.jd.com/2925346.html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https://item.jd.com/4924290.html&#x27;</span>, <span class="string">&#x27;https://item.jd.com/6879534.html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https://item.jd.com/100006306997.html&#x27;</span>, <span class="string">&#x27;https://item.jd.com/8543963.html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https://item.jd.com/100007212087.html&#x27;</span>, <span class="string">&#x27;https://item.jd.com/5662044.html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https://item.jd.com/8543957.html&#x27;</span>,  <span class="string">&#x27;https://item.jd.com/6739532.html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https://item.jd.com/4607999.html&#x27;</span>, <span class="string">&#x27;https://item.jd.com/100006930529.html&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;https://item.jd.com/100011848484.html&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(urls)):</span><br><span class="line">        print(<span class="string">f&#x27;----------正在爬取第<span class="subst">&#123;i&#125;</span>个网页的内容------------&#x27;</span>)</span><br><span class="line">        url = urls[i]</span><br><span class="line">        pd_type_comments, pd_hot_comments = get_type_comments(url)</span><br><span class="line">        uniq = pd_type_comments[<span class="string">&#x27;content&#x27;</span>].drop_duplicates().index</span><br><span class="line">        data_drop_dup = pd_type_comments.loc[uniq, :].reset_index()</span><br><span class="line">        data_drop_dup.to_csv(<span class="string">f&#x27;./Comments_type_product_<span class="subst">&#123;i&#125;</span>-0.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>, errors = <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        pd_hot_comments.to_excel(<span class="string">f&#x27;./Hot_comments_product_<span class="subst">&#123;i&#125;</span>.xlsx&#x27;</span>, sheet_name = get_product_id(url))</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="dynamic-crawler">3 Dynamic crawler</h1>
<h2 id="description">3.1 Description</h2>
<p>除了上述数据之外，我们还需要问答数据，其数据样式如下：</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bwuoq.md.png' style="zoom:80%;" /></p>
<center>
Fig. 7 问答信息
</center>
<p>通过分析，可以发现其问答数据藏在 <code>继续查看68条回答</code> 按钮之下，通过点击可以动态加载数据，因此我们选择使用动态爬虫爬取问答数据。</p>
<h2 id="爬取问答数据">3.2 爬取问答数据</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ask_answers</span>(<span class="params">url, pages</span>):</span></span><br><span class="line">    pd_ask_answer = pd.DataFrame()</span><br><span class="line"></span><br><span class="line">    browser = webdriver.Chrome(executable_path=<span class="string">&#x27;C:\Program Files (x86)\Google\Chrome\Application\chromedriver&#x27;</span>)</span><br><span class="line">    browser.get(url)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> bt <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, pages):</span><br><span class="line">        bt_xpath = <span class="string">f&#x27;//*[@id=&quot;askAnswer&quot;]/div[2]/div[2]/div[12]/div/a[<span class="subst">&#123;bt&#125;</span>]&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            browser.find_element_by_xpath(bt_xpath).click()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>):</span><br><span class="line">            shapes = pd_ask_answer.shape</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    click_xpath = <span class="string">f&#x27;//*[@id=&quot;askAnswer&quot;]/div[2]/div[2]/div[<span class="subst">&#123;i&#125;</span>]/div[2]/div/div/a[1]&#x27;</span></span><br><span class="line">                    browser.find_element_by_xpath(click_xpath).click()</span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                question_xpath = <span class="string">f&#x27;//*[@id=&quot;askAnswer&quot;]/div[2]/div[2]/div[<span class="subst">&#123;i&#125;</span>]/div[1]/div/p&#x27;</span></span><br><span class="line">                pd_ask_answer.loc[<span class="number">0</span>, shapes[<span class="number">1</span>]+i] = browser.find_element_by_xpath(question_xpath).text</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">70</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    answer_xpath = <span class="string">f&#x27;//*[@id=&quot;askAnswer&quot;]/div[2]/div[2]/div[<span class="subst">&#123;i&#125;</span>]/div[2]/div/ul/li[<span class="subst">&#123;j&#125;</span>]/p&#x27;</span></span><br><span class="line">                    pd_ask_answer.loc[j, shapes[<span class="number">1</span>]+i] = browser.find_element_by_xpath(answer_xpath).text</span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                time.sleep(<span class="number">0.05</span>)</span><br><span class="line"></span><br><span class="line">    pd_ask_answer.to_csv(<span class="string">&#x27;./Ask_answer.csv&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>, errors = <span class="string">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>可以通过传入 <code>url</code> 和 <code>pages</code> 两个参数获取问答数据，如本案列中使用的参数如下：</p>
<ul>
<li><code>url</code>： https://item.jd.com/2925506.html#comment</li>
<li><code>pages</code>： 14</li>
</ul>
<p>传入上述函数，最终可得到成品数据如下：</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bwQYV.md.png' style="zoom:80%;" /></p>
<center>
Fig. 8 问答信息
</center>
<p>其中表头（第一行）为问题，其他行为该问题的回答。</p>
<h1 id="emotion-analysis">4. Emotion analysis</h1>
<p>接下来我们对得到的评论数据进行情感分析。</p>
<h2 id="preparation">4.1 Preparation</h2>
<h3 id="load-data">4.1.1 Load data</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">data = pd.DataFrame()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    filename = <span class="string">f&#x27;Comments_type_product_<span class="subst">&#123;i&#125;</span>.csv&#x27;</span></span><br><span class="line">    df = pd.read_csv(<span class="string">f&#x27;./Results/<span class="subst">&#123;filename&#125;</span>&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">    data = pd.concat([data, df], axis = <span class="number">0</span>, ignore_index = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份</span></span><br><span class="line">data_copy = data.copy()</span><br></pre></td></tr></table></figure>
<h2 id="preprocession">4.2 Preprocession</h2>
<p>对数据进行预处理，在本次处理中，仅处理评论文本数据。</p>
<ul>
<li><p>查看数据大小</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data.shape</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>(32419, 44)</code></pre></li>
</ul>
<p>可以发现我们爬取的数据共有 44 列，其中图片和视频占大头。</p>
<ul>
<li><p>Data description</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data.info()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 32419 entries, 0 to 32418
Data columns (total 44 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   Unnamed: 0        32419 non-null  int64  
 1   id                29885 non-null  float64
 2   guid              32419 non-null  object
 3   nickname          32419 non-null  object
 4   content           32419 non-null  object
 5   creationTime      32419 non-null  object
 6   score             32419 non-null  float64
 7   productColor      30207 non-null  object
 8   referenceName     32419 non-null  object
 9   Video_mainpic_0   500 non-null    object
 10  Video_url_0       500 non-null    object
 11  Video_mainpic_1   492 non-null    object
 12  Video_url_1       492 non-null    object
 13  Video_mainpic_2   509 non-null    object
 14  Video_url_2       509 non-null    object
 15  Video_mainpic_3   476 non-null    object
 16  Video_url_3       476 non-null    object
 17  IMG_url_0         18849 non-null  object
 18  IMG_url_1         14269 non-null  object
 19  Video_mainpic_4   460 non-null    object
 20  Video_url_4       460 non-null    object
 21  Video_mainpic_5   500 non-null    object
 22  Video_url_5       500 non-null    object
 23  Video_mainpic_6   469 non-null    object
 24  Video_url_6       469 non-null    object
 25  IMG_url_2         9757 non-null   object
 26  Video_mainpic_7   533 non-null    object
 27  Video_url_7       533 non-null    object
 28  IMG_url_3         7876 non-null   object
 29  IMG_url_4         3474 non-null   object
 30  IMG_url_5         1780 non-null   object
 31  Video_mainpic_8   503 non-null    object
 32  Video_url_8       503 non-null    object
 33  Reply_0_content   739 non-null    object
 34  Reply_0_time      739 non-null    object
 35  Zhuiping_content  2756 non-null   object
 36  Zhuiping_time     2756 non-null   object
 37  IMG_url_6         882 non-null    object
 38  Video_mainpic_9   473 non-null    object
 39  Video_url_9       473 non-null    object
 40  IMG_url_7         574 non-null    object
 41  IMG_url_8         279 non-null    object
 42  level_0           1681 non-null   float64
 43  index             20245 non-null  float64
dtypes: float64(4), int64(1), object(39)
memory usage: 10.9+ MB</code></pre></li>
<li><p>提取数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = data.loc[:, data.columns[<span class="number">1</span>:-<span class="number">2</span>]]</span><br><span class="line">data.info()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>  &lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
  RangeIndex: 32419 entries, 0 to 32418
  Data columns (total 41 columns):
   #   Column            Non-Null Count  Dtype  
  ---  ------            --------------  -----  
   0   id                29885 non-null  float64
   1   guid              32419 non-null  object
   2   nickname          32419 non-null  object
   3   content           32419 non-null  object
   4   creationTime      32419 non-null  object
   5   score             32419 non-null  float64
   6   productColor      30207 non-null  object
   7   referenceName     32419 non-null  object
   8   Video_mainpic_0   500 non-null    object
   9   Video_url_0       500 non-null    object
   10  Video_mainpic_1   492 non-null    object
   11  Video_url_1       492 non-null    object
   12  Video_mainpic_2   509 non-null    object
   13  Video_url_2       509 non-null    object
   14  Video_mainpic_3   476 non-null    object
   15  Video_url_3       476 non-null    object
   16  IMG_url_0         18849 non-null  object
   17  IMG_url_1         14269 non-null  object
   18  Video_mainpic_4   460 non-null    object
   19  Video_url_4       460 non-null    object
   20  Video_mainpic_5   500 non-null    object
   21  Video_url_5       500 non-null    object
   22  Video_mainpic_6   469 non-null    object
   23  Video_url_6       469 non-null    object
   24  IMG_url_2         9757 non-null   object
   25  Video_mainpic_7   533 non-null    object
   26  Video_url_7       533 non-null    object
   27  IMG_url_3         7876 non-null   object
   28  IMG_url_4         3474 non-null   object
   29  IMG_url_5         1780 non-null   object
   30  Video_mainpic_8   503 non-null    object
   31  Video_url_8       503 non-null    object
   32  Reply_0_content   739 non-null    object
   33  Reply_0_time      739 non-null    object
   34  Zhuiping_content  2756 non-null   object
   35  Zhuiping_time     2756 non-null   object
   36  IMG_url_6         882 non-null    object
   37  Video_mainpic_9   473 non-null    object
   38  Video_url_9       473 non-null    object
   39  IMG_url_7         574 non-null    object
   40  IMG_url_8         279 non-null    object
  dtypes: float64(2), object(39)
  memory usage: 10.1+ MB</code></pre></li>
<li><p>Select data</p>
<p>我们选取评论相关的数据作为此次处理对象。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">comments = data_copy.iloc[:, <span class="number">1</span>:<span class="number">7</span>]</span><br><span class="line">comments.head(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>id</p>
</th>
<th>
<p>guid</p>
</th>
<th>
<p>nickname</p>
</th>
<th>
<p>content</p>
</th>
<th>
<p>creationTime</p>
</th>
<th>
<p>score</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1.582772e+10</p>
</td>
<td>
<p>d495506f3df9fa9fe5af352c8ecbea3f</p>
</td>
<td>
<p>****w</p>
</td>
<td>
<p>京东自营618屯货。图方便快捷，一直在京东自营购买牛肉。这次回购的牛腱子，是用来做干切牛肉。...</p>
</td>
<td>
<p>2021-06-18 15:30:41</p>
</td>
<td>
<p>5.0</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>1.582486e+10</p>
</td>
<td>
<p>39964bbdefbf80e9b48fd004531f5665</p>
</td>
<td>
<p>小***3</p>
</td>
<td>
<p>感谢感谢京东商城提供这么好的美食产品，好吃不贵经济实惠</p>
</td>
<td>
<p>2021-06-18 05:53:15</p>
</td>
<td>
<p>5.0</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h2 id="word-frequency-analysis">4.2 Word frequency analysis</h2>
<h3 id="word-frequency">4.2.1 Word frequency</h3>
<ul>
<li><p>Count word frequency</p>
<p>将所有评论作为一个文档进行词频统计。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">comments[<span class="string">&#x27;content&#x27;</span>].to_csv(<span class="string">&#x27;./Process/content.txt&#x27;</span>, encoding = <span class="string">&#x27;gbk&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">stop_words = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&#x27;中文停用词表.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>).readlines()]</span><br><span class="line">stop_words.extend([<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\xa0&#x27;</span>, <span class="string">&#x27;\u3000&#x27;</span>, <span class="string">&#x27;\u2002&#x27;</span>, <span class="string">&#x27; &#x27;</span>,])</span><br><span class="line"><span class="comment"># stop_words.extend([&#x27;用户未填写评价内容&#x27;])</span></span><br><span class="line">jb.load_userdict(<span class="string">&#x27;./Process/jieba_dict.txt&#x27;</span>)</span><br><span class="line">jb.add_word(<span class="string">&#x27;牛腱子&#x27;</span>, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./Process/content.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> fr:</span><br><span class="line">word = jb.cut(fr.read())</span><br><span class="line"></span><br><span class="line">terms = pd.DataFrame(columns = [<span class="string">&#x27;Terms&#x27;</span>, <span class="string">&#x27;Frequence&#x27;</span>])</span><br><span class="line">terms[<span class="string">&#x27;Terms&#x27;</span>] = <span class="built_in">list</span>(data.keys())[<span class="number">1</span>:]</span><br><span class="line">terms[<span class="string">&#x27;Frequence&#x27;</span>] = <span class="built_in">list</span>(data.values())[<span class="number">1</span>:]</span><br><span class="line">terms = terms.sort_values(by = <span class="string">&#x27;Frequence&#x27;</span>, ascending = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">terms[<span class="string">&#x27;Label&#x27;</span>] = terms[<span class="string">&#x27;Terms&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="number">1</span> <span class="keyword">if</span> x <span class="keyword">in</span> stop_words <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">mod_terms = terms.loc[terms[<span class="string">&#x27;Label&#x27;</span>] == <span class="number">0</span>, [<span class="string">&#x27;Terms&#x27;</span>, <span class="string">&#x27;Frequence&#x27;</span>]]</span><br><span class="line">mod_terms.reset_index(drop = <span class="literal">True</span>).head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Terms</p>
</th>
<th>
<p>Frequence</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>牛肉</p>
</td>
<td>
<p>15919</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>买</p>
</td>
<td>
<p>15027</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>吃</p>
</td>
<td>
<p>11294</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>京东</p>
</td>
<td>
<p>11012</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>不错</p>
</td>
<td>
<p>10360</p>
</td>
</tr>
<tr>
<th>
<p>5</p>
</th>
<td>
<p>肉</p>
</td>
<td>
<p>6466</p>
</td>
</tr>
<tr>
<th>
<p>6</p>
</th>
<td>
<p>好吃</p>
</td>
<td>
<p>6250</p>
</td>
</tr>
<tr>
<th>
<p>7</p>
</th>
<td>
<p>购买</p>
</td>
<td>
<p>5738</p>
</td>
</tr>
<tr>
<th>
<p>8</p>
</th>
<td>
<p>牛腱</p>
</td>
<td>
<p>4933</p>
</td>
</tr>
<tr>
<th>
<p>9</p>
</th>
<td>
<p>做</p>
</td>
<td>
<p>4733</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>将词频分析结果存储</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mod_terms.to_csv(<span class="string">&#x27;./Process/analsis_content.csv&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p><strong>Note：</strong> 得到词频结果后，我们对一些关键词进行了指标值的分类，具体分类情况见下一章节</p></li>
</ul>
<h3 id="word-cloud">4.2.2 Word cloud</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</span><br><span class="line"></span><br><span class="line">words = <span class="string">&#x27; &#x27;</span>.join(word)</span><br><span class="line">wordcloud = WordCloud(</span><br><span class="line">    font_path=<span class="string">&quot;C:/Windows/Fonts/simkai.ttf&quot;</span>,<span class="comment">#设置字体</span></span><br><span class="line">    background_color=<span class="string">&quot;white&quot;</span>,<span class="comment">#设置背景颜色</span></span><br><span class="line">    max_font_size=<span class="number">250</span>,<span class="comment"># 设置字体最大值</span></span><br><span class="line">    max_words=<span class="number">2000</span>, <span class="comment"># 设置最大显示的字数</span></span><br><span class="line">    width=<span class="number">2800</span>, <span class="comment"># 宽</span></span><br><span class="line">    height=<span class="number">1600</span>, <span class="comment"># 高</span></span><br><span class="line">    ).generate(words)</span><br><span class="line"></span><br><span class="line">image = wordcloud.to_image()</span><br><span class="line">wordcloud.to_file(<span class="string">&#x27;./Process/ciyun.png&#x27;</span>)</span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<img src = 'https://z3.ax1x.com/2021/10/02/4bw3SU.md.png' style="zoom:80%;" />
<center>
Fig. 9 评论词云
</center>
<h2 id="feature-engineering">4.3 Feature engineering</h2>
<ul>
<li><p>对每个评论进行分词</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba <span class="keyword">as</span> jb</span><br><span class="line"></span><br><span class="line">stop_words = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&#x27;中文停用词表.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>).readlines()]</span><br><span class="line">stop_words.extend([<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\xa0&#x27;</span>, <span class="string">&#x27;\u3000&#x27;</span>, <span class="string">&#x27;\u2002&#x27;</span>, <span class="string">&#x27;&#x27;</span>,])</span><br><span class="line"><span class="comment"># stop_words.extend([&#x27;用户未填写评价内容&#x27;])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_str</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> jb.cut(x, cut_all = <span class="literal">False</span>) <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> stop_words])</span><br><span class="line"></span><br><span class="line">comments[<span class="string">&#x27;content_seg&#x27;</span>] = comments[<span class="string">&#x27;content&#x27;</span>].apply(get_str)</span><br></pre></td></tr></table></figure></li>
<li><p>查看分词的结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">comments[<span class="string">&#x27;content_seg&#x27;</span>][:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<p>Results：</p>
<pre><code>0    京东 自营 618 屯货 图 方便快捷 京东 自营 购买 牛肉 回购 牛腱子 做 干切 牛肉...
1                      感谢 感谢 京东 商城 提供 美食 产品 好吃 贵 经济 实惠
2      高压锅 不炖 太烂 吃 牛肉 感觉 慢慢 炖煮 味道 煮 机会 买 尝尝 煮 方法 不好 感觉
3                                  减肥 吃点 牛肉 买 两份 够吃 几天
4    物超所值 商品 设计 完美 外观 高大 爱不释手 客服 更是 热情 没话说 购物 满意 哈哈...
Name: content_seg, dtype: object</code></pre></li>
<li><p>加载指标分类结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_maps = pd.read_excel(<span class="string">&#x27;./Process/Analysis_content.xlsx&#x27;</span>, sheet_name = <span class="string">&#x27;Sheet2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">key_words = pd_maps[<span class="string">&#x27;Terms&#x27;</span>]</span><br><span class="line">labels = pd_maps[<span class="string">&#x27;Label&#x27;</span>]</span><br><span class="line">maps = <span class="built_in">dict</span>(<span class="built_in">zip</span>(key_words, labels))</span><br><span class="line"></span><br><span class="line">pd_maps.sample(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>Results：</p>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Terms</p>
</th>
<th>
<p>Label</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>35</p>
</th>
<td>
<p>牌子</p>
</td>
<td>
<p>品牌</p>
</td>
</tr>
<tr>
<th>
<p>74</p>
</th>
<td>
<p>差评</p>
</td>
<td>
<p>印象</p>
</td>
</tr>
<tr>
<th>
<p>25</p>
</th>
<td>
<p>味道</p>
</td>
<td>
<p>口味</p>
</td>
</tr>
<tr>
<th>
<p>33</p>
</th>
<td>
<p>品牌</p>
</td>
<td>
<p>品牌</p>
</td>
</tr>
<tr>
<th>
<p>49</p>
</th>
<td>
<p>筋</p>
</td>
<td>
<p>肉类</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>计算每个关键词在该条评论中的频次</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">frequence = [comments[<span class="string">&#x27;content_seg&#x27;</span>].apply(<span class="keyword">lambda</span> x: x.count(i)) <span class="keyword">for</span> i <span class="keyword">in</span> key_words]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key_words)):</span><br><span class="line">    comments[key_words[i]] = frequence[i]</span><br><span class="line"></span><br><span class="line">comments.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>id</p>
</th>
<th>
<p>guid</p>
</th>
<th>
<p>nickname</p>
</th>
<th>
<p>content</p>
</th>
<th>
<p>creationTime</p>
</th>
<th>
<p>score</p>
</th>
<th>
<p>content_seg</p>
</th>
<th>
<p>包装</p>
</th>
<th>
<p>活动</p>
</th>
<th>
<p>优惠</p>
</th>
<th>
<p>...</p>
</th>
<th>
<p>感觉</p>
</th>
<th>
<p>放心</p>
</th>
<th>
<p>推荐</p>
</th>
<th>
<p>还会</p>
</th>
<th>
<p>好评</p>
</th>
<th>
<p>信赖</p>
</th>
<th>
<p>失望</p>
</th>
<th>
<p>体验</p>
</th>
<th>
<p>五星</p>
</th>
<th>
<p>差评</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1.582772e+10</p>
</td>
<td>
<p>d495506f3df9fa9fe5af352c8ecbea3f</p>
</td>
<td>
<p>****w</p>
</td>
<td>
<p>京东自营618屯货。图方便快捷，一直在京东自营购买牛肉。这次回购的牛腱子，是用来做干切牛肉。...</p>
</td>
<td>
<p>2021-06-18 15:30:41</p>
</td>
<td>
<p>5.0</p>
</td>
<td>
<p>京东 自营 618 屯货 图 方便快捷 京东 自营 购买 牛肉 回购 牛腱子 做 干切 牛肉...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>1.582486e+10</p>
</td>
<td>
<p>39964bbdefbf80e9b48fd004531f5665</p>
</td>
<td>
<p>小***3</p>
</td>
<td>
<p>感谢感谢京东商城提供这么好的美食产品，好吃不贵经济实惠</p>
</td>
<td>
<p>2021-06-18 05:53:15</p>
</td>
<td>
<p>5.0</p>
</td>
<td>
<p>感谢 感谢 京东 商城 提供 美食 产品 好吃 贵 经济 实惠</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>1.582004e+10</p>
</td>
<td>
<p>7d3fe9e265681e75361982339900af6e</p>
</td>
<td>
<p>常****</p>
</td>
<td>
<p>不可使用高压锅，要不炖的太烂了，都没有吃牛肉的感觉了。还是需要慢慢炖煮，把味道煮进去最好，有...</p>
</td>
<td>
<p>2021-06-17 10:48:28</p>
</td>
<td>
<p>4.0</p>
</td>
<td>
<p>高压锅 不炖 太烂 吃 牛肉 感觉 慢慢 炖煮 味道 煮 机会 买 尝尝 煮 方法 不好 感觉</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
</tbody>
</table>
<p>
<p>3 rows × 82 columns</p>
</p>
<p>可以发现增加了75列，这75列表示该列名称所示的关键词在评论中出现的频次。</p></li>
<li><p>关键词的指标</p>
<p>对上述的关键词进行指标分类和频次加总，映射关系见 pd_maps。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">label_unq = <span class="built_in">list</span>(labels.unique())</span><br><span class="line"><span class="keyword">for</span> lab <span class="keyword">in</span> label_unq:</span><br><span class="line">    terms = pd_maps.groupby(<span class="string">&#x27;Label&#x27;</span>).get_group(lab)[<span class="string">&#x27;Terms&#x27;</span>].agg(<span class="keyword">lambda</span> x: <span class="built_in">list</span>(x.to_list()))</span><br><span class="line">    comments[<span class="string">&#x27;Top-&#x27;</span>+lab] = comments.loc[:, terms].<span class="built_in">sum</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">comments.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>id</p>
</th>
<th>
<p>guid</p>
</th>
<th>
<p>nickname</p>
</th>
<th>
<p>content</p>
</th>
<th>
<p>creationTime</p>
</th>
<th>
<p>score</p>
</th>
<th>
<p>content_seg</p>
</th>
<th>
<p>包装</p>
</th>
<th>
<p>活动</p>
</th>
<th>
<p>优惠</p>
</th>
<th>
<p>...</p>
</th>
<th>
<p>Top-口感</p>
</th>
<th>
<p>Top-口味</p>
</th>
<th>
<p>Top-派送</p>
</th>
<th>
<p>Top-品牌</p>
</th>
<th>
<p>Top-品质</p>
</th>
<th>
<p>Top-渠道</p>
</th>
<th>
<p>Top-肉类</p>
</th>
<th>
<p>Top-肉质</p>
</th>
<th>
<p>Top-物流</p>
</th>
<th>
<p>Top-印象</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1.582772e+10</p>
</td>
<td>
<p>d495506f3df9fa9fe5af352c8ecbea3f</p>
</td>
<td>
<p>****w</p>
</td>
<td>
<p>京东自营618屯货。图方便快捷，一直在京东自营购买牛肉。这次回购的牛腱子，是用来做干切牛肉。...</p>
</td>
<td>
<p>2021-06-18 15:30:41</p>
</td>
<td>
<p>5.0</p>
</td>
<td>
<p>京东 自营 618 屯货 图 方便快捷 京东 自营 购买 牛肉 回购 牛腱子 做 干切 牛肉...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>4</p>
</td>
<td>
<p>4</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>1.582486e+10</p>
</td>
<td>
<p>39964bbdefbf80e9b48fd004531f5665</p>
</td>
<td>
<p>小***3</p>
</td>
<td>
<p>感谢感谢京东商城提供这么好的美食产品，好吃不贵经济实惠</p>
</td>
<td>
<p>2021-06-18 05:53:15</p>
</td>
<td>
<p>5.0</p>
</td>
<td>
<p>感谢 感谢 京东 商城 提供 美食 产品 好吃 贵 经济 实惠</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>1.582004e+10</p>
</td>
<td>
<p>7d3fe9e265681e75361982339900af6e</p>
</td>
<td>
<p>常****</p>
</td>
<td>
<p>不可使用高压锅，要不炖的太烂了，都没有吃牛肉的感觉了。还是需要慢慢炖煮，把味道煮进去最好，有...</p>
</td>
<td>
<p>2021-06-17 10:48:28</p>
</td>
<td>
<p>4.0</p>
</td>
<td>
<p>高压锅 不炖 太烂 吃 牛肉 感觉 慢慢 炖煮 味道 煮 机会 买 尝尝 煮 方法 不好 感觉</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
</tr>
</tbody>
</table>
<p>
<p>3 rows × 96 columns</p>
</p>
<p>增加了14列一级指标。</p></li>
<li><p>生成标签</p>
<p>将 score 小于三的划分为负面评论 <code>0</code>，大于三的划分为正面评论 <code>1</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">comments[<span class="string">&#x27;Label&#x27;</span>] = comments[<span class="string">&#x27;score&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="number">1</span> <span class="keyword">if</span> x &gt;=<span class="number">3</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="tf-idf">4.4 TF-IDF</h2>
<ul>
<li><p>TP-IDF 处理</p>
<p>将评论文本数据转化为 10 维的向量数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNB</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> mlxtend.classifier <span class="keyword">import</span> StackingCVClassifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score <span class="keyword">as</span> ac</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> TruncatedSVD</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"></span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tfidf</span>(<span class="params">df, names</span>):</span></span><br><span class="line">    tfidf_enc_tmp = TfidfVectorizer(ngram_range=(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">    tfidf_vec_tmp = tfidf_enc_tmp.fit_transform(df[names])</span><br><span class="line">    svd_tag_tmp = TruncatedSVD(n_components=<span class="number">10</span>, n_iter=<span class="number">20</span>, random_state=<span class="number">2019</span>)</span><br><span class="line">    tag_svd_tmp = svd_tag_tmp.fit_transform(tfidf_vec_tmp)</span><br><span class="line">    tag_svd_tmp = pd.DataFrame(tag_svd_tmp)</span><br><span class="line">    tag_svd_tmp.columns = [<span class="string">f&#x27;<span class="subst">&#123;names&#125;</span>_svd_<span class="subst">&#123;i&#125;</span>&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    <span class="keyword">return</span> tag_svd_tmp</span><br><span class="line">    <span class="comment">#return pd.concat([df[[merge_id]], tag_svd_tmp], axis=1)</span></span><br><span class="line">    </span><br><span class="line">detail_svd = get_tfidf(comments, <span class="string">&#x27;content_seg&#x27;</span>)</span><br><span class="line">comments = pd.concat([comments, detail_svd], axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">comments.columns</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Index([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;guid&#x27;</span>, <span class="string">&#x27;nickname&#x27;</span>, <span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;creationTime&#x27;</span>, <span class="string">&#x27;score&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;content_seg&#x27;</span>, <span class="string">&#x27;包装&#x27;</span>, <span class="string">&#x27;活动&#x27;</span>, <span class="string">&#x27;优惠&#x27;</span>,</span><br><span class="line">     ...</span><br><span class="line">     <span class="string">&#x27;content_seg_svd_0&#x27;</span>, <span class="string">&#x27;content_seg_svd_1&#x27;</span>, <span class="string">&#x27;content_seg_svd_2&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;content_seg_svd_3&#x27;</span>, <span class="string">&#x27;content_seg_svd_4&#x27;</span>, <span class="string">&#x27;content_seg_svd_5&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;content_seg_svd_6&#x27;</span>, <span class="string">&#x27;content_seg_svd_7&#x27;</span>, <span class="string">&#x27;content_seg_svd_8&#x27;</span>,</span><br><span class="line">     <span class="string">&#x27;content_seg_svd_9&#x27;</span>],</span><br><span class="line">    dtype=<span class="string">&#x27;object&#x27;</span>, length=<span class="number">107</span>)</span><br></pre></td></tr></table></figure>
<p>至此，特征工程处理完毕。</p></li>
</ul>
<h2 id="lightgbm-建模分析">4.5 LightGBM 建模分析</h2>
<h2 id="lightgbm-建模分析-1">LightGBM 建模分析</h2>
<ul>
<li><p>模型定义</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_on_line</span>(<span class="params">train_, test_, pred, label,  is_shuffle=<span class="literal">True</span></span>):</span></span><br><span class="line">    n_splits = <span class="number">5</span></span><br><span class="line">    folds = KFold(n_splits=n_splits, shuffle=is_shuffle, random_state=<span class="number">1024</span>)</span><br><span class="line">    sub_preds = np.zeros((test_.shape[<span class="number">0</span>], folds.n_splits))</span><br><span class="line">    train_.loc[:, <span class="string">f&#x27;<span class="subst">&#123;label&#125;</span>_pred&#x27;</span>] = <span class="number">0</span></span><br><span class="line">    fold_importance_df = pd.DataFrame()</span><br><span class="line">    fold_importance_df[<span class="string">&quot;Feature&quot;</span>] = pred</span><br><span class="line">    print(<span class="string">f&#x27;Use <span class="subst">&#123;<span class="built_in">len</span>(pred)&#125;</span> features ...&#x27;</span>)</span><br><span class="line">    auc_scores = []</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;learning_rate&#x27;</span>: <span class="number">0.01</span>,</span><br><span class="line">        <span class="string">&#x27;boosting_type&#x27;</span>: <span class="string">&#x27;gbdt&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;objective&#x27;</span>: <span class="string">&#x27;binary&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;metric&#x27;</span>: <span class="string">&#x27;auc&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;num_leaves&#x27;</span>: <span class="number">63</span>,</span><br><span class="line">        <span class="string">&#x27;feature_fraction&#x27;</span>: <span class="number">0.8</span>,</span><br><span class="line">        <span class="string">&#x27;bagging_fraction&#x27;</span>: <span class="number">0.8</span>,</span><br><span class="line">        <span class="string">&#x27;bagging_freq&#x27;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&#x27;seed&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;bagging_seed&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;feature_fraction_seed&#x27;</span>: <span class="number">7</span>,</span><br><span class="line">        <span class="string">&#x27;min_data_in_leaf&#x27;</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="string">&#x27;nthread&#x27;</span>: -<span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;verbose&#x27;</span>: -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> n_fold, (train_idx, valid_idx) <span class="keyword">in</span> <span class="built_in">enumerate</span>(folds.split(train_.index), start=<span class="number">1</span>):</span><br><span class="line">        print(<span class="string">f&#x27;the <span class="subst">&#123;n_fold&#125;</span> training start ...&#x27;</span>)</span><br><span class="line">        train_x, train_y = train_.loc[train_idx, pred], train_.loc[train_idx, label]</span><br><span class="line">        valid_x, valid_y = train_.loc[valid_idx, pred], train_.loc[valid_idx, label]</span><br><span class="line">        print(<span class="string">f&#x27;for train user:<span class="subst">&#123;<span class="built_in">len</span>(train_idx)&#125;</span>\nfor valid user:<span class="subst">&#123;<span class="built_in">len</span>(valid_idx)&#125;</span>&#x27;</span>)</span><br><span class="line">        dtrain = lgb.Dataset(train_x, label=train_y)</span><br><span class="line">        dvalid = lgb.Dataset(valid_x, label=valid_y)</span><br><span class="line"></span><br><span class="line">        clf = lgb.train(</span><br><span class="line">            params=params,</span><br><span class="line">            train_set=dtrain,</span><br><span class="line">            num_boost_round=<span class="number">10000</span>,</span><br><span class="line">            valid_sets=[dvalid],</span><br><span class="line">            early_stopping_rounds=<span class="number">500</span>,</span><br><span class="line">            verbose_eval=<span class="number">100</span></span><br><span class="line">        )</span><br><span class="line">        sub_preds[:, n_fold - <span class="number">1</span>] = clf.predict(test_[pred], num_iteration=clf.best_iteration)</span><br><span class="line">        fold_importance_df[<span class="string">f&#x27;fold_<span class="subst">&#123;n_fold&#125;</span>_imp&#x27;</span>] = clf.feature_importance()</span><br><span class="line">        auc_scores.append(clf.best_score[<span class="string">&#x27;valid_0&#x27;</span>][<span class="string">&#x27;auc&#x27;</span>])</span><br><span class="line">        train_.loc[valid_idx, <span class="string">f&#x27;<span class="subst">&#123;label&#125;</span>_pred&#x27;</span>] = clf.predict(valid_x, num_iteration=clf.best_iteration)</span><br><span class="line"></span><br><span class="line">    five_folds = [<span class="string">f&#x27;fold_<span class="subst">&#123;f&#125;</span>_imp&#x27;</span> <span class="keyword">for</span> f <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, n_splits + <span class="number">1</span>)]</span><br><span class="line">    fold_importance_df[<span class="string">&#x27;avg_imp&#x27;</span>] = fold_importance_df[five_folds].mean(axis=<span class="number">1</span>)</span><br><span class="line">    fold_importance_df.sort_values(by=<span class="string">&#x27;avg_imp&#x27;</span>, ascending=<span class="literal">False</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">    fold_importance_df[[<span class="string">&#x27;Feature&#x27;</span>, <span class="string">&#x27;avg_imp&#x27;</span>]].to_csv(<span class="string">&#x27;./Process/feat_imp_base.csv&#x27;</span>, index=<span class="literal">False</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">    test_[<span class="string">f&#x27;<span class="subst">&#123;label&#125;</span>_pred&#x27;</span>] = np.mean(sub_preds, axis=<span class="number">1</span>).<span class="built_in">round</span>()</span><br><span class="line">    <span class="comment"># print(classification_report(test_[f&#x27;&#123;label&#125;_pred&#x27;], test_[label], digits=4))</span></span><br><span class="line">    print(<span class="string">&#x27;auc score&#x27;</span>, np.mean(auc_scores))</span><br><span class="line">    <span class="keyword">return</span> test_</span><br></pre></td></tr></table></figure></li>
<li><p>建模分析</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> KFold</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report</span><br><span class="line"></span><br><span class="line">label = <span class="string">&#x27;Label&#x27;</span></span><br><span class="line">train = train.reset_index(drop = <span class="literal">True</span>)</span><br><span class="line">test = test.reset_index(drop = <span class="literal">True</span>)</span><br><span class="line">test_pred = sub_on_line(train, test, features, label)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>Use 99 features ...
the 1 training start ...
for train user:20748
for valid user:5187
Training until validation scores don&#39;t improve for 500 rounds
[100] valid_0&#39;s auc: 0.912947
[200] valid_0&#39;s auc: 0.923455
[300] valid_0&#39;s auc: 0.932511
[400] valid_0&#39;s auc: 0.938316
[500] valid_0&#39;s auc: 0.9423
[600] valid_0&#39;s auc: 0.945808
[700] valid_0&#39;s auc: 0.948631
[800] valid_0&#39;s auc: 0.950704
[900] valid_0&#39;s auc: 0.952399
[1000]    valid_0&#39;s auc: 0.953738
[1100]    valid_0&#39;s auc: 0.95514
[1200]    valid_0&#39;s auc: 0.955977
[1300]    valid_0&#39;s auc: 0.956791
[1400]    valid_0&#39;s auc: 0.957412
[1500]    valid_0&#39;s auc: 0.957956
[1600]    valid_0&#39;s auc: 0.958558
[1700]    valid_0&#39;s auc: 0.958972
[1800]    valid_0&#39;s auc: 0.959205
[1900]    valid_0&#39;s auc: 0.959827
[2000]    valid_0&#39;s auc: 0.960179
[2100]    valid_0&#39;s auc: 0.96054
[2200]    valid_0&#39;s auc: 0.960713
[2300]    valid_0&#39;s auc: 0.960969
[2400]    valid_0&#39;s auc: 0.961075
[2500]    valid_0&#39;s auc: 0.961292
[2600]    valid_0&#39;s auc: 0.961535
[2700]    valid_0&#39;s auc: 0.961669
[2800]    valid_0&#39;s auc: 0.961738
[2900]    valid_0&#39;s auc: 0.962018
[3000]    valid_0&#39;s auc: 0.962061
[3100]    valid_0&#39;s auc: 0.962088
[3200]    valid_0&#39;s auc: 0.96215
[3300]    valid_0&#39;s auc: 0.962239
[3400]    valid_0&#39;s auc: 0.962313
[3500]    valid_0&#39;s auc: 0.9623
[3600]    valid_0&#39;s auc: 0.962196
[3700]    valid_0&#39;s auc: 0.962222
[3800]    valid_0&#39;s auc: 0.962309
[3900]    valid_0&#39;s auc: 0.962354
[4000]    valid_0&#39;s auc: 0.962443
[4100]    valid_0&#39;s auc: 0.96247
[4200]    valid_0&#39;s auc: 0.962388
[4300]    valid_0&#39;s auc: 0.962324
[4400]    valid_0&#39;s auc: 0.962444
[4500]    valid_0&#39;s auc: 0.962368
Early stopping, best iteration is:
[4067]    valid_0&#39;s auc: 0.962502
Early stopping, best iteration is:
[5067]    valid_0&#39;s auc: 0.955291 ...
auc score 0.9550347381665819</code></pre></li>
<li><p>分类结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(classification_report(test_pred[<span class="string">f&#x27;<span class="subst">&#123;label&#125;</span>_pred&#x27;</span>], test_pred[label], digits=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>
<pre><code>              precision    recall  f1-score   support

         0.0     0.7155    0.8783    0.7886       567
         1.0     0.9881    0.9665    0.9772      5917

    accuracy                         0.9588      6484
   macro avg     0.8518    0.9224    0.8829      6484
weighted avg     0.9642    0.9588    0.9607      6484</code></pre>
<p>可以发现分类结果还算不错。</p></li>
</ul>
<h1 id="conclusion">5. Conclusion</h1>
<p>至此，京东评论爬取和情感分析处理完毕。由于是个人的比赛项目，本文不提供更详细的数据，代码和部分结果已基本附上。所获取的数据仅用于比赛。图片皆为个人爬取后的数据截图，如有侵权，可联系邮箱进行删除。</p>
<p>申明：本文仅供学习和交流，请珍惜作者劳动成果，勿用作商业用途，如需商业用途或业务交流可联系邮箱 <code>e-mail:yangsuoly@qq.com</code> 进行进一步交流。</p>
]]></content>
      <categories>
        <category>Project</category>
        <category>Crawler</category>
      </categories>
      <tags>
        <tag>Crawler</tag>
        <tag>Project</tag>
      </tags>
  </entry>
  <entry>
    <title>DataAnalysis-Cleaning</title>
    <url>/2021/06/17/DataAnalysis-Cleaning/</url>
    <content><![CDATA[<p>前文已经对数据分析的基本操作进行了学习，接下来要进行数据清洗、数据特征提取、数据重构以及数据可视化的学习。</p>
<h1 id="data-cleaning">1 Data cleaning</h1>
<h2 id="load-data">1.1 Load data</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;./train.csv&#x27;</span>)</span><br><span class="line">df.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<h2 id="statistic-description">1.2 Statistic description</h2>
<h3 id="查看信息">1.2.1 查看信息</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.info()</span><br><span class="line"></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">pandas</span>.<span class="title">core</span>.<span class="title">frame</span>.<span class="title">DataFrame</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">RangeIndex</span>:</span> <span class="number">891</span> entries, <span class="number">0</span> to <span class="number">890</span></span><br><span class="line">Data columns (total <span class="number">12</span> columns):</span><br><span class="line"> <span class="comment">#   Column       Non-Null Count  Dtype  </span></span><br><span class="line">---  ------       --------------  -----  </span><br><span class="line"> <span class="number">0</span>   PassengerId  <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">1</span>   Survived     <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">2</span>   Pclass       <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">3</span>   Name         <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">4</span>   Sex          <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">5</span>   Age          <span class="number">714</span> non-null    float64</span><br><span class="line"> <span class="number">6</span>   SibSp        <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">7</span>   Parch        <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">8</span>   Ticket       <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">9</span>   Fare         <span class="number">891</span> non-null    float64</span><br><span class="line"> <span class="number">10</span>  Cabin        <span class="number">204</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">11</span>  Embarked     <span class="number">889</span> non-null    <span class="built_in">object</span></span><br><span class="line">dtypes: float64(<span class="number">2</span>), int64(<span class="number">5</span>), <span class="built_in">object</span>(<span class="number">5</span>)</span><br><span class="line">memory usage: <span class="number">83.7</span>+ KB</span><br></pre></td></tr></table></figure>
<h3 id="缺失值">1.2.2 缺失值</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.isnull().<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">PassengerId      <span class="number">0</span></span><br><span class="line">Survived         <span class="number">0</span></span><br><span class="line">Pclass           <span class="number">0</span></span><br><span class="line">Name             <span class="number">0</span></span><br><span class="line">Sex              <span class="number">0</span></span><br><span class="line">Age            <span class="number">177</span></span><br><span class="line">SibSp            <span class="number">0</span></span><br><span class="line">Parch            <span class="number">0</span></span><br><span class="line">Ticket           <span class="number">0</span></span><br><span class="line">Fare             <span class="number">0</span></span><br><span class="line">Cabin          <span class="number">687</span></span><br><span class="line">Embarked         <span class="number">2</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[[<span class="string">&#x27;Age&#x27;</span>,<span class="string">&#x27;Cabin&#x27;</span>,<span class="string">&#x27;Embarked&#x27;</span>]].head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Age
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
22.0
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
<tr>
<th>
1
</th>
<td>
38.0
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
2
</th>
<td>
26.0
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>：数值列读取数据后，空缺值的数据类型为 <code>float64</code> 所以用 <code>None</code> 一般索引不到，比较的时候最好用 <code>np.nan</code></p>
<h3 id="填充缺失值">1.2.3 填充缺失值</h3>
<p>处理缺失值一般有：</p>
<ul>
<li>用数字 <code>0</code> 进行填充</li>
<li>用均值进行填充（针对数值型）</li>
<li>用众数进行填充（多用于非数值型）</li>
<li>用特定标识符进行填充（实际处理时特殊对待）</li>
<li>对于缺失值占比太大的列直接进行剔除</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.fillna(<span class="number">0</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">    data.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
0
</td>
<td>
S
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
0
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<ul>
<li><p><code>fillna</code> 用法</p>
<p>从帮助文档可以知道，<code>fillna(value=None, method=None, axis=None, inplace=False, limit=None, downcast=None)</code>，<code>fillna</code> 包含六个参数：</p>
<ul>
<li><code>Value</code>: 用做填充的值</li>
<li><code>Method</code>: 包含 <code>backfill</code>, <code>bfill</code>, <code>pad</code>, <code>ffill</code>, <code>None</code> 五个值，默认为 <code>None</code>。
<ul>
<li><code>backfill</code>/<code>bfill</code>: 用位于缺失值索引值上的有效值进行填充，直到下一个有效值。</li>
<li><code>pad</code>/<code>ffill</code>: 用位于缺失值索引下的有效值进行填充，直到上一个有效值。</li>
</ul></li>
<li><code>axis</code>: {0 or 'index', 1 or 'columns'}</li>
<li><code>inplace</code> : bool, default False</li>
</ul></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>df = pd.DataFrame([[np.nan, <span class="number">2</span>, np.nan, <span class="number">0</span>],</span><br><span class="line">                   [<span class="number">3</span>, <span class="number">4</span>, np.nan, <span class="number">1</span>],</span><br><span class="line">                   [np.nan, np.nan, np.nan, <span class="number">5</span>],</span><br><span class="line">                   [np.nan, <span class="number">3</span>, np.nan, <span class="number">4</span>]],</span><br><span class="line">                  columns=<span class="built_in">list</span>(<span class="string">&#x27;ABCD&#x27;</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>df</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
A
</th>
<th>
B
</th>
<th>
C
</th>
<th>
D
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
NaN
</td>
<td>
2.0
</td>
<td>
NaN
</td>
<td>
0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
3.0
</td>
<td>
4.0
</td>
<td>
NaN
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2
</th>
<td>
NaN
</td>
<td>
NaN
</td>
<td>
NaN
</td>
<td>
5
</td>
</tr>
<tr>
<th>
3
</th>
<td>
NaN
</td>
<td>
3.0
</td>
<td>
NaN
</td>
<td>
4
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>df.fillna(method=<span class="string">&#x27;ffill&#x27;</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
A
</th>
<th>
B
</th>
<th>
C
</th>
<th>
D
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
NaN
</td>
<td>
2.0
</td>
<td>
NaN
</td>
<td>
0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
3.0
</td>
<td>
4.0
</td>
<td>
NaN
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3.0
</td>
<td>
4.0
</td>
<td>
NaN
</td>
<td>
5
</td>
</tr>
<tr>
<th>
3
</th>
<td>
3.0
</td>
<td>
3.0
</td>
<td>
NaN
</td>
<td>
4
</td>
</tr>
</tbody>
</table>
<h3 id="去除空值">1.2.4 去除空值</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.dropna().head(<span class="number">3</span>) <span class="comment"># 未设置 inplace参数</span></span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
3
</th>
<td>
4
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Futrelle, Mrs. Jacques Heath (Lily May Peel)
</td>
<td>
female
</td>
<td>
35.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
113803
</td>
<td>
53.1000
</td>
<td>
C123
</td>
<td>
S
</td>
</tr>
<tr>
<th>
6
</th>
<td>
7
</td>
<td>
0
</td>
<td>
1
</td>
<td>
McCarthy, Mr. Timothy J
</td>
<td>
male
</td>
<td>
54.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
17463
</td>
<td>
51.8625
</td>
<td>
E46
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<h3 id="重复值">1.2.5 重复值</h3>
<ul>
<li><p>查看重复值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[data.duplicated()]</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
</tr>
</thead>
<tbody>
</tbody>
</table></li>
<li><p>剔除重复值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = data.drop_duplicates()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.head()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Heikkinen, Miss. Laina</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>STON/O2. 3101282</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>4</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Futrelle, Mrs. Jacques Heath (Lily May Peel)</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>113803</p>
</td>
<td>
<p>53.1000</p>
</td>
<td>
<p>C123</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>5</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Allen, Mr. William Henry</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>373450</p>
</td>
<td>
<p>8.0500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h2 id="feature-analysis">1.3 Feature analysis</h2>
<p>对数据进行初步观察后可以发现，特征主要可以分为两大类：</p>
<p>数值型特征：Survived ，Pclass， Age ，SibSp， Parch， Fare，其中Survived， Pclass为离散型数值特征，Age，SibSp， Parch， Fare为连续型数值特征</p>
<p>文本型特征：Name， Sex， Cabin，Embarked， Ticket，其中Sex， Cabin， Embarked， Ticket为类别型文本特征。</p>
<p>数值型特征一般可以直接用于模型的训练，但有时候为了模型的稳定性及鲁棒性会对连续变量进行离散化。文本型特征往往需要转换成数值型特征才能用于建模分析。</p>
<h3 id="分箱操作">1.3.1 分箱操作</h3>
<ul>
<li><p>按平均进行分箱</p>
<p>将连续变量Age平均分成5个年龄段，并分别用类别变量12345表示</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;AgeBand&#x27;</span>] = pd.cut(data[<span class="string">&#x27;Age&#x27;</span>], <span class="number">5</span>, labels = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.head(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
<th>
<p>AgeBand</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
<td>
<p>2</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
<td>
<p>3</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>按数值分箱</p>
<p>将连续变量Age划分为[0,5) [5,15) [15,30) [30,50) [50,80)五个年龄段，并分别用类别变量12345表示。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;AgeBand&#x27;</span>] = pd.cut(data[<span class="string">&#x27;Age&#x27;</span>], [<span class="number">0</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">80</span>], labels = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
<th>
<p>AgeBand</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
<td>
<p>3</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
<td>
<p>4</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Heikkinen, Miss. Laina</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>STON/O2. 3101282</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
<td>
<p>3</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>按比例分箱</p>
<p>将连续变量Age按10% 30% 50% 70% 90%五个年龄段，并用分类变量12345表示</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;AgeBand&#x27;</span>] = pd.cut(data[<span class="string">&#x27;Age&#x27;</span>], [<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">0.9</span>], labels = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
<th>
<p>AgeBand</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Heikkinen, Miss. Laina</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>STON/O2. 3101282</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h3 id="提取字符特征">1.3.2 提取字符特征</h3>
<p>从纯文本 <code>Name</code> 特征里提取出 <code>Titles</code> 的特征( <code>Mr, Miss, Mrs</code> 等)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;Title&#x27;</span>] = data.Name.<span class="built_in">str</span>.extract(<span class="string">&#x27;([A-Za-z]+)\.&#x27;</span>, expand=<span class="literal">False</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.head()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
<th>
Sex_female
</th>
<th>
Sex_male
</th>
<th>
Embarked_C
</th>
<th>
Embarked_Q
</th>
<th>
Embarked_S
</th>
<th>
Title
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
2
</td>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
<td>
Mr
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
1
</td>
<td>
1
</td>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
Mrs
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
2
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
<td>
Miss
</td>
</tr>
<tr>
<th>
3
</th>
<td>
4
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Futrelle, Mrs. Jacques Heath (Lily May Peel)
</td>
<td>
female
</td>
<td>
35.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
113803
</td>
<td>
53.1000
</td>
<td>
C123
</td>
<td>
2
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
<td>
Mrs
</td>
</tr>
<tr>
<th>
4
</th>
<td>
5
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Allen, Mr. William Henry
</td>
<td>
male
</td>
<td>
35.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
373450
</td>
<td>
8.0500
</td>
<td>
NaN
</td>
<td>
2
</td>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
<td>
Mr
</td>
</tr>
</tbody>
</table>
<h2 id="type-transformation">1.4 Type transformation</h2>
<p>查看文本变量的信息。</p>
<ul>
<li><p><code>value_counts</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;Sex&#x27;</span>].value_counts()</span><br><span class="line"></span><br><span class="line">male      <span class="number">577</span></span><br><span class="line">female    <span class="number">314</span></span><br><span class="line">Name: Sex, dtype: int64</span><br></pre></td></tr></table></figure></li>
<li><p><code>unique</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;Sex&#x27;</span>].unique()</span><br><span class="line"></span><br><span class="line">array([<span class="string">&#x27;male&#x27;</span>, <span class="string">&#x27;female&#x27;</span>], dtype=<span class="built_in">object</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="判别式方式">1.4.1 判别式方式</h3>
<p>将性别转换未数值型数据，用 0 表示男性，1 表示女性。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = data_copy.copy()</span><br><span class="line">    data.loc[data[<span class="string">&#x27;Sex&#x27;</span>] == <span class="string">&#x27;male&#x27;</span>, <span class="string">&#x27;Sex&#x27;</span>] = <span class="number">0</span> <span class="comment"># &#x27;male&#x27; -&gt; 0</span></span><br><span class="line">    data.loc[data[<span class="string">&#x27;Sex&#x27;</span>] == <span class="string">&#x27;female&#x27;</span>, <span class="string">&#x27;Sex&#x27;</span>] = <span class="number">1</span> <span class="comment"># &#x27;female&#x27; -&gt; 1</span></span><br><span class="line">    data.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
0
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
1
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
1
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<h3 id="replace-方法">1.4.2 <code>replace</code> 方法：</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = data_copy.copy()</span><br><span class="line">    data[<span class="string">&#x27;Sex_num&#x27;</span>] = data[<span class="string">&#x27;Sex&#x27;</span>].replace([<span class="string">&#x27;male&#x27;</span>,<span class="string">&#x27;female&#x27;</span>],[<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line">    data.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
<th>
Sex_num
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
1
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
<td>
2
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
<h3 id="map-方法">1.4.3 <code>map</code> 方法</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = data_copy.copy()</span><br><span class="line">    data[<span class="string">&#x27;Sex_num&#x27;</span>] = data[<span class="string">&#x27;Sex&#x27;</span>].<span class="built_in">map</span>(&#123;<span class="string">&#x27;male&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;female&#x27;</span>: <span class="number">2</span>&#125;)</span><br><span class="line">    data.head()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
<th>
Sex_num
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
1
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
<td>
2
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
2
</td>
</tr>
<tr>
<th>
3
</th>
<td>
4
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Futrelle, Mrs. Jacques Heath (Lily May Peel)
</td>
<td>
female
</td>
<td>
35.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
113803
</td>
<td>
53.1000
</td>
<td>
C123
</td>
<td>
S
</td>
<td>
2
</td>
</tr>
<tr>
<th>
4
</th>
<td>
5
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Allen, Mr. William Henry
</td>
<td>
male
</td>
<td>
35.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
373450
</td>
<td>
8.0500
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
<h3 id="labelencoder">1.4.4 <code>labelEncoder</code></h3>
<p>使用<code>sklearn.preprocessing.labelEncoder</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelEncoder</span><br><span class="line"></span><br><span class="line">    data = data_copy.copy()</span><br><span class="line">    <span class="keyword">for</span> feat <span class="keyword">in</span> [<span class="string">&#x27;Cabin&#x27;</span>, <span class="string">&#x27;Ticket&#x27;</span>]:</span><br><span class="line">        lbl = LabelEncoder()  </span><br><span class="line">        label_dict = <span class="built_in">dict</span>(<span class="built_in">zip</span>(data[feat].unique(), <span class="built_in">range</span>(data[feat].nunique())))</span><br><span class="line">        data[feat + <span class="string">&quot;_labelEncode&quot;</span>] = data[feat].<span class="built_in">map</span>(label_dict)</span><br><span class="line">        <span class="comment"># data[feat + &quot;_labelEncode&quot;] = lbl.fit_transform(data[feat].astype(str))</span></span><br><span class="line"></span><br><span class="line">    data.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
<th>
Cabin_labelEncode
</th>
<th>
Ticket_labelEncode
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
0.0
</td>
<td>
0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
<td>
1.0
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
0.0
</td>
<td>
2
</td>
</tr>
</tbody>
</table>
<p>其中，<code>label_dict</code> 是个字典类型，其 <code>key</code> 值表示真实值，即 <code>data[feat].unique()</code>，而对应的数值为 <code>range(data[feat].nunique()</code> 产生的序列。</p>
<p><strong>一点小差异：</strong></p>
<p>从上述代码可以发现，有两种实现方式：</p>
<ul>
<li><p><code>map</code> 方式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[feat].<span class="built_in">map</span>(label_dict).values[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], dtype=int64)</span><br></pre></td></tr></table></figure></li>
<li><p><code>labelEncoder</code> 方式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>lbl.fit_transform(data[feat].astype(<span class="built_in">str</span>))[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">array([<span class="number">523</span>, <span class="number">596</span>, <span class="number">669</span>,  <span class="number">49</span>, <span class="number">472</span>])</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>Note:</strong></p>
<p>可以发现，虽然两种方式都能产生同样的效果，当时生成数值编码的方式存在些许差异，第一种方式为按顺序生成，第二种会打乱顺序。</p>
<h3 id="ont-hot-编码">1.4.5 <code>ont-hot</code> 编码</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = data_copy.copy()</span><br><span class="line">    <span class="keyword">for</span> feat <span class="keyword">in</span> [<span class="string">&quot;Sex&quot;</span>, <span class="string">&quot;Embarked&quot;</span>]:</span><br><span class="line">        x = pd.get_dummies(data[feat], prefix=feat)</span><br><span class="line">        data = pd.concat([data, x], axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># data[feat] = pd.get_dummies(data[feat], prefix=feat)</span></span><br><span class="line"></span><br><span class="line">    data.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
<th>
Sex_female
</th>
<th>
Sex_male
</th>
<th>
Embarked_C
</th>
<th>
Embarked_Q
</th>
<th>
Embarked_S
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
<td>
1
</td>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
<p>对于 <code>age</code>，可考虑如下的方式进行处理。</p>
<ul>
<li><p>整除</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd.get_dummies(data[<span class="string">&quot;Age&quot;</span>] // <span class="number">6</span>)[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>0.0</p>
</th>
<th>
<p>1.0</p>
</th>
<th>
<p>2.0</p>
</th>
<th>
<p>3.0</p>
</th>
<th>
<p>4.0</p>
</th>
<th>
<p>5.0</p>
</th>
<th>
<p>6.0</p>
</th>
<th>
<p>7.0</p>
</th>
<th>
<p>8.0</p>
</th>
<th>
<p>9.0</p>
</th>
<th>
<p>10.0</p>
</th>
<th>
<p>11.0</p>
</th>
<th>
<p>12.0</p>
</th>
<th>
<p>13.0</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>分箱</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd.get_dummies(pd.cut(data[<span class="string">&#x27;Age&#x27;</span>],<span class="number">5</span>))[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>(0.34, 16.336]</p>
</th>
<th>
<p>(16.336, 32.252]</p>
</th>
<th>
<p>(32.252, 48.168]</p>
</th>
<th>
<p>(48.168, 64.084]</p>
</th>
<th>
<p>(64.084, 80.0]</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h1 id="data-reconstruction">2 Data reconstruction</h1>
<p>前面已经学习了 <code>Pandas</code> 基础和数据清洗，只有数据变得相对干净，之后对数据的分析才可以更有力。本节要做的是数据重构，数据重构依旧属于数据理解（准备）的范围。</p>
<h2 id="data-merge">2.1 Data merge</h2>
<p>数据合并内容之前已经进行了详细的记录，此处便不进行赘述，具体可以查看本人的博客内容，链接： <a href="https://www.yangsuoly.com/2020/11/27/Pandas/">Pandas的Chaper 4 Merge dataframes</a></p>
<h2 id="aggregae-operation">2.2 Aggregae operation</h2>
<ul>
<li><p>计算男女平均票价</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>fare_sex  = data[<span class="string">&#x27;Fare&#x27;</span>].groupby(data[<span class="string">&#x27;Sex&#x27;</span>])</span><br><span class="line">    fare_sex.mean()</span><br><span class="line"></span><br><span class="line">Sex</span><br><span class="line">female    <span class="number">44.479818</span></span><br><span class="line">male      <span class="number">25.523893</span></span><br><span class="line">Name: Fare, dtype: float64</span><br></pre></td></tr></table></figure></li>
<li><p>计算男女存活人数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;Survived&#x27;</span>].groupby(data[<span class="string">&#x27;Sex&#x27;</span>]).<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">Sex</span><br><span class="line">female    <span class="number">233</span></span><br><span class="line">male      <span class="number">109</span></span><br><span class="line">Name: Survived, dtype: int64</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>结论</strong>：可以发现，女性票价远大于男性，其次，女性存活率大于男性。</p>
<h3 id="aggregate-函数">2.2.1 Aggregate 函数</h3>
<p>此外，上述操作还可以通过 <code>agg</code> 函数进行计算。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.groupby(<span class="string">&#x27;Sex&#x27;</span>).agg(&#123;<span class="string">&#x27;Fare&#x27;</span>: <span class="string">&#x27;mean&#x27;</span>, <span class="string">&#x27;Pclass&#x27;</span>: <span class="string">&#x27;count&#x27;</span>&#125;).rename(columns=</span><br><span class="line">                            &#123;<span class="string">&#x27;Fare&#x27;</span>: <span class="string">&#x27;mean_fare&#x27;</span>, <span class="string">&#x27;Pclass&#x27;</span>: <span class="string">&#x27;count_pclass&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
mean_fare
</th>
<th>
count_pclass
</th>
</tr>
<tr>
<th>
Sex
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
female
</th>
<td>
44.479818
</td>
<td>
314
</td>
</tr>
<tr>
<th>
male
</th>
<td>
25.523893
</td>
<td>
577
</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>:</p>
<p><code>agg()</code> 函数主要有两个参数：</p>
<ol type="1">
<li><code>func</code>: function, str, list or dict. Function to use for aggregating the data. If a function, must eitherwork when passed a DataFrame or when passed to DataFrame.apply. e.g. mean, median, prod, sum, std, var.</li>
<li><code>axis</code>: default is 0 or 'index', operating based on all columns.</li>
</ol>
<h3 id="其他函数">2.2.2 其他函数</h3>
<ul>
<li><p>统计不同等级的票中，不同年龄的船票花费的平均价格</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.groupby([<span class="string">&#x27;Pclass&#x27;</span>,<span class="string">&#x27;Age&#x27;</span>])[<span class="string">&#x27;Fare&#x27;</span>].mean()</span><br><span class="line"></span><br><span class="line">Pclass  Age  </span><br><span class="line"><span class="number">1</span>       <span class="number">0.92</span>     <span class="number">151.5500</span></span><br><span class="line">        <span class="number">2.00</span>     <span class="number">151.5500</span></span><br><span class="line">        <span class="number">4.00</span>      <span class="number">81.8583</span></span><br><span class="line">        <span class="number">11.00</span>    <span class="number">120.0000</span></span><br><span class="line">        <span class="number">14.00</span>    <span class="number">120.0000</span></span><br><span class="line">                   ...   </span><br><span class="line"><span class="number">3</span>       <span class="number">61.00</span>      <span class="number">6.2375</span></span><br><span class="line">        <span class="number">63.00</span>      <span class="number">9.5875</span></span><br><span class="line">        <span class="number">65.00</span>      <span class="number">7.7500</span></span><br><span class="line">        <span class="number">70.50</span>      <span class="number">7.7500</span></span><br><span class="line">        <span class="number">74.00</span>      <span class="number">7.7750</span></span><br><span class="line">Name: Fare, Length: <span class="number">182</span>, dtype: float64</span><br></pre></td></tr></table></figure></li>
<li><p>不同年龄的存活人数</p>
<p>得出不同年龄的总的存活人数，然后找出存活人数的最高的年龄，最后计算存活人数最高的存活率（存活人数/总人数）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>survived_age = data[<span class="string">&#x27;Survived&#x27;</span>].groupby(data[<span class="string">&#x27;Age&#x27;</span>]).<span class="built_in">sum</span>()</span><br><span class="line">    survived_age.head()</span><br><span class="line"></span><br><span class="line">Age</span><br><span class="line"><span class="number">0.42</span>    <span class="number">1</span></span><br><span class="line"><span class="number">0.67</span>    <span class="number">1</span></span><br><span class="line"><span class="number">0.75</span>    <span class="number">2</span></span><br><span class="line"><span class="number">0.83</span>    <span class="number">2</span></span><br><span class="line"><span class="number">0.92</span>    <span class="number">1</span></span><br><span class="line">Name: Survived, dtype: int64</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>survived_age[survived_age.values == survived_age.<span class="built_in">max</span>()]</span><br><span class="line"></span><br><span class="line">Age</span><br><span class="line"><span class="number">24.0</span>    <span class="number">15</span></span><br><span class="line">Name: Survived, dtype: int64</span><br></pre></td></tr></table></figure>
<p>总人数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;Survived&#x27;</span>].<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line"><span class="number">342</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>sum_temp = data[<span class="string">&#x27;Survived&#x27;</span>].<span class="built_in">sum</span>()</span><br><span class="line">    print(<span class="string">&#x27;最大存活率为：&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(survived_age.<span class="built_in">max</span>()/sum_temp))</span><br><span class="line"></span><br><span class="line">最大存活率为：<span class="number">0.043859649122807015</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="stack-to-series">2.3 Stack to series</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.stack()</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>    PassengerId                          <span class="number">1</span></span><br><span class="line">     Survived                             <span class="number">0</span></span><br><span class="line">     Pclass                               <span class="number">3</span></span><br><span class="line">     Name           Braund, Mr. Owen Harris</span><br><span class="line">     Sex                               male</span><br><span class="line">                             ...           </span><br><span class="line"><span class="number">890</span>  Sex_male                             <span class="number">1</span></span><br><span class="line">     Embarked_C                           <span class="number">0</span></span><br><span class="line">     Embarked_Q                           <span class="number">1</span></span><br><span class="line">     Embarked_S                           <span class="number">0</span></span><br><span class="line">     Title                               Mr</span><br><span class="line">Length: <span class="number">15172</span>, dtype: <span class="built_in">object</span></span><br></pre></td></tr></table></figure>
<p>探究 <code>stack</code> 函数的功能：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.stack().shape</span><br><span class="line"></span><br><span class="line">(<span class="number">15172</span>,)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; unit_result.head()</span><br><span class="line"></span><br><span class="line">0  Unnamed: 0                           0</span><br><span class="line">   PassengerId                          1</span><br><span class="line">   Survived                             0</span><br><span class="line">   Pclass                               3</span><br><span class="line">   Name           Braund, Mr. Owen Harris</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="number">891</span>*<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">16038</span></span><br></pre></td></tr></table></figure>
<p>可以发现，<code>stack</code> 函数的作用是将数据表中的每一行都转化为一个 <code>Series</code>，共计 <code>891</code> 个 <code>Series</code>，其形状为 <code>15172</code> 行，我们注意到 <span class="math inline">\(891 \times 18 = 16038\)</span>，之间相差一些，是因为 <code>data</code> 中存在部分缺失值。</p>
<h1 id="data-visualization">3 Data visualization</h1>
<p>前文中，已经对基本数据结构有了了解，也学了一些基本的统计方法、数据清洗和重构。本章节中主要学习 <strong>数据可视化</strong>，主要给大家介绍一下 <code>Python</code> 数据可视化库 <code>Matplotlib</code>。</p>
<p>本章节的内容可以通过查阅 《Python for Data Analysis》第九章 进行更深入的学习。</p>
<ul>
<li><p>Import modules</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>%matplotlib inline</span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="柱状图">3.1 柱状图</h2>
<h3 id="简单柱状图">3.1.1 简单柱状图</h3>
<p>可视化展示泰坦尼克号数据集中男女中生存人数分布情况。</p>
<ul>
<li><p>生存情况</p>
<p>由于 <code>Survived = 0</code> 表示死亡，<code>Survived = 1</code> 表示生存，所以使用 <code>sum</code> 函数可以统计生存人数情况。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>sex = data.groupby(<span class="string">&#x27;Sex&#x27;</span>)[<span class="string">&#x27;Survived&#x27;</span>].<span class="built_in">sum</span>()</span><br><span class="line">    sex.plot.bar()</span><br><span class="line">    plt.title(<span class="string">&#x27;survived_count&#x27;</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/06/19/RPLMyd.png" /></p></li>
<li><p>死亡情况</p>
<p>对于死亡人数，可以使用判别式 <code>data['Survived'] != 1</code> 来得到死亡人数的索引，之后用 <code>count</code> 函数进行人数统计。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>sex = data[data[<span class="string">&#x27;Survived&#x27;</span>] != <span class="number">1</span>].groupby(<span class="string">&#x27;Sex&#x27;</span>).Survived.count()</span><br><span class="line">    sex.plot.bar()</span><br><span class="line">    plt.title(<span class="string">&#x27;survived_count&#x27;</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/06/19/RPLKQH.png" /></p></li>
<li><p>合并分析</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.groupby([<span class="string">&#x27;Sex&#x27;</span>,<span class="string">&#x27;Survived&#x27;</span>])[<span class="string">&#x27;Survived&#x27;</span>].count().unstack().plot(kind=<span class="string">&#x27;bar&#x27;</span>,stacked=<span class="string">&#x27;True&#x27;</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;survived_count&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Text(<span class="number">0</span>, <span class="number">0.5</span>, <span class="string">&#x27;count&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/06/19/RPLuSe.png" /></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.groupby([<span class="string">&#x27;Sex&#x27;</span>,<span class="string">&#x27;Survived&#x27;</span>])[<span class="string">&#x27;Survived&#x27;</span>].count().unstack()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
<p>Survived</p>
</th>
<th>
<p>0</p>
</th>
<th>
<p>1</p>
</th>
</tr>
<tr>
<th>
<p>Sex</p>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>female</p>
</th>
<td>
<p>81</p>
</td>
<td>
<p>233</p>
</td>
</tr>
<tr>
<th>
<p>male</p>
</th>
<td>
<p>468</p>
</td>
<td>
<p>109</p>
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.groupby([<span class="string">&#x27;Sex&#x27;</span>,<span class="string">&#x27;Survived&#x27;</span>])[<span class="string">&#x27;Survived&#x27;</span>].count()</span><br><span class="line"></span><br><span class="line">Sex     Survived</span><br><span class="line">female  <span class="number">0</span>            <span class="number">81</span></span><br><span class="line">        <span class="number">1</span>           <span class="number">233</span></span><br><span class="line">male    <span class="number">0</span>           <span class="number">468</span></span><br><span class="line">        <span class="number">1</span>           <span class="number">109</span></span><br><span class="line">Name: Survived, dtype: int64</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>Note:</strong></p>
<p>上文简单介绍了 <code>stack</code> 函数，是将整个数据表的每一行转化为一个 <code>pd.Series</code>，而在此处，通过对比上述两行代码，可以发现，<code>unstack()</code> 的作用是反向操作，将 <code>count</code> 函数得到的 <code>Series</code> 转化为 <code>pd.DataFrame</code> 类型。</p>
<h3 id="分层柱状图">3.2.1 分层柱状图</h3>
<p>可视化展示泰坦尼克号数据集中不同仓位等级的人生存和死亡人员的分布情况。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; pclass_sur &#x3D; text.groupby([&#39;Pclass&#39;])[&#39;Survived&#39;].value_counts()</span><br><span class="line">&gt;&gt;&gt; pclass_sur</span><br><span class="line"></span><br><span class="line">Pclass  Survived</span><br><span class="line">1       1           136</span><br><span class="line">        0            80</span><br><span class="line">2       0            97</span><br><span class="line">        1            87</span><br><span class="line">3       0           372</span><br><span class="line">        1           119</span><br><span class="line">Name: Survived, dtype: int64</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line">    sns.countplot(x=<span class="string">&quot;Pclass&quot;</span>, hue=<span class="string">&quot;Survived&quot;</span>, data=text)</span><br><span class="line"></span><br><span class="line">&lt;AxesSubplot:xlabel=<span class="string">&#x27;Pclass&#x27;</span>, ylabel=<span class="string">&#x27;count&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/06/19/RPLeJO.png" /></p>
<h2 id="折线图">3.2 折线图</h2>
<h3 id="普通折线图">3.2.1 普通折线图</h3>
<p>可视化展示泰坦尼克号数据集中不同票价的人生存和死亡人数分布情况（横轴是不同票价，纵轴是存活人数）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>fare_sur = data.groupby(<span class="string">&#x27;Fare&#x27;</span>)[<span class="string">&#x27;Survived&#x27;</span>].value_counts().sort_values(ascending = <span class="literal">False</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>fare_sur</span><br><span class="line"></span><br><span class="line">Fare     Survived</span><br><span class="line"><span class="number">8.0500</span>   <span class="number">0</span>           <span class="number">38</span></span><br><span class="line"><span class="number">7.8958</span>   <span class="number">0</span>           <span class="number">37</span></span><br><span class="line"><span class="number">13.0000</span>  <span class="number">0</span>           <span class="number">26</span></span><br><span class="line"><span class="number">7.7500</span>   <span class="number">0</span>           <span class="number">22</span></span><br><span class="line"><span class="number">13.0000</span>  <span class="number">1</span>           <span class="number">16</span></span><br><span class="line">                     ..</span><br><span class="line"><span class="number">7.7417</span>   <span class="number">0</span>            <span class="number">1</span></span><br><span class="line"><span class="number">26.2833</span>  <span class="number">1</span>            <span class="number">1</span></span><br><span class="line"><span class="number">7.7375</span>   <span class="number">1</span>            <span class="number">1</span></span><br><span class="line"><span class="number">26.3875</span>  <span class="number">1</span>            <span class="number">1</span></span><br><span class="line"><span class="number">22.5250</span>  <span class="number">0</span>            <span class="number">1</span></span><br><span class="line">Name: Survived, Length: <span class="number">330</span>, dtype: int64</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 排序后绘折线图</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>fig = plt.figure(figsize=(<span class="number">20</span>, <span class="number">18</span>))</span><br><span class="line">    fare_sur.plot(grid=<span class="literal">True</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/06/19/RPLZFK.png" /></p>
<h3 id="核密度图">3.2.2 核密度图</h3>
<p>可视化展示泰坦尼克号数据集中不同年龄的人生存与死亡人数分布情况</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>facet = sns.FacetGrid(text, hue=<span class="string">&quot;Survived&quot;</span>,aspect=<span class="number">3</span>)</span><br><span class="line">    facet.<span class="built_in">map</span>(sns.kdeplot,<span class="string">&#x27;Age&#x27;</span>,shade= <span class="literal">True</span>)</span><br><span class="line">    facet.<span class="built_in">set</span>(xlim=(<span class="number">0</span>, text[<span class="string">&#x27;Age&#x27;</span>].<span class="built_in">max</span>()))</span><br><span class="line">    facet.add_legend()</span><br><span class="line"></span><br><span class="line">&lt;seaborn.axisgrid.FacetGrid at <span class="number">0x1fe9191cc70</span>&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/06/19/RPLQOA.png" /></p>
<h3 id="多个图形">3.2.3 多个图形</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.Age[data.Pclass == <span class="number">1</span>].plot(kind=<span class="string">&#x27;kde&#x27;</span>)</span><br><span class="line">    data.Age[data.Pclass == <span class="number">2</span>].plot(kind=<span class="string">&#x27;kde&#x27;</span>)</span><br><span class="line">    data.Age[data.Pclass == <span class="number">3</span>].plot(kind=<span class="string">&#x27;kde&#x27;</span>)</span><br><span class="line">    plt.xlabel(<span class="string">&quot;age&quot;</span>)</span><br><span class="line">    plt.legend((<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),loc=<span class="string">&quot;best&quot;</span>)</span><br><span class="line"></span><br><span class="line">&lt;matplotlib.legend.Legend at <span class="number">0x1fe919a5d00</span>&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/06/19/RPL1eI.png" /></p>
<p><strong>Note:</strong></p>
<p>到这里，可视化就告一段落啦，后期可进一步了解其他可视化模块，如：<code>pyecharts</code>，<code>bokeh</code> 等。</p>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Data Analysis</category>
      </categories>
      <tags>
        <tag>Data Analysis</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Crawler-qcc</title>
    <url>/2021/10/02/Crawler-qcc/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<h2 id="job-description">1.1 Job description</h2>
<p>本项目为企查查注册企业信息爬取，项目来源是别人的实验需求。故本博客会对项目的具体数据进行脱敏处理，其中涉及的 1168 个链接本文不进行提供，也不提供成品数据。</p>
<a id="more"></a>
<p>读者如需类似信息，可以借助本博客提供的方法自行爬取。注：部分公司和企业家信息需要 VIP 账户方能进行爬取。</p>
<p>免责声明：本文仅供参考和交流，仅记录数据爬取过程中所使用的方法和问题的解决方法，如有侵权，请联系 <code>e-mail:yangsuoly@qq.com</code>。</p>
<p>任务爬取所需工具：</p>
<ol type="1">
<li>企查查 VIP 账户</li>
<li>Python 3.8</li>
</ol>
<h2 id="task-requirements">1.2 Task requirements</h2>
<p>网站：企查查（共1168个链接-Excel表），链接样例： https://www.qcc.com/pl/p43ce90f8f80f49f4089ab2e9040dece.html</p>
<h3 id="企业家信息">1.2.1 企业家信息</h3>
<ul>
<li><p>所有企业表</p>
<p>抓取企业家在哪些企业有股份(即他的所有企业表，如下图所示)：抓取的内容包括序号、企业名称、企业名称对应的url(第二个任务会用到)以及其余的整个表的内容。</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCMXq.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 1 所有企业表</p>
</center></li>
<li><p>在外任职表</p>
<p>抓取企业家在哪些企业有管理职位(在外任职表，如下图所示)：同样的抓取的内容包括序号、企业名称以及对应的url、以及职位等表格内容。</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCln0.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 2 在外任职表</p>
</center></li>
</ul>
<h3 id="公司信息">1.2.2 公司信息</h3>
<p>爬取企业家旗下每一家企业信息(即他的所有企业表中的所有公司的信息，如 Fig.1 所示)的信息：</p>
<ul>
<li><p>营业执照信息</p>
<p>企业的基本注册信息</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCu1s.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 3 营业执照信息</p>
</center></li>
<li><p>股东信息</p>
<p>企业的股东信息(点击url显示如下表)，包括：每一位股东的名字 + 股份 + 每一位股东的URL</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bC37T.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 4 公司股东信息</p>
</center></li>
<li><p>主要人员</p>
<p>企业管理者信息，包括：名字 + 股份(if applicable) + 职务 +每一位管理者的URL</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCKcn.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 5 主要人员信息</p>
</center></li>
</ul>
<h3 id="公司知识产权信息">1.2.3 公司知识产权信息</h3>
<p>企业的知识产权信息(点击相同url后，点击知识产权)</p>
<ul>
<li><p>专利信息</p>
<p>包含专利信息一栏的所有信息</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCGAU.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 6 专利信息</p>
</center></li>
<li><p>软件著作权</p>
<p>包含软件著作权一栏的所有信息</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCJNF.png' style="zoom:80%;" /></p></li>
<li><p>其他</p>
<p>如资质证书、作品著作权。</p></li>
</ul>
<h1 id="static-crawler">2 Static crawler</h1>
<p>在爬取之前，对需要爬取的链接进行初步地分析，我们发现，索要爬取的信息存在如下特点：</p>
<ol type="1">
<li>大多数内容数量少于 10 条，少部分公司的词条（如专利证书）数量会大于10。</li>
<li>高管的 <code>url</code> 链接都以 <code>pl</code> 开头，公司的基本信息的 <code>url</code> 以 <code>cbase</code> 开头，而知识产权信息以 <code>cassets</code> 开头。</li>
<li>各项信息在网页中（如果存在该词条）存在都有规律，且存在一直的 <code>id</code> 节点，因此可以通过 <code>id</code> 对元素进行定位（<code>id</code> 是页面中唯一的标识）</li>
<li>企查查的反爬虫机制较为严格，需要适用虚拟 <code>ip</code> 和控制请求的时间来规避反爬虫，本文只是用最简单的控制请求的时间来规避爬虫机制。</li>
</ol>
<p>得到上述信息之后，我们考虑先用静态爬虫来进行信息的提取，之后适用动态爬虫来补充遗漏的数据。同时，文中也会附上 <code>ip</code> 代理池的生成方法，感兴趣的可以自行适用代理池进行虚拟 <code>ip</code> 的设置。</p>
<h2 id="configuration">2.1 Configuration</h2>
<ul>
<li><p>Import modules</p>
<p>首先导入如下模块，如果没有的，自行适用 <code>pip install module_name</code> 进行安装。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> swifter</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br></pre></td></tr></table></figure></li>
<li><p>Set request headers</p>
<p>设置请求头：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> headers = &#123;</span><br><span class="line">  <span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;www.qcc.com&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;Connection&#x27;</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;Accept&#x27;</span>:<span class="string">r&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.164 Safari/537.36&quot;</span>,</span><br><span class="line">  <span class="string">&#x27;Accept-Encoding&#x27;</span>:<span class="string">&#x27;gzip, deflate, br&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;Accept-Language&#x27;</span>:<span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;Cookie&#x27;</span>:<span class="string">&quot;QCCSESSID= ; qcc_did= ; zg_did= ; acw_tc= ; zg_294c2ba1ecc244809c552f8f6fd2a440= &quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于爬取过程中需要 <code>VIP</code> 账户的权限，因此我们适用了本地浏览器的 <code>Cookie</code>，此处已经对 <code>Cookie</code> 信息进行脱敏，读者自行载入自己浏览器的 <code>Cookie</code> 信息，本文全程适用 <code>Google Chrome 92.0.4515.107</code> 进行数据爬取，此处以 <code>Chrome</code> 浏览器为例，其他浏览器 <code>Cookie</code> 信息载入方法大同小异。</p>
<p>进入企查查官网，并进行登录，只有有两种方式得到 <code>Cookie</code>，分别法如下：</p>
<ol type="1">
<li><p>利用设置</p>
<p>打开 <code>all cookies and site data</code> 界面 <a href="chrome://settings/siteData">chrome://settings/siteData</a>，搜查 <code>qcc</code> 将搜过结果对应字段的值粘贴到上述 <code>Cookie</code> 中等号的右边（如<code>QCCSESSID</code>）</p>
<p>搜索结果如下图所示：</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCYh4.png' style="zoom:80%;" /></p></li>
<li><p>利用开发者模式</p>
<p>进入企查查官网，登录之后，按 <code>F12</code> 或右键 <code>审视</code> 打开开发者模式，依次点击 <code>Network</code>，<code>Fetch/XHR</code>，之后算便点击其中一个链接，找到 <code>Headers</code> 中的 <code>cookie</code> 字段的信息，进行复制。如下图所示：</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bC1BV.png' style="zoom:80%;" /></p></li>
</ol></li>
<li><p>Set data path and load data</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pl_root_dir = <span class="string">r&#x27;D:\Demo\work\XMU\Data_Collection\Results\Results/&#x27;</span></span><br><span class="line">pd_firm = pd.read_csv(<span class="string">&#x27;./FirmList.csv&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>其中，<code>FirmList.csv</code> 仅包含1168条公司 <code>url</code> 信息，由于涉及他人实验和论文信息，本文不进行公开，仅提供 5 个样本供学习交流。读者可自行寻找一些公司的 <code>url</code> 进行尝试。</p>
<p><a id="download" href="https://www.aliyundrive.com/s/2pB62oUL4sv" target="_blank"><i class="fa fa-download"></i><span> Download FirmList </span> </a></p></li>
</ul>
<h2 id="自定义函数">2.2 自定义函数</h2>
<p>接下来，对所需要爬取的各项数据进行拆解和爬取。</p>
<h3 id="企业家所属信息">2.2.1 企业家所属信息</h3>
<p>通过 <code>id</code> 我们可以定位许多信息，如</p>
<ul>
<li><code>allcompanylist</code>: 所有企业信息;</li>
<li><code>postofficelist</code>: 在外任职信息；</li>
<li><code>legallist</code>: 担任法定代表人信息;</li>
<li><code>holdcolist</code>: 控制企业</li>
</ul>
<p>由于本项目的任务只需要前两个，故设置 <code>n_info</code> 为 <code>2</code> 爬取前两个信息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pl_data</span>(<span class="params">soup</span>):</span></span><br><span class="line">    list_ids = [<span class="string">&#x27;allcompanylist&#x27;</span>, <span class="comment"># 他的所有企业表</span></span><br><span class="line">                 <span class="string">&#x27;postofficelist&#x27;</span>, <span class="comment"># 在外任职表</span></span><br><span class="line">                 <span class="string">&#x27;legallist&#x27;</span>, <span class="comment"># 担任法定代表人</span></span><br><span class="line">                 <span class="string">&#x27;holdcolist&#x27;</span> <span class="comment"># 控制企业    </span></span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">    n_info = <span class="number">2</span> <span class="comment"># 爬取他的所有企业和在外任职信息</span></span><br><span class="line">    list_pd = []</span><br><span class="line">    <span class="keyword">for</span> com_id <span class="keyword">in</span> list_ids[:n_info]:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            html_table = soup.find_all(<span class="string">&#x27;div&#x27;</span>, <span class="built_in">id</span> = com_id)[<span class="number">0</span>] <span class="comment"># 他的所有企业表</span></span><br><span class="line"></span><br><span class="line">            pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table.table)))[<span class="number">0</span>] <span class="comment"># 得到公司信息</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                html_table = soup.find_all(<span class="string">&#x27;div&#x27;</span>, <span class="built_in">id</span> = <span class="string">&#x27;his&#x27;</span> + com_id)[<span class="number">0</span>] <span class="comment"># 他的所有企业表</span></span><br><span class="line">                pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table.table)))[<span class="number">0</span>] <span class="comment"># 得到公司信息</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                pd_comp = pd.DataFrame()</span><br><span class="line">        hyper_comps = html_table.find_all(<span class="string">&#x27;a&#x27;</span>, class_ = <span class="string">&#x27;text-blue&#x27;</span>)</span><br><span class="line">        dict_comps = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> hyper_comps:</span><br><span class="line">            <span class="keyword">if</span> h.text <span class="keyword">in</span> dict_comps.keys():</span><br><span class="line">                dict_comps[h.text + <span class="string">&#x27;1&#x27;</span>] = h[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dict_comps[h.text] = h[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ix <span class="keyword">in</span> <span class="built_in">range</span>(pd_comp.shape[<span class="number">0</span>], <span class="built_in">len</span>(dict_comps.keys())):</span><br><span class="line">            pd_comp.loc[ix, <span class="string">&#x27;Name&#x27;</span>] = np.nan</span><br><span class="line"></span><br><span class="line">        pd_comp[<span class="string">&#x27;Name&#x27;</span>] = dict_comps.keys()</span><br><span class="line">        pd_comp[<span class="string">&#x27;url&#x27;</span>] = dict_comps.values()</span><br><span class="line">        pd_comp[<span class="string">&#x27;url&#x27;</span>] = pd_comp[<span class="string">&#x27;url&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="string">&#x27;https://www.qcc.com&#x27;</span> + x)</span><br><span class="line"></span><br><span class="line">        list_pd.append(pd_comp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> list_pd[<span class="number">0</span>], list_pd[<span class="number">1</span>] <span class="comment"># 输出到 n_info-1</span></span><br></pre></td></tr></table></figure>
<h3 id="公司所属信息">2.2.2 公司所属信息</h3>
<p>类似的，可以通过 <code>id</code> 定位公司信息：</p>
<ul>
<li><code>cominfo</code>: 营业执照信息；</li>
<li><code>partner</code>: 股东信息；</li>
<li><code>mainmember</code>: 主要人员；</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_firm_data</span>(<span class="params">name_urls, sep, pl_dir</span>):</span></span><br><span class="line">    list_ids = [<span class="string">&#x27;cominfo&#x27;</span>, <span class="comment"># 营业执照信息</span></span><br><span class="line">                 <span class="string">&#x27;partner&#x27;</span>, <span class="comment"># 股东信息</span></span><br><span class="line">                 <span class="string">&#x27;mainmember&#x27;</span>, <span class="comment">#  主要人员</span></span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">    num_partner_id = [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    part_keys = [<span class="string">&#x27;股东信息&#x27;</span>, <span class="string">&#x27;主要人员&#x27;</span>]</span><br><span class="line">    part_numbers = [<span class="number">0</span>, <span class="number">0</span>] <span class="comment"># 所述块的位置</span></span><br><span class="line">    dic_partners = <span class="built_in">dict</span>(<span class="built_in">zip</span>(part_keys, part_numbers))</span><br><span class="line"></span><br><span class="line">    csv_names = [<span class="string">&#x27;营业执照信息&#x27;</span>, <span class="string">&#x27;股东信息&#x27;</span>, <span class="string">&#x27;主要人员&#x27;</span>]</span><br><span class="line">    name = name_urls.split(sep)[<span class="number">0</span>] <span class="comment"># 得到公司名字，用来作为存储的文件名</span></span><br><span class="line">    url = name_urls.split(sep)[<span class="number">1</span>] <span class="comment"># 得到公司 url 并转化为基本信息链接</span></span><br><span class="line">    firm_url = url.split(<span class="string">&#x27;firm&#x27;</span>)</span><br><span class="line">    url = firm_url[<span class="number">0</span>] + <span class="string">&#x27;cbase&#x27;</span> + firm_url[<span class="number">1</span>] <span class="comment"># 进入公司基本信息界面</span></span><br><span class="line"></span><br><span class="line">    html = requests.get(url, headers = headers).text</span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    list_pd = []</span><br><span class="line">    <span class="keyword">for</span> i, com_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(list_ids):</span><br><span class="line">        html_table = soup.find_all(<span class="string">&#x27;section&#x27;</span>, <span class="built_in">id</span> = com_id)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                html_table = html_table[<span class="number">0</span>]</span><br><span class="line">                pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table.table)))[<span class="number">0</span>] <span class="comment"># 得到公司信息</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(html_table) &gt; <span class="number">0</span>:</span><br><span class="line">                html_table = html_table[<span class="number">0</span>]</span><br><span class="line">                pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table.table)))[<span class="number">0</span>]</span><br><span class="line">                hyper_comps = html_table.find_all(<span class="string">&#x27;a&#x27;</span>, target = <span class="string">&#x27;_blank&#x27;</span>)</span><br><span class="line">                dict_comps = <span class="built_in">dict</span>()</span><br><span class="line">                <span class="keyword">for</span> h <span class="keyword">in</span> hyper_comps:</span><br><span class="line">                    dict_comps[h.text] = h[<span class="string">&#x27;href&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                num_partners = html_table.find_all(<span class="string">&#x27;span&#x27;</span>, class_ = <span class="string">&#x27;tbadge&#x27;</span>)</span><br><span class="line">                part_numbers[i-<span class="number">1</span>] = num_partners[num_partner_id[i-<span class="number">1</span>]].text</span><br><span class="line">                dic_partners[part_keys[i-<span class="number">1</span>]] = part_numbers[i-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> dic_partners[part_keys[i-<span class="number">1</span>]] == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                    dic_partners[part_keys[i-<span class="number">1</span>]] = pd_comp.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> pd_comp.shape[<span class="number">0</span>] &lt;= <span class="built_in">len</span>(dict_comps.keys()):</span><br><span class="line">                    <span class="keyword">for</span> ix <span class="keyword">in</span> <span class="built_in">range</span>(pd_comp.shape[<span class="number">0</span>], <span class="built_in">len</span>(dict_comps.keys())):</span><br><span class="line">                        pd_comp.loc[ix, <span class="string">&#x27;Name&#x27;</span>] = np.nan</span><br><span class="line"></span><br><span class="line">                    pd_comp[<span class="string">&#x27;Name&#x27;</span>] = dict_comps.keys()</span><br><span class="line">                    pd_comp[<span class="string">&#x27;url&#x27;</span>] = dict_comps.values()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(dict_comps.keys()) != <span class="number">0</span>:</span><br><span class="line">                        pd_comp.loc[<span class="number">0</span>:<span class="built_in">len</span>(dict_comps.keys())-<span class="number">1</span>, <span class="string">&#x27;Name&#x27;</span>] = dict_comps.keys()</span><br><span class="line">                        pd_comp.loc[<span class="number">0</span>:<span class="built_in">len</span>(dict_comps.keys())-<span class="number">1</span>, <span class="string">&#x27;url&#x27;</span>] = dict_comps.values()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dic_partners[part_keys[i-<span class="number">1</span>]] = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        firm_path = pl_dir +  <span class="string">&#x27;/&#x27;</span> + name</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(firm_path):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            os.makedirs(firm_path)</span><br><span class="line">        firm_dir = firm_path + <span class="string">&#x27;/&#x27;</span> + csv_names[i] + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">        pd_comp.to_csv(firm_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">10</span>) <span class="comment"># 休眠 10 s</span></span><br><span class="line">    <span class="keyword">return</span> dic_partners</span><br></pre></td></tr></table></figure>
<h3 id="公司专利信息">2.2.3 公司专利信息</h3>
<p><code>zhuanlilist</code>: 专利信息; <code>zhengshulist</code>: 资质证书; <code>rjzzqlist</code>: 软件著作权; <code>zzqlist</code>: 作品著作权</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_casset_data</span>(<span class="params">name_urls, sep, pl_dir</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;专利信息：zhuanlilist</span></span><br><span class="line"><span class="string">        资质证书：zhengshulist</span></span><br><span class="line"><span class="string">        软件著作权：rjzzqlist</span></span><br><span class="line"><span class="string">        作品著作权：zzqlist</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    list_ids = [<span class="string">&#x27;zhuanlilist&#x27;</span>, <span class="string">&#x27;zhengshulist&#x27;</span>, <span class="string">&#x27;rjzzqlist&#x27;</span>, <span class="string">&#x27;zzqlist&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    cas_keys = [<span class="string">&#x27;专利信息&#x27;</span>, <span class="string">&#x27;资质证书&#x27;</span>, <span class="string">&#x27;软件著作权&#x27;</span>, <span class="string">&#x27;作品著作权&#x27;</span>]</span><br><span class="line">    cas_numbers = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    dic_cassets = <span class="built_in">dict</span>(<span class="built_in">zip</span>(cas_keys, cas_numbers))</span><br><span class="line"></span><br><span class="line">    name = name_urls.split(sep)[<span class="number">0</span>]</span><br><span class="line">    casset_path = pl_dir +  <span class="string">&#x27;/&#x27;</span> + name</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(casset_path):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        os.makedirs(casset_path)</span><br><span class="line"></span><br><span class="line">    url = name_urls.split(sep)[<span class="number">1</span>]</span><br><span class="line">    firm_url = url.split(<span class="string">&#x27;firm&#x27;</span>)</span><br><span class="line">    url = firm_url[<span class="number">0</span>] + <span class="string">&#x27;cassets&#x27;</span> + firm_url[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    html = requests.get(url, headers = headers).text</span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    list_pd = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, com_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(list_ids):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            html_table = soup.find_all(<span class="string">&#x27;section&#x27;</span>, <span class="built_in">id</span> = com_id)[<span class="number">0</span>] <span class="comment"># 专利信息</span></span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                txt = html_table.find(<span class="string">&#x27;div&#x27;</span>, class_ = <span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line">                pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(txt)))[<span class="number">0</span>] <span class="comment"># 专利信息</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table.table)))[<span class="number">0</span>] <span class="comment"># 得到公司信息</span></span><br><span class="line"></span><br><span class="line">            casset_dir = casset_path + <span class="string">&#x27;/&#x27;</span> + cas_keys[i] + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">            pd_comp.to_csv(casset_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            cas_numbers[i] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            html_table = soup.find_all(<span class="string">&#x27;section&#x27;</span>, <span class="built_in">id</span> = com_id)[<span class="number">0</span>] <span class="comment"># 专利信息</span></span><br><span class="line">            casset_infos = html_table.find_all(<span class="string">&#x27;div&#x27;</span>, class_ = <span class="string">&#x27;tcaption&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(casset_infos) == <span class="number">0</span>:</span><br><span class="line">                cas_numbers[i] = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">len</span>(casset_infos) == <span class="number">1</span>:</span><br><span class="line">                cassets = casset_infos[<span class="number">0</span>]</span><br><span class="line">                title = BeautifulSoup(<span class="built_in">str</span>(casset_infos[<span class="number">0</span>]), <span class="string">&#x27;lxml&#x27;</span>).find_all(<span class="string">&#x27;h3&#x27;</span>, class_ = <span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> title[<span class="number">0</span>].text == cas_keys[i]:</span><br><span class="line">                    cas_numbers[i] = BeautifulSoup(<span class="built_in">str</span>(casset_infos[<span class="number">0</span>]), <span class="string">&#x27;lxml&#x27;</span>).find_all(<span class="string">&#x27;span&#x27;</span>, class_ = <span class="string">&#x27;tbadge&#x27;</span>)[<span class="number">0</span>].text</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">len</span>(casset_infos) &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">for</span> cassets <span class="keyword">in</span> casset_infos:</span><br><span class="line">                    cassets = casset_infos[<span class="number">0</span>]</span><br><span class="line">                    title = BeautifulSoup(<span class="built_in">str</span>(casset_infos[<span class="number">0</span>]), <span class="string">&#x27;lxml&#x27;</span>).find_all(<span class="string">&#x27;h3&#x27;</span>, class_ = <span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> title[<span class="number">0</span>].text == cas_keys[i]:</span><br><span class="line">                        cas_numbers[i] = BeautifulSoup(<span class="built_in">str</span>(casset_infos[<span class="number">0</span>]), <span class="string">&#x27;lxml&#x27;</span>).find_all(<span class="string">&#x27;span&#x27;</span>, class_ = <span class="string">&#x27;tbadge&#x27;</span>)[<span class="number">0</span>].text</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">&gt;         <span class="keyword">except</span>:</span><br><span class="line">            cas_numbers[i] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        dic_cassets[cas_keys[i]] = cas_numbers[i]</span><br><span class="line">    time.sleep(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">return</span> dic_cassets</span><br></pre></td></tr></table></figure>
<h3 id="建立-ip-池">2.2.4 建立 IP 池</h3>
<p>可以通过如下的程序来建立个人的免费代理 <code>IP</code> 池子。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 建立属于自己的开放代理IP池</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IpPool</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 测试ip是否可用url</span></span><br><span class="line">        self.test_url = <span class="string">&#x27;http://httpbin.org/get&#x27;</span></span><br><span class="line">        <span class="comment"># 获取IP的 目标url</span></span><br><span class="line">        self.url = <span class="string">&#x27;https://www.89ip.cn/index_&#123;&#125;.html&#x27;</span></span><br><span class="line"></span><br><span class="line">        self.headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: UserAgent().random&#125;</span><br><span class="line">        <span class="comment"># 存储可用ip</span></span><br><span class="line">        self.file = <span class="built_in">open</span>(<span class="string">&#x27;ip_pool.txt&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_html</span>(<span class="params">self, url</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;获取页面&#x27;&#x27;&#x27;</span></span><br><span class="line">        html = requests.get(url=url, headers=self.headers).text</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_proxy</span>(<span class="params">self, url</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;数据处理  获取ip 和端口&#x27;&#x27;&#x27;</span></span><br><span class="line">        html = self.get_html(url=url)</span><br><span class="line">        <span class="comment"># print(html)</span></span><br><span class="line"></span><br><span class="line">        elemt = etree.HTML(html)</span><br><span class="line"></span><br><span class="line">        ips_list = elemt.xpath(<span class="string">&#x27;//table/tbody/tr/td[1]/text()&#x27;</span>)</span><br><span class="line">        ports_list = elemt.xpath(<span class="string">&#x27;//table/tbody/tr/td[2]/text()&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ip, port <span class="keyword">in</span> <span class="built_in">zip</span>(ips_list, ports_list):</span><br><span class="line">            <span class="comment"># 拼接ip与port</span></span><br><span class="line">            proxy = ip.strip() + <span class="string">&quot;:&quot;</span> + port.strip()</span><br><span class="line">            <span class="comment"># print(proxy)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 175.44.109.195:9999</span></span><br><span class="line">            self.test_proxy(proxy)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_proxy</span>(<span class="params">self, proxy</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;测试代理IP是否可用&#x27;&#x27;&#x27;</span></span><br><span class="line">        proxies = &#123;</span><br><span class="line">            <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(proxy),</span><br><span class="line">            <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(proxy),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 参数类型</span></span><br><span class="line">        <span class="comment"># proxies</span></span><br><span class="line">        <span class="comment"># proxies = &#123;&#x27;协议&#x27;: &#x27;协议://IP:端口号&#x27;&#125;</span></span><br><span class="line">        <span class="comment"># timeout 超时设置 网页响应时间3秒 超过时间会抛出异常</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url=self.test_url, proxies=proxies, headers=self.headers, timeout=<span class="number">3</span>)</span><br><span class="line">           <span class="comment"># 获取 状态码为200</span></span><br><span class="line">            <span class="keyword">if</span> resp.status_code == <span class="number">200</span>:</span><br><span class="line">                print(proxy, <span class="string">&#x27;\033[31m可用\033[0m&#x27;</span>)</span><br><span class="line">                <span class="comment"># 可以的IP 写入文本以便后续使用</span></span><br><span class="line">                self.file.write(proxy)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(proxy, <span class="string">&#x27;不可用&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(proxy, <span class="string">&#x27;不可用&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawl</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;执行函数&#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># 快代理每页url 的区别</span></span><br><span class="line">        <span class="comment"># https://www.kuaidaili.com/free/inha/1/</span></span><br><span class="line">        <span class="comment"># https://www.kuaidaili.com/free/inha/2/</span></span><br><span class="line">        <span class="comment"># .......</span></span><br><span class="line">        <span class="comment"># 提供的免费ip太多</span></span><br><span class="line">        <span class="comment"># 这里只获取前100页提供的免费代理IP测试</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>):</span><br><span class="line">            <span class="comment"># 拼接完整的url</span></span><br><span class="line">            page_url = self.url.<span class="built_in">format</span>(i)</span><br><span class="line">            <span class="comment"># 注意抓取控制频率</span></span><br><span class="line">            time.sleep(random.randint(<span class="number">1</span>, <span class="number">4</span>))</span><br><span class="line">            self.get_proxy(url=page_url)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 执行完毕关闭文本</span></span><br><span class="line">        self.file.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ip = IpPool()</span><br><span class="line">    ip.crawl()</span><br></pre></td></tr></table></figure>
<h2 id="start-program">2.3 Start program</h2>
<p>考虑到程序可能会由于异常情况而终止，我们设置了起始点，只需要对 <code>start</code> 的值进行更改，便可在上一次的基础上进行爬取。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start = <span class="number">0</span> <span class="comment"># 接着上次爬取的序号</span></span><br><span class="line"><span class="keyword">for</span> ix, url <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_firm[<span class="string">&#x27;url&#x27;</span>].values[start:]):</span><br><span class="line">    i = start + ix <span class="comment"># 更改 index 值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置代理 ip</span></span><br><span class="line">    proxies = &#123;</span><br><span class="line">            <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;47.98.179.39:8080&#x27;</span>),</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    html = requests.get(url, headers = headers, proxies = proxies).text</span><br><span class="line">    soup = BeautifulSoup(html, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    name = soup.find_all(<span class="string">&#x27;h1&#x27;</span>, class_ = <span class="string">&#x27;row title jk-tip&#x27;</span>)[<span class="number">0</span>].text.strip() <span class="comment"># 得到企业家的名字</span></span><br><span class="line"></span><br><span class="line">    pl_dir = pl_root_dir + <span class="string">f&#x27;<span class="subst">&#123;i&#125;</span>.<span class="subst">&#123;name&#125;</span>&#x27;</span> <span class="comment"># 以企业家的名字作为文件夹的名字保存信息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(pl_dir):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        os.makedirs(pl_dir) <span class="comment"># 如果该文件目录不存在，则新建文件夹</span></span><br><span class="line"></span><br><span class="line">    all_comp, post_of_comp = get_pl_data(soup) <span class="comment"># 调用 2.2.1 节的 get_pl_data 函数</span></span><br><span class="line"></span><br><span class="line">    post_of_comp_path = pl_dir + <span class="string">f&#x27;/<span class="subst">&#123;name&#125;</span>-在外任职表.csv&#x27;</span> <span class="comment"># 保存路径</span></span><br><span class="line">    post_of_comp.to_csv(post_of_comp_path, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>) <span class="comment"># 保存在外任职表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将名字和路径保存至 pd_firm 中</span></span><br><span class="line">    pd_firm.loc[i, <span class="string">&#x27;企业家名字&#x27;</span>] = name  </span><br><span class="line">    pd_firm.loc[i, <span class="string">&#x27;在外任职目录&#x27;</span>] = post_of_comp_path</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 借助apply函数爬取所有企业信息</span></span><br><span class="line">    sep = <span class="string">&#x27;&lt;break&gt;&#x27;</span></span><br><span class="line">    all_comp[<span class="string">&#x27;Name_com&#x27;</span>] = all_comp[<span class="string">&#x27;企业名称&#x27;</span>] + sep + (all_comp[<span class="string">&#x27;url&#x27;</span>])</span><br><span class="line">    all_comp[<span class="string">&#x27;Firm_info&#x27;</span>] = all_comp[<span class="string">&#x27;Name_com&#x27;</span>].apply(<span class="keyword">lambda</span> x: get_firm_data(x, sep, pl_dir))</span><br><span class="line">    all_comp[<span class="string">&#x27;Casset_info&#x27;</span>] = all_comp[<span class="string">&#x27;Name_com&#x27;</span>].apply(<span class="keyword">lambda</span> x: get_casset_data(x, sep, pl_dir))</span><br><span class="line"></span><br><span class="line">    all_comp[<span class="string">&#x27;股东数&#x27;</span>] = all_comp[<span class="string">&#x27;Firm_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: x[<span class="built_in">list</span>(x.keys())[<span class="number">0</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;主要人员数&#x27;</span>] = all_comp[<span class="string">&#x27;Firm_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: x[<span class="built_in">list</span>(x.keys())[<span class="number">1</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;专利信息数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: x[<span class="built_in">list</span>(x.keys())[<span class="number">0</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;资质证书数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: x[<span class="built_in">list</span>(x.keys())[<span class="number">1</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;软件著作权数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: x[<span class="built_in">list</span>(x.keys())[<span class="number">2</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;作品著作权数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: x[<span class="built_in">list</span>(x.keys())[<span class="number">3</span>]])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存所有企业信息</span></span><br><span class="line">    all_comp_path = pl_dir + <span class="string">f&#x27;/<span class="subst">&#123;name&#125;</span>-所有企业表.csv&#x27;</span></span><br><span class="line">    pd_firm.loc[i, <span class="string">&#x27;所有企业目录&#x27;</span>] = all_comp_path</span><br><span class="line">    all_comp.drop(<span class="string">&#x27;Name_com&#x27;</span>, axis = <span class="number">1</span>).to_csv(all_comp_path, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f&#x27;已经爬取<span class="subst">&#123;i&#125;</span>个企业家名单...&#x27;</span>)</span><br><span class="line">    pd_firm.to_csv(<span class="string">&#x27;FirmList.csv&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>) <span class="comment"># 每次爬取一个企业家之后进行保存</span></span><br><span class="line">    time.sleep(<span class="number">20</span>) <span class="comment"># 休眠，反爬虫</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<pre><code>已经爬取0个企业家名单...
已经爬取1个企业家名单...
已经爬取2个企业家名单...
已经爬取3个企业家名单...
已经爬取4个企业家名单...
...</code></pre>
<h2 id="data-cleaning">2.4 Data cleaning</h2>
<h3 id="更正公司数量信息">2.4.1 更正公司数量信息</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_current_dir</span>(<span class="params">file_dir, all_comp_path</span>):</span></span><br><span class="line">    cur_dir = file_dir</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> all_comp_path.split(<span class="string">&#x27;/&#x27;</span>)[:-<span class="number">1</span>]:</span><br><span class="line">        <span class="keyword">if</span> i == file_dir:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cur_dir = cur_dir + <span class="string">&#x27;/&#x27;</span> + i</span><br><span class="line"></span><br><span class="line">    cur_dir = cur_dir + <span class="string">&#x27;/&#x27;</span>  </span><br><span class="line">    <span class="keyword">return</span> cur_dir</span><br></pre></td></tr></table></figure>
<ul>
<li><p>产看数和表格中的记录数是否相同</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file_dir = <span class="string">&#x27;D:\\Demo\\work\\XMU\\Data_Collection\\Results&#x27;</span></span><br><span class="line">sep = <span class="string">&#x27;&lt;break&gt;&#x27;</span></span><br><span class="line">error_idx = []</span><br><span class="line"><span class="keyword">for</span> i, relat_path <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_firm[<span class="string">&#x27;所有企业目录&#x27;</span>].values):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        name = relat_path.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        error_idx.append(i)</span><br><span class="line">        print(i, relat_path, sep = <span class="string">&#x27;\t | \t&#x27;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    all_comp_path = file_dir + relat_path</span><br><span class="line">    all_comp = pd.read_csv(all_comp_path, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cur_dir = get_current_dir(file_dir, all_comp_path)</span><br><span class="line">    sub_dirs = os.listdir(cur_dir)</span><br><span class="line"></span><br><span class="line">    records_len = all_comp.shape[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(sub_dirs) - <span class="number">2</span> != records_len):</span><br><span class="line">        error_idx.append(i)</span><br><span class="line">        print(i, relat_path, sep = <span class="string">&#x27;\t | \t&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<pre><code>  683  |  nan
  747  |  /Results/747.朱俊/朱俊-所有企业表.csv
  868  |  /Results/868.杨大伟/杨大伟-所有企业表.csv
  991  |  /Results/991.刘学高/刘学高-所有企业表.csv</code></pre>
<p>可以发现有4个数据表格中的企业数和爬取的不同。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_firm.loc[error_idx, <span class="string">&#x27;url&#x27;</span>].values</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<pre><code>  array([&#39;https://www.qcc.com/pl/pr06c1505288f0c2021d813c9e7f332f.html&#39;,
         &#39;https://www.qcc.com/pl/pc73f5a2f9eb17be99d0ef4cf0f0991b.html&#39;,
         &#39;https://www.qcc.com/pl/pa26bc685636ad55bc1a11b5b7d42828.html&#39;,
         &#39;https://www.qcc.com/pl/p12d778b91113fa1209cdb2394bb4a65.html&#39;],
          dtype=object)</code></pre>
<p>进一步查看发现：</p>
<ul>
<li>683 孙月洋 信息缺失</li>
<li>747 朱俊 旗下两家公司信息重叠</li>
<li>868 杨大伟 旗下两家公司信息重叠</li>
<li>991 刘学高 旗下两家公司信息重叠</li>
</ul>
<p>因此对后面三家进行重新爬取</p></li>
<li><p>重新爬取三个企业家的信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file_dir = <span class="string">&#x27;D:\\Demo\\work\\XMU\\Data_Collection\\Results&#x27;</span></span><br><span class="line">sep = <span class="string">&#x27;&lt;break&gt;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i, relat_path <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_firm[<span class="string">&#x27;所有企业目录&#x27;</span>].values[error_idx[<span class="number">2</span>:]]):</span><br><span class="line">    name = relat_path.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">    all_comp_path = file_dir + relat_path</span><br><span class="line">    all_comp = pd.read_csv(all_comp_path, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    pl_dir = file_dir+<span class="string">&#x27;/Results/&#x27;</span> + name</span><br><span class="line">    <span class="comment"># 爬取所有企业信息</span></span><br><span class="line">    all_comp[<span class="string">&#x27;Name_com&#x27;</span>] = all_comp[<span class="string">&#x27;企业名称&#x27;</span>] + sep + (all_comp[<span class="string">&#x27;url&#x27;</span>])</span><br><span class="line">    cur_dir = get_current_dir(file_dir, all_comp_path)</span><br><span class="line">    sub_dirs = os.listdir(cur_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_comp[<span class="string">&#x27;Name_com&#x27;</span>].values):</span><br><span class="line">        <span class="keyword">if</span> x.split(sep)[<span class="number">0</span>] <span class="keyword">in</span> sub_dirs:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            all_comp.loc[j, <span class="string">&#x27;Firm_info&#x27;</span>] = <span class="built_in">str</span>(get_firm_data(x, sep, pl_dir))</span><br><span class="line">            all_comp.loc[j, <span class="string">&#x27;Casset_info&#x27;</span>] = <span class="built_in">str</span>(get_casset_data(x, sep, pl_dir))</span><br><span class="line"></span><br><span class="line">    all_comp[<span class="string">&#x27;股东数&#x27;</span>] = all_comp[<span class="string">&#x27;Firm_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">eval</span>(x)[<span class="built_in">list</span>(<span class="built_in">eval</span>(x).keys())[<span class="number">0</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;主要人员数&#x27;</span>] = all_comp[<span class="string">&#x27;Firm_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">eval</span>(x)[<span class="built_in">list</span>(<span class="built_in">eval</span>(x).keys())[<span class="number">1</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;专利信息数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">eval</span>(x)[<span class="built_in">list</span>(<span class="built_in">eval</span>(x).keys())[<span class="number">0</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;资质证书数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">eval</span>(x)[<span class="built_in">list</span>(<span class="built_in">eval</span>(x).keys())[<span class="number">1</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;软件著作权数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">eval</span>(x)[<span class="built_in">list</span>(<span class="built_in">eval</span>(x).keys())[<span class="number">2</span>]])</span><br><span class="line">    all_comp[<span class="string">&#x27;作品著作权数&#x27;</span>] = all_comp[<span class="string">&#x27;Casset_info&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">eval</span>(x)[<span class="built_in">list</span>(<span class="built_in">eval</span>(x).keys())[<span class="number">3</span>]])</span><br><span class="line"></span><br><span class="line">    all_comp_path = pl_dir + <span class="string">f&#x27;/<span class="subst">&#123;name&#125;</span>-所有企业表.csv&#x27;</span></span><br><span class="line">    all_comp.drop(<span class="string">&#x27;Name_com&#x27;</span>, axis = <span class="number">1</span>).to_csv(all_comp_path, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="数据规范化">2.4.2 数据规范化</h3>
<p>查看数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_firm.sample(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
url
</th>
<th>
企业家名字
</th>
<th>
在外任职目录
</th>
<th>
所有企业目录
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
454
</th>
<td>
https://www.qcc.com/pl/pc0bf5ac0db3ac3833528e9...
</td>
<td>
徐诵舜
</td>
<td>
/Results/454.徐诵舜/徐诵舜-在外任职表.csv
</td>
<td>
/Results/454.徐诵舜/徐诵舜-所有企业表.csv
</td>
</tr>
<tr>
<th>
444
</th>
<td>
https://www.qcc.com/pl/pe9f1e4541b32c30c40c4f1...
</td>
<td>
刘键
</td>
<td>
/Results/444.刘键/刘键-在外任职表.csv
</td>
<td>
/Results/444.刘键/刘键-所有企业表.csv
</td>
</tr>
<tr>
<th>
244
</th>
<td>
https://www.qcc.com/pl/p103fd20dc779066987fd98...
</td>
<td>
刘兵
</td>
<td>
/Results/244.刘兵/刘兵-在外任职表.csv
</td>
<td>
/Results/244.刘兵/刘兵-所有企业表.csv
</td>
</tr>
<tr>
<th>
610
</th>
<td>
https://www.qcc.com/pl/p4f922b492f237793f8e240...
</td>
<td>
刘云辉
</td>
<td>
/Results/610.刘云辉/刘云辉-在外任职表.csv
</td>
<td>
/Results/610.刘云辉/刘云辉-所有企业表.csv
</td>
</tr>
<tr>
<th>
1146
</th>
<td>
https://www.qcc.com/pl/p98067b26718f4c7b0b9e69...
</td>
<td>
李骁淳
</td>
<td>
/Results/1146.李骁淳/李骁淳-在外任职表.csv
</td>
<td>
/Results/1146.李骁淳/李骁淳-所有企业表.csv
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ignore_index = pd_firm[pd_firm[<span class="string">&#x27;企业家名字&#x27;</span>].isnull()].index</span><br><span class="line">pd_firm.loc[ignore_index, :].values</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<pre><code>array([], shape=(0, 4), dtype=object)</code></pre>
<p>可以发现，数据爬取基本成功，接下来对文件目录进行标准化，方便迁移分析。</p>
<ul>
<li><p>Modify file path</p>
<p>将文件路径的绝对路劲转换为相对路径。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mode_path</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(path, <span class="built_in">float</span>):</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line">    <span class="keyword">if</span> path.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        modify_path = path[<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">elif</span> path.startswith(<span class="string">&#x27;D:\\&#x27;</span>):</span><br><span class="line">        path_split = path.split(<span class="string">&#x27;D:\\Demo\\work\\XMU\\Data_Collection\\Results\\&#x27;</span>)</span><br><span class="line">        modify_path = <span class="string">&#x27;/&#x27;</span> + path_split[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">elif</span> path.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">        modify_path = path</span><br><span class="line">    <span class="keyword">return</span> modify_path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> swifter <span class="comment"># 加速apply</span></span><br><span class="line">pd_firm[<span class="string">&#x27;在外任职目录&#x27;</span>] = pd_firm[<span class="string">&#x27;在外任职目录&#x27;</span>].swifter.apply(mode_path)</span><br><span class="line">pd_firm[<span class="string">&#x27;所有企业目录&#x27;</span>] = pd_firm[<span class="string">&#x27;所有企业目录&#x27;</span>].swifter.apply(mode_path)</span><br></pre></td></tr></table></figure></li>
<li><p>Recheck</p></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file_dir = <span class="string">&#x27;D:\\Demo\\work\\XMU\\Data_Collection\\Results&#x27;</span></span><br><span class="line">sep = <span class="string">&#x27;&lt;break&gt;&#x27;</span></span><br><span class="line">error_idx = []</span><br><span class="line"><span class="keyword">for</span> i, relat_path <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_firm[<span class="string">&#x27;所有企业目录&#x27;</span>].values):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        name = relat_path.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        error_idx.append(i)</span><br><span class="line">        print(i, relat_path, sep = <span class="string">&#x27;\t | \t&#x27;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    all_comp_path = file_dir + relat_path</span><br><span class="line">    all_comp = pd.read_csv(all_comp_path, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cur_dir = get_current_dir(file_dir, all_comp_path)</span><br><span class="line">    sub_dirs = os.listdir(cur_dir)</span><br><span class="line"></span><br><span class="line">    records_len = all_comp.shape[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(sub_dirs) - <span class="number">2</span> != records_len): <span class="comment"># 文件夹中还包含所有企业表和在外任职表，所以 -2</span></span><br><span class="line">        error_idx.append(i)</span><br><span class="line">        print(i, relat_path, sep = <span class="string">&#x27;\t | \t&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<pre><code>683  |  nan</code></pre>
<p>至此处理完毕，公司数和表格中的记录数能对上。其中683为失效链接，后续直接去掉:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_firm = pd_firm.drop(<span class="number">683</span>, axis = <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h3 id="更新专利信息">2.4.3 更新专利信息</h3>
<h4 id="更新所有数量信息">更新所有数量信息</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file_dir = <span class="string">&#x27;D:\\Demo\\work\\XMU\\Data_Collection\\Results&#x27;</span></span><br><span class="line">sep = <span class="string">&#x27;&lt;break&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">pd_all_firm = pd_firm.copy()</span><br><span class="line">pd_pl_comp = pd.DataFrame()</span><br><span class="line"></span><br><span class="line">columns = [<span class="string">&#x27;企业表&#x27;</span>, <span class="string">&#x27;公司地址&#x27;</span>, <span class="string">&#x27;公司url&#x27;</span>, <span class="string">&#x27;股东信息&#x27;</span>,  <span class="string">&#x27;NUM_股东信息&#x27;</span>, <span class="string">&#x27;主要人员&#x27;</span>, <span class="string">&#x27;NUM_主要人员&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;专利信息&#x27;</span>, <span class="string">&#x27;NUM_专利信息&#x27;</span>, <span class="string">&#x27;资质证书&#x27;</span>, <span class="string">&#x27;NUM_资质证书&#x27;</span>, <span class="string">&#x27;软件著作权&#x27;</span>, <span class="string">&#x27;NUM_软件著作权&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;股东信息&#x27;</span>, <span class="string">&#x27;NUM_股东信息&#x27;</span>]</span><br><span class="line">pd_record = pd.DataFrame(columns = columns)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, relat_path <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_firm[<span class="string">&#x27;所有企业目录&#x27;</span>].values):</span><br><span class="line">    name = relat_path.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>]</span><br><span class="line">    all_comp_path = file_dir + relat_path</span><br><span class="line">    all_comp = pd.read_csv(all_comp_path, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">    all_comp[<span class="string">&#x27;企业家名字&#x27;</span>] = [name]*all_comp.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    pl_dir = file_dir+<span class="string">&#x27;/Results/&#x27;</span> + name</span><br><span class="line">    <span class="comment"># 爬取所有企业信息</span></span><br><span class="line">    all_comp[<span class="string">&#x27;Name_com&#x27;</span>] = all_comp[<span class="string">&#x27;企业名称&#x27;</span>] + sep + (all_comp[<span class="string">&#x27;url&#x27;</span>])</span><br><span class="line">    cur_dir = get_current_dir(file_dir, all_comp_path)</span><br><span class="line">    sub_dirs = os.listdir(cur_dir)</span><br><span class="line">    <span class="keyword">for</span> j, nam <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_comp[<span class="string">&#x27;企业名称&#x27;</span>].values):</span><br><span class="line">        url = all_comp.loc[j, <span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        comp_dir = cur_dir + nam + <span class="string">&#x27;/&#x27;</span></span><br><span class="line">        all_comp.loc[j, <span class="string">&#x27;公司目录&#x27;</span>] = comp_dir</span><br><span class="line">        file_list = os.listdir(comp_dir)</span><br><span class="line">        cas_keys = [<span class="string">&#x27;股东信息&#x27;</span>, <span class="string">&#x27;主要人员&#x27;</span>, <span class="string">&#x27;专利信息&#x27;</span>, <span class="string">&#x27;资质证书&#x27;</span>, <span class="string">&#x27;软件著作权&#x27;</span>, <span class="string">&#x27;作品著作权&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> k, cas <span class="keyword">in</span> <span class="built_in">enumerate</span>(cas_keys):</span><br><span class="line">            file_path = cas+<span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">            pd_cols = [<span class="string">&#x27;股东数&#x27;</span>, <span class="string">&#x27;主要人员数&#x27;</span>, <span class="string">&#x27;专利信息数&#x27;</span>, <span class="string">&#x27;资质证书数&#x27;</span>, <span class="string">&#x27;软件著作权数&#x27;</span>,<span class="string">&#x27;作品著作权数&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> file_path <span class="keyword">not</span> <span class="keyword">in</span> file_list:</span><br><span class="line">                all_comp.loc[j, pd_cols[k]] = np.nan</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                cas_file_dir = comp_dir+file_path</span><br><span class="line">                casset = pd.read_csv(cas_file_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">                number = casset.shape[<span class="number">0</span>]</span><br><span class="line">                all_comp.loc[j, pd_cols[k]] = number</span><br><span class="line">    save_col = [<span class="string">&#x27;序号&#x27;</span>, <span class="string">&#x27;企业家名字&#x27;</span>, <span class="string">&#x27;企业名称&#x27;</span>, <span class="string">&#x27;角色&#x27;</span>, <span class="string">&#x27;注册资本&#x27;</span>, <span class="string">&#x27;成立日期&#x27;</span>, <span class="string">&#x27;地区&#x27;</span>, <span class="string">&#x27;状态&#x27;</span>, <span class="string">&#x27;url&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;股东数&#x27;</span>, <span class="string">&#x27;主要人员数&#x27;</span>, <span class="string">&#x27;专利信息数&#x27;</span>, <span class="string">&#x27;资质证书数&#x27;</span>, <span class="string">&#x27;软件著作权数&#x27;</span>, <span class="string">&#x27;作品著作权数&#x27;</span>]</span><br><span class="line">    mod_path = all_comp_path.split(<span class="string">&#x27;.csv&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;_mod.csv&#x27;</span></span><br><span class="line">    all_comp[save_col].to_csv(mod_path, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line">    pd_pl_comp = pd.concat([pd_pl_comp, all_comp], axis = <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Modify path</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_name</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> x:</span><br><span class="line">        name = x.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        name = x</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mode_path</span>(<span class="params">path</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(path, <span class="built_in">float</span>):</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line">    <span class="keyword">if</span> path.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">        modify_path = path[<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">elif</span> path.startswith(<span class="string">&#x27;D:&#x27;</span>):</span><br><span class="line">        path_split = path.split(<span class="string">&#x27;D:\Demo\work\XMU\Data_Collection\Results/&#x27;</span>)</span><br><span class="line">        modify_path = <span class="string">&#x27;/&#x27;</span> + path_split[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">elif</span> path.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">        modify_path = path</span><br><span class="line">    <span class="keyword">return</span> modify_path</span><br><span class="line"></span><br><span class="line">pd_pl_comp[<span class="string">&#x27;企业家名字&#x27;</span>] = pd_pl_comp[<span class="string">&#x27;企业家名字&#x27;</span>].apply(mod_name)</span><br><span class="line">pd_pl_comp[<span class="string">&#x27;公司目录&#x27;</span>] = pd_pl_comp[<span class="string">&#x27;公司目录&#x27;</span>].swifter.apply(mod_name)</span><br><span class="line">pd_pl_comp.rename(columns=&#123;<span class="string">&#x27;url&#x27;</span>:<span class="string">&#x27;Com_url&#x27;</span>,<span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;B&#x27;</span>&#125;, inplace = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Merge</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_all_firm = pd_firm.copy()</span><br><span class="line">pd_all_firm = pd.merge(pd_all_firm, pd_pl_comp, on = <span class="string">&#x27;企业家名字&#x27;</span>, how = <span class="string">&#x27;outer&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="核对数量">核对数量</h4>
<ul>
<li><p>产看所有信息指标</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_all_firm.columns</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>Index([&#39;url&#39;, &#39;企业家名字&#39;, &#39;在外任职目录&#39;, &#39;所有企业目录&#39;, &#39;序号&#39;, &#39;企业名称&#39;, &#39;角色&#39;, &#39;注册资本&#39;, &#39;成立日期&#39;,
       &#39;地区&#39;, &#39;状态&#39;, &#39;Com_url&#39;, &#39;Firm_info&#39;, &#39;Casset_info&#39;, &#39;股东数&#39;, &#39;主要人员数&#39;,
       &#39;专利信息数&#39;, &#39;资质证书数&#39;, &#39;软件著作权数&#39;, &#39;作品著作权数&#39;, &#39;Name_com&#39;, &#39;公司目录&#39;, &#39;Name&#39;],
       dtype=&#39;object&#39;)</code></pre></li>
<li><p>Check</p>
<p>由于静态爬取仅能爬取页面中加载的第一页信息，共十条，因此对所爬取的信息数量进行核对，对所爬取的 <code>csv</code> 表格中信息数为 10 的进行动态爬取，补充信息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">check_names = [ <span class="string">&#x27;股东数&#x27;</span>, <span class="string">&#x27;主要人员数&#x27;</span>, <span class="string">&#x27;专利信息数&#x27;</span>, <span class="string">&#x27;资质证书数&#x27;</span>, <span class="string">&#x27;软件著作权数&#x27;</span>, <span class="string">&#x27;作品著作权数&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> check_names:</span><br><span class="line">    col_shape = pd_all_firm[pd_all_firm[col]&gt;=<span class="number">10</span>].shape</span><br><span class="line">    print(col, col_shape, sep = <span class="string">&#x27; | &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> check_names:</span><br><span class="line">    col_shape = pd_all_firm[pd_all_firm[col]&gt;<span class="number">10</span>].shape</span><br><span class="line">    print(col, col_shape, sep = <span class="string">&#x27; | &#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<pre><code>股东数 | (658, 23)
主要人员数 | (225, 23)
专利信息数 | (1009, 23)
资质证书数 | (411, 23)
软件著作权数 | (576, 23)
作品著作权数 | (15, 23)
股东数 | (585, 23)
主要人员数 | (162, 23)
专利信息数 | (0, 23)
资质证书数 | (0, 23)
软件著作权数 | (0, 23)
作品著作权数 | (0, 23)</code></pre>
<p>可以发现资产信息的四个指标的数量基本都是10个，这些都需要进行重新爬取。接下来需要适用动态爬虫来对这些信息进行补充。</p></li>
<li><p>Save</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_all_firm.to_csv(<span class="string">&#x27;./All_pd_firm.csv&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="dynamic-crawler">3. Dynamic crawler</h1>
<h2 id="problem-description">3.1 Problem description</h2>
<p>尽管上述静态爬虫能爬取绝大多数的信息，但还是存在诸多问题，如：所有企业表中：以 高<em>波 为例，北京 </em>*** 科技有限责任公司为例，所有企业表中的专利数等信息存在错误。<所有企业表> 中的专利信息数和资质证书数都错了。</p>
<p>经过分析，发现造成这些原因是因为静态爬虫不能得到页面内动态加载的信息（指同一个 url 中点击按钮后会加载不同的信息），因此在本节中，我们考虑用 <code>selenium</code> 来进行动态爬取资产信息，补充第二节中静态爬虫未能完整爬取的信息。</p>
<h2 id="configuration-1">3.2 Configuration</h2>
<p>由于本人使用的是 <code>Google Chrome</code> 浏览器，其版本是 <code>92.0.4515.107</code>。因此在本节中，我们借助 <code>selenium</code> 库中的 <code>webdriver</code> 驱动进行动态爬取，使用该工具需要下载相应的驱动，其各版本的驱动可以通过 <a href="https://mirrors.huaweicloud.com/chromedriver/">华为镜像</a> 进行下载，需要注意的是要下载自己浏览器对应的驱动版本，同时将该文件所保存的地址传给 <code>executable_path</code> 参数，如本人的存储地址为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">C:\Program Files (x86)\Google\Chrome\Application\chromedriver.exe</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Import modules</p>
<p>同上，若未安装对应的库，可使用 <code>pip install module_name</code> 进行安装。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time  <span class="comment"># 提供延时功能</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver  <span class="comment"># 浏览器操作库</span></span><br></pre></td></tr></table></figure></li>
<li><p>Launch driver</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">option = webdriver.ChromeOptions()</span><br><span class="line">option.add_argument(</span><br><span class="line">    <span class="string">&#x27;--user-agent=&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.146 Safari/537.36&quot;&#x27;</span>)</span><br><span class="line">driver = webdriver.Chrome(</span><br><span class="line">      options=option, executable_path=<span class="string">&#x27;C:\Program Files (x86)\Google\Chrome\Application\chromedriver.exe&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开登录页面</span></span><br><span class="line">driver.get(<span class="string">&#x27;https://www.qcc.com/&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">20</span>)  <span class="comment"># 等待20s，完成手动登录操作</span></span><br><span class="line">driver.refresh()</span><br></pre></td></tr></table></figure>
<p>可以注意到在这里我们休眠了 20 s，这个过程是为了手动用企查查 <code>APP</code> 进行扫码登录，虽然也可以传入 <code>cookie</code> 进行登录，不过本人在传入 <code>cookie</code> 过程中并未成功，因此使用该简便方式进行登录。</p></li>
<li><p>Load data</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pl_root_dir = <span class="string">r&#x27;D:\Demo\work\XMU\Data_Collection\Results/&#x27;</span></span><br><span class="line"></span><br><span class="line">pd_all_firm = pd.read_csv(<span class="string">&#x27;./All_pd_firm.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>, index_col = <span class="number">0</span>)</span><br><span class="line">pd_firm = pd.read_csv(<span class="string">&#x27;FirmList.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="data-complementary">3.3 Data complementary</h2>
<p>对数量不对的进行再次爬取，先获取数量不对的条目的index</p>
<ul>
<li><p>得到需要重新爬取的数据索引</p>
<p>得到需要重新爬取的数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">check_names = [<span class="string">&#x27;股东数&#x27;</span>, <span class="string">&#x27;主要人员数&#x27;</span>, <span class="string">&#x27;专利信息数&#x27;</span>, <span class="string">&#x27;资质证书数&#x27;</span>, <span class="string">&#x27;软件著作权数&#x27;</span>, <span class="string">&#x27;作品著作权数&#x27;</span>]</span><br><span class="line"></span><br><span class="line">recheck_index = pd.Index([])</span><br><span class="line">recheck_type_index = []</span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> check_names[<span class="number">2</span>:]:</span><br><span class="line">    check_idx = pd_all_firm[pd_all_firm[col] &gt;= <span class="number">10</span>].index</span><br><span class="line">    recheck_index = recheck_index.append(check_idx)</span><br><span class="line">    recheck_type_index.append(check_idx)</span><br><span class="line"></span><br><span class="line">recheck_index = <span class="built_in">list</span>(<span class="built_in">set</span>(recheck_index))</span><br></pre></td></tr></table></figure></li>
<li><p>判断当前节点是否存在</p>
<p>由于有些信息节点并不是所有企业都有（如知识产权），因此我们需要判断该节点是否存在，以防程序报错而终止运行。</p>
<p>我们可以通过 <code>type_input</code> 来控制传入的节点的类型，如 <code>xpath</code>, <code>tag</code> 等，也可以自行扩充。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">NodeExists</span>(<span class="params">drievr, input_code, type_input</span>):</span></span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">      <span class="keyword">if</span> type_input == <span class="string">&#x27;xpath&#x27;</span>:</span><br><span class="line">          driver.find_element_by_xpath(input_code)</span><br><span class="line">      <span class="keyword">elif</span> type_input == <span class="string">&#x27;tag&#x27;</span>:</span><br><span class="line">          driver.find_element_by_tag_name(input_code)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure></li>
<li><p>判断四个信息中哪些信息需要重新爬取</p>
<p>通过筛选之后，我们发现在外任职表和所有企业表的信息基本准确，因此，主要针对专利信息、资质证书、软件著作权和作品著作权进行更新。</p>
<p>此外，我们需要判断四个节点中有哪些节点是需要更新的，因为并不是所有的节点都需要更新，全部更新的话颇为耗时，且有报错的可能。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_idx</span>(<span class="params">pd_data, idx, recheck_cols</span>):</span></span><br><span class="line">    ret_idx = []</span><br><span class="line">    <span class="keyword">for</span> i, col <span class="keyword">in</span> <span class="built_in">enumerate</span>(recheck_cols):</span><br><span class="line">        <span class="keyword">if</span> pd_data.loc[idx, col] &gt;= <span class="number">10</span>:</span><br><span class="line">            ret_idx.append(i)</span><br><span class="line">    <span class="keyword">return</span> ret_idx</span><br></pre></td></tr></table></figure></li>
<li><p>开始更新数据</p>
<p>得到需要更新的数据的索引 <code>recheck_index</code> 之后，我们对这些数据进行遍历和爬取。由于不同节点的 <code>xpath</code> 地址不同，我们使用 <code>if ... else ...</code> 语句进行区分对待。最后将更新好的数据保存至 <code>All_pd_firm-mod.csv</code> 文件中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start_pos = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> idx, i <span class="keyword">in</span> <span class="built_in">enumerate</span>(recheck_index[start_pos:]):</span><br><span class="line">  name = pd_all_firm.loc[i, <span class="string">&#x27;企业名称&#x27;</span>]</span><br><span class="line">  casset_path = pd_all_firm.loc[i, <span class="string">&#x27;公司目录&#x27;</span>]</span><br><span class="line">  url = pd_all_firm.loc[i, <span class="string">&#x27;Com_url&#x27;</span>]</span><br><span class="line">  firm_url = url.split(<span class="string">&#x27;firm&#x27;</span>)</span><br><span class="line">  url = firm_url[<span class="number">0</span>] + <span class="string">&#x27;cassets&#x27;</span> + firm_url[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># requests.get(url=url, cookies=cookies, headers=headers, timeout=5).text</span></span><br><span class="line"></span><br><span class="line">  driver.get(url)</span><br><span class="line">  time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;专利信息：zhuanlilist</span></span><br><span class="line"><span class="string">      资质证书：zhengshulist</span></span><br><span class="line"><span class="string">      软件著作权：rjzzqlist</span></span><br><span class="line"><span class="string">      作品著作权：zzqlist</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  list_ids = [<span class="string">&#x27;zhuanlilist&#x27;</span>, <span class="string">&#x27;zhengshulist&#x27;</span>, <span class="string">&#x27;rjzzqlist&#x27;</span>, <span class="string">&#x27;zzqlist&#x27;</span>]</span><br><span class="line">  num_cassets_id = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  cas_keys = [<span class="string">&#x27;专利信息&#x27;</span>, <span class="string">&#x27;资质证书&#x27;</span>, <span class="string">&#x27;软件著作权&#x27;</span>, <span class="string">&#x27;作品著作权&#x27;</span>] <span class="comment"># csv表名称</span></span><br><span class="line">  recheck_cols = [<span class="string">&#x27;专利信息数&#x27;</span>, <span class="string">&#x27;资质证书数&#x27;</span>, <span class="string">&#x27;软件著作权数&#x27;</span>, <span class="string">&#x27;作品著作权数&#x27;</span>] <span class="comment"># 数量</span></span><br><span class="line">  cas_numbers = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">  dic_cassets = <span class="built_in">dict</span>(<span class="built_in">zip</span>(cas_keys, cas_numbers))</span><br><span class="line"></span><br><span class="line">  <span class="comment"># if os.path.exists(pl_root_dir+casset_path):</span></span><br><span class="line">  <span class="comment">#     pass</span></span><br><span class="line">  <span class="comment"># else:</span></span><br><span class="line">  <span class="comment">#     os.makedirs(casset_path)</span></span><br><span class="line"></span><br><span class="line">  recheck_col_idx = check_idx(pd_all_firm, i, recheck_cols)</span><br><span class="line">  <span class="comment"># pd_all_firm.loc[i, recheck_cols]</span></span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> recheck_col_idx:</span><br><span class="line">      com_id = list_ids[j]</span><br><span class="line">      casset_dir = pl_root_dir + casset_path + cas_keys[j] + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">      <span class="comment"># try:</span></span><br><span class="line">      html_table = driver.find_element_by_id(com_id).get_attribute(<span class="string">&quot;innerHTML&quot;</span>)   <span class="comment"># 专利信息</span></span><br><span class="line">      soup = BeautifulSoup(html_table, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">          <span class="comment"># 专利信息</span></span><br><span class="line">          txt = soup.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line">          pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(txt)))[<span class="number">0</span>]  <span class="comment"># 专利信息</span></span><br><span class="line"></span><br><span class="line">          number_xpath = <span class="string">&#x27;//*[@id=&quot;zhuanlilist&quot;]/div[4]/nav/ul&#x27;</span></span><br><span class="line">          <span class="keyword">if</span> NodeExists(driver, number_xpath, <span class="string">&#x27;xpath&#x27;</span>):                    </span><br><span class="line">              <span class="keyword">while</span> <span class="number">1</span> :</span><br><span class="line">                  <span class="keyword">try</span>:</span><br><span class="line">                      list_str_list = driver.find_element_by_xpath(number_xpath).text</span><br><span class="line">                      bt_text = list_str_list.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                      bt_next_index = bt_text.index(<span class="string">&#x27;&gt;&#x27;</span>) + <span class="number">1</span></span><br><span class="line">                  <span class="keyword">except</span>:</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                  bt_xpath = <span class="string">f&#x27;//*[@id=&quot;zhuanlilist&quot;]/div[4]/nav/ul/li[<span class="subst">&#123;bt_next_index&#125;</span>]&#x27;</span></span><br><span class="line">                  driver.find_element_by_xpath(bt_xpath).click()</span><br><span class="line">                  time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">                  html_table = driver.find_element_by_id(com_id).get_attribute(<span class="string">&quot;innerHTML&quot;</span>)   <span class="comment"># 专利信息</span></span><br><span class="line">                  soup = BeautifulSoup(html_table, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">                  tmp_txt = soup.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line">                  tmp_pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(tmp_txt)))[<span class="number">0</span>]  <span class="comment"># 专利信息</span></span><br><span class="line">                  pd_comp = pd.concat([pd_comp, tmp_pd_comp], axis = <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">elif</span> j == <span class="number">1</span>:</span><br><span class="line">          pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table)))[<span class="number">0</span>]  <span class="comment"># 得到公司信息</span></span><br><span class="line"></span><br><span class="line">          casset_driver = driver.find_element_by_id(com_id)</span><br><span class="line">          table_cas = casset_driver.find_element_by_class_name(<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> NodeExists(table_cas, <span class="string">&#x27;nav&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>):</span><br><span class="line">              <span class="keyword">while</span> <span class="number">1</span> :</span><br><span class="line">                  <span class="keyword">try</span>:</span><br><span class="line">                      number_xpath = <span class="string">&#x27;//*[@id=&quot;zhengshulist&quot;]/div[4]/div[2]/nav/ul&#x27;</span></span><br><span class="line">                      <span class="comment"># list_str_list = table_cas.find_element_by_xpath(number_xpath).text</span></span><br><span class="line">                      list_str_list = table_cas.find_element_by_tag_name(<span class="string">&#x27;nav&#x27;</span>).text</span><br><span class="line">                      bt_text = list_str_list.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                      bt_next_index = bt_text.index(<span class="string">&#x27;&gt;&#x27;</span>) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                  <span class="keyword">except</span>:</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                  bt_xpath = <span class="string">f&#x27;//*[@id=&quot;zhengshulist&quot;]/div[4]/div[2]/nav/ul/li[<span class="subst">&#123;bt_next_index&#125;</span>]&#x27;</span></span><br><span class="line">                  table_cas.find_element_by_xpath(bt_xpath).click()</span><br><span class="line">                  time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">                  html_table = driver.find_element_by_id(com_id).get_attribute(<span class="string">&quot;innerHTML&quot;</span>)   <span class="comment"># 专利信息</span></span><br><span class="line">                  soup = BeautifulSoup(html_table, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">                  tmp_txt = soup.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line">                  tmp_pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(tmp_txt)))[<span class="number">0</span>]  <span class="comment"># 专利信息</span></span><br><span class="line">                  pd_comp = pd.concat([pd_comp, tmp_pd_comp], axis = <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">elif</span> j == <span class="number">2</span>:</span><br><span class="line">          pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table)))[<span class="number">0</span>]  <span class="comment"># 得到公司信息</span></span><br><span class="line"></span><br><span class="line">          casset_driver = driver.find_element_by_id(com_id)</span><br><span class="line">          table_cas = casset_driver.find_element_by_class_name(<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> NodeExists(table_cas, <span class="string">&#x27;nav&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>):</span><br><span class="line">              <span class="keyword">while</span> <span class="number">1</span> :</span><br><span class="line">                  <span class="keyword">try</span>:</span><br><span class="line">                      number_xpath = <span class="string">&#x27;//*[@id=&quot;rjzzqlist&quot;]/div[2]/nav/ul&#x27;</span></span><br><span class="line">                      <span class="comment"># list_str_list = table_cas.find_element_by_xpath(number_xpath).text</span></span><br><span class="line">                      list_str_list = table_cas.find_element_by_tag_name(<span class="string">&#x27;nav&#x27;</span>).text</span><br><span class="line">                      bt_text = list_str_list.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                      bt_next_index = bt_text.index(<span class="string">&#x27;&gt;&#x27;</span>) + <span class="number">1</span></span><br><span class="line">                  <span class="keyword">except</span>:</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                  bt_xpath = <span class="string">f&#x27;//*[@id=&quot;rjzzqlist&quot;]/div[2]/nav/ul/li[<span class="subst">&#123;bt_next_index&#125;</span>]&#x27;</span></span><br><span class="line">                  table_cas.find_element_by_xpath(bt_xpath).click()</span><br><span class="line">                  time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">                  html_table = driver.find_element_by_id(com_id).get_attribute(<span class="string">&quot;innerHTML&quot;</span>)   <span class="comment"># 专利信息</span></span><br><span class="line">                  soup = BeautifulSoup(html_table, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">                  tmp_txt = soup.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line">                  tmp_pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(tmp_txt)))[<span class="number">0</span>]  <span class="comment"># 专利信息</span></span><br><span class="line">                  pd_comp = pd.concat([pd_comp, tmp_pd_comp], axis = <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">elif</span> j == <span class="number">3</span>:</span><br><span class="line">          pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(html_table)))[<span class="number">0</span>]  <span class="comment"># 得到公司信息</span></span><br><span class="line"></span><br><span class="line">          casset_driver = driver.find_element_by_id(com_id)</span><br><span class="line">          table_cas = casset_driver.find_element_by_class_name(<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line">          <span class="keyword">if</span> NodeExists(table_cas, <span class="string">&#x27;nav&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>):</span><br><span class="line">              <span class="keyword">while</span> <span class="number">1</span> :</span><br><span class="line">                  <span class="keyword">try</span>:</span><br><span class="line">                      number_xpath = <span class="string">&#x27;//*[@id=&quot;zzqlist&quot;]/div[2]/nav/ul&#x27;</span></span><br><span class="line">                      <span class="comment"># list_str_list = table_cas.find_element_by_xpath(number_xpath).text</span></span><br><span class="line">                      list_str_list = table_cas.find_element_by_tag_name(<span class="string">&#x27;nav&#x27;</span>).text</span><br><span class="line">                      bt_text = list_str_list.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                      bt_next_index = bt_text.index(<span class="string">&#x27;&gt;&#x27;</span>) + <span class="number">1</span></span><br><span class="line">                  <span class="keyword">except</span>:</span><br><span class="line">                      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                  bt_xpath = <span class="string">f&#x27;//*[@id=&quot;zzqlist&quot;]/div[2]/nav/ul/li[<span class="subst">&#123;bt_next_index&#125;</span>]&#x27;</span></span><br><span class="line">                  table_cas.find_element_by_xpath(bt_xpath).click()</span><br><span class="line">                  time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">                  html_table = driver.find_element_by_id(com_id).get_attribute(<span class="string">&quot;innerHTML&quot;</span>)   <span class="comment"># 专利信息</span></span><br><span class="line">                  soup = BeautifulSoup(html_table, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">                  tmp_txt = soup.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&#x27;app-ntable&#x27;</span>)</span><br><span class="line">                  tmp_pd_comp = pd.read_html(StringIO(<span class="built_in">str</span>(tmp_txt)))[<span class="number">0</span>]  <span class="comment"># 专利信息</span></span><br><span class="line">                  pd_comp = pd.concat([pd_comp, tmp_pd_comp], axis = <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      pd_all_firm.loc[i, recheck_cols[j]] = pd_comp.shape[<span class="number">0</span>]</span><br><span class="line">      pd_comp.to_csv(casset_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>, errors = <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      time.sleep(<span class="number">2</span>)</span><br><span class="line">  print(<span class="string">f&#x27;第<span class="subst">&#123;idx+start_pos&#125;</span>个条目已经重新整理完毕！&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pd_all_firm.to_csv(<span class="string">&#x27;./All_pd_firm-mod.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>, errors = <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">driver.close()</span><br></pre></td></tr></table></figure></li>
</ul>
<p>至此，数量信息更新完毕，由于 <code>selenium</code> 是通过动态爬取，其结果很大程度上具有可信性。</p>
<h1 id="data-preprocess">4 Data Preprocess</h1>
<h2 id="job-description-1">4.1 Job description</h2>
<p>经过动态爬取之后，为了方便做研究，甲方认为数据仍然存在些许需要改善的地方，因此本节的主要目的是对得到的数据进行数据预处理。</p>
<p>甲方提出需求如下：</p>
<ol type="1">
<li><p>所有企业表和在外任职表：仅需要企业的url，但是把法定代表人的url也给搞下来了，造成表格较乱（处理方法两种，要不把法人url给删除了，要不把法人url给对齐，推荐后者）。如下图所示：</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCU39.md.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 7 在外任职表样例</p>
</center></li>
<li><p>营业执照信息表：企业名称、经营范围、英文名以及注册地址存在重复；法定代表人处存在重复的首字（注：该问题存在的原因是因为我们直接借助 <code>pd.read_html</code> 进行页面表格的提取，而这种方式对于合并单元的处理并不友好。）。如下图所示：</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCacR.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 8 营业执照信息样例</p>
</center>
<p>如果可行，把表头方第一行，内容方第二行吧（此外，营业执照信息表里中D2单元格-有关企业名称拿里有多余”复制”两个字，需要进行剔除）。</p></li>
<li><p>股东信息表和主要人员表：B列和C列重复，把C列中”关联?加企业”单独分出一列。</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCdj1.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 9 营业执照信息样例</p>
</center></li>
<li><p>所有企业表中，需要载爬取一个数据：当企业状态为注销或吊销时，需要再爬取注销的时间，如下图所示。</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bCN9J.png' style="zoom:80%;" /></p>
<center>
<p>Fig. 10 注销时间样例</p>
</center></li>
</ol>
<h2 id="preprocess">4.2 Preprocess</h2>
<p>在本节中，我们针对甲方提出的问题对所得到的数据进行一个个处理。</p>
<h3 id="task-1">4.2.1 Task 1</h3>
<p>首先我们定义一些函数，方便处理。</p>
<ul>
<li><p>得到精确的高管名字</p>
<p>通过 Fig.7 我们可以发现，直接从网页上爬取的企业（家）名称并不一定精确，所以需要对这些信息进行标准化处理。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_plname</span>(<span class="params">pl_name</span>):</span></span><br><span class="line">    pl_list = pl_name.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(pl_list[<span class="number">0</span>]) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> pl_list[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(pl_list[<span class="number">0</span>]) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> pl_list[<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p></li>
<li><p>用字典存储企业及其 url</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">updata_names</span>(<span class="params">dict_url</span>):</span></span><br><span class="line">  en_keys = <span class="built_in">dict</span>()</span><br><span class="line">  keys = dict_url.keys()</span><br><span class="line">  <span class="keyword">for</span> ky <span class="keyword">in</span> keys:</span><br><span class="line">      ky_split = ky.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">len</span>(ky_split) &gt; <span class="number">1</span>:</span><br><span class="line">          en_keys[ky_split[<span class="number">0</span>]] = ky</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          en_keys[ky] = ky</span><br><span class="line">  <span class="keyword">return</span> en_keys</span><br></pre></td></tr></table></figure></li>
<li><p>更新名称和url</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_url</span>(<span class="params">name, dict_url</span>):</span></span><br><span class="line">      <span class="keyword">if</span> name <span class="keyword">in</span> dict_url.keys():</span><br><span class="line">        <span class="keyword">return</span> dict_url[name]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> np.nan</span><br></pre></td></tr></table></figure></li>
<li><p>得到关联信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_connec</span>(<span class="params">name</span>):</span></span><br><span class="line">    ky_split = name.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(ky_split) &gt; <span class="number">1</span>:</span><br><span class="line">        connect = ky_split[-<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> connect.startswith(<span class="string">&#x27;关联&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> connect</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> np.nan</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> np.nan</span><br></pre></td></tr></table></figure></li>
</ul>
<ol type="1">
<li><p>处理股东信息</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, u_idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_all_firm.index[start:]):</span><br><span class="line">    i = i + start</span><br><span class="line">    name = pd_all_firm.loc[u_idx, <span class="string">&#x27;企业名称&#x27;</span>]</span><br><span class="line">    people_path = pd_all_firm.loc[u_idx, <span class="string">&#x27;公司目录&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    read_people_path = <span class="string">&#x27;Results - Copy&#x27;</span> + people_path.split(<span class="string">&#x27;/Results&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    out_people_path = people_path</span><br><span class="line"></span><br><span class="line">    pl_csv = <span class="string">&#x27;股东信息.csv&#x27;</span></span><br><span class="line">    people_dir = pl_root_dir + read_people_path + pl_csv</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    columns:</span></span><br><span class="line"><span class="string">        [&#x27;序号&#x27;, &#x27;股东名称&#x27;, &#x27;股东名称.1&#x27;, &#x27;持股比例&#x27;,</span></span><br><span class="line"><span class="string">         &#x27;持股数(股)&#x27;, &#x27;关联产品/机构&#x27;, &#x27;Name&#x27;, &#x27;url&#x27;]</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> pd_all_firm.loc[u_idx, <span class="string">&#x27;股东数&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pd_people = pd.read_csv(people_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    numbers = pd_people[<span class="string">&#x27;序号&#x27;</span>].notnull().<span class="built_in">sum</span>()</span><br><span class="line">    columns = pd_people.columns</span><br><span class="line">    pd_pl_mod = pd_people.loc[:numbers-<span class="number">1</span>, columns[:-<span class="number">2</span>]]</span><br><span class="line">    pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">2</span>]].apply(mod_plname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">in</span> pd_people.columns:</span><br><span class="line">        dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(pd_people[<span class="string">&#x27;Name&#x27;</span>].values, pd_people[<span class="string">&#x27;url&#x27;</span>].values))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_url[x])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                dict_names = updata_names(dict_url)</span><br><span class="line">                pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_names[x] <span class="keyword">if</span> x <span class="keyword">in</span> dict_names.keys() <span class="keyword">else</span> x)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                keys = pd_people[<span class="string">&#x27;Name&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                beg_idx = keys.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                end_idx = keys.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                keys = <span class="built_in">eval</span>(keys[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                values = pd_people[<span class="string">&#x27;url&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                beg_idx = values.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                end_idx = values.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                values = <span class="built_in">eval</span>(values[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line">                dict_url = dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(keys, values))</span><br><span class="line"></span><br><span class="line">            pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x:  mod_url(x, dict_url))</span><br><span class="line"></span><br><span class="line">        pd_pl_mod[<span class="string">&#x27;关联信息&#x27;</span>] = pd_pl_mod[(columns[<span class="number">2</span>])].apply(mod_connec)</span><br><span class="line">        pd_pl_mod.drop(columns[<span class="number">2</span>], axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">        people_mod_dir = pl_root_dir + out_people_path + pl_csv.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;-mod.csv&#x27;</span></span><br><span class="line">        pd_pl_mod.to_csv(people_mod_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">f&#x27;第<span class="subst">&#123;i&#125;</span>条人员信息已处理完毕&#x27;</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>处理在外任职表</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, u_idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_firm.index[start:]):</span><br><span class="line">    i = i + start</span><br><span class="line">    out_dir = pd_firm.loc[u_idx, <span class="string">&#x27;在外任职目录&#x27;</span>]</span><br><span class="line">    out_path = pl_root_dir + out_dir</span><br><span class="line">    pd_people = pd.read_csv(out_path, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pd_people.shape[<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    numbers = pd_people[<span class="string">&#x27;序号&#x27;</span>].notnull().<span class="built_in">sum</span>()</span><br><span class="line">    columns = pd_people.columns</span><br><span class="line">    pd_pl_mod = pd_people.loc[:numbers-<span class="number">1</span>, columns[:-<span class="number">2</span>]]</span><br><span class="line">    pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">1</span>]].apply(mod_plname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">in</span> pd_people.columns:</span><br><span class="line">        dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(pd_people[<span class="string">&#x27;Name&#x27;</span>].values, pd_people[<span class="string">&#x27;url&#x27;</span>].values))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_url[x])</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                dict_names = updata_names(dict_url)</span><br><span class="line">                pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_names[x] <span class="keyword">if</span> x <span class="keyword">in</span> dict_names.keys() <span class="keyword">else</span> x)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                keys = pd_people[<span class="string">&#x27;Name&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                beg_idx = keys.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                end_idx = keys.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                keys = <span class="built_in">eval</span>(keys[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                values = pd_people[<span class="string">&#x27;url&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                beg_idx = values.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                end_idx = values.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                values = <span class="built_in">eval</span>(values[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line">                dict_url = dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(keys, values))</span><br><span class="line"></span><br><span class="line">            pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x:  mod_url(x, dict_url))</span><br><span class="line"></span><br><span class="line">        pd_pl_mod.drop(columns[<span class="number">2</span>], axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">        people_mod_dir = out_path.split(<span class="string">&#x27;.csv&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;-mod.csv&#x27;</span></span><br><span class="line">        pd_pl_mod.to_csv(people_mod_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># break</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">f&#x27;第<span class="subst">&#123;i&#125;</span>条人员信息已处理完毕&#x27;</span>)</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h3 id="工商信息处理">4.2.2 工商信息处理</h3>
<ul>
<li><p>标准化名字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_mod_plname</span>(<span class="params">pl_name</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(pl_name, <span class="built_in">str</span>):</span><br><span class="line">        pl_list = pl_name.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pl_list[<span class="number">0</span>]) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> pl_list[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(pl_list[<span class="number">0</span>]) &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> pl_list[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> pl_name</span><br></pre></td></tr></table></figure></li>
<li><p>update</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start = <span class="number">366</span></span><br><span class="line"><span class="keyword">for</span> i, u_idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_all_firm.index[start:]):</span><br><span class="line">    i = i + start</span><br><span class="line">    name = pd_all_firm.loc[u_idx, <span class="string">&#x27;企业名称&#x27;</span>]</span><br><span class="line">    people_path = pd_all_firm.loc[u_idx, <span class="string">&#x27;公司目录&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    pl_csv = <span class="string">&#x27;营业执照信息.csv&#x27;</span></span><br><span class="line">    people_dir = pl_root_dir + people_path + pl_csv</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    columns:</span></span><br><span class="line"><span class="string">        [&#x27;序号&#x27;, &#x27;股东名称&#x27;, &#x27;股东名称.1&#x27;, &#x27;持股比例&#x27;,</span></span><br><span class="line"><span class="string">         &#x27;持股数(股)&#x27;, &#x27;关联产品/机构&#x27;, &#x27;Name&#x27;, &#x27;url&#x27;]</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pd_people = pd.read_csv(people_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> pd_people.shape[<span class="number">0</span>] == <span class="number">10</span>:</span><br><span class="line">        columns = pd_people.iloc[:, <span class="number">0</span>].values.tolist()</span><br><span class="line">        columns.extend(pd_people.iloc[:, <span class="number">2</span>].values[:<span class="number">7</span>].tolist())</span><br><span class="line">        columns.extend(pd_people.iloc[:, <span class="number">4</span>].values[<span class="number">1</span>:<span class="number">8</span>].tolist())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 第二列</span></span><br><span class="line">        idx = pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">0</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line">        name = new_mod_plname(pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">1</span>])</span><br><span class="line">        dollar = pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">2</span>]</span><br><span class="line">        org_id = pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">3</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line">        values = [idx, name, dollar, org_id] <span class="comment"># id</span></span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">4</span>:].tolist())</span><br><span class="line"></span><br><span class="line">        values.append(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">0</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">1</span>:<span class="number">3</span>].tolist())</span><br><span class="line">        values.append(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">3</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">4</span>:<span class="number">7</span>].tolist())</span><br><span class="line"></span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">5</span>].values[<span class="number">1</span>:<span class="number">3</span>].tolist())</span><br><span class="line">        values.append(pd_people.iloc[:, <span class="number">5</span>].values[<span class="number">3</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">5</span>].values[<span class="number">4</span>:<span class="number">8</span>].tolist())</span><br><span class="line"></span><br><span class="line">        pd_pl_mod.drop(columns[<span class="number">2</span>], axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">        people_mod_dir = pl_root_dir + people_path + pl_csv.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;-mod.csv&#x27;</span></span><br><span class="line">        pd_pl_mod.to_csv(people_mod_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        pd_pl_mod = pd.DataFrame(np.array(values).reshape(<span class="number">1</span>,-<span class="number">1</span>), columns = columns)</span><br><span class="line">    <span class="keyword">elif</span> pd_people.shape[<span class="number">0</span>] == <span class="number">11</span>:</span><br><span class="line">        columns = pd_people.iloc[:, <span class="number">0</span>].values.tolist()</span><br><span class="line">        columns.extend(pd_people.iloc[:, <span class="number">2</span>].values[:<span class="number">7</span>].tolist())</span><br><span class="line">        columns.extend(pd_people.iloc[:, <span class="number">4</span>].values[<span class="number">1</span>:<span class="number">8</span>].tolist())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 第二列</span></span><br><span class="line">        idx = pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">0</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line">        name = new_mod_plname(pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">1</span>])</span><br><span class="line">        dollar = pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">2</span>]</span><br><span class="line">        org_id = pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">3</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line">        values = [idx, name, dollar, org_id] <span class="comment"># id</span></span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">1</span>].values[<span class="number">4</span>:].tolist())</span><br><span class="line"></span><br><span class="line">        values.append(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">0</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">1</span>:<span class="number">3</span>].tolist())</span><br><span class="line">        values.append(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">3</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">3</span>].values[<span class="number">4</span>:<span class="number">7</span>].tolist())</span><br><span class="line"></span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">5</span>].values[<span class="number">1</span>:<span class="number">3</span>].tolist())</span><br><span class="line">        values.append(pd_people.iloc[:, <span class="number">5</span>].values[<span class="number">3</span>].split(<span class="string">&#x27;复制&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">        values.extend(pd_people.iloc[:, <span class="number">5</span>].values[<span class="number">4</span>:<span class="number">8</span>].tolist())</span><br><span class="line"></span><br><span class="line">        pd_pl_mod.drop(columns[<span class="number">2</span>], axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">        people_mod_dir = pl_root_dir + people_path + pl_csv.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;-mod.csv&#x27;</span></span><br><span class="line">        pd_pl_mod.to_csv(people_mod_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        pd_pl_mod = pd.DataFrame(np.array(values).reshape(<span class="number">1</span>,-<span class="number">1</span>), columns = columns)</span><br><span class="line"></span><br><span class="line">    people_mod_dir = people_dir.split(<span class="string">&#x27;.csv&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;-mod.csv&#x27;</span></span><br><span class="line">    pd_pl_mod.to_csv(people_mod_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># break</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">f&#x27;第<span class="subst">&#123;i&#125;</span>条人员信息已处理完毕&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="股东和主要人员url匹配">4.2.3 股东和主要人员url匹配</h3>
<p>从 Fig.9 可以发现，股东名字和 url 并没有很好地对应，因此对该记录进行校正，删除多余的信息，仅保留与前面合伙人一直的url信息，如果不能匹配则填充为空值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_plname</span>(<span class="params">pl_name</span>):</span></span><br><span class="line">    pl_list = pl_name.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(pl_list[<span class="number">0</span>]) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> pl_list[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(pl_list[<span class="number">0</span>]) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> pl_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">updata_names</span>(<span class="params">dict_url</span>):</span></span><br><span class="line">    en_keys = <span class="built_in">dict</span>()</span><br><span class="line">    keys = dict_url.keys()</span><br><span class="line">    <span class="keyword">for</span> ky <span class="keyword">in</span> keys:</span><br><span class="line">        ky_split = ky.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ky_split) &gt; <span class="number">1</span>:</span><br><span class="line">            en_keys[ky_split[<span class="number">0</span>]] = ky</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            en_keys[ky] = ky</span><br><span class="line">    <span class="keyword">return</span> en_keys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_url</span>(<span class="params">name, dict_url</span>):</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">in</span> dict_url.keys():</span><br><span class="line">        <span class="keyword">return</span> dict_url[name]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> np.nan</span><br><span class="line"></span><br><span class="line">people_csvs = [<span class="string">&#x27;股东信息.csv&#x27;</span>, <span class="string">&#x27;主要人员.csv&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1212, 2115</span></span><br><span class="line">start = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, u_idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_all_firm.index[start:]):</span><br><span class="line">    i = i + start</span><br><span class="line">    name = pd_all_firm.loc[u_idx, <span class="string">&#x27;企业名称&#x27;</span>]</span><br><span class="line">    people_path = pd_all_firm.loc[u_idx, <span class="string">&#x27;公司目录&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> j, pl_csv <span class="keyword">in</span> <span class="built_in">enumerate</span>(people_csvs):</span><br><span class="line">        people_dir = pl_root_dir + people_path + pl_csv</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">            <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            columns:</span></span><br><span class="line"><span class="string">                [&#x27;序号&#x27;, &#x27;股东名称&#x27;, &#x27;股东名称.1&#x27;, &#x27;持股比例&#x27;,</span></span><br><span class="line"><span class="string">                 &#x27;持股数(股)&#x27;, &#x27;关联产品/机构&#x27;, &#x27;Name&#x27;, &#x27;url&#x27;]</span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> pd_all_firm.loc[u_idx, <span class="string">&#x27;股东数&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            pd_people = pd.read_csv(people_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">            numbers = pd_people[<span class="string">&#x27;序号&#x27;</span>].notnull().<span class="built_in">sum</span>()</span><br><span class="line">            columns = pd_people.columns</span><br><span class="line">            pd_pl_mod = pd_people.loc[:numbers-<span class="number">1</span>, columns[:-<span class="number">2</span>]]</span><br><span class="line">            pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">2</span>]].apply(mod_plname)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">in</span> pd_people.columns:</span><br><span class="line">                dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(pd_people[<span class="string">&#x27;Name&#x27;</span>].values, pd_people[<span class="string">&#x27;url&#x27;</span>].values))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_url[x])</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        dict_names = updata_names(dict_url)</span><br><span class="line">                        pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_names[x] <span class="keyword">if</span> x <span class="keyword">in</span> dict_names.keys() <span class="keyword">else</span> x)</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        keys = pd_people[<span class="string">&#x27;Name&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                        beg_idx = keys.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                        end_idx = keys.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                        keys = <span class="built_in">eval</span>(keys[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                        values = pd_people[<span class="string">&#x27;url&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                        beg_idx = values.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                        end_idx = values.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                        values = <span class="built_in">eval</span>(values[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line">                        dict_url = dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(keys, values))</span><br><span class="line"></span><br><span class="line">                    pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x:  mod_url(x, dict_url))</span><br><span class="line"></span><br><span class="line">                pd_pl_mod.drop(columns[<span class="number">2</span>], axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">                people_mod_dir = pl_root_dir + people_path + pl_csv.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;-mod.csv&#x27;</span></span><br><span class="line">                pd_pl_mod.to_csv(people_mod_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> pd_all_firm.loc[u_idx, <span class="string">&#x27;主要人员数&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            pd_people = pd.read_csv(people_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">            numbers = pd_people[<span class="string">&#x27;序号&#x27;</span>].notnull().<span class="built_in">sum</span>()</span><br><span class="line">            columns = pd_people.columns</span><br><span class="line">            pd_pl_mod = pd_people.loc[:numbers-<span class="number">1</span>, columns[:-<span class="number">2</span>]]</span><br><span class="line">            pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">1</span>]].apply(mod_plname)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;Name&#x27;</span> <span class="keyword">in</span> pd_people.columns:</span><br><span class="line">                dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(pd_people[<span class="string">&#x27;Name&#x27;</span>].values, pd_people[<span class="string">&#x27;url&#x27;</span>].values))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_url[x])</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        dict_names = updata_names(dict_url)</span><br><span class="line">                        pd_pl_mod[columns[<span class="number">1</span>]] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: dict_names[x] <span class="keyword">if</span> x <span class="keyword">in</span> dict_names.keys() <span class="keyword">else</span> x)</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        keys = pd_people[<span class="string">&#x27;Name&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                        beg_idx = keys.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                        end_idx = keys.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                        keys = <span class="built_in">eval</span>(keys[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                        values = pd_people[<span class="string">&#x27;url&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">                        beg_idx = values.index(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                        end_idx = values.index(<span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">                        values = <span class="built_in">eval</span>(values[beg_idx:end_idx+<span class="number">1</span>])</span><br><span class="line">                        dict_url = dict_url = <span class="built_in">dict</span>(<span class="built_in">zip</span>(keys, values))     </span><br><span class="line"></span><br><span class="line">                    pd_pl_mod[<span class="string">&#x27;url&#x27;</span>] = pd_pl_mod[columns[<span class="number">1</span>]].apply(<span class="keyword">lambda</span> x: mod_url(x, dict_url))                </span><br><span class="line"></span><br><span class="line">            people_mod_dir = pl_root_dir + people_path + pl_csv.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>] + <span class="string">&#x27;-mod.csv&#x27;</span></span><br><span class="line">            pd_pl_mod.to_csv(people_mod_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>, index = <span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># break</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">f&#x27;第<span class="subst">&#123;i&#125;</span>条人员信息已处理完毕&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="得到注销时间">4.2.4 得到注销时间</h3>
<p>此处，我们仍然使用动态爬虫的方式爬取注销时间，通过分析页面可以发现，注销的实践存储在 <code>xpath</code> 值为 <code>/html/body/div[3]/div/div/div[2]/table/tr[2]/td[3]</code> 的节点下，不过需要点击方可显示该节点。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pd_all_firm = pd.read_csv(<span class="string">&#x27;./All_pd_firm-mod.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">NodeExists</span>(<span class="params">drievr, input_code</span>):</span></span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">      driver.find_element_by_xpath(input_code)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">start_pos = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(browser_index):</span><br><span class="line">    i = i + start_pos</span><br><span class="line">    url = pd_all_firm.loc[idx, <span class="string">&#x27;Com_url&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    driver.get(url)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    expire_bt_xpath = <span class="string">&#x27;/html/body/div[1]/div[2]/div/div/a&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> NodeExists(driver, expire_bt_xpath):</span><br><span class="line">        driver.find_element_by_xpath(<span class="string">&#x27;/html/body/div[1]/div[2]/div/div/a&#x27;</span>).click()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        date = driver.find_element_by_xpath(<span class="string">&#x27;/html/body/div[3]/div/div/div[2]/table/tr[2]/td[3]&#x27;</span>).text</span><br><span class="line">        pd_all_firm.loc[idx, <span class="string">&#x27;吊销时间&#x27;</span>] = date</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">f&#x27;第<span class="subst">&#123;idx&#125;</span>个条目已经重新整理完毕！&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="更新所有数量信息-1">4.2.5 更新所有数量信息</h3>
<p>至此，我们已经对四个任务处理完毕，接下来，我们更新表格的的数量信息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">columns = [<span class="string">&#x27;企业表&#x27;</span>, <span class="string">&#x27;公司地址&#x27;</span>, <span class="string">&#x27;公司url&#x27;</span>, <span class="string">&#x27;股东信息&#x27;</span>,  <span class="string">&#x27;NUM_股东信息&#x27;</span>, <span class="string">&#x27;主要人员&#x27;</span>, <span class="string">&#x27;NUM_主要人员&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;专利信息&#x27;</span>, <span class="string">&#x27;NUM_专利信息&#x27;</span>, <span class="string">&#x27;资质证书&#x27;</span>, <span class="string">&#x27;NUM_资质证书&#x27;</span>, <span class="string">&#x27;软件著作权&#x27;</span>, <span class="string">&#x27;NUM_软件著作权&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;股东信息&#x27;</span>, <span class="string">&#x27;NUM_股东信息&#x27;</span>]</span><br><span class="line">pd_record = pd.DataFrame(columns = columns)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod_check_idx</span>(<span class="params">pd_data, idx, recheck_cols</span>):</span></span><br><span class="line">    ret_idx = []</span><br><span class="line">    <span class="keyword">for</span> i, col <span class="keyword">in</span> <span class="built_in">enumerate</span>(recheck_cols):</span><br><span class="line">        <span class="keyword">if</span> pd_data.loc[idx, col] == <span class="number">10</span>:</span><br><span class="line">            ret_idx.append(i)</span><br><span class="line">    <span class="keyword">return</span> ret_idx</span><br><span class="line"></span><br><span class="line">pd_all_pri_firm = pd.read_csv(<span class="string">&#x27;./All_pd_firm.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>, index_col = <span class="number">0</span>)</span><br><span class="line">start_pos = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> idx, i <span class="keyword">in</span> <span class="built_in">enumerate</span>(recheck_index[start_pos:]):</span><br><span class="line">    name = pd_all_firm.loc[i, <span class="string">&#x27;企业名称&#x27;</span>]</span><br><span class="line">    casset_path = pd_all_firm.loc[i, <span class="string">&#x27;公司目录&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;专利信息：zhuanlilist</span></span><br><span class="line"><span class="string">        资质证书：zhengshulist</span></span><br><span class="line"><span class="string">        软件著作权：rjzzqlist</span></span><br><span class="line"><span class="string">        作品著作权：zzqlist</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    cas_keys = [<span class="string">&#x27;专利信息&#x27;</span>, <span class="string">&#x27;资质证书&#x27;</span>, <span class="string">&#x27;软件著作权&#x27;</span>, <span class="string">&#x27;作品著作权&#x27;</span>] <span class="comment"># csv表名称</span></span><br><span class="line">    recheck_cols = [<span class="string">&#x27;专利信息数&#x27;</span>, <span class="string">&#x27;资质证书数&#x27;</span>, <span class="string">&#x27;软件著作权数&#x27;</span>, <span class="string">&#x27;作品著作权数&#x27;</span>] <span class="comment"># 数量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># if os.path.exists(pl_root_dir+casset_path):</span></span><br><span class="line">    <span class="comment">#     pass</span></span><br><span class="line">    <span class="comment"># else:</span></span><br><span class="line">    <span class="comment">#     os.makedirs(casset_path)</span></span><br><span class="line"></span><br><span class="line">    recheck_col_idx = mod_check_idx(pd_all_pri_firm, i, recheck_cols)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pd_all_firm.loc[i, recheck_cols]</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> recheck_col_idx:</span><br><span class="line">        casset_dir = pl_root_dir + casset_path + cas_keys[j] + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">        pd_comp = pd.read_csv(casset_dir, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        col = recheck_cols[j]</span><br><span class="line"></span><br><span class="line">        pd_all_firm.loc[i, col] = pd_comp.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> idx % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">f&#x27;第<span class="subst">&#123;idx+start_pos&#125;</span>个条目已经重新整理完毕！&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pd_all_firm.to_csv(<span class="string">&#x27;./All_pd_firm-mod.csv&#x27;</span>, encoding=<span class="string">&#x27;ansi&#x27;</span>, errors = <span class="string">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="删除旧的信息">4.2.6 删除旧的信息</h3>
<p>由于在处理数据过程中，以防万一我们都用 <code>-mod</code> 的后缀处理得到的所有信息，因此，再甲方确认处理完的信息无误之后，我们需要对旧信息进行删除，这里需要用到文件夹操作，具体代码如下：</p>
<ul>
<li><p>删除旧的公司信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">remove_name = [<span class="string">&#x27;股东信息.csv&#x27;</span>, <span class="string">&#x27;主要人员.csv&#x27;</span>, <span class="string">&#x27;营业执照信息.csv&#x27;</span>]</span><br><span class="line">keep_name = [<span class="string">&#x27;股东信息-mod.csv&#x27;</span>, <span class="string">&#x27;主要人员-mod.csv&#x27;</span>, <span class="string">&#x27;营业执照信息-mod.csv&#x27;</span>]</span><br><span class="line"></span><br><span class="line">start = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, u_idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(pd_all_firm.index[start:]):</span><br><span class="line">    i = i + start</span><br><span class="line">    name = pd_all_firm.loc[u_idx, <span class="string">&#x27;企业名称&#x27;</span>]</span><br><span class="line">    people_path = pd_all_firm.loc[u_idx, <span class="string">&#x27;公司目录&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    remove_name = [<span class="string">&#x27;股东信息.csv&#x27;</span>, <span class="string">&#x27;主要人员.csv&#x27;</span>, <span class="string">&#x27;营业执照信息.csv&#x27;</span>]</span><br><span class="line">    keep_name = [<span class="string">&#x27;股东信息-mod.csv&#x27;</span>, <span class="string">&#x27;主要人员-mod.csv&#x27;</span>, <span class="string">&#x27;营业执照信息-mod.csv&#x27;</span>]</span><br><span class="line">    people_dir = pl_root_dir + people_path</span><br><span class="line">    have_file_lists = os.listdir(people_dir)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">if</span> remove_name[j] <span class="keyword">in</span> have_file_lists <span class="keyword">and</span> keep_name[j] <span class="keyword">in</span> have_file_lists:</span><br><span class="line">            os.remove(os.path.join(people_dir, remove_name[j]))</span><br></pre></td></tr></table></figure></li>
<li><p>删除多余的任职表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pl_root_dir_new = pl_root_dir + <span class="string">&#x27;Results/&#x27;</span></span><br><span class="line">pl_dirs = os.listdir(pl_root_dir_new)</span><br><span class="line"></span><br><span class="line">remove_name = [<span class="string">&#x27;在外任职表.csv&#x27;</span>, <span class="string">&#x27;所有企业表.csv&#x27;</span>]</span><br><span class="line">keep_name = [<span class="string">&#x27;在外任职表-mod.csv&#x27;</span>, <span class="string">&#x27;所有企业表_mod.csv&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, tmp_dir <span class="keyword">in</span> <span class="built_in">enumerate</span>(pl_dirs):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> tmp_dir:</span><br><span class="line">        name = tmp_dir.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        name = tmp_dir</span><br><span class="line">    pl_dir = pl_root_dir_new + tmp_dir</span><br><span class="line">    have_file_lists = os.listdir(pl_dir)</span><br><span class="line"></span><br><span class="line">    remove_names = [name+<span class="string">&#x27;-&#x27;</span>+table <span class="keyword">for</span> table <span class="keyword">in</span> remove_name]</span><br><span class="line">    keep_names = [name+<span class="string">&#x27;-&#x27;</span>+table <span class="keyword">for</span> table <span class="keyword">in</span> keep_name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> remove_names[j] <span class="keyword">in</span> have_file_lists <span class="keyword">and</span> keep_names[j] <span class="keyword">in</span> have_file_lists:</span><br><span class="line">            os.remove(os.path.join(pl_dir, remove_names[j]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">f&#x27;第<span class="subst">&#123;i&#125;</span>个条目已经重新整理完毕！&#x27;</span>)  </span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="conclusion">5 Conclusion</h1>
<p>至此，所有信息处理完毕，甲方也十分满意。最后附上成品图。</p>
<p><img src = 'https://z3.ax1x.com/2021/10/02/4bC0nx.png' style="zoom:80%;" /></p>
<center>
Fig. 11 成果样例
</center>
<p>由于是别人的研究，本文不提供更详细的数据，代码已基本附上。所获取的数据仅用于研究，不做他用，展示数据已经过脱敏处理。图片皆为个人爬取后的数据截图，如有侵权，可联系邮箱进行删除。</p>
<p>申明：本文的代码均为个人原创，本文仅供学习和交流，请珍惜作者劳动成果，勿用作商业用途，如需商业用途或业务交流可联系邮箱 <code>e-mail:yangsuoly@qq.com</code> 进行进一步交流。</p>
]]></content>
      <categories>
        <category>Project</category>
        <category>Crawler</category>
      </categories>
      <tags>
        <tag>Crawler</tag>
        <tag>Project</tag>
      </tags>
  </entry>
  <entry>
    <title>DataAnalysis-Modeling</title>
    <url>/2021/06/19/DataAnalysis-Modeling/</url>
    <content><![CDATA[<h1 id="modeling-creation">1 Modeling creation</h1>
<p>经过前面的学习，已可以对数数据进行增删查补和清洗工作。接下来需要使用处理好的数据进行分析和建模。这一章要做的是运用数据来得到某些结果。</p>
<p>分析的第一步是搭建一个预测模型或者其他；根据模型的结果，可以分析该模型是否可靠。</p>
<a id="more"></a>
<h2 id="preparation">1.1 Preparation</h2>
<ul>
<li><p>Import modules</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]  <span class="comment"># 用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span>  <span class="comment"># 用来正常显示负号</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;figure.figsize&#x27;</span>] = (<span class="number">10</span>, <span class="number">6</span>)  <span class="comment"># 设置输出图片大小</span></span><br></pre></td></tr></table></figure></li>
<li><p>Load data</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 读取原数据数集</span></span><br><span class="line">train = pd.read_csv(<span class="string">&#x27;train.csv&#x27;</span>)</span><br><span class="line">train.shape</span><br><span class="line"></span><br><span class="line"><span class="comment">#读取清洗过的数据集</span></span><br><span class="line">data = pd.read_csv(<span class="string">&#x27;clear_data.csv&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="feature-engineer">1.2 Feature engineer</h2>
<h3 id="fillna">1.2.1 Fillna</h3>
<ul>
<li><p>对分类变量缺失值：填充某个缺失值字符(NA)、用最多类别的进行填充</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>train[<span class="string">&#x27;Cabin&#x27;</span>] = train[<span class="string">&#x27;Cabin&#x27;</span>].fillna(<span class="string">&#x27;NA&#x27;</span>)</span><br><span class="line">    train[<span class="string">&#x27;Embarked&#x27;</span>] = train[<span class="string">&#x27;Embarked&#x27;</span>].fillna(<span class="string">&#x27;S&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>对连续变量缺失值：填充均值、中位数、众数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>train[<span class="string">&#x27;Age&#x27;</span>] = train[<span class="string">&#x27;Age&#x27;</span>].fillna(train[<span class="string">&#x27;Age&#x27;</span>].mean())</span><br></pre></td></tr></table></figure></li>
<li><p>检查缺失值比例</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>train.isnull().<span class="built_in">sum</span>().sort_values(ascending=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">PassengerId    <span class="number">0</span></span><br><span class="line">Survived       <span class="number">0</span></span><br><span class="line">Pclass         <span class="number">0</span></span><br><span class="line">Name           <span class="number">0</span></span><br><span class="line">Sex            <span class="number">0</span></span><br><span class="line">Age            <span class="number">0</span></span><br><span class="line">SibSp          <span class="number">0</span></span><br><span class="line">Parch          <span class="number">0</span></span><br><span class="line">Ticket         <span class="number">0</span></span><br><span class="line">Fare           <span class="number">0</span></span><br><span class="line">Cabin          <span class="number">0</span></span><br><span class="line">Embarked       <span class="number">0</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h3 id="encoding-classification-variable">1.2.2 Encoding classification variable</h3>
<ul>
<li><p>取出所有输入特征</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = train[[<span class="string">&#x27;Pclass&#x27;</span>,<span class="string">&#x27;Sex&#x27;</span>,<span class="string">&#x27;Age&#x27;</span>,<span class="string">&#x27;SibSp&#x27;</span>,<span class="string">&#x27;Parch&#x27;</span>, <span class="string">&#x27;Fare&#x27;</span>, <span class="string">&#x27;Embarked&#x27;</span>]]</span><br></pre></td></tr></table></figure></li>
<li><p>虚拟变量转换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = pd.get_dummies(data)</span><br><span class="line">    data.head()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Sex_female</p>
</th>
<th>
<p>Sex_male</p>
</th>
<th>
<p>Embarked_C</p>
</th>
<th>
<p>Embarked_Q</p>
</th>
<th>
<p>Embarked_S</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>53.1000</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>8.0500</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h2 id="construction">1.3 Construction</h2>
<ul>
<li>处理完数据的下一步是选择合适模型</li>
<li>在进行模型选择前，需要对数据集进行学习的方式是 <strong>监督学习</strong> 还是 <strong>无监督学习</strong></li>
<li>模型的选择通过任务决定</li>
<li>除了根据们任务来选择模型，还可以根据数据样本量以及特征的稀疏性来决定</li>
<li>一般通常会尝试使用一个基本的模型来作为其 <code>baseline</code>，进而再训练其他模型做对比，最终选择泛化能力或性能比较好的模型</li>
</ul>
<p>可以使用机器学习最常用的一个库 <code>sklearn</code> 来完成模型的搭建，<code>sklearn</code> 算法的选择路径如下：</p>
<p><img src="https://z3.ax1x.com/2021/06/20/RF1cYn.png" /></p>
<p><strong>Note:</strong> 图源：<a href="https://mofanpy.com/tutorials/machine-learning/sklearn/select-method/">莫凡Python-选择学习方法</a>，如果想深入学习机器学习的话，也可关注该博客网站，上面有各大常用机器学习库的讲解视频的笔记，视频发布在 <a href="https://space.bilibili.com/243821484?spm_id_from=333.788.b_765f7570696e666f.1">B 站莫烦Python</a> 上，附几个热门的模块：</p>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Jx411L7LU">Matplotlib</a></li>
<li><a href="https://www.bilibili.com/video/BV1xW411Y7Qd">Scikit-learn (sklearn)</a></li>
<li><a href="https://www.bilibili.com/video/BV1Vx411j7kT">Pytorch 神经网络</a></li>
<li><a href="https://www.bilibili.com/video/BV1TW411Y7HU">Keras</a></li>
</ul>
<h3 id="split-data">1.3.1 Split data</h3>
<ul>
<li>按比例切割数据集(常有30%、25%、20%、15%和10%)</li>
<li>按目标变量分层进行等比切割</li>
<li>设置随机种子以便结果能复现</li>
</ul>
<p><strong>Note:</strong></p>
<ul>
<li>切割数据集是为了后续评估模型泛化能力</li>
<li>查看函数文档可以在 <code>notebook</code> 里面使用 <code>train_test_split?</code> 和 <code>help(train_test_split)</code> 后回车即可看到</li>
<li>分层和随机种子在参数里寻找</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">    X = data.astype(<span class="string">&#x27;float64&#x27;</span>)</span><br><span class="line">    y = train[<span class="string">&#x27;Survived&#x27;</span>].astype(<span class="string">&#x27;float64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    X_train, X_test, y_train, y_test = train_test_split(X, y, stratify=y, random_state=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>查看数据形状</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>X_train.shape, X_test.shape</span><br><span class="line"></span><br><span class="line">((<span class="number">668</span>, <span class="number">10</span>), (<span class="number">223</span>, <span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<h3 id="modeling">1.3.2 Modeling</h3>
<ul>
<li>创建基于线性模型的分类模型（逻辑回归）</li>
<li>创建基于树的分类模型（决策树、随机森林）</li>
<li>查看模型的参数，并更改参数值，观察模型变化</li>
</ul>
<p><strong>Note:</strong></p>
<ul>
<li>逻辑回归不是回归模型而是 <strong>分类模型</strong>，不要与<code>LinearRegression</code> 混淆</li>
<li>随机森林其实是决策树集成为了降低决策树过拟合的情况</li>
<li>线性模型所在的模块为 <code>sklearn.linear_model</code></li>
<li>树模型所在的模块为 <code>sklearn.ensemble</code></li>
</ul>
<p><strong>线性模型的处理逻辑:</strong> 线性函数可以将平面进行分割，就形成了二分类问题。多分类的处理逻辑类似于线性规划，将平面分割为一个个小块。</p>
<h3 id="cases">1.3.3 Cases</h3>
<p>本小节使用支持向量机和随即森林两个模型进行模型构建。</p>
<ul>
<li><p>支持向量机</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVCfrom sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"></span><br><span class="line">    clf = SVC(probability=<span class="literal">True</span>)</span><br><span class="line">    clf.fit(X_train, y_train</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看训练集和测试集score值</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">&quot;Training set score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(clf.score(X_train, y_train)))</span><br><span class="line">    print(<span class="string">&quot;Testing set score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(clf.score(X_test, y_test)))</span><br><span class="line"></span><br><span class="line">Training <span class="built_in">set</span> score: <span class="number">0.70</span>Testing <span class="built_in">set</span> score: <span class="number">0.64</span></span><br></pre></td></tr></table></figure></li>
<li><p>随机森林</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 默认参数的随机森林分类模型</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rfc = RandomForestClassifier()</span><br><span class="line">    rfc.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line">RandomForestClassifier()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">&quot;Training set score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(rfc.score(X_train, y_train)))</span><br><span class="line">    print(<span class="string">&quot;Testing set score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(rfc.score(X_test, y_test)))</span><br><span class="line"></span><br><span class="line">Training <span class="built_in">set</span> score: <span class="number">0.99</span>Testing <span class="built_in">set</span> score: <span class="number">0.81</span></span><br></pre></td></tr></table></figure>
<p>对随机森林模型进行调参：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 调整参数后的随机森林分类模型</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rfc2 = RandomForestClassifier(n_estimators=<span class="number">100</span>, max_depth=<span class="number">5</span>)</span><br><span class="line">    rfc2.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;Training set score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(rfc2.score(X_train, y_train)))</span><br><span class="line">    print(<span class="string">&quot;Testing set score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(rfc2.score(X_test, y_test)))</span><br><span class="line"></span><br><span class="line">Training <span class="built_in">set</span> score: <span class="number">0.86</span>Testing <span class="built_in">set</span> score: <span class="number">0.83</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="prediction">1.4 Prediction</h2>
<p>一般监督模型在 <code>sklearn</code> 里面有个 <code>predict</code> 能输出预测标签，<code>predict_proba</code> 则可以输出标签概率。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>pred = clf.predict(X_train)</span><br><span class="line">    pred[:<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">array([<span class="number">1.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li><p>预测概率</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>pred_proba = clf.predict_proba(X_train)</span><br><span class="line">    pred_proba[:<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">array([[<span class="number">0.43518882</span>, <span class="number">0.56481118</span>],</span><br><span class="line">       [<span class="number">0.68639392</span>, <span class="number">0.31360608</span>],</span><br><span class="line">       [<span class="number">0.62646492</span>, <span class="number">0.37353508</span>],</span><br><span class="line">       [<span class="number">0.62676837</span>, <span class="number">0.37323163</span>],</span><br><span class="line">       [<span class="number">0.70955025</span>, <span class="number">0.29044975</span>],</span><br><span class="line">       [<span class="number">0.72361218</span>, <span class="number">0.27638782</span>],</span><br><span class="line">       [<span class="number">0.64503542</span>, <span class="number">0.35496458</span>],</span><br><span class="line">       [<span class="number">0.38964073</span>, <span class="number">0.61035927</span>],</span><br><span class="line">       [<span class="number">0.23539098</span>, <span class="number">0.76460902</span>],</span><br><span class="line">       [<span class="number">0.26563197</span>, <span class="number">0.73436803</span>]])</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="model-evaluation">2 Model evaluation</h1>
<p>根据之前的模型的建模，已经学会了运用 <code>sklearn</code> 库来完成建模，以及数据集的划分等操作。那么如何评估模型的优劣呢？以及如何判断模型给出的结果是否有效呢？这也是本次任务需要学习的内容。</p>
<h2 id="preparation-1">2.1 Preparation</h2>
<h3 id="load-modules">2.1.1 Load modules</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"></span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]  <span class="comment"># 用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span>  <span class="comment"># 用来正常显示负号</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;figure.figsize&#x27;</span>] = (<span class="number">10</span>, <span class="number">6</span>)  <span class="comment"># 设置输出图片大小</span></span><br></pre></td></tr></table></figure>
<h3 id="load-data">2.1.2 Load data</h3>
<p>一般先取出 <code>X</code> 和 <code>y</code> 后再切割，有些情况会使用到未切割的，这时候 <code>X</code> 和 <code>y</code> 就可以用，<code>x</code> 是清洗好的数据，<code>y</code> 是我们要预测的存活数据 <code>Survived</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = pd.read_csv(<span class="string">&#x27;clear_data.csv&#x27;</span>)</span><br><span class="line">    train = pd.read_csv(<span class="string">&#x27;train.csv&#x27;</span>)</span><br><span class="line">    X = data.astype(<span class="string">&#x27;float64&#x27;</span>)</span><br><span class="line">    y = train[<span class="string">&#x27;Survived&#x27;</span>].astype(<span class="string">&#x27;float64&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="split-data-1">2.1.3 Split data</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对数据集进行切割</span></span><br><span class="line">    X_train, X_test, y_train, y_test = train_test_split(X, y, stratify=y, random_state=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>注意到，在本例子中使用了 <code>stratify</code> 参数，其目的是保持测试集与整个数据集里 <code>y</code> 的数据分类比例一致。</p>
<p>举个栗子： 如何整个数据集有 1000 行，<code>y</code> 列的数据也是 1000 个，而且分两类：0 和 1，其中 0 有 300 个，1 有 700 个，即数据分类的比例为 3：7。那么现在把整个数据 <code>split</code>，因为 <code>test_size = 0.2</code>，所以训练集分到 800 个数据，测试集分到 200 个数据。</p>
<p><strong>重点</strong>：由于 <code>stratify = y</code>，则训练集和测试集中的数据分类比例将与 <code>y</code> 一致，也是 3：7，结果就是在训练集中，有 240 个 0 和 560 个 1；测试集中有 60 个 0 和 140 个 1 。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>y_train.values.shape</span><br><span class="line"></span><br><span class="line">(<span class="number">668</span>,)</span><br></pre></td></tr></table></figure>
<h2 id="construction-1">2.2 Construction</h2>
<ul>
<li><p>拟合</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 默认参数逻辑回归模型</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>clf = RandomForestClassifier()</span><br><span class="line">    clf.fit(X_train.values, y_train)</span><br></pre></td></tr></table></figure></li>
<li><p>预测</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>clf.predict(X_test)[:<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">array([<span class="number">0.</span>, <span class="number">1.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>])</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="evaluation">2.3 Evaluation</h2>
<ul>
<li>模型评估是为了知道模型的泛化能力。</li>
<li>交叉验证（<code>cross-validation</code>）是一种评估泛化性能的统计学方法，它比单次划分训练集和测试集的方法更加稳定、全面。</li>
<li>在交叉验证中，数据被多次划分，并且需要训练多个模型。</li>
<li>最常用的交叉验证是 <code>k</code> 折交叉验证（<code>k-fold cross-validation</code>），其中 <code>k</code> 是由用户指定的数字，通常取 5 或 10。</li>
<li>准确率（<code>Precision</code>）度量的是被预测为正例的样本中有多少是真正的正例</li>
<li>召回率（<code>Recall</code>）度量的是正类样本中有多少被预测为正类</li>
<li>f-分数是准确率与召回率的调和平均</li>
</ul>
<h3 id="cross-validation">2.3.1 Cross-validation</h3>
<ol type="1">
<li><p>概念</p>
<p>交叉验证是建立模型和验证模型参数时常用的办法。顾名思义，就是重复的对样本数据进行切分，组合为不同的训练集和测试集，并用训练集来训练模型，用测试集来评估模型。</p>
<p>在此基础上可以得到多组不同的训练集和测试集，某次训练集中的某样本在下次可能成为测试集中的样本，即所谓“交叉”。</p></li>
<li><p><strong>思考：那么什么时候才需要交叉验证呢？</strong></p>
<p>交叉验证常用在数据不是很充足时。如果数据样本量较小，可以采用交叉验证来训练优化选择模型。若样本充足，一般可把数据随机地分成三份：<code>Training Set</code>，<code>Validation Set</code>，<code>Test Set</code>。用 <code>Training Set</code> 来训练模型，用 <code>Validation Set</code> 来评估模型预测的好坏和选择模型及其对应的参数。把最终得到的模型再用于 <code>Test Set</code> ，最终决定使用哪个模型以及对应参数。</p></li>
<li><p><strong>常见形式：</strong></p>
<ul>
<li><code>Holdout</code></li>
</ul>
<p>常识来说，Holdout 验证并非一种交叉验证，因为数据并没有交叉使用。 随机从最初的样本中选出部分，形成交叉验证数据，而剩余的就当做训练数据。 一般来说，少于原本样本三分之一的数据被选做验证数据。</p>
<ul>
<li><code>K-fold cross-validation</code>:</li>
</ul>
<p><code>K</code> 折交叉验证，初始采样分割成 <code>K</code> 个子样本，一个单独的子样本被保留作为验证模型的数据，其他 <code>K-1</code> 个样本用来训练。交叉验证重复K次，每个子样本验证一次，平均 <code>K</code> 次的结果或者使用其它结合方式，最终得到一个单一估测。这个方法的优势在于，同时重复运用随机产生的子样本进行训练和验证，每次的结果验证一次，10 折交叉验证是最常用的。5 折交叉验证的示例图如下： <img src="https://z3.ax1x.com/2021/06/20/RF1soj.png" /></p>
<ul>
<li><code>Leave-one-out Cross Validation</code>:</li>
</ul>
<p>留一验证（<code>LOOCV</code>）是 <code>K</code> 折交叉验证的特例，此时折数 <code>K</code> 等于原本样本个数。意指只使用原本样本中的一项来当做验证资料， 而剩余的则留下来当做训练资料。 这个步骤一直持续到每个样本都被当做一次验证资料。在某些情况下是存在有效率的演算法，如使用<code>kernel regression</code> 和 <code>Tikhonov regularization</code>。</p>
<p><strong>Note:</strong> 上述交叉验证的解释内容部分来自搜狗百科词条 <a href="https://baike.sogou.com/v7413760.htm?fromTitle=%E4%BA%A4%E5%8F%89%E9%AA%8C%E8%AF%81">交叉验证</a>。</p></li>
<li><p><strong>K 折交叉验证的使用</strong></p>
<p>在本节中主要介绍 <code>K</code> 折交叉验证的使用，借助 <code>sklearn.model_selection</code> 来实现利用 10 折交叉验证来评估前文的随机森林分类模型。</p></li>
</ol>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line">    clf = RandomForestClassifier()</span><br><span class="line">    scores = cross_val_score(clf, X_train, y_train, cv=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># k折交叉验证分数</span></span><br><span class="line">    scores</span><br><span class="line"></span><br><span class="line">array([<span class="number">0.88059701</span>, <span class="number">0.80597015</span>, <span class="number">0.8358209</span> , <span class="number">0.82089552</span>, <span class="number">0.7761194</span> ,</span><br><span class="line">       <span class="number">0.8358209</span> , <span class="number">0.8358209</span> , <span class="number">0.80597015</span>, <span class="number">0.83333333</span>, <span class="number">0.8030303</span> ])</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 平均交叉验证分数</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">&quot;Average cross-validation score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(scores.mean()))</span><br><span class="line"></span><br><span class="line">Average cross-validation score: <span class="number">0.82</span></span><br></pre></td></tr></table></figure></p>
<p>折数越多代表着运行时间越长。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> timefrom sklearn.model_selection</span><br><span class="line"><span class="keyword">import</span> LeaveOneOut</span><br><span class="line"></span><br><span class="line"><span class="comment"># 10 折</span></span><br><span class="line">start = time.time()</span><br><span class="line">scores_fold = cross_val_score(clf, X_train, y_train, cv=<span class="number">10</span>)</span><br><span class="line">transition = time.time()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 留一验证</span></span><br><span class="line">loocv = LeaveOneOut()</span><br><span class="line">scores_leave = cross_val_score(clf, X_train, y_train, cv=loocv)</span><br><span class="line">end = time.time()</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;The 10-fold spend &#123;:.2f&#125;s, the leave one spend &#123;:.2f&#125;s&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">        transition-start, end-transition))</span><br><span class="line">print(<span class="string">&quot;Average 10-fold cross-validation score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(scores.mean()))</span><br><span class="line">print(<span class="string">&quot;Average leave-one-out cross-validation score: &#123;:.2f&#125;&quot;</span>.<span class="built_in">format</span>(scores.mean()))</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">The <span class="number">10</span>-fold spend <span class="number">2.72</span>s, the leave one spend <span class="number">189.75</span>s</span><br><span class="line">Average <span class="number">10</span>-fold cross-validation score: <span class="number">0.82</span></span><br><span class="line">Average leave-one-out cross-validation score: <span class="number">0.82</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="built_in">len</span>(y_train)/<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">66.8</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="number">189.75</span>/<span class="number">2.72</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">69.7610294117647</span></span><br></pre></td></tr></table></figure>
<p>可以发现采用 <code>10</code> 折仅费了 <code>2.72s</code>，而将折数上调至极限（留一验证）时，花费的时间几乎增加了了 70 倍，同时可以发现倍数与折数比几乎相同。</p>
<h3 id="confusion-matrix">2.3.2 Confusion matrix</h3>
<p><strong>任务：</strong></p>
<ul>
<li>计算二分类问题的混淆矩阵</li>
<li>计算精确率、召回率以及f-分数</li>
</ul>
<ol type="1">
<li><p>混肴矩阵</p>
<p>示意图如下：</p>
<p><img src="https://z3.ax1x.com/2021/06/20/RF16Fs.png" /></p></li>
<li><p>指标值</p>
<p>准确率 <code>Accuracy</code>，精确度 <code>Precision</code>，<code>Recall</code>，<code>f-score</code> 的计算方式：</p>
<p><img src="https://z3.ax1x.com/2021/06/20/RF1Deg.png" /></p>
<ul>
<li>混淆矩阵的方法在 <code>sklearn.metrics</code> 模块</li>
<li>混淆矩阵需要输入真实标签和预测标签</li>
<li><code>Precision</code>，<code>Recall</code>，<code>f-score</code>可以使用 <code>classification_report</code> 模块</li>
</ul></li>
</ol>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> confusion_matrix</span><br><span class="line"></span><br><span class="line">clf = RandomForestClassifier()</span><br><span class="line">clf.fit(X_train.values, y_train) <span class="comment"># 训练</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型预测结果</span></span><br><span class="line">pred = clf.predict(X_train)</span><br></pre></td></tr></table></figure></p>
<p><strong>混淆矩阵：</strong></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>confusion_matrix(y_train, pred)</span><br><span class="line"></span><br><span class="line">array([[<span class="number">412</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>, <span class="number">256</span>]], dtype=int64)</span><br></pre></td></tr></table></figure></p>
<p><strong>指标值：</strong></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report</span><br><span class="line">print(classification_report(y_train, pred))</span><br></pre></td></tr></table></figure></p>
<pre><code>              precision    recall  f1-score   support

         0.0       1.00      1.00      1.00       412
         1.0       1.00      1.00      1.00       256

    accuracy                           1.00       668
   macro avg       1.00      1.00      1.00       668
weighted avg       1.00      1.00      1.00       668</code></pre>
<h3 id="roc-curve">2.3.3 ROC curve</h3>
<ul>
<li>ROC曲线在sklearn中的模块为<code>sklearn.metrics</code></li>
<li>ROC曲线下面所包围的面积越大越好</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC <span class="comment"># 支持向量机</span></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> roc_curve</span><br><span class="line"></span><br><span class="line"><span class="comment"># clf = SVC(decision_function_shape=&quot;ovr&quot;,probability=True)</span></span><br><span class="line">clf = SVC(probability=<span class="literal">True</span>)</span><br><span class="line">clf.fit(X_train.values, y_train) <span class="comment"># 训练</span></span><br><span class="line"></span><br><span class="line">fpr, tpr, thresholds = roc_curve(y_test, clf.decision_function(X_test))</span><br><span class="line">plt.plot(fpr, tpr, label=<span class="string">&quot;ROC Curve&quot;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&quot;FPR&quot;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&quot;TPR (recall)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到最接近于0的阈值</span></span><br><span class="line">close_zero = np.argmin(np.<span class="built_in">abs</span>(thresholds))</span><br><span class="line">plt.plot(fpr[close_zero], tpr[close_zero], <span class="string">&#x27;o&#x27;</span>, markersize=<span class="number">10</span>,</span><br><span class="line">         label=<span class="string">&quot;threshold zero&quot;</span>, fillstyle=<span class="string">&quot;none&quot;</span>, c=<span class="string">&#x27;k&#x27;</span>, mew=<span class="number">2</span>)</span><br><span class="line">plt.legend(loc=<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://z3.ax1x.com/2021/06/20/RF1wy8.png" /></p>
<p>在上述使用的支持向量机中，对于 <code>n</code> 分类，会有 <code>n</code> 个分类器，然后，任意两个分类器都可以算出一个分类界面，这样，用 <code>decision_function()</code> 时，对于任意一个样例，就会有 <span class="math inline">\(n*(n-1)/2\)</span> 个值。</p>
<p>任意两个分类器可以算出一个分类界面，然后这个值就是距离分类界面的距离。这个函数可能是为了统计画图，对于二分类时最明显，用来统计每个点离超平面有多远，为了在空间中直观的表示数据以及画超平面还有间隔平面等。 <code>decision_function_shape</code> 为 <code>ovr</code> 时是 4 个值，为 <code>ovo</code> 时是 6 个值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>clf.decision_function(X_test)[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">array([-<span class="number">0.98942638</span>, -<span class="number">0.96365727</span>, -<span class="number">0.81459531</span>, -<span class="number">0.64715413</span>, -<span class="number">0.38873267</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>np.argmin()</code></p>
<p>获取最小值索引位置。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>np.argmin(np.<span class="built_in">abs</span>(thresholds))</span><br><span class="line"></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure></li>
<li><p>计算得分</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>clf.predict_proba(X) <span class="comment">#这个是得分,每个分类器的得分，取最大得分对应的类。</span></span><br><span class="line"></span><br><span class="line">array([[<span class="number">0.68136476</span>, <span class="number">0.31863524</span>],</span><br><span class="line">       [<span class="number">0.61321679</span>, <span class="number">0.38678321</span>],</span><br><span class="line">       [<span class="number">0.68211357</span>, <span class="number">0.31788643</span>],</span><br><span class="line">       			...,       </span><br><span class="line">       [<span class="number">0.63577539</span>, <span class="number">0.36422461</span>],</span><br><span class="line">       [<span class="number">0.61380992</span>, <span class="number">0.38619008</span>],</span><br><span class="line">       [<span class="number">0.68829583</span>, <span class="number">0.31170417</span>]])</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="classification-boundary">2.3.4 Classification boundary</h3>
<p>借助 <code>decision_function</code> 还在输入特征较少时直观地画出分类边界图。下面以一个输入特征为二维的小例子展示二维平面分类边界的绘制，案例参考自 <a href="https://blog.csdn.net/o1101574955/article/details/70212126">胖大海瘦西湖的博文</a>。</p>
<ul>
<li><p>模型构建</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建输入特征和输出特征</span></span><br><span class="line">X = np.array([[-<span class="number">1</span>,-<span class="number">1</span>],[-<span class="number">2</span>,-<span class="number">1</span>],[<span class="number">1</span>,<span class="number">1</span>],[<span class="number">2</span>,<span class="number">1</span>],[-<span class="number">1</span>,<span class="number">1</span>],[-<span class="number">1</span>,<span class="number">2</span>],[<span class="number">1</span>,-<span class="number">1</span>],[<span class="number">1</span>,-<span class="number">2</span>]])</span><br><span class="line">y = np.array([<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># clf = SVC(decision_function_shape=&quot;ovr&quot;,probability=True)</span></span><br><span class="line">clf = SVC(probability=<span class="literal">True</span>)</span><br><span class="line">clf.fit(X, y)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plot_step=<span class="number">0.02</span></span><br><span class="line">x_min, x_max = X[:, <span class="number">0</span>].<span class="built_in">min</span>() - <span class="number">1</span>, X[:, <span class="number">0</span>].<span class="built_in">max</span>() + <span class="number">1</span> <span class="comment"># X 的第一维作为横坐标</span></span><br><span class="line">y_min, y_max = X[:, <span class="number">1</span>].<span class="built_in">min</span>() - <span class="number">1</span>, X[:, <span class="number">1</span>].<span class="built_in">max</span>() + <span class="number">1</span> <span class="comment"># 第二维作为纵坐标</span></span><br><span class="line"></span><br><span class="line">xx, yy = np.meshgrid(np.arange(x_min, x_max, plot_step),</span><br><span class="line">                     np.arange(y_min, y_max, plot_step))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对坐标风格上的点进行预测，来画分界面。其实最终看到的类的分界线就是分界面的边界线。</span></span><br><span class="line">Z = clf.predict(np.c_[xx.ravel(), yy.ravel()])</span><br><span class="line">Z = Z.reshape(xx.shape)</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>Note:</strong> 上述代码中使用到了 <code>np.meshgrid</code> 函数，官方文档看起来文绉绉的，理解起来不是很直观。通俗来讲，这个函数的作用是利用两个坐标轴上的点在平面上画网格。</p>
<p>返回两个参数，<code>xx</code> 中记录了网格中所有点的横坐标，<code>yy</code> 记录了网格中所有点的纵坐标。其运行过程可通过下图加深理解：</p>
<p><img src="https://z3.ax1x.com/2021/06/20/RF10OS.jpg" /></p>
<center>
（图源公众号： Python数据之道）
</center>
<p><strong>用法：</strong></p>
<ul>
<li><code>[X, Y] = meshgrid(x, y)</code></li>
<li><code>[X, Y] = meshgrid(x)</code>与 <code>[X, Y] = meshgrid(x, x)</code> 等同</li>
<li><code>[X, Y, Z] = meshgrid(x, y, z)</code> 生成三维数组，可用来计算三变量的函数和绘制三维立体图</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cs = plt.contourf(xx, yy, Z, cmap=plt.cm.Paired) <span class="comment"># 绘制轮廓线</span></span><br><span class="line">plt.axis(<span class="string">&quot;tight&quot;</span>)</span><br><span class="line"></span><br><span class="line">class_names=<span class="string">&quot;ABCD&quot;</span></span><br><span class="line">plot_colors=<span class="string">&quot;rybg&quot;</span></span><br><span class="line"><span class="keyword">for</span> i, n, c <span class="keyword">in</span> <span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">4</span>), class_names, plot_colors):</span><br><span class="line">    idx = np.where(y == i) <span class="comment">#i为0或者1，两个类</span></span><br><span class="line">    plt.scatter(X[idx, <span class="number">0</span>], X[idx, <span class="number">1</span>],</span><br><span class="line">                c=c, cmap=plt.cm.Paired,</span><br><span class="line">                label=<span class="string">&quot;Class %s&quot;</span> % n)</span><br><span class="line"></span><br><span class="line">plt.xlim(x_min, x_max)</span><br><span class="line">plt.ylim(y_min, y_max)</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;upper right&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Decision Boundary&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src="https://z3.ax1x.com/2021/06/20/RF1rwQ.png" /></p>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Data Analysis</category>
      </categories>
      <tags>
        <tag>Data Analysis</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>DataAnalysis-Describe</title>
    <url>/2021/06/15/DataAnalysis-Describe/</url>
    <content><![CDATA[<h1 id="概述">1 概述</h1>
<p>这门课程得主要目的是通过真实的数据，以实战的方式了解数据分析的流程和熟悉数据分析python的基本操作。知道了课程的目的之后，我们接下来我们要正式的开始数据分析的实战教学，完成kaggle上<a href="https://www.kaggle.com/c/titanic/overview">泰坦尼克的任务</a>，实战数据分析全流程。 这里有两份资料： 教材《Python for Data Analysis》和 baidu.com &amp; google.com（善用搜索引擎）</p>
<a id="more"></a>
<h1 id="数据载入及初步观察">2 数据载入及初步观察</h1>
<h2 id="载入数据">2.1 载入数据</h2>
<p>数据集下载 https://www.kaggle.com/c/titanic/overview</p>
<ul>
<li><p>导入模块</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> nnp</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="加载数据">2.2 加载数据</h2>
<ul>
<li><p>相对路径</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = pd.read_csv(<span class="string">&#x27;./train.csv&#x27;</span>, encoding = <span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>绝对路径</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = pd.read_csv(<span class="string">r&quot;D:\Demo\University\XMU\Python\Artificial-intelligence\Data analysis\第一单元项目集合\train.csv&quot;</span>, encoding = <span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p><code>read_table</code> 读取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置 sep</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = pd.read_table(<span class="string">&#x27;./train.csv&#x27;</span>, sep = <span class="string">&#x27;,&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>获取当前路径</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(os.getcwd())</span><br><span class="line"></span><br><span class="line">D:\Demo\University\XMU\Python\Artificial-intelligence\Data analysis\第一单元项目集合</span><br></pre></td></tr></table></figure></li>
<li><p>逐块读取</p>
<p>每500行为一个数据模块，逐块读取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置 chunksize 参数</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>chunker = pd.read_csv(<span class="string">&#x27;train.csv&#x27;</span>, chunksize=<span class="number">500</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> df <span class="keyword">in</span> chunker:</span><br><span class="line">        print(<span class="built_in">type</span>(df), df.shape)</span><br><span class="line"></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">pandas</span>.<span class="title">core</span>.<span class="title">frame</span>.<span class="title">DataFrame</span>&#x27;&gt; (<span class="params"><span class="number">500</span>, <span class="number">12</span></span>)</span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> &#x27;<span class="title">pandas</span>.<span class="title">core</span>.<span class="title">frame</span>.<span class="title">DataFrame</span>&#x27;&gt; (<span class="params"><span class="number">391</span>, <span class="number">12</span></span>)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="数据预处理">2.3 数据预处理</h2>
<h3 id="更改表头">2.3.1 更改表头</h3>
<p>索引改为乘客ID（对于某些英文资料，我们可以通过翻译来更直观的熟悉我们的数据）： PassengerId =&gt; 乘客ID<br />
Survived =&gt; 是否幸存<br />
Pclass =&gt; 乘客等级(1/2/3等舱位)<br />
Name =&gt; 乘客姓名<br />
Sex =&gt; 性别<br />
Age =&gt; 年龄<br />
SibSp =&gt; 堂兄弟/妹个数<br />
Parch =&gt; 父母与小孩个数<br />
Ticket =&gt; 船票信息<br />
Fare =&gt; 票价<br />
Cabin =&gt; 客舱<br />
Embarked =&gt; 登船港口</p>
<ul>
<li><p>方式一</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>maps = &#123;<span class="string">&#x27;PassengerId&#x27;</span>: <span class="string">&#x27;乘客ID&#x27;</span>, <span class="string">&#x27;Survived&#x27;</span>: <span class="string">&#x27;是否幸存&#x27;</span>, <span class="string">&#x27;Pclass&#x27;</span>: <span class="string">&#x27;乘客等级(1/2/3等舱位)&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;乘客姓名&#x27;</span>, <span class="string">&#x27;Sex&#x27;</span>: <span class="string">&#x27;性别&#x27;</span>, <span class="string">&#x27;Age&#x27;</span>: <span class="string">&#x27;年龄&#x27;</span>, <span class="string">&#x27;SibSp&#x27;</span>: <span class="string">&#x27;堂兄弟/妹个数&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Parch&#x27;</span>: <span class="string">&#x27;父母与小孩个数&#x27;</span>, <span class="string">&#x27;Ticket&#x27;</span>: <span class="string">&#x27;船票信息&#x27;</span>, <span class="string">&#x27;Fare&#x27;</span>: <span class="string">&#x27;票价&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Cabin&#x27;</span>: <span class="string">&#x27;客舱&#x27;</span>, <span class="string">&#x27;Embarked&#x27;</span>: <span class="string">&#x27;登船港口&#x27;</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.rename(columns=maps, inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>方式二</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = data = pd.read_csv(<span class="string">&#x27;./train.csv&#x27;</span>, encoding = <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>columns = [<span class="string">&#x27;乘客ID&#x27;</span>,<span class="string">&#x27;是否幸存&#x27;</span>,<span class="string">&#x27;仓位等级&#x27;</span>,<span class="string">&#x27;姓名&#x27;</span>,<span class="string">&#x27;性别&#x27;</span>,<span class="string">&#x27;年龄&#x27;</span>,<span class="string">&#x27;兄弟姐妹个数&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;父母子女个数&#x27;</span>,<span class="string">&#x27;船票信息&#x27;</span>,<span class="string">&#x27;票价&#x27;</span>,<span class="string">&#x27;客舱&#x27;</span>,<span class="string">&#x27;登船港口&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.columns = columns</span><br></pre></td></tr></table></figure></li>
<li><p>方式三</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>df = pd.read_csv(<span class="string">&#x27;train.csv&#x27;</span>,</span><br><span class="line">         names=[<span class="string">&#x27;乘客ID&#x27;</span>,<span class="string">&#x27;是否幸存&#x27;</span>,<span class="string">&#x27;仓位等级&#x27;</span>,<span class="string">&#x27;姓名&#x27;</span>,<span class="string">&#x27;性别&#x27;</span>,<span class="string">&#x27;年龄&#x27;</span>, <span class="string">&#x27;兄弟姐妹个数&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;父母子女个数&#x27;</span>,<span class="string">&#x27;船票信息&#x27;</span>,<span class="string">&#x27;票价&#x27;</span>,<span class="string">&#x27;客舱&#x27;</span>,<span class="string">&#x27;登船港口&#x27;</span>],</span><br><span class="line">                 index_col=<span class="string">&#x27;乘客ID&#x27;</span>,header=<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="初步观察">2.3.2 初步观察</h3>
<p>导入数据后，你可能要对数据的整体结构和样例进行概览，比如说，数据大小、有多少列，各列都是什么格式的，是否包含null等。</p>
<ul>
<li><p>查看信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.info()</span><br><span class="line"></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">pandas</span>.<span class="title">core</span>.<span class="title">frame</span>.<span class="title">DataFrame</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">RangeIndex</span>:</span> <span class="number">891</span> entries, <span class="number">0</span> to <span class="number">890</span></span><br><span class="line">Data columns (total <span class="number">12</span> columns):</span><br><span class="line"> <span class="comment">#   Column  Non-Null Count  Dtype  </span></span><br><span class="line">---  ------  --------------  -----  </span><br><span class="line"> <span class="number">0</span>   乘客ID    <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">1</span>   是否幸存    <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">2</span>   仓位等级    <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">3</span>   姓名      <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">4</span>   性别      <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">5</span>   年龄      <span class="number">714</span> non-null    float64</span><br><span class="line"> <span class="number">6</span>   兄弟姐妹个数  <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">7</span>   父母子女个数  <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">8</span>   船票信息    <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">9</span>   票价      <span class="number">891</span> non-null    float64</span><br><span class="line"> <span class="number">10</span>  客舱      <span class="number">204</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">11</span>  登船港口    <span class="number">889</span> non-null    <span class="built_in">object</span></span><br><span class="line">dtypes: float64(<span class="number">2</span>), int64(<span class="number">5</span>), <span class="built_in">object</span>(<span class="number">5</span>)</span><br><span class="line">memory usage: <span class="number">83.7</span>+ KB</span><br></pre></td></tr></table></figure></li>
<li><p>开头和结尾</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>乘客ID</p>
</th>
<th>
<p>是否幸存</p>
</th>
<th>
<p>仓位等级</p>
</th>
<th>
<p>姓名</p>
</th>
<th>
<p>性别</p>
</th>
<th>
<p>年龄</p>
</th>
<th>
<p>兄弟姐妹个数</p>
</th>
<th>
<p>父母子女个数</p>
</th>
<th>
<p>船票信息</p>
</th>
<th>
<p>票价</p>
</th>
<th>
<p>客舱</p>
</th>
<th>
<p>登船港口</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Heikkinen, Miss. Laina</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>STON/O2. 3101282</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>4</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Futrelle, Mrs. Jacques Heath (Lily May Peel)</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>113803</p>
</td>
<td>
<p>53.1000</p>
</td>
<td>
<p>C123</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>5</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Allen, Mr. William Henry</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>373450</p>
</td>
<td>
<p>8.0500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>5</p>
</th>
<td>
<p>6</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Moran, Mr. James</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>330877</p>
</td>
<td>
<p>8.4583</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>Q</p>
</td>
</tr>
<tr>
<th>
<p>6</p>
</th>
<td>
<p>7</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>McCarthy, Mr. Timothy J</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>54.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>17463</p>
</td>
<td>
<p>51.8625</p>
</td>
<td>
<p>E46</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>7</p>
</th>
<td>
<p>8</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Palsson, Master. Gosta Leonard</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>2.0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>349909</p>
</td>
<td>
<p>21.0750</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>8</p>
</th>
<td>
<p>9</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Johnson, Mrs. Oscar W (Elisabeth Vilhelmina Berg)</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>27.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>347742</p>
</td>
<td>
<p>11.1333</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>9</p>
</th>
<td>
<p>10</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>Nasser, Mrs. Nicholas (Adele Achem)</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>14.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>237736</p>
</td>
<td>
<p>30.0708</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>C</p>
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.tail(<span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>乘客ID</p>
</th>
<th>
<p>是否幸存</p>
</th>
<th>
<p>仓位等级</p>
</th>
<th>
<p>姓名</p>
</th>
<th>
<p>性别</p>
</th>
<th>
<p>年龄</p>
</th>
<th>
<p>兄弟姐妹个数</p>
</th>
<th>
<p>父母子女个数</p>
</th>
<th>
<p>船票信息</p>
</th>
<th>
<p>票价</p>
</th>
<th>
<p>客舱</p>
</th>
<th>
<p>登船港口</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>876</p>
</th>
<td>
<p>877</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Gustafsson, Mr. Alfred Ossian</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>20.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>7534</p>
</td>
<td>
<p>9.8458</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>877</p>
</th>
<td>
<p>878</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Petroff, Mr. Nedelio</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>19.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>349212</p>
</td>
<td>
<p>7.8958</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>878</p>
</th>
<td>
<p>879</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Laleff, Mr. Kristo</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>349217</p>
</td>
<td>
<p>7.8958</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>879</p>
</th>
<td>
<p>880</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Potter, Mrs. Thomas Jr (Lily Alexenia Wilson)</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>56.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>11767</p>
</td>
<td>
<p>83.1583</p>
</td>
<td>
<p>C50</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>880</p>
</th>
<td>
<p>881</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>Shelley, Mrs. William (Imanita Parrish Hall)</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>25.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>230433</p>
</td>
<td>
<p>26.0000</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>881</p>
</th>
<td>
<p>882</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Markun, Mr. Johann</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>33.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>349257</p>
</td>
<td>
<p>7.8958</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>882</p>
</th>
<td>
<p>883</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Dahlberg, Miss. Gerda Ulrika</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>7552</p>
</td>
<td>
<p>10.5167</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>883</p>
</th>
<td>
<p>884</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>Banfield, Mr. Frederick James</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>28.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>C.A./SOTON 34068</p>
</td>
<td>
<p>10.5000</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>884</p>
</th>
<td>
<p>885</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Sutehall, Mr. Henry Jr</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>25.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>SOTON/OQ 392076</p>
</td>
<td>
<p>7.0500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>885</p>
</th>
<td>
<p>886</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Rice, Mrs. William (Margaret Norton)</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>39.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>5</p>
</td>
<td>
<p>382652</p>
</td>
<td>
<p>29.1250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>Q</p>
</td>
</tr>
<tr>
<th>
<p>886</p>
</th>
<td>
<p>887</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>Montvila, Rev. Juozas</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>27.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>211536</p>
</td>
<td>
<p>13.0000</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>887</p>
</th>
<td>
<p>888</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Graham, Miss. Margaret Edith</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>19.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>112053</p>
</td>
<td>
<p>30.0000</p>
</td>
<td>
<p>B42</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>888</p>
</th>
<td>
<p>889</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Johnston, Miss. Catherine Helen "Carrie"</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>W./C. 6607</p>
</td>
<td>
<p>23.4500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>889</p>
</th>
<td>
<p>890</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Behr, Mr. Karl Howell</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>111369</p>
</td>
<td>
<p>30.0000</p>
</td>
<td>
<p>C148</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>890</p>
</th>
<td>
<p>891</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Dooley, Mr. Patrick</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>32.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>370376</p>
</td>
<td>
<p>7.7500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>Q</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>判断是否为空</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.isnull().head()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>乘客ID</p>
</th>
<th>
<p>是否幸存</p>
</th>
<th>
<p>仓位等级</p>
</th>
<th>
<p>姓名</p>
</th>
<th>
<p>性别</p>
</th>
<th>
<p>年龄</p>
</th>
<th>
<p>兄弟姐妹个数</p>
</th>
<th>
<p>父母子女个数</p>
</th>
<th>
<p>船票信息</p>
</th>
<th>
<p>票价</p>
</th>
<th>
<p>客舱</p>
</th>
<th>
<p>登船港口</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>True</p>
</td>
<td>
<p>False</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>True</p>
</td>
<td>
<p>False</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>False</p>
</td>
<td>
<p>True</p>
</td>
<td>
<p>False</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>描述性统计</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.describe()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>乘客ID</p>
</th>
<th>
<p>是否幸存</p>
</th>
<th>
<p>仓位等级</p>
</th>
<th>
<p>年龄</p>
</th>
<th>
<p>兄弟姐妹个数</p>
</th>
<th>
<p>父母子女个数</p>
</th>
<th>
<p>票价</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>count</p>
</th>
<td>
<p>891.000000</p>
</td>
<td>
<p>891.000000</p>
</td>
<td>
<p>891.000000</p>
</td>
<td>
<p>714.000000</p>
</td>
<td>
<p>891.000000</p>
</td>
<td>
<p>891.000000</p>
</td>
<td>
<p>891.000000</p>
</td>
</tr>
<tr>
<th>
<p>mean</p>
</th>
<td>
<p>446.000000</p>
</td>
<td>
<p>0.383838</p>
</td>
<td>
<p>2.308642</p>
</td>
<td>
<p>29.699118</p>
</td>
<td>
<p>0.523008</p>
</td>
<td>
<p>0.381594</p>
</td>
<td>
<p>32.204208</p>
</td>
</tr>
<tr>
<th>
<p>std</p>
</th>
<td>
<p>257.353842</p>
</td>
<td>
<p>0.486592</p>
</td>
<td>
<p>0.836071</p>
</td>
<td>
<p>14.526497</p>
</td>
<td>
<p>1.102743</p>
</td>
<td>
<p>0.806057</p>
</td>
<td>
<p>49.693429</p>
</td>
</tr>
<tr>
<th>
<p>min</p>
</th>
<td>
<p>1.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>0.420000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
</tr>
<tr>
<th>
<p>25%</p>
</th>
<td>
<p>223.500000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>2.000000</p>
</td>
<td>
<p>20.125000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>7.910400</p>
</td>
</tr>
<tr>
<th>
<p>50%</p>
</th>
<td>
<p>446.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>3.000000</p>
</td>
<td>
<p>28.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>14.454200</p>
</td>
</tr>
<tr>
<th>
<p>75%</p>
</th>
<td>
<p>668.500000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>3.000000</p>
</td>
<td>
<p>38.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>31.000000</p>
</td>
</tr>
<tr>
<th>
<p>max</p>
</th>
<td>
<p>891.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>3.000000</p>
</td>
<td>
<p>80.000000</p>
</td>
<td>
<p>8.000000</p>
</td>
<td>
<p>6.000000</p>
</td>
<td>
<p>512.329200</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>重复</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.duplicated()</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>      <span class="literal">False</span></span><br><span class="line"><span class="number">1</span>      <span class="literal">False</span></span><br><span class="line"><span class="number">2</span>      <span class="literal">False</span></span><br><span class="line"><span class="number">3</span>      <span class="literal">False</span></span><br><span class="line"><span class="number">4</span>      <span class="literal">False</span></span><br><span class="line">       ...  </span><br><span class="line"><span class="number">886</span>    <span class="literal">False</span></span><br><span class="line"><span class="number">887</span>    <span class="literal">False</span></span><br><span class="line"><span class="number">888</span>    <span class="literal">False</span></span><br><span class="line"><span class="number">889</span>    <span class="literal">False</span></span><br><span class="line"><span class="number">890</span>    <span class="literal">False</span></span><br><span class="line">Length: <span class="number">891</span>, dtype: <span class="built_in">bool</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="保存数据">2.4 保存数据</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>df.to_csv(<span class="string">&#x27;train_chinese.csv&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>【总结】数据的加载以及入门，接下来就要接触数据本身的运算，我们将主要掌握numpy和pandas在工作和项目场景的运用。</p>
<h1 id="探索性数据分析">3 探索性数据分析</h1>
<p><strong>复习：</strong> 前面已经学习了Pandas基础，知道利用Pandas读取csv数据的增删查改。这一章节学习的是 <strong>探索性数据分析</strong>，主要介绍如何利用Pandas进行排序、算术计算以及计算描述函数describe()的使用。</p>
<h2 id="加载数据-1">3.1 加载数据</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#载入之前保存的train_chinese.csv数据，关于泰坦尼克号的任务，我们就使用这个数据</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = pd.read_csv(<span class="string">&#x27;train_chinese.csv&#x27;</span>)</span><br><span class="line">    data_en = pd.read_csv(<span class="string">&#x27;train.csv&#x27;</span>)</span><br><span class="line">    data.head(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
�˿�ID
</th>
<th>
�Ƿ��Ҵ�
</th>
<th>
��λ�ȼ�
</th>
<th>
����
</th>
<th>
�Ա�
</th>
<th>
����.1
</th>
<th>
�ֵܽ��ø���
</th>
<th>
��ĸ��Ů����
</th>
<th>
��Ʊ��Ϣ
</th>
<th>
Ʊ��
</th>
<th>
�Ͳ�
</th>
<th>
�Ǵ��ۿ�
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.25
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<p>可以发现直接读取会产生乱码，因此需要设置编码格式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = pd.read_csv(<span class="string">&#x27;train_chinese.csv&#x27;</span>, encoding = <span class="string">&#x27;ansi&#x27;</span>)</span><br><span class="line">  data.head()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
乘客ID
</th>
<th>
是否幸存
</th>
<th>
仓位等级
</th>
<th>
姓名
</th>
<th>
性别
</th>
<th>
年龄
</th>
<th>
兄弟姐妹个数
</th>
<th>
父母子女个数
</th>
<th>
船票信息
</th>
<th>
票价
</th>
<th>
客舱
</th>
<th>
登船港口
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
<tr>
<th>
3
</th>
<td>
4
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Futrelle, Mrs. Jacques Heath (Lily May Peel)
</td>
<td>
female
</td>
<td>
35.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
113803
</td>
<td>
53.1000
</td>
<td>
C123
</td>
<td>
S
</td>
</tr>
<tr>
<th>
4
</th>
<td>
5
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Allen, Mr. William Henry
</td>
<td>
male
</td>
<td>
35.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
373450
</td>
<td>
8.0500
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<h2 id="了解数据">3.2 了解数据</h2>
<p>详细请参考教材《Python for Data Analysis》第五章</p>
<h3 id="排序">3.2.1 排序</h3>
<ul>
<li><p>理论</p>
<p>具体请看《利用Python进行数据分析》第五章 排序和排名 部分</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建数据</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>frame = pd.DataFrame(np.arange(<span class="number">8</span>).reshape((<span class="number">2</span>, <span class="number">4</span>)),</span><br><span class="line">                     index=[<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;1&#x27;</span>],</span><br><span class="line">                     columns=[<span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>frame</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>d</p>
</th>
<th>
<p>a</p>
</th>
<th>
<p>b</p>
</th>
<th>
<p>c</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>3</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>4</p>
</td>
<td>
<p>5</p>
</td>
<td>
<p>6</p>
</td>
<td>
<p>7</p>
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 索引升序frame.sort_index(axis = 0, ascending = True)</span></span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>d</p>
</th>
<th>
<p>a</p>
</th>
<th>
<p>b</p>
</th>
<th>
<p>c</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>4</p>
</td>
<td>
<p>5</p>
</td>
<td>
<p>6</p>
</td>
<td>
<p>7</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>3</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>:</p>
<ol type="1">
<li><code>axis</code>: 控制索引的维度，默认为 <code>axis = 0</code> 即行索引。将 <code>axis</code> 设置为 <code>1</code> 可以更改为按列排序.</li>
<li><code>ascending</code>: 控制升序 / 降序。默认为 <code>ascending = True</code>，即升序排列。</li>
<li>此外，可以通过设置 <code>by</code> 参数，选择多列进行排序。如 <code>by = ['a', 'c']</code>。</li>
</ol></li>
<li><p>实操</p>
<p>对 <code>data</code> 数据按票价和年龄两列进行综合排序（降序排列）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.sort_values(by=[<span class="string">&#x27;票价&#x27;</span>, <span class="string">&#x27;年龄&#x27;</span>], ascending=<span class="literal">False</span>).head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>乘客ID</p>
</th>
<th>
<p>是否幸存</p>
</th>
<th>
<p>仓位等级</p>
</th>
<th>
<p>姓名</p>
</th>
<th>
<p>性别</p>
</th>
<th>
<p>年龄</p>
</th>
<th>
<p>兄弟姐妹个数</p>
</th>
<th>
<p>父母子女个数</p>
</th>
<th>
<p>船票信息</p>
</th>
<th>
<p>票价</p>
</th>
<th>
<p>客舱</p>
</th>
<th>
<p>登船港口</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>679</p>
</th>
<td>
<p>680</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cardeza, Mr. Thomas Drake Martinez</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>36.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>PC 17755</p>
</td>
<td>
<p>512.3292</p>
</td>
<td>
<p>B51 B53 B55</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>258</p>
</th>
<td>
<p>259</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Ward, Miss. Anna</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17755</p>
</td>
<td>
<p>512.3292</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>737</p>
</th>
<td>
<p>738</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Lesurer, Mr. Gustave J</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>35.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17755</p>
</td>
<td>
<p>512.3292</p>
</td>
<td>
<p>B101</p>
</td>
<td>
<p>C</p>
</td>
</tr>
</tbody>
</table>
<p>排序后，如果我们仅仅关注年龄和票价两列。根据常识我知道发现票价越高的应该客舱越好，所以我们会明显看出，票价前20的乘客中存活的高达14人。</p></li>
</ul>
<h3 id="算数计算">3.2.2 算数计算</h3>
<p>具体参照《利用Python进行数据分析》第五章 算术运算与数据对齐部分</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>frame1_a = pd.DataFrame(np.arange(<span class="number">9.</span>).reshape(<span class="number">3</span>, <span class="number">3</span>),</span><br><span class="line">                     columns=[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>],</span><br><span class="line">                     index=[<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>frame1_b = pd.DataFrame(np.arange(<span class="number">12.</span>).reshape(<span class="number">4</span>, <span class="number">3</span>),</span><br><span class="line">                     columns=[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>],</span><br><span class="line">                     index=[<span class="string">&#x27;first&#x27;</span>, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;second&#x27;</span>])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>frame1_a</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
a
</th>
<th>
b
</th>
<th>
c
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
one
</th>
<td>
0.0
</td>
<td>
1.0
</td>
<td>
2.0
</td>
</tr>
<tr>
<th>
two
</th>
<td>
3.0
</td>
<td>
4.0
</td>
<td>
5.0
</td>
</tr>
<tr>
<th>
three
</th>
<td>
6.0
</td>
<td>
7.0
</td>
<td>
8.0
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>frame1_b</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
a
</th>
<th>
e
</th>
<th>
c
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
first
</th>
<td>
0.0
</td>
<td>
1.0
</td>
<td>
2.0
</td>
</tr>
<tr>
<th>
one
</th>
<td>
3.0
</td>
<td>
4.0
</td>
<td>
5.0
</td>
</tr>
<tr>
<th>
two
</th>
<td>
6.0
</td>
<td>
7.0
</td>
<td>
8.0
</td>
</tr>
<tr>
<th>
second
</th>
<td>
9.0
</td>
<td>
10.0
</td>
<td>
11.0
</td>
</tr>
</tbody>
</table>
<ul>
<li><p>加法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将frame_a和frame_b进行相加</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>frame1_a + frame1_b</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>a</p>
</th>
<th>
<p>b</p>
</th>
<th>
<p>c</p>
</th>
<th>
<p>e</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>first</p>
</th>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
<tr>
<th>
<p>one</p>
</th>
<td>
<p>3.0</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>7.0</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
<tr>
<th>
<p>second</p>
</th>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
<tr>
<th>
<p>three</p>
</th>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
<tr>
<th>
<p>two</p>
</th>
<td>
<p>9.0</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>13.0</p>
</td>
<td>
<p>NaN</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h3 id="极值">3.2.3 极值</h3>
<p>查看最大的家族有多少人（‘兄弟姐妹个数’+‘父母子女个数’）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">max</span>(data[<span class="string">&#x27;兄弟姐妹个数&#x27;</span>] + data[<span class="string">&#x27;父母子女个数&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data[<span class="string">&#x27;父母子女个数&#x27;</span>].describe()</span><br><span class="line"></span><br><span class="line">count    <span class="number">891.000000</span></span><br><span class="line">mean       <span class="number">0.381594</span></span><br><span class="line">std        <span class="number">0.806057</span></span><br><span class="line"><span class="built_in">min</span>        <span class="number">0.000000</span></span><br><span class="line"><span class="number">25</span>%        <span class="number">0.000000</span></span><br><span class="line"><span class="number">50</span>%        <span class="number">0.000000</span></span><br><span class="line"><span class="number">75</span>%        <span class="number">0.000000</span></span><br><span class="line"><span class="built_in">max</span>        <span class="number">6.000000</span></span><br><span class="line">Name: 父母子女个数, dtype: float64</span><br></pre></td></tr></table></figure>
<h1 id="pandas-基础">4 Pandas 基础</h1>
<ul>
<li><p>DataFrame and Series</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>sdata = &#123;<span class="string">&#x27;Ohio&#x27;</span>: <span class="number">35000</span>, <span class="string">&#x27;Texas&#x27;</span>: <span class="number">71000</span>, <span class="string">&#x27;Oregon&#x27;</span>: <span class="number">16000</span>, <span class="string">&#x27;Utah&#x27;</span>: <span class="number">5000</span>&#125;</span><br><span class="line">    example_1 = pd.Series(sdata)</span><br><span class="line">    example_1</span><br><span class="line"></span><br><span class="line">Ohio      <span class="number">35000</span></span><br><span class="line">Texas     <span class="number">71000</span></span><br><span class="line">Oregon    <span class="number">16000</span></span><br><span class="line">Utah       <span class="number">5000</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>temp = &#123;<span class="string">&#x27;state&#x27;</span>: [<span class="string">&#x27;Ohio&#x27;</span>, <span class="string">&#x27;Ohio&#x27;</span>, <span class="string">&#x27;Ohio&#x27;</span>, <span class="string">&#x27;Nevada&#x27;</span>, <span class="string">&#x27;Nevada&#x27;</span>, <span class="string">&#x27;Nevada&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;year&#x27;</span>: [<span class="number">2000</span>, <span class="number">2001</span>, <span class="number">2002</span>, <span class="number">2001</span>, <span class="number">2002</span>, <span class="number">2003</span>],<span class="string">&#x27;pop&#x27;</span>: [<span class="number">1.5</span>, <span class="number">1.7</span>, <span class="number">3.6</span>, <span class="number">2.4</span>, <span class="number">2.9</span>, <span class="number">3.2</span>]&#125;</span><br><span class="line">    example_2 = pd.DataFrame(temp)</span><br><span class="line">    example_2</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>state</p>
</th>
<th>
<p>year</p>
</th>
<th>
<p>pop</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>Ohio</p>
</td>
<td>
<p>2000</p>
</td>
<td>
<p>1.5</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>Ohio</p>
</td>
<td>
<p>2001</p>
</td>
<td>
<p>1.7</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>Ohio</p>
</td>
<td>
<p>2002</p>
</td>
<td>
<p>3.6</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>Nevada</p>
</td>
<td>
<p>2001</p>
</td>
<td>
<p>2.4</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>Nevada</p>
</td>
<td>
<p>2002</p>
</td>
<td>
<p>2.9</p>
</td>
</tr>
<tr>
<th>
<p>5</p>
</th>
<td>
<p>Nevada</p>
</td>
<td>
<p>2003</p>
</td>
<td>
<p>3.2</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h2 id="数据特征">4.1 数据特征</h2>
<ul>
<li><p>列名称</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data_en.columns</span><br><span class="line"></span><br><span class="line">Index([<span class="string">&#x27;PassengerId&#x27;</span>, <span class="string">&#x27;Survived&#x27;</span>, <span class="string">&#x27;Pclass&#x27;</span>, <span class="string">&#x27;Name&#x27;</span>, <span class="string">&#x27;Sex&#x27;</span>, <span class="string">&#x27;Age&#x27;</span>, <span class="string">&#x27;SibSp&#x27;</span>,       <span class="string">&#x27;Parch&#x27;</span>, <span class="string">&#x27;Ticket&#x27;</span>, <span class="string">&#x27;Fare&#x27;</span>, <span class="string">&#x27;Cabin&#x27;</span>, <span class="string">&#x27;Embarked&#x27;</span>],      dtype=<span class="string">&#x27;object&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>查看某些的信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data_en[<span class="string">&#x27;Cabin&#x27;</span>].head(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>    NaN1    C852    NaNName: Cabin, dtype: <span class="built_in">object</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data_en.Cabin.head(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0</span>    NaN1    C852    NaNName: Cabin, dtype: <span class="built_in">object</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="删除多余的列">4.2 删除多余的列</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>test_1 = pd.read_csv(<span class="string">&#x27;test_1.csv&#x27;</span>)</span><br><span class="line">test_1.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Unnamed: 0
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
<th>
a
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
100
</td>
</tr>
<tr>
<th>
1
</th>
<td>
1
</td>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
<td>
100
</td>
</tr>
<tr>
<th>
2
</th>
<td>
2
</td>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
<td>
100
</td>
</tr>
</tbody>
</table>
<p>经过我们的观察发现一个测试集 <code>test_1.csv</code> 有两列是多余的，需要将多余的列删去。</p>
<ul>
<li><p><code>del</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除多余的列</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> test_1[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>test_1.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Unnamed: 0</p>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Heikkinen, Miss. Laina</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>STON/O2. 3101282</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
</tbody>
</table></li>
<li><p><code>drop</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>test_1.drop(<span class="string">&#x27;a&#x27;</span>, axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)<span class="comment"># test_1 = test_1.drop(&#x27;a&#x27;, axis = 1)test_1.head(3)</span></span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Unnamed: 0</p>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Heikkinen, Miss. Laina</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>STON/O2. 3101282</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
</tbody>
</table>
<p>Note:</p>
<ul>
<li><code>inplace</code> ：是否替换原始的数据，也可以使用第二行的代码进行替代或存储为新的变量。默认为 <code>False</code>，即不替换</li>
<li><code>axis</code>：在行/列的维度进行操作。
<ul>
<li>0: Row</li>
<li>1: Column</li>
</ul></li>
</ul></li>
<li><p>Replace</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>test_1 = test_1.iloc[:, <span class="number">1</span>:-<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>可以通过 <code>loc</code> 和 <code>iloc</code> 方法进行取位置来替换原始的数据。</p></li>
</ul>
<h2 id="隐藏信息">4.3 隐藏信息</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data_en.drop([<span class="string">&#x27;PassengerId&#x27;</span>,<span class="string">&#x27;Name&#x27;</span>,<span class="string">&#x27;Age&#x27;</span>,<span class="string">&#x27;Ticket&#x27;</span>],axis=<span class="number">1</span>).head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Sex
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
0
</td>
<td>
3
</td>
<td>
male
</td>
<td>
1
</td>
<td>
0
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
<tr>
<th>
1
</th>
<td>
1
</td>
<td>
1
</td>
<td>
female
</td>
<td>
1
</td>
<td>
0
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
2
</th>
<td>
1
</td>
<td>
3
</td>
<td>
female
</td>
<td>
0
</td>
<td>
0
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<p>上述也可用下述代码实现：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>columns = data_en.columns.drop([<span class="string">&#x27;PassengerId&#x27;</span>,<span class="string">&#x27;Name&#x27;</span>,<span class="string">&#x27;Age&#x27;</span>,<span class="string">&#x27;Ticket&#x27;</span>])data_en.drop(columns, axis=<span class="number">1</span>).head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Name
</th>
<th>
Age
</th>
<th>
Ticket
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
22.0
</td>
<td>
A/5 21171
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
38.0
</td>
<td>
PC 17599
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
26.0
</td>
<td>
STON/O2. 3101282
</td>
</tr>
</tbody>
</table>
<p>Note:</p>
<p><code>drop</code> 方法将数据从原数据中去掉，如果不设置 <code>inplace = True</code> 参数的话，默认是用一个临时变量存储新得到的数据。</p>
<h3 id="数据筛选">4.3.1 数据筛选</h3>
<p>表格数据中，最重要的一个功能就是要具有可筛选的能力，选出我所需要的信息，丢弃无用的信息。</p>
<ul>
<li><p>判别式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data_en[data_en[<span class="string">&quot;Age&quot;</span>]&lt;<span class="number">10</span>].head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>7</p>
</th>
<td>
<p>8</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Palsson, Master. Gosta Leonard</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>2.0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>349909</p>
</td>
<td>
<p>21.075</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>10</p>
</th>
<td>
<p>11</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Sandstrom, Miss. Marguerite Rut</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>4.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>PP 9549</p>
</td>
<td>
<p>16.700</p>
</td>
<td>
<p>G6</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>16</p>
</th>
<td>
<p>17</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Rice, Master. Eugene</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>2.0</p>
</td>
<td>
<p>4</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>382652</p>
</td>
<td>
<p>29.125</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>Q</p>
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>midage = data_en[(data_en[<span class="string">&quot;Age&quot;</span>]&gt;<span class="number">10</span>) &amp; (data_en[<span class="string">&quot;Age&quot;</span>]&lt;<span class="number">50</span>)]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>midage.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>PassengerId</p>
</th>
<th>
<p>Survived</p>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
<th>
<p>Age</p>
</th>
<th>
<p>SibSp</p>
</th>
<th>
<p>Parch</p>
</th>
<th>
<p>Ticket</p>
</th>
<th>
<p>Fare</p>
</th>
<th>
<p>Cabin</p>
</th>
<th>
<p>Embarked</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Braund, Mr. Owen Harris</p>
</td>
<td>
<p>male</p>
</td>
<td>
<p>22.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>A/5 21171</p>
</td>
<td>
<p>7.2500</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Cumings, Mrs. John Bradley (Florence Briggs Th...</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>38.0</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>PC 17599</p>
</td>
<td>
<p>71.2833</p>
</td>
<td>
<p>C85</p>
</td>
<td>
<p>C</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>Heikkinen, Miss. Laina</p>
</td>
<td>
<p>female</p>
</td>
<td>
<p>26.0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>STON/O2. 3101282</p>
</td>
<td>
<p>7.9250</p>
</td>
<td>
<p>NaN</p>
</td>
<td>
<p>S</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<h3 id="数据提取">4.3.2 数据提取</h3>
<p>将midage的数据中第100行的"Pclass"和"Sex"的数据显示出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>midage = midage.reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># midage.reset_index(inplace = True, drop=True)</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>midage.head(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
PassengerId
</th>
<th>
Survived
</th>
<th>
Pclass
</th>
<th>
Name
</th>
<th>
Sex
</th>
<th>
Age
</th>
<th>
SibSp
</th>
<th>
Parch
</th>
<th>
Ticket
</th>
<th>
Fare
</th>
<th>
Cabin
</th>
<th>
Embarked
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
0
</td>
<td>
3
</td>
<td>
Braund, Mr. Owen Harris
</td>
<td>
male
</td>
<td>
22.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
A/5 21171
</td>
<td>
7.2500
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
<tr>
<th>
1
</th>
<td>
2
</td>
<td>
1
</td>
<td>
1
</td>
<td>
Cumings, Mrs. John Bradley (Florence Briggs Th...
</td>
<td>
female
</td>
<td>
38.0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
PC 17599
</td>
<td>
71.2833
</td>
<td>
C85
</td>
<td>
C
</td>
</tr>
<tr>
<th>
2
</th>
<td>
3
</td>
<td>
1
</td>
<td>
3
</td>
<td>
Heikkinen, Miss. Laina
</td>
<td>
female
</td>
<td>
26.0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
STON/O2. 3101282
</td>
<td>
7.9250
</td>
<td>
NaN
</td>
<td>
S
</td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>:</p>
<p><code>reset_index()</code> 的作用是重置索引值，<code>drop</code> 参数表示是否去掉原始的索引值。</p>
<ul>
<li><p><code>loc</code> 方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>midage.loc[[<span class="number">100</span>],[<span class="string">&#x27;Pclass&#x27;</span>,<span class="string">&#x27;Sex&#x27;</span>]]</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Sex</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>100</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>male</p>
</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>midage.loc[[<span class="number">100</span>,<span class="number">105</span>,<span class="number">108</span>],[<span class="string">&#x27;Pclass&#x27;</span>,<span class="string">&#x27;Name&#x27;</span>,<span class="string">&#x27;Sex&#x27;</span>]]</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>100</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>Byles, Rev. Thomas Roussel Davids</p>
</td>
<td>
<p>male</p>
</td>
</tr>
<tr>
<th>
<p>105</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>Cribb, Mr. John Hatfield</p>
</td>
<td>
<p>male</p>
</td>
</tr>
<tr>
<th>
<p>108</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>Calic, Mr. Jovo</p>
</td>
<td>
<p>male</p>
</td>
</tr>
</tbody>
</table></li>
<li><p><code>iloc</code> 方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>midage.iloc[[<span class="number">100</span>,<span class="number">105</span>,<span class="number">108</span>],[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]]</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Pclass</p>
</th>
<th>
<p>Name</p>
</th>
<th>
<p>Sex</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>100</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>Byles, Rev. Thomas Roussel Davids</p>
</td>
<td>
<p>male</p>
</td>
</tr>
<tr>
<th>
<p>105</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>Cribb, Mr. John Hatfield</p>
</td>
<td>
<p>male</p>
</td>
</tr>
<tr>
<th>
<p>108</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>Calic, Mr. Jovo</p>
</td>
<td>
<p>male</p>
</td>
</tr>
</tbody>
</table></li>
</ul>
<p><strong>【总结】</strong>: <code>loc</code> 方法的操作对象是 <code>label</code> 标签，而 <code>iloc</code> 方法的操作对象是标签的索引值。</p>
<p>此外如果要对 <code>DataFrame</code> 对象中的数据进行重赋值操作的话，如果使用的是 <code>loc</code> 方法，当赋值的 <code>label</code> 在数据表中不存在时，会默认新建一列，而 <code>iloc</code> 方法只能在数据表中现有的索引内容中进行覆写，索引值不能超过现有的 <code>shape</code> 值。</p>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Data Analysis</category>
      </categories>
      <tags>
        <tag>Data Analysis</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Econometrics</title>
    <url>/2020/12/15/Econometrics/</url>
    <content><![CDATA[<h1 id="introduction">1 Introduction</h1>
<p>本文为参考洪永淼老师《高级计量学》复习高级计量经济学的学习笔记。</p>
<a id="more"></a>
<h1 id="一般回归分析和模型设定">2 一般回归分析和模型设定</h1>
<h2 id="条件概率分别">2.1 条件概率分别</h2>
<ul>
<li><p>边际概率密度函数 （<span class="math inline">\(\rm{P}_{18}\)</span>） <span class="math display">\[
\begin{align*}
f_x(x) = \int_{-\infty}^\infty f_{XY}(x,y)\rm{d}y
\end{align*}
\]</span></p></li>
<li><p>给定 <span class="math inline">\(X = x\)</span>，<span class="math inline">\(Y\)</span> 的条件概率密度函数 （<span class="math inline">\(\rm{P}_{18}\)</span>） <span class="math display">\[
\begin{align*}
f_{Y|X}(y|x) = \frac{f_{XY}(x,y)}{f_X{(x)}}
\end{align*}
\]</span></p></li>
<li><p>条件均值（<span class="math inline">\(\rm{P}_{19}\)</span>） <span class="math display">\[
\begin{align*}
E(Y|x) \equiv E(Y|X=x) = \int_{-\infty}^{\infty} y f_{Y|X}(y|x)\rm{d}y
\end{align*}
\]</span></p></li>
<li><p>条件方差（<span class="math inline">\(\rm{P}_{19}\)</span>） <span class="math display">\[
\begin{align*}
var(Y|x) \equiv var(Y|X=x) &amp;= \int_{-\infty}^{\infty} [y-E(Y|x)]^2f_{Y|X}(y|x)\rm{d}y  \\
&amp;= E(Y^2|x)-[E(Y|x)]^2
\end{align*}
\]</span></p></li>
<li><p>条件偏度（Conditional skewness）（<span class="math inline">\(\rm{P}_{19}\)</span>） <span class="math display">\[
\begin{align*}
S(Y|x) \equiv \frac{E[(Y-E(Y|x)]^3|x)}{[var(Y|x)]^{3/2}}
\end{align*}
\]</span></p></li>
<li><p>条件峰度（Conditional kurtosis）（<span class="math inline">\(\rm{P}_{19}\)</span>） <span class="math display">\[
\begin{align*}
K(Y|x) \equiv \frac{E[(Y-E(Y|x)]^4|x)}{[var(Y|x)]^{2}}
\end{align*}
\]</span></p></li>
<li><p>条件 <span class="math inline">\(\alpha\)</span> - 分位数（Conditional <span class="math inline">\(\alpha\)</span>-quantile）（<span class="math inline">\(\rm{P}_{19}\)</span>） <span class="math display">\[
\begin{align*}
P[Y \leq Q(X, \alpha)|X = x] = \alpha \in (0,1)
\end{align*}
\]</span></p></li>
</ul>
<h2 id="条件均值与回归分析">2.2 条件均值与回归分析</h2>
<h3 id="定义">2.2.1 定义</h3>
<ul>
<li><strong>定义 2.1</strong>（<span class="math inline">\(\rm{P}_{20}\)</span>）&lt; 回归函数 (Regression Function) &gt;：条件均值 <span class="math inline">\(E(Y|X)\)</span> 称为 <span class="math inline">\(Y\)</span> 对 <span class="math inline">\(X\)</span> 的回归函数;</li>
</ul>
<h3 id="定理">2.2.2 定理</h3>
<ul>
<li><p><strong>定理 2.1</strong>（<span class="math inline">\(\rm{P}_{21}\)</span>）：<span class="math inline">\(E(E(Y|X)) = E(Y)\)</span>；</p></li>
<li><p><strong>定理 2.2</strong>（<span class="math inline">\(\rm{P}_{21}\)</span>） &lt; 重复期望法则 (Law of Interated Expectations, LIE) &gt;：对给定的可测函数 <span class="math inline">\(G(X,Y)\)</span>，假设期望 <span class="math inline">\(E[G(X,Y)]\)</span> 存在，则： <span class="math display">\[
\begin{align*}
E[G(X, Y)] = E\{E[G(X,Y)|X])\}
\end{align*}
\]</span></p></li>
<li><p><strong>定理 2.3</strong>（<span class="math inline">\(\rm{P}_{23}\)</span>）&lt; <span class="math inline">\(MSE\)</span> 最优解 &gt;：条件均值 <span class="math inline">\(E(Y|X)\)</span> 是下列问题的最优解： <span class="math display">\[
\begin{align*}
E(Y|X = \arg \min_{g\ \in\ \mathbb{F}} E[Y - g(X)]^2
\end{align*}
\]</span> 其中，<span class="math inline">\(\mathbb{F}\)</span> 是所有可测和平方可积函数的集合 (Space of all measurable and quare-integrable functions)，即： <span class="math display">\[
\begin{align*}
\mathbb{F} = \left\{g:\mathbb{R}^{k+1} \to \mathbb{R}\ \left| \int g^2(x) f_X(x) \rm{d}x &lt; \infty \right.\right\}
\end{align*}
\]</span> &lt; 注：可通过中间变量 <span class="math inline">\(g_0(X) \equiv E(Y|X)\)</span> 证明 &gt;</p></li>
<li><p><strong>定理 2.4</strong>（<span class="math inline">\(\rm{P}_{25}\)</span>）&lt; 回归等式 (Regression Identity) &gt;：给定条件均值 <span class="math inline">\(E(Y|X)\)</span>，总有： <span class="math display">\[
\begin{align*}
Y = E(Y|X) + \varepsilon
\end{align*}
\]</span> 其中，<span class="math inline">\(\varepsilon\)</span> 称为回归扰动项（Regression disturbance），满足： <span class="math display">\[
\begin{align*}
E(\varepsilon|X) = 0
\end{align*}
\]</span></p></li>
</ul>
<h2 id="线性回归建模">2.3 线性回归建模</h2>
<h3 id="定义-1">2.3.1 定义</h3>
<ul>
<li><p><strong>定义 2.3</strong>（<span class="math inline">\(\rm{P}_{29}\)</span>）&lt; 仿射函数 (Affine Function) &gt;：记 <span class="math inline">\(X = (1, X_1, \dots , X_k)^\prime\)</span>，<span class="math inline">\(\beta = (\beta_0, \beta_1, \dots, \beta_k)^\prime\)</span>。则仿射函数族定义为： <span class="math display">\[
\begin{align*}
\mathbb{A} &amp;= \left\{ g:\mathbb{R}^{k+1} \to \mathbb{R}\ |\ g(X) = \beta_0 + \sum_{j=1}^{k} \beta_jX_j, \beta_j \in \mathbb{R} \right\} \\
&amp;= \left\{ g:\mathbb{R}^{k+1} \to \mathbb{R}\ |\ g(X) = X^\prime\beta \right\}
\end{align*}
\]</span> 这里，对参数向量 <span class="math inline">\(\beta\)</span> 的值没有限制。对于这族函数，函数形式一致，分别是解释变量和参数 <span class="math inline">\(\beta\)</span> 的线性函数；</p></li>
<li><p><strong>定义 2.4</strong>（<span class="math inline">\(\rm{P}_{32}\)</span>）&lt; 线性回归模型 (Linear Regression Model) &gt;：方程： <span class="math display">\[
\begin{align*}
Y = X^\prime \beta + u, \beta \in \mathbb{R}^{k+1}
\end{align*}
\]</span> 称为 <span class="math inline">\(Y\)</span> 对 <span class="math inline">\(X\)</span> 的线性回归模型，其中 <span class="math inline">\(u\)</span> 是回归模型误差 (Regression model error)。如果 <span class="math inline">\(k=1\)</span>，称为二元线性回归模型 (Bivariate linear regression model) 或直线回归模型 (Straight linere gression model)。如果 <span class="math inline">\(k&gt;1\)</span>，则称为多元线性回归模型 (Multiple linear regression model)；</p></li>
</ul>
<h3 id="定理-1">2.3.2 定理</h3>
<ul>
<li><p><strong>定理 2.5</strong>（<span class="math inline">\(\rm{P}_{30}\)</span>）&lt; 最优线性最小二乘预测 (Best Linear Least Squares Predictstion) &gt; ：假设<span class="math inline">\(E(Y^2) &lt; \infty\)</span>，且<span class="math inline">\((k+1) \times (k+1)\)</span> 矩阵 <span class="math inline">\(E(X^\prime X)\)</span> 是非奇异的。则以下优化问题： <span class="math display">\[
\begin{align*}
\min_{g\ \in\ \mathbb{A} }E[Y - g(X)]^2 = \min_{\beta\ \in \mathbb{R}^{k+1}}E(Y - X^\prime \beta)^2
\end{align*}
\]</span> 的解，即最优线性最小二乘法预测值为： <span class="math display">\[
\begin{align*}
g^*(X) = X^\prime\beta^*
\end{align*}
\]</span> 其中最优系数向量为（<span class="math inline">\(\star \star \star\)</span>）： <span class="math display">\[
\begin{align*}
\beta^* = [E(X X^\prime)]^{-1}E(XY)
\end{align*}
\]</span></p></li>
<li><p><strong>定理 2.6</strong>（<span class="math inline">\(\rm{P}_{32}\)</span>）：假设定理 2.5 的条件成立。令： <span class="math display">\[
\begin{align*}
Y =  X^\prime \beta + u
\end{align*}
\]</span> 并令 <span class="math inline">\(\beta^* = [E(XX^\prime)]^{-1}E(XY)\)</span> 为最优线性最小二乘近似系数。则： <span class="math display">\[
\begin{align*}
\beta = \beta^*
\end{align*}
\]</span> 当且仅当以下正交条件成立： <span class="math display">\[
\begin{align*}
E(Xu) = 0
\end{align*}
\]</span></p></li>
</ul>
<h2 id="条件均值的模型设定">2.4 条件均值的模型设定</h2>
<h3 id="定义-2">2.4.1 定义</h3>
<ul>
<li><strong>定义 2.5</strong>（<span class="math inline">\(\rm{P}_{34}\)</span>）&lt; 条件均值模型的正确设定 &gt;：线性回归模型： <span class="math display">\[
\begin{align*}
Y = X^\prime \beta + u, \beta \in \mathbb{R^{k+1}}
\end{align*}
\]</span> 是条件均值 <span class="math inline">\(E(Y|X)\)</span> 的正确设定，如果存在某个参数值 <span class="math inline">\(\beta^o \in \mathbb{R^{k+1}}\)</span>，有： <span class="math display">\[
\begin{align*}
E(Y|X) = X^\prime \beta^o
\end{align*}
\]</span> 另一方面，如果对于任意的参数值 <span class="math inline">\(\beta \in \mathbb{R^{k+1}}\)</span>， <span class="math display">\[
\begin{align*}
E(Y|X) \neq X^\prime \beta
\end{align*}
\]</span> 则称线性回归模型是对 <span class="math inline">\(E(Y|X)\)</span> 的错误设定 (Misspecified)；</li>
</ul>
<h3 id="定理-2">2.4.2 定理</h3>
<ul>
<li><p><strong>定理 2.7</strong>（<span class="math inline">\(\rm{P}_{35}\)</span>）：如果线性回归模型： <span class="math display">\[
\begin{align*}
Y =  X^\prime \beta + u
\end{align*}
\]</span> 是对条件均值<span class="math inline">\(E(Y|X)\)</span> 的正确设定则：</p>
<p>1）存在一个参数 <span class="math inline">\(\beta^o\)</span> 和一个随机变量 <span class="math inline">\(\varepsilon\)</span>，有 <span class="math inline">\(Y = X^\prime \beta^o+\varepsilon\)</span>，其中 <span class="math inline">\(E(\varepsilon|X) = 0\)</span>；</p>
<p>2）<span class="math inline">\(\beta^* = \beta^o\)</span></p></li>
</ul>
<h1 id="经典线性回归模型">3. 经典线性回归模型</h1>
<h2 id="假设">3.1 假设</h2>
<ul>
<li><p><strong>假设 3.1</strong>（<span class="math inline">\(\rm{P}_{45}\)</span>）&lt; 线性 (Linearity) &gt;：<span class="math inline">\(\{Y_t, X_t^\prime\}_{t=1}^n\)</span> 是一个可观测的随机样本，且： <span class="math display">\[
Y_t = X_t^\prime \beta^o + \varepsilon_t, t = 1, \dots, n
\]</span> 其中，<span class="math inline">\(\beta^o\)</span> 是一个 <span class="math inline">\(K \times 1 (K = k + 1)\)</span> 未知参数向量，<span class="math inline">\(\varepsilon_t\)</span> 是一个不可观测的随机扰动项；</p>
<p>令： <span class="math display">\[
\begin{align*}
Y &amp; = (Y_1, \dots , Y_n)^\prime, &amp;n \times 1 \\
\varepsilon &amp; = (\varepsilon_1, \dots , \varepsilon_n)^\prime, &amp;n \times 1 \\
X &amp; = (X_1, \dots , X_n)^\prime, &amp;n \times K \\
\end{align*}
\]</span> 这里 <span class="math inline">\(X\)</span> 的第 <span class="math inline">\(t\)</span> 行是 <span class="math inline">\(K\)</span> 维行向量 <span class="math inline">\(X_t^\prime = (1, X_{1t},\dots,X_{kt})\)</span>。从而，(1) 式可以表示为： <span class="math display">\[
\begin{align*}
Y = X \beta^o + \varepsilon
\end{align*}
\]</span></p></li>
<li><p><strong>假设 3.2</strong>（<span class="math inline">\(\rm{P}_{46}\)</span>）&lt; 严格外生性 (Strict Exogeneity) &gt;： <span class="math display">\[
\begin{align*}
E(\varepsilon_t|X) = E(\varepsilon_t|X_1, \dots, X_t,\dots,X_n) = 0 \qquad t = 1,\dots,n
\end{align*}
\]</span> 这一假设隐含着 <span class="math inline">\(E(Y_t|X_t)\)</span> 的模型设定正确；</p></li>
<li><p><strong>假设 3.3</strong>（<span class="math inline">\(\rm{P}_{48}\)</span>）&lt; 非奇异性 (Nonsingularity) &gt;：</p>
<p>1）<span class="math inline">\(K \times K\)</span> 方阵 <span class="math inline">\(X^\prime X = \sum_\limits{t=1}^n X_t X_t^\prime\)</span> 是非奇异的（排除了 <span class="math inline">\(X_t\)</span> 中存在多重共线性）；</p>
<p>2）当 <span class="math inline">\(n \to \infty\)</span> 时，<span class="math inline">\(X^\prime X\)</span> 的最小特征值: <span class="math display">\[
\begin{align*}
\lambda_{min}(X^\prime X) \to \infty
\end{align*}
\]</span> 的概率为 1;</p></li>
<li><p><strong>假设 3.4</strong>（<span class="math inline">\(\rm{P}_{49}\)</span>）&lt; 球形误差方差 (Spherical Error Variance) &gt;：</p>
<p>1）条件同方差: <span class="math display">\[
\begin{align*}
E(\varepsilon_t^2|X) = \sigma^2 &gt; 0, \quad t =1,\dots,n
\end{align*}
\]</span> 2）条件不相关： <span class="math display">\[
\begin{align*}
E(\varepsilon_t\varepsilon_s|X) = 0, t \neq s, \quad t,s \in \{1,\dots,n\}
\end{align*}
\]</span> 上述可写为： <span class="math display">\[
\begin{align*}
E(\varepsilon_t\varepsilon_s|X) = \sigma^2 \delta_{ts} = \sigma^2I,  \quad t,s \in \{1,\dots,n\}
\end{align*}
\]</span> 其中，<span class="math inline">\(\delta_{ts} = 1\)</span> 当且仅当 <span class="math inline">\(t=s\)</span>；</p></li>
</ul>
<h3 id="总结">3.1.1 总结</h3>
<p>给定假设 3.2 和 3.4 意味着 <span class="math inline">\(\varepsilon_t\)</span> 存在条件同方差，即： <span class="math display">\[
\begin{align*}
var(\varepsilon_t|X) = E(\varepsilon_t^2|X) - [E(\varepsilon_t|X)]^2 = E(\varepsilon_t^2|X) = \sigma^2
\end{align*}
\]</span> 同样的，对于所有的 <span class="math inline">\(t \neq s\)</span>，有： <span class="math display">\[
\begin{align*}
cov(\varepsilon_t,\varepsilon_s|X) = E(\varepsilon_t\varepsilon_s|X) = 0
\end{align*}
\]</span> 如果 <span class="math inline">\(t\)</span> 表示个体单元，这意味着 <strong>横截面不相关</strong>，如果 <span class="math inline">\(t\)</span> 表示时间，这意味着 <strong>序列不相关</strong>，为方便起见，这两种情况均称为 <span class="math inline">\(\{\varepsilon_t\}\)</span> <strong>不存在自相关</strong>；</p>
<h2 id="普通最小二乘法-ols">3.2 普通最小二乘法 (OLS)</h2>
<h3 id="定义-3">3.2.1 定义</h3>
<ul>
<li><p><strong>定义 3.1</strong>（<span class="math inline">\(\rm{P}_{50}\)</span>）&lt; <span class="math inline">\(OLS\)</span> 估计量 &gt;：定义线性回归模型 <span class="math inline">\(Y_t = X_t^\prime \beta + u_t\)</span> 的残差平方和 (Sum of squared residuals, SSR) 为： <span class="math display">\[
\begin{align*}
SSR(\beta) \equiv (Y - X\beta)^\prime(Y - X\beta) = \sum_{t=1}^{n}(Y_t - X_t^\prime\beta)^2
\end{align*}
\]</span> 则普通最小二乘法 ( <span class="math inline">\(OLS\)</span> ) 估计量 <span class="math inline">\(\hat\beta\)</span> 是以下优化问题的解： <span class="math display">\[
\begin{align*}
\hat \beta = \arg \min_{\beta\ \in \mathbb{R}^K} SSR(\beta)
\end{align*}
\]</span> <strong>注：</strong> <span class="math inline">\(OLS\)</span> 具有以下良好性质（陈强，<span class="math inline">\(\rm{P}_{87}\)</span>）：</p>
<p>1）<strong>线性性。</strong><span class="math inline">\(OLS\)</span> 估计量 <span class="math inline">\(\hat \beta\)</span> 为线性估计量（Linear estimator）。从 <span class="math inline">\(OLS\)</span> 估计量的表达式 <span class="math inline">\(\hat \beta = (X^\prime X)^{-1} X^\prime Y\)</span> 可知，<span class="math inline">\(\hat \beta\)</span> 可以视为 <span class="math inline">\(Y\)</span> 的线性组合，同时也是 <span class="math inline">\(\varepsilon\)</span> 的线性组合（<strong>将 <span class="math inline">\((X^\prime X)^{-1} X^\prime\)</span> 视为系数矩阵</strong>，<span class="math inline">\(\star\star\star\)</span>）。故为线性估计量。</p>
<p>2）<strong>无偏性。</strong><span class="math inline">\(E(\hat\beta|X) = \beta\)</span>，即 <span class="math inline">\(\hat\beta\)</span> 不会系统地高估或低估 <span class="math inline">\(\beta\)</span>，即定理 3.5 (1)。</p>
<p>3）<strong>估计量 <span class="math inline">\(\hat\beta\)</span> 的协方差矩阵。</strong><span class="math inline">\(var(\hat \beta |X) = \sigma^2(X^\prime X)^{-1}\)</span>，见定理 3.5 (2)。</p>
<p>4）<strong>最小方差性。</strong>所有无偏估计量中最小二乘估计的方差最小。</p></li>
</ul>
<h3 id="定理-3">3.2.2 定理</h3>
<ul>
<li><p><strong>定理 3.1</strong>（<span class="math inline">\(\rm{P}_{50}\)</span>）&lt; <span class="math inline">\(OLS\)</span> 的存在性 &gt;：在假设 3.1 和 3.3 (1) 下， <span class="math inline">\(OLS\)</span> 估计量 <span class="math inline">\(\hat \beta\)</span> 存在，并且： <span class="math display">\[
\begin{align*}
\hat \beta &amp;= (X^\prime  X)^{-1} X^\prime Y \\
 &amp; = \left(\frac{1}{n} \sum_{t = 1}^{n} X_t X_t^\prime\right)^{-1} \frac{1}{n} \sum_{t=1}^{n} X_t Y_t
\end{align*}
\]</span> 其中第二个表达式在后面章节的渐近分析中将经常用到。</p>
<p><strong>注：</strong> <span class="math inline">\(\hat Y_t \equiv X_t^\prime \hat\beta\)</span> 称为观测值 <span class="math inline">\(Y_t\)</span> 的 <strong>拟合值或者预测值</strong>，而 <span class="math inline">\(e_t \equiv Y_t - \hat Y_t\)</span> 是观测值 <span class="math inline">\(Y_t\)</span> 的 <strong>估计残差或预测误差</strong>。被解释变量 <span class="math inline">\(Y_t\)</span> 可以分解为相互正交的拟合值 <span class="math inline">\(\hat Y\)</span> 与残差 <span class="math inline">\(e\)</span> 之和，参见 Fig. 3-1。</p>
<p><img src="https://s3.ax1x.com/2020/12/21/r03CND.jpg" style="zoom:80%;" /></p></li>
</ul>
<center>
Fig. 3-1 OLS 的正交性
</center>
<ul>
<li><p><strong>定理 3.2</strong>（<span class="math inline">\(\rm{P}_{52}\)</span>）：给定假设 3.1 和 3.3 (1)，有：</p>
<ol type="1">
<li><span class="math display">\[
\begin{align*}
X ^\prime e = 0
\end{align*}
\]</span></li>
<li><span class="math display">\[
\begin{align*}
\hat \beta - \beta^o = (X^\prime X)^{-1}X^{\prime}\varepsilon
\end{align*}
\]</span></li>
</ol>
<p><strong>注：</strong> 上式可变为 <span class="math inline">\(C\varepsilon\)</span>，其中 <span class="math inline">\(C\)</span> 是权重向量，因此，给定 <span class="math inline">\(X, \hat\beta-\beta^o\)</span> 是 <span class="math inline">\(\varepsilon\)</span> 的线性组合，当 <span class="math inline">\(\varepsilon\)</span> 服从联合正态分布时，<span class="math inline">\(\hat\beta-\beta^o\)</span> 也服从正态分布。</p>
<ol start="3" type="1">
<li>定义 <span class="math inline">\(n \times n\)</span> 投影矩阵 <span class="math display">\[
\begin{align*}
P = X(X^\prime X)^{-1}X^{\prime}
\end{align*}
\]</span> 和 <span class="math display">\[
\begin{align*}
M = I_n - P
\end{align*}
\]</span> 则 <span class="math inline">\(P\)</span> 和 <span class="math inline">\(M\)</span> 是对称的（即 <span class="math inline">\(P = P^{\prime},\ M = M^{\prime}\)</span>）幂等矩阵（即 <span class="math inline">\(P = P^{2},\ M = M^{2}\)</span>），并且 <span class="math display">\[
\begin{align*}
PX = X \\
MX = 0
\end{align*}
\]</span></li>
<li><span class="math display">\[
\begin{align*}
SSR(\hat \beta) = e^\prime e = Y^{-1} MY = \varepsilon^{\prime} M \varepsilon
\end{align*}
\]</span> <strong>注：</strong><span class="math inline">\(e = Y - X \hat\beta = M \varepsilon\)</span>（<span class="math inline">\(\star\star\star\)</span>）</li>
</ol></li>
</ul>
<h2 id="拟合优度和模型选择准则">3.3 拟合优度和模型选择准则</h2>
<h3 id="定义-4">3.3.1 定义</h3>
<ul>
<li><p><strong>定义 3.2</strong>（<span class="math inline">\(\rm{P}_{54}\)</span>）&lt; 非中心化 <span class="math inline">\(\mathcal{R}^2\)</span> &gt;：非中心化多元相关系数平方 <span class="math inline">\(\mathcal{R}^2\)</span> 定义为：</p>
<p><span class="math display">\[
\begin{align*}
\mathcal{R}^2_{uc} = \frac{\hat Y{}^\prime \hat Y}{Y^\prime Y} = 1 - \frac{e^\prime e}{Y^\prime Y}
\end{align*}
\]</span></p>
<p><span class="math inline">\(\mathcal{R}^2\)</span> 的含义是因变量 <span class="math inline">\({Y_t}\)</span> 的非中心化的样本二次型变动可以被预测值 <span class="math inline">\(\{\hat Y{}^\prime\}\)</span> 的非中心化样本二次型变动所预测的比例。由定义可知，总有 <span class="math inline">\(0 \leq \mathcal{R}^2_{uc} \leq 1\)</span>。</p></li>
<li><p><strong>定义 3.3</strong>（<span class="math inline">\(\rm{P}_{54}\)</span>）&lt; 中心化 <span class="math inline">\(\mathcal{R}^2\)</span> 或决定系数 (Coefficient of Determination) &gt;：决定系数定义为：</p>
<p><span class="math display">\[
\begin{align*}
\mathcal{R}^2 &amp;\equiv 1 - \frac{\sum_\limits{t=1}^{n} e_t^2}{\sum_\limits{t=1}^{n} (Y_t - \overline Y)^2} \\
&amp;= 1 - \frac{SSE}{SST} = \frac{SSR}{SST} = \frac{\sum\limits_{i=1}^{n}(\hat{Y_i} - \bar Y)^2}{\sum\limits_{i=1}^{n}(Y_i - \bar Y)^2}
\end{align*}
\]</span></p>
<p>其中 <span class="math inline">\(\overline Y = n^{-1}\sum_\limits{t=1}^{n}Y_t\)</span> 是样本均值。</p>
<p><strong>注：</strong></p>
<ul>
<li><p>当 <span class="math inline">\(X_t\)</span> 包括截距项，即 <span class="math inline">\(X_{0t} = 1\)</span> 时，可进行如下正交分解：</p>
<p><span class="math display">\[
\begin{align*}
\sum_{t=1}^{n}(Y_t - \overline Y)^2 &amp;= \sum_{t=1}^{n}(\hat Y_t - \overline Y + Y_t - \hat Y_t)^2 \\
&amp; = \sum_{t=1}^{n}(\hat Y_t - \overline Y)^2 + \sum_{t=1}^{n}e_t^2
\end{align*}
\]</span></p>
<p>此时（<span class="math inline">\(\star \star\star\)</span>）：</p>
<p><span class="math display">\[
\begin{align*}
\mathcal{R}^2 &amp;\equiv 1 - \frac{e^\prime e}{\sum_\limits{t=1}^{n}(Y_t - \overline Y)^2}\\
&amp;= \frac{\sum_\limits{t=1}^{n}(\hat Y_t - \overline Y)^2}{\sum_\limits{t=1}^{n}(Y_t - \overline Y)^2}
\end{align*}
\]</span></p></li>
<li><p>如果 <span class="math inline">\(X_t\)</span> 不包括截距项，此时 <span class="math inline">\((X^\prime X)\)</span> 是奇异矩阵，且可能有 <span class="math inline">\(E(e_t) \neq 0\)</span>，所以有：</p>
<p><span class="math display">\[
\begin{align*}
\sum_{t=1}^{n}(Y_t - \overline Y)^2 &amp;= \sum_{t=1}^{n}(\hat Y_t - \overline Y)^2 + \sum_{t=1}^{n}e_t^2 + 2 \sum_{t=1}^{n}(\hat Y_t - \overline Y)e_t \\
&amp;\neq \sum_{t=1}^{n}(\hat Y_t - \overline Y)^2 + \sum_{t=1}^{n}e_t^2
\end{align*}
\]</span></p>
<p>在这种情况下，<strong><span class="math inline">\(\mathcal{R}^2\)</span> 可能为负值</strong>，因为交叉项 <span class="math inline">\(\sum_\limits{t=1}^{n}(\hat Y_t - \overline Y)e_t\)</span> 可能为负值。</p></li>
</ul></li>
</ul>
<h3 id="定理-4">3.3.2 定理</h3>
<ul>
<li><p><strong>定理 3.3</strong>（<span class="math inline">\(\rm{P}_{56}\)</span>）：<span class="math inline">\(\mathcal{R}^2 = \hat \rho_{Y\hat Y}^2 = \frac{cov(Y, \hat Y)}{var(Y)var(\hat Y)}\)</span>，这里 <span class="math inline">\(\hat \rho_{Y\hat Y}^2\)</span> 是 <span class="math inline">\(\{Y_t\}\)</span> 和 <span class="math inline">\(\{\hat Y_t\}\)</span> 的样本相关系数。</p></li>
<li><p><strong>定理 3.4</strong>（<span class="math inline">\(\rm{P}_{56}\)</span>）：假设 <span class="math inline">\(\{Y_t, X_{1t}, \dots, X_{ (k+q)t}\}_{t=1}^n\)</span> 是一容量为 <span class="math inline">\(n\)</span> 的随机样本，<span class="math inline">\(\mathcal{R}_1^2\)</span> 是下列线性回归模型的中心化拟合度：</p>
<p><span class="math display">\[
\begin{align*}
Y_t= X_t^{\prime}\beta + \varepsilon_t
\end{align*}
\]</span></p>
<p>其中， <span class="math inline">\(X_t = (1, X_{1t}, \dots, X_{kt})^\prime\)</span>，<span class="math inline">\(\beta\)</span> 是 <span class="math inline">\(K \times 1\)</span> 未知参数向量；<span class="math inline">\(\mathcal{R}_2^2\)</span> 是下面扩展的线性回归模型的中心化扰合优度：</p>
<p><span class="math display">\[
\begin{align*}
Y_t = \tilde X_t^\prime \gamma + u_t
\end{align*}
\]</span></p>
<p>其中，<span class="math inline">\(\tilde X_t = (1, X_{1t}, \dots, X_{kt}, X_{(k+1)t)})^\prime\)</span>，<span class="math inline">\(\gamma\)</span> 是 <span class="math inline">\((K+q) \times 1\)</span> 未知参数向量，<span class="math inline">\(q\)</span> 是正整数。则：</p>
<p><span class="math display">\[
\begin{align*}
\mathcal{R}_2^2 \geq \mathcal{R}_1^2
\end{align*}
\]</span></p>
<p><strong>注：</strong>定理 3.4 有重要含义：</p>
<ul>
<li><p><span class="math inline">\(\mathcal{R}^2\)</span> 可用于 <strong>解释变量数目相等</strong> 的线性回归模型的比较，但它不适用于 <strong>比较不同解释变量数目</strong> 的线性模型，因为 <strong>模型的解释变量越多，<span class="math inline">\(\mathcal{R}^2\)</span> 就会越大</strong>。</p></li>
<li><p><span class="math inline">\(\mathcal{R}^2\)</span> 也不是正确模型设定的判断标准。<span class="math inline">\(\mathcal{R}^2\)</span> 高并不意味着模型设定正确，事实上，给定解释变量 <span class="math inline">\(X_t\)</span>，<span class="math inline">\(\mathcal{R}_2\)</span> 值的大小 <strong>与线性回归模型的信噪比</strong> 有关。</p></li>
</ul></li>
</ul>
<h3 id="模型选择准则">3.3.3 模型选择准则</h3>
<ol type="1">
<li><p><strong>Akaike 信息准则</strong>（Akaike information criterion, AIC）</p>
<p>线性回归模型可通过选择合适的解释变量数模 <span class="math inline">\(K\)</span>，以最小化下面的 Akaike 信息准则来选择模型。 <span class="math display">\[
\begin{align*}
AIC = {\rm{ln}}(s^2) + \frac{2K}{n}
\end{align*}
\]</span> 其中， <span class="math display">\[
\begin{align*}
s^2 = e^\prime e / (n - K)
\end{align*}
\]</span> <span class="math inline">\(K = k+1\)</span> 是自变量 <span class="math inline">\(X_t\)</span> 的数目，第一项 <span class="math inline">\({\rm{ln}} s^2\)</span> 测度模型的拟合优度，而第二项 <span class="math inline">\(2K/n\)</span> 测度模型的复杂程度。另外，<span class="math inline">\(s^2\)</span> 是 <span class="math inline">\(E(\varepsilon_t^2) = \sigma^2\)</span> 的残差方差估计量（Residual variance estimator）。</p></li>
<li><p><strong>Bayesian 信息准则</strong>（Bayesian information criterion, BIC）</p>
<p>线性模型也可以通过选择合适的 <span class="math inline">\(K\)</span>，以最小化以下 <span class="math inline">\(Bayesian\)</span> 信息准则来选择模型： <span class="math display">\[
\begin{align*}
BIC = {\rm{ln}} (s^2) +\frac{K {\rm{ln}}(n)}{n}
\end{align*}
\]</span></p></li>
<li><p><span class="math inline">\(\overline{\mathcal{R}}{}^2\)</span></p>
<p>我们知道 <span class="math inline">\(\mathcal{R}^2\)</span> 的定义为：</p>
<p><span class="math display">\[
\begin{align*}
\mathcal{R}^2 = 1 - \frac{e^\prime e / n}{\sum_\limits{t=1}^{n}(Y_t - \overline Y)^2 / n} = 1 - \frac{SSE}{SST}
\end{align*}
\]</span></p>
<p>其中，<span class="math inline">\(e^\prime e / n\)</span> 和 <span class="math inline">\(\sum_\limits{t=1}^{n}(Y_t - \overline Y)^2 / n\)</span> 分别是方差 <span class="math inline">\(\sigma^2 = var(\varepsilon_t)\)</span> 和 <span class="math inline">\(\sigma_Y^2 = var(Y_t)\)</span> 的有偏估计。残差平方和：<span class="math inline">\(SSE\)</span>（书中为 <span class="math inline">\(SSR\)</span>（residual），调整的 <span class="math inline">\(\mathcal{R}^2\)</span> 为：</p>
<p><span class="math display">\[
\begin{align*}
\overline{\mathcal{R}}{}^2 = 1 - \frac{e^\prime e / (n-K)}{(n-1)^{-1}\sum_\limits{t=1}^{n}(Y_t - \overline Y)^2} = 1 - \frac{n-1}{n-K}(1 - \mathcal{R})
\end{align*}
\]</span></p></li>
</ol>
<p>此时有：<span class="math inline">\(E[e^\prime e / (n-K)] = \sigma^2\)</span> 和 <span class="math inline">\(E[(n-1)^{-1}\sum_\limits{t=1}^{n}(Y_t - \overline Y)^2] = \sigma_Y^2\)</span> ，在 <span class="math inline">\(\overline{\mathcal{R}}{}^2\)</span> 中，调整的是自由度，此时即使 <span class="math inline">\(X_t\)</span> 中包含截距项，<span class="math inline">\(\bar{\mathcal{R}}\)</span> 也可能取负值。</p>
<p><span class="math inline">\(\bar{\mathcal{R}}\)</span> 作用：① 消除解释变量的多少对决定系数计算的影响。② 可用于比较解释变量个数不同的模型，而 <span class="math inline">\(\mathcal{R}\)</span> 则不能比较。</p>
<h2 id="ols-估计量的无偏性和有效性">3.4 <span class="math inline">\(OLS\)</span> 估计量的无偏性和有效性</h2>
<h3 id="定理-5">3.4.1 定理</h3>
<ul>
<li><p><strong>定理 3.5</strong>（<span class="math inline">\(\rm{P}_{60}\)</span>）：如果假设 3.1、3.3 (1) 和 3.4 成立，则：</p>
<p>1）<strong>无偏性</strong> &lt; Unbiasedness &gt; ：<span class="math inline">\(E(\hat \beta|X) = \beta^o\)</span>，并且 <span class="math inline">\(E(\hat\beta) = \beta^o\)</span>； <strong>注：将 <span class="math inline">\((X^\prime X)^{-1} X^\prime\)</span> 视为系数矩阵</strong>（<span class="math inline">\(\star\star\star\)</span>）。</p>
<p>2）<strong>方差偏小性</strong> &lt; Vanishing variance &gt; 所有无偏估计中，最小二乘的方差最小： <span class="math display">\[
\begin{align*}
var(\hat \beta |X) = E\{[\hat\beta - E(\hat \beta|X)][\hat\beta - E(\hat\beta|X)]^\prime |X\} = \sigma^2(X^\prime X)^{-1}
\end{align*}
\]</span> 如果假设 3.3 (2) 也成立，那么对于任意的 <span class="math inline">\(K \times 1\)</span> 向量 <span class="math inline">\(\tau\)</span>，满足 <span class="math inline">\(\tau^\prime \tau = 1\)</span>，有： <span class="math display">\[
\begin{align*}
  \mathsf{当} n \to \infty \mathsf{时，}\tau^\prime var(\hat\beta|X)\tau \to 0
  \end{align*}
\]</span> 3）<strong>正交性</strong> &lt; Orthogonality between <span class="math inline">\(e\)</span> and <span class="math inline">\(\beta\)</span> &gt; ： <span class="math display">\[
\begin{align*}
  cov(\hat \beta, e|X) = 0
\end{align*}
\]</span> 4）<strong>Gauss - Markov 定理</strong>：对于任意的线性无偏估计量 <span class="math inline">\(\hat b, var(\hat b|X) - var(\hat\beta|X)\)</span> 是半正定 (Positive semi-definite, PSD) 的（说明 <span class="math inline">\(\hat{\beta}\)</span> 是方差最小的。</p>
<p>5）<strong>残差方差估计量</strong> &lt; Residual variance estimator &gt;： <span class="math display">\[
\begin{align*}
  s^2 = e^\prime e/(n - K) = \frac{1}{n - K }\sum_\limits{t = 1}^{n} e_t^2
\end{align*}
\]</span> 是 <span class="math inline">\(\sigma^2 = E(\varepsilon_t^2)\)</span> 的无偏估计量，即 <span class="math inline">\(E(s^2 | X) = \sigma^2\)</span>。</p>
<p><strong>注：</strong> <strong>由于随机变量 <span class="math inline">\(\{e_t\}\)</span> 必须满足 <span class="math inline">\(K\)</span> 个正规方程 <span class="math inline">\(X^\prime e = 0\)</span>，故其中只有 <span class="math inline">\((n - K)\)</span> 个残差是（自由）独立的，</strong>经过自由度校正后，才是无偏估计。如果样本容量 <span class="math inline">\(n\)</span> 很大，当 <span class="math inline">\(n \to \infty\)</span> 时，<span class="math inline">\(\frac{n - K}{n} \to 1\)</span>，是否进行“小样本校正”并无多大区别。</p></li>
</ul>
<h2 id="ols-估计量的抽样分布">3.5 <span class="math inline">\(OLS\)</span> 估计量的抽样分布</h2>
<h3 id="假设-1">3.5.1 假设</h3>
<ul>
<li><p><strong>假设 3.5</strong>（<span class="math inline">\(\rm{P}_{65}\)</span>）&lt; 条件正态分布 (Conditional Normality) &gt;：<span class="math inline">\(\varepsilon|X \sim N(0, \sigma^2 I)\)</span> 。</p>
<p>假设 3.5 可以推出假设 3.2（<span class="math inline">\(E(\varepsilon|X) = 0\)</span>） 和假设 3.4 （<span class="math inline">\(E(\varepsilon_t\varepsilon_s|X) = \sigma^2I\)</span>）。事实上，在假设 3.5 下，<span class="math inline">\(\varepsilon\)</span> 的条件概率密度函数： <span class="math display">\[
\begin{align*}
  f(\varepsilon|X) = \frac{1}{(\sqrt{2 \pi \sigma^2})^n}exp(-\frac{\varepsilon^\prime \varepsilon} {2\sigma^2}) = f(\varepsilon)
\end{align*}
\]</span> 不依赖于 <span class="math inline">\(X\)</span>，从而随机扰动项 <span class="math inline">\(\varepsilon\)</span> 独立于 <span class="math inline">\(X\)</span>。因此， <span class="math inline">\(\varepsilon\)</span> 的任何条件矩均不依赖于 <span class="math inline">\(X\)</span>。</p></li>
</ul>
<h3 id="定理-6">3.5.2 定理</h3>
<ul>
<li><p><strong>定理 3.6</strong>（<span class="math inline">\(\rm{P}_{65}\)</span>）&lt; <span class="math inline">\(\hat\beta\)</span> 的条件正态分布 &gt;：给定假设 3.1、3.3 (1) 和 3.5，对所有的 <span class="math inline">\(n&gt;K\)</span>： <span class="math display">\[
\begin{align*}
  (\hat \beta - \beta^o)|X \sim N[0, \sigma^2(X^\prime X)^{-1}]
\end{align*}
\]</span></p></li>
<li><p><strong>推论 3.7</strong>（<span class="math inline">\(\rm{P}_{66}\)</span>）&lt; <span class="math inline">\(R(\hat\beta - \beta^o)\)</span> 的条件正态分布 &gt;：给定假设 3.1、3.3 (1) 和 3.5，则对于任何非随机的 <span class="math inline">\(J \times K\)</span> 矩阵 <span class="math inline">\(R\)</span>（<span class="math inline">\(J\)</span> 为参数限制数目），有： <span class="math display">\[
  \begin{align*}
  R(\hat \beta - \beta^o)|X \sim N[0, R \sigma^2(X^\prime X)^{-1} R^\prime]
  \end{align*}
\]</span> 其中，<span class="math inline">\(R\)</span> 可以视为一个选择矩阵，如 <span class="math inline">\(R = (1, 0, 0, \cdots, 0)\)</span>，则 <span class="math inline">\(R(\hat{\beta} - \beta^o) = \hat{\beta}_0 - \beta_0^o\)</span>，在假设检验中需要用到 <span class="math inline">\(R(\hat{\beta} - \beta^o_0)\)</span> 的抽样分布。但由于 <span class="math inline">\(var(\varepsilon_t) = \sigma^2\)</span> 是未知的，因此要估计 <span class="math inline">\(\sigma^2\)</span>。</p></li>
</ul>
<h2 id="ols-估计量的方差---协方差矩阵的估计">3.6 <span class="math inline">\(OLS\)</span> 估计量的方差 - 协方差矩阵的估计</h2>
<h3 id="定理-7">3.6.1 定理</h3>
<ul>
<li><p><strong>引理 3.8</strong>（<span class="math inline">\(\rm{P}_{66}\)</span>）&lt; 正态随机变量的二次型 (Quadratic Form of Normal Random Variables) &gt;：如果一个 <span class="math inline">\(m\times 1\)</span> 随机变量 <span class="math inline">\(v \sim N(0, 1)\)</span>，并且 <span class="math inline">\(Q\)</span> 是一个 <span class="math inline">\(m \times m\)</span> 非随机对称幂等矩阵， 秩 <span class="math inline">\(1\leq m\)</span>，则二次型： <span class="math display">\[
 \begin{align*}
  v^\prime Q v \sim \chi^2_q
  \end{align*}
\]</span> 在以下引用中，<span class="math inline">\(v = \varepsilon/\sigma\sim N(0,1), Q = M\)</span>。因为 <span class="math inline">\(rank(M) = n - K\)</span>，所以： <span class="math display">\[
  \begin{align*}
  \left.\frac{e^\prime e}{\sigma^2} \right|X \sim \chi^2_{n-K}
  \end{align*}
\]</span></p></li>
<li><p><strong>引理 3.9</strong>（<span class="math inline">\(\rm{P}_{67}\)</span>）&lt; 残差方差的估计量 (Residual Variance Estimator) &gt;：给定假设 3.1、3.3 (1) 和 3.5，则对于任意的 <span class="math inline">\(n\leq K\)</span>，有：</p>
<p>1） <span class="math display">\[
\begin{align*}
  \left.\frac{(n-K)s^2}{\sigma^2} \right|X = \left.\frac{e^\prime e}{\sigma^2} \right|X \sim \chi^2_{n-K}
\end{align*}
\]</span> 其中，<span class="math inline">\(e = M\varepsilon\)</span>。 2）给定 <span class="math inline">\(X\)</span> 的条件下，<span class="math inline">\(s^2\)</span> 和 <span class="math inline">\(\hat\beta\)</span> 是独立的。从定理 3.4(3) 可知：<span class="math inline">\(cov(\hat{\beta, e|X}) = 0\)</span>，对于联合正态分布而言，零相关意味着相互独立。</p></li>
</ul>
<h2 id="参数假设检验">3.7 参数假设检验</h2>
<h3 id="定义-5">3.7.1 定义</h3>
<ul>
<li><strong>定义 3.4</strong>（<span class="math inline">\(\rm{P}_{73}\)</span>）&lt; 依分布收敛 (Convergence in Distribution) &gt; ：假设 <span class="math inline">\(\{Z_n, n= 1, 2, \dots\}\)</span> 是一个分布函数为<span class="math inline">\(\{F_n(z) = P(Z_n \leq z)\}\)</span> 的随机变量或随机向量的序列，<span class="math inline">\(Z\)</span> 是一个不依赖于 <span class="math inline">\(n\)</span> 的分布函数为 <span class="math inline">\(F(z) = P(Z \leq z)\)</span> 的随机变量或随机向量。称 <span class="math inline">\(Z_n\)</span> 依分布收敛于 <span class="math inline">\(Z\)</span>，如果在分布函数 <span class="math inline">\(F(z)\)</span> 的任何连续点，<span class="math inline">\(Z_n\)</span> 的分布函数值均收敛于 <span class="math inline">\(Z\)</span> 的分布函数值，即： <span class="math display">\[
\begin{align*}
  \lim_{n\to\infty} F_n(z) = F(z)
\end{align*}
\]</span> 或等价地： <span class="math display">\[
\begin{align*}
  \mathsf{当}\ n\to\infty\ \mathsf{时}, F_n(z) \to F(z)
\end{align*}
\]</span> 用符号 <span class="math inline">\(Z_n \overset{d}{\to} Z\)</span> 表示。<span class="math inline">\(Z\)</span> 的分布称为 <span class="math inline">\(Z_n\)</span> 的渐近分布或极限分布。</li>
</ul>
<h3 id="定理-8">3.7.2 定理</h3>
<ul>
<li><strong>推论 3.10</strong>（<span class="math inline">\(\rm{P}_{71}\)</span>）：给定假设 3.1、3.3 (1) 和 3.5，当原假设 <span class="math inline">\(\mathbb{H}_0: R\beta^o = r\)</span> 成立时，对于每一个 <span class="math inline">\(n\geq K\)</span>，有：</li>
</ul>
<p><span class="math display">\[
\begin{align*}
  (R\hat\beta - r)|X \sim N[0, \sigma^2 R(X^\prime X)^{-1}R^\prime]
\end{align*}
\]</span> - <strong>推论 3.11</strong>（<span class="math inline">\(\rm{P}_{76}\)</span>）：如果 <span class="math inline">\(q \times 1\)</span> 随机向量 <span class="math inline">\(Z \sim N(0, V)\)</span>，其中 <span class="math inline">\(V = var(Z)\)</span> 是一个 <span class="math inline">\(q\times q\)</span> 对称、非奇异的方差 - 协方差矩阵，则： <span class="math display">\[
  \begin{align*}
    Z^\prime V^{-1}Z \sim \chi_q^2
  \end{align*}
  \]</span></p>
<ul>
<li><p><strong>定理 3.12</strong>（<span class="math inline">\(\rm{P}_{78}\)</span>）：给定假设 3.1、3.3 (1) 和 3.5，当原假设 <span class="math inline">\(\mathbb{H}_0: R\beta^o = r\)</span> 成立时，对于每一个 <span class="math inline">\(n\geq K\)</span>，有： <span class="math display">\[
\begin{align*}
F = \frac{(R \hat\beta - r)^\prime[R(X^\prime X)^{-1}R^\prime]^{-1}(R \hat\beta - r)/J}{s^2} \sim F_{J,n-K}
\end{align*} \\
\frac{s^2(n-K)}{\sigma^2} \sim \chi^2(n-K)
\]</span></p></li>
<li><p><strong>定理 3.13</strong>（<span class="math inline">\(\rm{P}_{79}\)</span>）：给定假设 3.1、3.3 (1) ，令 <span class="math inline">\(SSR_u = e^\prime e\)</span> 是以下无约束回归模型的残差平方和： <span class="math display">\[
\begin{align*}
Y = X\beta^o + \varepsilon
\end{align*}
\]</span> 令 <span class="math inline">\(SSR_r = \tilde e^\prime \tilde e\)</span> 是以下有约束模型的残差平方和 ： <span class="math display">\[
\begin{align*}
Y = X\beta^o + \varepsilon
\end{align*}
\]</span> 其约束条件为： <span class="math display">\[
\begin{align*}
R \beta^o = r
\end{align*}
\]</span> 这里 <span class="math inline">\(\tilde e = Y - X \tilde \beta\)</span>，<span class="math inline">\(\tilde \beta\)</span> 是有约束回归模型的 <span class="math inline">\(OLS\)</span> 估计量。则 <span class="math inline">\(F\)</span> 检验统计量可写为： <span class="math display">\[
\begin{align*}
F = \frac{(\tilde e^\prime \tilde e - e^\prime e)/J}{e^\prime e/(n - K)}
\end{align*}
\]</span></p></li>
<li><p><strong>定理 3.14</strong>（<span class="math inline">\(\rm{P}_{81}\)</span>）：给定假设 3.1、3.3 (1) 和 3.5，则当原假设是 <span class="math inline">\(\mathbb{H}_0: R\beta^o = r\)</span> 成立且 <span class="math inline">\(n \to \infty\)</span> 时，<span class="math inline">\(Wald\)</span> 检验统计量： <span class="math display">\[
\begin{align*}
\mathcal{W} = \frac{(R\hat\beta - r)^\prime[R(X^\prime X)^{-1} R^\prime]^{-1}(R\hat\beta  - r)}{s^2} = J \cdot F \overset{d}{\to}\chi^2_J
\end{align*}
\]</span> 可以发现，这里定义的 <span class="math inline">\(Wald\)</span> 检验统计量与 <span class="math inline">\(F\)</span> 检验统计量 <strong>只相差一个比例常数</strong> <span class="math inline">\(J\)</span>，这是因为目前考虑条件同方差的情形。如果存在条件异方差，仍然可以定义 <span class="math inline">\(Wald\)</span> 检验统计量，但是 <span class="math inline">\(W = J \cdot F\)</span> 这一关系将不再成立。</p></li>
</ul>
<h2 id="广义最小二乘估计">3.9 广义最小二乘估计</h2>
<p>经典线性回归模型依赖于关键假设—假设 3.5（<span class="math inline">\(\varepsilon|X \sim N(0, \sigma^2 I)\)</span> ）。除了条件正态分布外，还隐含不存在条件异方差和自相关性。</p>
<h3 id="假设-2">3.9.1 假设</h3>
<ul>
<li><p><strong>假设 3.6</strong>（<span class="math inline">\(\rm{P}_{87}\)</span>）：<span class="math inline">\(\varepsilon|X \sim N(0, \sigma^2 V)\)</span>，其中 <span class="math inline">\(0 &lt; \sigma^2 &lt; \infty\)</span> 是未知的，但 <span class="math inline">\(V = V(X)\)</span> 是一个已知的对称与有限的 <span class="math inline">\(n \times n\)</span> 正定矩阵。</p>
<p>从假设可知条件方差（<span class="math inline">\(\star\star\star\)</span>）： <span class="math display">\[
\begin{align*}
var(\varepsilon|X) = E(\varepsilon^\prime\varepsilon|X) = \sigma^2V = \sigma^2 V(X)
\end{align*}
\]</span> 虽然 <span class="math inline">\(var(\varepsilon|X)\)</span> 仅包含一个未知常数 <span class="math inline">\(\sigma^2\)</span>，但它允许存在已知形式的条件异方差 <span class="math inline">\(V(X)\)</span>。</p></li>
</ul>
<h3 id="定义-6">3.9.2 定义</h3>
<h3 id="定理-9">3.9.3 定理</h3>
<ul>
<li><p><strong>定理 3.15</strong>（<span class="math inline">\(\rm{P}_{87}\)</span>）：给定假设 3.1、3.3 (1) 和 3.6，则：</p>
<p>1）<strong>无偏性</strong>：<span class="math inline">\(E(\hat\beta|X) = \beta^o\)</span>；</p>
<p>2）<strong>方差</strong>：<span class="math inline">\(var(\hat\beta|X) = \sigma^2(X^\prime X)^{-1} X^\prime VX(X^\prime X)^{-1} \neq \sigma^2(X^\prime X)^{-1}\)</span>；</p>
<p>3）<strong>正态分布</strong>：<span class="math inline">\((\hat\beta - \beta^o)|X \sim N[0,\sigma^2 (X^\prime X)^{-1}X^\prime VX(X^\prime X)^{-1}]\)</span>；</p>
<p>4）<strong>相关性</strong>：<span class="math inline">\(cov(\hat\beta,e|X) = E[(X^\prime X)^{-1} X^\prime \varepsilon \varepsilon^\prime M] = \sigma^2 (X^\prime X)^{-1} X^\prime V M \neq 0\)</span>（其中，<span class="math inline">\(V \neq I,\ e = M \varepsilon,\ M = I - P,\ P = X(X^\prime X)^{-1} X\)</span>）。</p>
<p>相关性表明，由于给定 <span class="math inline">\(X, \hat \beta\)</span> 和 <span class="math inline">\(e\)</span> 存在相关性，<span class="math inline">\(t\)</span> 检验和 <span class="math inline">\(F\)</span> 检验统计量定义中的分子和分母不再独立，所以不能得到有限样本条件下的 <span class="math inline">\(t\)</span> 分布和 <span class="math inline">\(F\)</span> 分布。为了解决该问题，需要考虑新的估计方法——GLS。</p></li>
<li><p><strong>引理 3.16</strong>（<span class="math inline">\(\rm{P}_{88}\)</span>）：对于任意的 <span class="math inline">\(n \times n\)</span> 对称正定矩阵 <span class="math inline">\(V\)</span>，总可以写成： <span class="math display">\[
\begin{align*}
V^{-1} &amp;= C^\prime C \\
V &amp;= C^{-1}(C^\prime)^{-1}
\end{align*}
\]</span> 这里，<span class="math inline">\(C\)</span> 是一个 <span class="math inline">\(n \times n\)</span> 非奇异矩阵。这称为 Cholesky 分解（Cholesky factorization），其中 C 可能是非对称矩阵。</p>
<p>考虑线性回归模型： <span class="math display">\[
\begin{align*}
CY = (CX)\beta^o + C \varepsilon
\end{align*}
\]</span> 令 <span class="math inline">\(Y^* = CY, X^* = CX, \varepsilon^* = C\varepsilon\)</span>。所以有：</p>
<p><span class="math inline">\(E(\varepsilon^*|X) = E(C \varepsilon|X) = 0\)</span>;</p>
<p><span class="math inline">\(var(\varepsilon^*|X) = CE(\varepsilon \varepsilon^\prime | X) C^\prime = \sigma^2 CVC^\prime = \sigma^2 I\)</span> ;</p>
<p>变换后的回归模型的 <span class="math inline">\(OLS\)</span> 估计量为： <span class="math display">\[
\begin{align*}
\hat\beta{}^* = (X^{*\prime}X^*)^{-1}(X^{*\prime}Y^*) = (X^\prime V^{-1}X)^{-1} X^\prime V^{-1} Y
\end{align*}
\]</span> 称为广义最小二乘 (<span class="math inline">\(GLS\)</span>) 估计量。变换后的 <span class="math inline">\(\hat{\beta^*}\)</span> 和 <span class="math inline">\(e^*\)</span> 不相关，故 <span class="math inline">\(t\)</span> 和 <span class="math inline">\(F\)</span> 检验可用：</p>
<p><span class="math display">\[
\begin{align*}
T^* &amp;= \frac{R \hat\beta {}^* - r}{\sqrt{s^*{}^2 {R(X{}^*}^\prime {X{}^*})^{-1}R^\prime}} \sim t(n-K) \\
F{}^* &amp;= \frac{(R \hat\beta {}^* - r)^\prime[{R(X{}^*}^\prime {X{}^*})^{-1}R^\prime]^{-1}(R \hat\beta{}^* - r)}{s^2} \sim F_{J,n-K}
\end{align*}
\]</span></p></li>
<li><p><strong>定理 3.17</strong>（<span class="math inline">\(\rm{P}_{91}\)</span>）：给定假设 3.1、3.3 (1) 和 3.6，则：</p>
<p>1）<strong>无偏性</strong>：<span class="math inline">\(E(\hat\beta{}^*|X) = \beta^o\)</span>；</p>
<p>2）<strong>方差</strong>：<span class="math inline">\(var(\hat\beta{}^*|X) = \sigma^2(X^{*\prime} X^*)^{-1} = \sigma^2(X^\prime V^{-1} X)^{-1}\)</span>；</p>
<p>3）<strong>相关性</strong>：<span class="math inline">\(cov(\hat\beta{}^*,e^*|X) = 0\)</span>，其中 <span class="math inline">\(e^* = Y^* - X^* \hat\beta{}^*\)</span>；</p>
<p>4）<span class="math inline">\(\hat\beta{}^*\)</span> 是最优线性无偏估计量(BLUE);</p>
<p>5）<span class="math inline">\((s^{*2}|X) = \sigma^2\)</span>，其中 <span class="math inline">\(s^{*2} = e^{*\prime}e^*/(n-K)\)</span>。</p></li>
</ul>
<h1 id="独立同分布随机样本的线性回归模型">4 独立同分布随机样本的线性回归模型</h1>
<p>在 <span class="math inline">\(var(\varepsilon | X) = \sigma^2 V\)</span> 形式未定时，仍可用 <span class="math inline">\(OLS\)</span> 估计量 <span class="math inline">\(\hat \beta\)</span>，根据正确的方差公式 <span class="math inline">\(var(\hat\beta|X) = \sigma^2(X^\prime X)^{-1} X^\prime VX(X^\prime X)^{-1}\)</span>，可构造 <span class="math inline">\(var(\hat\beta|X)\)</span> 的估计量，此时经典的 <span class="math inline">\(t\)</span> 和 <span class="math inline">\(F\)</span> 检验已不再适用，因为他们建立在不正确的 <span class="math inline">\(var(\hat\beta|X)\)</span> 上的，此时，仅能适用渐近分布理论。</p>
<h2 id="渐近理论导论">4.1 渐近理论导论</h2>
<h3 id="定义-7">4.1.1 定义</h3>
<ul>
<li><p><strong>定义 4.1</strong>（<span class="math inline">\(\rm{P}_{103}\)</span>）&lt; 依均方收敛或依二次方均值收敛 (Convergence in Mean Squares or in Quadratic Mean) &gt; ：一个随机变量（或固定维数的随机向量，即 <span class="math inline">\(Z_n\)</span> 的维数不随 <span class="math inline">\(n\)</span> 的增加而变化）序列 <span class="math inline">\(\{Z_n, n = 1, 2, \dots\}\)</span> 依均方收敛于随机变量（或随机向量） <span class="math inline">\(Z\)</span>，如果当 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
E\ \Vert Z_n - Z \Vert^2 \to 0
\end{align*}
\]</span> 其中，<span class="math inline">\(\Vert \cdot \Vert\)</span> 是随机变量或随机向量的模。记 <span class="math inline">\(Z_n \overset{q.m.}{\to} Z\)</span>。</p>
<p><strong>注：</strong>当 <span class="math inline">\(Z_n\)</span> 是一个固定维数的随机向量时，可理解为 <span class="math inline">\(Z_n\)</span> 的每一个元素的序列收敛于 <span class="math inline">\(Z\)</span> 的相对应元素。如果 <span class="math inline">\(Z_n - Z\)</span> 是一个 <span class="math inline">\(l \times m\)</span> 的矩阵时，可将平方模定义为： <span class="math display">\[
\begin{align*}
\Vert Z_n - Z \Vert^2 = \sum_{t=1}^{l}\sum_{s = 1}^{m} [Z_n - Z]^2_{(t, s)}
\end{align*}
\]</span></p></li>
<li><p><strong>定义 4.2</strong>（<span class="math inline">\(\rm{P}_{103}\)</span>）&lt; 依概率收敛 (Convergence in Probability) &gt; ：一个随机变量序列 <span class="math inline">\(\{Z_n, n = 1, 2, \dots\}\)</span> 依概率收敛于 <span class="math inline">\(Z\)</span>，如果对任意给定的常数 <span class="math inline">\(\epsilon &gt; 0\)</span>，有： <span class="math display">\[
\begin{align*}
\mathsf{当}\ n\to \infty \mathsf{时},\ Pr[\ \Vert Z_n - Z \Vert &gt;\epsilon] \to 0
\end{align*}
\]</span> 或等价地： <span class="math display">\[
\begin{align*}
\mathsf{当}\ n\to \infty \mathsf{时},\ Pr[\ \Vert Z_n - Z \Vert \leq \epsilon] \to 1
\end{align*}
\]</span> 对于依概率收敛，可记为 <span class="math inline">\(Z_n - Z \overset{p}{\to} 0\)</span> 或 <span class="math inline">\(Z_n - Z = O_P(1)\)</span>。</p></li>
<li><p><strong>定义 4.3</strong>（<span class="math inline">\(\rm{P}_{106}\)</span>）&lt; 依概率有界 (Boundedness in Probability) &gt; ：一个随机变量序列 <span class="math inline">\(\{Z_n, n = 1, 2, \dots\}\)</span> 依概率有界的，如果对任意小的常数 <span class="math inline">\(\delta &gt; 0\)</span>，存在常数 <span class="math inline">\(C= C(\delta)&lt; \infty\)</span>，使得，当 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
P(\ \Vert Z_n \Vert &gt; C\ ) \leq \delta
\end{align*}
\]</span> 记为 <span class="math inline">\(Z_n = O_P(1)\)</span>。</p></li>
<li><p><strong>定义 4.4</strong>（<span class="math inline">\(\rm{P}_{108}\)</span>）&lt; 几乎必然收敛 (Almost sure convergence)) &gt; ：<span class="math inline">\(\{Z_n, n = 1, 2, \dots\}\)</span> 几乎必然收敛于 <span class="math inline">\(Z\)</span>，如果： <span class="math display">\[
\begin{align*}
\Pr[\lim_{n\to\infty}\Vert Z_n - Z \Vert = 0] = 1
\end{align*}
\]</span> 记为 <span class="math inline">\(Z_n - Z \overset{a.s.}{\to}\)</span> 或 <span class="math inline">\(Z_n - Z = o_{a.s.}(1)\)</span>。</p>
<p><strong>注：</strong>几乎必然收敛可以推出依概率收敛，但依概率收敛不一定能推出几乎必然收敛。</p></li>
</ul>
<h3 id="定理-10">4.1.2 定理</h3>
<ul>
<li><p><strong>引理 4.1</strong>（<span class="math inline">\(\rm{P}_{105}\)</span>）&lt; 独立同分布样本的弱大数定律 (Weak Law of Large Numbers (WLLN) for I.I.D Samples) &gt; ：假设随机样本 <span class="math inline">\(\{Z_t\}^n_{t=1}\)</span> 服从 <span class="math inline">\(i.i.d.(\mu,\sigma^2)\)</span>，并定义 <span class="math inline">\(\bar Z_n = n^{-1} \sum_\limits{t=1}^{n} Z_t\)</span>，这里 <span class="math inline">\(n = 1,2,\cdots\)</span>。则当 <span class="math inline">\(n \to \infty\)</span> 时： <span class="math display">\[
\begin{align*}
\bar Z_n \overset{p}{\to} \mu
\end{align*}
\]</span></p></li>
<li><p><strong>引理 4.2</strong>（<span class="math inline">\(\rm{P}_{105}\)</span>）&lt; 独立同分布随机样本的弱大数定律 (WLLN for I.I.D Samples) &gt; ：假设 <span class="math inline">\(\{Z_t\}^n_{t=1}\)</span> 是一个独立同分布随机样本，<span class="math inline">\(E(Z_t) = \mu\)</span> 且 <span class="math inline">\(E |Z_t| &lt; \infty\)</span>。定义 <span class="math inline">\(\bar Z_n = n^{-1} \sum_\limits{t=1}^{n} Z_t\)</span>，则当 <span class="math inline">\(n \to \infty\)</span> 时： <span class="math display">\[
\begin{align*}
\bar Z_n \overset{p}{\to} \mu
\end{align*}
\]</span></p></li>
<li><p><strong>引理 4.3</strong>（<span class="math inline">\(\rm{P}_{106}\)</span>）：如果 <span class="math inline">\(Z_t - Z \overset{q.m.}{\to} 0\)</span>，则 <span class="math inline">\(Z_t - Z \overset{p}{\to} 0\)</span>。</p></li>
<li><p><strong>引理 4.4</strong>（<span class="math inline">\(\rm{P}_{109}\)</span>）&lt; 独立同分布随机样本的强大数定律 (Strong Law of Large Numbers (SLLN) for I.I.D Samples) &gt; ：假设 <span class="math inline">\(\{Z_t\}^n_{t=1}\)</span> 是一个独立同分布随机样本，<span class="math inline">\(E(Z_t) = \mu\)</span> 且 <span class="math inline">\(E |Z_t| &lt; \infty\)</span>。则当 <span class="math inline">\(n \to \infty\)</span> 时： <span class="math display">\[
\begin{align*}
\bar Z_n \overset{a.s.}{\to} \mu
\end{align*}
\]</span></p></li>
<li><p><strong>引理 4.5</strong>（<span class="math inline">\(\rm{P}_{109}\)</span>）&lt; 连续性 (Continuity) &gt; ：</p>
<p>1）假设当 <span class="math inline">\(n \to \infty\)</span> 时，<span class="math inline">\(A_n - A \overset{p}{\to} 0, B_n - B \overset{p}{\to} 0\)</span>，且 <span class="math inline">\(g(\cdot)\)</span> 和 <span class="math inline">\(h(\cdot)\)</span> 是连续函数。则： <span class="math display">\[
\begin{align*}
[g(A_n) + h(B_n)] - [g(A) + h(B)] \overset{p}{\to} 0 \\
g(A_n)h(B_n) - g(A)h(B) \overset{p}{\to} 0
\end{align*}
\]</span> 2）对于几乎必然收敛，也有类似结论。</p></li>
<li><p><strong>引理 4.6</strong>（<span class="math inline">\(\rm{P}_{110}\)</span>）&lt; 独立同分布随机样本的中心极限定理 (CLT for I.I.D Random Samples) &gt;：假设 <span class="math inline">\(\{Z_t\}_{t=1}^{n}\)</span> 是一个 <span class="math inline">\(i.i.d.(\mu, \sigma^2)\)</span> 随机样本呢，这里 <span class="math inline">\(Z_t\)</span> 是随机变量。定义 <span class="math inline">\(\bar Z_n = n^{-1} \sum_\limits{t=1}^n Z_t\)</span> 时，有： <span class="math display">\[
\begin{align*}
\frac{\bar Z_n - E(\bar Z_n)}{\sqrt{var(\bar Z_n)}} = \frac{\sqrt{n}(\bar Z_n - \mu)}{\sigma} \overset{d}{\to} N(0,1)
\end{align*}
\]</span></p></li>
<li><p><strong>引理 4.7</strong>（<span class="math inline">\(\rm{P}_{112}\)</span>）&lt; Cramer-Wold 方法 &gt; ：假设 <span class="math inline">\(Z_n\)</span> 和 <span class="math inline">\(Z\)</span> 均是 <span class="math inline">\(p \times 1\)</span> 随机向量，这里 <span class="math inline">\(p\)</span> 是一个固定正整数。令 <span class="math inline">\(n \to \infty\)</span>。则 <span class="math inline">\(Z_n \overset{d}{\to} Z\)</span>，当且仅当对于任意非零的 <span class="math inline">\(\tau \in R^p\)</span>，且满足 <span class="math inline">\(\tau^\prime\tau = 1\)</span>，使得： <span class="math display">\[
\begin{align*}
\tau^\prime Z_n \overset{d}{\to} \tau^\prime Z
\end{align*}
\]</span></p></li>
<li><p><strong>定理 4.8</strong>（<span class="math inline">\(\rm{P}_{112}\)</span>）&lt; Slutsky 定理 &gt; ：令 <span class="math inline">\(Z_n \overset{d}{\to}Z, a_n \overset{d}{\to} a\)</span> 且 <span class="math inline">\(b_n \overset{d}{\to}b\)</span>, 其中 <span class="math inline">\(a\)</span> 和 <span class="math inline">\(b\)</span> 是常数。则当 <span class="math inline">\(n \to \infty\)</span> 时，有 ： <span class="math display">\[
\begin{align*}
a_n + b_n Z_n \overset{d}{\to} a + bZ
\end{align*}
\]</span></p></li>
<li><p><strong>定理 4.9</strong>（<span class="math inline">\(\rm{P}_{112}\)</span>）&lt; Delta 方法 &gt; ：假设 <span class="math inline">\(\sqrt n(Z_n - \mu)/\sigma \overset{d}{\to} N(0,1)\)</span>，<span class="math inline">\(g(\cdot)\)</span> 是连续可导的函数。且 <span class="math inline">\(g^\prime(\mu) \neq 0\)</span>。则当 <span class="math inline">\(n \to \infty\)</span> 时，有 <span class="math inline">\(\sqrt n [g(\bar Z_n) - g(\mu)] = g^\prime(\mu)\sqrt n(\bar Z_n - \mu) + O_P(1)\)</span>，且： <span class="math display">\[
\begin{align*}
\sqrt n [g(\bar Z_n) - g(\mu)] &amp;\overset{d}{\to} N\{0,\sigma^2[g^\prime(\mu)]^2\} \\
g(\bar{Z}_n) &amp;= g(\mu) + g^\prime(\bar{\mu}_n)(\bar{Z}_n - \mu) \\
\bar{\mu}_n &amp;= \lambda \mu + (1 - \lambda) \bar{Z}_n, \lambda \in [0, 1]
\end{align*}
\]</span></p></li>
</ul>
<h2 id="线性回归模型假设">4.2 线性回归模型假设</h2>
<h3 id="假设-3">4.2.1 假设</h3>
<ul>
<li><p><strong>假设 4.1</strong>（<span class="math inline">\(\rm{P}_{114}\)</span>）&lt; 独立同分布 (I.I.D) &gt; ：<span class="math inline">\(\{Y_t,X_t^\prime\}\)</span> 是一个可观测的独立同分布随机样本（独立同分布意味着，对于 <span class="math inline">\(t \neq s, cov(\varepsilon_t, \varepsilon_s) = 0\)</span>，回归扰动项不存在自相关）；</p></li>
<li><p><strong>假设 4.2</strong>（<span class="math inline">\(\rm{P}_{114}\)</span>）&lt; 线性 (Linearity) &gt; ： <span class="math display">\[
\begin{align*}
Y_t = X_t^\prime \beta^o + \varepsilon_t \qquad t = 1,\cdots,n
\end{align*}
\]</span></p></li>
<li><p><strong>假设 4.3</strong>（<span class="math inline">\(\rm{P}_{114}\)</span>）&lt; 正确模型设定 (Correct Model Specification) &gt; ：<span class="math inline">\(E(\varepsilon_t|X_t) = 0\)</span> 且 <span class="math inline">\(E(\varepsilon_t^2) = \sigma^2 &lt; \infty\)</span>；</p></li>
<li><p><strong>假设 4.4</strong>（<span class="math inline">\(\rm{P}_{114}\)</span>）&lt; 非奇异性同分布 (Nonsingularity) &gt; ： <span class="math inline">\(K\times K\)</span> 阶矩阵 <span class="math inline">\(Q = E(X_t X_t^\prime)\)</span> 是对称、有限与非奇异的；</p>
<p>由强大数定理可知：<span class="math inline">\(n \to \infty\)</span> 时，<span class="math inline">\(\frac{X^\prime X}{n} = \frac 1 n \sum\limits_{t=1}^{n}X_t X_t^\prime \overset{a.s}{\to} E(X_t X_t^\prime) = Q\)</span></p></li>
<li><p><strong>假设 4.5</strong>（<span class="math inline">\(\rm{P}_{114}\)</span>）： <span class="math inline">\(K\times K\)</span> 阶矩阵 <span class="math inline">\(V \equiv var(X_t \varepsilon_t) = E(X_t X_t^\prime\varepsilon_t^2)\)</span> 是对称、有限与正定 (PD) 的；</p></li>
</ul>
<p>这些假设的一个重要特征时：不要求 <span class="math inline">\(\varepsilon\)</span> 服从条件正态分布，同时允许条件异方差，即 <span class="math inline">\(var(\varepsilon|X_t) \neq \sigma^2\)</span>。</p>
<h2 id="ols-估计量的一致性">4.3 <span class="math inline">\(OLS\)</span> 估计量的一致性</h2>
<p>由假设 4.4 可知，对于所有的 <span class="math inline">\(j\in\{0, 1, \cdots, k\}, E(X_{jt}^2)&lt;\infty\)</span>。根据对立同分布随机样本的强大数据定律（引理 4.4），当 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
\frac{X^\prime X}{n} = \frac{1}{n}\sum_{t=1}^{n} X_t X_t^\prime \overset{a.s.}{\to}E(X_t X_t^\prime) = Q \qquad (\star\star\star)
\end{align*}
\]</span> 假设有一个随机样本 <span class="math inline">\(\{Y_t, X_t^\prime\}_{t=1}^n\)</span>。回忆 <span class="math inline">\(OLS\)</span> 估计量： <span class="math display">\[
\begin{align*}
\hat \beta = (X^\prime X)^{-1}X^\prime Y = \hat Q{}^{-1} n^{-1} \sum_{t=1}^{n} X_t Y_t
\end{align*}
\]</span> 其中， <span class="math display">\[
\begin{align*}
\hat Q{}^{-1} = n^{-1} \sum_{t=1}^{n} X_t X_t^\prime
\end{align*}
\]</span> 将 <span class="math inline">\(Y_t = X_t^\prime \beta^o + \varepsilon_t\)</span>（参见假设 4.2）代入，得： <span class="math display">\[
\begin{align*}
\hat \beta  = \beta^o + \hat Q{}^{-1} n^{-1}\sum_{t=1}^{n} X_t \varepsilon_t
\end{align*}
\]</span> <span class="math inline">\(\hat{\beta} - \beta^o = \hat{Q}{}^{-1}\sum\limits_{t=1}^{n} X_t \varepsilon_t \overset{P}{\to} 0\)</span> 下面考察 <span class="math inline">\(\hat\beta\)</span> 的一致性。 ### 4.3.1 定理</p>
<ul>
<li><strong>定理 4.10</strong>（<span class="math inline">\(\rm{P}_{116}\)</span>）&lt; <span class="math inline">\(OLS\)</span> 估计量的一致性 (Consistency of OLS) &gt; ：给定假设 4.1-4.4，且当 <span class="math inline">\(n\to\infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
\hat\beta \overset{d}{\to} \beta^o \mathsf{或} \hat\beta - \beta^o = O_P(1)
\end{align*}
\]</span></li>
</ul>
<h3 id="ols-估计量的渐近正态性">4.4 <span class="math inline">\(OLS\)</span> 估计量的渐近正态性</h3>
<h3 id="假设-4">4.4.1 假设</h3>
<ul>
<li><strong>假设 4.6</strong>（<span class="math inline">\(\rm{P}_{119}\)</span>）&lt; 条件同方差 (Conditional Homoskedasticity) &gt;：<span class="math inline">\(E(\varepsilon_t^2|X_t) = \sigma^2\)</span>。</li>
</ul>
<h3 id="定理-11">4.4.2 定理</h3>
<ul>
<li><p><strong>引理 4.11</strong>（<span class="math inline">\(\rm{P}_{117}\)</span>）&lt; 独立同分布随机样本的多元中心极限定理 (Multivariate CLT for I.I.D. Random Samples) &gt;：假设 <span class="math inline">\(\{Z_t\}^n_{t=1}\)</span> 是一个独立同分布随机样本，且 <span class="math inline">\(E(Z_t) = 0, var(Z_t) = E(Z_t Z_t^\prime) = V\)</span> 是一个有限、对称与正定的矩阵，定义： <span class="math display">\[
\begin{align*}
\bar Z_n = n^{-1} \sum_{t=1}^n Z_t
\end{align*}
\]</span> 则当 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
\sqrt n \bar Z_n \overset{d}{\to} N(0, V)
\end{align*}
\]</span> 或等价地： <span class="math display">\[
\begin{align*}
V^{-\frac{1}{2}} \sqrt n \bar Z_n \overset{d}{\to} N(0, I)
\end{align*}
\]</span> 其中，<span class="math inline">\(I\)</span> 是一个维数与 <span class="math inline">\(V\)</span> 相同的单位矩阵。引理 4.11 表明，<span class="math inline">\(V \equiv var(Z_t)\)</span> 是 <span class="math inline">\(\sqrt n \bar Z_n\)</span> 的渐近分布的方差，简称 <span class="math inline">\(\sqrt n \bar Z_n\)</span> 的渐近方差，记为 <span class="math inline">\(avar(\sqrt n \bar Z_n) = V\)</span>。</p></li>
<li><p><strong>定理 4.12</strong>（<span class="math inline">\(\rm{P}_{118}\)</span>）&lt; <span class="math inline">\(OLS\)</span> 估计量的渐近正态分布 (Asymptotic Normality of OLS) &gt;：给定假设 4.1-4.5，则当 <span class="math inline">\(n\to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
\sqrt n (\hat \beta - \beta^o) \overset{d}{\to} N(0, Q^{-1}VQ^{-1})
\end{align*}
\]</span> 其中 <span class="math inline">\(V \equiv var(X_t\varepsilon_t) = E(X_t X_t^\prime \varepsilon_t^2)\)</span>。</p></li>
<li><p><strong>定理 4.13</strong>（<span class="math inline">\(\rm{P}_{119}\)</span>）：给定假设 4.1-4.6，则当 <span class="math inline">\(n\to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
\sqrt n (\hat \beta - \beta^o) \overset{d}{\to} N(0, \sigma^2Q^{-1})
\end{align*}
\]</span> 定理 4.13 表明，当存在条件同方差时，<span class="math inline">\(\sqrt n(\bar \beta - \beta^o)\)</span> 的渐近方差 (<span class="math inline">\(\star\star\star\)</span>) 为： <span class="math display">\[
\begin{align*}
avar(\sqrt n \hat \beta) = \sigma^2Q^{-1}
\end{align*}
\]</span></p></li>
</ul>
<h2 id="渐近方差估计量">4.5 渐近方差估计量</h2>
<h3 id="定理-12">4.5.1 定理</h3>
<p><strong>1. 条件同法差</strong></p>
<p>在这种情况下，由定理 4.13，<span class="math inline">\(\sqrt{n}(\hat\beta - \beta^o)\)</span> 渐近方差为： <span class="math display">\[
\begin{align*}
avar(\sqrt n \hat \beta) = \sigma^2 Q^{-1}
\end{align*}
\]</span></p>
<ul>
<li><p><strong>引理 4.14</strong>（<span class="math inline">\(\rm{P}_{120}\)</span>）：给定假设 4.1、4.2 和 4.4，则： <span class="math display">\[
\begin{align*}
\hat Q = n^{-1} \sum_{t=1}^n X_t X_t^\prime \overset{p}{\to} Q
\end{align*}
\]</span> 其次，考虑估计 <span class="math inline">\(\sigma^2\)</span>。因为 <span class="math inline">\(\sigma^2 = E(\varepsilon_t^2)\)</span>，可使用样本残差方差估计量： <span class="math display">\[
\begin{align*}
s^2 = e^\prime e/(n-K) = \frac{1}{n-K} \sum_{t=1}{n} e_t^2
\end{align*}
\]</span></p></li>
<li><p><strong>定理 4.15</strong>（<span class="math inline">\(\rm{P}_{120}\)</span>）：&lt; <span class="math inline">\(\sigma^2\)</span> 的一致估计量 (Consistent Estimator of <span class="math inline">\(\sigma^2\)</span>)&gt;：给定假设 4.1-4.4，当 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
s^2 \overset{p}{\to} \sigma^2
\end{align*}
\]</span></p></li>
<li><p><strong>定理 4.16</strong>（<span class="math inline">\(\rm{P}_{121}\)</span>）：&lt; 条件同方差下 <span class="math inline">\(\sqrt n (\hat\beta - \beta^o)\)</span> 的渐近方差估计量 (Asymototic Variance Estimator of OLS Under Conditional Homoskedasticity) &gt;：给定假设 4.1-4.4，当 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
s^2 \hat Q {}^{-1} \overset{p}{\to} avar(\sqrt n \hat \beta) = \sigma^2 Q^{-1}
\end{align*}
\]</span> <span class="math inline">\(\sqrt n (\hat\beta - \beta^o)\)</span> 的渐近方差估计量是： <span class="math display">\[
\begin{align*}
s^2 \hat Q {}^{-1} = s^2(X^\prime X /n)^{-1}
\end{align*}
\]</span> 这等价于，当 <span class="math inline">\(n\)</span> 很大时，<span class="math inline">\((\hat\beta - \beta^o)\)</span> 的方差估计量近似为： <span class="math display">\[
\begin{align*}
s^2 \hat Q {}^{-1}/n = s^2(X^\prime X)^{-1}
\end{align*}
\]</span></p></li>
</ul>
<p><strong>2. 条件异方差</strong></p>
<p>在存在条件异方差（即 <span class="math inline">\(E(\varepsilon_t^2|X_t) \neq \sigma^2\)</span>) 时，<span class="math inline">\(\sqrt n (\hat\beta - \beta^o)\)</span> 的渐近方差为： <span class="math display">\[
\begin{align*}
avar(\sqrt n \hat \beta) = Q^{-1} V Q^{-1}
\end{align*}
\]</span> 其中，<span class="math inline">\(V = E(X_t X_t^\prime \varepsilon_t^2)\)</span>。</p>
<ul>
<li><p><strong>引理 4.17</strong>（<span class="math inline">\(\rm{P}_{122}\)</span>）：给定假设 4.1-4.5 和 4.7，则当 <span class="math inline">\(n \to \infty\)</span> 时，有 <span class="math display">\[
\begin{align*}
\hat V = \frac{1}{n} \sum_{t = 1}^{n} X_t X_t^\prime e_t^2 \overset{p}{\to} V
\end{align*}
\]</span></p></li>
<li><p><strong>引理 4.18</strong>（<span class="math inline">\(\rm{P}_{123}\)</span>）&lt; 条件异方差下 <span class="math inline">\(\sqrt n \hat \beta\)</span> 的渐近方差估计量 (Asymptotic Variance Estimator of OLS Under Conditional Heteroskedasticity) &gt;：给定假设 4.1-4.5 和 4.7，则当 <span class="math inline">\(n \to \infty\)</span> 时，有 <span class="math display">\[
\begin{align*}
\hat Q{}^{-1} \hat V \hat Q{}^{-1} \overset{p}{\to} avar{\sqrt n \hat \beta} = Q^{-1} V Q^{-1}
\end{align*}
\]</span> 这就是 <span class="math inline">\(\sqrt n \hat \beta\)</span> 的 <span class="math inline">\(White (1980)\)</span> 异方差一致性方差 - 协方差矩阵估计量 (Heteroskedasticity-consistent variance-covariance matrix estimator)。因此，当存在条件异方差及 <span class="math inline">\(n\)</span> 很大时，<span class="math inline">\(\hat \beta - \beta^o\)</span> 的方差估计量为: <span class="math display">\[
\begin{align*}
\frac{\hat Q{}^{-1} \hat V \hat Q{}^{-1}}{n} &amp;= \frac{(X^\prime X /n)^{-1} \hat V (X^\prime X /n)^{-1}}{n}\\
&amp;=  (X^\prime X)^{-1} X^\prime D(e) D(e)^\prime X (X^\prime X)^{-1}\\
&amp;\neq s^2(X^\prime X)^{-1}
\end{align*}
\]</span></p>
<p>其中 <span class="math inline">\(D(e) = diag(e_1, \cdots, e_n) \neq s^2 I\)</span>。</p></li>
</ul>
<h3 id="假设-5">4.5.2 假设</h3>
<ul>
<li><p><strong>假设 4.7</strong>（<span class="math inline">\(\rm{P}_{122}\)</span>）：(1) 对于所有的 <span class="math inline">\(j \in \{0,1,\cdots,k\}, E(X_{jt}^4)&lt;\infty\)</span>。(2) <span class="math inline">\(E(X\varepsilon_{t}^4)&lt;\infty\)</span>。 <span class="math display">\[
\begin{align*}
s^2 \hat Q {}^{-1} \overset{p}{\to} avar(\sqrt n \hat \beta) = \sigma^2 Q^{-1}
\end{align*}
\]</span></p>
<p>注：渐近方差估计 <span class="math inline">\(\hat Q {}^{-1} V \hat Q {}^{-1}\)</span> 在条件同方差下也是渐近有效的，即 <span class="math inline">\(\hat Q {}^{-1} V \hat{Q}{}^{-1} \overset{P}{\to} Avar(\sqrt{n}\hat{\beta}) = \sigma^2 Q{}^{-1}\)</span>，但在有限样本条件下，可能不如 <span class="math inline">\(\sigma^2 Q^{-1}\)</span> 表现好，因为后者利用了条件同方差这一信息。</p></li>
</ul>
<h2 id="参数假设检验-1">4.6 参数假设检验</h2>
<p>下面考虑如何构建统计量以检验原假设： <span class="math display">\[
\begin{align*}
\mathbb{H}: R\beta^o = r
\end{align*}
\]</span> 其中 <span class="math inline">\(R\)</span> 时 <span class="math inline">\(J \times K\)</span> 满秩矩阵，<span class="math inline">\(r\)</span> 是 <span class="math inline">\(J \times 1\)</span> 常向量，且 <span class="math inline">\(J \leq K\)</span>。</p>
<p>首先考虑统计量 <span class="math inline">\(R \hat\beta - r = R(\hat\beta - \beta^o) + R\beta^o - r\)</span>，所以再原假设 <span class="math inline">\(\mathbb{H}: R\beta^o = r\)</span> 下有： <span class="math display">\[
\begin{align*}
\sqrt n (R \hat\beta - r) &amp;= R\sqrt n(\hat\beta - \beta^o) \\
&amp;\overset{d}{\to} N(0, RQ^{-1}VQ^{-1}R^\prime)
\end{align*}
\]</span></p>
<p>其中，<span class="math inline">\(\hat Q = \frac{X^{\prime} X}{n} \overset{P}{\to} Q,\ s^2 \overset{P}{\to} \sigma^2\)</span>。</p>
<p><strong>1. 条件同方差情形</strong>(<span class="math inline">\(V = \sigma^2 Q\)</span>)</p>
<ul>
<li><p><strong>定理 4.19</strong>（<span class="math inline">\(\rm{P}_{125}\)</span>）&lt; <span class="math inline">\(t\)</span> 检验 &gt;：给定假设 4.1-4.4 和 4.6，则当假设 <span class="math inline">\(\mathbb{H}_0: R\beta^o = r\)</span> 成立， <span class="math inline">\(J = 1\)</span>，且 <span class="math inline">\(n\to \infty\)</span> 时，经典 <span class="math inline">\(t\)</span> 检验统计量： <span class="math display">\[
\begin{align*}
T &amp;= \frac{\sqrt n(R\beta_o - r)}{\sqrt{\sigma^2 R Q^{-1} R^{\prime}}} \\
&amp;= \frac{R\beta_o - r}{\sqrt{s^2 R (nQ)^{-1} R^{\prime}}} \\
&amp;=  \frac{R\beta^o - r}{\sqrt{s^2 R(X^\prime X)^{-1}R^\prime}}   \overset{p}{\to} N(0, 1)
\end{align*}
\]</span></p></li>
<li><p><strong>定理 4.20</strong>（<span class="math inline">\(\rm{P}_{125}\)</span>）&lt; 渐近 <span class="math inline">\(\chi^2\)</span> 检验 &gt;：给定假设 4.1-4.4 和 4.6，则当假设 <span class="math inline">\(\mathbb{H}_0: R\beta^o = r\)</span> 成立， <span class="math inline">\(J \leq 1\)</span>，且 <span class="math inline">\(n\to \infty\)</span>, <span class="math inline">\(Wald\)</span> 检验统计量（同方差，方差可知： <span class="math display">\[
\begin{align*}
\mathcal{W} &amp;\equiv (R\beta^o - r)^\prime[s^2 R(X^\prime X)^{-1}R]^{-1}(R\beta^o - r) \\
&amp;= J \cdot F \overset{d}{\to} \chi^2_J
\end{align*}
\]</span></p></li>
<li><p><strong>定理 4.21</strong>（<span class="math inline">\(\rm{P}_{126}\)</span>）&lt; <span class="math inline">\((n-K)\mathcal{R}^2\)</span> 检验 &gt;：给定假设 4.1-4.6，检验以下原假设： <span class="math display">\[
\begin{align*}
\mathbb{H}_0:\beta^o_0 = \beta^o_1 = \cdots = \beta^o_k = 0
\end{align*}
\]</span> 其中，<span class="math inline">\(\beta^o_0, \beta^o_1, \cdots, \beta^o_k\)</span> 是线性回归方程: <span class="math display">\[
\begin{align*}
Y = \beta^o_0 + \beta^o_1 X_{1t} + \cdots + \beta^o_k X_{kt} + \varepsilon_t
\end{align*}
\]</span> 除截距项 <span class="math inline">\(\beta_0^o\)</span> 意外的所有回归系数。令 <span class="math inline">\(\mathcal{R}^2\)</span> 是无约束线性回归模型的决定系数，则当原假设 <span class="math inline">\(\mathbb{H}_0\)</span> 成立及 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
(n - K) \mathcal{R}^2 \overset{d}{\to} \chi^2_k
\end{align*}
\]</span> 其中，<span class="math inline">\(\mathcal{R}^2\)</span> 的定义（<span class="math inline">\(\rm{P}_{82}\)</span>）为： <span class="math display">\[
\begin{align*}
\mathcal{R}^2 &amp;= 1 - \frac{e^\prime e}{(Y - \bar Y l)^\prime (Y - \bar Y l)} = 1 - \frac{e^\prime e}{\tilde e{}^\prime \tilde e} \\
&amp; \frac{R^2/(k-1)}{(1-R^2)/(n-K)} \overset{d}{\to} F(K-1, n-K)
\end{align*}
\]</span> 在原假设 <span class="math inline">\(\mathcal{H}_0: \beta_1^o = \cdots = \beta_k^o = 0\)</span> 时，<span class="math inline">\(R^2 \overset{P}{\to} 0\)</span>。</p></li>
</ul>
<p><strong>2. 条件异方差情形</strong>(<span class="math inline">\(V \neq \sigma^2 Q\)</span>) 在原假设 <span class="math inline">\(\mathbb{H}_0: R \beta^o = r\)</span> 成立的条件下，有： <span class="math display">\[
\begin{align*}
\sqrt n (R \hat\beta - r) \overset{d}{\to} N(0, RQ^{-1}VQ^{-1}R^\prime)
\end{align*}
\]</span> 其中，<span class="math inline">\(V = E(X_t X_T^\prime \varepsilon_t^2)\)</span>，因此有 <span class="math display">\[
\begin{align*}
\frac{R\beta^o - r}{\sqrt{R Q^{-1} V Q^{-1} R^\prime}} \overset{p}{\to} N(0, 1)
\end{align*}
\]</span> 给定 <span class="math inline">\(\hat Q \overset{p}{\to} Q, \hat V \overset{p}{\to} V\)</span>，这里 <span class="math inline">\(\hat V = X^\prime D(e) D(e)^\prime X/n\)</span>，并由 Slutsky 定理，可定义稳健性 <span class="math inline">\(t\)</span> 检验统计量： <span class="math display">\[
\begin{align*}
T_r \equiv \frac{\sqrt n(R \hat\beta - r)}{\sqrt{R \hat Q{}^{-1} \hat V \hat Q{}^{-1} R^\prime}}
\end{align*}
\]</span> 当 <span class="math inline">\(\mathbb{H}_0:R\beta^o = r\)</span> 成立，且 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
T_r \overset{p}{\to} N(0, 1)
\end{align*}
\]</span> 这里，稳健性 (Robustness) 是指，当存在条件异方差时，<span class="math inline">\(T_r\)</span> 也是渐近有效的。</p>
<ul>
<li><p><strong>定理 4.22</strong>（<span class="math inline">\(\rm{P}_{128}\)</span>）&lt; 条件异方差下的稳健 <span class="math inline">\(t\)</span> 检验 (Robust t-Test Under Conditional Heteroskedasticity) &gt;：给定假设 4.1-4.5 和 4.7，则当原假设 <span class="math inline">\(\mathbb{H}_0: R \beta^o = r\)</span> 成立。</p>
<p>当 <span class="math inline">\(J = 1\)</span>，且 <span class="math inline">\(n \to \infty\)</span> 时，稳健 <span class="math inline">\(t\)</span> 检验统计量为： <span class="math display">\[
\begin{align*}
T_r \equiv \frac{\sqrt n(R \hat\beta - r)}{\sqrt{R \hat Q{}^{-1} \hat V \hat Q{}^{-1} R^\prime}} \overset{p}{\to} N(0, 1)
\end{align*}
\]</span> 当 <span class="math inline">\(J \geq 1\)</span>，在原假设 <span class="math inline">\(\mathbb{H}_0: R \beta^o = r\)</span> 下，有二次型： <span class="math display">\[
\begin{align*}
\mathcal{W} &amp;\equiv \sqrt n (R\hat \beta - r)^\prime[R \hat Q{}^{-1} \hat V \hat Q{}^{-1} R^\prime]^{-1}\sqrt n(R\hat \beta - r) \\
&amp;\overset{d}{\to} \chi^2_J
\end{align*}
\]</span> 其中， <span class="math display">\[
\begin{align*}
\hat Q &amp;= \frac{X^\prime X}{n}\\
\hat V &amp;= var(X_t e_t) = \frac{X^\prime D(e)D(e)^\prime X}{n}
\end{align*}
\]</span> 这里，<span class="math inline">\(D(e) = diag\{e_1, 2_2, \cdots,e_n\}\)</span>。</p></li>
<li><p><strong>定理 4.23</strong>（<span class="math inline">\(\rm{P}_{128}\)</span>）&lt; 条件异方差下的稳健 <span class="math inline">\(Wald\)</span> 检验 (Robust Wald Test Under Conditional Heteroskedasticity) &gt;：给定假设 4.1-4.5 和 4.7，则当原假设 <span class="math inline">\(\mathbb{H}_0: R \beta^o = r\)</span> 成立，且 <span class="math inline">\(n \to \infty\)</span> 时，有： <span class="math display">\[
\begin{align*}
\mathcal{W} &amp;\equiv \sqrt n (R\hat \beta - r)^\prime[R \hat Q{}^{-1} \hat V \hat Q{}^{-1} R^\prime]^{-1}\sqrt n(R\hat \beta - r) \\
&amp;\overset{d}{\to} \chi^2_J
\end{align*}
\]</span></p>
<p>异方差下，方差不可知，用渐近分布估计方差。</p></li>
</ul>
<h2 id="条件异方差检验">4.7 条件异方差检验</h2>
<p><strong><span class="math inline">\(White\)</span> 条件异方差检验</strong></p>
<p>考虑原假设：<span class="math inline">\(\mathbb{H}_0: E(\varepsilon_t^2|X_t) = \sigma^2\)</span>，其中，<span class="math inline">\(\varepsilon_t\)</span> 是 <span class="math inline">\(Y_t = X_t^\prime \beta^o + \varepsilon_t\)</span> 的随机扰动项。</p>
<p>非零假设为： <span class="math display">\[
\begin{align*}
\varepsilon_t^2 &amp;= \gamma^\prime \rm{vech}(X_t X_t^\prime) + v_t \\
&amp;= \beta_0 + \beta_1 
X_1 + \beta_2 X_2 + \cdots + \beta_t X_1 X_2 + \beta_s X_1 X_3 + \cdots + v_t
\end{align*}
\]</span> 其中，<span class="math inline">\(\rm{vech}(X_t X_t^\prime)\)</span> 是一个向量化算子，它将 <span class="math inline">\(K \times K\)</span> 对称矩阵 <span class="math inline">\(X_t X_t^\prime\)</span> 下三角元素转变为一个 <span class="math inline">\(\frac{K(K+1)}{2} \times 1\)</span> 向量。在 <span class="math inline">\(\mathbb{H}_0: E(\varepsilon_t^2|X_t) = \sigma^2\)</span> 下，<span class="math inline">\(\varepsilon_t^2\)</span> 与任何 <span class="math inline">\(X_t\)</span> 都不相关，故除截距项外，所有斜率系数均为零。</p>
<p>假设 <span class="math inline">\(E(\varepsilon_t^4|X_t) = \mu_4\)</span>，可以得到： <span class="math display">\[
\begin{align*}
(n-J-1)\tilde{\mathcal{R}} \overset{d}{\to} \chi_J^2
\end{align*}
\]</span></p>
<h1 id="平稳时间序列的线性回归模型">5 平稳时间序列的线性回归模型</h1>
<h2 id="时间序列分析导论">5.1 时间序列分析导论</h2>
<h3 id="定义-8">5.1 定义</h3>
<ul>
<li><strong>定义 5.1</strong>（<span class="math inline">\(\rm{P}_{137}\)</span>）&lt; 随机时间序列过程 (Stochastic Time Series Process) &gt;：一个随机时间序列过程 <span class="math inline">\(\{Z_t\}\)</span> 是由概率法则 <span class="math inline">\((\Omega, \mathbb{F}, P)\)</span> 支配而产生的随机变量或向量序列。其中， <span class="math inline">\(t \in \{\cdots, 0, 1, 2, \cdots\}\)</span> 代表时间，<span class="math inline">\(\Omega\)</span> 是样本空间，<span class="math inline">\(\mathbb{F}\)</span> 是 <span class="math inline">\(\sigma\ -\)</span> 域，<span class="math inline">\(P: \mathbb{F} \to [0, 1]\)</span> 是概率测度。</li>
</ul>
]]></content>
      <categories>
        <category>Class Notes</category>
        <category>Econometrics</category>
      </categories>
      <tags>
        <tag>Econometrics</tag>
      </tags>
  </entry>
  <entry>
    <title>Energy Economic Codes</title>
    <url>/2020/12/08/Energy-Economic/</url>
    <content><![CDATA[<h1 id="markov-model">1 Markov model</h1>
<h2 id="preparation-and-definition">1.1 Preparation and definition</h2>
<ul>
<li><p>Import modules</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> linalg <span class="keyword">as</span> la</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_absolute_error, r2_score</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plot module</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line"><span class="comment"># Microsoft YaHei, Times New Roman</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br></pre></td></tr></table></figure></li>
</ul>
<a id="more"></a>
<ul>
<li><p>Plot results</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_result</span>(<span class="params">test_Y, pred_Y, Title</span>):</span></span><br><span class="line">    ylim_min = np.<span class="built_in">round</span>(test_Y.<span class="built_in">min</span>()) - <span class="number">1</span></span><br><span class="line">    ylim_max = np.<span class="built_in">round</span>(test_Y.<span class="built_in">max</span>()) + <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># plot comparison results</span></span><br><span class="line">    fig = plt.figure(figsize = (<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line">    ax0 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">    ax0.scatter(test_Y, pred_Y)</span><br><span class="line">    ax0.plot([ylim_min, ylim_max], [ylim_min, ylim_max], <span class="string">&#x27;--k&#x27;</span>)</span><br><span class="line">    ax0.set_xlabel(<span class="string">&#x27;True Target&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">    ax0.set_ylabel(<span class="string">&#x27;Target predicted&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">    ax0.set_title(Title , fontsize = <span class="number">16</span>)</span><br><span class="line">    ax0.text(ylim_min + <span class="number">2</span>, ylim_max - <span class="number">4</span>, <span class="string">r&#x27;$R^2$ = %.2f, $MAE$ = %.2f&#x27;</span> %(r2_score(test_Y, pred_Y), </span><br><span class="line">                mean_absolute_error(test_Y, pred_Y)), fontsize = <span class="number">14</span>)</span><br><span class="line">    ax0.text(ylim_min + <span class="number">2</span>, ylim_max - <span class="number">5</span>, <span class="string">r&#x27;$MSE$ = %.2f, $RMSE$ = %.2f&#x27;</span> %(mean_squared_error(test_Y, pred_Y), </span><br><span class="line">                mean_squared_error(test_Y, pred_Y, squared=<span class="literal">False</span>)), fontsize = <span class="number">14</span>)</span><br><span class="line">    </span><br><span class="line">    ax0.set_xlim([ylim_min, ylim_max])</span><br><span class="line">    ax0.set_ylim([ylim_min, ylim_max])</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Plot prediction and real values</span></span><br><span class="line">    plt.figure(figsize = (<span class="number">8</span>, <span class="number">6</span>)) <span class="comment"># length x width</span></span><br><span class="line">    plt.plot(pred_Y, <span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;prediction&#x27;</span>, lw = <span class="number">0.8</span>)</span><br><span class="line">    plt.plot(test_Y, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;real&#x27;</span>, lw = <span class="number">0.8</span>)</span><br><span class="line">    plt.xticks(<span class="built_in">range</span>(<span class="number">19</span>), fontsize = <span class="number">15</span>)</span><br><span class="line">    plt.yticks(fontsize = <span class="number">15</span>)</span><br><span class="line">    plt.title(Title, fontsize = <span class="number">16</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">&#x27;best&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<p>绘制结果图（可选，可通过调整 <code>plot_b</code> 的值来选择是否绘图），包含两个:</p>
<p><img src="https://s3.ax1x.com/2020/12/08/rpDV56.md.png" /></p>
<center>
<p>Fig. 1-1 Trend figure of Coal</p>
</center>
<p><img src="https://s3.ax1x.com/2020/12/08/rpDePK.png" /></p>
<center>
<p>Fig. 1-2 Comparison figure of Coal</p>
</center></li>
<li><p>Calculate loss</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_error</span>(<span class="params">test_data, np_Pred_results, title</span>):</span></span><br><span class="line">    <span class="comment"># Storing error results </span></span><br><span class="line">    R2 = r2_score(test_data, np_Pred_results)</span><br><span class="line">    MAE = mean_absolute_error(test_data, np_Pred_results)</span><br><span class="line">    MSE = mean_squared_error(test_data, np_Pred_results)</span><br><span class="line">    RMSE = mean_squared_error(test_data, np_Pred_results, squared=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    error = [title, R2, MAE, MSE, RMSE]</span><br><span class="line">    <span class="keyword">return</span> error</span><br></pre></td></tr></table></figure>
<p>Calculate the loss: R2, MAE, MSE, RMSE</p></li>
<li><p>Definition of Markov model</p>
<p>The first step: calculate and return transfer matrix (type: np.array)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Markov_trans</span>(<span class="params">data_stru, year_start, year_end</span>):</span></span><br><span class="line">    P = np.identity(<span class="number">4</span>)</span><br><span class="line">    K = np.array([<span class="number">1.0</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>])</span><br><span class="line">    </span><br><span class="line">    year_start_data = data_stru.loc[year_start, :]</span><br><span class="line">    year_end_data = data_stru.loc[year_end,:]</span><br><span class="line">    </span><br><span class="line">    bool_value = np.array(year_end_data &lt; year_start_data)</span><br><span class="line">    i = <span class="number">0</span> <span class="comment"># index</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> bool_value:</span><br><span class="line">        <span class="keyword">if</span> b == <span class="literal">False</span>: <span class="comment"># Decrease</span></span><br><span class="line">            K[i] =  year_end_data[i] - year_start_data[i]</span><br><span class="line">        <span class="keyword">elif</span> b == <span class="literal">True</span>: <span class="comment"># Increase</span></span><br><span class="line">            P[i, i] = year_end_data[i]/year_start_data[i]</span><br><span class="line">            K[i] = <span class="number">0</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">          </span><br><span class="line">    KK = <span class="built_in">sum</span>(K)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="keyword">if</span> (j != n) &amp; (K[j] == <span class="number">0</span>):</span><br><span class="line">                P[j,n] = (<span class="number">1</span>-P[j,j])*K[n]/KK</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># v 为特征值    Q 为特征向量</span></span><br><span class="line">    P = np.<span class="built_in">round</span>(P, <span class="number">3</span>)</span><br><span class="line">    v, Q = la.eig(P)</span><br><span class="line">    <span class="comment"># diag_P = np.round(np.dot(np.dot(la.inv(Q), P), Q), 3)</span></span><br><span class="line">    V = np.diag(v)**((<span class="number">1</span>)/(year_end-year_start))</span><br><span class="line">    Predict_P =  np.<span class="built_in">round</span>(np.dot(np.dot(Q, V), la.inv(Q)), <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> Predict_P</span><br></pre></td></tr></table></figure>
<p>The second step: calculate and return forecasting result (type: np.array)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Markov_predict</span>(<span class="params">data_stru, P, year_end, year_pred</span>):</span></span><br><span class="line">    year_end_data = data_stru.loc[year_end,:]</span><br><span class="line">    P = np.<span class="built_in">round</span>(P, <span class="number">3</span>)</span><br><span class="line">    v, Q = la.eig(P)</span><br><span class="line">    <span class="comment"># diag_P = np.round(np.dot(np.dot(la.inv(Q), P), Q), 3)</span></span><br><span class="line">    V = np.diag(v)**(year_pred - year_end)</span><br><span class="line">    Predict_P =  np.<span class="built_in">round</span>(np.dot(np.dot(Q, V), la.inv(Q)), <span class="number">3</span>)</span><br><span class="line">    np_year_end_data =np.array(year_end_data)</span><br><span class="line">    Predict_energy_stru = np.around(np.dot(np_year_end_data, Predict_P), <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> Predict_energy_stru</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="preparation">1.2 Preparation</h2>
<ul>
<li><p>Read data file</p>
<p><code>Data.xlsx</code> 文件需要根程序文件在同一目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Read datafile</span></span><br><span class="line">data_stru = pd.read_excel(<span class="string">&#x27;./Data.xlsx&#x27;</span>, header = <span class="number">0</span>, </span><br><span class="line">                          sheet_name = <span class="number">0</span>, index_col= <span class="number">0</span>)</span><br><span class="line">num_year = <span class="built_in">len</span>(data_stru) <span class="comment"># the length of the dataset</span></span><br><span class="line">train_percent = <span class="number">0.7</span> <span class="comment"># Set the first 70% data as train set</span></span><br><span class="line">Error_results = [] <span class="comment"># Store all error results</span></span><br><span class="line">plot_b = <span class="literal">False</span> <span class="comment"># Choose whether plot result</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dataset start with 1953, end with 2017</span></span><br><span class="line">year_train_start, year_end = <span class="number">1953</span>, <span class="number">2018</span></span><br><span class="line">year_train_end = year_train_start + <span class="built_in">round</span>(<span class="built_in">len</span>(data_stru) * <span class="number">0.7</span>) <span class="comment"># = 1999</span></span><br><span class="line"></span><br><span class="line">test_data = np.array(data_stru.loc[year_train_end:, :]) <span class="comment"># from 1999 to 2017</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="model-application">1.3 Model application</h2>
<ul>
<li><p>Avarage trans_P</p>
<p>Model test based on avarage trans_P</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">trans_P = [] <span class="comment"># store all transfer matric</span></span><br><span class="line"><span class="keyword">for</span> startY <span class="keyword">in</span> <span class="built_in">range</span>(year_train_start, year_train_end - <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> endY <span class="keyword">in</span> <span class="built_in">range</span>(startY, year_train_end):</span><br><span class="line">        trans_temp = Markov_trans(year_start = year_train_start, </span><br><span class="line">                        year_end = year_train_end, data_stru = data_stru)</span><br><span class="line">        temp = trans_temp.tolist()</span><br><span class="line">        trans_P.append(temp)</span><br><span class="line"></span><br><span class="line">np_trans_P = np.array(trans_P) <span class="comment"># Transfer list into numpy</span></span><br><span class="line">av_trans_P = np.<span class="built_in">sum</span>(np_trans_P, <span class="number">0</span>)/np_trans_P.shape[<span class="number">0</span>] <span class="comment"># Calculate avarage</span></span><br><span class="line"></span><br><span class="line">Pred_results = [] <span class="comment"># Using average transfer matrix to predict energy structure</span></span><br><span class="line"><span class="keyword">for</span> predY <span class="keyword">in</span> <span class="built_in">range</span>(year_train_end, year_end):</span><br><span class="line">    <span class="comment"># Forecasting</span></span><br><span class="line">    Pred_temp = Markov_predict(data_stru = data_stru, P = av_trans_P, </span><br><span class="line">                            year_end = year_train_end - <span class="number">1</span>, year_pred = predY)</span><br><span class="line">    temp = Pred_temp.tolist() <span class="comment"># Turn numpy.array into list</span></span><br><span class="line">    Pred_results.append(temp) <span class="comment"># It&#x27;s convenient to append value using list</span></span><br><span class="line">    </span><br><span class="line">np_Pred_results = np.array(Pred_results) <span class="comment"># Turn list into np.array</span></span><br><span class="line">Columns = data_stru.columns</span><br><span class="line"><span class="comment"># Plot forecasting result if needed</span></span><br><span class="line"><span class="keyword">if</span> plot_b == <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        test_Y, pred_Y = test_data[:, i], np_Pred_results[:, i]</span><br><span class="line">        Title = <span class="string">&#x27;&#123;&#125; based on average transfer matrix to predict:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(regression, </span><br><span class="line">                                    Columns[i])</span><br><span class="line">        plot_result(test_Y, pred_Y, Title)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Storing error results</span></span><br><span class="line">title = <span class="string">&#x27;average transfer matrix&#x27;</span>  </span><br><span class="line"><span class="comment"># Calculate 4 error</span></span><br><span class="line">error = calculate_error(test_data, np_Pred_results, title)</span><br><span class="line">Error_results.append(error)</span><br></pre></td></tr></table></figure></li>
<li><p>One step and 46 step</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> year_train_start <span class="keyword">in</span> [<span class="number">1953</span>, <span class="number">1998</span>]: <span class="comment"># from &#x27;1953 to 1999&#x27; or &#x27;1998 to 1999&#x27;</span></span><br><span class="line">    year_train_end, year_end = <span class="number">1999</span>, <span class="number">2018</span></span><br><span class="line">    trans_temp = Markov_trans(year_start = year_train_start, </span><br><span class="line">                            year_end = year_train_end, data_stru = data_stru)</span><br><span class="line">    Pred_results = []</span><br><span class="line">    <span class="keyword">for</span> predY <span class="keyword">in</span> <span class="built_in">range</span>(year_train_end, year_end):</span><br><span class="line">        Pred_temp = Markov_predict(data_stru = data_stru, P = trans_temp, </span><br><span class="line">                                year_end = year_train_end - <span class="number">1</span>, year_pred = predY)</span><br><span class="line">        temp = Pred_temp.tolist()</span><br><span class="line">        Pred_results.append(temp)</span><br><span class="line">        </span><br><span class="line">    np_Pred_results = np.array(Pred_results)</span><br><span class="line">    Columns = data_stru.columns</span><br><span class="line">    <span class="keyword">if</span> plot_b == <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            test_Y, pred_Y = test_data[:, i], np_Pred_results[:, i]</span><br><span class="line">            Title = <span class="string">&#x27;&#123;&#125; based on &#123;&#125; and &#123;&#125; to predict:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(regression, </span><br><span class="line">                                    year_train_start, year_train_end, Columns[i])             </span><br><span class="line">            plot_result(test_Y, pred_Y, Title)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Storing error results  </span></span><br><span class="line">    title = <span class="string">&#x27;&#123;&#125; step&#x27;</span>.<span class="built_in">format</span>(year_train_end - year_train_start)   </span><br><span class="line">    error = calculate_error(test_data, np_Pred_results, title)</span><br><span class="line">    Error_results.append(error)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="export-result-to-excel">1.4 Export result to excel</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">np_error = np.array(Error_results)</span><br><span class="line">columns = [<span class="string">&#x27;Transfer Matrix&#x27;</span>, <span class="string">&#x27;R2&#x27;</span>, <span class="string">&#x27;MAE&#x27;</span>, <span class="string">&#x27;MSE&#x27;</span>, <span class="string">&#x27;RMSE&#x27;</span>]</span><br><span class="line">pd_error = pd.DataFrame(np_error, columns = columns, dtype = <span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">pd_error.to_excel(<span class="string">&#x27;Error result.xlsx&#x27;</span>, encoding = <span class="string">&#x27;utf_8_sig&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="all-codes">1.5 All codes</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Markov model for energy structure prediction#</span></span><br><span class="line"><span class="comment"># ========================= Import modules ====================================</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> linalg <span class="keyword">as</span> la</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_absolute_error, r2_score</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plot module</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line"><span class="comment"># Microsoft YaHei, Times New Roman</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== Preparation =======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read datafile</span></span><br><span class="line">data_stru = pd.read_excel(<span class="string">&#x27;./Data.xlsx&#x27;</span>, header = <span class="number">0</span>, </span><br><span class="line">                          sheet_name = <span class="number">0</span>, index_col= <span class="number">0</span>)</span><br><span class="line">num_year = <span class="built_in">len</span>(data_stru) <span class="comment"># the length of the dataset</span></span><br><span class="line">train_percent = <span class="number">0.7</span> <span class="comment"># Set the first 70% data as train set</span></span><br><span class="line">Error_results = [] <span class="comment"># Store all error results</span></span><br><span class="line">plot_b = <span class="literal">False</span> <span class="comment"># Choose whether plot result</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dataset start with 1953, end with 2017</span></span><br><span class="line">year_train_start, year_end = <span class="number">1953</span>, <span class="number">2018</span></span><br><span class="line">year_train_end = year_train_start + <span class="built_in">round</span>(<span class="built_in">len</span>(data_stru) * <span class="number">0.7</span>) <span class="comment"># = 1999</span></span><br><span class="line"></span><br><span class="line">test_data = np.array(data_stru.loc[year_train_end:, :]) <span class="comment"># from 1999 to 2017</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== Plot Results =====================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_result</span>(<span class="params">test_Y, pred_Y, Title</span>):</span></span><br><span class="line">    ylim_min = np.<span class="built_in">round</span>(test_Y.<span class="built_in">min</span>()) - <span class="number">1</span></span><br><span class="line">    ylim_max = np.<span class="built_in">round</span>(test_Y.<span class="built_in">max</span>()) + <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># plot comparison results</span></span><br><span class="line">    fig = plt.figure(figsize = (<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line">    ax0 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">    ax0.scatter(test_Y, pred_Y)</span><br><span class="line">    ax0.plot([ylim_min, ylim_max], [ylim_min, ylim_max], <span class="string">&#x27;--k&#x27;</span>)</span><br><span class="line">    ax0.set_xlabel(<span class="string">&#x27;True Target&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">    ax0.set_ylabel(<span class="string">&#x27;Target predicted&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">    ax0.set_title(Title , fontsize = <span class="number">16</span>)</span><br><span class="line">    ax0.text(ylim_min + <span class="number">2</span>, ylim_max - <span class="number">4</span>, <span class="string">r&#x27;$R^2$ = %.2f, $MAE$ = %.2f&#x27;</span> %(r2_score(test_Y, pred_Y), </span><br><span class="line">                mean_absolute_error(test_Y, pred_Y)), fontsize = <span class="number">14</span>)</span><br><span class="line">    ax0.text(ylim_min + <span class="number">2</span>, ylim_max - <span class="number">5</span>, <span class="string">r&#x27;$MSE$ = %.2f, $RMSE$ = %.2f&#x27;</span> %(mean_squared_error(test_Y, pred_Y), </span><br><span class="line">                mean_squared_error(test_Y, pred_Y, squared=<span class="literal">False</span>)), fontsize = <span class="number">14</span>)</span><br><span class="line">    </span><br><span class="line">    ax0.set_xlim([ylim_min, ylim_max])</span><br><span class="line">    ax0.set_ylim([ylim_min, ylim_max])</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Plot prediction and real values</span></span><br><span class="line">    plt.figure(figsize = (<span class="number">8</span>, <span class="number">6</span>)) <span class="comment"># length x width</span></span><br><span class="line">    plt.plot(pred_Y, <span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;prediction&#x27;</span>, lw = <span class="number">0.8</span>)</span><br><span class="line">    plt.plot(test_Y, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;real&#x27;</span>, lw = <span class="number">0.8</span>)</span><br><span class="line">    plt.xticks(<span class="built_in">range</span>(<span class="number">19</span>), fontsize = <span class="number">15</span>)</span><br><span class="line">    plt.yticks(fontsize = <span class="number">15</span>)</span><br><span class="line">    plt.title(Title, fontsize = <span class="number">16</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">&#x27;best&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate the loss: R2, MAE, MSE, RMSE</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_error</span>(<span class="params">test_data, np_Pred_results, title</span>):</span></span><br><span class="line">    <span class="comment"># Storing error results </span></span><br><span class="line">    R2 = r2_score(test_data, np_Pred_results)</span><br><span class="line">    MAE = mean_absolute_error(test_data, np_Pred_results)</span><br><span class="line">    MSE = mean_squared_error(test_data, np_Pred_results)</span><br><span class="line">    RMSE = mean_squared_error(test_data, np_Pred_results, squared=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    error = [title, R2, MAE, MSE, RMSE]</span><br><span class="line">    <span class="keyword">return</span> error</span><br><span class="line"></span><br><span class="line"><span class="comment"># =================== Markov model definition =============================</span></span><br><span class="line"><span class="comment"># The first step: calculate and return transfer matrix (type: np.array)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Markov_trans</span>(<span class="params">data_stru, year_start, year_end</span>):</span></span><br><span class="line">    P = np.identity(<span class="number">4</span>)</span><br><span class="line">    K = np.array([<span class="number">1.0</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>])</span><br><span class="line">    </span><br><span class="line">    year_start_data = data_stru.loc[year_start, :]</span><br><span class="line">    year_end_data = data_stru.loc[year_end,:]</span><br><span class="line">    </span><br><span class="line">    bool_value = np.array(year_end_data &lt; year_start_data)</span><br><span class="line">    i = <span class="number">0</span> <span class="comment"># index</span></span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> bool_value:</span><br><span class="line">        <span class="keyword">if</span> b == <span class="literal">False</span>: <span class="comment"># Decrease</span></span><br><span class="line">            K[i] =  year_end_data[i] - year_start_data[i]</span><br><span class="line">        <span class="keyword">elif</span> b == <span class="literal">True</span>: <span class="comment"># Increase</span></span><br><span class="line">            P[i, i] = year_end_data[i]/year_start_data[i]</span><br><span class="line">            K[i] = <span class="number">0</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">          </span><br><span class="line">    KK = <span class="built_in">sum</span>(K)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="keyword">if</span> (j != n) &amp; (K[j] == <span class="number">0</span>):</span><br><span class="line">                P[j,n] = (<span class="number">1</span>-P[j,j])*K[n]/KK</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># v 为特征值    Q 为特征向量</span></span><br><span class="line">    P = np.<span class="built_in">round</span>(P, <span class="number">3</span>)</span><br><span class="line">    v, Q = la.eig(P)</span><br><span class="line">    <span class="comment"># diag_P = np.round(np.dot(np.dot(la.inv(Q), P), Q), 3)</span></span><br><span class="line">    V = np.diag(v)**((<span class="number">1</span>)/(year_end-year_start))</span><br><span class="line">    Predict_P =  np.<span class="built_in">round</span>(np.dot(np.dot(Q, V), la.inv(Q)), <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> Predict_P</span><br><span class="line"></span><br><span class="line"><span class="comment"># The second step: calculate and return forecasting result (type: np.array)    </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Markov_predict</span>(<span class="params">data_stru, P, year_end, year_pred</span>):</span></span><br><span class="line">    year_end_data = data_stru.loc[year_end,:]</span><br><span class="line">    P = np.<span class="built_in">round</span>(P, <span class="number">3</span>)</span><br><span class="line">    v, Q = la.eig(P)</span><br><span class="line">    <span class="comment"># diag_P = np.round(np.dot(np.dot(la.inv(Q), P), Q), 3)</span></span><br><span class="line">    V = np.diag(v)**(year_pred - year_end)</span><br><span class="line">    Predict_P =  np.<span class="built_in">round</span>(np.dot(np.dot(Q, V), la.inv(Q)), <span class="number">3</span>)</span><br><span class="line">    np_year_end_data =np.array(year_end_data)</span><br><span class="line">    Predict_energy_stru = np.around(np.dot(np_year_end_data, Predict_P), <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> Predict_energy_stru</span><br><span class="line">  </span><br><span class="line"><span class="comment"># Lable</span></span><br><span class="line">regression = <span class="string">&#x27;Markov model&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========== Model test based on avarage trans_P ==========================</span></span><br><span class="line">trans_P = [] <span class="comment"># store all transfer matric</span></span><br><span class="line"><span class="keyword">for</span> startY <span class="keyword">in</span> <span class="built_in">range</span>(year_train_start, year_train_end - <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> endY <span class="keyword">in</span> <span class="built_in">range</span>(startY, year_train_end):</span><br><span class="line">        trans_temp = Markov_trans(year_start = year_train_start, </span><br><span class="line">                        year_end = year_train_end, data_stru = data_stru)</span><br><span class="line">        temp = trans_temp.tolist()</span><br><span class="line">        trans_P.append(temp)</span><br><span class="line"></span><br><span class="line">np_trans_P = np.array(trans_P) <span class="comment"># Transfer list into numpy</span></span><br><span class="line">av_trans_P = np.<span class="built_in">sum</span>(np_trans_P, <span class="number">0</span>)/np_trans_P.shape[<span class="number">0</span>] <span class="comment"># Calculate avarage</span></span><br><span class="line"></span><br><span class="line">Pred_results = [] <span class="comment"># Using average transfer matrix to predict energy structure</span></span><br><span class="line"><span class="keyword">for</span> predY <span class="keyword">in</span> <span class="built_in">range</span>(year_train_end, year_end):</span><br><span class="line">    <span class="comment"># Forecasting</span></span><br><span class="line">    Pred_temp = Markov_predict(data_stru = data_stru, P = av_trans_P, </span><br><span class="line">                            year_end = year_train_end - <span class="number">1</span>, year_pred = predY)</span><br><span class="line">    temp = Pred_temp.tolist() <span class="comment"># Turn numpy.array into list</span></span><br><span class="line">    Pred_results.append(temp) <span class="comment"># It&#x27;s convenient to append value using list</span></span><br><span class="line">    </span><br><span class="line">np_Pred_results = np.array(Pred_results) <span class="comment"># Turn list into np.array</span></span><br><span class="line">Columns = data_stru.columns</span><br><span class="line"><span class="comment"># Plot forecasting result if needed</span></span><br><span class="line"><span class="keyword">if</span> plot_b == <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        test_Y, pred_Y = test_data[:, i], np_Pred_results[:, i]</span><br><span class="line">        Title = <span class="string">&#x27;&#123;&#125; based on average transfer matrix to predict:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(regression, </span><br><span class="line">                                    Columns[i])</span><br><span class="line">        plot_result(test_Y, pred_Y, Title)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Storing error results</span></span><br><span class="line">title = <span class="string">&#x27;average transfer matrix&#x27;</span>  </span><br><span class="line"><span class="comment"># Calculate 4 error</span></span><br><span class="line">error = calculate_error(test_data, np_Pred_results, title)</span><br><span class="line">Error_results.append(error)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======== Model test based on datas from 1953 to 1999 ==================</span></span><br><span class="line"><span class="keyword">for</span> year_train_start <span class="keyword">in</span> [<span class="number">1953</span>, <span class="number">1998</span>]: <span class="comment"># from &#x27;1953 to 1999&#x27; or &#x27;1998 to 1999&#x27;</span></span><br><span class="line">    year_train_end, year_end = <span class="number">1999</span>, <span class="number">2018</span></span><br><span class="line">    trans_temp = Markov_trans(year_start = year_train_start, </span><br><span class="line">                            year_end = year_train_end, data_stru = data_stru)</span><br><span class="line">    Pred_results = []</span><br><span class="line">    <span class="keyword">for</span> predY <span class="keyword">in</span> <span class="built_in">range</span>(year_train_end, year_end):</span><br><span class="line">        Pred_temp = Markov_predict(data_stru = data_stru, P = trans_temp, </span><br><span class="line">                                year_end = year_train_end - <span class="number">1</span>, year_pred = predY)</span><br><span class="line">        temp = Pred_temp.tolist()</span><br><span class="line">        Pred_results.append(temp)</span><br><span class="line">        </span><br><span class="line">    np_Pred_results = np.array(Pred_results)</span><br><span class="line">    Columns = data_stru.columns</span><br><span class="line">    <span class="keyword">if</span> plot_b == <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            test_Y, pred_Y = test_data[:, i], np_Pred_results[:, i]</span><br><span class="line">            Title = <span class="string">&#x27;&#123;&#125; based on &#123;&#125; and &#123;&#125; to predict:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(regression, </span><br><span class="line">                                    year_train_start, year_train_end, Columns[i])             </span><br><span class="line">            plot_result(test_Y, pred_Y, Title)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Storing error results  </span></span><br><span class="line">    title = <span class="string">&#x27;&#123;&#125; step&#x27;</span>.<span class="built_in">format</span>(year_train_end - year_train_start)   </span><br><span class="line">    error = calculate_error(test_data, np_Pred_results, title)</span><br><span class="line">    Error_results.append(error)</span><br><span class="line"></span><br><span class="line">np_error = np.array(Error_results)</span><br><span class="line">columns = [<span class="string">&#x27;Transfer Matrix&#x27;</span>, <span class="string">&#x27;R2&#x27;</span>, <span class="string">&#x27;MAE&#x27;</span>, <span class="string">&#x27;MSE&#x27;</span>, <span class="string">&#x27;RMSE&#x27;</span>]</span><br><span class="line">pd_error = pd.DataFrame(np_error, columns = columns, dtype = <span class="string">&#x27;object&#x27;</span>)</span><br><span class="line">pd_error.to_excel(<span class="string">&#x27;Error result.xlsx&#x27;</span>, encoding = <span class="string">&#x27;utf_8_sig&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h1 id="traditional-models">2 Traditional models</h1>
<ul>
<li>Ridge</li>
<li>Lasso</li>
<li>PLS</li>
<li>MLP</li>
<li>Linear SVM</li>
<li>DecisionTree</li>
</ul>
<p>不同之处在于104 行开始的模型定义不同</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ========================= Import modules ====================================</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Ridge, Lasso</span><br><span class="line"><span class="keyword">from</span> sklearn.neural_network <span class="keyword">import</span> MLPRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.cross_decomposition <span class="keyword">import</span> PLSRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> LinearSVR</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeRegressor</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_absolute_error, r2_score</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error</span><br><span class="line"></span><br><span class="line"><span class="comment"># Plot module</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line"><span class="comment"># Microsoft YaHei, Times New Roman</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== Preparation =======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Read datafile</span></span><br><span class="line">data_stru = pd.read_excel(<span class="string">&#x27;./Data.xlsx&#x27;</span>, header = <span class="number">0</span>, </span><br><span class="line">                          sheet_name = <span class="number">0</span>, index_col= <span class="number">0</span>)</span><br><span class="line">data_stru = data_stru.dropna()</span><br><span class="line">dataset = data_stru.values</span><br><span class="line">dataset = dataset.astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Columns = data_stru.columns <span class="comment"># columns name</span></span><br><span class="line">num_year = <span class="built_in">len</span>(data_stru) <span class="comment"># the length of the dataset</span></span><br><span class="line">train_percent = <span class="number">0.70</span> <span class="comment"># Set the first 70% data as train set</span></span><br><span class="line">test_percent = <span class="number">1</span> - train_percent</span><br><span class="line">Error_results = [] <span class="comment"># Store all error results</span></span><br><span class="line">input_size = <span class="number">10</span> <span class="comment"># Feed the previous 10 years as the input</span></span><br><span class="line">num_features = <span class="number">4</span> <span class="comment"># 4 energy categories</span></span><br><span class="line">plot_b = <span class="literal">False</span> <span class="comment"># Choose whether plot result</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # Put NN calculating module into GPU if available</span></span><br><span class="line"><span class="comment"># device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Feed the previous 10 years as the input and the 11th year as prediction output</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_dataset</span>(<span class="params">dataset, look_back = input_size</span>):</span></span><br><span class="line">    dataX, dataY = [], []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dataset) - look_back):</span><br><span class="line">        a = dataset[i:(i + look_back)]</span><br><span class="line">        dataX.append(a)</span><br><span class="line">        dataY.append(dataset[i + look_back])</span><br><span class="line">    <span class="keyword">return</span> np.array(dataX), np.array(dataY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Input datasets and output datasets</span></span><br><span class="line">data_X, data_Y = create_dataset(dataset)</span><br><span class="line">ylim_min = np.<span class="built_in">round</span>(data_Y.<span class="built_in">min</span>()) - <span class="number">1</span></span><br><span class="line">ylim_max = np.<span class="built_in">round</span>(data_Y.<span class="built_in">max</span>()) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Divide training set and test set</span></span><br><span class="line">train_X, test_X, train_Y, test_Y = train_test_split(data_X, data_Y, </span><br><span class="line">        shuffle = <span class="literal">False</span>, test_size = test_percent) </span><br><span class="line"><span class="comment"># shuffle: don&#x27;t shuffle data</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== Plot Results =====================================</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_result</span>(<span class="params">test_Y, pred_Y, Title</span>):</span></span><br><span class="line">    ylim_min = np.<span class="built_in">round</span>(test_Y.<span class="built_in">min</span>()) - <span class="number">1</span></span><br><span class="line">    ylim_max = np.<span class="built_in">round</span>(test_Y.<span class="built_in">max</span>()) + <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># plot comparison results</span></span><br><span class="line">    fig = plt.figure(figsize = (<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line">    ax0 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">    ax0.scatter(test_Y, pred_Y)</span><br><span class="line">    ax0.plot([ylim_min, ylim_max], [ylim_min, ylim_max], <span class="string">&#x27;--k&#x27;</span>)</span><br><span class="line">    ax0.set_xlabel(<span class="string">&#x27;True Target&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">    ax0.set_ylabel(<span class="string">&#x27;Target predicted&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">    ax0.set_title(Title , fontsize = <span class="number">16</span>)</span><br><span class="line">    ax0.text(ylim_min + <span class="number">2</span>, ylim_max - <span class="number">4</span>, <span class="string">r&#x27;$R^2$ = %.2f, $MAE$ = %.2f&#x27;</span> %(r2_score(test_Y, pred_Y), </span><br><span class="line">                mean_absolute_error(test_Y, pred_Y)), fontsize = <span class="number">14</span>)</span><br><span class="line">    ax0.text(ylim_min + <span class="number">2</span>, ylim_max - <span class="number">5</span>, <span class="string">r&#x27;$MSE$ = %.2f, $RMSE$ = %.2f&#x27;</span> %(mean_squared_error(test_Y, pred_Y), </span><br><span class="line">                mean_squared_error(test_Y, pred_Y, squared=<span class="literal">False</span>)), fontsize = <span class="number">14</span>)</span><br><span class="line">    </span><br><span class="line">    ax0.set_xlim([ylim_min, ylim_max])</span><br><span class="line">    ax0.set_ylim([ylim_min, ylim_max])</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Plot prediction and real values</span></span><br><span class="line">    plt.figure(figsize = (<span class="number">8</span>, <span class="number">6</span>)) <span class="comment"># length x width</span></span><br><span class="line">    plt.plot(pred_Y, <span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;prediction&#x27;</span>, lw = <span class="number">0.8</span>)</span><br><span class="line">    plt.plot(test_Y, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;real&#x27;</span>, lw = <span class="number">0.8</span>)</span><br><span class="line">    plt.xticks(<span class="built_in">range</span>(<span class="number">19</span>), fontsize = <span class="number">15</span>)</span><br><span class="line">    plt.yticks(fontsize = <span class="number">15</span>)</span><br><span class="line">    plt.title(Title, fontsize = <span class="number">16</span>)</span><br><span class="line">    plt.legend(loc=<span class="string">&#x27;best&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate the loss: R2, MAE, MSE, RMSE</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_error</span>(<span class="params">test_data, np_Pred_results, title</span>):</span></span><br><span class="line">    <span class="comment"># Storing error results</span></span><br><span class="line">    R2 = <span class="built_in">float</span>(<span class="string">&#x27;&#123;:.5f&#125;&#x27;</span>.<span class="built_in">format</span>(r2_score(test_data, np_Pred_results)))</span><br><span class="line">    MAE = <span class="built_in">float</span>(<span class="string">&#x27;&#123;:.5f&#125;&#x27;</span>.<span class="built_in">format</span>(mean_absolute_error(test_data, np_Pred_results)))</span><br><span class="line">    MSE = <span class="built_in">float</span>(<span class="string">&#x27;&#123;:.5f&#125;&#x27;</span>.<span class="built_in">format</span>(mean_squared_error(test_data, np_Pred_results)))</span><br><span class="line">    RMSE =<span class="built_in">float</span>(<span class="string">&#x27;&#123;:.5f&#125;&#x27;</span>.<span class="built_in">format</span>( mean_squared_error(test_data, np_Pred_results, squared=<span class="literal">False</span>)))</span><br><span class="line">    error = [title, R2, MAE, MSE, RMSE]</span><br><span class="line">    <span class="keyword">return</span> error</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= Ridge Regression =============================</span></span><br><span class="line"><span class="comment"># Ridge model</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict_model</span>(<span class="params">model_train_X, model_train_Y</span>):</span></span><br><span class="line">    regr = Ridge()</span><br><span class="line">    regr.fit(model_train_X, model_train_Y)</span><br><span class="line">    model_pred_Y = regr.predict(model_test_X)</span><br><span class="line">    regression_name = <span class="string">&#x27;Ridge Regression&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> model_pred_Y, regression_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># # Lasso model</span></span><br><span class="line"><span class="comment"># def predict_model(model_train_X, model_train_Y):</span></span><br><span class="line"><span class="comment">#     regr = Lasso()</span></span><br><span class="line"><span class="comment">#     regr.fit(model_train_X, model_train_Y)</span></span><br><span class="line"><span class="comment">#     model_pred_Y = regr.predict(model_test_X)</span></span><br><span class="line"><span class="comment">#     regression_name = &#x27;Lasso Model&#x27;</span></span><br><span class="line"><span class="comment">#     return model_pred_Y, regression_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # PLS model</span></span><br><span class="line"><span class="comment"># def predict_model(model_train_X, model_train_Y):</span></span><br><span class="line"><span class="comment">#     regr = PLSRegression(n_components=1)</span></span><br><span class="line"><span class="comment">#     regr.fit(model_train_X, model_train_Y)</span></span><br><span class="line"><span class="comment">#     model_pred_Y = regr.predict(model_test_X)</span></span><br><span class="line"><span class="comment">#     regression_name = &#x27;PLS Regression&#x27;</span></span><br><span class="line"><span class="comment">#     return model_pred_Y, regression_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= MLP Regression =============================</span></span><br><span class="line"><span class="comment"># # MLP model</span></span><br><span class="line"><span class="comment"># def predict_model(model_train_X, model_train_Y):</span></span><br><span class="line"><span class="comment">#     regr = MLPRegressor(random_state = 1, max_iter = 500)</span></span><br><span class="line"><span class="comment">#     regr.fit(model_train_X, model_train_Y)</span></span><br><span class="line"><span class="comment">#     model_pred_Y = regr.predict(model_test_X)</span></span><br><span class="line"><span class="comment">#     regression_name = &#x27;MLP Regression&#x27;</span></span><br><span class="line"><span class="comment">#     return model_pred_Y, regression_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= Linear SVM regression =============================</span></span><br><span class="line"><span class="comment"># # SVC model</span></span><br><span class="line"><span class="comment"># def predict_model(model_train_X, model_train_Y):</span></span><br><span class="line"><span class="comment">#     regr = LinearSVR(random_state= 0, tol= 1e-5)</span></span><br><span class="line"><span class="comment">#     regr.fit(model_train_X, model_train_Y)</span></span><br><span class="line"><span class="comment">#     model_pred_Y = regr.predict(model_test_X)</span></span><br><span class="line"><span class="comment">#     regression_name = &#x27;Linear SVR Regression&#x27;</span></span><br><span class="line"><span class="comment">#     return model_pred_Y, regression_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ================= DecisionTree Regressor =============================</span></span><br><span class="line"><span class="comment"># # DecisionTree model</span></span><br><span class="line"><span class="comment"># def predict_model(model_train_X, model_train_Y):</span></span><br><span class="line"><span class="comment">#     regr = DecisionTreeRegressor(random_state=0)</span></span><br><span class="line"><span class="comment">#     regr.fit(model_train_X, model_train_Y)</span></span><br><span class="line"><span class="comment">#     model_pred_Y = regr.predict(model_test_X)</span></span><br><span class="line"><span class="comment">#     regression_name = &#x27;Decision-Tree Regression&#x27;</span></span><br><span class="line"><span class="comment">#     return model_pred_Y, regression_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Forecasting</span></span><br><span class="line">pred_result = [] <span class="comment"># to store prediction results</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">3</span>:</span><br><span class="line">        model_train_X = train_X[:, :, i].reshape(-<span class="number">1</span>, input_size)</span><br><span class="line">        model_test_X = test_X[:, :, i].reshape(-<span class="number">1</span>, input_size)</span><br><span class="line">        model_train_Y = train_Y[:, i].reshape(-<span class="number">1</span>)</span><br><span class="line">        model_test_Y = test_Y[:, i].reshape(-<span class="number">1</span>)</span><br><span class="line">        model_pred_Y, regression = predict_model(model_train_X = model_train_X,</span><br><span class="line">                    model_train_Y = model_train_Y)</span><br><span class="line">        pred_result.append(model_pred_Y.tolist())</span><br><span class="line">    <span class="keyword">elif</span> i == <span class="number">3</span>:</span><br><span class="line">        <span class="comment"># Calculate the last energy consumption percent</span></span><br><span class="line">        np_pred_result = np.array(pred_result).T</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(np_pred_result.shape) == <span class="number">3</span>: <span class="comment"># Model output is 3-dimension</span></span><br><span class="line">            model_pred_Y = <span class="number">100</span> - np_pred_result.<span class="built_in">sum</span>(<span class="number">2</span>).reshape(-<span class="number">1</span>, <span class="number">1</span>) <span class="comment"># PLS model</span></span><br><span class="line">            np_pred_result = np.concatenate((np_pred_result[<span class="number">0</span>], model_pred_Y), axis = <span class="number">1</span>) <span class="comment"># for PLS model</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(np_pred_result.shape) == <span class="number">2</span>: <span class="comment"># Model output is 2-dimension</span></span><br><span class="line">            model_pred_Y = <span class="number">100</span> - np_pred_result.<span class="built_in">sum</span>(<span class="number">1</span>).reshape(-<span class="number">1</span>, <span class="number">1</span>) <span class="comment"># Lasso model </span></span><br><span class="line">            np_pred_result = np.concatenate((np_pred_result, model_pred_Y), axis = <span class="number">1</span>) <span class="comment"># for Lasso model</span></span><br><span class="line">    Title = <span class="string">&#x27;Using &#123;&#125; to predict:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(regression, Columns[i])</span><br><span class="line">    <span class="keyword">if</span> plot_b == <span class="literal">True</span>:</span><br><span class="line">        plot_result(model_test_Y, model_pred_Y, Title) </span><br><span class="line">        </span><br><span class="line"><span class="comment"># Updata Error table</span></span><br><span class="line">error = calculate_error(test_Y, np_pred_result, regression)</span><br><span class="line">np_error = np.array(error).reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">columns = [<span class="string">&#x27;Transfer Matrix&#x27;</span>, <span class="string">&#x27;R2&#x27;</span>, <span class="string">&#x27;MAE&#x27;</span>, <span class="string">&#x27;MSE&#x27;</span>, <span class="string">&#x27;RMSE&#x27;</span>]</span><br><span class="line">pd_error = pd.DataFrame(np_error, columns = columns)</span><br><span class="line"></span><br><span class="line">error_excel =  pd.read_excel(<span class="string">&#x27;./Error result.xlsx&#x27;</span>, header = <span class="number">0</span>, sheet_name = <span class="number">0</span>, index_col= <span class="literal">None</span>)</span><br><span class="line">res = pd.concat([error_excel, pd_error], axis = <span class="number">0</span>, ignore_index = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Updata predict table</span></span><br><span class="line">model_col = []</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> Columns:</span><br><span class="line">    temp = <span class="string">&#x27;&#123;&#125;_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(c, regression.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">    model_col.append(temp)</span><br><span class="line">pd_pred_result = pd.DataFrame(np_pred_result, columns = model_col, index = <span class="built_in">range</span>(<span class="number">2001</span>, <span class="number">2018</span>))</span><br><span class="line">pred_excel =  pd.read_excel(<span class="string">&#x27;./Predict results.xlsx&#x27;</span>, header = <span class="number">0</span>, sheet_name = <span class="number">0</span>, index_col= <span class="number">0</span>)</span><br><span class="line">pred_res = pd.concat([pred_excel, pd_pred_result], axis = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Store updated data</span></span><br><span class="line">res.to_excel(<span class="string">&#x27;./Error result.xlsx&#x27;</span>, encoding = <span class="string">&#x27;utf_8_sig&#x27;</span>, header = <span class="literal">True</span>, index = <span class="literal">False</span>)</span><br><span class="line">pred_res.to_excel(<span class="string">&#x27;./Predict results.xlsx&#x27;</span>, encoding = <span class="string">&#x27;utf_8_sig&#x27;</span>,  header = <span class="literal">True</span>, index = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h1 id="linear-nn-model">3 Linear NN model</h1>
]]></content>
      <categories>
        <category>Class Notes</category>
        <category>Energy economics</category>
      </categories>
      <tags>
        <tag>Prediction</tag>
        <tag>Deep learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Ensemble-Blending</title>
    <url>/2021/05/11/Ensemble-Blending/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<p>Blending 方法可以看是一个简化版的 Stacking 方法，blend 的中文意思是 “混合”，这就很好地诠释了 Blending 方法的思想 —— 不同模型的混合，也就是集成的本意。该方法仅在验证集中进行预测，如下为 Blending 的步骤：</p>
<a id="more"></a>
<ol type="1">
<li>将数据划分为 train set 和 test set，其中，train set 需要进一步被细分为 Training set 和 validation set (见 Fig. 1 (i)，图片来源：<a href="https://courses.analyticsvidhya.com/courses/take/ensemble-learning-and-ensemble-learning-techniques/texts/11126029-blending">Analytics vidhya</a>)；</li>
<li>构建多个模型 （第一层），并使用细分后的 Training set 作为输入数据来训练这些模型，并用训练好的模型来预测 validation set 和 test set，得到 val_pred 和 test_pred；</li>
<li>再次构建模型（第二层），并将 val_pred 视为训练集来训练该层的模型(见 Fig. 1 (ii)；</li>
<li>用训练好的模型来对测试集 (test_pred) 进行预测，得到预测结果 test prediction 记为整个 Blending 集成学习的预测结果。</li>
</ol>
<img src="https://z3.ax1x.com/2021/05/11/gUN4RU.png" />
<center>
Fig.1 Bleding procedutre
</center>
<h1 id="sample">2. Sample</h1>
<h2 id="steps">2.1 Steps</h2>
<p>为了对 Blending 有进一步的了解，参考 Analytics vidhya, 构建了一个两层的 Blending 模型，其中第一层由决策树和 KNN 组成，对这两个模型用 Training set 进行预测，并用训练好的模型预测 Valitation set 和 test set。之后构建一个逻辑回归利用上述两个预测结果进行预测训练。具体步骤如下：</p>
<ul>
<li><p>Import Module</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> tree</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> make_blobs</span><br></pre></td></tr></table></figure></li>
<li><p>Creating Datasets</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data, target = make_blobs(n_samples = <span class="number">10000</span>, centers = <span class="number">2</span>,</span><br><span class="line">                    random_state = <span class="number">1</span>, cluster_std = <span class="number">1.0</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment"># Creatint test set and temporary train set, test_percent = 20%</span></span><br><span class="line">x_train1,x_test,y_train1,y_test = train_test_split(data,</span><br><span class="line">                  target, test_size = <span class="number">0.2</span>, random_state = <span class="number">1</span>)</span><br><span class="line"><span class="comment"># Spliting temporary train set into train set and validation set, validation_percent = 80%*30%</span></span><br><span class="line">x_train,x_val,y_train,y_val = train_test_split(X_train1,</span><br><span class="line">                  y_train1, test_size = <span class="number">0.3</span>, random_state = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;The shape of training X:&quot;</span>, x_train.shape)</span><br><span class="line">print(<span class="string">&quot;The shape of training y:&quot;</span>, y_train.shape)</span><br><span class="line">print(<span class="string">&quot;The shape of test set:&quot;</span>, x_test.shape)</span><br><span class="line">print(<span class="string">&quot;The shape of test y:&quot;</span>, y_test.shape)</span><br><span class="line">print(<span class="string">&quot;The shape of validation X:&quot;</span>, x_val.shape)</span><br><span class="line">print(<span class="string">&quot;The shape of validation y:&quot;</span>, y_val.shape)</span><br></pre></td></tr></table></figure>
<p>Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">The shape of training X: (<span class="number">5600</span>, <span class="number">2</span>)</span><br><span class="line">The shape of training y: (<span class="number">5600</span>,)</span><br><span class="line">The shape of test <span class="built_in">set</span>: (<span class="number">2000</span>, <span class="number">2</span>)</span><br><span class="line">The shape of test y: (<span class="number">2000</span>,)</span><br><span class="line">The shape of validation X: (<span class="number">2400</span>, <span class="number">2</span>)</span><br><span class="line">The shape of validation y: (<span class="number">2400</span>,)</span><br></pre></td></tr></table></figure></p></li>
<li><p>First Layer</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model1 = tree.DecisionTreeClassifier()</span><br><span class="line">model1.fit(x_train, y_train)</span><br><span class="line">val_pred1=model1.predict(x_val)</span><br><span class="line">test_pred1=model1.predict(x_test)</span><br><span class="line"></span><br><span class="line">val_pred1=pd.DataFrame(val_pred1)</span><br><span class="line">test_pred1=pd.DataFrame(test_pred1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model2 = KNeighborsClassifier()</span><br><span class="line">model2.fit(x_train,y_train)</span><br><span class="line">val_pred2=model2.predict(x_val)</span><br><span class="line">test_pred2=model2.predict(x_test)</span><br><span class="line"></span><br><span class="line">val_pred2=pd.DataFrame(val_pred2)</span><br><span class="line">test_pred2=pd.DataFrame(test_pred2)</span><br></pre></td></tr></table></figure></li>
<li><p>Second Layer</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df_val=pd.concat([pd.DataFrame(x_val), val_pred1, val_pred2],axis=<span class="number">1</span>)</span><br><span class="line">df_test=pd.concat([pd.DataFrame(x_test),test_pred1,test_pred2],axis=<span class="number">1</span>)</span><br><span class="line">model = LogisticRegression()</span><br><span class="line">model.fit(df_val,y_val)</span><br></pre></td></tr></table></figure></li>
<li><p>Forecasting Results</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model.score(df_test,y_test)</span><br><span class="line">cross_val_score(model,df_test,y_test,cv=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.0</span></span><br><span class="line">array([<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>])</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="complete-codes">2.2 Complete codes</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Inporting modules</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> tree</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> make_blobs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Creating datasets</span></span><br><span class="line">data, target = make_blobs(n_samples = <span class="number">10000</span>, centers = <span class="number">2</span>,</span><br><span class="line">                    random_state = <span class="number">1</span>, cluster_std = <span class="number">1.0</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment"># Creatint test set and temporary train set, test_percent = 20%</span></span><br><span class="line">x_train1,x_test,y_train1,y_test = train_test_split(data,</span><br><span class="line">                  target, test_size = <span class="number">0.2</span>, random_state = <span class="number">1</span>)</span><br><span class="line"><span class="comment"># Spliting temporary train set into train set and validation set, validation_percent = 80%*30%</span></span><br><span class="line">x_train,x_val,y_train,y_val = train_test_split(X_train1,</span><br><span class="line">                  y_train1, test_size = <span class="number">0.3</span>, random_state = <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Constructing model</span></span><br><span class="line"><span class="comment">## First layer</span></span><br><span class="line">model1 = tree.DecisionTreeClassifier()</span><br><span class="line">model1.fit(x_train, y_train)</span><br><span class="line">val_pred1=model1.predict(x_val)</span><br><span class="line">test_pred1=model1.predict(x_test)</span><br><span class="line"></span><br><span class="line">val_pred1=pd.DataFrame(val_pred1)</span><br><span class="line">test_pred1=pd.DataFrame(test_pred1)</span><br><span class="line"></span><br><span class="line">model2 = KNeighborsClassifier()</span><br><span class="line">model2.fit(x_train,y_train)</span><br><span class="line">val_pred2=model2.predict(x_val)</span><br><span class="line">test_pred2=model2.predict(x_test)</span><br><span class="line"></span><br><span class="line">val_pred2=pd.DataFrame(val_pred2)</span><br><span class="line">test_pred2=pd.DataFrame(test_pred2)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Second layer</span></span><br><span class="line">df_val=pd.concat([pd.DataFrame(x_val), val_pred1, val_pred2],axis=<span class="number">1</span>)</span><br><span class="line">df_test=pd.concat([pd.DataFrame(x_test),test_pred1,test_pred2],axis=<span class="number">1</span>)</span><br><span class="line">model = LogisticRegression()</span><br><span class="line">model.fit(df_val,y_val)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print forecasting results</span></span><br><span class="line">model.score(df_test,y_test)</span><br><span class="line">cross_val_score(model,df_test,y_test,cv=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Ensemble</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Ensemble</tag>
        <tag>Sklearn</tag>
      </tags>
  </entry>
  <entry>
    <title>Ensemble-happiness</title>
    <url>/2021/05/18/Ensemble-Happiness/</url>
    <content><![CDATA[<h1 id="problem">1. Problem</h1>
<h2 id="introduction-of-background">1.1 Introduction of background</h2>
<p>幸福感是一个古老而深刻的话题，是人类世代追求的方向。与幸福感相关的因素成千上万，这些错综复杂的因素中，我们能找到其中的共性，一窥幸福感的要义吗？</p>
<a id="more"></a>
<p>该案例为幸福感预测这一经典课题，希望在现有社会科学研究外有其他维度的算法尝试，结合多学科各自优势，挖掘潜在的影响因素，发现更多可解释、可理解的相关关系。</p>
<p>具体来说，该案例就是一个数据挖掘类型的比赛——幸福感预测的baseline。具体来说，我们需要使用包括个体变量（性别、年龄、地域、职业、健康、婚姻与政治面貌等等）、家庭变量（父母、配偶、子女、家庭资本等等）、社会态度（公平、信用、公共服务等等）等139维度的信息来预测其对幸福感的影响。</p>
<p>数据来源于国家官方的《中国综合社会调查（CGSS）》文件中的调查结果中的数据，数据来源可靠可依赖。</p>
<p>数据包下载地址: <a href="https://yangsuoly.com/file/Data-of-forcasting-happiness.rar">Data of case</a>。</p>
<h2 id="data-information">1.2 Data information</h2>
<p>要求使用以上 139 维的特征，使用 8000 余组数据进行对于个人幸福感的预测（预测值为1，2，3，4，5，其中1代表幸福感最低，5代 表幸福感最高）。 因为考虑到变量个数较多，部分变量间关系复杂，数据分为完整版和精简版两类。同时给出了 <code>index</code> 文件中包含每个变量对应的问卷题目，以及变量取值的含义；<code>survey</code> 文件中为原版问卷，作为补充以方便理解问题背景。</p>
<h1 id="data-process">2. Data process</h1>
<h2 id="load-data">2.1 Load data</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">train = pd.read_csv(<span class="string">&quot;train.csv&quot;</span>, parse_dates=[<span class="string">&#x27;survey_time&#x27;</span>],encoding=<span class="string">&#x27;latin-1&#x27;</span>)</span><br><span class="line">test = pd.read_csv(<span class="string">&quot;test.csv&quot;</span>, parse_dates=[<span class="string">&#x27;survey_time&#x27;</span>],encoding=<span class="string">&#x27;latin-1&#x27;</span>)</span><br><span class="line"><span class="comment">#latin-1向下兼容ASCII</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>Deleting the rows that happiness values equal to -8</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Deleting the rows that happiness values equal to -8</span></span><br><span class="line">target_name = <span class="string">&#x27;happiness&#x27;</span></span><br><span class="line">train_copy = train.copy()</span><br></pre></td></tr></table></figure></li>
<li><p>Train and target set</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train = train[train[target_name] != -<span class="number">8</span>].reset_index(drop = <span class="literal">True</span>)</span><br><span class="line">target = train_copy[target_name] <span class="comment"># Target</span></span><br></pre></td></tr></table></figure></li>
<li><p>Concatenation</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">del</span> train_copy[target_name] <span class="comment"># Drop the target column</span></span><br><span class="line"><span class="comment"># Store the train set(without happiness values)</span></span><br><span class="line"></span><br><span class="line">data = pd.concat([train_copy, test], axis = <span class="number">0</span>, ignore_index = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="information">2.2 Information</h2>
<ul>
<li><p><code>describe</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train.happiness.describe()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>count    7988.000000
mean        3.867927
std         0.818717
min         1.000000
25%         4.000000
50%         4.000000
75%         4.000000
max         5.000000
Name: happiness, dtype: float64</code></pre></li>
<li><p><code>info</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train.info()</span><br></pre></td></tr></table></figure>
<pre><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 8000 entries, 0 to 7999
Columns: 140 entries, id to public_service_9
dtypes: datetime64[ns](1), float64(25), int64(111), object(3)
memory usage: 8.5+ MB</code></pre></li>
</ul>
<h2 id="data-preparation">2.3 Data preparation</h2>
<h3 id="missing-values">2.3.1 Missing values</h3>
<ul>
<li><p>Number of columns having missing values</p>
<p>通过如下代码了解数据中的缺省值信息：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data_nomiss = data.dropna(axis=<span class="number">1</span>, inplace = <span class="literal">False</span>) <span class="comment"># 没有缺失值的数据信息</span></span><br><span class="line"></span><br><span class="line">name_data = data.columns</span><br><span class="line">name_miss = name_data.drop(data_nomiss.columns) <span class="comment"># 含有缺失值的列名称</span></span><br><span class="line"></span><br><span class="line">data_miss = data.loc[:, name_miss] <span class="comment"># 存储含有缺失值的数据，方便查看数据</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data_miss.shape</span><br><span class="line"></span><br><span class="line">(<span class="number">10968</span>, <span class="number">25</span>)</span><br></pre></td></tr></table></figure>
<p>可以发现，数据集中 25 列中含有缺失值，具体的列名称如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>miss_name</span><br><span class="line"></span><br><span class="line">Index([<span class="string">&#x27;edu_other&#x27;</span>, <span class="string">&#x27;edu_status&#x27;</span>, <span class="string">&#x27;edu_yr&#x27;</span>, <span class="string">&#x27;join_party&#x27;</span>, <span class="string">&#x27;property_other&#x27;</span>, <span class="string">&#x27;hukou_loc&#x27;</span>, <span class="string">&#x27;social_neighbor&#x27;</span>, <span class="string">&#x27;social_friend&#x27;</span>, <span class="string">&#x27;work_status&#x27;</span>, <span class="string">&#x27;work_yr&#x27;</span>, <span class="string">&#x27;work_type&#x27;</span>, <span class="string">&#x27;work_manage&#x27;</span>, <span class="string">&#x27;family_income&#x27;</span>, <span class="string">&#x27;invest_other&#x27;</span>, <span class="string">&#x27;minor_child&#x27;</span>, <span class="string">&#x27;marital_1st&#x27;</span>, <span class="string">&#x27;s_birth&#x27;</span>, <span class="string">&#x27;marital_now&#x27;</span>, <span class="string">&#x27;s_edu&#x27;</span>, <span class="string">&#x27;s_political&#x27;</span>, <span class="string">&#x27;s_hukou&#x27;</span>, <span class="string">&#x27;s_income&#x27;</span>, <span class="string">&#x27;s_work_exper&#x27;</span>, <span class="string">&#x27;s_work_status&#x27;</span>, <span class="string">&#x27;s_work_type&#x27;</span>], dtype=<span class="string">&#x27;object&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Processing</p>
<p>进一步查看缺失数据的信息：</p>
<pre><code>&gt;&gt;&gt; data_miss.info()

&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 10968 entries, 0 to 10967
Data columns (total 25 columns):
 #   Column           Non-Null Count  Dtype  
---  ------           --------------  -----  
 0   edu_other        6 non-null      object
 1   edu_status       9399 non-null   float64
 2   edu_yr           8212 non-null   float64
 3   join_party       1126 non-null   float64
 4   property_other   89 non-null     object
 5   hukou_loc        10964 non-null  float64
 6   social_neighbor  9871 non-null   float64
 7   social_friend    9871 non-null   float64
 8   work_status      4029 non-null   float64
 9   work_yr          4029 non-null   float64
 10  work_type        4030 non-null   float64
 11  work_manage      4030 non-null   float64
 12  family_income    10967 non-null  float64
 13  invest_other     45 non-null     object
 14  minor_child      9520 non-null   float64
 15  marital_1st      9839 non-null   float64
 16  s_birth          8601 non-null   float64
 17  marital_now      8521 non-null   float64
 18  s_edu            8601 non-null   float64
 19  s_political      8601 non-null   float64
 20  s_hukou          8601 non-null   float64
 21  s_income         8601 non-null   float64
 22  s_work_exper     8601 non-null   float64
 23  s_work_status    3524 non-null   float64
 24  s_work_type      3524 non-null   float64
dtypes: float64(22), object(3)
memory usage: 2.1+ MB</code></pre>
<p>可以发现，<code>edu_other</code>, <code>join_party</code>, <code>property_other</code>, <code>invest_other</code>, 四列含有缺失值较多，占到了样本总体的90%以上，综合考虑后，选择将这四个变量从分析中剔除。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">name_del = [<span class="string">&#x27;edu_other&#x27;</span>, <span class="string">&#x27;join_party&#x27;</span>, <span class="string">&#x27;property_other&#x27;</span>, <span class="string">&#x27;invest_other&#x27;</span>]</span><br><span class="line">name_data = name_data.drop(name_del)</span><br><span class="line">name_miss = name_miss.drop(name_del) <span class="comment"># 剔除上述四个变量</span></span><br><span class="line"></span><br><span class="line">data_miss = data_miss.loc[:, name_miss]</span><br><span class="line">data = data.copy().loc[:, name_miss]</span><br></pre></td></tr></table></figure></li>
<li><p>Information</p>
<p>查看每列缺失值的数量：</p>
<pre><code>&gt;&gt;&gt; data_miss.isnull().sum()

edu_status         0
edu_yr             0
hukou_loc          0
social_neighbor    0
social_friend      0
work_status        0
work_yr            0
work_type          0
work_manage        0
family_income      0
minor_child        0
marital_1st        0
s_birth            0
marital_now        0
s_edu              0
s_political        0
s_hukou            0
s_income           0
s_work_exper       0
s_work_status      0
s_work_type        0
dtype: int64</code></pre></li>
<li><p>Fillna</p>
<p>可以发现，部分列缺失值比较多，部分缺失值较少，为此，我们对缺失值做如下处理：</p>
<ul>
<li>缺失值数量少于总数的 20% (即 2193.6)的列，用该列的众数进行填充；</li>
<li>缺失值数量大于2193的列，用0进行填充，防止过分干预数据而导致失真。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_miss)):</span><br><span class="line">    num_nulls = data_miss.isnull().<span class="built_in">sum</span>() <span class="comment"># 对缺失值进行计数</span></span><br><span class="line">    num_null = num_nulls[i] <span class="comment"># 当前列的缺失值数</span></span><br><span class="line">    name = name_miss[i] <span class="comment"># 当前列的名称</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> num_null &lt; <span class="number">0.2</span>*data.shape[<span class="number">0</span>]:</span><br><span class="line">        data.loc[:, name].fillna(data_miss.mode().loc[<span class="number">0</span>, name], inplace = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data.loc[:, name].fillna(<span class="number">0</span>, inplace = <span class="literal">True</span>)                    </span><br><span class="line">data_miss = data.loc[:, name_miss]</span><br></pre></td></tr></table></figure></li>
</ul>
<p>至此，缺失值处理完成。</p>
<h3 id="negative-values">2.3.2 Negative values</h3>
<p>对数据中的连续出现的负的数值进行处理。由于数据中的负值只有 -1, -2, -3, -8，故进行如下处理：</p>
<ul>
<li><p>Self definition function</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># make feature +5</span></span><br><span class="line"><span class="comment">#csv中有复数值：-1、-2、-3、-8，将他们视为有问题的特征，但是不删去</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getres1</span>(<span class="params">row</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>([x <span class="keyword">for</span> x <span class="keyword">in</span> row.values <span class="keyword">if</span> <span class="built_in">type</span>(x)==<span class="built_in">int</span> <span class="keyword">and</span> x&lt;<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getres2</span>(<span class="params">row</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>([x <span class="keyword">for</span> x <span class="keyword">in</span> row.values <span class="keyword">if</span> <span class="built_in">type</span>(x)==<span class="built_in">int</span> <span class="keyword">and</span> x==-<span class="number">8</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getres3</span>(<span class="params">row</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>([x <span class="keyword">for</span> x <span class="keyword">in</span> row.values <span class="keyword">if</span> <span class="built_in">type</span>(x)==<span class="built_in">int</span> <span class="keyword">and</span> x==-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getres4</span>(<span class="params">row</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>([x <span class="keyword">for</span> x <span class="keyword">in</span> row.values <span class="keyword">if</span> <span class="built_in">type</span>(x)==<span class="built_in">int</span> <span class="keyword">and</span> x==-<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getres5</span>(<span class="params">row</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>([x <span class="keyword">for</span> x <span class="keyword">in</span> row.values <span class="keyword">if</span> <span class="built_in">type</span>(x)==<span class="built_in">int</span> <span class="keyword">and</span> x==-<span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#检查数据</span></span><br><span class="line">data[<span class="string">&#x27;neg1&#x27;</span>] = data[data.columns].apply(<span class="keyword">lambda</span> row:getres1(row),axis=<span class="number">1</span>)</span><br><span class="line">data.loc[data[<span class="string">&#x27;neg1&#x27;</span>]&gt;<span class="number">20</span>,<span class="string">&#x27;neg1&#x27;</span>] = <span class="number">20</span> <span class="comment">#平滑处理,最多出现20次</span></span><br><span class="line">data[<span class="string">&#x27;neg2&#x27;</span>] = data[data.columns].apply(<span class="keyword">lambda</span> row:getres2(row),axis=<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;neg3&#x27;</span>] = data[data.columns].apply(<span class="keyword">lambda</span> row:getres3(row),axis=<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;neg4&#x27;</span>] = data[data.columns].apply(<span class="keyword">lambda</span> row:getres4(row),axis=<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;neg5&#x27;</span>] = data[data.columns].apply(<span class="keyword">lambda</span> row:getres5(row),axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Process</p>
<p>记录下含有负值的列名称，然后对比 index.csv 中的信息对这些负值进行填充性处理。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先将问卷时间变为年份</span></span><br><span class="line">data[<span class="string">&#x27;survey_time&#x27;</span>] = pd.to_datetime(data[<span class="string">&#x27;survey_time&#x27;</span>], <span class="built_in">format</span> = <span class="string">&#x27;%Y-%m-%d&#x27;</span>,</span><br><span class="line">                                errors = <span class="string">&#x27;coerce&#x27;</span>) <span class="comment"># 强制转换</span></span><br><span class="line">data[<span class="string">&#x27;survey_time&#x27;</span>] = data[<span class="string">&#x27;survey_time&#x27;</span>].dt.year <span class="comment"># 截取年份，用于计算年龄</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有含有负值的列</span></span><br><span class="line">neg_name = data.<span class="built_in">min</span>()[data.<span class="built_in">min</span>()&lt;<span class="number">0</span>].index <span class="comment"># 存储 data 中最小的值小于 0 的列名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 借助 index.csv 查看缺失值的信息</span></span><br><span class="line">data_index = pd.read_csv(<span class="string">&quot;index.csv&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">data_index.set_index(<span class="string">&#x27;变量名&#x27;</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">data_index_column = data_index.columns</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;There are &#123;&#125; columns have negative values&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(neg_name)))</span><br></pre></td></tr></table></figure>
<pre><code>There are 100 columns have negative values</code></pre>
<p>可以到整个数据表中有 <code>100</code> 列中含有负值。</p></li>
<li><p>查看字段详细信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data_index.loc[neg_name, data_index_column[<span class="number">1</span>:<span class="number">3</span>]].head()</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>问题</p>
</th>
<th>
<p>取值含义</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>nationality</p>
</th>
<td>
<p>您的民族</p>
</td>
<td>
<p>1 = 汉; 2 = 蒙; 3 = 满; 4 = 回; 5 = 藏; 6 = 壮; 7 = ...</p>
</td>
</tr>
<tr>
<th>
<p>religion</p>
</th>
<td>
<p>您的宗教信仰-不信仰宗教</p>
</td>
<td>
<p>0 = 否; 1 = 是;</p>
</td>
</tr>
<tr>
<th>
<p>religion_freq</p>
</th>
<td>
<p>您参加宗教活动的频繁程度</p>
</td>
<td>
<p>1 = 从来没有参加过; 2 = 一年不到1次; 3 = 一年大概1到2次; 4 = 一年几...</p>
</td>
</tr>
<tr>
<th>
<p>edu</p>
</th>
<td>
<p>您目前的最高教育程度（包括目前在读的）</p>
</td>
<td>
<p>1 = 没有受过任何教育; 2 = 私塾、扫盲班; 3 = 小学; 4 = 初中; 5 = ...</p>
</td>
</tr>
<tr>
<th>
<p>edu_status</p>
</th>
<td>
<p>您目前的最高教育程度的状态</p>
</td>
<td>
<p>1 = 正在读; 2 = 辍学和中途退学; 3 = 肄业; 4 = 毕业;</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>填充</p>
<p>根据实际情况，对数据进行填充处理，填充分为如下几种方式：</p>
<ul>
<li>根据生活常识进行填充</li>
<li>根据非负数中的众数进行填充</li>
<li>根据非负数中的均值进行填充</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> neg_name:</span><br><span class="line">    <span class="keyword">if</span>(data[col].loc[data[col]&lt;<span class="number">0</span>].count()&gt;<span class="number">1000</span>):</span><br><span class="line">        print(col, data[col].loc[data[col]&lt;<span class="number">0</span>].count(), sep = <span class="string">&#x27; | &#x27;</span>)</span><br></pre></td></tr></table></figure>
<pre><code>edu_yr | 1679
marital_1st | 1901
f_birth | 4664
m_birth | 4448
inc_ability | 1325
inc_exp | 1501
trust_3 | 1399
trust_4 | 1413
trust_6 | 1562
trust_8 | 1381
trust_10 | 2451
trust_11 | 5456
trust_12 | 3382</code></pre>
<p>通过上述预处理，可以发现，仅有 5列数据中的负值多余2000</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ===================== 生活常识 ========================</span></span><br><span class="line"><span class="comment"># 民族</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;nationality&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;nationality&#x27;</span>] = <span class="number">1</span> <span class="comment"># 1为汉族</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 宗教</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;religion&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;religion&#x27;</span>] = <span class="number">1</span> <span class="comment"># 1为不信仰宗教</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;religion_freq&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;religion_freq&#x27;</span>] = <span class="number">1</span> <span class="comment"># 1为从来没参加过宗教活动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================= 众数 ============================</span></span><br><span class="line"><span class="comment"># 教育</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;edu&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;edu&#x27;</span>] = data[<span class="string">&#x27;edu&#x27;</span>].mode()[<span class="number">0</span>]  <span class="comment"># 众数为 4，初中</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;edu_status&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;edu_status&#x27;</span>] = data[<span class="string">&#x27;edu_status&#x27;</span>].mode()[<span class="number">0</span>] <span class="comment"># 众数为 4，毕业</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;edu_yr&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;edu_yr&#x27;</span>] = <span class="number">0</span> <span class="comment"># 毕业年份</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 政治面貌</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;political&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;political&#x27;</span>] = data[<span class="string">&#x27;political&#x27;</span>].mode()[<span class="number">0</span>] <span class="comment"># 众数为 1，群众</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 健康</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;health&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;health&#x27;</span>] = data[<span class="string">&#x27;health&#x27;</span>].mode()[<span class="number">0</span>] <span class="comment"># 众数为 4，比较健康</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;health_problem&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;health_problem&#x27;</span>] = data[<span class="string">&#x27;health_problem&#x27;</span>].mode()[<span class="number">0</span>] <span class="comment"># 众数为 4，比较健康</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 沮丧</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;depression&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;depression&#x27;</span>] = data[<span class="string">&#x27;depression&#x27;</span>].mode()[<span class="number">0</span>] <span class="comment"># 众数为 4，很少</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 媒体：报纸、杂志、广播、电视、互联网、手机定值消息</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    col = <span class="string">&#x27;media_&#x27;</span> + <span class="built_in">str</span>(i+<span class="number">1</span>)</span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[col].mode()[<span class="number">0</span>] <span class="comment"># 以众数填充</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">data.loc[data[&#x27;media_1&#x27;]&lt;0,&#x27;media_1&#x27;] = data[&#x27;media_1&#x27;].mode().values # 众数为1，从不</span></span><br><span class="line"><span class="string">data.loc[data[&#x27;media_2&#x27;]&lt;0,&#x27;media_2&#x27;] = data[&#x27;media_2&#x27;].mode().values # 众数为1，从不</span></span><br><span class="line"><span class="string">data.loc[data[&#x27;media_3&#x27;]&lt;0,&#x27;media_3&#x27;] = data[&#x27;media_3&#x27;].mode().values # 众数为1，从不</span></span><br><span class="line"><span class="string">data.loc[data[&#x27;media_4&#x27;]&lt;0,&#x27;media_4&#x27;] = data[&#x27;media_4&#x27;].mode().values # 众数为4，经常</span></span><br><span class="line"><span class="string">data.loc[data[&#x27;media_5&#x27;]&lt;0,&#x27;media_5&#x27;] = data[&#x27;media_5&#x27;].mode().values # 众数为1，从不</span></span><br><span class="line"><span class="string">data.loc[data[&#x27;media_6&#x27;]&lt;0,&#x27;media_6&#x27;] = data[&#x27;media_6&#x27;].mode().values # 众数为1，经常</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 空闲：看碟、看电影、逛街购物、读书、文化活动等共12项</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">    col = <span class="string">&#x27;leisure_&#x27;</span> + <span class="built_in">str</span>(i+<span class="number">1</span>)</span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[col].mode()[<span class="number">0</span>] <span class="comment"># 以众数填充</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">socialize、relax、learn、social_neighbor、learn、social_neighbor、</span></span><br><span class="line"><span class="string">social_friend、socia_outing、equity、class、class_10_before、</span></span><br><span class="line"><span class="string">class_10_after、class_14、work_status、work_yr、work_type、work_manage、</span></span><br><span class="line"><span class="string">insur_1、insur_2、insur_3、insur_4</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">29</span>, <span class="number">48</span>):</span><br><span class="line">    col = neg_name[i]</span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[col].mode()[<span class="number">0</span>] <span class="comment"># 以众数填充</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;socialize&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;socialize&#x27;</span>] = data[<span class="string">&#x27;socialize&#x27;</span>].mode()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 收入状态</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">49</span>, <span class="number">56</span>):</span><br><span class="line">    col = neg_name[i]</span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[col].mode()[<span class="number">0</span>] <span class="comment"># 以众数填充</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;socialize&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;socialize&#x27;</span>] = data[<span class="string">&#x27;socialize&#x27;</span>].mode()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">58</span>, <span class="number">64</span>):</span><br><span class="line">    col = neg_name[i]</span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[col].mode()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 信任</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">77</span>, <span class="number">100</span>):</span><br><span class="line">    col = neg_name[i]</span><br><span class="line">    <span class="comment"># 考虑到 trust 中包含较多负数，故考虑在大于零的数中取众数</span></span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[name].loc[data[name]&gt;<span class="number">0</span>].mode()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================= 均值 ==========================</span></span><br><span class="line"><span class="comment"># 收入</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;income&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;income&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>].mean() <span class="comment"># 取均值填充收入</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 家庭收入：49列</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;family_income&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;family_income&#x27;</span>] = data[<span class="string">&#x27;family_income&#x27;</span>].mean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预期收入：76</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;inc_exp&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;inc_exp&#x27;</span>] = data[<span class="string">&#x27;inc_exp&#x27;</span>].mean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== 0 填充 ===========================</span></span><br><span class="line"><span class="comment"># 婚姻：56-57</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;marital_1st&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;marital_1st&#x27;</span>] = <span class="number">0</span> <span class="comment"># 首次结婚</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;marital_now&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;marital_now&#x27;</span>] = <span class="number">0</span> <span class="comment"># 现在</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 父亲：64</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;f_birth&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;f_birth&#x27;</span>] = <span class="number">0</span> <span class="comment"># 出生年份</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65</span>, <span class="number">68</span>):</span><br><span class="line">    col = neg_name[i]</span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[col].mode()[<span class="number">0</span>]<span class="comment"># 众数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 母亲：68</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;m_birth&#x27;</span>]&lt;<span class="number">0</span>,<span class="string">&#x27;m_birth&#x27;</span>] = <span class="number">0</span> <span class="comment"># 出生年份</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">69</span>, <span class="number">76</span>):</span><br><span class="line">    col = neg_name[i]</span><br><span class="line">    data.loc[data[col]&lt;<span class="number">0</span>,col] = data[col].mode()[<span class="number">0</span>] <span class="comment"># 众数</span></span><br></pre></td></tr></table></figure></li>
<li><p>确认负值处理完成</p>
<p>对所有的列进行查看，确认是否所有的列中的负值都已处理完成。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">neg_count = <span class="built_in">len</span>(data.<span class="built_in">min</span>()[data.<span class="built_in">min</span>()&lt;<span class="number">0</span>].index) <span class="comment"># 记录负值列的个数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> neg_count != <span class="number">0</span>:</span><br><span class="line">    print(<span class="string">&#x27;&#123;&#125; columns still have Negative values!&#x27;</span>.<span class="built_in">format</span>(neg_count))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&#x27;Congratulations! No columns have negative values!&#x27;</span>)</span><br></pre></td></tr></table></figure>
<pre><code>Congratulations! No columns have negative values!</code></pre></li>
</ul>
<p>可以发现所有的负值都已处理完成。</p>
<h3 id="special-infromation-process">Special infromation process</h3>
<ul>
<li><p>Age strafitication</p>
<p>考虑到年龄对于收入水平、教育水平等都有重要的影响，因此，根据表格信息<code>survey_time</code> 和 <code>birth</code> 两列的信息计算年龄，并对年龄进行分段。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Calculate age</span></span><br><span class="line">data[<span class="string">&#x27;age&#x27;</span>] = data[<span class="string">&#x27;survey_time&#x27;</span>] - data[<span class="string">&#x27;birth&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Age strafitication</span></span><br><span class="line">bins = [<span class="number">0</span>, <span class="number">17</span>, <span class="number">26</span>, <span class="number">34</span>, <span class="number">50</span>, <span class="number">63</span>, <span class="number">100</span>]</span><br><span class="line">data[<span class="string">&#x27;age_bin&#x27;</span>] = pd.cut(data[<span class="string">&#x27;age&#x27;</span>], bins, labels = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]) <span class="comment"># 分层</span></span><br></pre></td></tr></table></figure></li>
<li><p>Data augmentation</p>
<p>为了挖掘更多信息，我们需要进一步分析每个特征之间的关系，进行数据增广。经过仔细分析，加入了如下特征：</p>
<ul>
<li>第一次结婚年龄</li>
<li>最近结婚年龄</li>
<li>是否再婚</li>
<li>配偶年龄</li>
<li>配偶年龄差</li>
<li>各种收入比（与配偶之间的收入比、十年后预期收入与现在的收入比等）</li>
<li>收入与住房买诺记比（包括10年后期望收入等）</li>
<li>社会阶级（10年后的社会阶级、14年后的社会阶级等）</li>
<li>悠闲指数</li>
<li>满意指数</li>
<li>信任指数</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 第一次结婚年龄 143</span></span><br><span class="line">new_col = <span class="string">&#x27;marital_1stbir&#x27;</span></span><br><span class="line">data[new_col] = data[<span class="string">&#x27;marital_1st&#x27;</span>] - data[<span class="string">&#x27;birth&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最近结婚年龄 144</span></span><br><span class="line">new_col = <span class="string">&#x27;marital_nowtbir&#x27;</span></span><br><span class="line">data[new_col] = data[<span class="string">&#x27;marital_now&#x27;</span>] - data[<span class="string">&#x27;birth&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否再婚 145</span></span><br><span class="line">new_col = <span class="string">&#x27;mar&#x27;</span></span><br><span class="line">data[new_col] = data[<span class="string">&#x27;marital_nowtbir&#x27;</span>] - data[<span class="string">&#x27;marital_1stbir&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配偶年龄 146</span></span><br><span class="line">new_col = <span class="string">&#x27;marital_sbir&#x27;</span></span><br><span class="line">data[new_col] = data[<span class="string">&#x27;marital_now&#x27;</span>]-data[<span class="string">&#x27;s_birth&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配偶年龄差 147</span></span><br><span class="line">new_col = <span class="string">&#x27;age__&#x27;</span></span><br><span class="line">data[new_col] = data[<span class="string">&#x27;marital_nowtbir&#x27;</span>] - data[<span class="string">&#x27;marital_sbir&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 收入比 147+7 = 154</span></span><br><span class="line">data[<span class="string">&#x27;income/s_income&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>]/(data[<span class="string">&#x27;s_income&#x27;</span>]+<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;income+s_income&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>]+(data[<span class="string">&#x27;s_income&#x27;</span>]+<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;income/family_income&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>]/(data[<span class="string">&#x27;family_income&#x27;</span>]+<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;all_income/family_income&#x27;</span>] = (data[<span class="string">&#x27;income&#x27;</span>]+data[<span class="string">&#x27;s_income&#x27;</span>])/(data[<span class="string">&#x27;family_income&#x27;</span>]+<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;income/inc_exp&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>]/(data[<span class="string">&#x27;inc_exp&#x27;</span>]+<span class="number">1</span>)</span><br><span class="line">data[<span class="string">&#x27;family_income/m&#x27;</span>] = data[<span class="string">&#x27;family_income&#x27;</span>]/(data[<span class="string">&#x27;family_m&#x27;</span>]+<span class="number">0.01</span>)</span><br><span class="line">data[<span class="string">&#x27;income/m&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>]/(data[<span class="string">&#x27;family_m&#x27;</span>]+<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 收入/面积比 154+4=158</span></span><br><span class="line">data[<span class="string">&#x27;income/floor_area&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>]/(data[<span class="string">&#x27;floor_area&#x27;</span>]+<span class="number">0.01</span>)</span><br><span class="line">data[<span class="string">&#x27;all_income/floor_area&#x27;</span>] = (data[<span class="string">&#x27;income&#x27;</span>]+data[<span class="string">&#x27;s_income&#x27;</span>])/(data[<span class="string">&#x27;floor_area&#x27;</span>]+<span class="number">0.01</span>)</span><br><span class="line">data[<span class="string">&#x27;family_income/floor_area&#x27;</span>] = data[<span class="string">&#x27;family_income&#x27;</span>]/(data[<span class="string">&#x27;floor_area&#x27;</span>]+<span class="number">0.01</span>)</span><br><span class="line">data[<span class="string">&#x27;floor_area/m&#x27;</span>] = data[<span class="string">&#x27;floor_area&#x27;</span>]/(data[<span class="string">&#x27;family_m&#x27;</span>]+<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># class 158+3=161</span></span><br><span class="line">data[<span class="string">&#x27;class_10_diff&#x27;</span>] = (data[<span class="string">&#x27;class_10_after&#x27;</span>] - data[<span class="string">&#x27;class&#x27;</span>])</span><br><span class="line">data[<span class="string">&#x27;class_diff&#x27;</span>] = data[<span class="string">&#x27;class&#x27;</span>] - data[<span class="string">&#x27;class_10_before&#x27;</span>]</span><br><span class="line">data[<span class="string">&#x27;class_14_diff&#x27;</span>] = data[<span class="string">&#x27;class&#x27;</span>] - data[<span class="string">&#x27;class_14&#x27;</span>]</span><br><span class="line"><span class="comment"># 悠闲指数 162</span></span><br><span class="line">leisure_fea_lis = [<span class="string">&#x27;leisure_&#x27;</span>+<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">13</span>)]</span><br><span class="line">data[<span class="string">&#x27;leisure_sum&#x27;</span>] = data[leisure_fea_lis].<span class="built_in">sum</span>(axis=<span class="number">1</span>) <span class="comment">#skew</span></span><br><span class="line"><span class="comment"># 满意指数 163</span></span><br><span class="line">public_service_fea_lis = [<span class="string">&#x27;public_service_&#x27;</span>+<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>)]</span><br><span class="line">data[<span class="string">&#x27;public_service_sum&#x27;</span>] = data[public_service_fea_lis].<span class="built_in">sum</span>(axis=<span class="number">1</span>) <span class="comment">#skew</span></span><br><span class="line"><span class="comment"># 信任指数 164</span></span><br><span class="line">trust_fea_lis = [<span class="string">&#x27;trust_&#x27;</span>+<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">14</span>)]</span><br><span class="line">data[<span class="string">&#x27;trust_sum&#x27;</span>] = data[trust_fea_lis].<span class="built_in">sum</span>(axis=<span class="number">1</span>) <span class="comment">#skew</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># province mean 164+13=177</span></span><br><span class="line">data[<span class="string">&#x27;province_income_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;income&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_family_income_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;family_income&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_equity_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;equity&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_depression_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;depression&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_floor_area_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;floor_area&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_health_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;health&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_class_10_diff_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;class_10_diff&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_class_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;class&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_health_problem_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;health_problem&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_family_status_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;family_status&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_leisure_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;leisure_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_public_service_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])</span><br><span class="line">[<span class="string">&#x27;public_service_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;province_trust_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;province&#x27;</span>])[<span class="string">&#x27;trust_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line"></span><br><span class="line"><span class="comment"># city mean 177+13=190</span></span><br><span class="line">data[<span class="string">&#x27;city_income_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;income&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_family_income_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;family_income&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_equity_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;equity&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_depression_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;depression&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_floor_area_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;floor_area&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_health_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;health&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_class_10_diff_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;class_10_diff&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_class_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;class&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_health_problem_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;health_problem&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_family_status_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;family_status&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_leisure_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;leisure_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_public_service_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;public_service_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;city_trust_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;city&#x27;</span>])[<span class="string">&#x27;trust_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line"></span><br><span class="line"><span class="comment"># county mean 190 + 13 = 203</span></span><br><span class="line">data[<span class="string">&#x27;county_income_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;income&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_family_income_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;family_income&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_equity_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;equity&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_depression_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;depression&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_floor_area_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;floor_area&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_health_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;health&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_class_10_diff_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;class_10_diff&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_class_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;class&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_health_problem_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;health_problem&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_family_status_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;family_status&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_leisure_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;leisure_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_public_service_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])</span><br><span class="line">[<span class="string">&#x27;public_service_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line">data[<span class="string">&#x27;county_trust_sum_mean&#x27;</span>] = data.groupby([<span class="string">&#x27;county&#x27;</span>])[<span class="string">&#x27;trust_sum&#x27;</span>].transform(<span class="string">&#x27;mean&#x27;</span>).values</span><br><span class="line"></span><br><span class="line"><span class="comment"># ratio 相比同省 203 + 13 =216</span></span><br><span class="line">data[<span class="string">&#x27;income/province&#x27;</span>] = data[<span class="string">&#x27;income&#x27;</span>]/(data[<span class="string">&#x27;province_income_mean&#x27;</span>])</span><br><span class="line">data[<span class="string">&#x27;family_income/province&#x27;</span>] = data[<span class="string">&#x27;family_income&#x27;</span>]/(data[<span class="string">&#x27;province_family_income_mean&#x27;</span>])</span><br><span class="line">data[<span class="string">&#x27;equity/province&#x27;</span>] = data[<span class="string">&#x27;equity&#x27;</span>]/(data[<span class="string">&#x27;province_equity_mean&#x27;</span>])</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Ensemble</category>
        <category>Cases</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Ensemble</tag>
        <tag>Sklearn</tag>
      </tags>
  </entry>
  <entry>
    <title>Ensemble-Stacking</title>
    <url>/2021/05/13/Ensemble-Stacking/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<p>Blending 集成方法的学习过程中，可以发现 Blending 在集成过程中只使用到了验证集的数据，这就造成了很大的浪费。因此可以靠用使用 Stacking 集成方法进行改进。</p>
<a id="more"></a>
<p>Blending 产生验证集的方式是使用分割的方式，产生一组训练集和验证集，那么是否可以将这种方式改进为交叉验证的方式呢？于是就有了如下的 Stacking 集成方法，其步骤如下：</p>
<ol type="1">
<li>记初始训练集为 <code>Train set</code>，测试集为 <code>Test set</code>，shape 分别为 <code>(train_size, 1)</code> 和 <code>(test_size, 1)</code>。 将 <code>Train set</code> 划分为多个部分（如 10 个），如下图 (Source: <a href="https://courses.analyticsvidhya.com/courses/take/ensemble-learning-and-ensemble-learning-techniques/texts/11125921-stacking">Analytics Vidhya</a>)；</li>
</ol>
<p><img src="https://z3.ax1x.com/2021/05/13/g0zJv4.png" /></p>
<ol start="2" type="1">
<li>用划分后的的 9/10 作为训练集 (<code>train_set</code>) 训练基准模型 (如决策树)，并用训练好的模型对剩下的 1/10 数据 (验证集, <code>val_set</code>) 和测试集 (<code>Test_set</code>) 来预测数据；</li>
<li>重复迭代训练 10 次直到所有数据都作为 <code>val_set</code>，并将 <code>val_set</code> 的 10 份预测的数据拼接为一个 shape 为 (<code>train_size</code>, 1) 的矩阵 (记为 <code>Trainset</code>)。</li>
<li>对迭代过程中得到的 10 份测试集 (<code>Test set</code>) 的预测数据取加权平均，得到一个shape 为 (<code>test_size</code>, 1)的矩阵。</li>
<li>重复步骤 2-4 训练其他基准模型 (如 knn) : <img src="https://z3.ax1x.com/2021/05/13/g0ztKJ.png" /></li>
<li>将上述训练得到的一系列 Trainset 串联，得到一个形状为 <code>(train_size, num_features)</code> 的矩阵，并用该矩阵训练第二层的模型，然后用训练好的新模型来做测试集的预测，并作为最终预测结果。</li>
</ol>
<p>下面借助实例来体验 Stacking 的魅力（参考案例：<a href="https://www.cnblogs.com/Christina-Notebook/p/10063146.html">cnblogs</a>）： 注：<code>sklearn</code> 模块并没有 <code>Stacking</code> 的方法，因此需要使用 <code>mlxtend</code> 工具包。</p>
<h1 id="a-example-of-stacking-model">2. A example of stacking model</h1>
<h2 id="data-process">2.1 Data process</h2>
<ul>
<li><p>Import modules <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNB</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> mlxtend.classifier <span class="keyword">import</span> StackingCVClassifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score <span class="keyword">as</span> ac</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line">%matplotlib inline</span><br></pre></td></tr></table></figure></p></li>
<li><p>Load data 本案例使用了 <code>Kaggle</code> 比赛中的一份泰坦尼克号乘客的数据来进行处理，下载链接：<a href="https://yangsuoly.com/file/titanic-data.csv">Titanic-data.csv</a> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = pd.read_csv(<span class="string">&#x27;./titanic-data.csv&#x27;</span>)</span><br></pre></td></tr></table></figure> <strong>Information</strong>:</p>
<ul>
<li>PassengerId：乘客ID</li>
<li>Survived：是否获救，用1和Rescued表示获救,用0或者not saved表示没有获救</li>
<li>Pclass：乘客等级，“1”表示Upper，“2”表示Middle，“3”表示Lower</li>
<li>Name：乘客姓名</li>
<li>Sex：性别</li>
<li>Age：年龄</li>
<li>SibSp：乘客在船上的配偶数量或兄弟姐妹数量）</li>
<li>Parch：乘客在船上的父母或子女数量</li>
<li>Ticket：船票信息</li>
<li>Fare：票价</li>
<li>Cabin：是否住在独立的房间，“1”表示是，“0”为否</li>
<li>embarked：表示乘客上船的码头距离泰坦尼克出发码头的距离，数值越大表示距离越远</li>
</ul></li>
<li><p>Statistical description <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data.info() <span class="comment"># See datatype</span></span><br></pre></td></tr></table></figure> Results: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">pandas</span>.<span class="title">core</span>.<span class="title">frame</span>.<span class="title">DataFrame</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">RangeIndex</span>:</span> <span class="number">891</span> entries, <span class="number">0</span> to <span class="number">890</span></span><br><span class="line">Data columns (total <span class="number">12</span> columns):</span><br><span class="line"> <span class="comment">#   Column       Non-Null Count  Dtype  </span></span><br><span class="line">---  ------       --------------  -----  </span><br><span class="line"> <span class="number">0</span>   PassengerId  <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">1</span>   Survived     <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">2</span>   Pclass       <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">3</span>   Name         <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">4</span>   Sex          <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">5</span>   Age          <span class="number">714</span> non-null    float64</span><br><span class="line"> <span class="number">6</span>   SibSp        <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">7</span>   Parch        <span class="number">891</span> non-null    int64  </span><br><span class="line"> <span class="number">8</span>   Ticket       <span class="number">891</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">9</span>   Fare         <span class="number">891</span> non-null    float64</span><br><span class="line"> <span class="number">10</span>  Cabin        <span class="number">204</span> non-null    <span class="built_in">object</span></span><br><span class="line"> <span class="number">11</span>  Embarked     <span class="number">889</span> non-null    <span class="built_in">object</span></span><br><span class="line">dtypes: float64(<span class="number">2</span>), int64(<span class="number">5</span>), <span class="built_in">object</span>(<span class="number">5</span>)</span><br><span class="line">memory usage: <span class="number">83.7</span>+ KB</span><br></pre></td></tr></table></figure></p></li>
<li><p>Missing values processing</p>
<ul>
<li><p>Embarked</p>
<p>Embarked 列仅有两个缺失值，而 'S' 占比最高，故将缺失值用 'S' 填充； <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data[<span class="string">&#x27;Embarked&#x27;</span>] = data[<span class="string">&#x27;Embarked&#x27;</span>].fillna(<span class="string">&#x27;S&#x27;</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Age</p>
<p>Age 包含较多缺失值，用均值填充； <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dmean_age = data[<span class="string">&#x27;Age&#x27;</span>].mean()</span><br><span class="line">data[<span class="string">&#x27;Age&#x27;</span>] = data[<span class="string">&#x27;Age&#x27;</span>].fillna(mean_age)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Cabin</p>
<p>Cabin 值缺失过多，且每位乘客房间号均不一样，且无规律，故舍去。</p></li>
</ul></li>
<li><p>Datatype transformation</p>
<ul>
<li><p>Sex 将性别转换未数值型数据，用 0 表示男性，1 表示女性</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data.loc[data[<span class="string">&#x27;Sex&#x27;</span>] == <span class="string">&#x27;male&#x27;</span>, <span class="string">&#x27;Sex&#x27;</span>] = <span class="number">0</span> <span class="comment"># &#x27;male&#x27; -&gt; 0</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;Sex&#x27;</span>] == <span class="string">&#x27;female&#x27;</span>, <span class="string">&#x27;Sex&#x27;</span>] = <span class="number">1</span> <span class="comment"># &#x27;female&#x27; -&gt; 1</span></span><br></pre></td></tr></table></figure></li>
<li><p>Embarked</p>
<p>将 'C' 所在位置的值改为 1, 'S' 所在位置的值改为 2, 'Q' 所在位置的值改为 3；</p></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data.loc[data[<span class="string">&#x27;Embarked&#x27;</span>] == <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;Embarked&#x27;</span>] = <span class="number">1</span> <span class="comment"># &#x27;C&#x27; -&gt; 1</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;Embarked&#x27;</span>] == <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;Embarked&#x27;</span>] = <span class="number">2</span> <span class="comment"># &#x27;S&#x27; -&gt; 2</span></span><br><span class="line">data.loc[data[<span class="string">&#x27;Embarked&#x27;</span>] == <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;Embarked&#x27;</span>] = <span class="number">3</span> <span class="comment"># &#x27;Q&#x27; -&gt; 3</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Drop irrelevant variables <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">columns = data.columns</span><br><span class="line">columns = columns.drop([<span class="string">&#x27;PassengerId&#x27;</span>, <span class="string">&#x27;Cabin&#x27;</span>, <span class="string">&#x27;Name&#x27;</span>, <span class="string">&#x27;Ticket&#x27;</span>])</span><br><span class="line">data = data.loc[:, columns]</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>Parameters setting 可以直到 data的列名称为 <code>['Survived', 'Pclass', 'Sex', 'Age', 'SibSp', 'Parch', 'Fare', 'Embarked']</code>。选择最后一列作为分类标准。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">test_percent = <span class="number">0.10</span> <span class="comment"># 测试集大小</span></span><br><span class="line"></span><br><span class="line">train_X = train.loc[:, data.columns[<span class="number">1</span>:]]</span><br><span class="line">train_Y = train.loc[:, data.columns[<span class="number">0</span>]].values.reshape(-<span class="number">1</span>,)</span><br><span class="line">test_X = test.loc[:, data.columns[<span class="number">1</span>:]]</span><br><span class="line">test_Y = test.loc[:, data.columns[<span class="number">0</span>]].values.reshape(-<span class="number">1</span>,)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="creating-stacking-model">2.2 Creating Stacking model</h2>
<ul>
<li><p>Stacking <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">RANDOM_SEED = <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The first layer</span></span><br><span class="line">clf1 = KNeighborsClassifier(n_neighbors=<span class="number">1</span>)</span><br><span class="line">clf2 = RandomForestClassifier(random_state=RANDOM_SEED)</span><br><span class="line">clf3 = GaussianNB()</span><br><span class="line">lr = LogisticRegression()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Starting from v0.16.0, StackingCVRegressor supports</span></span><br><span class="line"><span class="comment"># `random_state` to get deterministic result.</span></span><br><span class="line">sclf = StackingCVClassifier(</span><br><span class="line">      classifiers=[clf1, clf2, clf3],  <span class="comment"># The first layer</span></span><br><span class="line">      meta_classifier=lr,   <span class="comment"># THe second layer</span></span><br><span class="line">      random_state=RANDOM_SEED)</span><br><span class="line"></span><br><span class="line">print(<span class="string">&#x27;3-fold cross validation:\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> clf, label <span class="keyword">in</span> <span class="built_in">zip</span>([clf1, clf2, clf3, sclf], [<span class="string">&#x27;KNN&#x27;</span>, <span class="string">&#x27;Random Forest&#x27;</span>, <span class="string">&#x27;Naive Bayes&#x27;</span>,<span class="string">&#x27;StackingClassifier&#x27;</span>]):</span><br><span class="line">    scores = cross_val_score(clf, train_X, train_Y,</span><br><span class="line">              cv=<span class="number">3</span>, scoring=<span class="string">&#x27;accuracy&#x27;</span>)</span><br><span class="line">    print(<span class="string">&quot;Accuracy: %0.2f (+/- %0.2f) [%s]&quot;</span> % (scores.mean(),</span><br><span class="line">               scores.std(), label))</span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">3</span>-fold cross validation:</span><br><span class="line"></span><br><span class="line">Accuracy: <span class="number">0.70</span> (+/- <span class="number">0.02</span>) [KNN]</span><br><span class="line">Accuracy: <span class="number">0.80</span> (+/- <span class="number">0.01</span>) [Random Forest]</span><br><span class="line">Accuracy: <span class="number">0.76</span> (+/- <span class="number">0.02</span>) [Naive Bayes]</span><br><span class="line">Accuracy: <span class="number">0.79</span> (+/- <span class="number">0.01</span>) [StackingClassifier]</span><br></pre></td></tr></table></figure></p></li>
<li><p>Ploting decision region 由于使用了多维数据，决策边界暂无法成功绘制，有时间了再琢磨。</p></li>
</ul>
<h1 id="conclusion">3. Conclusion</h1>
<h2 id="blending-和-stacking-对比">3.1 Blending 和 Stacking 对比</h2>
<ul>
<li>Blending 优点：
<ul>
<li>比 Stacking 简单，不用进行 <code>K</code> 次的交叉验证来获得 stacker feature</li>
</ul></li>
<li>缺点：
<ul>
<li>在训练第二层的模型的时候，仅使用了很少的数据；</li>
<li>由于第二层训练数据较少，容易导致过拟合</li>
<li>stacking 使用多测的 CV 会比较文件。</li>
</ul></li>
</ul>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Ensemble</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Ensemble</tag>
        <tag>Sklearn</tag>
      </tags>
  </entry>
  <entry>
    <title>Ensemble-Steam</title>
    <url>/2021/05/22/Ensemble-Steam/</url>
    <content><![CDATA[<h1 id="problem">1. Problem</h1>
<h2 id="introduction-of-background">1.1 Introduction of Background</h2>
<p>火力发电的基本原理是：颜料燃烧时加热水会生成蒸汽，蒸汽压力推动汽轮机旋转，然后汽轮机带动带动发电机旋转，产生电能。在这一系列的能量转化中，影响发电效率的核心是锅炉的燃烧效率，即燃料燃烧加热水产生高温高压蒸汽。锅炉的燃烧效率的影响因素很多，包括锅炉的可调参数，如燃烧给量，一二次风，引风，返料风，给水水量；以及锅炉的工况，比如锅炉床温、床压，炉膛温度、压力，过热器的温度等。我们如何使用以上的信息，根据锅炉的工况，预测产生的蒸汽量，来为我国的工业届的产量预测贡献自己的一份力量呢？</p>
<a id="more"></a>
<p>此次的案列时使用工业指标的特征，进行蒸汽量的预测。所使用的数据均为脱敏后的数据。</p>
<h2 id="data-source">1.2 Data source</h2>
<p>数据分成训练数据（<code>train.txt</code>）和测试数据（<code>test.txt</code>），其中字段 <code>V0-V37</code>，这 <code>38</code> 个字段是作为特征变量，<code>target</code> 作为目标变量。我们需要利用训练数据训练出模型，预测测试数据的目标变量。</p>
<p>数据包下载地址: <a href="https://yangsuoly.com/file/Data-of-forcasting-Steams.rar">Data of case</a>。</p>
<h2 id="evaluation-metrics">1.3 Evaluation metrics</h2>
<p>最终的评价指标为均方误差 <span class="math inline">\(MSE\)</span> ，即： <span class="math inline">\(Score = \frac{1}{n}\sum^n_1 (y_i - y^*)^2\)</span></p>
<h1 id="data-process">2. Data process</h1>
<h2 id="load-data">2.1 Load data</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">data_train = pd.read_csv(<span class="string">&#x27;train.txt&#x27;</span>, sep = <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">data_test = pd.read_csv(<span class="string">&#x27;test.txt&#x27;</span>, sep = <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># concantenate</span></span><br><span class="line">data_train[<span class="string">&#x27;oringin&#x27;</span>] = <span class="string">&#x27;train&#x27;</span></span><br><span class="line">data_test[<span class="string">&#x27;oringin&#x27;</span>] = <span class="string">&#x27;test&#x27;</span></span><br><span class="line">data_all = pd.concat([data_train, data_test], axis = <span class="number">0</span>, ignore_index = <span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看合并后的数据信息：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data_all.head()</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
V0
</th>
<th>
V1
</th>
<th>
V2
</th>
<th>
V3
</th>
<th>
V4
</th>
<th>
V5
</th>
<th>
V6
</th>
<th>
V7
</th>
<th>
V8
</th>
<th>
V9
</th>
<th>
...
</th>
<th>
V30
</th>
<th>
V31
</th>
<th>
V32
</th>
<th>
V33
</th>
<th>
V34
</th>
<th>
V35
</th>
<th>
V36
</th>
<th>
V37
</th>
<th>
target
</th>
<th>
oringin
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
0.566
</td>
<td>
0.016
</td>
<td>
-0.143
</td>
<td>
0.407
</td>
<td>
0.452
</td>
<td>
-0.901
</td>
<td>
-1.812
</td>
<td>
-2.360
</td>
<td>
-0.436
</td>
<td>
-2.114
</td>
<td>
...
</td>
<td>
0.109
</td>
<td>
-0.615
</td>
<td>
0.327
</td>
<td>
-4.627
</td>
<td>
-4.789
</td>
<td>
-5.101
</td>
<td>
-2.608
</td>
<td>
-3.508
</td>
<td>
0.175
</td>
<td>
train
</td>
</tr>
<tr>
<th>
1
</th>
<td>
0.968
</td>
<td>
0.437
</td>
<td>
0.066
</td>
<td>
0.566
</td>
<td>
0.194
</td>
<td>
-0.893
</td>
<td>
-1.566
</td>
<td>
-2.360
</td>
<td>
0.332
</td>
<td>
-2.114
</td>
<td>
...
</td>
<td>
0.124
</td>
<td>
0.032
</td>
<td>
0.600
</td>
<td>
-0.843
</td>
<td>
0.160
</td>
<td>
0.364
</td>
<td>
-0.335
</td>
<td>
-0.730
</td>
<td>
0.676
</td>
<td>
train
</td>
</tr>
<tr>
<th>
2
</th>
<td>
1.013
</td>
<td>
0.568
</td>
<td>
0.235
</td>
<td>
0.370
</td>
<td>
0.112
</td>
<td>
-0.797
</td>
<td>
-1.367
</td>
<td>
-2.360
</td>
<td>
0.396
</td>
<td>
-2.114
</td>
<td>
...
</td>
<td>
0.361
</td>
<td>
0.277
</td>
<td>
-0.116
</td>
<td>
-0.843
</td>
<td>
0.160
</td>
<td>
0.364
</td>
<td>
0.765
</td>
<td>
-0.589
</td>
<td>
0.633
</td>
<td>
train
</td>
</tr>
<tr>
<th>
3
</th>
<td>
0.733
</td>
<td>
0.368
</td>
<td>
0.283
</td>
<td>
0.165
</td>
<td>
0.599
</td>
<td>
-0.679
</td>
<td>
-1.200
</td>
<td>
-2.086
</td>
<td>
0.403
</td>
<td>
-2.114
</td>
<td>
...
</td>
<td>
0.417
</td>
<td>
0.279
</td>
<td>
0.603
</td>
<td>
-0.843
</td>
<td>
-0.065
</td>
<td>
0.364
</td>
<td>
0.333
</td>
<td>
-0.112
</td>
<td>
0.206
</td>
<td>
train
</td>
</tr>
<tr>
<th>
4
</th>
<td>
0.684
</td>
<td>
0.638
</td>
<td>
0.260
</td>
<td>
0.209
</td>
<td>
0.337
</td>
<td>
-0.454
</td>
<td>
-1.073
</td>
<td>
-2.086
</td>
<td>
0.314
</td>
<td>
-2.114
</td>
<td>
...
</td>
<td>
1.078
</td>
<td>
0.328
</td>
<td>
0.418
</td>
<td>
-0.843
</td>
<td>
-0.215
</td>
<td>
0.364
</td>
<td>
-0.280
</td>
<td>
-0.028
</td>
<td>
0.384
</td>
<td>
train
</td>
</tr>
</tbody>
</table>
<p>
5 rows × 40 columns
</p>
<h2 id="data-exploration">2.2 Data exploration</h2>
<h3 id="eda">2.2.1 EDA</h3>
<p>由于是传感器数据，所以这些变量都是连续便来给你，故使用 <code>kdeplot</code>（核密度估计图）进行数据的初步分析，即 <code>EDA</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"></span><br><span class="line">columns = data_all.columns[<span class="number">0</span>:-<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">num_subfig = <span class="number">6</span> <span class="comment"># 每个大图中有多少小图</span></span><br><span class="line">num_fig = <span class="built_in">len</span>(columns) // num_subfig <span class="comment"># 需要多少个大图</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_fig):</span><br><span class="line">    f = plt.figure(figsize = (<span class="number">12</span>, <span class="number">9</span>))</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(num_subfig):</span><br><span class="line">        column = columns[i*num_subfig+j]</span><br><span class="line">        <span class="comment"># ax = f.add_subplot(4, 3, j+1) # 当 num_subfit = 12 时使用</span></span><br><span class="line">        ax = f.add_subplot(<span class="number">3</span>, <span class="number">2</span>, j+<span class="number">1</span>) <span class="comment"># 当 num_subfit = 6 时使用</span></span><br><span class="line">        sns.kdeplot(data_all[column][(data_all[<span class="string">&quot;oringin&quot;</span>] == <span class="string">&quot;train&quot;</span>)],</span><br><span class="line">                    color=<span class="string">&quot;Red&quot;</span>, shade = <span class="literal">True</span>)</span><br><span class="line">        sns.kdeplot(data_all[column][(data_all[<span class="string">&quot;oringin&quot;</span>] == <span class="string">&quot;test&quot;</span>)],</span><br><span class="line">                    ax = ax, color=<span class="string">&quot;Blue&quot;</span>, shade= <span class="literal">True</span>)</span><br><span class="line">        ax.set_title(<span class="string">&#x27;V&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i*num_subfig+j), fontsize = <span class="number">16</span>)</span><br><span class="line">        ax.set_xlabel(column)</span><br><span class="line">        ax.set_ylabel(<span class="string">&#x27;Frenquency&#x27;</span>)</span><br><span class="line">        ax.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Test&#x27;</span>])</span><br><span class="line">    plt.tight_layout()</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    f = plt.figure(figsize = (<span class="number">12</span>, <span class="number">3</span>))</span><br><span class="line">    column = columns[<span class="number">36</span>+i]</span><br><span class="line">    ax = f.add_subplot(<span class="number">1</span>, <span class="number">2</span>, i+<span class="number">1</span>)</span><br><span class="line">    sns.kdeplot(data_all[column][(data_all[<span class="string">&quot;oringin&quot;</span>] == <span class="string">&quot;train&quot;</span>)],</span><br><span class="line">                color=<span class="string">&quot;Red&quot;</span>, shade = <span class="literal">True</span>)</span><br><span class="line">    sns.kdeplot(data_all[column][(data_all[<span class="string">&quot;oringin&quot;</span>] == <span class="string">&quot;test&quot;</span>)],</span><br><span class="line">                ax = ax, color=<span class="string">&quot;Blue&quot;</span>, shade= <span class="literal">True</span>)</span><br><span class="line">    ax.set_title(<span class="string">&#x27;V&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="number">36</span>+i), fontsize = <span class="number">16</span>)</span><br><span class="line">    ax.set_xlabel(column)</span><br><span class="line">    ax.set_ylabel(<span class="string">&#x27;Frenquency&#x27;</span>)</span><br><span class="line">    ax.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Test&#x27;</span>])</span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/05/22/gO9rZt.png" /></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjwKx.png" /></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjBqK.png" /></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjrVO.png" /></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLj0r6.png" /></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjyIe.png" /></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjsaD.png" /></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjcPH.png" /></p>
<ul>
<li><p>Delete variables</p>
<p>从上述的图中可以看出，特征征 <code>V5</code>, <code>V9</code>, <code>V11</code>, <code>V17</code>, <code>V22</code>, <code>V28</code>中的训练集数据分布和测试集数据分布分布不均，所以我们删除这些特则会给你数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = plt.figure(figsize = (<span class="number">12</span>, <span class="number">9</span>))</span><br><span class="line"></span><br><span class="line">drop_columns = [<span class="string">&#x27;V5&#x27;</span>, <span class="string">&#x27;V9&#x27;</span>, <span class="string">&#x27;V11&#x27;</span>, <span class="string">&#x27;V17&#x27;</span>, <span class="string">&#x27;V22&#x27;</span>, <span class="string">&#x27;V28&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    column = drop_columns[i]</span><br><span class="line">    <span class="comment"># ax = f.add_subplot(4, 3, j+1) # 当 num_subfit = 12 时使用</span></span><br><span class="line">    ax = f.add_subplot(<span class="number">3</span>, <span class="number">2</span>, i+<span class="number">1</span>) <span class="comment"># 当 num_subfit = 6 时使用</span></span><br><span class="line">    sns.kdeplot(data_all[column][(data_all[<span class="string">&quot;oringin&quot;</span>] == <span class="string">&quot;train&quot;</span>)],</span><br><span class="line">                color=<span class="string">&quot;Red&quot;</span>, shade = <span class="literal">True</span>)</span><br><span class="line">    sns.kdeplot(data_all[column][(data_all[<span class="string">&quot;oringin&quot;</span>] == <span class="string">&quot;test&quot;</span>)],</span><br><span class="line">                ax = ax, color=<span class="string">&quot;Blue&quot;</span>, shade= <span class="literal">True</span>)</span><br><span class="line">    ax.set_title(column, fontsize = <span class="number">16</span>)</span><br><span class="line">    ax.set_xlabel(column)</span><br><span class="line">    ax.set_ylabel(<span class="string">&#x27;Frenquency&#x27;</span>)</span><br><span class="line">    ax.legend([<span class="string">&#x27;Train&#x27;</span>, <span class="string">&#x27;Test&#x27;</span>])</span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">data_all.drop([<span class="string">&quot;V5&quot;</span>,<span class="string">&quot;V9&quot;</span>,<span class="string">&quot;V11&quot;</span>,<span class="string">&quot;V17&quot;</span>,<span class="string">&quot;V22&quot;</span>,<span class="string">&quot;V28&quot;</span>],axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjax1.png" /></p></li>
</ul>
<h3 id="dimentsionality">2.2.2 Dimentsionality</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">data_train1 = data_all[data_all[<span class="string">&quot;oringin&quot;</span>]==<span class="string">&quot;train&quot;</span>].drop(<span class="string">&quot;oringin&quot;</span>,axis=<span class="number">1</span>)</span><br><span class="line">plt.figure(figsize=(<span class="number">20</span>, <span class="number">16</span>)) <span class="comment"># 指定绘图对象宽度和高度</span></span><br><span class="line">colnm = data_train1.columns.tolist() <span class="comment"># 列表头</span></span><br><span class="line">mcorr = data_train1[colnm].corr(method=<span class="string">&quot;spearman&quot;</span>) <span class="comment"># 相关系数矩阵，即给出了任意两个变量之间的相关系数</span></span><br><span class="line">mask = np.zeros_like(mcorr, dtype=np.<span class="built_in">bool</span>) <span class="comment"># 构造与mcorr同维数矩阵 为bool型</span></span><br><span class="line">mask[np.triu_indices_from(mask)] = <span class="literal">True</span> <span class="comment"># 角分线右侧为True</span></span><br><span class="line">cmap = sns.diverging_palette(<span class="number">220</span>, <span class="number">10</span>, as_cmap=<span class="literal">True</span>) <span class="comment"># 返回matplotlib colormap对象，调色板</span></span><br><span class="line">g = sns.heatmap(mcorr, mask=mask, cmap=cmap, square=<span class="literal">True</span>, annot=<span class="literal">True</span>, fmt=<span class="string">&#x27;0.2f&#x27;</span>) <span class="comment"># 热力图（看两两相似度）</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjfMt.md.png" /></p>
<ul>
<li><p>降维操作</p>
<p>可以发现部分特征 (<code>V14, V21, V22, V25, V26, V32, V33, V34, V35</code>) 与 <code>target</code> 的相关性非常小，其中可能包含几乎很少的对target 的预测信息，因此，对这些变量进行剔除。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">threshold = <span class="number">0.1</span></span><br><span class="line">corr_matrix = data_train1.corr().<span class="built_in">abs</span>()</span><br><span class="line">drop_col=corr_matrix[corr_matrix[<span class="string">&quot;target&quot;</span>]&lt;threshold].index</span><br><span class="line">data_all.drop(drop_col,axis=<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Normalization</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cols_numeric = <span class="built_in">list</span>(data_all.columns)</span><br><span class="line">cols_numeric.remove(<span class="string">&#x27;oringin&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scale_minmax</span>(<span class="params">col</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (col - col.<span class="built_in">min</span>())/(col.<span class="built_in">max</span>()-col.<span class="built_in">min</span>())</span><br><span class="line">scale_cols = [col <span class="keyword">for</span> col <span class="keyword">in</span> cols_numeric <span class="keyword">if</span> col != <span class="string">&#x27;target&#x27;</span>]</span><br><span class="line">data_all[scale_cols] = data_all[scale_cols].apply(scale_minmax,axis=<span class="number">0</span>)</span><br><span class="line">data_all[scale_cols].describe()</span><br></pre></td></tr></table></figure>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>V0</p>
</th>
<th>
<p>V1</p>
</th>
<th>
<p>V2</p>
</th>
<th>
<p>V3</p>
</th>
<th>
<p>V4</p>
</th>
<th>
<p>V6</p>
</th>
<th>
<p>V7</p>
</th>
<th>
<p>V8</p>
</th>
<th>
<p>V10</p>
</th>
<th>
<p>V12</p>
</th>
<th>
<p>...</p>
</th>
<th>
<p>V20</p>
</th>
<th>
<p>V23</p>
</th>
<th>
<p>V24</p>
</th>
<th>
<p>V27</p>
</th>
<th>
<p>V29</p>
</th>
<th>
<p>V30</p>
</th>
<th>
<p>V31</p>
</th>
<th>
<p>V35</p>
</th>
<th>
<p>V36</p>
</th>
<th>
<p>V37</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>count</p>
</th>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
<td>
<p>4813.000000</p>
</td>
</tr>
<tr>
<th>
<p>mean</p>
</th>
<td>
<p>0.694172</p>
</td>
<td>
<p>0.721357</p>
</td>
<td>
<p>0.602300</p>
</td>
<td>
<p>0.603139</p>
</td>
<td>
<p>0.523743</p>
</td>
<td>
<p>0.748823</p>
</td>
<td>
<p>0.745740</p>
</td>
<td>
<p>0.715607</p>
</td>
<td>
<p>0.348518</p>
</td>
<td>
<p>0.578507</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.456147</p>
</td>
<td>
<p>0.744438</p>
</td>
<td>
<p>0.356712</p>
</td>
<td>
<p>0.881401</p>
</td>
<td>
<p>0.388683</p>
</td>
<td>
<p>0.589459</p>
</td>
<td>
<p>0.792709</p>
</td>
<td>
<p>0.762873</p>
</td>
<td>
<p>0.332385</p>
</td>
<td>
<p>0.545795</p>
</td>
</tr>
<tr>
<th>
<p>std</p>
</th>
<td>
<p>0.144198</p>
</td>
<td>
<p>0.131443</p>
</td>
<td>
<p>0.140628</p>
</td>
<td>
<p>0.152462</p>
</td>
<td>
<p>0.106430</p>
</td>
<td>
<p>0.132560</p>
</td>
<td>
<p>0.132577</p>
</td>
<td>
<p>0.118105</p>
</td>
<td>
<p>0.134882</p>
</td>
<td>
<p>0.105088</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.134083</p>
</td>
<td>
<p>0.134085</p>
</td>
<td>
<p>0.265512</p>
</td>
<td>
<p>0.128221</p>
</td>
<td>
<p>0.133475</p>
</td>
<td>
<p>0.130786</p>
</td>
<td>
<p>0.102976</p>
</td>
<td>
<p>0.102037</p>
</td>
<td>
<p>0.127456</p>
</td>
<td>
<p>0.150356</p>
</td>
</tr>
<tr>
<th>
<p>min</p>
</th>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
<td>
<p>0.000000</p>
</td>
</tr>
<tr>
<th>
<p>25%</p>
</th>
<td>
<p>0.626676</p>
</td>
<td>
<p>0.679416</p>
</td>
<td>
<p>0.514414</p>
</td>
<td>
<p>0.503888</p>
</td>
<td>
<p>0.478182</p>
</td>
<td>
<p>0.683324</p>
</td>
<td>
<p>0.696938</p>
</td>
<td>
<p>0.664934</p>
</td>
<td>
<p>0.284327</p>
</td>
<td>
<p>0.532892</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.370475</p>
</td>
<td>
<p>0.719362</p>
</td>
<td>
<p>0.040616</p>
</td>
<td>
<p>0.888575</p>
</td>
<td>
<p>0.292445</p>
</td>
<td>
<p>0.550092</p>
</td>
<td>
<p>0.761816</p>
</td>
<td>
<p>0.727273</p>
</td>
<td>
<p>0.270584</p>
</td>
<td>
<p>0.445647</p>
</td>
</tr>
<tr>
<th>
<p>50%</p>
</th>
<td>
<p>0.729488</p>
</td>
<td>
<p>0.752497</p>
</td>
<td>
<p>0.617072</p>
</td>
<td>
<p>0.614270</p>
</td>
<td>
<p>0.535866</p>
</td>
<td>
<p>0.774125</p>
</td>
<td>
<p>0.771974</p>
</td>
<td>
<p>0.742884</p>
</td>
<td>
<p>0.366469</p>
</td>
<td>
<p>0.591635</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.447305</p>
</td>
<td>
<p>0.788817</p>
</td>
<td>
<p>0.381736</p>
</td>
<td>
<p>0.916015</p>
</td>
<td>
<p>0.375734</p>
</td>
<td>
<p>0.594428</p>
</td>
<td>
<p>0.815055</p>
</td>
<td>
<p>0.800020</p>
</td>
<td>
<p>0.347056</p>
</td>
<td>
<p>0.539317</p>
</td>
</tr>
<tr>
<th>
<p>75%</p>
</th>
<td>
<p>0.790195</p>
</td>
<td>
<p>0.799553</p>
</td>
<td>
<p>0.700464</p>
</td>
<td>
<p>0.710474</p>
</td>
<td>
<p>0.585036</p>
</td>
<td>
<p>0.842259</p>
</td>
<td>
<p>0.836405</p>
</td>
<td>
<p>0.790835</p>
</td>
<td>
<p>0.432965</p>
</td>
<td>
<p>0.641971</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.522660</p>
</td>
<td>
<p>0.792706</p>
</td>
<td>
<p>0.574728</p>
</td>
<td>
<p>0.932555</p>
</td>
<td>
<p>0.471837</p>
</td>
<td>
<p>0.650798</p>
</td>
<td>
<p>0.852229</p>
</td>
<td>
<p>0.800020</p>
</td>
<td>
<p>0.414861</p>
</td>
<td>
<p>0.643061</p>
</td>
</tr>
<tr>
<th>
<p>max</p>
</th>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
<td>
<p>1.000000</p>
</td>
</tr>
</tbody>
</table>
<p>
<p>8 rows × 25 columns</p>
</p></li>
</ul>
<h3 id="features-engineering">2.3.3 Features engineering</h3>
<p>绘图显示 <code>Box-Cox</code> 变换对数据分布影响，<code>Box-Cox</code> 用于连续的响应变量不满足正态分布的情况。在进行 <code>Box-Cox</code> 变换之后，可以一定程度上减少不可观测的误差和预测变量的相关性。</p>
<p><code>quantitle-quantile(q-q)</code> 图，可参考 <a href="https://blog.csdn.net/u012193416/article/details/83210790">QQ图，stats.probplot</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> stats</span><br><span class="line"></span><br><span class="line">fcols = <span class="number">6</span></span><br><span class="line">frows = <span class="built_in">len</span>(cols_numeric)-<span class="number">1</span></span><br><span class="line">plt.figure(figsize=(<span class="number">4</span>*fcols,<span class="number">4</span>*frows))</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> cols_numeric:</span><br><span class="line">    <span class="keyword">if</span> var!=<span class="string">&#x27;target&#x27;</span>:</span><br><span class="line">        dat = data_all[[var, <span class="string">&#x27;target&#x27;</span>]].dropna()</span><br><span class="line"></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        plt.subplot(frows,fcols,i)</span><br><span class="line">        sns.distplot(dat[var] , fit=stats.norm);</span><br><span class="line">        plt.title(var+<span class="string">&#x27; Original&#x27;</span>)</span><br><span class="line">        plt.xlabel(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        plt.subplot(frows,fcols,i)</span><br><span class="line">        _=stats.probplot(dat[var], plot=plt)</span><br><span class="line">        plt.title(<span class="string">&#x27;skew=&#x27;</span>+<span class="string">&#x27;&#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(stats.skew(dat[var])))</span><br><span class="line">        plt.xlabel(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        plt.ylabel(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        plt.subplot(frows,fcols,i)</span><br><span class="line">        plt.plot(dat[var], dat[<span class="string">&#x27;target&#x27;</span>],<span class="string">&#x27;.&#x27;</span>,alpha=<span class="number">0.5</span>)</span><br><span class="line">        plt.title(<span class="string">&#x27;corr=&#x27;</span>+<span class="string">&#x27;&#123;:.2f&#125;&#x27;</span>.<span class="built_in">format</span>(np.corrcoef(dat[var], dat[<span class="string">&#x27;target&#x27;</span>])[<span class="number">0</span>][<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        plt.subplot(frows,fcols,i)</span><br><span class="line">        trans_var, lambda_var = stats.boxcox(dat[var].dropna()+<span class="number">1</span>)</span><br><span class="line">        trans_var = scale_minmax(trans_var)</span><br><span class="line">        sns.distplot(trans_var , fit=stats.norm);</span><br><span class="line">        plt.title(var+<span class="string">&#x27; Tramsformed&#x27;</span>)</span><br><span class="line">        plt.xlabel(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        plt.subplot(frows,fcols,i)</span><br><span class="line">        _=stats.probplot(trans_var, plot=plt)</span><br><span class="line">        plt.title(<span class="string">&#x27;skew=&#x27;</span>+<span class="string">&#x27;&#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(stats.skew(trans_var)))</span><br><span class="line">        plt.xlabel(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        plt.ylabel(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        plt.subplot(frows,fcols,i)</span><br><span class="line">        plt.plot(trans_var, dat[<span class="string">&#x27;target&#x27;</span>],<span class="string">&#x27;.&#x27;</span>,alpha=<span class="number">0.5</span>)</span><br><span class="line">        plt.title(<span class="string">&#x27;corr=&#x27;</span>+<span class="string">&#x27;&#123;:.2f&#125;&#x27;</span>.<span class="built_in">format</span>(np.corrcoef(trans_var,dat[<span class="string">&#x27;target&#x27;</span>])[<span class="number">0</span>][<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjIZ8.md.png" /></p>
<ul>
<li><p>Box-Cox 变换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进行Box-Cox变换</span></span><br><span class="line">cols_transform=data_all.columns[<span class="number">0</span>:-<span class="number">2</span>]</span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> cols_transform:</span><br><span class="line">    <span class="comment"># transform column</span></span><br><span class="line">    data_all.loc[:,col], _ = stats.boxcox(data_all.loc[:,col]+<span class="number">1</span>)</span><br><span class="line">print(data_all.target.describe())</span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>,<span class="number">4</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">sns.distplot(data_all.target.dropna() , fit=stats.norm);</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">_=stats.probplot(data_all.target.dropna(), plot=plt)</span><br></pre></td></tr></table></figure>
<p>Results: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">count    <span class="number">2888.000000</span></span><br><span class="line">mean        <span class="number">0.126353</span></span><br><span class="line">std         <span class="number">0.983966</span></span><br><span class="line"><span class="built_in">min</span>        -<span class="number">3.044000</span></span><br><span class="line"><span class="number">25</span>%        -<span class="number">0.350250</span></span><br><span class="line"><span class="number">50</span>%         <span class="number">0.313000</span></span><br><span class="line"><span class="number">75</span>%         <span class="number">0.793250</span></span><br><span class="line"><span class="built_in">max</span>         <span class="number">2.538000</span></span><br><span class="line">Name: target, dtype: float64</span><br></pre></td></tr></table></figure></p></li>
</ul>
<p><img src="https://z3.ax1x.com/2021/05/22/gLj2RA.png" /></p>
<ul>
<li><p>对数变换 <code>target</code></p>
<p>使用对数变换 <code>target</code> 目标提升特征数量的正态性，可以参考知乎文章：<a href="https://www.zhihu.com/question/22012482">在统计学中为什么要对变量取对数？</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sp = data_train.target</span><br><span class="line">data_train.target1 = np.power(<span class="number">1.5</span>,sp)</span><br><span class="line">print(data_train.target1.describe())</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>,<span class="number">4</span>))</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">sns.distplot(data_train.target1.dropna(),fit=stats.norm);</span><br><span class="line">plt.subplot(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">_ = stats.probplot(data_train.target1.dropna(), plot=plt)</span><br></pre></td></tr></table></figure>
<p>Results: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">count    <span class="number">2888.000000</span></span><br><span class="line">mean        <span class="number">1.129957</span></span><br><span class="line">std         <span class="number">0.394110</span></span><br><span class="line"><span class="built_in">min</span>         <span class="number">0.291057</span></span><br><span class="line"><span class="number">25</span>%         <span class="number">0.867609</span></span><br><span class="line"><span class="number">50</span>%         <span class="number">1.135315</span></span><br><span class="line"><span class="number">75</span>%         <span class="number">1.379382</span></span><br><span class="line"><span class="built_in">max</span>         <span class="number">2.798463</span></span><br><span class="line">Name: target, dtype: float64</span><br></pre></td></tr></table></figure></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjRxI.png" /></p></li>
</ul>
<h1 id="model-construction">3. Model construction</h1>
<h2 id="self-definition-fuction">3.1 Self definition fuction</h2>
<ul>
<li><p>Train set and Test set</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line"><span class="comment"># function to get training samples</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_training_data</span>():</span></span><br><span class="line">    <span class="comment"># extract training samples</span></span><br><span class="line">    df_train = data_all[data_all[<span class="string">&quot;oringin&quot;</span>]==<span class="string">&quot;train&quot;</span>]</span><br><span class="line">    df_train[<span class="string">&quot;label&quot;</span>] = data_train.target1</span><br><span class="line">    <span class="comment"># split SalePrice and features</span></span><br><span class="line">    y = df_train.target</span><br><span class="line">    X = df_train.drop([<span class="string">&quot;oringin&quot;</span>,<span class="string">&quot;target&quot;</span>,<span class="string">&quot;label&quot;</span>], axis=<span class="number">1</span>)</span><br><span class="line">    X_train,X_valid,y_train,y_valid=train_test_split(X,</span><br><span class="line">                        y,test_size=<span class="number">0.3</span>,random_state=<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">return</span> X_train,X_valid,y_train,y_valid</span><br><span class="line">    <span class="comment"># extract test data (without SalePrice)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_test_data</span>():</span></span><br><span class="line">    df_test = data_all[data_all[<span class="string">&quot;oringin&quot;</span>]==<span class="string">&quot;test&quot;</span>].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> df_test.drop([<span class="string">&quot;oringin&quot;</span>,<span class="string">&quot;target&quot;</span>],axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Evaluation metrics</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> make_scorer,mean_squared_error</span><br><span class="line"></span><br><span class="line"><span class="comment"># metric for evaluation</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rmse</span>(<span class="params">y_true, y_pred</span>):</span></span><br><span class="line">    diff = y_pred - y_true</span><br><span class="line">    sum_sq = <span class="built_in">sum</span>(diff**<span class="number">2</span>)</span><br><span class="line">    n = <span class="built_in">len</span>(y_pred)</span><br><span class="line">    <span class="keyword">return</span> np.sqrt(sum_sq/n)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mse</span>(<span class="params">y_ture,y_pred</span>):</span></span><br><span class="line">    <span class="keyword">return</span> mean_squared_error(y_ture,y_pred)</span><br><span class="line"></span><br><span class="line"><span class="comment"># scorer to be used in sklearn model fitting</span></span><br><span class="line">rmse_scorer = make_scorer(rmse, greater_is_better=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入的score_func为记分函数时，该值为True（默认值）；输入函数为损失函数时，该值为False</span></span><br><span class="line">mse_scorer = make_scorer(mse, greater_is_better=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Outliers</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Ridge</span><br><span class="line"></span><br><span class="line"><span class="comment"># function to detect outliers based on the predictions of a model</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_outliers</span>(<span class="params">model, X, y, sigma=<span class="number">3</span></span>):</span></span><br><span class="line">    <span class="comment"># predict y values using model</span></span><br><span class="line">    model.fit(X,y)</span><br><span class="line">    y_pred = pd.Series(model.predict(X), index=y.index)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># calculate residuals between the model prediction and true y values</span></span><br><span class="line">    resid = y - y_pred</span><br><span class="line">    mean_resid = resid.mean()</span><br><span class="line">    std_resid = resid.std()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># calculate z statistic, define outliers to be where |z|&gt;sigma</span></span><br><span class="line">    z = (resid - mean_resid)/std_resid</span><br><span class="line">    outliers = z[<span class="built_in">abs</span>(z)&gt;sigma].index</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print and plot the results</span></span><br><span class="line">    print(<span class="string">&#x27;R2=&#x27;</span>,model.score(X,y))</span><br><span class="line">    print(<span class="string">&#x27;rmse=&#x27;</span>,rmse(y, y_pred))</span><br><span class="line">    print(<span class="string">&quot;mse=&quot;</span>,mean_squared_error(y,y_pred))</span><br><span class="line">    print(<span class="string">&#x27;---------------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&#x27;mean of residuals:&#x27;</span>,mean_resid)</span><br><span class="line">    print(<span class="string">&#x27;std of residuals:&#x27;</span>,std_resid)</span><br><span class="line">    print(<span class="string">&#x27;---------------------------------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="built_in">len</span>(outliers),<span class="string">&#x27;outliers:&#x27;</span>)</span><br><span class="line">    print(outliers.tolist())</span><br><span class="line"></span><br><span class="line">    plt.figure(figsize=(<span class="number">15</span>,<span class="number">5</span>))</span><br><span class="line">    ax_131 = plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">    plt.plot(y,y_pred,<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    plt.plot(y.loc[outliers],y_pred.loc[outliers],<span class="string">&#x27;ro&#x27;</span>)</span><br><span class="line">    plt.legend([<span class="string">&#x27;Accepted&#x27;</span>,<span class="string">&#x27;Outlier&#x27;</span>])</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;y_pred&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    ax_132=plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>)</span><br><span class="line">    plt.plot(y,y-y_pred,<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    plt.plot(y.loc[outliers],y.loc[outliers]-y_pred.loc[outliers],<span class="string">&#x27;ro&#x27;</span>)</span><br><span class="line">    plt.legend([<span class="string">&#x27;Accepted&#x27;</span>,<span class="string">&#x27;Outlier&#x27;</span>])</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">    plt.ylabel(<span class="string">&#x27;y - y_pred&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    ax_133=plt.subplot(<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>)</span><br><span class="line">    z.plot.hist(bins=<span class="number">50</span>,ax=ax_133)</span><br><span class="line">    z.loc[outliers].plot.hist(color=<span class="string">&#x27;r&#x27;</span>,bins=<span class="number">50</span>,ax=ax_133)</span><br><span class="line">    plt.legend([<span class="string">&#x27;Accepted&#x27;</span>,<span class="string">&#x27;Outlier&#x27;</span>])</span><br><span class="line">    plt.xlabel(<span class="string">&#x27;z&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> outliers</span><br><span class="line"></span><br><span class="line"><span class="comment"># get training data</span></span><br><span class="line">X_train, X_valid,y_train,y_valid = get_training_data()</span><br><span class="line">test=get_test_data()</span><br><span class="line"></span><br><span class="line"><span class="comment"># find and remove outliers using a Ridge model</span></span><br><span class="line">outliers = find_outliers(Ridge(), X_train, y_train)</span><br><span class="line">X_outliers=X_train.loc[outliers]</span><br><span class="line">y_outliers=y_train.loc[outliers]</span><br><span class="line">X_t=X_train.drop(outliers)</span><br><span class="line">y_t=y_train.drop(outliers)</span><br></pre></td></tr></table></figure>
<p>Results: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">R2= <span class="number">0.8760125992975717</span></span><br><span class="line">rmse= <span class="number">0.3499365298917651</span></span><br><span class="line">mse= <span class="number">0.12245557495269015</span></span><br><span class="line">---------------------------------------</span><br><span class="line">mean of residuals: -<span class="number">3.28946831838468e-16</span></span><br><span class="line">std of residuals: <span class="number">0.3500231371273175</span></span><br><span class="line">---------------------------------------</span><br><span class="line"><span class="number">21</span> outliers:</span><br><span class="line">[<span class="number">2655</span>, <span class="number">2159</span>, <span class="number">1164</span>, <span class="number">2863</span>, <span class="number">1145</span>, <span class="number">2697</span>, <span class="number">2528</span>, <span class="number">2645</span>, <span class="number">691</span>, <span class="number">1874</span>,</span><br><span class="line"><span class="number">2647</span>, <span class="number">884</span>, <span class="number">2696</span>, <span class="number">2668</span>, <span class="number">1310</span>, <span class="number">1901</span>, <span class="number">1458</span>, <span class="number">2769</span>, <span class="number">2002</span>, <span class="number">2669</span>, <span class="number">1972</span>]</span><br></pre></td></tr></table></figure></p>
<p><img src="https://z3.ax1x.com/2021/05/22/gLjhsP.png" /></p></li>
</ul>
<h2 id="model-training">3.2 Model training</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_trainning_data_omitoutliers</span>():</span></span><br><span class="line">    <span class="comment">#获取训练数据省略异常值</span></span><br><span class="line">    y=y_t.copy()</span><br><span class="line">    X=X_t.copy()</span><br><span class="line">    <span class="keyword">return</span> X,y</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_model</span>(<span class="params">model, param_grid=[], X=[], y=[],</span></span></span><br><span class="line"><span class="function"><span class="params">                splits=<span class="number">5</span>, repeats=<span class="number">5</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取数据</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(y)==<span class="number">0</span>:</span><br><span class="line">        X,y = get_trainning_data_omitoutliers()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 交叉验证</span></span><br><span class="line">    rkfold = RepeatedKFold(n_splits=splits, n_repeats=repeats)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 网格搜索最佳参数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(param_grid)&gt;<span class="number">0</span>:</span><br><span class="line">        gsearch = GridSearchCV(model, param_grid, cv=rkfold,</span><br><span class="line">        scoring=<span class="string">&quot;neg_mean_squared_error&quot;</span>,</span><br><span class="line">        verbose=<span class="number">1</span>, return_train_score=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 训练</span></span><br><span class="line">        gsearch.fit(X,y)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 最好的模型</span></span><br><span class="line">        model = gsearch.best_estimator_</span><br><span class="line">        best_idx = gsearch.best_index_</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取交叉验证评价指标</span></span><br><span class="line">        grid_results = pd.DataFrame(gsearch.cv_results_)</span><br><span class="line">        cv_mean = <span class="built_in">abs</span>(grid_results.loc[best_idx,<span class="string">&#x27;mean_test_score&#x27;</span>])</span><br><span class="line">        cv_std = grid_results.loc[best_idx,<span class="string">&#x27;std_test_score&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 没有网格搜索</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        grid_results = []</span><br><span class="line">        cv_results = cross_val_score(model, X, y, scoring=<span class="string">&quot;neg_mean_squared_error&quot;</span>, cv=rkfold)</span><br><span class="line">        cv_mean = <span class="built_in">abs</span>(np.mean(cv_results))</span><br><span class="line">        cv_std = np.std(cv_results)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 合并数据</span></span><br><span class="line">    cv_score = pd.Series(&#123;<span class="string">&#x27;mean&#x27;</span>:cv_mean,<span class="string">&#x27;std&#x27;</span>:cv_std&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 预测</span></span><br><span class="line">    y_pred = model.predict(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模型性能的统计数据</span></span><br><span class="line">    print(<span class="string">&#x27;----------------------&#x27;</span>)</span><br><span class="line">    print(model)</span><br><span class="line">    print(<span class="string">&#x27;----------------------&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;score=&#x27;</span>,model.score(X,y))</span><br><span class="line">    print(<span class="string">&#x27;rmse=&#x27;</span>,rmse(y, y_pred))</span><br><span class="line">    print(<span class="string">&#x27;mse=&#x27;</span>,mse(y, y_pred))</span><br><span class="line">    print(<span class="string">&#x27;cross_val: mean=&#x27;</span>,cv_mean,<span class="string">&#x27;, std=&#x27;</span>,cv_std)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 残差分析与可视化</span></span><br><span class="line">    y_pred = pd.Series(y_pred,index=y.index)</span><br><span class="line">    resid = y - y_pred</span><br><span class="line">    mean_resid = resid.mean()</span><br><span class="line">    std_resid = resid.std()</span><br><span class="line">    z = (resid - mean_resid)/std_resid</span><br><span class="line">    n_outliers = <span class="built_in">sum</span>(<span class="built_in">abs</span>(z)&gt;<span class="number">3</span>)</span><br><span class="line">    outliers = z[<span class="built_in">abs</span>(z)&gt;<span class="number">3</span>].index</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model, cv_score, grid_results</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV, RepeatedKFold, cross_val_score,cross_val_predict,KFold</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Ridge</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义训练变量存储数据</span></span><br><span class="line">opt_models = <span class="built_in">dict</span>()</span><br><span class="line">score_models = pd.DataFrame(columns=[<span class="string">&#x27;mean&#x27;</span>,<span class="string">&#x27;std&#x27;</span>])</span><br><span class="line">splits=<span class="number">5</span></span><br><span class="line">repeats=<span class="number">5</span></span><br><span class="line"></span><br><span class="line">model = <span class="string">&#x27;Ridge&#x27;</span></span><br><span class="line">opt_models[model] = Ridge()</span><br><span class="line">alph_range = np.arange(<span class="number">0.25</span>,<span class="number">6</span>,<span class="number">0.25</span>)</span><br><span class="line">param_grid = &#123;<span class="string">&#x27;alpha&#x27;</span>: alph_range&#125;</span><br><span class="line"></span><br><span class="line">opt_models[model],cv_score,grid_results = train_model(opt_models[model],</span><br><span class="line">                    param_grid=param_grid, splits=splits, repeats=repeats)</span><br><span class="line"></span><br><span class="line">cv_score.name = model</span><br><span class="line">score_models = score_models.append(cv_score)</span><br><span class="line"></span><br><span class="line">plt.figure()</span><br><span class="line">plt.errorbar(alph_range, <span class="built_in">abs</span>(grid_results[<span class="string">&#x27;mean_test_score&#x27;</span>]),</span><br><span class="line">        <span class="built_in">abs</span>(grid_results[<span class="string">&#x27;std_test_score&#x27;</span>])/np.sqrt(splits*repeats))</span><br><span class="line">plt.xlabel(<span class="string">&#x27;alpha&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;score&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>Fitting 25 folds for each of 23 candidates, totalling 575 fits
----------------------
Ridge(alpha=0.25)
----------------------
score= 0.8914965873982021
rmse= 0.32638045120253134
mse= 0.1065241989271679
cross_val: mean= 0.11019851747204477 , std= 0.006413351282774973

Text(0, 0.5, &#39;score&#39;)</code></pre>
<p><img src="https://z3.ax1x.com/2021/05/22/gLj4qf.png" /></p>
<ul>
<li><p>Forecasting function</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 预测函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">model_predict</span>(<span class="params">test_data,test_y=[]</span>):</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    y_predict_total=np.zeros((test_data.shape[<span class="number">0</span>],))</span><br><span class="line">    <span class="keyword">for</span> model <span class="keyword">in</span> opt_models.keys():</span><br><span class="line">        <span class="keyword">if</span> model!=<span class="string">&quot;LinearSVR&quot;</span> <span class="keyword">and</span> model!=<span class="string">&quot;KNeighbors&quot;</span>:</span><br><span class="line">            y_predict=opt_models[model].predict(test_data)</span><br><span class="line">            y_predict_total+=y_predict</span><br><span class="line">            i+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(test_y)&gt;<span class="number">0</span>:</span><br><span class="line">            print(<span class="string">&quot;&#123;&#125;_mse:&quot;</span>.<span class="built_in">format</span>(model),mean_squared_error(y_predict,test_y))</span><br><span class="line"></span><br><span class="line">    y_predict_mean=np.<span class="built_in">round</span>(y_predict_total/i,<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(test_y)&gt;<span class="number">0</span>:</span><br><span class="line">        print(<span class="string">&quot;mean_mse:&quot;</span>,mean_squared_error(y_predict_mean,test_y))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        y_predict_mean=pd.Series(y_predict_mean)</span><br><span class="line">        <span class="keyword">return</span> y_predict_mean</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="预测并保存结果">3.3 预测并保存结果</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y_ = model_predict(test)</span><br><span class="line">y_.to_csv(<span class="string">&#x27;predict.txt&#x27;</span>,header = <span class="literal">None</span>,index = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Ensemble</category>
        <category>Cases</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Ensemble</tag>
        <tag>Sklearn</tag>
      </tags>
  </entry>
  <entry>
    <title>Eviews notes</title>
    <url>/2020/11/22/Eviews/</url>
    <content><![CDATA[<h1 id="create-workfile">1 Create workfile</h1>
<p>Eviews 10 创建时间序列工作文件，界面如下</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DUNDeA.png" /></p>
<center>
figure 1-1 时间序列类型
</center>
<p>参数释义为：</p>
<a id="more"></a>
<ul>
<li>Annual：年度数据</li>
<li>Semi-annual：半年(2010S1 - 2019S1)</li>
<li>Quarteryly：季度 （2010Q3 - 2019Q2）</li>
<li>Monthly：月度（2010M01 - 2019M11）</li>
<li>Bimonthly：半月（2010-3-01 - 2019-8-8）</li>
<li>Fortnightly：两周</li>
<li>Daily-custom week：用户自定义选择周几</li>
<li>Intraday：当日数据，精确到每天每隔多少时间</li>
<li>Integer data：可以是年度（eg：2001 - 2012），也可以是哪一期（eg：3 - 33）</li>
</ul>
<p>创建平衡面板数据：</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DUN0Ld.png" /></p>
<center>
figure 1-2 平衡面板数据
</center>
<h1 id="least-squares最小二乘法">2 Least Squares（最小二乘法）</h1>
<p>Command中输入 <code>ls y c x</code>即可得到如下结果：</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DUNrdI.md.png" /></p>
<center>
figure 1-3 Parameters
</center>
<p>Parameters:</p>
<ul>
<li>Coefficient：系数，参数估计值</li>
<li>Std. Error：参数估计量标准差估计值</li>
<li>t-Statistic：<span class="math inline">\(t\)</span> 统计量的值</li>
<li>Prob: <span class="math inline">\(P\)</span> 值</li>
<li>R-squared: $ R^2$</li>
<li>Adjusted R-squared: $^ - $</li>
<li>S.E. of regression: <span class="math inline">\(\sigma ^2\)</span></li>
<li>Sum squared resid: $ RSS$，残差平方和</li>
<li>Mean dependent var: <span class="math inline">\(\overset{-}{Y}\)</span>，被解释变量的均值</li>
<li>S.D. dependent var: 被解释变量的标准差</li>
</ul>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Software</category>
      </categories>
      <tags>
        <tag>Eviews</tag>
        <tag>Software</tag>
      </tags>
  </entry>
  <entry>
    <title>Git notes</title>
    <url>/2020/11/22/Git-notes/</url>
    <content><![CDATA[<h1 id="版本控制">1. 版本控制</h1>
<h2 id="版本控制迭代">1.1 版本控制（迭代）</h2>
<p>版本控制（Revision control）是一种在开发的过程中用于管理我们对文件、目录或工程等内容的修改历史，方便查看更改历史记录，备份以便恢复以前的版本的软件工程技术。</p>
<ul>
<li>实现跨区域多人协同开发</li>
<li>追踪和记载一个或者多个文件的历史记录</li>
<li>组织和保护你的源代码和文档</li>
<li>统计工作量</li>
<li>并行开发、提高开发效率</li>
<li>跟踪记录整个软件的开发过程</li>
<li>减轻开发人员的负担，节省时间，同时降低人为错误</li>
</ul>
<a id="more"></a>
<h2 id="版本控制工具">1.2 版本控制工具</h2>
<h3 id="主流的版本控制器">1.2.1 主流的版本控制器：</h3>
<ul>
<li><strong>Git</strong></li>
<li><strong>SVN</strong>（Subversion）</li>
<li><strong>CVS</strong>（Concurrent Versions System）</li>
<li><strong>VSS</strong>（Micorosoft Visual SourceSafe）</li>
<li><strong>TFS</strong>（Team Foundation Server）</li>
<li>Visual Studio Online</li>
</ul>
<h3 id="版本控制分类">1.2.2 版本控制分类</h3>
<ul>
<li>本地版本控制：RCS</li>
</ul>
<blockquote>
<p><img src="https://s3.ax1x.com/2020/11/25/DauN11.png" /></p>
</blockquote>
<center>
图 1-1 本地版本控制
</center>
<ul>
<li>集中版本控制：SVN</li>
</ul>
<p><img src="https://s3.ax1x.com/2020/11/25/Dauu60.png" /></p>
<center>
图 1-2 集中版本控制
</center>
<ul>
<li>分布式版本控制：Git</li>
</ul>
<p><img src="https://s3.ax1x.com/2020/11/25/DauZfs.md.jpg" /></p>
<center>
图 1-3 分布式版本控制
</center>
<h3 id="git-与-svn-的区别">1.2.3 Git 与 SVN 的区别</h3>
<blockquote>
<ul>
<li><p>SVN是集中式版本控制系统，版本库集中放在中央服务器的，工作时，需要从中央服务器得到最新的版本，完成工作后，把做完的活推送到中央服务器。集中式版本控制系统是必须联网才能工作，对网络带宽要求较高。</p></li>
<li><p>Git是分布式版本控制系统，没有中央服务器，每个人的电脑就是一个完整的版本库</p></li>
</ul>
</blockquote>
<h1 id="git-环境配置">2. Git 环境配置</h1>
<h2 id="git配置">2.1 Git配置</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">git config -l</span><br><span class="line"><span class="comment"># 查看配置</span></span><br><span class="line"></span><br><span class="line">git config --system --<span class="built_in">list</span></span><br><span class="line"><span class="comment"># 系统配置</span></span><br><span class="line"></span><br><span class="line">git config --<span class="keyword">global</span> --<span class="built_in">list</span></span><br><span class="line"><span class="comment"># 查看当前用户 (global) 配置</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Git 相关的配置文件</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">D:\Program files\Git\Git\etc：</span><br><span class="line"><span class="comment"># Git 安装目录下的 gitconfig --system 系统级</span></span><br><span class="line"></span><br><span class="line">C:\Users\YangSu\.gitconfig</span><br><span class="line"><span class="comment">#  只适用于当前登录用户的配置  --global 全局</span></span><br><span class="line"></span><br><span class="line">git config --<span class="keyword">global</span> user.name <span class="string">&quot;YS&quot;</span> <span class="comment">#名称</span></span><br><span class="line">git config --<span class="keyword">global</span> user.email num@qq.com   <span class="comment"># 邮箱</span></span><br></pre></td></tr></table></figure>
<h1 id="git-基本理论">3. Git 基本理论</h1>
<h2 id="工作区域">3.1 工作区域</h2>
<blockquote>
<p>四个工作区域：</p>
<ul>
<li>工作目录 (Working Directory)</li>
<li>暂存区 (Stage / Index)</li>
<li>资源库 (Repository 或 Git Directory)</li>
<li>远程 Git 仓库 (Remote Directory)</li>
</ul>
</blockquote>
<p><img src="https://s3.ax1x.com/2020/11/25/Daunlq.png" /></p>
<center>
图 1-4 工作区域（核心）
</center>
<ul>
<li>Workspace：工作区，就是你平时存放项目代码的地方</li>
<li>Index / Stage：暂存区，用于临时存放你的改动，事实上它只是一个文件，保存即将提交到文件列表信息</li>
<li>Repository：仓库区（或本地仓库），就是安全存放数据的位置，这里面有你提交到所有版本的数据。其中HEAD指向最新放入仓库的版本</li>
<li>Remote：远程仓库，托管代码的服务器，可以简单的认为是你项目组中的一台电脑用于远程数据交换</li>
</ul>
<p>本地的三个区域确切的说应该是git仓库中HEAD指向的版本：</p>
<p><img src="https://s3.ax1x.com/2020/11/25/Daumpn.png" /></p>
<center>
图 1-5 Git示意图
</center>
<ul>
<li>Directory：使用Git管理的一个目录，也就是一个仓库，包含我们的工作空间和Git的管理空间。</li>
<li>WorkSpace：需要通过Git进行版本控制的目录和文件，这些目录和文件组成了工作空间。</li>
<li>.git：存放Git管理信息的目录，初始化仓库的时候自动创建。</li>
<li>Index/Stage：暂存区，或者叫待提交更新区，在提交进入repo之前，我们可以把所有的更新放在暂存区。</li>
<li>Local Repo：本地仓库，一个存放在本地的版本库；HEAD会只是当前的开发分支（branch）。</li>
<li>Stash：隐藏，是一个工作状态保存栈，用于保存/恢复WorkSpace中的临时状态。</li>
</ul>
<h2 id="工作流程">3.2 工作流程</h2>
<ol type="1">
<li>在工作目录中添加、修改文件；</li>
<li>将需要进行版本管理的文件放入暂存区域；</li>
<li>将暂存区域的文件提交到git仓库。</li>
</ol>
<p>因此，git管理的文件有三种状态：已修改（modified）,已暂存（staged）,已提交(committed)</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DauKXV.jpg" /></p>
<center>
1-6 工作流程
</center>
<h1 id="项目搭建">4. 项目搭建</h1>
<h2 id="创建工作目录">4.1 创建工作目录</h2>
<p>工作目录（WorkSpace)一般就是你希望Git帮助你管理的文件夹，可以是你项目的目录，也可以是一个空目录，建议不要有中文。</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DauQmT.png" /></p>
<center>
1-7 常用命令
</center>
<h2 id="创建本地仓库">4.2 创建本地仓库</h2>
<ul>
<li>创建全新的仓库</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在当前目录新建一个Git代码库</span></span><br><span class="line">$ git init</span><br><span class="line"><span class="comment"># 执行后，项目目录多出了一个.git目录</span></span><br></pre></td></tr></table></figure>
<ul>
<li>克隆远程仓库</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 克隆一个项目和它的整个代码历史(版本信息)</span></span><br><span class="line">$ git clone [url]  </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">从 gitee 或 github 中克隆</span></span><br><span class="line"><span class="string">https://gitee.com/kuangstudy/openclass.git</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h1 id="git-文件操作">5. Git 文件操作</h1>
<h2 id="文件的四种状态">5.1 文件的四种状态</h2>
<ul>
<li>Untracked: 未跟踪, 此文件在文件夹中, 但并没有加入到git 库, 不参与版本控制. 通过 git add 状态变为 Staged.</li>
<li>Unmodify: 文件已经入库, 未修改, 即版本库中的文件快照内容与文件夹中完全一致. 这种类型的文件有两种去处, 如果它被修改, 而变为 Modified. 如果使用git rm移出版本库, 则成为 Untracked 文件</li>
<li>Modified: 文件已修改, 仅仅是修改, 并没有进行其他的操作. 这个文件也有两个去处, 通过git add可进入暂存staged状态, 使用git checkout 则丢弃修改过, 返回到unmodify状态, 这个git checkout即从库中取出文件, 覆盖当前修改 !</li>
<li>Staged: 暂存状态. 执行git commit则将修改同步到库中, 这时库中的文件和本地文件又变为一致, 文件为Unmodify状态. 执行git reset HEAD filename取消暂存, 文件状态为Modified</li>
</ul>
<h2 id="查看文件状态">5.2 查看文件状态</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">touch hello.py</span><br><span class="line"></span><br><span class="line">git status hello.py <span class="comment"># 产看指定文件状态</span></span><br><span class="line">git status <span class="comment"># 查看所有文件状态</span></span><br><span class="line"></span><br><span class="line">git add hello.py <span class="comment"># 添加指定文件到暂存区</span></span><br><span class="line">git add . <span class="comment"># 添加所有文件到暂存区 (repository)</span></span><br><span class="line"></span><br><span class="line">git rm --cached hello.py <span class="comment"># 将文件从暂存区移除</span></span><br><span class="line">git restore -staged add.py <span class="comment"># 将文件从暂存区移除</span></span><br><span class="line"></span><br><span class="line">git commit -m <span class="string">&quot;a new file named hello.py&quot;</span> </span><br><span class="line"><span class="comment"># 提交暂存区内容至本地仓库</span></span><br><span class="line"></span><br><span class="line">git push -u origin master -f</span><br><span class="line"><span class="comment"># 第一次使用push的时候加上-u,以后可不加，-f强制上传</span></span><br></pre></td></tr></table></figure>
<h2 id="忽略文件">5.3 忽略文件</h2>
<p>有些时候我们不想把某些文件纳入版本控制中，比如数据库文件，临时文件，设计文件等</p>
<p>在主目录下建立".gitignore"文件，此文件有如下规则：</p>
<ul>
<li>忽略文件中的空行或以井号（#）开始的行将会被忽略。</li>
<li>可以使用Linux通配符。例如：星号（*）代表任意多个字符，问号（？）代表一个字符，方括号（[abc]）代表可选字符范围，大括号（{string1,string2,...}）代表可选的字符串等。</li>
<li>如果名称的最前面有一个感叹号（!），表示例外规则，将不被忽略。</li>
<li>如果名称的最前面是一个路径分隔符（/），表示要忽略的文件在此目录下，而子目录中的文件不忽略。</li>
<li>如果名称的最后面是一个路径分隔符（/），表示要忽略的是此目录下该名称的子目录，而非文件（默认文件或目录都忽略）。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 为注释</span></span><br><span class="line">*.txt  <span class="comment"># 忽略.txt结尾的文件,上传时不会被选中！</span></span><br><span class="line">!lib.txt     <span class="comment"># 但lib.txt除外</span></span><br><span class="line">/temp        <span class="comment">#仅忽略项目根目录下的TODO文件,不包括其它目录temp</span></span><br><span class="line">build/       <span class="comment">#忽略build/目录下的所有文件</span></span><br><span class="line">doc/*.txt    <span class="comment">#忽略doc/notes.txt 但不包括 doc/server/arch.txt</span></span><br></pre></td></tr></table></figure>
<h1 id="使用码云">6. 使用码云</h1>
<blockquote>
<p>github 是有墙的，比较慢，国内一般用 gitee</p>
</blockquote>
<h2 id="设置免密码登录">6.1 设置免密码登录</h2>
<ol type="1">
<li><p>设置本机绑定SSH公钥，实现免密码登录！</p>
<p>免密码登录，这一步挺重要的，码云是远程仓库，我们是平时工作在本地仓库！</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入 C:\Users\YangSu\.ssh 目录</span></span><br><span class="line"><span class="comment"># 生成公钥</span></span><br><span class="line">ssh-keygen -t rsa <span class="comment"># 加密算法</span></span><br></pre></td></tr></table></figure></li>
<li><p>将公钥信息public key 添加到码云账户中</p>
<p>密钥信息存储在 id_rsa.pub 文件中</p></li>
<li><p>使用 gitee 创建一个自己的仓库</p>
<p><strong>许可证：</strong>开源是否可以随意转载，开源但是不能商业使用，不能转载，... 限制！</p></li>
</ol>
<h2 id="添加远程库">7.2 添加远程库</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">git remote add origin https://gitee.com/yangsuoly/GitStudy.git</span><br><span class="line"><span class="comment"># 添加远程库, HTTPS方式，ssh可以免密</span></span><br><span class="line"></span><br><span class="line">git remote -v <span class="comment"># 查看 clone 的地址</span></span><br><span class="line">git remote rm origin <span class="comment"># 移除远程库地址</span></span><br><span class="line">git remote add origin git@gitee.com:yangsuoly/GitStudy.git <span class="comment"># 添加远程库地址，SSH方式</span></span><br><span class="line"></span><br><span class="line">cat /c/Users/YangSu/.ssh/id_rsa.pub <span class="comment"># 查看公玥</span></span><br><span class="line">    </span><br><span class="line">git push -u origin master -f <span class="comment"># 首次使用</span></span><br><span class="line">git push <span class="comment"># 之后</span></span><br></pre></td></tr></table></figure>
<h1 id="git-分支">8. Git 分支</h1>
<h2 id="git-常用指令">8.1 Git 常用指令</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 列出所有本地分支</span></span><br><span class="line">git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有远程分支</span></span><br><span class="line">git branch -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，但依然停留在当前分支</span></span><br><span class="line">git branch [branch-name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，并切换到该分支</span></span><br><span class="line">git checkout -b [branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并指定分支到当前分支</span></span><br><span class="line">$ git merge [branch]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line">$ git branch -d [branch-name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line">$ git push origin --delete [branch-name]</span><br><span class="line">$ git branch -dr [remote/branch]</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Notes</category>
        <category>OS</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Group-Pictures</title>
    <url>/2020/12/02/Group-Pictures/</url>
    <content><![CDATA[<div class="group-picture"><div class="group-picture-container"><div class="group-picture-row"><div class="group-picture-column" style="width: 50%;"><img src="https://s3.ax1x.com/2020/11/30/DgWRZ6.png" /></div><div class="group-picture-column" style="width: 50%;"><img src="https://s3.ax1x.com/2020/11/30/DgWA8H.png" /></div></div><div class="group-picture-row"><div class="group-picture-column" style="width: 100%;"><img src="https://s3.ax1x.com/2020/11/30/DgWA8H.png" /></div></div><div class="group-picture-row"><div class="group-picture-column" style="width: 50%;"><img src="https://s3.ax1x.com/2020/11/30/DgWA8H.png" /></div><div class="group-picture-column" style="width: 50%;"><img src="https://s3.ax1x.com/2020/11/30/DgWA8H.png" /></div></div></div></div>
]]></content>
      <categories>
        <category>Notes</category>
      </categories>
      <tags>
        <tag>Pics</tag>
      </tags>
  </entry>
  <entry>
    <title>Fantastic-Matplotlib</title>
    <url>/2022/01/11/Fantastic-Matplotlib/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<p><img src="https://matplotlib.org/_static/logo2_compressed.svg" /></p>
<p>本笔记是 <code>DataWhale</code> 第 <code>33</code> 期 <code>Fantastic-Matplotlib</code> 项目的学习笔记。原项目地址：<a href="https://github.com/datawhalechina/fantastic-matplotlib">Clike here</a>。本博客提供笔记所使用的数据：</p>
<p><a id="download" href="https://www.aliyundrive.com/s/5ny6LPYdyiu" target="_blank"><i class="fa fa-download"></i><span> Download Now </span> </a></p>
<a id="more"></a>
<p><code>Matplotlib</code> 是 <code>python</code> 数据可视化最重要且常见的工具之一，和数据打交道的过程中几乎都不可避免要用到，此外也有大量的可视化工具是基于 <code>matplotlib</code> 做的二次开发。它是一个 <code>Python 2D</code> 绘图库，能够以多种硬拷贝格式和跨平台的交互式环境生成出版物质量的图形，用来绘制各种静态，动态，交互式的图表。</p>
<p>通常，在用 <code>python</code> 做数据可视化时面临两大痛点:</p>
<ul>
<li>没有系统梳理 <code>matplotlib</code> 的绘图接口，常常是现用现查，用过即忘，效率极低；</li>
<li>没有深入理解 <code>matplotlib</code> 的设计框架，往往是只会复制粘贴，不知其所以然，面对复杂图表时一筹莫展；</li>
</ul>
<p>基于此，本项目将从 <a href="https://matplotlib.org/">官方文档</a> 出发，系统的阐述 <code>Matplotlib</code> 的常见用法。</p>
<h1 id="begin-with-a-simple-case">2. Begin with a simple case</h1>
<h2 id="create-figure">2.1 Create figure</h2>
<p><code>Matplotlib</code> 的图像是画在 <code>figure</code> （如 <code>windows</code>， <code>jupyter</code> 窗体）上的，每一个 <code>figure</code> 又包含了一个或多个 <code>axes</code>（一个可以制定坐标系的子区间）。最贱的创建 <code>figure</code> 以及 <code>axes</code> 的方式是通过 <code>pyplot.subplots</code> 命令，之后可以使用 <code>Axes.plot</code> 绘制最简易的折线图。</p>
<ul>
<li><p>Import module</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib <span class="keyword">as</span> mpl</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure></p>
<p><strong>Note</strong>: 有时，当我们在 <code>matplotlib</code> 中使用中文时，我们会发现乱码或者无法正常显示的情况，这是因为默认的字体不支持中文字体，可以在导入模块之后使用下述代码来自定义中文字体。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyplt <span class="keyword">import</span> mpl</span><br><span class="line">mpl.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">mpl.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Plot</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, ax = plt.subplots()</span><br><span class="line">ax.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], [<span class="number">1</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M65ZR.png' style='zoom:80%' /></p></li>
<li><p>Components</p>
<p>创建了 <code>figure</code> 之后，我们来深入理解一下一张 <code>figure</code> 的组成。通过一张 <code>figure</code> 的解剖图，我们可以看到一个完整的 <code>matplotlib</code> 图像通常会包括四个层级，这些层级也被称为容器 <code>container</code>，下一章会对其进行详细介绍。在了解了容器之后，我们可以通过各种命令方式来操作图像中的每个部分，从而达到自定义数据可视化的效果。</p>
<ul>
<li><code>Figure</code>：顶层级，用来容纳所有绘图元素；</li>
<li><code>Axes</code>：<code>Matplotlib</code> 宇宙的核心，容纳了大量元素；用来构造一幅幅子图，一个 <code>figure</code> 可以由一个或多个子图组成；</li>
<li><code>Axis</code>：<code>Axes</code> 的下属层级，用于处理所有与纵坐标、网格有关的元素；</li>
<li><code>Tick</code>：<code>Axis</code> 的下属层级，用来处理所有和刻度有关的元素。</li>
</ul>
<p><img src='https://s4.ax1x.com/2022/01/11/7e5PfK.md.png' style='zoom:80%' /></p></li>
</ul>
<h2 id="interfaces">2.2 Interfaces</h2>
<p><code>Matplotlib</code> 提供了两种最常用的绘图接口，面向对象编程绘图和函数式绘图。面向对象 （Object-oriented, <code>OO</code>）绘图更加灵活，现实中，在添加文本注释时，常使用 <code>OO</code>，在 <code>Axes</code> 找到对应的位置，直接添加文字，在考虑多张表不规则排放在一张图中时，尤其时嵌套等情况，也会使用 <code>Axes</code> 来规定位置。但是，函数式绘图更加方便与快速，两者结合都掌握才能更好地画出想要的图。</p>
<p><strong>Reference</strong>: <a href="https://blog.csdn.net/Mart_inn/article/details/122352935">Matplotlib入门(一)</a></p>
<h3 id="面向对象编程绘图">2.2.1 面向对象编程绘图</h3>
<p>面向对象 （Object-oriented, <code>OO</code>）绘图灵活，当我们要更改坐标轴相关属性时会倾向于使用面向对象编程绘图，如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots()  </span><br><span class="line">ax.plot(x, x, label=<span class="string">&#x27;linear&#x27;</span>)  </span><br><span class="line">ax.plot(x, x**<span class="number">2</span>, label=<span class="string">&#x27;quadratic&#x27;</span>)  </span><br><span class="line">ax.plot(x, x**<span class="number">3</span>, label=<span class="string">&#x27;cubic&#x27;</span>)  </span><br><span class="line">ax.set_xlabel(<span class="string">&#x27;x label&#x27;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&#x27;y label&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&quot;Simple Plot&quot;</span>)  </span><br><span class="line">ax.legend()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7MhdfI.png' style='zoom:80%' /></p>
<h3 id="函数式绘图">2.2.2 函数式绘图</h3>
<p>函数式绘图则相对而言更便捷：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">plt.plot(x, x, label=<span class="string">&#x27;linear&#x27;</span>)</span><br><span class="line">plt.plot(x, x**<span class="number">2</span>, label=<span class="string">&#x27;quadratic&#x27;</span>)  </span><br><span class="line">plt.plot(x, x**<span class="number">3</span>, label=<span class="string">&#x27;cubic&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;x label&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;y label&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&quot;Simple Plot&quot;</span>)</span><br><span class="line">plt.legend()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7MhdfI.png' style='zoom:80%' /></p>
<h2 id="general-plot-template">2.3 General plot template</h2>
<p>由于 <code>Matplotlib</code> 绘图的知识十分庞杂，在实际使用过程中，不可能将全部的 <code>API</code> 都记住。大部分时候都是边用边查。因此若想精通 <code>Matplotlib</code> 绘图的话，建议养成记笔记的良好习惯，每次绘图时都可以从自己的笔记库中摘抄相应的功能，类似于本人的博客：<a href="https://www.yangsuoly.com/2020/11/30/Matplotlib/">Matplotlib</a>。由于里面记录许多图表类型，因此可以基本满足日常绘图的需求。</p>
<p>此处，就绘图的步骤提供一个通用绘图模板，初学者刚开始学习时只需要牢记这一模板就足以应对大部分简单图表的绘制，在学习过程中可以将这个模板模块化，了解每个模块在做什么，在绘制复杂图表时如何修改，填充对应的模块。</p>
<ul>
<li><p>Steps:</p>
<ol type="1">
<li><p>Prepare data</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">2</span>, <span class="number">100</span>) <span class="comment"># Create 100 numbers</span></span><br><span class="line">y = x ** <span class="number">2</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Style set</p>
<p>设置绘图样式，这一模块的扩展参考第六章进一步学习，这一步不是必须的，样式也可以在绘制图像是进行设置。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mpl.rc(<span class="string">&#x27;lines&#x27;</span>, linewidth=<span class="number">4</span>, linestyle=<span class="string">&#x27;-.&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Define layout</p>
<p>定义布局， 这一模块的扩展参考第三章进一步学习</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, ax = plt.subplots()  </span><br></pre></td></tr></table></figure></p></li>
<li><p>Plot</p>
<p>绘制图像， 这一模块的扩展参考第二章进一步学习</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ax.plot(x, y, label=<span class="string">&#x27;linear&#x27;</span>)  </span><br></pre></td></tr></table></figure></p></li>
<li><p>Tag</p>
<p>添加标签，文字和图例，这一模块的扩展参考第四章进一步学习</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ax.set_xlabel(<span class="string">&#x27;x label&#x27;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&#x27;y label&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&quot;Simple Plot&quot;</span>)  </span><br><span class="line">ax.legend()</span><br></pre></td></tr></table></figure></p></li>
</ol></li>
<li><p><strong>Full code</strong>:</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># step1 准备数据</span></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line">y = x**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step2 设置绘图样式</span></span><br><span class="line">mpl.rc(<span class="string">&#x27;lines&#x27;</span>, linewidth=<span class="number">4</span>, linestyle=<span class="string">&#x27;-.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step3 定义布局， 这一模块的扩展参考第三章进一步学习</span></span><br><span class="line">fig, ax = plt.subplots()  </span><br><span class="line"></span><br><span class="line"><span class="comment"># step4 绘制图像</span></span><br><span class="line">ax.plot(x, y, label=<span class="string">&#x27;linear&#x27;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="comment"># step5 添加标签</span></span><br><span class="line">ax.set_xlabel(<span class="string">&#x27;x label&#x27;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&#x27;y label&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&quot;Simple Plot&quot;</span>)  </span><br><span class="line">ax.legend()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mh36K.png' style='zoom:80%' /></p></li>
</ul>
<h2 id="thinking">2.4 Thinking</h2>
<ul>
<li>请思考两种绘图模式的优缺点和各自适合的使用场景</li>
<li>在第五节绘图模板中我们是以OO模式作为例子展示的，请思考并写一个pyplot绘图模式的简单模板</li>
</ul>
<p>这里借用之前的笔记，用一个稍微复杂点的例子来展示两种绘图模式的区别。</p>
<ol type="1">
<li><p>面向对象编程绘图</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对象式绘图</span></span><br><span class="line"><span class="comment"># pyplot 模块中的 figure() 函数创建名为 fig 的 Figure 对象</span></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Figure 对象中创建一个 Axes 对象，每个 Axes 对象即为一个绘图区域</span></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate data</span></span><br><span class="line">start_val, stop_val, num_val = <span class="number">0</span>, <span class="number">10</span>, <span class="number">1000</span></span><br><span class="line">x = np.linspace(start_val, stop_val, num_val)</span><br><span class="line">y = np.sin(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># y = sin(x)</span></span><br><span class="line"><span class="comment"># &#x27;--g,&#x27;: format_string, equals with a combination of linestyle, color, market, 即折线、绿色、像素点</span></span><br><span class="line">ax.plot(x, y, <span class="string">&#x27;--g&#x27;</span>, lw = <span class="number">2</span>, label = <span class="string">&#x27;sin(x)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整坐标范围</span></span><br><span class="line">x_min, x_max = <span class="number">0</span>, <span class="number">10</span></span><br><span class="line">y_min, y_max = <span class="number">0</span>, <span class="number">1.5</span></span><br><span class="line">ax.set_xlim(x_min, x_max)</span><br><span class="line">ax.set_ylim(y_min, y_max)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置坐标轴标签</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;x轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;y轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">x_location = np.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">x_labels = [<span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;2019-02-01&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="string">&#x27;2019-04-01&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>]</span><br><span class="line">y_location = np.arange(-<span class="number">1</span>, <span class="number">1.5</span>, <span class="number">1</span>)</span><br><span class="line">y_labels = [<span class="string">u&#x27;minimum&#x27;</span>, <span class="string">u&#x27;zero&#x27;</span>, <span class="string">u&#x27;maximum&#x27;</span>]</span><br><span class="line">plt.xticks(x_location, x_labels, rotation = <span class="number">45</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.yticks(y_location, y_labels, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls: linestyle</span></span><br><span class="line">plt.grid(<span class="literal">True</span>, ls = <span class="string">&#x27;:&#x27;</span>, color = <span class="string">&#x27;r&#x27;</span>, alpha = <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;函数式绘图 vs 对象式绘图&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line">plt.legend(loc = <span class="string">&#x27;upper right&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Result:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6Id1.md.png' style='zoom:80%' /></p></li>
<li><p>函数式绘图</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step one: create figure and fix size</span></span><br><span class="line">plt.figure(figsize = (<span class="number">12</span>, <span class="number">6</span>)) <span class="comment"># length x width</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step two: generate data</span></span><br><span class="line">start_val = <span class="number">0</span> <span class="comment"># start value</span></span><br><span class="line">stop_val = <span class="number">10</span> <span class="comment"># end value</span></span><br><span class="line">num_val = <span class="number">1000</span> <span class="comment"># samples number</span></span><br><span class="line">x = np.linspace(start_val, stop_val, num_val)</span><br><span class="line">y = np.sin(x)</span><br><span class="line">plt.plot(x, y, <span class="string">&#x27;--g,&#x27;</span>, lw = <span class="number">2</span>, label = <span class="string">&#x27;$sin(x)$&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step three: adjust axis</span></span><br><span class="line">x_min = <span class="number">0</span></span><br><span class="line">x_max = <span class="number">10</span></span><br><span class="line">y_min = <span class="number">0</span></span><br><span class="line">y_max = <span class="number">1.5</span></span><br><span class="line">plt.xlim(x_min, x_max)</span><br><span class="line">plt.ylim(y_min, y_max)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step four: set axis label</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;x轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;y轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">x_location = np.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">x_labels = [<span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;2019-02-01&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="string">&#x27;2019-04-01&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>]</span><br><span class="line">y_location = np.arange(-<span class="number">1</span>, <span class="number">1.5</span>, <span class="number">1</span>)</span><br><span class="line">y_labels = [<span class="string">u&#x27;minimum&#x27;</span>, <span class="string">u&#x27;zero&#x27;</span>, <span class="string">u&#x27;maximum&#x27;</span>]</span><br><span class="line">plt.xticks(x_location, x_labels, rotation = <span class="number">45</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.yticks(y_location, y_labels, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step five: set grid</span></span><br><span class="line"><span class="comment"># ls: linestyle</span></span><br><span class="line">plt.grid(<span class="literal">True</span>, ls = <span class="string">&#x27;:&#x27;</span>, color = <span class="string">&#x27;r&#x27;</span>, alpha = <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;函数式绘图&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line">plt.legend(loc = <span class="string">&#x27;upper right&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Result:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6Id1.md.png' style='zoom:80%' /></p></li>
</ol>
<h1 id="艺术画笔见乾坤">3. 艺术画笔见乾坤</h1>
<h2 id="matplotlib-原理">3.1 Matplotlib 原理</h2>
<h3 id="绘图步骤">3.1.1 绘图步骤</h3>
<p><code>matplotlib</code> 绘图的原理是借助 <code>Artist</code> 对象在画布 （<code>Canvas</code>） 上绘制 （<code>Render</code>）图形。这与人作画的步骤类似： 1. 准备画布； 2. 准备好颜料、画笔等制图工具； 3. 作画</p>
<p>对应地，<code>Matplotlib</code> 也有三层 <code>API</code>：</p>
<ul>
<li>绘图区：<code>matplotlib.backend_bases.FigureCanvas</code> 代表了绘图区，所有的图像都是在绘图区完成的；</li>
<li>渲染器：<code>matplotlib.backend_bases.Renderer</code> 表示渲染器，可以近似理解为画笔，控制如何在 <code>FigureCanvas</code> 上画图；</li>
<li>图表组件：<code>matplotlib.artist.Artist</code> 代表了具体的图表组件，即调用了 <code>Renderer</code> 的接口在 <code>Canvas</code> 上作图。</li>
<li>前两者处理程序和计算机的底层交互的事项，第三项 <code>Artist</code> 就是具体的调用接口来做出我们想要的图，比如图形、文本、线条的设定。所以通常来说，我们 <code>95%</code> 的时间，都是用来和 <code>matplotlib.artist.Artist</code> 类打交道的。</li>
</ul>
<h3 id="artist-分类">3.1.2 <code>Artist</code> 分类</h3>
<p><code>Artist</code> 有两种类型： - <code>primitives</code></p>
<pre><code>基本要素，它包含一些我们要在绘图区作图用到的标准图形对象，如曲线 `Line2D`，文字 `Text`，矩形 `Rectangle`，图像 `Image` 等。</code></pre>
<ul>
<li><p><code>containers</code>;</p>
<p>容器，用来装基本要素的地方，包括图形 <code>Figure</code>、坐标系 <code>Axes</code> 和坐标轴 <code>Axis</code>。他们之间的关系如下所示：</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M67i6.png' style='zoom:80%' /></p></li>
</ul>
<p>可视化中，常见的 <code>Artist</code> 类可以参考下表。</p>
<center>
Fig. 1 Aritist object
</center>
<table>
<thead>
<tr class="header">
<th>Axes helper method</th>
<th>Artist</th>
<th>Container</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>bar</code> - bar charts</td>
<td><code>Rectangle</code></td>
<td>ax.patches</td>
</tr>
<tr class="even">
<td><code>errorbar</code> - error bar plots</td>
<td><code>Line2D</code> and <code>Rectangle</code></td>
<td>ax.lines and ax.patches</td>
</tr>
<tr class="odd">
<td><code>fill</code> - shared area</td>
<td><code>Polygon</code></td>
<td>ax.patches</td>
</tr>
<tr class="even">
<td><code>hist</code> - histograms</td>
<td><code>Rectangle</code></td>
<td>ax.patches</td>
</tr>
<tr class="odd">
<td><code>imshow</code> - image data</td>
<td><code>AxesImage</code></td>
<td>ax.images</td>
</tr>
<tr class="even">
<td><code>plot</code> - xy plots</td>
<td><code>Line2D</code></td>
<td>ax.lines</td>
</tr>
<tr class="odd">
<td><code>scatter</code> - scatter charts</td>
<td><code>PolyCollection</code></td>
<td>ax.collections</td>
</tr>
</tbody>
</table>
<p>三列各自的含义分别表示：</p>
<ul>
<li><p><code>Axes helper method</code></p>
<p>表示 <code>Matplotlib</code> 中子图上的辅助方法，可以理解为可视化中不同种类的图表类型，如柱状图，折线图，直方图等，这些图表都可以用这些辅助方法绘制。</p></li>
<li><p><code>Artist</code></p>
<p>表示图表背后的 <code>Artist</code> 类，比如折线图方法 <code>plot</code> 在底层用到的就是 <code>Line2D</code> 这一 <code>Artist</code> 类。</p></li>
<li><p><code>Container</code></p>
<p>表示 <code>Artist</code> 的列表容器，例如所有在子图中创建的 <code>Line2D</code> 对象都会被自动收集到 <code>ax.lines</code> 返回的列表中。</p></li>
</ul>
<p>后面的案列内容会更清楚地阐述这三者之间的关系。通常情况下，我们只需记住第一列的辅助方法及逆行绘图即可，而无需关注其底层具体用了什么类。但是了解底层类有助于我们绘制一些复杂的图表。</p>
<h2 id="primitives-基本元素">3.2 <code>Primitives</code> 基本元素</h2>
<p>各个容器中可能会包含多种 <code>primitives</code> 基本元素，所以此处先介绍 <code>primitives</code>，再介绍容器 <code>container</code>。 <code>primitives</code> 主要包含如下种类：</p>
<ul>
<li>曲线 <code>Line2D</code>；</li>
<li>矩形 <code>Rectangle</code>；</li>
<li>多边形 <code>Polygon</code>；</li>
<li>图像 <code>image</code></li>
</ul>
<h3 id="dlines">3.2.1 <code>2Dlines</code></h3>
<p><code>Matplotlib</code> 中曲线的绘制主要通过类 <code>matplotlib.lines.line2D</code> 来完成。其中线 <code>line</code> 的含义：它表示的可以是连接所有顶点的实现央视，也可以是每个顶点的标记。此外，这条线也会受到会话风格的影响，比如，我们可以创建虚线种类的线。</p>
<p>它的构造函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">matplotlib</span>.<span class="title">lines</span>.<span class="title">Line2D</span>(<span class="params">xdata, ydata, linewidth=<span class="literal">None</span>, linestyle=<span class="literal">None</span>, color=<span class="literal">None</span>, marker=<span class="literal">None</span>, markersize=<span class="literal">None</span>, markeredgewidth=<span class="literal">None</span>, markeredgecolor=<span class="literal">None</span>, markerfacecolor=<span class="literal">None</span>, markerfacecoloralt=<span class="string">&#x27;none&#x27;</span>, fillstyle=<span class="literal">None</span>, antialiased=<span class="literal">None</span>, dash_capstyle=<span class="literal">None</span>, solid_capstyle=<span class="literal">None</span>, dash_joinstyle=<span class="literal">None</span>, solid_joinstyle=<span class="literal">None</span>, pickradius=<span class="number">5</span>, drawstyle=<span class="literal">None</span>, markevery=<span class="literal">None</span>, **kwargs</span>)</span></span><br></pre></td></tr></table></figure>
<p>其中常用的参数有： - <code>xdata</code>：需要绘制的 <code>line</code> 中点在 <code>x</code> 轴上的取值，若忽略，则默认为 <code>range(1, len(ydata)+1)</code>； - <code>ydata</code>：需要绘制的 <code>line</code> 中点的在 <code>y</code> 轴上的取值； - <code>linewidth</code>：线条的宽度； - <code>linewidth</code>：线条的宽度； - <code>linestyle</code>：线性； - <code>color</code>：线条的颜色； - <code>marker</code>：点的标记，详细可参考 <a href="https://matplotlib.org/api/markers_api.html#module-matplotlib.markers">markers API</a> - <code>markersize</code>：标记的 <code>size</code></p>
<p>更多参数说明可查看 <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.lines.Line2D.html">Line2D 官方文档</a></p>
<p><strong>Load modules</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> matplotlib.lines <span class="keyword">import</span> Line2D   </span><br><span class="line"><span class="keyword">from</span> matplotlib.patches <span class="keyword">import</span> Circle, Wedge</span><br><span class="line"><span class="keyword">from</span> matplotlib.collections <span class="keyword">import</span> PatchCollection</span><br><span class="line"></span><br><span class="line"><span class="comment"># plt.figure(dpi=300,figsize=(12,8))</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;figure.figsize&#x27;</span>]=(<span class="number">12</span>,<span class="number">8</span>) <span class="comment"># 预设图片大小</span></span><br></pre></td></tr></table></figure>
<ol type="1">
<li><p><strong>如何设置 <code>Line2D</code> 的属性</strong></p>
<p>可以通过如下方式设置线的属性：</p>
<ul>
<li><p>直接在 <code>plot()</code> 函数中设置；</p>
<p>借助 <code>plot</code> 函数的参数，可以便捷地设置属性。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line">y = [<span class="number">2</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">10</span>]</span><br><span class="line">plt.plot(x, y, linewidth = <span class="number">10</span>) <span class="comment"># 设置线的粗细参数为 10</span></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6oIx.png' style='zoom:80%' /></p></li>
<li><p>通过获得线对象，对线对象进行设置；</p>
<p>借助面向对象编程，先获取线对象，然后对其属性进行设置。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line">y = [<span class="number">2</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line">line, = plt.plot(x, y, <span class="string">&#x27;-&#x27;</span>) <span class="comment"># 这里等号坐标的line,是一个列表解包的操作，目的是获取plt.plot返回列表中的Line2D对象</span></span><br><span class="line">line.set_antialiased(<span class="literal">False</span>); <span class="comment"># 关闭抗锯齿功能</span></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6fsJ.md.png' style='zoom:80%' /></p>
<p><strong>Note</strong>：注意到这里使用了 <code>line</code> 来存储 <code>plt.plot()</code> 的返回对象，这里等号左边的 <code>line</code> 是一个解包的操作，目的是获取 <code>plt.plot</code> 返回列表中的 <code>Line2D</code> 对象，特别地，<code>plt.plot</code> 的返回为:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&lt;matplotlib.lines.Line2D at 0x248e34d2760&gt;]</span><br></pre></td></tr></table></figure></p></li>
<li><p>获得线对象，使用 <code>setp()</code> 函数设置</p>
<p>也可以先获得线属性，然后使用 <code>setp</code> 函数（<code>set property</code>）设置。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line">y = [<span class="number">2</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line">lines = plt.plot(x, y)</span><br><span class="line">plt.setp(lines, color=<span class="string">&#x27;r&#x27;</span>, linewidth=<span class="number">10</span>)</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7MhEOU.png' style='zoom:80%' /></p></li>
</ul></li>
<li><p><strong>如何绘制</strong> <code>lines</code></p>
<p><strong>1）绘制直线 <code>line</code></strong>；</p>
<p>首先介绍两种绘制直线 <code>line</code> 常用的方法：</p>
<ul>
<li><p><code>plot</code> 方法绘制</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. plot方法绘制</span></span><br><span class="line">x = <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line">y1 = [<span class="number">2</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line">y2= [<span class="number">3</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">11</span>]</span><br><span class="line"></span><br><span class="line">fig,ax= plt.subplots()</span><br><span class="line">ax.plot(x,y1)</span><br><span class="line">ax.plot(x,y2) <span class="comment"># 通过直接使用辅助方法画线</span></span><br><span class="line">plt.show()</span><br><span class="line">print(ax.lines);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mhhpq.md.png' style='zoom:80%' /></p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&lt;matplotlib.lines.Line2D object at 0x00000248E374F0A0&gt;, &lt;matplotlib.lines.Line2D object at 0x00000248E374FF40&gt;]</span><br></pre></td></tr></table></figure></p>
<p>通过直接使用辅助方法画线，打印 <code>ax.lines</code> 后可以看到在 <code>matplotlib</code> 在底层创建了两个 <code>Line2D</code> 对象</p></li>
<li><p><code>Line2D</code> 对象绘制</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line">y1 = [<span class="number">2</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line">y2= [<span class="number">3</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">11</span>]</span><br><span class="line">fig,ax= plt.subplots()</span><br><span class="line">lines = [Line2D(x, y1), Line2D(x, y2,color=<span class="string">&#x27;orange&#x27;</span>)]  <span class="comment"># 显式创建Line2D对象</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">    ax.add_line(line) <span class="comment"># 使用add_line方法将创建的Line2D添加到子图中</span></span><br><span class="line">ax.set_xlim(<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line">ax.set_ylim(<span class="number">2</span>, <span class="number">11</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>2）<code>errorbar</code> 绘制误差折线图；</p>
<p><code>pyplot</code> 里有个专门绘制误差线的功能，通过 <code>errorbar</code> 类实现，它的构造函数：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">matplotlib.pyplot.errorbar(x, y, yerr=<span class="literal">None</span>, xerr=<span class="literal">None</span>, fmt=<span class="string">&#x27;&#x27;</span>, ecolor=<span class="literal">None</span>, elinewidth=<span class="literal">None</span>, capsize=<span class="literal">None</span>, barsabove=<span class="literal">False</span>, lolims=<span class="literal">False</span>, uplims=<span class="literal">False</span>, xlolims=<span class="literal">False</span>, xuplims=<span class="literal">False</span>, errorevery=<span class="number">1</span>, capthick=<span class="literal">None</span>, *, data=<span class="literal">None</span>, **kwargs)</span><br></pre></td></tr></table></figure></p>
<p>其中最主要的参数包括：</p>
<ul>
<li><strong>x</strong>：需要绘制的 <code>line</code> 中点的在 <code>x</code> 轴上的取值<br />
</li>
<li><strong>y</strong>：需要绘制的 <code>line</code> 中点的在 <code>y</code> 轴上的取值<br />
</li>
<li><strong>yerr</strong>：指定 <code>y</code> 轴水平的误差<br />
</li>
<li><strong>xerr</strong>：指定 <code>x</code> 轴水平的误差<br />
</li>
<li><strong>fmt</strong>：指定折线图中某个点的颜色，形状，线条风格，例如 <code>co--</code><br />
</li>
<li><strong>ecolor</strong>：指定 <code>error bar</code> 的颜色<br />
</li>
<li><strong>elinewidth</strong>：指定 <code>error bar</code> 的线条宽度</li>
</ul>
<p>**绘制 <code>errorbar</code>：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">x = np.arange(<span class="number">10</span>)</span><br><span class="line">y = <span class="number">2.5</span> * np.sin(x / <span class="number">20</span>* np.pi)</span><br><span class="line">yerr = np.linspace(<span class="number">0.05</span>, <span class="number">0.2</span>, <span class="number">10</span>)</span><br><span class="line">plt.errorbar(x, y + <span class="number">3</span>, yerr = yerr, label = <span class="string">&#x27;both limits (default)&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<p>Result:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McJm9.md.png' style='zoom:80%' /></p></li>
</ol>
<h3 id="patches">3.2.2 <code>patches</code></h3>
<p><code>matplotlib.patches.Patch</code> 类是二维图形类，并且它是众多二维图形的负类，它的所有子类见 <a href="https://matplotlib.org/stable/api/patches_api.html">matplotlib.patches API</a>，<code>Patch</code> 类的构造函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Patch(edgecolor=<span class="literal">None</span>, facecolor=<span class="literal">None</span>, color=<span class="literal">None</span>, linewidth=<span class="literal">None</span>, linestyle=<span class="literal">None</span>, antialiased=<span class="literal">None</span>, hatch=<span class="literal">None</span>, fill=<span class="literal">True</span>, capstyle=<span class="literal">None</span>, joinstyle=<span class="literal">None</span>, **kwargs)</span><br></pre></td></tr></table></figure>
<p>本小节主要聚焦三种最常见的子类，矩形、多边形和楔形。</p>
<ol type="1">
<li><p><code>Rectangle</code>-矩形</p>
<p><code>Rectangle</code> 矩形类在官网中的定义是：通过描点 <code>xy</code> 及宽度和高度生成。<code>Rectangle</code> 本身主要比较简单，即 <code>xy</code> 控制描点，<code>width</code> 和 <code>height</code> 分别控制宽和高。它的构造函数：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">matplotlib</span>.<span class="title">patches</span>.<span class="title">Rectangle</span>(<span class="params">xy, width, height, angle=<span class="number">0.0</span>, **kwargs</span>)</span></span><br></pre></td></tr></table></figure></p>
<p>在实际使用过程中最常用的是 <strong><code>hist</code> 直方图</strong> 和 <strong><code>bar</code> 条形图</strong>。</p>
<ul>
<li><p><code>hist</code> 直方图</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">matplotlib.pyplot.hist(x,bins=<span class="literal">None</span>,<span class="built_in">range</span>=<span class="literal">None</span>, density=<span class="literal">None</span>, bottom=<span class="literal">None</span>, histtype=<span class="string">&#x27;bar&#x27;</span>, align=<span class="string">&#x27;mid&#x27;</span>, log=<span class="literal">False</span>, color=<span class="literal">None</span>, label=<span class="literal">None</span>, stacked=<span class="literal">False</span>, normed=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure></p>
<p>常用参数及含义：</p>
<ul>
<li><strong>x</strong>: 数据集，最终的直方图将对数据集进行统计</li>
<li><strong>bins</strong>: 统计的区间分布</li>
<li><strong>range</strong>: <code>tuple</code>, 显示的区间，<code>range</code> 在没有给出 <code>bins</code> 时生效</li>
<li><strong>density</strong>: <code>bool</code>，默认为 <code>false</code>，显示的是频数统计结果，为 <code>True</code> 则显示频率统计结果，这里需要注意，频率统计结果=区间数目/(总数*区间宽度)，和 <code>normed</code> 效果一致，官方推荐使用 <code>density</code></li>
<li><strong>histtype</strong>: 可选{<code>bar</code>, <code>barstacked</code>, <code>step</code>, <code>stepfilled</code>}之一，默认为 <code>bar</code>，推荐使用默认配置，<code>step</code> 使用的是梯状，<code>stepfilled</code> 则会对梯状内部进行填充，效果与 <code>bar</code> 类似</li>
<li><strong>align</strong>: 可选{<code>left</code>, <code>mid</code>, <code>right</code>}之一，默认为 <code>mid</code>，控制柱状图的水平分布，<code>left</code> 或者 <code>right</code>，会有部分空白区域，推荐使用默认</li>
<li><strong>log</strong>: <code>bool</code>，默认 <code>False</code>,即 <code>y</code> 坐标轴是否选择指数刻度</li>
<li><strong>stacked</strong>: <code>bool</code>，默认为 <code>False</code>，是否为堆积状图</li>
</ul>
<p>**借助 <code>hist</code> 绘制直方图：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x=np.random.randint(<span class="number">0</span>,<span class="number">100</span>,<span class="number">100</span>) <span class="comment"># 生成[0-100)之间的100个数据,即 数据集</span></span><br><span class="line">bins=np.arange(<span class="number">0</span>,<span class="number">101</span>,<span class="number">10</span>) <span class="comment"># 设置连续的边界值，即直方图的分布区间 [0,10), [10,20).</span></span><br><span class="line">plt.hist(x,bins,color=<span class="string">&#x27;fuchsia&#x27;</span>,alpha=<span class="number">0.5</span>) <span class="comment"># alpha设置透明度，0为完全透明</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;scores&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">plt.xlim(<span class="number">0</span>,<span class="number">100</span>); <span class="comment"># 设置x轴分布范围</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mc8OJ.md.png' style='zoom:80%' /></p>
<p><strong><code>Rectangle</code> 矩阵类绘制直方图</strong>：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(columns = [<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line">df.loc[:,<span class="string">&#x27;data&#x27;</span>] = x</span><br><span class="line">df[<span class="string">&#x27;fenzu&#x27;</span>] = pd.cut(df[<span class="string">&#x27;data&#x27;</span>], bins=bins, right = <span class="literal">False</span>,include_lowest=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">df_cnt = df[<span class="string">&#x27;fenzu&#x27;</span>].value_counts().reset_index()</span><br><span class="line">df_cnt.loc[:,<span class="string">&#x27;mini&#x27;</span>] = df_cnt[<span class="string">&#x27;index&#x27;</span>].astype(<span class="built_in">str</span>).<span class="built_in">map</span>(<span class="keyword">lambda</span> x:re.findall(<span class="string">&#x27;\[(.*)\,&#x27;</span>,x)[<span class="number">0</span>]).astype(<span class="built_in">int</span>)</span><br><span class="line">df_cnt.loc[:,<span class="string">&#x27;maxi&#x27;</span>] = df_cnt[<span class="string">&#x27;index&#x27;</span>].astype(<span class="built_in">str</span>).<span class="built_in">map</span>(<span class="keyword">lambda</span> x:re.findall(<span class="string">&#x27;\,(.*)\)&#x27;</span>,x)[<span class="number">0</span>]).astype(<span class="built_in">int</span>)</span><br><span class="line">df_cnt.loc[:,<span class="string">&#x27;width&#x27;</span>] = df_cnt[<span class="string">&#x27;maxi&#x27;</span>]- df_cnt[<span class="string">&#x27;mini&#x27;</span>]</span><br><span class="line">df_cnt.sort_values(<span class="string">&#x27;mini&#x27;</span>,ascending = <span class="literal">True</span>,inplace = <span class="literal">True</span>)</span><br><span class="line">df_cnt.reset_index(inplace = <span class="literal">True</span>,drop = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#用Rectangle把hist绘制出来</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> df_cnt.index:</span><br><span class="line">    rect =  plt.Rectangle((df_cnt.loc[i,<span class="string">&#x27;mini&#x27;</span>],<span class="number">0</span>),df_cnt.loc[i,<span class="string">&#x27;width&#x27;</span>],df_cnt.loc[i,<span class="string">&#x27;fenzu&#x27;</span>])</span><br><span class="line">    ax1.add_patch(rect)</span><br><span class="line"></span><br><span class="line">ax1.set_xlim(<span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">ax1.set_ylim(<span class="number">0</span>, <span class="number">16</span>)</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mc3y4.md.png' style='zoom:80%' /></p></li>
<li><p><code>bar</code> 柱状图</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">matplotlib.pyplot.bar(left, height, alpha=<span class="number">1</span>, width=<span class="number">0.8</span>, color=, edgecolor=, label=, lw=<span class="number">3</span>)</span><br></pre></td></tr></table></figure></p>
<p>常用的参数：</p>
<ul>
<li><strong>left</strong>：x轴的位置序列，一般采用range函数产生一个序列，但是有时候可以是字符串<br />
</li>
<li><strong>height</strong>：y轴的数值序列，也就是柱形图的高度，一般就是我们需要展示的数据；<br />
</li>
<li><strong>alpha</strong>：透明度，值越小越透明<br />
</li>
<li><strong>width</strong>：为柱形图的宽度，一般这是为0.8即可；<br />
</li>
<li><strong>color或facecolor</strong>：柱形图填充的颜色；<br />
</li>
<li><strong>edgecolor</strong>：图形边缘颜色<br />
</li>
<li><strong>label</strong>：解释每个图像代表的含义，这个参数是为legend()函数做铺垫的，表示该次bar的标签</li>
</ul>
<p>与上述类似，同样有两种方式绘制柱状图：</p>
<ul>
<li><code>bar</code> 绘制柱状图<br />
</li>
<li><code>Rectangle</code>矩形类绘制柱状图</li>
</ul>
<p><strong><code>bar</code> 绘制柱状图</strong></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y = <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">17</span>)</span><br><span class="line">plt.bar(np.arange(<span class="number">16</span>), y, alpha=<span class="number">0.5</span>, width=<span class="number">0.5</span>, color=<span class="string">&#x27;yellow&#x27;</span>, edgecolor=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;The First Bar&#x27;</span>, lw=<span class="number">3</span>);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mc1lF.md.png' style='zoom:80%' /></p>
<p><strong><code>Rectangle</code></strong></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">17</span>):</span><br><span class="line">  rect = plt.Rectangle((i+<span class="number">0.25</span>, <span class="number">0</span>), <span class="number">0.5</span>, i)</span><br><span class="line">  ax1.add_patch(rect)</span><br><span class="line">ax1.set_xlim(<span class="number">0</span>, <span class="number">16</span>)</span><br><span class="line">ax1.set_ylim(<span class="number">0</span>, <span class="number">16</span>);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7MclSU.md.png' style='zoom:80%' /></p></li>
</ul></li>
<li><p><code>Polygon</code>-多边形</p>
<p><code>matplotlib.patches.Polygon</code> 类是多边形类，它的构造函数：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">matplotlib</span>.<span class="title">patches</span>.<span class="title">Polygon</span>(<span class="params">xy, closed=<span class="literal">True</span>, **kwargs</span>)</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>xy</code> 是一个 <span class="math inline">\(N \times 2\)</span> 的 <code>numpy.array</code>，为多边形的顶点。</li>
<li><code>closed</code> 为 <code>True</code> 则制定多边形将起点和终点重合从而显式关闭多边形。</li>
</ul>
<p><code>matplotlib.patches.Polygon</code> 类中常用的是 <code>fill</code> 类，它是基于 <code>xy</code> 绘制一个填充的多边形，它的定义：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">matplotlib.pyplot.fill(args, data=<span class="literal">None</span>, *kwargs)</span><br></pre></td></tr></table></figure></p>
<p>参数说明：关于 <code>x</code>、<code>y</code> 和 <code>color</code> 的序列，其中 <code>color</code> 是可选的参数，每个多边形都是由其他节点的 <code>x</code> 和 <code>y</code> 位置列表定义，后面可以选择一个颜色说明符。</p>
<p><strong>用 <code>fill</code> 来绘制图形</strong></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">5</span>*np.pi, <span class="number">1000</span>)</span><br><span class="line">y1 = np.sin(x)</span><br><span class="line">y2 = np.sin(<span class="number">2</span>*x)</span><br><span class="line">plt.fill(x, y1, color = <span class="string">&#x27;g&#x27;</span>, alpha = <span class="number">0.3</span>);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McMWT.md.png' style='zoom:80%' /></p></li>
<li><p><code>Wedge</code>-楔形</p>
<p><code>matplotlib.patches.Wedge</code> 类是楔形类，构造函数为：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">matplotlib</span>.<span class="title">patches</span>.<span class="title">Wedge</span>(<span class="params">center, r, theta1, theta2, width=<span class="literal">None</span>, **kwargs</span>)</span></span><br></pre></td></tr></table></figure></p>
<p>一个 <code>Wedge</code>-楔形是以坐标 <code>x, y</code> 为中心，半径为 <code>r</code>，从 <span class="math inline">\(\theta_1\)</span> 扫到 <span class="math inline">\(\theta_2\)</span>（单位是度）。如果宽度给定，则从内半径 <code>r</code>-宽度 到外半径 <code>r</code> 画出部分楔形。<code>wedge</code> 中比较常见的是绘制饼状图。</p>
<p><strong>以绘制饼图为例</strong>。通常我们可以使用 <code>matplotlib.pyplot.pie</code> 直接绘制饼图，其构造函数有如下：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">matplotlib.pyplot.pie(x, explode=<span class="literal">None</span>, labels=<span class="literal">None</span>, colors=<span class="literal">None</span>, autopct=<span class="literal">None</span>, pctdistance=<span class="number">0.6</span>, shadow=<span class="literal">False</span>, labeldistance=<span class="number">1.1</span>, startangle=<span class="number">0</span>, radius=<span class="number">1</span>, counterclock=<span class="literal">True</span>, wedgeprops=<span class="literal">None</span>, textprops=<span class="literal">None</span>, center=<span class="number">0</span>, <span class="number">0</span>, frame=<span class="literal">False</span>, rotatelabels=<span class="literal">False</span>, *, normalize=<span class="literal">None</span>, data=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure></p>
<p>制作数据 <code>x</code> 的饼图，每个楔子的面积用 <code>x/sum(x)</code> 表示。其主要的参数是前四个：</p>
<ul>
<li><strong>x</strong>：契型的形状，一维数组。</li>
<li><strong>explode</strong>：如果不是等于 <code>None</code>，则是一个 <code>len(x)</code> 数组，它指定用于偏移每个楔形块的半径的分数；</li>
<li><strong>labels</strong>：用于指定每个契型块的标记，取值是列表或为 <code>None</code>；</li>
<li><strong>colors</strong>：饼图循环使用的颜色序列。如果取值为 <code>None</code>，将使用当前活动循环中的颜色；</li>
<li><strong>startangle</strong>：饼状图开始的绘制的角度。</li>
</ul>
<p><strong><code>pie</code> 函数绘制饼图</strong>：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">labels = <span class="string">&#x27;Frogs&#x27;</span>, <span class="string">&#x27;Hogs&#x27;</span>, <span class="string">&#x27;Dogs&#x27;</span>, <span class="string">&#x27;Logs&#x27;</span></span><br><span class="line">sizes = [<span class="number">15</span>, <span class="number">30</span>, <span class="number">45</span>, <span class="number">10</span>]</span><br><span class="line">explode = (<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">fig1, ax1 = plt.subplots()</span><br><span class="line">ax1.pie(sizes, explode=explode, labels=labels, autopct=<span class="string">&#x27;%1.1f%%&#x27;</span>, shadow=<span class="literal">True</span>, startangle=<span class="number">90</span>)</span><br><span class="line">ax1.axis(<span class="string">&#x27;equal&#x27;</span>); <span class="comment"># Equal aspect ratio ensures that pie is drawn as a circle.</span></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McKYV.md.png' style='zoom:80%' /></p>
<p><strong><code>wedge</code> 绘制饼图</strong></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure(figsize=(<span class="number">5</span>,<span class="number">5</span>))</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">theta1 = <span class="number">0</span></span><br><span class="line">sizes = [<span class="number">15</span>, <span class="number">30</span>, <span class="number">45</span>, <span class="number">10</span>]</span><br><span class="line">patches = []</span><br><span class="line">patches += [</span><br><span class="line">    Wedge((<span class="number">0.5</span>, <span class="number">0.5</span>), <span class="number">.4</span>, <span class="number">0</span>, <span class="number">54</span>),           </span><br><span class="line">    Wedge((<span class="number">0.5</span>, <span class="number">0.5</span>), <span class="number">.4</span>, <span class="number">54</span>, <span class="number">162</span>),  </span><br><span class="line">    Wedge((<span class="number">0.5</span>, <span class="number">0.5</span>), <span class="number">.4</span>, <span class="number">162</span>, <span class="number">324</span>),           </span><br><span class="line">    Wedge((<span class="number">0.5</span>, <span class="number">0.5</span>), <span class="number">.4</span>, <span class="number">324</span>, <span class="number">360</span>),  </span><br><span class="line">]</span><br><span class="line">colors = <span class="number">100</span> * np.random.rand(<span class="built_in">len</span>(patches))</span><br><span class="line">p = PatchCollection(patches, alpha=<span class="number">0.8</span>)</span><br><span class="line">p.set_array(colors)</span><br><span class="line">ax1.add_collection(p);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McuF0.png' style='zoom:80%' /></p></li>
</ol>
<h3 id="collection">3.2.3 <code>collection</code></h3>
<p><code>collections</code> 类是用来绘制一组对象的集合，<code>collections</code> 有许多不同的子类，如 <code>RegularPolyCollection</code>，<code>CircleCollection</code>, <code>Pathcollection</code>，分别对应不同的集合子类型。其中比较常用的是散点图，它是属于 <code>PathCollection</code> 子类，<code>scatter</code> 方法提供了该类的封装，根据 <code>x</code> 与 <code>y</code> 绘制不同大小或颜色标记的散点图。它的构造方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Axes.scatter(self, x, y, s=<span class="literal">None</span>, c=<span class="literal">None</span>, marker=<span class="literal">None</span>, cmap=<span class="literal">None</span>, norm=<span class="literal">None</span>, vmin=<span class="literal">None</span>, vmax=<span class="literal">None</span>, alpha=<span class="literal">None</span>, linewidths=<span class="literal">None</span>, verts=, edgecolors=<span class="literal">None</span>, , plotnonfinite=<span class="literal">False</span>, data=<span class="literal">None</span>, *kwargs)</span><br></pre></td></tr></table></figure>
<p>主要参数为： + <strong>x</strong>：数据点x轴的位置<br />
+ <strong>y</strong>：数据点y轴的位置<br />
+ <strong>s</strong>：尺寸大小<br />
+ <strong>c</strong>：可以是单个颜色格式的字符串，也可以是一系列颜色<br />
+ <strong>marker</strong>: 标记的类型</p>
<p><strong>用 <code>scatter</code> 绘制散点图</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = [<span class="number">0</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line">y = [<span class="number">10</span>]*<span class="built_in">len</span>(x)</span><br><span class="line">s = [<span class="number">20</span>*<span class="number">2</span>**n <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line">plt.scatter(x,y,s=s) ;</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mcewn.md.png' style='zoom:80%' /></p>
<h3 id="images">3.2.4 <code>images</code></h3>
<p><code>images</code> 是 <code>matplotlib</code> 中绘制 <code>image</code> 图像的类，其构造函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">matplotlib</span>.<span class="title">image</span>.<span class="title">AxesImage</span>(<span class="params">ax, cmap=<span class="literal">None</span>, norm=<span class="literal">None</span>, interpolation=<span class="literal">None</span>, origin=<span class="literal">None</span>, extent=<span class="literal">None</span>, filternorm=<span class="literal">True</span>, filterrad=<span class="number">4.0</span>, resample=<span class="literal">False</span>, **kwargs</span>)</span></span><br></pre></td></tr></table></figure>
<p>最常用的 <code>imshow</code> 可以根据数组绘制成图像，它的构造函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">matplotlib.pyplot.imshow(X, cmap=<span class="literal">None</span>, norm=<span class="literal">None</span>, aspect=<span class="literal">None</span>, interpolation=<span class="literal">None</span>, alpha=<span class="literal">None</span>, vmin=<span class="literal">None</span>, vmax=<span class="literal">None</span>, origin=<span class="literal">None</span>, extent=<span class="literal">None</span>, shape=, filternorm=<span class="number">1</span>, filterrad=<span class="number">4.0</span>, imlim=, resample=<span class="literal">None</span>, url=<span class="literal">None</span>, , data=<span class="literal">None</span>, *kwargs)</span><br></pre></td></tr></table></figure>
<p>使用 <code>imshow</code> 画图时首先需要传入一个数组，数组对应的是空间内的像素位置和像素点的值，<code>interpolation</code> 参数可以设置不同的插值方法，具体效果如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">methods = [<span class="literal">None</span>, <span class="string">&#x27;none&#x27;</span>, <span class="string">&#x27;nearest&#x27;</span>, <span class="string">&#x27;bilinear&#x27;</span>, <span class="string">&#x27;bicubic&#x27;</span>, <span class="string">&#x27;spline16&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;spline36&#x27;</span>, <span class="string">&#x27;hanning&#x27;</span>, <span class="string">&#x27;hamming&#x27;</span>, <span class="string">&#x27;hermite&#x27;</span>, <span class="string">&#x27;kaiser&#x27;</span>, <span class="string">&#x27;quadric&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;catrom&#x27;</span>, <span class="string">&#x27;gaussian&#x27;</span>, <span class="string">&#x27;bessel&#x27;</span>, <span class="string">&#x27;mitchell&#x27;</span>, <span class="string">&#x27;sinc&#x27;</span>, <span class="string">&#x27;lanczos&#x27;</span>]</span><br><span class="line"></span><br><span class="line">grid = np.random.rand(<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">fig, axs = plt.subplots(nrows=<span class="number">3</span>, ncols=<span class="number">6</span>, figsize=(<span class="number">9</span>, <span class="number">6</span>),</span><br><span class="line">                        subplot_kw=&#123;<span class="string">&#x27;xticks&#x27;</span>: [], <span class="string">&#x27;yticks&#x27;</span>: []&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ax, interp_method <span class="keyword">in</span> <span class="built_in">zip</span>(axs.flat, methods):</span><br><span class="line">    ax.imshow(grid, interpolation=interp_method, cmap=<span class="string">&#x27;viridis&#x27;</span>)</span><br><span class="line">    ax.set_title(<span class="built_in">str</span>(interp_method))</span><br><span class="line"></span><br><span class="line">plt.tight_layout();</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mcmoq.md.png' style='zoom:80%' /></p>
<p><strong>Note</strong>：其中，<code>nrows</code> 和 <code>ncols</code> 分别表示子图的行和列，此处表示 <code>3</code> 行 <code>6</code> 列。返回值 <code>axs</code> 为 <code>18</code> 个子图，因此可以通过 <code>for</code> 循环对其进行遍历，并对各个子图的属性进行修改。</p>
<h2 id="object-container-对象容器">3.3 Object container 对象容器</h2>
<p>容器会包含一些 <code>primitives</code>，并且容器还有它自身的属性。<br />
比如 <code>Axes Artist</code>，它是一种容器，它包含了很多 <code>primitives</code>，比如 <code>Line2D</code>，<code>Text</code>；同时，它也有自身的属性，比如 <code>xscal</code>，用来控制X轴是 <code>linear</code> 还是 <code>log</code> 的。</p>
<h3 id="figure-容器">3.3.1 <code>Figure</code> 容器</h3>
<p><code>matplotlib.figure.Figure</code> 是 <code>Artist</code> 最顶层的 <code>container</code> -对象容器，它包含了图表中的所有元素。一张图表的背景就是在 <code>Figure.patch</code> 的一个矩形 <code>Rectangle</code>。<br />
当我们向图表添加 <code>Figure.add_subplot()</code> 或者 <code>Figure.add_axes()</code> 元素时，这些都会被添加到 <code>Figure.axes</code> 列表中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">211</span>) <span class="comment"># 作一幅2*1的图，选择第1个子图</span></span><br><span class="line">ax2 = fig.add_axes([<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.7</span>, <span class="number">0.3</span>]) <span class="comment"># 位置参数，四个数分别代表了(left,bottom,width,height)</span></span><br><span class="line">print(ax1)</span><br><span class="line">print(fig.axes) <span class="comment"># fig.axes 中包含了subplot和axes两个实例, 刚刚添加的</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McELj.md.png' style='zoom:80%' /></p>
<ul>
<li><p><strong>Note</strong>：</p>
<p>我们发现，这里面得到的两个子图没有对齐，这是为什么呢？因为 <code>add_axes</code> 是以 <code>figure</code> 容器为基准进行对齐的。</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McZes.md.png' style='zoom:80%' /></p>
<p>接下来，为了突出两种方式的区别，我们对图形重新绘制：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">211</span>) <span class="comment"># 作一幅2*1的图，选择第1个子图</span></span><br><span class="line">ax1 = fig.add_subplot(<span class="number">212</span>)</span><br><span class="line">ax2 = fig.add_axes([<span class="number">0.0</span>, <span class="number">0.</span>, <span class="number">0.7</span>, <span class="number">0.3</span>]) <span class="comment"># 位置参数，四个数分别代表了(left,bottom,width,height)</span></span><br><span class="line">print(ax1)</span><br><span class="line">print(fig.axes) <span class="comment"># fig.axes 中包含了subplot和axes两个实例, 刚刚添加的</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McAyQ.md.png' style='zoom:80%' /></p>
<p>可以发现，两个的基准对齐位置不同，可以理解为，<code>add_subplot</code> 是重新创建了一个 <code>subplot</code> 容器，因此，在基于此函数进行增添子图的时候，是在容器内部进行对齐。而 <code>add_axes</code> 则默认是基于 <code>figure</code> 进行操作和对齐。如果要在这种情况下进行对齐，可以首先获得 <code>subplot</code> 的位置信息。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">211</span>) <span class="comment"># 作一幅2*1的图，选择第1个子图</span></span><br><span class="line"></span><br><span class="line">position = ax1.get_position()</span><br><span class="line"></span><br><span class="line"><span class="comment">#(x0, y0) and (x1, y1) represent the the point coordinates of the lower left and upper right corner respectively</span></span><br><span class="line">width = position.x1 - position.x0</span><br><span class="line">height = position.y1 - position.y0</span><br><span class="line"></span><br><span class="line">ax2 = fig.add_axes([position.x0, position.y0 - <span class="number">0.4</span>, width, height]) <span class="comment"># 位置参数，四个数分别代表了(left,bottom,width,height)</span></span><br><span class="line">print(ax1)</span><br><span class="line">print(fig.axes) <span class="comment"># fig.axes 中包含了subplot和axes两个实例, 刚刚添加的</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7MckQg.md.png' style='zoom:80%' /></p>
<p><strong>Note</strong>: <code>ax1.get_position</code> 返回一个 <code>Bbox</code> 对象，可以通过其 <code>x0</code>, <code>y0</code>, <code>x1</code> 和 <code>y1</code> 得到左下角和右上角的坐标信息。即：</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McFSS.md.png' style='zoom:80%' /></p>
<p>综上，通过获得位置参数之后，将两张子图进行了对齐。</p></li>
</ul>
<p>由于 <code>Figure</code> 维持了 <code>current axes</code>，因此你不应该手动的从 <code>Figure.axes</code> 列表中添加删除元素，而是要通过 <code>Figure.add_subplot()</code>、<code>Figure.add_axes()</code> 来添加元素，通过<code>Figure.delaxes()</code>来删除元素。但是你可以迭代或者访问 <code>Figure.axes</code> 中的 <code>Axes</code>，然后修改这个 <code>Axes</code> 的属性。</p>
<p>比如下面的遍历 <code>axes</code> 里的内容，并且添加网格线：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">211</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ax <span class="keyword">in</span> fig.axes:</span><br><span class="line">    ax.grid(<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McPW8.md.png' style='zoom:80%' /></p>
<p><code>Figure</code> 也有它自己的 <code>text</code>、<code>line</code>、<code>patch</code>、<code>image</code>。你可以直接通过 <code>add primitive</code> 语句直接添加。但是注意 <code>Figure</code> 默认的坐标系是以像素为单位，需要转换成 <code>figure</code> 坐标系：<code>(0,0)</code> 表示左下点，<code>(1,1)</code> 表示右上点。</p>
<p><strong>Figure容器的常见属性：</strong><br />
<code>Figure.patch</code>属性：<code>Figure</code> 的背景矩形<br />
<code>Figure.axes</code>属性：一个 <code>Axes</code> 实例的列表（包括 <code>Subplot</code>)<br />
<code>Figure.images</code>属性：一个 <code>FigureImages patch</code> 列表<br />
<code>Figure.lines</code>属性：一个 <code>Line2D</code> 实例的列表（很少使用）<br />
<code>Figure.legends</code>属性：一个 <code>Figure Legend</code> 实例列表（不同于 <code>Axes.legends</code>)<br />
<code>Figure.texts</code>属性：一个 <code>Figure Text</code> 实例列表</p>
<h3 id="axes-坐标系容器">3.3.2 <code>Axes</code> 坐标系容器</h3>
<p><code>matplotlib.axes.Axes</code> 是 <code>matplotlib</code> 的核心。大量的用于绘图的 <code>Artist</code> 存放在它内部，并且它有许多辅助方法来创建和添加 <code>Artist</code> 给它自己，而且它也有许多赋值方法来访问和修改这些 <code>Artist</code>。</p>
<p>和 <code>Figure</code> 容器类似，<code>Axes</code> 包含了一个 <code>patch</code> 属性，对于笛卡尔坐标系而言，它是一个 <code>Rectangle</code>；对于极坐标而言，它是一个 <code>Circle</code>。这个 <code>patch</code> 属性决定了绘图区域的形状、背景和边框。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">rect = ax.patch  <span class="comment"># axes的patch是一个Rectangle实例</span></span><br><span class="line">rect.set_facecolor(<span class="string">&#x27;green&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McCJf.md.png' style='zoom:80%' /></p>
<p><code>Axes</code>有许多方法用于绘图，如<code>.plot()、.text()、.hist()、.imshow()</code>等方法用于创建大多数常见的<code>primitive</code>(如<code>Line2D，Rectangle，Text，Image</code>等等）。在<code>primitives</code>中已经涉及，不再赘述。</p>
<p><code>Subplot</code> 就是一个特殊的 <code>Axes</code>，其实例是位于网格中某个区域的 <code>Subplot</code> 实例。其实你也可以在任意区域创建 <code>Axes</code>，通过下述代码来创建一个任意区域的 <code>Axes</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Figure.add_axes([left,bottom,width,height])</span><br></pre></td></tr></table></figure>
<p>其中，<code>left</code>, <code>bottom</code>, <code>width</code>, <code>height</code> 都是 <code>[0—1]</code> 之间的浮点数，他们代表了相对于 <code>Figure</code> 的坐标。</p>
<p>你不应该直接通过 <code>Axes.lines</code> 和 <code>Axes.patches</code> 列表来添加图表。因为当创建或添加一个对象到图表中时，<code>Axes</code>会做许多自动化的工作:<br />
- 它会设置 <code>Artist</code> 中 <code>figure</code> 和 <code>axes</code> 的属性，同时默认 <code>Axes</code> 的转换；<br />
- 它也会检视 <code>Artist</code> 中的数据，来更新数据结构，这样数据范围和呈现方式可以根据作图范围自动调整。</p>
<p>可以使用Axes的辅助方法 <code>.add_line()</code> 和 <code>.add_patch()</code> 方法来直接添加。</p>
<p>此外，<code>Axes</code> 还包含两个最重要的 <code>Artist container</code>： - <code>ax.xaxis</code>：<code>XAxis</code> 对象的实例，用于处理 <code>x</code> 轴 <code>tick</code> 以及 <code>label</code> 的绘制； - <code>ax.yaxis</code>：<code>YAxis</code> 对象的实例，用于处理 <code>y</code> 轴 <code>tick</code> 以及 <code>label</code> 的绘制;</p>
<p><strong>Axes容器</strong>的常见属性有：</p>
<ul>
<li><code>artists</code>: <code>Artist</code> 实例列表<br />
</li>
<li><code>patch</code>: <code>Axes</code> 所在的矩形实例<br />
</li>
<li><code>collections</code>: <code>Collection</code> 实例<br />
</li>
<li><code>images</code>: <code>Axes</code> 图像<br />
</li>
<li><code>legends</code>: <code>Legend</code> 实例<br />
</li>
<li><code>lines</code>: <code>Line2D</code> 实例<br />
</li>
<li><code>patches</code>: <code>Patch</code> 实例<br />
</li>
<li><code>texts</code>: <code>Text</code> 实例<br />
</li>
<li><code>xaxis</code>: <code>matplotlib.axis.XAxis</code> 实例<br />
</li>
<li><code>yaxis</code>: <code>matplotlib.axis.YAxis</code> 实例</li>
</ul>
<h3 id="axis-坐标轴容器">3.3.3 <code>Axis</code> 坐标轴容器</h3>
<p><code>matplotlib.axis.Axis</code> 实例处理 <code>tick line</code>、<code>grid line</code>、<code>tick label</code> 以及 <code>axis label</code> 的绘制，它包括坐标轴上的刻度线、刻度 <code>label</code>、坐标网格、坐标轴标题。通常可以独立的配置 <code>y</code> 轴的左边刻度以及右边的刻度，也可以独立地配置 <code>x</code> 轴的上边刻度以及下边的刻度。</p>
<p>刻度包括主刻度和次刻度，它们都是 <code>Tick</code> 刻度对象。</p>
<p><code>Axis</code> 也存储了用于自适应、平移以及缩放的 <code>data_interval</code> 和 <code>view_interval</code>。它还有 <code>Locator</code> 实例和 <code>Formatter</code> 实例用于控制刻度线的位置以及刻度 <code>label</code>。</p>
<p>每个 <code>Axis</code> 都有一个 <code>label</code> 属性，也有主刻度列表和次刻度列表。这些 <code>ticks</code> 是 <code>axis.XTick</code>和 <code>axis.YTick</code> 实例，它们包含着 <code>line primitive</code> 以及 <code>text primitive</code> 用来渲染刻度线以及刻度文本。</p>
<p>刻度是动态创建的，只有在需要创建的时候才创建（比如缩放的时候）。<code>Axis</code> 也提供了一些辅助方法来获取刻度文本、刻度线位置等等：</p>
<p>常见的如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 不用print，直接显示结果</span></span><br><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">&quot;all&quot;</span></span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line">x = <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line">y = [<span class="number">2</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line">plt.plot(x, y, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"></span><br><span class="line">axis = ax.xaxis <span class="comment"># axis为X轴对象</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>获取刻度线位置</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">axis.get_ticklocs()     <span class="comment"># 获取刻度线位置</span></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array([-0.5,  0. ,  0.5,  1. ,  1.5,  2. ,  2.5,  3. ,  3.5,  4. ,  4.5])</span><br></pre></td></tr></table></figure></p></li>
<li><p>获取刻度线 <code>label</code> 列表</p>
<p>返回一个 <code>Text</code> 实例的列表，可以通过 <code>minor=True|False</code> 关键字参数控制输出 <code>minor</code> 还是 <code>major</code> 的 <code>tick label</code>。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">axis.get_ticklabels()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Text(-0.5, 0, &#39;−0.5&#39;),</span><br><span class="line"> Text(0.0, 0, &#39;0.0&#39;),</span><br><span class="line"> Text(0.5, 0, &#39;0.5&#39;),</span><br><span class="line"> Text(1.0, 0, &#39;1.0&#39;),</span><br><span class="line"> Text(1.5, 0, &#39;1.5&#39;),</span><br><span class="line"> Text(2.0, 0, &#39;2.0&#39;),</span><br><span class="line"> Text(2.5, 0, &#39;2.5&#39;),</span><br><span class="line"> Text(3.0, 0, &#39;3.0&#39;),</span><br><span class="line"> Text(3.5, 0, &#39;3.5&#39;),</span><br><span class="line"> Text(4.0, 0, &#39;4.0&#39;),</span><br><span class="line"> Text(4.5, 0, &#39;4.5&#39;)]</span><br></pre></td></tr></table></figure></p></li>
<li><p>获取刻度线列表</p>
<p>一个 <code>Line2D</code> 实例的列表。可以通过 <code>minor=True|False</code> 关键字参数控制输出 <code>minor</code> 还是 <code>major</code> 的 <code>tick line</code>。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">axis.get_ticklines()    <span class="comment"># 获取刻度线列表(</span></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;a list of 22 Line2D ticklines objects&gt;</span><br></pre></td></tr></table></figure></p></li>
<li><p>获取轴刻度间隔</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">axis.get_data_interval()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array([0., 4.])</span><br></pre></td></tr></table></figure></p></li>
<li><p>获取轴视角（位置）的间隔</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">axis.get_view_interval()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array([-0.2,  4.2])</span><br></pre></td></tr></table></figure></p></li>
</ul>
<p>下面的例子展示了如何调整一些轴和刻度的属性(忽略美观度，仅作调整参考)：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure() <span class="comment"># 创建一个新图表</span></span><br><span class="line">rect = fig.patch   <span class="comment"># 矩形实例并将其设为黄色</span></span><br><span class="line">rect.set_facecolor(<span class="string">&#x27;lightgoldenrodyellow&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax1 = fig.add_axes([<span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">0.4</span>, <span class="number">0.4</span>]) <span class="comment"># 创一个axes对象，从(0.1,0.3)的位置开始，宽和高都为0.4，</span></span><br><span class="line">rect = ax1.patch   <span class="comment"># ax1的矩形设为灰色</span></span><br><span class="line">rect.set_facecolor(<span class="string">&#x27;lightslategray&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> label <span class="keyword">in</span> ax1.xaxis.get_ticklabels():</span><br><span class="line">    <span class="comment"># 调用x轴刻度标签实例，是一个text实例</span></span><br><span class="line">    label.set_color(<span class="string">&#x27;red&#x27;</span>) <span class="comment"># 颜色</span></span><br><span class="line">    label.set_rotation(<span class="number">45</span>) <span class="comment"># 旋转角度</span></span><br><span class="line">    label.set_fontsize(<span class="number">16</span>) <span class="comment"># 字体大小</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> ax1.yaxis.get_ticklines():</span><br><span class="line">    <span class="comment"># 调用y轴刻度线条实例, 是一个Line2D实例</span></span><br><span class="line">    line.set_color(<span class="string">&#x27;green&#x27;</span>)    <span class="comment"># 颜色</span></span><br><span class="line">    line.set_markersize(<span class="number">25</span>)    <span class="comment"># marker大小</span></span><br><span class="line">    line.set_markeredgewidth(<span class="number">2</span>)<span class="comment"># marker粗细</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7McSot.png' style='zoom:80%' /></p>
<h3 id="tick-容器">3.3.4 <code>Tick</code> 容器</h3>
<p><code>matplotlib.axis.Tick</code> 是从 <code>Figure</code> 到 <code>Axes</code> 到 <code>Axis</code> 到 <code>Tick</code> 中最末端的容器对象。<code>Tick</code> 包含了 <code>tick</code>、<code>grid line</code> 实例以及对应的 <code>label</code>。</p>
<p>所有的这些都可以通过 <code>Tick</code> 的属性获取，常见的 <code>tick</code> 属性有<br />
- <code>Tick.tick1line</code>：<code>Line2D</code> 实例<br />
- <code>Tick.tick2line</code>：<code>Line2D</code> 实例<br />
- <code>Tick.gridline</code>：<code>Line2D</code> 实例<br />
- <code>Tick.label1</code>：<code>Text</code> 实例<br />
- <code>Tick.label2</code>：<code>Text</code> 实例</p>
<p>其中，<code>y</code> 轴分为左右两个，因此 <code>tick1</code> 对应左侧的轴；<code>tick2</code> 对应右侧的轴。<br />
<code>x</code> 轴分为上下两个，因此 <code>tick1</code> 对应下侧的轴；<code>tick2</code> 对应上侧的轴。</p>
<p>下面的例子展示了，如何将 <code>Y</code> 轴右边轴设为主轴，并将标签设置为美元符号且为绿色：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, ax = plt.subplots()</span><br><span class="line">ax.plot(<span class="number">100</span>*np.random.rand(<span class="number">20</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置ticker的显示格式</span></span><br><span class="line">formatter = matplotlib.ticker.FormatStrFormatter(<span class="string">&#x27;$%1.2f&#x27;</span>)</span><br><span class="line">ax.yaxis.set_major_formatter(formatter)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置ticker的参数，右侧为主轴，颜色为绿色</span></span><br><span class="line">ax.yaxis.set_tick_params(which=<span class="string">&#x27;major&#x27;</span>, labelcolor=<span class="string">&#x27;green&#x27;</span>,</span><br><span class="line">                         labelleft=<span class="literal">False</span>, labelright=<span class="literal">True</span>);</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7Mc9FP.md.png' style='zoom:80%' /></p>
<h2 id="thinking-1">3.4 Thinking</h2>
<ol type="1">
<li><p><code>primitives</code> 和 <code>container</code> 的区别和联系是什么，分别用于控制可视化图表中的哪些要素</p>
<ul>
<li><code>container</code> 是容器，可以理解为一个盒子，用来盛放 <code>Axis</code> 坐标轴、<code>Axes</code> 坐标系 和 <code>Figure</code> 图形；</li>
<li><code>primitives</code> 表示基本要素，包括 <code>Line2D</code>, <code>Rectangle</code>, <code>Text</code>, <code>AxesImage</code> 这些基本的绘图要素。</li>
</ul>
<p>它们之间的关系是使用 <code>Figure</code> 容器创建一个或多个 <code>Axes</code> 坐标轴容器或者 <code>Subplot</code> 实例，然后用 <code>Axes</code> 坐标轴实例的帮助方法创建 <code>primitives</code>要素。接下来，我们用一个例子来演示。</p>
<ul>
<li><p>Create a <code>Figure</code> instance</p>
<p>We create a <code>Figure</code> instance using <code>matplotlib.pyplot.figure()</code>, which is a convenience method for instantiating <code>Figure</code> instances and connecting them with user interface or drawing toolkit <code>FigureCanvas</code>.</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>) <span class="comment"># two rows, one column, first plot</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">fig2 = plt.figure()</span><br><span class="line">ax2 = fig2.add_axes([<span class="number">0.15</span>, <span class="number">0.1</span>, <span class="number">0.7</span>, <span class="number">0.3</span>])</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6zdI.md.png' style='zoom:80%' /></p></li>
</ul></li>
<li><p>使用提供的drug数据集，对第一列yyyy和第二列state分组求和，画出下面折线图。PA加粗标黄，其他为灰色。图标题和横纵坐标轴标题，以及线的文本暂不做要求。</p>
<p>数据下载：<a id="download" href="https://www.aliyundrive.com/s/5ny6LPYdyiu" target="_blank"><i class="fa fa-download"></i><span> Download Now </span> </a></p>
<p><img src='https://img-blog.csdnimg.cn/20210523162430365.png' style='zoom:80%' /></p>
<p>实现代码如下：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">data = pd.read_csv(<span class="string">&#x27;./data/Drugs.txt&#x27;</span>, encoding = <span class="string">&#x27;utf8&#x27;</span>, sep = <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">plot_var = data[<span class="string">&#x27;State&#x27;</span>].unique()</span><br><span class="line">plot_data = data.groupby([<span class="string">&#x27;State&#x27;</span>, <span class="string">&#x27;YYYY&#x27;</span>])[<span class="string">&#x27;DrugReports&#x27;</span>].<span class="built_in">sum</span>()</span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_axes([<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.8</span>, <span class="number">0.6</span>])</span><br><span class="line">ax.grid()</span><br><span class="line"><span class="comment"># rect = ax.patch</span></span><br><span class="line"><span class="comment"># rect.set_facecolor(&#x27;grey&#x27;, alpha = 0.5)</span></span><br><span class="line"><span class="keyword">for</span> var <span class="keyword">in</span> plot_var:</span><br><span class="line">    <span class="keyword">if</span> var != <span class="string">&#x27;PA&#x27;</span>:</span><br><span class="line">        ax.plot(plot_data[var], <span class="string">&#x27;grey&#x27;</span>);</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ax.plot(plot_data[var], <span class="string">&#x27;orange&#x27;</span>, lw = <span class="number">3</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6xeA.md.png' style='zoom:80%' /></p></li>
<li><p>分别用一组长方形柱和填充面积的方式模仿画出下图，函数 y = -1 * (x - 2) * (x - 8) +10 在区间[2,9]的积分面积。如下图所示：</p>
<p><img src='https://img-blog.csdnimg.cn/20201126105910781.png' style='zoom:80%' /> <img src='https://img-blog.csdnimg.cn/20201126105910780.png' style='zoom:80%' /></p></li>
</ol>
<ul>
<li><p>针对第一个长方形柱形</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">50</span>)</span><br><span class="line">y = -<span class="number">1</span> * (x - <span class="number">2</span>) * (x - <span class="number">8</span>) +<span class="number">10</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line"></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.ylim((<span class="number">0</span>, <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">i, num_bars</span>):</span></span><br><span class="line">    step = <span class="number">7</span>/num_bars</span><br><span class="line">    x = <span class="number">2</span> + i * step</span><br><span class="line">    <span class="keyword">if</span> i &lt; num_bars/<span class="number">2</span>:</span><br><span class="line">        y = -<span class="number">1</span> * (x - <span class="number">2</span>) * (x - <span class="number">8</span>) +<span class="number">10</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        x1 = <span class="number">2</span> + (i+<span class="number">1</span>) * step</span><br><span class="line">        y = -<span class="number">1</span> * (x1 - <span class="number">2</span>) * (x1 - <span class="number">8</span>) +<span class="number">10</span></span><br><span class="line">    <span class="keyword">return</span>  x, y</span><br><span class="line"></span><br><span class="line">num_bars = <span class="number">56</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,num_bars):</span><br><span class="line">    <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        x1, y1 = func(i, num_bars)</span><br><span class="line">        rect =  plt.Rectangle((x1,<span class="number">0</span>),<span class="number">7</span>/num_bars, y1)</span><br><span class="line">        ax.add_patch(rect)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6XsH.md.png' style='zoom:80%' /></p>
<p><strong>Note</strong>：为了使图形更为美观，此处对对称轴两端的矩形高度做了调整，左边的矩形高度等于矩形左边坐标轴所对应的函数值，而右边则取右边坐标轴对应的函数值。</p></li>
<li><p>栅栏面积填充</p>
<p>如果觉得矩形与曲线之间有一定间隔，不美观，则可以使用 <code>fill_between</code> 函数进行填充，这样得到的填充区为坐标轴与曲线之间的无缝连接区域：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">1000</span>)</span><br><span class="line">y = -<span class="number">1</span> * (x - <span class="number">2</span>) * (x - <span class="number">8</span>) +<span class="number">10</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line"></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">plt.plot(x, y);</span><br><span class="line">plt.ylim((<span class="number">0</span>, <span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">num_bars = <span class="number">56</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,num_bars):</span><br><span class="line">    <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        step = <span class="number">7</span>/num_bars</span><br><span class="line">        x1 = <span class="number">2</span> + i * step</span><br><span class="line">        plt.fill_between(x, y, where=(x1 &lt; x) &amp; (x &lt; x1+step), facecolor=<span class="string">&#x27;pink&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6OQe.md.png' style='zoom:80%' /></p>
<p><strong>Note</strong>：需要注意的是：当设置的 <code>num_bars</code> 条形的数量较大时，要控制 <code>np.linspace</code> 函数生成的 <code>x</code> 值要足够的多，才能生成正确的图形，因为 <code>x</code> 数量较少时，函数找不到参照的区域，会导致生成图形不对，如下图所示（将 <code>1000</code> 改为 <code>100</code>）：</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6jLd.md.png' style='zoom:80%' /></p></li>
<li><p>面积填充</p>
<p>类似的，借助 <code>fill_between</code> 函数，可以直接进行区域面积填充，如：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">10</span>, <span class="number">50</span>)</span><br><span class="line">y = -<span class="number">1</span> * (x - <span class="number">2</span>) * (x - <span class="number">8</span>) +<span class="number">10</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line"></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">plt.plot(x, y);</span><br><span class="line">plt.ylim((<span class="number">0</span>, <span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">plt.fill_between(x, y, where=(<span class="number">2</span> &lt; x) &amp; (x &lt; <span class="number">9</span>), facecolor=<span class="string">&#x27;pink&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/13/7M6qzD.md.png' style='zoom:80%' /></p></li>
</ul>
<h2 id="reference">3.5 Reference</h2>
<ol type="1">
<li><a href="https://zhuanlan.zhihu.com/p/32693665">matplotlib设计的基本逻辑</a><br />
</li>
<li><a href="https://www.bookstack.cn/read/huaxiaozhuan-ai/spilt.2.333f5abdbabf383d.md">AI算法工程师手册</a></li>
<li><a href="https://github.com/datawhalechina/fantastic-matplotlib">Fantastic-Matplotlib</a></li>
</ol>
<h1 id="布局格式定方圆">4. 布局格式定方圆</h1>
<ul>
<li><p>Import modules</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]   <span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span>   <span class="comment">#用来正常显示负号</span></span><br><span class="line"><span class="comment"># plt.figure(dpi=300,figsize=(12,8))</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;figure.figsize&#x27;</span>]=(<span class="number">12</span>,<span class="number">8</span>)</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="subplot">4.1 Subplot</h2>
<h3 id="使用-plt.subplots-绘制均匀状态下的子图">4.1.1 使用 <code>plt.subplots</code> 绘制均匀状态下的子图</h3>
<p>返回元素分别是画布和子图构成的列表，第一个数字为行，第二个为列，默认值都为 <code>1</code>。构造函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">subplots(nrows=<span class="number">1</span>, ncols=<span class="number">1</span>, *, sharex=<span class="literal">False</span>, sharey=<span class="literal">False</span>, squeeze=<span class="literal">True</span>, subplot_kw=<span class="literal">None</span>, gridspec_kw=<span class="literal">None</span>, **fig_kw)</span><br></pre></td></tr></table></figure>
<p>参数如下： - <code>nrows</code>：行 - <code>ncols</code>：列 - <code>sharex</code> and <code>sharey</code>：分别表示是否共享横轴和纵轴刻度 - <code>tight_layout</code> ：该函数可以调整子图的相对大小使字符不会重叠</p>
<ul>
<li><p>Case：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, axs = plt.subplots(<span class="number">2</span>, <span class="number">5</span>, figsize=(<span class="number">10</span>, <span class="number">4</span>), sharex=<span class="literal">True</span>, sharey=<span class="literal">True</span>)</span><br><span class="line">fig.suptitle(<span class="string">&#x27;样例1&#x27;</span>, size=<span class="number">20</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        axs[i][j].scatter(np.random.randn(<span class="number">10</span>), np.random.randn(<span class="number">10</span>))</span><br><span class="line">        axs[i][j].set_title(<span class="string">&#x27;第%d行，第%d列&#x27;</span>%(i+<span class="number">1</span>,j+<span class="number">1</span>))</span><br><span class="line">        axs[i][j].set_xlim(-<span class="number">5</span>,<span class="number">5</span>)</span><br><span class="line">        axs[i][j].set_ylim(-<span class="number">5</span>,<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">1</span>: axs[i][j].set_xlabel(<span class="string">&#x27;横坐标&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> j==<span class="number">0</span>: axs[i][j].set_ylabel(<span class="string">&#x27;纵坐标&#x27;</span>)</span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714z1s.png' style='zoom:80%' /></p></li>
</ul>
<p><code>subplots</code> 是基于 <code>OO</code> 模式的写法，显式地创建一个或多个 <code>axes</code> 对象，然后在对应地子图对象中进行绘图操作。还有种方式是使用 <code>subplot</code> 这样基于 <code>pyplot</code> 模式的写法，每次在制定位置新建一个子图，并且之后的绘图操作都会只想当前子图，本质上 <code>subplot</code> 也是 <code>Figure.add_subplot</code> 的一种封装。</p>
<p>在调用 <code>subplot</code> 时一般需要传入三位数字，分别代表总行数，总列数，当前子图的 <code>index</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.figure()</span><br><span class="line"><span class="comment"># 子图1</span></span><br><span class="line">plt.subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>], <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line"><span class="comment"># 子图2</span></span><br><span class="line">plt.subplot(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>], <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment">#子图3</span></span><br><span class="line">plt.subplot(<span class="number">224</span>)  <span class="comment"># 当三位数都小于10时，可以省略中间的逗号，这行命令等价于plt.subplot(2,2,4)</span></span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">3</span>], <span class="string">&#x27;g&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714xpj.png' style='zoom:80%' /></p>
<ul>
<li><p>极坐标 <code>projection</code></p>
<p>除了常规的直角坐标系，也可以通过 <code>projection</code> 方法创建极坐标系下的图表</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">N = <span class="number">150</span></span><br><span class="line">r = <span class="number">2</span> * np.random.rand(N)</span><br><span class="line">theta = <span class="number">2</span> * np.pi * np.random.rand(N)</span><br><span class="line">area = <span class="number">200</span> * r**<span class="number">2</span></span><br><span class="line">colors = theta</span><br><span class="line"></span><br><span class="line">plt.subplot(projection=<span class="string">&#x27;polar&#x27;</span>)</span><br><span class="line">plt.scatter(theta, r, c=colors, s=area, cmap=<span class="string">&#x27;hsv&#x27;</span>, alpha=<span class="number">0.75</span>);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714jhQ.png' style='zoom:80%' /></p></li>
<li><p>思考：如何用 <code>GridSpec</code> 绘制非均匀子图</p>
<p>可以借助上一章所学习的楔形图来绘制玫瑰图，为了简单，此处我们随机生成 <code>36</code> 个分支，每个分支的长度从 <code>0.1</code> 开始，逐步增加 <code>0.01</code>，最终生成如下所示的玫瑰图：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib.patches <span class="keyword">import</span> Wedge</span><br><span class="line"><span class="keyword">from</span> matplotlib.collections <span class="keyword">import</span> PatchCollection</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">9</span>,<span class="number">9</span>))</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">theta1 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">num = <span class="number">36</span></span><br><span class="line">patches = []</span><br><span class="line"></span><br><span class="line">patches = [</span><br><span class="line">    Wedge((<span class="number">0.5</span>, <span class="number">0.5</span>), <span class="number">0.01</span> + <span class="number">0.01</span>*i, i* <span class="number">360</span>/num, (<span class="number">1</span> + i) * <span class="number">360</span>/num) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">colors = <span class="number">100</span> * np.random.rand(<span class="built_in">len</span>(patches))</span><br><span class="line">p = PatchCollection(patches, alpha=<span class="number">0.8</span>)</span><br><span class="line">p.set_array(colors)</span><br><span class="line">ax1.add_collection(p);</span><br></pre></td></tr></table></figure></p>
<p>Result:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714Xtg.png' style='zoom:80%' /></p></li>
</ul>
<h3 id="使用-gridspec-绘制非均匀子图">4.1.2 使用 <code>GridSpec</code> 绘制非均匀子图</h3>
<p>所谓的非均匀包含两层含义，第一是指图的比例大小不同但没有跨行或者跨列，第二是指图为跨列或跨行状态。利用 <code>add_gridspec</code> 可以制定相对宽度比例 <code>width_ratios</code> 和相对高度比例参数 <code>height_ratios</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure(figsize=(<span class="number">12</span>, <span class="number">5</span>))</span><br><span class="line">spec = fig.add_gridspec(nrows=<span class="number">2</span>, ncols=<span class="number">5</span>, width_ratios=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>], height_ratios=[<span class="number">1</span>,<span class="number">3</span>])</span><br><span class="line">fig.suptitle(<span class="string">&#x27;样例2&#x27;</span>, size=<span class="number">20</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        ax = fig.add_subplot(spec[i, j])</span><br><span class="line">        ax.scatter(np.random.randn(<span class="number">10</span>), np.random.randn(<span class="number">10</span>))</span><br><span class="line">        ax.set_title(<span class="string">&#x27;第%d行，第%d列&#x27;</span>%(i+<span class="number">1</span>,j+<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">1</span>: ax.set_xlabel(<span class="string">&#x27;横坐标&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> j==<span class="number">0</span>: ax.set_ylabel(<span class="string">&#x27;纵坐标&#x27;</span>)</span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure>
<p>Results：</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714OAS.png' style='zoom:80%' /></p>
<p>在上面的例子中出现了 <code>spec[i, j]</code> 的用法，事实上通过切片就可以实现子图的合并而达到跨图的功能。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>, <span class="number">4</span>))</span><br><span class="line">spec = fig.add_gridspec(nrows=<span class="number">2</span>, ncols=<span class="number">6</span>,</span><br><span class="line">        width_ratios=[<span class="number">2</span>,<span class="number">2.5</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1.5</span>,<span class="number">2</span>], height_ratios=[<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line">fig.suptitle(<span class="string">&#x27;样例3&#x27;</span>, size=<span class="number">20</span>)</span><br><span class="line"><span class="comment"># sub1</span></span><br><span class="line">ax = fig.add_subplot(spec[<span class="number">0</span>, :<span class="number">3</span>])</span><br><span class="line">ax.scatter(np.random.randn(<span class="number">10</span>), np.random.randn(<span class="number">10</span>))</span><br><span class="line"><span class="comment"># sub2</span></span><br><span class="line">ax = fig.add_subplot(spec[<span class="number">0</span>, <span class="number">3</span>:<span class="number">5</span>])</span><br><span class="line">ax.scatter(np.random.randn(<span class="number">10</span>), np.random.randn(<span class="number">10</span>))</span><br><span class="line"><span class="comment"># sub3</span></span><br><span class="line">ax = fig.add_subplot(spec[:, <span class="number">5</span>])</span><br><span class="line">ax.scatter(np.random.randn(<span class="number">10</span>), np.random.randn(<span class="number">10</span>))</span><br><span class="line"><span class="comment"># sub4</span></span><br><span class="line">ax = fig.add_subplot(spec[<span class="number">1</span>, <span class="number">0</span>])</span><br><span class="line">ax.scatter(np.random.randn(<span class="number">10</span>), np.random.randn(<span class="number">10</span>))</span><br><span class="line"><span class="comment"># sub5</span></span><br><span class="line">ax = fig.add_subplot(spec[<span class="number">1</span>, <span class="number">1</span>:<span class="number">5</span>])</span><br><span class="line">ax.scatter(np.random.randn(<span class="number">10</span>), np.random.randn(<span class="number">10</span>))</span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure>
<p>Results：</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714q78.png' style='zoom:80%' /></p>
<h2 id="子图上的方法">4.2 子图上的方法</h2>
<p>补充一些子图的用法，常用直线的画法为：<code>axhlive</code>, <code>axvline</code> 和 <code>axline</code> (horizontal, vertical and any)</p>
<ul>
<li><p>构造函数：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">axhline(y=<span class="number">0</span>, xmin=<span class="number">0</span>, xmax=<span class="number">1</span>, **kwargs)</span><br><span class="line">axvline(x=<span class="number">0</span>, ymin=<span class="number">0</span>, ymax=<span class="number">1</span>, **kwargs)</span><br><span class="line">axline(xy1, xy2=<span class="literal">None</span>, *, slope=<span class="literal">None</span>, **kwargs)</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>Cases</strong>:</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">4</span>,<span class="number">3</span>))</span><br><span class="line">ax.axhline(<span class="number">0.5</span>,<span class="number">0.2</span>,<span class="number">0.8</span>)</span><br><span class="line">ax.axvline(<span class="number">0.5</span>,<span class="number">0.2</span>,<span class="number">0.8</span>)</span><br><span class="line">ax.axline([<span class="number">0.3</span>,<span class="number">0.3</span>],[<span class="number">0.7</span>,<span class="number">0.7</span>]);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714b0f.png' style='zoom:80%' /></p></li>
<li><p>使用 <code>grid</code> 添加灰色网格</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">12</span>,<span class="number">8</span>))</span><br><span class="line">ax.grid(<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714HnP.png' style='zoom:80%' /></p></li>
<li><p>使用 <code>set_xscale</code> 设置坐标轴的规度（指对数坐标等）</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, axs = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">12</span>, <span class="number">4</span>))</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    axs[j].plot(<span class="built_in">list</span>(<span class="string">&#x27;abcd&#x27;</span>), [<span class="number">10</span>**i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)])</span><br><span class="line">    <span class="keyword">if</span> j==<span class="number">0</span>:</span><br><span class="line">        axs[j].set_yscale(<span class="string">&#x27;log&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714TXt.png' style='zoom:80%' /></p></li>
</ul>
<h2 id="thinking-2">4.3 Thinking</h2>
<h3 id="利用数据画出每个月的月温度曲线">4.3.1 利用数据，画出每个月的月温度曲线</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ex1 = pd.read_csv(<span class="string">&#x27;data/layout_ex1.csv&#x27;</span>)</span><br><span class="line">ex1[<span class="string">&#x27;Year&#x27;</span>] = ex1[<span class="string">&#x27;Time&#x27;</span>].apply(<span class="keyword">lambda</span> x: x.split(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">ex1[<span class="string">&#x27;Month&#x27;</span>] = ex1[<span class="string">&#x27;Time&#x27;</span>].apply(<span class="keyword">lambda</span> x: x.split(<span class="string">&#x27;-&#x27;</span>)[<span class="number">1</span>])</span><br><span class="line">plot_data = ex1.groupby([<span class="string">&#x27;Year&#x27;</span>, <span class="string">&#x27;Month&#x27;</span>])[<span class="string">&#x27;Temperature&#x27;</span>].<span class="built_in">sum</span>()</span><br><span class="line"></span><br><span class="line">figs, axs = plt.subplots(<span class="number">2</span>, <span class="number">5</span>, figsize=(<span class="number">12</span>, <span class="number">2</span>), sharex=<span class="literal">True</span>, sharey=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        year = <span class="built_in">str</span>(i*<span class="number">2</span> + j + <span class="number">1981</span>)</span><br><span class="line">        axs[i][j].plot(plot_data[year])</span><br><span class="line">        axs[i][j].set_xticklabels(labels = ex1[<span class="string">&#x27;Year&#x27;</span>].index, fontsize = <span class="number">8</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714o6I.png' style='zoom:80%' /></p>
<h3 id="用两种方式画出数据的散点图和边际分布">4.3.2. 用两种方式画出数据的散点图和边际分布</h3>
<ul>
<li><p>方式一：使用 <code>gridspec</code> 方式</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">my_data_x, my_data_y = np.random.randn(<span class="number">2</span>, <span class="number">150</span>)</span><br><span class="line"><span class="comment"># my_data_y = np.random.randn(2, 150)</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>,<span class="number">10</span>))</span><br><span class="line">spec = fig.add_gridspec(nrows = <span class="number">2</span>, ncols = <span class="number">2</span>, width_ratios = [<span class="number">5</span>, <span class="number">1</span>], height_ratios = [<span class="number">1</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">ax1 = fig.add_subplot(spec[<span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">ax1.hist(my_data_x, density = <span class="literal">True</span>, rwidth = <span class="number">0.8</span>)</span><br><span class="line">ax1.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Scatter</span></span><br><span class="line">ax2 = fig.add_subplot(spec[<span class="number">1</span>, <span class="number">0</span>])</span><br><span class="line">ax2.scatter(my_data_x, my_data_y)</span><br><span class="line">ax2.set_xlabel(<span class="string">&quot;my_data_x&quot;</span>)</span><br><span class="line">ax2.set_ylabel(<span class="string">&quot;my_data_y&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">ax3 = fig.add_subplot(spec[<span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">ax3.hist(my_data_y, orientation = <span class="string">&#x27;horizontal&#x27;</span>, density = <span class="literal">True</span>, rwidth = <span class="number">0.9</span>)</span><br><span class="line">ax3.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714fte.png' style='zoom:80%' /></p>
<p>此处也可以不设置 <code>width_ratios</code> 和 <code>height_ratios</code>，而是选择生成一个 <span class="math inline">\(6\times 6\)</span> 的网格， 然后通过跨表格操作生成图形。</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714I1A.md.png' style='zoom:80%' /></p>
<p>代码：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure(figsize=(<span class="number">8</span>, <span class="number">8</span>))</span><br><span class="line">spec = fig.add_gridspec(nrows=<span class="number">6</span>, ncols=<span class="number">6</span>)  <span class="comment"># (nrows,ncols) == figsize</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#hist plot1</span></span><br><span class="line">ax1 = fig.add_subplot(spec[<span class="number">0</span>:<span class="number">1</span>,<span class="number">0</span>:<span class="number">5</span>])</span><br><span class="line">ax1.hist(my_data_x,density = <span class="literal">True</span>,rwidth = <span class="number">0.9</span>)  <span class="comment"># rwidth控制竹子宽度</span></span><br><span class="line">ax1.axis(<span class="string">&quot;off&quot;</span>)</span><br><span class="line"><span class="comment">#scatter plot</span></span><br><span class="line">ax2 = fig.add_subplot(spec[<span class="number">1</span>:<span class="number">6</span>,<span class="number">0</span>:<span class="number">5</span>])</span><br><span class="line">ax2.scatter(my_data_x, my_data_y)</span><br><span class="line">ax2.set_xlabel(<span class="string">&quot;my_data_x&quot;</span>)</span><br><span class="line">ax2.set_ylabel(<span class="string">&quot;my_data_y&quot;</span>)</span><br><span class="line">ax2.grid()</span><br><span class="line"><span class="comment">#hist plot2</span></span><br><span class="line">ax3 = fig.add_subplot(spec[<span class="number">1</span>:<span class="number">6</span>,<span class="number">5</span>])</span><br><span class="line">ax3.hist(my_data_y,orientation=<span class="string">&#x27;horizontal&#x27;</span>,density = <span class="literal">True</span>,rwidth = <span class="number">0.9</span>)  <span class="comment"># rwidth控制竹子宽度</span></span><br><span class="line">ax3.axis(<span class="string">&quot;off&quot;</span>)</span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714hfH.png' style='zoom:80%' /></p></li>
<li><p>方式二：借助 <code>gridspec</code> 生成网格自定义绘图</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib.gridspec <span class="keyword">as</span> gridspec</span><br><span class="line"></span><br><span class="line">my_data_x, my_data_y = np.random.randn(<span class="number">2</span>, <span class="number">150</span>)</span><br><span class="line"><span class="comment"># my_data_y = np.random.randn(2, 150)</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">8</span>,<span class="number">8</span>))</span><br><span class="line">spec = fig.add_gridspec(nrows = <span class="number">2</span>, ncols = <span class="number">2</span>, width_ratios = [<span class="number">5</span>, <span class="number">1</span>], height_ratios = [<span class="number">1</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>), dpi = <span class="number">100</span>, facecolor = <span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">gs = gridspec.GridSpec(<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">graph_ax1 = fig.add_subplot(gs[<span class="number">0</span>, :<span class="number">5</span>])</span><br><span class="line">graph_ax1.hist(my_data_x, density = <span class="literal">True</span>, rwidth = <span class="number">0.8</span>)</span><br><span class="line">graph_ax1.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Scatter</span></span><br><span class="line">graph_ax2 = fig.add_subplot(gs[<span class="number">1</span>:<span class="number">6</span>, :<span class="number">5</span>])</span><br><span class="line">graph_ax2.scatter(my_data_x, my_data_y)</span><br><span class="line">graph_ax2.set_xlabel(<span class="string">&quot;my_data_x&quot;</span>)</span><br><span class="line">graph_ax2.set_ylabel(<span class="string">&quot;my_data_y&quot;</span>)</span><br><span class="line"></span><br><span class="line">graph_ax3 = fig.add_subplot(gs[<span class="number">1</span>:<span class="number">6</span>, <span class="number">5</span>])</span><br><span class="line">graph_ax3.hist(my_data_y, orientation = <span class="string">&#x27;horizontal&#x27;</span>, density = <span class="literal">True</span>, rwidth = <span class="number">0.9</span>)</span><br><span class="line">graph_ax3.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/7145pd.png' style='zoom:80%' /></p></li>
</ul>
<h1 id="文字图例尽眉目">5. 文字图例尽眉目</h1>
<ul>
<li><p>Import modules</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.dates <span class="keyword">as</span> mdates</span><br><span class="line"><span class="keyword">import</span> datetime</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="figure-和-axes-上的文本">5.1 <code>Figure</code> 和 <code>Axes</code> 上的文本</h2>
<p><code>Matplotlib</code> 具有广泛的文本支持，包括对数学表达式的支持、对栅格和矢量输出的 <code>TrueType</code> 支持、具有任意旋转的换行分隔文本以及 <code>Unicode</code> 支持。</p>
<h3 id="文本-api-示例">5.1.1 文本 <code>API</code> 示例</h3>
<p>下面的命令是介绍了通过 <code>pyplot API</code> 和 <code>objected-oriented API</code> 分别创建文本的方式。</p>
<center>
Table 1 Text creation
</center>
<table>
<thead>
<tr class="header">
<th>pyplot API</th>
<th>OO API</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>text</code></td>
<td><code>text</code></td>
<td>在子图axes的任意位置添加文本</td>
</tr>
<tr class="even">
<td><code>annotate</code></td>
<td><code>annotate</code></td>
<td>在子图axes的任意位置添加注解，包含指向性的箭头</td>
</tr>
<tr class="odd">
<td><code>xlabel</code></td>
<td><code>set_xlabel</code></td>
<td>为子图axes添加x轴标签</td>
</tr>
<tr class="even">
<td><code>ylabel</code></td>
<td><code>set_ylabel</code></td>
<td>为子图axes添加y轴标签</td>
</tr>
<tr class="odd">
<td><code>title</code></td>
<td><code>set_title</code></td>
<td>为子图axes添加标题</td>
</tr>
<tr class="even">
<td><code>figtext</code></td>
<td><code>text</code></td>
<td>在画布figure的任意位置添加文本</td>
</tr>
<tr class="odd">
<td><code>suptitle</code></td>
<td><code>suptitle</code></td>
<td>为画布figure添加标题</td>
</tr>
</tbody>
</table>
<p>通过一个综合例子，以 <code>OO</code> 模式展示这些 <code>API</code> 是如何控制一个图像中各部分的文本，在之后的内容再详细分析这些 <code>api</code> 的使用技巧。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别为 figure 和 ax 设置标题，注意两者的位置是不同的</span></span><br><span class="line">fig.suptitle(<span class="string">&#x27;bold figure suptitle&#x27;</span>, fontsize=<span class="number">14</span>, fontweight=<span class="string">&#x27;bold&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&#x27;axes title&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 x 和 y 轴标签</span></span><br><span class="line">ax.set_xlabel(<span class="string">&#x27;xlabel&#x27;</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">&#x27;ylabel&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 x 和 y 轴显示范围均为 0 到 10</span></span><br><span class="line">ax.axis([<span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">10</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在子图上添加文本</span></span><br><span class="line">ax.text(<span class="number">3</span>, <span class="number">8</span>, <span class="string">&#x27;boxed italics text in data coords&#x27;</span>, style=<span class="string">&#x27;italic&#x27;</span>,</span><br><span class="line">        bbox=&#123;<span class="string">&#x27;facecolor&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;alpha&#x27;</span>: <span class="number">0.5</span>, <span class="string">&#x27;pad&#x27;</span>: <span class="number">10</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在画布上添加文本，一般在子图上添加文本是更常见的操作，这种方法很少用</span></span><br><span class="line">fig.text(<span class="number">0.4</span>,<span class="number">0.8</span>,<span class="string">&#x27;This is text for figure&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax.plot([<span class="number">2</span>], [<span class="number">1</span>], <span class="string">&#x27;o&#x27;</span>)</span><br><span class="line"><span class="comment"># 添加注解</span></span><br><span class="line">ax.annotate(<span class="string">&#x27;annotate&#x27;</span>, xy=(<span class="number">2</span>, <span class="number">1</span>), xytext=(<span class="number">3</span>, <span class="number">4</span>),arrowprops=<span class="built_in">dict</span>(facecolor=<span class="string">&#x27;black&#x27;</span>, shrink=<span class="number">0.05</span>));</span><br></pre></td></tr></table></figure>
<h3 id="text-子图上的文本">5.1.2 <code>text</code> 子图上的文本</h3>
<p><code>text</code> 的调用方式为</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Axes.text(x, y, s, fontdict=<span class="literal">None</span>, **kwargs) </span><br></pre></td></tr></table></figure>
<p>参数说明： - <code>x</code>,<code>y</code>： 为文本出现的位置，默认状态下即为当前坐标系下的坐标值； - <code>s</code>：文本的内容； - <code>fontdict</code>：可选参数，用于覆盖默认的文本属性 - <code>**kwargs</code>：关键字参数，也可以用于传入文本样式参数</p>
<p>接下来，重点解释下 <code>fontdict</code> 和 <code>**kwargs</code> 参数，这两种方式都可以用于调整呈现的文本样式，最终效果是一样的，不仅 <code>text</code> 方法，其他文本方法如 <code>set_xlabel</code>, <code>set_title</code> 等同样适用这两种方式修改样式。通过一个例子演示这两种方法如何使用：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>,<span class="number">3</span>))</span><br><span class="line">axes = fig.subplots(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用关键字参数修改文本样式</span></span><br><span class="line">axes[<span class="number">0</span>].text(<span class="number">0.3</span>, <span class="number">0.8</span>, <span class="string">&#x27;modify by **kwargs&#x27;</span>, style=<span class="string">&#x27;italic&#x27;</span>,</span><br><span class="line">        bbox=&#123;<span class="string">&#x27;facecolor&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;alpha&#x27;</span>: <span class="number">0.5</span>, <span class="string">&#x27;pad&#x27;</span>: <span class="number">10</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用fontdict参数修改文本样式</span></span><br><span class="line">font = &#123;<span class="string">&#x27;bbox&#x27;</span>:&#123;<span class="string">&#x27;facecolor&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;alpha&#x27;</span>: <span class="number">0.5</span>, <span class="string">&#x27;pad&#x27;</span>: <span class="number">10</span>&#125;, <span class="string">&#x27;style&#x27;</span>:<span class="string">&#x27;italic&#x27;</span>&#125;</span><br><span class="line">axes[<span class="number">1</span>].text(<span class="number">0.3</span>, <span class="number">0.8</span>, <span class="string">&#x27;modify by fontdict&#x27;</span>, fontdict=font);</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/714WkD.png' style='zoom:80%' /></p>
<p>matplotlib中所有支持的样式参数请参考<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.text.html#matplotlib.axes.Axes.text">官网文档说明</a>，大多数时候需要用到的时候再查询即可。</p>
<p>下表列举了一些常用的参数供参考。</p>
<center>
Table 2 Text Parameters
</center>
<table>
<colgroup>
<col style="width: 31%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="header">
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>alpha</code></td>
<td>float or None 透明度，越接近0越透明，越接近1越不透明</td>
</tr>
<tr class="even">
<td><code>backgroundcolor</code></td>
<td>color 文本的背景颜色</td>
</tr>
<tr class="odd">
<td><code>bbox</code></td>
<td>dict with properties for patches.FancyBboxPatch 用来设置text周围的box外框</td>
</tr>
<tr class="even">
<td><code>color</code> or c</td>
<td>color 字体的颜色</td>
</tr>
<tr class="odd">
<td><code>fontfamily</code> or family</td>
<td>{FONTNAME, 'serif', 'sans-serif', 'cursive', 'fantasy', 'monospace'} 字体的类型</td>
</tr>
<tr class="even">
<td><code>fontsize</code> or size</td>
<td>float or {'xx-small', 'x-small', 'small', 'medium', 'large', 'x-large', 'xx-large'} 字体大小</td>
</tr>
<tr class="odd">
<td><code>fontstyle</code> or style</td>
<td>{'normal', 'italic', 'oblique'} 字体的样式是否倾斜等</td>
</tr>
<tr class="even">
<td><code>fontweight</code> or weight</td>
<td>{a numeric value in range 0-1000, 'ultralight', 'light', 'normal', 'regular', 'book', 'medium', 'roman', 'semibold', 'demibold', 'demi', 'bold', 'heavy', 'extra bold', 'black'} 文本粗细</td>
</tr>
<tr class="odd">
<td><code>horizontalalignment</code> or ha</td>
<td>{'center', 'right', 'left'} 选择文本左对齐右对齐还是居中对齐</td>
</tr>
<tr class="even">
<td><code>linespacing</code></td>
<td>float (multiple of font size) 文本间距</td>
</tr>
<tr class="odd">
<td><code>rotation</code></td>
<td>float or {'vertical', 'horizontal'} 指text逆时针旋转的角度，“horizontal”等于0，“vertical”等于90</td>
</tr>
<tr class="even">
<td><code>verticalalignment</code> or va</td>
<td>{'center', 'top', 'bottom', 'baseline', 'center_baseline'} 文本在垂直角度的对齐方式</td>
</tr>
</tbody>
</table>
<h3 id="xlabel-and-ylabel">5.1.3 <code>xlabel</code> and <code>ylabel</code></h3>
<p><code>xlabel</code> and <code>ylabel</code> 分别表示子图的 <code>x</code>，<code>y</code> 轴标签，其构造函数为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Axes.set_xlabel(xlabel, fontdict=<span class="literal">None</span>, labelpad=<span class="literal">None</span>, *, loc=<span class="literal">None</span>, **kwargs)</span><br></pre></td></tr></table></figure>
<p>参数说明： - <code>xlabel</code>：标签内容； - <code>fontdict</code> and <code>**kwargs</code>：用来修改样式，上一小节已介绍； - <code>labelpad</code>：标签和坐标轴的距离，默认为 <code>4</code>； - <code>loc</code>：标签位置，可选的值为 <code>left</code>, <code>center</code>, <code>right</code> 之一，默认为居中。</p>
<p><strong>Case</strong>： <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 观察 labelpad 和 loc 参数的使用效果</span></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>,<span class="number">3</span>))</span><br><span class="line">axes = fig.subplots(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">axes[<span class="number">0</span>].set_xlabel(<span class="string">&#x27;xlabel&#x27;</span>,labelpad = <span class="number">20</span>,loc=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">axes[<span class="number">1</span>].set_xlabel(<span class="string">&#x27;xlabel&#x27;</span>, position=(<span class="number">0.2</span>, _), horizontalalignment=<span class="string">&#x27;left&#x27;</span>);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715QHK.png' style='zoom:80%' /></p>
<p><strong>Note</strong>： - <code>loc</code> 参数仅能提供粗略的位置调整，如果想要更精确的设置标签的位置，可以使用 <code>position</code> 参数和 <code>horizontalalignment</code> 参数来定位; - <code>position</code> 由一个元组过程，第一个元素 <code>0.2</code> 表示 <code>x</code> 轴标签在 <code>x</code> 轴的位置，第二个元素对于 <code>xlabel</code> 其实是无意义的，随便填一个数都可以； - <code>horizontalalignment</code> 为 <code>left</code> 表示左对齐，这样设置后 <code>x</code> 轴标签就能精确定位在 <code>x=0.2</code> 的位置处。</p>
<h3 id="title-and-suptitle">5.1.4 <code>title</code> and <code>suptitle</code></h3>
<ol type="1">
<li><p><code>title</code> 的调用方式为：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Axes.set_title(label, fontdict=<span class="literal">None</span>, loc=<span class="literal">None</span>, pad=<span class="literal">None</span>, *, y=<span class="literal">None</span>, **kwargs)</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<ul>
<li><code>label</code>：为子图标签的内容；</li>
<li><code>pad</code>：标题偏离图表顶部的距离，默认为 <code>6</code>；</li>
<li><code>y</code> 是 <code>title</code> 所在子图吹响的位置。默认值为 <code>1</code>，即 <code>title</code> 位于子图的顶部。</li>
</ul></li>
<li><p><code>suptitle</code> 的调用方式为</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">figure.suptitle(t, **kwargs)</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>t</code> 为画布的标题内容。</p></li>
</ol>
<ul>
<li><p><strong>Case</strong></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 观察pad参数的使用效果</span></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>,<span class="number">3</span>))</span><br><span class="line">fig.suptitle(<span class="string">&#x27;This is figure title&#x27;</span>,y=<span class="number">1.2</span>) <span class="comment"># 通过参数y设置高度</span></span><br><span class="line">axes = fig.subplots(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">axes[<span class="number">0</span>].set_title(<span class="string">&#x27;This is title&#x27;</span>,pad=<span class="number">15</span>)</span><br><span class="line">axes[<span class="number">1</span>].set_title(<span class="string">&#x27;This is title&#x27;</span>,pad=<span class="number">6</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src='https://s4.ax1x.com/2022/01/14/715MB6.png' style='zoom:80%' /></p></li>
</ul>
<h3 id="annotate-子图的注解">5.1.5 <code>annotate</code> 子图的注解</h3>
<p><code>annotate</code> 的构造函数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># API</span></span><br><span class="line">matplotlib.pyplot.annotate(text, xy, *args,**kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># OO API</span></span><br><span class="line">Axes.annotate(text, xy, *args, **kwargs)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li><code>text</code>：注解的内容；</li>
<li><code>xy</code>：注解箭头指向的坐标；</li>
</ul>
<p>其他常用的参数包括： - <code>xytext</code>：注解文字的坐标，二维元组，默认与 <code>xy</code> 相同</p>
<ul>
<li><p><code>xycoords</code>：用来定义 <code>xy</code> 参数的坐标系，允许的输入值如下:</p>
<table>
<thead>
<tr class="header">
<th>属性值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>‘figure points’</td>
<td>以绘图区左下角为参考，单位是点数</td>
</tr>
<tr class="even">
<td>‘figure pixels’</td>
<td>以绘图区左下角为参考，单位是像素数</td>
</tr>
<tr class="odd">
<td>‘figure fraction’</td>
<td>以绘图区左下角为参考，单位是百分比</td>
</tr>
<tr class="even">
<td>‘axes points’</td>
<td>以子绘图区左下角为参考，单位是点数（一个figure可以有多个axes，默认为1个）</td>
</tr>
<tr class="odd">
<td>‘axes pixels’</td>
<td>以子绘图区左下角为参考，单位是像素数</td>
</tr>
<tr class="even">
<td>‘axes fraction’</td>
<td>以子绘图区左下角为参考，单位是百分比</td>
</tr>
<tr class="odd">
<td>‘data’</td>
<td>以被注释的坐标点xy为参考 (默认值)</td>
</tr>
<tr class="even">
<td>‘polar’</td>
<td>不使用本地数据坐标系，使用极坐标系</td>
</tr>
</tbody>
</table></li>
<li><p><code>textcoords</code>：用来定义 <code>xytext</code> 参数的坐标系，默认与 <code>xycoords</code> 属性值相同，也可设为不同的值。除了允许输入 <code>xycoords</code> 的属性值，还允许输入以下两种：</p>
<table>
<thead>
<tr class="header">
<th>属性值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>‘offset points’</td>
<td>相对于被注释点xy的偏移量（单位是点）</td>
</tr>
<tr class="even">
<td>‘offset pixels’</td>
<td>相对于被注释点xy的偏移量（单位是像素）</td>
</tr>
</tbody>
</table></li>
<li><p><code>arrowprops</code>：用来定义指向箭头的样式，<code>dict</code>（字典）型数据，如果该属性非空，则会在注释文本和被注释点之间画一个箭头。如果不设置 <code>arrowstyle</code> 关键字，则允许包含以下关键字：</p>
<table>
<thead>
<tr class="header">
<th>关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>width</td>
<td>箭头的宽度（单位是点）</td>
</tr>
<tr class="even">
<td>headwidth</td>
<td>箭头头部的宽度（点）</td>
</tr>
<tr class="odd">
<td>headlength</td>
<td>箭头头部的长度（点）</td>
</tr>
<tr class="even">
<td>shrink</td>
<td>箭头两端收缩的百分比（占总长）</td>
</tr>
<tr class="odd">
<td>?</td>
<td>任何 <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.patches.FancyArrowPatch.html">matplotlib.patches.FancyArrowPatch</a> 中的关键字</td>
</tr>
</tbody>
</table>
<p>如果设置了 <code>arrowstyle</code> 关键字，以上关键字就不能使用。允许的值有：</p>
<table>
<thead>
<tr class="header">
<th>箭头的样式</th>
<th>属性</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>'-'</code></td>
<td>None</td>
</tr>
<tr class="even">
<td><code>'-&gt;'</code></td>
<td>head_length=0.4,head_width=0.2</td>
</tr>
<tr class="odd">
<td><code>'-['</code></td>
<td>widthB=1.0,lengthB=0.2,angleB=None</td>
</tr>
<tr class="even">
<td><code>'|-|'</code></td>
<td>widthA=1.0,widthB=1.0</td>
</tr>
<tr class="odd">
<td><code>'-|&gt;'</code></td>
<td>head_length=0.4,head_width=0.2</td>
</tr>
<tr class="even">
<td><code>'&lt;-'</code></td>
<td>head_length=0.4,head_width=0.2</td>
</tr>
<tr class="odd">
<td><code>'&lt;-&gt;'</code></td>
<td>head_length=0.4,head_width=0.2</td>
</tr>
<tr class="even">
<td><code>'&lt;|-'</code></td>
<td>head_length=0.4,head_width=0.2</td>
</tr>
<tr class="odd">
<td><code>'&lt;|-|&gt;'</code></td>
<td>head_length=0.4,head_width=0.2</td>
</tr>
<tr class="even">
<td><code>'fancy'</code></td>
<td>head_length=0.4,head_width=0.4,tail_width=0.4</td>
</tr>
<tr class="odd">
<td><code>'simple'</code></td>
<td>head_length=0.5,head_width=0.5,tail_width=0.2</td>
</tr>
</tbody>
</table>
<p>下图展现了不同的 <code>arrowstyle</code> 的不同形式：</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73ij5F.png' style='zoom:80%' /></p>
<p><a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.patches.FancyArrowPatch.html">FancyArrowPatch</a>的关键字包括:</p>
<table>
<thead>
<tr class="header">
<th>Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>arrowstyle</td>
<td>箭头的样式</td>
</tr>
<tr class="even">
<td>connectionstyle</td>
<td>连接线的样式</td>
</tr>
<tr class="odd">
<td>relpos</td>
<td>箭头起始点相对注释文本的位置，默认为 (0.5, 0.5)，即文本的中心，（0，0）表示左下角，（1，1）表示右上角</td>
</tr>
<tr class="even">
<td>patchA</td>
<td>箭头起点处的图形（matplotlib.patches对象），默认是注释文字框</td>
</tr>
<tr class="odd">
<td>patchB</td>
<td>箭头终点处的图形（matplotlib.patches对象），默认为空</td>
</tr>
<tr class="even">
<td>shrinkA</td>
<td>箭头起点的缩进点数，默认为2</td>
</tr>
<tr class="odd">
<td>shrinkB</td>
<td>箭头终点的缩进点数，默认为2</td>
</tr>
<tr class="even">
<td>mutation_scale</td>
<td>default is text size (in points)</td>
</tr>
<tr class="odd">
<td>mutation_aspect</td>
<td>default is 1.</td>
</tr>
<tr class="even">
<td>?</td>
<td>any key for <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.patches.PathPatch.html">matplotlib.patches.PathPatch</a></td>
</tr>
</tbody>
</table></li>
<li><p><code>annotation_clip</code>: 布尔值，可选参数，默认为空。设为 <code>True</code> 时，只有被注释点在 <code>axes</code> 时才绘制注释；设为 <code>False</code> 时，无论被注释点在哪里都绘制注释。仅当 <code>xycoords</code> 为 <code>data</code> 时，默认值空相当于 <code>True</code> 。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#此代码主要给示范了不同的arrowstyle以及FancyArrowPatch的样式</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib.patches <span class="keyword">as</span> mpatches</span><br><span class="line">fig, axs = plt.subplots(<span class="number">2</span>, <span class="number">2</span>, figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">x1, y1 = <span class="number">0.3</span>, <span class="number">0.3</span></span><br><span class="line">x2, y2 = <span class="number">0.7</span>, <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line">ax = axs.flat[<span class="number">0</span>]</span><br><span class="line">ax.plot([x1, x2], [y1, y2], <span class="string">&quot;.&quot;</span>)</span><br><span class="line">el = mpatches.Ellipse((x1, y1), <span class="number">0.3</span>, <span class="number">0.4</span>, angle=<span class="number">30</span>, alpha=<span class="number">0.2</span>)</span><br><span class="line">ax.add_artist(el)<span class="comment">#在axes中创建一个artist</span></span><br><span class="line">ax.annotate(<span class="string">&quot;&quot;</span>,</span><br><span class="line">            xy=(x1, y1), xycoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            xytext=(x2, y2), textcoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            arrowprops=<span class="built_in">dict</span>(arrowstyle=<span class="string">&quot;-&quot;</span>,<span class="comment">#箭头的样式</span></span><br><span class="line">                            color=<span class="string">&quot;0.5&quot;</span>,</span><br><span class="line">                            patchB=<span class="literal">None</span>,</span><br><span class="line">                            shrinkB=<span class="number">0</span>,</span><br><span class="line">                            connectionstyle=<span class="string">&quot;arc3,rad=0.3&quot;</span>,</span><br><span class="line">                            ),</span><br><span class="line">            )</span><br><span class="line"><span class="comment">#在整个代码中使用Transform=ax.transAx表示坐标相对于axes的bounding box，其中(0，0)是轴的左下角，(1，1)是右上角。</span></span><br><span class="line">ax.text(<span class="number">.05</span>, <span class="number">.95</span>, <span class="string">&quot;connect&quot;</span>, transform=ax.transAxes, ha=<span class="string">&quot;left&quot;</span>, va=<span class="string">&quot;top&quot;</span>)</span><br><span class="line"></span><br><span class="line">ax = axs.flat[<span class="number">1</span>]</span><br><span class="line">ax.plot([x1, x2], [y1, y2], <span class="string">&quot;.&quot;</span>)</span><br><span class="line">el = mpatches.Ellipse((x1, y1), <span class="number">0.3</span>, <span class="number">0.4</span>, angle=<span class="number">30</span>, alpha=<span class="number">0.2</span>)</span><br><span class="line">ax.add_artist(el)</span><br><span class="line">ax.annotate(<span class="string">&quot;&quot;</span>,</span><br><span class="line">            xy=(x1, y1), xycoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            xytext=(x2, y2), textcoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            arrowprops=<span class="built_in">dict</span>(arrowstyle=<span class="string">&quot;-&quot;</span>,</span><br><span class="line">                            color=<span class="string">&quot;0.5&quot;</span>,</span><br><span class="line">                            patchB=el,<span class="comment">#箭头终点处的图形</span></span><br><span class="line">                            shrinkB=<span class="number">0</span>,</span><br><span class="line">                            connectionstyle=<span class="string">&quot;arc3,rad=0.3&quot;</span>,</span><br><span class="line">                            ),</span><br><span class="line">            )</span><br><span class="line">ax.text(<span class="number">.05</span>, <span class="number">.95</span>, <span class="string">&quot;clip&quot;</span>, transform=ax.transAxes, ha=<span class="string">&quot;left&quot;</span>, va=<span class="string">&quot;top&quot;</span>)</span><br><span class="line"></span><br><span class="line">ax = axs.flat[<span class="number">2</span>]</span><br><span class="line">ax.plot([x1, x2], [y1, y2], <span class="string">&quot;.&quot;</span>)</span><br><span class="line">el = mpatches.Ellipse((x1, y1), <span class="number">0.3</span>, <span class="number">0.4</span>, angle=<span class="number">30</span>, alpha=<span class="number">0.2</span>)</span><br><span class="line">ax.add_artist(el)</span><br><span class="line">ax.annotate(<span class="string">&quot;&quot;</span>,</span><br><span class="line">            xy=(x1, y1), xycoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            xytext=(x2, y2), textcoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            arrowprops=<span class="built_in">dict</span>(arrowstyle=<span class="string">&quot;-&quot;</span>,</span><br><span class="line">                            color=<span class="string">&quot;0.5&quot;</span>,</span><br><span class="line">                            patchB=el,</span><br><span class="line">                            shrinkB=<span class="number">5</span>,</span><br><span class="line">                            connectionstyle=<span class="string">&quot;arc3,rad=0.3&quot;</span>,</span><br><span class="line">                            ),</span><br><span class="line">            )</span><br><span class="line">ax.text(<span class="number">.05</span>, <span class="number">.95</span>, <span class="string">&quot;shrink&quot;</span>, transform=ax.transAxes, ha=<span class="string">&quot;left&quot;</span>, va=<span class="string">&quot;top&quot;</span>)</span><br><span class="line"></span><br><span class="line">ax = axs.flat[<span class="number">3</span>]</span><br><span class="line">ax.plot([x1, x2], [y1, y2], <span class="string">&quot;.&quot;</span>)</span><br><span class="line">el = mpatches.Ellipse((x1, y1), <span class="number">0.3</span>, <span class="number">0.4</span>, angle=<span class="number">30</span>, alpha=<span class="number">0.2</span>)</span><br><span class="line">ax.add_artist(el)</span><br><span class="line">ax.annotate(<span class="string">&quot;&quot;</span>,</span><br><span class="line">            xy=(x1, y1), xycoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            xytext=(x2, y2), textcoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            arrowprops=<span class="built_in">dict</span>(arrowstyle=<span class="string">&quot;fancy&quot;</span>,</span><br><span class="line">                            color=<span class="string">&quot;0.5&quot;</span>,</span><br><span class="line">                            patchB=el,</span><br><span class="line">                            shrinkB=<span class="number">5</span>,<span class="comment">#箭头终点的缩进点数</span></span><br><span class="line">                            connectionstyle=<span class="string">&quot;arc3,rad=0.3&quot;</span>,</span><br><span class="line">                            ),</span><br><span class="line">            )</span><br><span class="line">ax.text(<span class="number">.05</span>, <span class="number">.95</span>, <span class="string">&quot;mutate&quot;</span>, transform=ax.transAxes, ha=<span class="string">&quot;left&quot;</span>, va=<span class="string">&quot;top&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ax <span class="keyword">in</span> axs.flat:</span><br><span class="line">    ax.<span class="built_in">set</span>(xlim=(<span class="number">0</span>, <span class="number">1</span>), ylim=(<span class="number">0</span>, <span class="number">1</span>), xticks=[], yticks=[], aspect=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73iXUU.png' style='zoom:80%' /></p></li>
<li><p>两个点之间的连线</p>
<p>两个点之间的连接路径主要有 <code>connectionstyle</code> 和以下样式确定</p>
<table>
<thead>
<tr class="header">
<th>Name Attrs</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>angle</td>
<td>angleA=90,angleB=0,rad=0.0</td>
</tr>
<tr class="even">
<td>angle3</td>
<td>angleA=90,angleB=0</td>
</tr>
<tr class="odd">
<td>arc</td>
<td>angleA=0,angleB=0,armA=None,armB=None,rad=0.0</td>
</tr>
<tr class="even">
<td>arc3</td>
<td>rad=0.0</td>
</tr>
<tr class="odd">
<td>bar</td>
<td>armA=0.0,armB=0.0,fraction=0.3,angle=None</td>
</tr>
</tbody>
</table>
<p>其中 <code>angle3</code> 和 <code>arc3</code> 中的 <code>3</code> 意味着所得到的路径是二次样条段（ 三个控制点）。下面的例子丰富的展现了连接线的用法，可以参考学习：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo_con_style</span>(<span class="params">ax, connectionstyle</span>):</span></span><br><span class="line">    x1, y1 = <span class="number">0.3</span>, <span class="number">0.2</span></span><br><span class="line">    x2, y2 = <span class="number">0.8</span>, <span class="number">0.6</span></span><br><span class="line"></span><br><span class="line">    ax.plot([x1, x2], [y1, y2], <span class="string">&quot;.&quot;</span>)</span><br><span class="line">    ax.annotate(<span class="string">&quot;&quot;</span>,</span><br><span class="line">                xy=(x1, y1), xycoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">                xytext=(x2, y2), textcoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">                arrowprops=<span class="built_in">dict</span>(arrowstyle=<span class="string">&quot;-&gt;&quot;</span>, color=<span class="string">&quot;0.5&quot;</span>,</span><br><span class="line">                                shrinkA=<span class="number">5</span>, shrinkB=<span class="number">5</span>,</span><br><span class="line">                                patchA=<span class="literal">None</span>, patchB=<span class="literal">None</span>,</span><br><span class="line">                                connectionstyle=connectionstyle,</span><br><span class="line">                                ),</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">ax.text(<span class="number">.05</span>, <span class="number">.95</span>, connectionstyle.replace(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;,\n&quot;</span>),</span><br><span class="line">        transform=ax.transAxes, ha=<span class="string">&quot;left&quot;</span>, va=<span class="string">&quot;top&quot;</span>)</span><br><span class="line"></span><br><span class="line">fig, axs = plt.subplots(<span class="number">3</span>, <span class="number">5</span>, figsize=(<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">demo_con_style(axs[<span class="number">0</span>, <span class="number">0</span>], <span class="string">&quot;angle3,angleA=90,angleB=0&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">1</span>, <span class="number">0</span>], <span class="string">&quot;angle3,angleA=0,angleB=90&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">0</span>, <span class="number">1</span>], <span class="string">&quot;arc3,rad=0.&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">1</span>, <span class="number">1</span>], <span class="string">&quot;arc3,rad=0.3&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">2</span>, <span class="number">1</span>], <span class="string">&quot;arc3,rad=-0.3&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">0</span>, <span class="number">2</span>], <span class="string">&quot;angle,angleA=-90,angleB=180,rad=0&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">1</span>, <span class="number">2</span>], <span class="string">&quot;angle,angleA=-90,angleB=180,rad=5&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">2</span>, <span class="number">2</span>], <span class="string">&quot;angle,angleA=-90,angleB=10,rad=5&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">0</span>, <span class="number">3</span>], <span class="string">&quot;arc,angleA=-90,angleB=0,armA=30,armB=30,rad=0&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">1</span>, <span class="number">3</span>], <span class="string">&quot;arc,angleA=-90,angleB=0,armA=30,armB=30,rad=5&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">2</span>, <span class="number">3</span>], <span class="string">&quot;arc,angleA=-90,angleB=0,armA=0,armB=40,rad=0&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">0</span>, <span class="number">4</span>], <span class="string">&quot;bar,fraction=0.3&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">1</span>, <span class="number">4</span>], <span class="string">&quot;bar,fraction=-0.3&quot;</span>)</span><br><span class="line">demo_con_style(axs[<span class="number">2</span>, <span class="number">4</span>], <span class="string">&quot;bar,angle=180,fraction=-0.2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ax <span class="keyword">in</span> axs.flat:</span><br><span class="line">    ax.<span class="built_in">set</span>(xlim=(<span class="number">0</span>, <span class="number">1</span>), ylim=(<span class="number">0</span>, <span class="number">1</span>), xticks=[], yticks=[], aspect=<span class="number">1</span>)</span><br><span class="line">fig.tight_layout(pad=<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results：</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73iOET.png' style='zoom:80%' /></p></li>
<li><p>**kwargs：该参数接受任何 <code>Text</code> 的参数</p></li>
</ul>
<p>详细的参数介绍可以参考我之前的博客 <a href="https://www.yangsuoly.com/2020/11/30/Matplotlib/">Matplotlib</a> 的 3.2 节 <strong>标注点的绘制</strong>。 annotate的参数非常复杂，这里仅仅展示两个简单的例子，更多参数可以查看<a href="https://matplotlib.org/stable/tutorials/text/annotations.html#plotting-guide-annotation">官方文档中的annotate介绍</a></p>
<ul>
<li><p>A simple case</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot()</span><br><span class="line">ax.annotate(<span class="string">&quot;&quot;</span>,</span><br><span class="line">            xy=(<span class="number">0.2</span>, <span class="number">0.2</span>), xycoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            xytext=(<span class="number">0.8</span>, <span class="number">0.8</span>), textcoords=<span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">            arrowprops=<span class="built_in">dict</span>(arrowstyle=<span class="string">&quot;-&gt;&quot;</span>, connectionstyle=<span class="string">&quot;arc3,rad=0.2&quot;</span>)</span><br><span class="line">            );</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715Knx.md.png' style='zoom:80%' /></p></li>
<li><p>A complex case</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Figure 对象中创建一个 Axes 对象，每个 Axes 对象即为一个绘图区域</span></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">x = np.arange(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line">y = np.around(np.log(x), <span class="number">2</span>)</span><br><span class="line">ax.plot(x, y, marker = <span class="string">&#x27;o&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式1&#x27;</span>, xy = (x[<span class="number">1</span>], y[<span class="number">1</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>,</span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(arrowstyle = <span class="string">&#x27;-&gt;&#x27;</span>, connectionstyle = <span class="string">&#x27;angle3, angleA = 80, angleB = 50&#x27;</span>))</span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式2&#x27;</span>, xy = (x[<span class="number">3</span>], y[<span class="number">3</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>,</span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(facecolor = <span class="string">&#x27;black&#x27;</span>, shrink = <span class="number">0.05</span>, width = <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式3&#x27;</span>, xy = (x[<span class="number">5</span>], y[<span class="number">5</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>,</span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(facecolor = <span class="string">&#x27;green&#x27;</span>, headwidth = <span class="number">5</span>, headlength = <span class="number">10</span>),</span><br><span class="line">            bbox = <span class="built_in">dict</span>(boxstyle = <span class="string">&#x27;circle, pad = 0.5&#x27;</span>, fc = <span class="string">&#x27;yellow&#x27;</span>, ec = <span class="string">&#x27;k&#x27;</span>, lw = <span class="number">1</span>, alpha = <span class="number">0.5</span>))</span><br><span class="line"><span class="comment"># fc: facecolor, ec: edegcolor, lw: lineweight</span></span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式4&#x27;</span>, xy = (x[<span class="number">7</span>], y[<span class="number">7</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>,</span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(facecolor = <span class="string">&#x27;blue&#x27;</span>, headwidth = <span class="number">5</span>, headlength = <span class="number">10</span>),</span><br><span class="line">            bbox = <span class="built_in">dict</span>(boxstyle = <span class="string">&#x27;round, pad = 0.5&#x27;</span>, fc = <span class="string">&#x27;gray&#x27;</span>, ec = <span class="string">&#x27;k&#x27;</span>, lw = <span class="number">1</span>, alpha = <span class="number">0.5</span>))</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715nj1.png' style='zoom:80%' /></p></li>
</ul>
<p>以下两个 <code>block</code> 懂了之后，<code>annotate</code> 基本懂了。如果想更深入学习可以参看[]官网案例学习](https://matplotlib.org/api/_as_gen/matplotlib.axes.Axes.annotate.html#matplotlib.axes.Axes.annotate)</p>
<ul>
<li><p>More Case one</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以步长0.005绘制一个曲线</span></span><br><span class="line">x = np.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">0.005</span>)</span><br><span class="line">y = np.exp(-x/<span class="number">2.</span>) * np.sin(<span class="number">2</span>*np.pi*x)</span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">ax.plot(x, y)</span><br><span class="line">ax.set_xlim(<span class="number">0</span>, <span class="number">10</span>)<span class="comment">#设置x轴的范围</span></span><br><span class="line">ax.set_ylim(-<span class="number">1</span>, <span class="number">1</span>)<span class="comment">#设置x轴的范围</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 被注释点的数据轴坐标和所在的像素</span></span><br><span class="line">xdata, ydata = <span class="number">5</span>, <span class="number">0</span></span><br><span class="line">xdisplay, ydisplay = ax.transData.transform_point((xdata, ydata))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置注释文本的样式和箭头的样式</span></span><br><span class="line">bbox = <span class="built_in">dict</span>(boxstyle=<span class="string">&quot;round&quot;</span>, fc=<span class="string">&quot;0.8&quot;</span>)</span><br><span class="line">arrowprops = <span class="built_in">dict</span>(</span><br><span class="line">    arrowstyle = <span class="string">&quot;-&gt;&quot;</span>,</span><br><span class="line">    connectionstyle = <span class="string">&quot;angle,angleA=0,angleB=90,rad=10&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置偏移量</span></span><br><span class="line">offset = <span class="number">72</span></span><br><span class="line"><span class="comment"># xycoords默认为&#x27;data&#x27;数据轴坐标，对坐标点（5,0）添加注释</span></span><br><span class="line"><span class="comment"># 注释文本参考被注释点设置偏移量，向左2*72points，向上72points</span></span><br><span class="line">ax.annotate(<span class="string">&#x27;data = (%.1f, %.1f)&#x27;</span>%(xdata, ydata),</span><br><span class="line">            (xdata, ydata), xytext=(-<span class="number">2</span>*offset, offset), textcoords=<span class="string">&#x27;offset points&#x27;</span>,</span><br><span class="line">            bbox=bbox, arrowprops=arrowprops)</span><br><span class="line"></span><br><span class="line"><span class="comment"># xycoords以绘图区左下角为参考，单位为像素</span></span><br><span class="line"><span class="comment"># 注释文本参考被注释点设置偏移量，向右0.5*72points，向下72points</span></span><br><span class="line">disp = ax.annotate(<span class="string">&#x27;display = (%.1f, %.1f)&#x27;</span>%(xdisplay, ydisplay),</span><br><span class="line">            (xdisplay, ydisplay), xytext=(<span class="number">0.5</span>*offset, -offset),</span><br><span class="line">            xycoords=<span class="string">&#x27;figure pixels&#x27;</span>,</span><br><span class="line">            textcoords=<span class="string">&#x27;offset points&#x27;</span>,</span><br><span class="line">            bbox=bbox, arrowprops=arrowprops)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73iqbV.png' style='zoom:80%' /></p></li>
<li><p>More Case two <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制一个极地坐标，再以0.001为步长，画一条螺旋曲线</span></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>, polar=<span class="literal">True</span>)</span><br><span class="line">r = np.arange(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0.001</span>)</span><br><span class="line">theta = <span class="number">2</span> * <span class="number">2</span>*np.pi * r</span><br><span class="line">line, = ax.plot(theta, r, color=<span class="string">&#x27;#ee8d18&#x27;</span>, lw=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对索引为800处画一个圆点，并做注释</span></span><br><span class="line">ind = <span class="number">800</span></span><br><span class="line">thisr, thistheta = r[ind], theta[ind]</span><br><span class="line">ax.plot([thistheta], [thisr], <span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">ax.annotate(<span class="string">&#x27;a polar annotation&#x27;</span>,</span><br><span class="line">            xy=(thistheta, thisr),  <span class="comment"># 被注释点遵循极坐标系，坐标为角度和半径</span></span><br><span class="line">            xytext=(<span class="number">0.05</span>, <span class="number">0.05</span>),    <span class="comment"># 注释文本放在绘图区的0.05百分比处</span></span><br><span class="line">            textcoords=<span class="string">&#x27;figure fraction&#x27;</span>,</span><br><span class="line">            arrowprops=<span class="built_in">dict</span>(facecolor=<span class="string">&#x27;black&#x27;</span>, shrink=<span class="number">0.05</span>),<span class="comment"># 箭头线为黑色，两端缩进5%</span></span><br><span class="line">            horizontalalignment=<span class="string">&#x27;left&#x27;</span>,<span class="comment"># 注释文本的左端和低端对齐到指定位置</span></span><br><span class="line">            verticalalignment=<span class="string">&#x27;bottom&#x27;</span>,</span><br><span class="line">            )</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p></li>
</ul>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73ibD0.png' style='zoom:80%' /></p>
<h3 id="字体的属性设置">5.1.6 字体的属性设置</h3>
<p>字体设置一般有全局字体设置和自定义局部字体设置两种方法。为方便在图中加入合适的字体，可以尝试了解中文字体的英文名称,该链接告诉了常用中文的英文名称：<a href="https://www.cnblogs.com/chendc/p/9298832.html">Here</a>。</p>
<ul>
<li><p>全局修改</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#该block讲述如何在matplotlib里面，修改字体默认属性，完成全局字体的更改。</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimSun&#x27;</span>]    <span class="comment"># 指定默认字体为新宋体。</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span>      <span class="comment"># 解决保存图像时 负号&#x27;-&#x27; 显示为方块和报错的问题。</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>局部修改</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#局部字体的修改方法1</span></span><br><span class="line">x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line">plt.plot(x, label=<span class="string">&#x27;小示例图标签&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接用字体的名字</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;x 轴名称参数&#x27;</span>, fontproperties=<span class="string">&#x27;Microsoft YaHei&#x27;</span>, fontsize=<span class="number">16</span>)         <span class="comment"># 设置x轴名称，采用微软雅黑字体</span></span><br><span class="line">plt.ylabel(<span class="string">&#x27;y 轴名称参数&#x27;</span>, fontproperties=<span class="string">&#x27;Microsoft YaHei&#x27;</span>, fontsize=<span class="number">14</span>)         <span class="comment"># 设置Y轴名称</span></span><br><span class="line">plt.title(<span class="string">&#x27;坐标系的标题&#x27;</span>,  fontproperties=<span class="string">&#x27;Microsoft YaHei&#x27;</span>, fontsize=<span class="number">20</span>)         <span class="comment"># 设置坐标系标题的字体</span></span><br><span class="line">plt.legend(loc=<span class="string">&#x27;lower right&#x27;</span>, prop=&#123;<span class="string">&quot;family&quot;</span>: <span class="string">&#x27;Microsoft YaHei&#x27;</span>&#125;, fontsize=<span class="number">10</span>) ;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715mcR.png' style='zoom:80%' /></p></li>
</ul>
<h2 id="tick-上的文本">5.2 <code>Tick</code> 上的文本</h2>
<p>设置 <code>tick</code>（刻度）和 <code>ticklabel</code>（刻度标签）也是可视化中经常需要操作的步骤，<code>matplotlib</code> 既提供了自动生成刻度和刻度标签的模式（默认状态），同时也提供了许多灵活设置的方式。</p>
<h3 id="simple-mode">5.2.1 Simple mode</h3>
<p>可以使用 <code>axis</code> 的 <code>set_ticks</code> 方法手动设置标签位置，使用 <code>axis</code> 的 <code>set_ticklabels</code> 方法手动设置标签格式。例如：</p>
<ul>
<li><p><code>set_ticks</code> 手动设置标签位置</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x1 = np.linspace(<span class="number">0.0</span>, <span class="number">5.0</span>, <span class="number">100</span>)</span><br><span class="line">y1 = np.cos(<span class="number">2</span> * np.pi * x1) * np.exp(-x1)</span><br><span class="line"></span><br><span class="line">fig, axs = plt.subplots(<span class="number">2</span>, <span class="number">1</span>, figsize=(<span class="number">5</span>, <span class="number">3</span>), tight_layout=<span class="literal">True</span>)</span><br><span class="line">axs[<span class="number">0</span>].plot(x1, y1)</span><br><span class="line">axs[<span class="number">1</span>].plot(x1, y1)</span><br><span class="line">axs[<span class="number">1</span>].xaxis.set_ticks(np.arange(<span class="number">0.</span>, <span class="number">10.1</span>, <span class="number">2.</span>));</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715e39.png' style='zoom:80%' /></p>
<p><strong>Note</strong>：使用 <code>axis的set_ticks</code> 方法手动设置标签位置的例子，该案例中由于 <code>tick</code> 设置过大，所以会影响绘图美观，不建议用此方式进行设置 <code>tick</code>。</p></li>
<li><p><code>set_ticklabels</code> 手动设置标签格式</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, axs = plt.subplots(<span class="number">2</span>, <span class="number">1</span>, figsize=(<span class="number">12</span>, <span class="number">6</span>), tight_layout=<span class="literal">True</span>)</span><br><span class="line">axs[<span class="number">0</span>].plot(x1, y1)</span><br><span class="line">axs[<span class="number">1</span>].plot(x1, y1)</span><br><span class="line">ticks = np.arange(<span class="number">0.</span>, <span class="number">8.1</span>, <span class="number">2.</span>)</span><br><span class="line">tickla = [<span class="string">f&#x27;<span class="subst">&#123;tick:<span class="number">1.2</span>f&#125;</span>&#x27;</span> <span class="keyword">for</span> tick <span class="keyword">in</span> ticks]</span><br><span class="line">axs[<span class="number">1</span>].xaxis.set_ticks(ticks)</span><br><span class="line">axs[<span class="number">1</span>].xaxis.set_ticklabels(tickla);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715Z9J.png' style='zoom:80%' /></p></li>
<li><p>不更改刻度，直接修改刻度标签</p>
<p>一般绘图时会自动创建刻度，而如果通过上面的例子使用 <code>set_ticks</code> 创建刻度可能会导致 <code>tick</code> 的范围与所绘制图形的范围不一致的问题。所以在下面的案例中，<code>axs[1]</code>中 <code>set_xtick</code> 的设置要与数据范围所对应，然后再通过 <code>set_xticklabels</code> 设置刻度所对应的标签。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">fig, axs = plt.subplots(<span class="number">2</span>, <span class="number">1</span>, figsize=(<span class="number">12</span>, <span class="number">6</span>), tight_layout=<span class="literal">True</span>)</span><br><span class="line">x1 = np.linspace(<span class="number">0.0</span>, <span class="number">6.0</span>, <span class="number">100</span>)</span><br><span class="line">y1 = np.cos(<span class="number">2</span> * np.pi * x1) * np.exp(-x1)</span><br><span class="line">axs[<span class="number">0</span>].plot(x1, y1)</span><br><span class="line">axs[<span class="number">0</span>].set_xticks([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>])</span><br><span class="line">axs[<span class="number">0</span>].set_xticklabels([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>], fontsize = <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">axs[<span class="number">1</span>].plot(x1, y1)</span><br><span class="line">axs[<span class="number">1</span>].set_xticks([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]) <span class="comment"># 要将 x 轴的刻度放在数据范围中的哪些位置</span></span><br><span class="line">axs[<span class="number">1</span>].set_xticklabels([<span class="string">&#x27;zero&#x27;</span>,<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>, <span class="string">&#x27;four&#x27;</span>, <span class="string">&#x27;five&#x27;</span>,<span class="string">&#x27;six&#x27;</span>], <span class="comment"># 设置刻度对应的标签</span></span><br><span class="line">                   rotation=<span class="number">30</span>, fontsize=<span class="number">14</span>) <span class="comment"># rotation选项设定 x 刻度标签倾斜30度。</span></span><br><span class="line">axs[<span class="number">1</span>].xaxis.set_ticks_position(<span class="string">&#x27;bottom&#x27;</span>)<span class="comment"># set_ticks_position()方法是用来设置刻度所在的位置，常用的参数有bottom、top、both、none</span></span><br><span class="line">print(axs[<span class="number">1</span>].xaxis.get_ticklines());</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715Eh4.png' style='zoom:80%' /></p></li>
</ul>
<h3 id="tick-locators-and-formatters">5.2.2 Tick Locators and Formatters</h3>
<p>除了上述的简单模式，还可以使用<code>Tick Locators and Formatters</code>完成对于刻度位置和刻度标签的设置。 其中 <a href="https://matplotlib.org/api/_as_gen/matplotlib.axis.Axis.set_major_locator.html#matplotlib.axis.Axis.set_major_locator">Axis.set_major_locator</a> 和 <a href="https://matplotlib.org/api/_as_gen/matplotlib.axis.Axis.set_minor_locator.html#matplotlib.axis.Axis.set_minor_locator">Axis.set_minor_locator</a> 方法用来设置标签的位置，<a href="https://matplotlib.org/api/_as_gen/matplotlib.axis.Axis.set_major_formatter.html#matplotlib.axis.Axis.set_major_formatter">Axis.set_major_formatter</a> 和 <a href="https://matplotlib.org/api/_as_gen/matplotlib.axis.Axis.set_minor_formatter.html#matplotlib.axis.Axis.set_minor_formatter">Axis.set_minor_formatter</a>方法用来设置标签的格式。这种方式的好处是不用显式地列举出刻度值列表。</p>
<p><code>set_major_formatter</code> 和 <code>set_minor_formatter</code> 这两个 <code>formatter</code> 格式命令可以接收字符串格式（<code>matplotlib.ticker.StrMethodFormatter</code>）或函数参数（<code>matplotlib.ticker.FuncFormatter</code>）来设置刻度值的格式 。</p>
<ol type="1">
<li><p>Tick Formatters</p>
<ul>
<li><p><code>FormatStrFormatter</code> 接收字符串</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 接收字符串格式的例子</span></span><br><span class="line">fig, axs = plt.subplots(<span class="number">2</span>, <span class="number">2</span>, figsize=(<span class="number">8</span>, <span class="number">5</span>), tight_layout=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">for</span> n, ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axs.flat):</span><br><span class="line">    ax.plot(x1*<span class="number">10.</span>, y1)</span><br><span class="line"></span><br><span class="line">formatter = matplotlib.ticker.FormatStrFormatter(<span class="string">&#x27;%1.1f&#x27;</span>)</span><br><span class="line">axs[<span class="number">0</span>, <span class="number">1</span>].xaxis.set_major_formatter(formatter)</span><br><span class="line"></span><br><span class="line">formatter = matplotlib.ticker.FormatStrFormatter(<span class="string">&#x27;-%1.1f&#x27;</span>)</span><br><span class="line">axs[<span class="number">1</span>, <span class="number">0</span>].xaxis.set_major_formatter(formatter)</span><br><span class="line"></span><br><span class="line">formatter = matplotlib.ticker.FormatStrFormatter(<span class="string">&#x27;%1.5f&#x27;</span>)</span><br><span class="line">axs[<span class="number">1</span>, <span class="number">1</span>].xaxis.set_major_formatter(formatter);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715ANF.png' style='zoom:80%' /></p></li>
<li><p><code>FuncFormatter</code> 接收函数参数</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">formatoddticks</span>(<span class="params">x, pos</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Format odd tick positions.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> x % <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;<span class="subst">&#123;x:<span class="number">1.2</span>f&#125;</span>&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">5</span>, <span class="number">3</span>), tight_layout=<span class="literal">True</span>)</span><br><span class="line">ax.plot(x1, y1)</span><br><span class="line">ax.xaxis.set_major_formatter(formatoddticks);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715kAU.png' style='zoom:80%' /></p></li>
</ul></li>
<li><p>Tick Locators</p>
<p>在普通的绘图中，我们可以直接通过上图的 <code>set_ticks</code> 进行设置刻度的位置，缺点是需要自己指定或者接受 <code>matplotlib</code> 默认给定的刻度。当需要更改刻度的位置时，<code>matplotlib</code> 给了常用的几种 <code>locator</code> 的类型。如果要绘制更复杂的图，可以先设置 <code>locator</code> 的类型，然后通过 <code>axs.xaxis.set_major_locator(locator)</code> 绘制即可。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">locator=plt.MaxNLocator(nbins=<span class="number">7</span>)  </span><br><span class="line">locator=plt.FixedLocator(locs=[<span class="number">0</span>,<span class="number">0.5</span>,<span class="number">1.5</span>,<span class="number">2.5</span>,<span class="number">3.5</span>,<span class="number">4.5</span>,<span class="number">5.5</span>,<span class="number">6</span>])<span class="comment">#直接指定刻度所在的位置  </span></span><br><span class="line">locator=plt.AutoLocator()<span class="comment">#自动分配刻度值的位置  </span></span><br><span class="line">locator=plt.IndexLocator(offset=<span class="number">0.5</span>, base=<span class="number">1</span>)<span class="comment">#面元间距是1，从0.5开始  </span></span><br><span class="line">locator=plt.MultipleLocator(<span class="number">1.5</span>)<span class="comment">#将刻度的标签设置为1.5的倍数  </span></span><br><span class="line">locator=plt.LinearLocator(numticks=<span class="number">5</span>)<span class="comment">#线性划分5等分，4个刻度  </span></span><br></pre></td></tr></table></figure></p>
<p><strong>Case</strong>:</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, axs = plt.subplots(<span class="number">2</span>, <span class="number">2</span>, figsize=(<span class="number">8</span>, <span class="number">5</span>), tight_layout=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">for</span> n, ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axs.flat):</span><br><span class="line">    ax.plot(x1*<span class="number">10.</span>, y1)</span><br><span class="line"></span><br><span class="line">locator = matplotlib.ticker.AutoLocator()</span><br><span class="line">axs[<span class="number">0</span>, <span class="number">0</span>].xaxis.set_major_locator(locator)</span><br><span class="line"></span><br><span class="line">locator = matplotlib.ticker.MaxNLocator(nbins=<span class="number">10</span>)</span><br><span class="line">axs[<span class="number">0</span>, <span class="number">1</span>].xaxis.set_major_locator(locator)</span><br><span class="line"></span><br><span class="line">locator = matplotlib.ticker.MultipleLocator(<span class="number">5</span>)</span><br><span class="line">axs[<span class="number">1</span>, <span class="number">0</span>].xaxis.set_major_locator(locator)</span><br><span class="line"></span><br><span class="line">locator = matplotlib.ticker.FixedLocator([<span class="number">0</span>,<span class="number">7</span>,<span class="number">14</span>,<span class="number">21</span>,<span class="number">28</span>])</span><br><span class="line">axs[<span class="number">1</span>, <span class="number">1</span>].xaxis.set_major_locator(locator);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715i7T.png' style='zoom:80%' /></p></li>
</ol>
<p>此外<code>matplotlib.dates</code> 模块还提供了特殊的设置日期型刻度格式和位置的方式：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 特殊的日期型locator和formatter</span></span><br><span class="line">locator = mdates.DayLocator(bymonthday=[<span class="number">1</span>,<span class="number">15</span>,<span class="number">25</span>])</span><br><span class="line">formatter = mdates.DateFormatter(<span class="string">&#x27;%b %d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">12</span>, <span class="number">6</span>), tight_layout=<span class="literal">True</span>)</span><br><span class="line">ax.xaxis.set_major_locator(locator)</span><br><span class="line">ax.xaxis.set_major_formatter(formatter)</span><br><span class="line">base = datetime.datetime(<span class="number">2017</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">time = [base + datetime.timedelta(days=x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x1))]</span><br><span class="line">ax.plot(time, y1)</span><br><span class="line">ax.tick_params(axis=<span class="string">&#x27;x&#x27;</span>, rotation=<span class="number">70</span>);</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715PBV.png' style='zoom:80%' /></p>
<h3 id="设置图形标题和坐标轴标签字体大小">5.2.3 设置图形标题和坐标轴标签字体大小</h3>
<p><code>Matplotlib</code> 中标题和轴的大小和字体可以通过使用 <code>set_size()</code> 方法调整 <code>fontsize</code> 参数并更改 <code>rcParams</code> 字典的值来设置。本小节的内容参考博客 <a href="https://www.delftstack.com/zh/howto/matplotlib/how-to-set-the-figure-title-and-axes-labels-font-size-in-matplotlib/#%E8%B0%83%E6%95%B4-fontsize-%E5%8F%82%E6%95%B0%E4%BB%A5%E5%9C%A8-matplotlib-%E4%B8%AD%E8%AE%BE%E7%BD%AE%E6%A0%87%E9%A2%98%E5%92%8C%E8%BD%B4%E7%9A%84%E5%AD%97%E4%BD%93%E5%A4%A7%E5%B0%8F">DelftStack</a></p>
<ul>
<li><p>调整 <code>fontsize</code> 参数以在 <code>Matplotlib</code> 中设置标题和轴的字体大小</p>
<p>我们可以在标签和标题方法中调整字体大小参数的适当值，以在 <code>Matplotlib</code> 中设置标签的字体大小和图表标题。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x=np.linspace(<span class="number">0</span>,<span class="number">5</span>,<span class="number">100</span>)</span><br><span class="line">y= np.sin(<span class="number">2</span> * np.pi * x)</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line">plt.plot(x,y,)</span><br><span class="line">plt.title(<span class="string">&#x27;Plot of sinx&#x27;</span>, fontsize=<span class="number">25</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;x&#x27;</span>, fontsize=<span class="number">20</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;sinx&#x27;</span>, fontsize=<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FpvR.png' style='zoom:80%' /></p></li>
<li><p>修改 <code>rcParams</code> 字典的默认值</p>
<p>可以更改存储在名为 <code>matplotlib.rcParams</code> 的全局字典式变量中的默认 <code>rc</code> 设置，以设置 <code>Matplotlib</code> 中标签的字体大小和图表标题。</p>
<p><strong><code>rcParams</code> 的结构</strong>：</p>
<p>可以通过 <code>plt.rcParams.keys()</code> 函数获取 <code>rcParams</code> 键的完整列表。</p>
<center>
<p>Table plt parameters</p>
</center>
<table>
<thead>
<tr class="header">
<th>Keys</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>axes.labelsize</td>
<td>x 和 y 标签的字体大小</td>
</tr>
<tr class="even">
<td>axes.titlesize</td>
<td>轴标题的字体大小</td>
</tr>
<tr class="odd">
<td>figure.titlesize</td>
<td>图形标题的大小（figure.suptitle()）</td>
</tr>
<tr class="even">
<td>xtick.labelsize</td>
<td>刻度标签的字体大小</td>
</tr>
<tr class="odd">
<td>ytick.labelsize</td>
<td>刻度标签的字体大小</td>
</tr>
<tr class="even">
<td>legend.fontsize</td>
<td>图例的字体大小（plt.legend()，fig.legend()）</td>
</tr>
<tr class="odd">
<td>legend.title_fontsize</td>
<td>图例标题的字体大小，无设置为默认轴。</td>
</tr>
</tbody>
</table>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x=np.linspace(<span class="number">0</span>,<span class="number">5</span>,<span class="number">100</span>)</span><br><span class="line">y= np.sin(<span class="number">2</span> * np.pi * x)</span><br><span class="line"></span><br><span class="line">parameters = &#123;<span class="string">&#x27;axes.labelsize&#x27;</span>: <span class="number">25</span>,</span><br><span class="line">          <span class="string">&#x27;axes.titlesize&#x27;</span>: <span class="number">35</span>&#125;</span><br><span class="line">plt.rcParams.update(parameters)</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.title(<span class="string">&#x27;Plot of sinx&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;sinx&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73ixC4.png' style='zoom:80%' /></p></li>
<li><p><code>set_size()</code> 方法在 <code>Matplotlib</code> 种设置标题和轴的字体大小</p>
<p>首先，我们使用 <code>get()</code> 方法返回绘图的轴。然后，使用 <code>axes.title.set_size(title_size)</code>，<code>axes.xaxis.label.set_size(x_size)</code> 和 <code>axes.yaxis.label.set_size(y_size)</code> 来更改标题、<code>x</code> 轴标签和 <code>y</code> 轴标签的字体大小。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x=np.linspace(<span class="number">0</span>,<span class="number">5</span>,<span class="number">100</span>)</span><br><span class="line">y= np.sin(<span class="number">2</span> * np.pi * x)</span><br><span class="line"></span><br><span class="line">axes = plt.gca()</span><br><span class="line">plt.plot(x, y)</span><br><span class="line">axes.set_title(<span class="string">&#x27;Plot of sinx&#x27;</span>)</span><br><span class="line">axes.set_xlabel(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">axes.set_ylabel(<span class="string">&#x27;sinx&#x27;</span>)</span><br><span class="line"></span><br><span class="line">axes.title.set_size(<span class="number">20</span>)</span><br><span class="line">axes.xaxis.label.set_size(<span class="number">16</span>)</span><br><span class="line">axes.yaxis.label.set_size(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73ixC4.png' style='zoom:80%' /></p></li>
</ul>
<h2 id="legend">5.3 Legend</h2>
<h3 id="术语与概念">5.3.1 术语与概念</h3>
<p>在具体学习图例之前，首先解释几个术语：</p>
<ul>
<li><p>legend entry（图例条目）</p>
<p>每个图例由一个或多个 <code>legend entries</code> 组成。一个 <code>entry</code> 包含一个 <code>key</code> 和其对应的 <code>label</code>。</p></li>
<li><p>legend key（图例键）</p>
<p>每个 <code>legend label</code> 左面的 <code>colored/patterned marker</code>（彩色/图案标记）</p></li>
<li><p>legend label（图例标签）</p>
<p>描述由 <code>key</code> 来表示的 <code>handle</code> 的文本</p></li>
<li><p>legend handle（图例句柄）</p>
<p>用于在图例中生成适当图例条目的原始对象</p></li>
</ul>
<p>以下面这个图为例，右侧的方框中的共有两个 <code>legend entry</code>；两个 <code>legend key</code>，分别是一个蓝色和一个黄色的 <code>legend key</code>；两个 <code>legend label</code>，一个名为 <code>Line up</code> 和一个名为 <code>Line Down</code> 的 <code>legend label</code>。</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715Cn0.md.png' style='zoom:80%' /></p>
<p>图例的绘制同样有 <code>OO</code> 模式和 <code>pyplot</code> 模式两种方式，写法都是一样的，使用 <code>legend()</code> 即可调用。</p>
<p>以下面的代码为例，在使用 <code>legend</code> 方法时，我们可以手动传入两个变量，句柄和标签，用以指定条目中的特定绘图对象和显示的标签值。当然通常更简单的操作是不传入任何参数，此时 <code>matplotlib</code> 会自动寻找合适的图例条目。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig, ax = plt.subplots()</span><br><span class="line">line_up, = ax.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], label=<span class="string">&#x27;Line 2&#x27;</span>)</span><br><span class="line">line_down, = ax.plot([<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>], label=<span class="string">&#x27;Line 1&#x27;</span>)</span><br><span class="line">ax.legend(handles = [line_up, line_down], labels = [<span class="string">&#x27;Line Up&#x27;</span>, <span class="string">&#x27;Line Down&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715Cn0.md.png' style='zoom:80%' /></p>
<h3 id="legend-的参数">5.3.2 legend 的参数</h3>
<p>参数：此方法接受以下描述的参数:</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 80%" />
</colgroup>
<thead>
<tr class="header">
<th>keyword</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>prop</td>
<td>the font property字体参数</td>
</tr>
<tr class="even">
<td>fontsize</td>
<td>the font size (used only if prop is not specified)</td>
</tr>
<tr class="odd">
<td>markerscale</td>
<td>the relative size of legend markers vs. original图例标记与原始标记的相对大小</td>
</tr>
<tr class="even">
<td>markerfirst</td>
<td>If True (default), marker is to left of the label.如果为True，则图例标记位于图例标签的左侧</td>
</tr>
<tr class="odd">
<td>numpoints</td>
<td>the number of points in the legend for line为线条图图例条目创建的标记点数</td>
</tr>
<tr class="even">
<td>scatterpoints</td>
<td>the number of points in the legend for scatter plot为散点图图例条目创建的标记点数</td>
</tr>
<tr class="odd">
<td>scatteryoffsets</td>
<td>a list of yoffsets for scatter symbols in legend为散点图图例条目创建的标记的垂直偏移量</td>
</tr>
<tr class="even">
<td>frameon</td>
<td>If True, draw the legend on a patch (frame).控制是否应在图例周围绘制框架</td>
</tr>
<tr class="odd">
<td>fancybox</td>
<td>If True, draw the frame with a round fancybox.控制是否应在构成图例背景的FancyBboxPatch周围启用圆边</td>
</tr>
<tr class="even">
<td>shadow</td>
<td>If True, draw a shadow behind legend.控制是否在图例后面画一个阴</td>
</tr>
<tr class="odd">
<td>framealpha</td>
<td>Transparency of the frame.控制图例框架的 Alpha 透明度</td>
</tr>
<tr class="even">
<td>edgecolor</td>
<td>Frame edgecolor.</td>
</tr>
<tr class="odd">
<td>facecolor</td>
<td>Frame facecolor.</td>
</tr>
<tr class="even">
<td>ncol</td>
<td>number of columns 设置图例分为n列展示</td>
</tr>
<tr class="odd">
<td>borderpad</td>
<td>the fractional whitespace inside the legend border图例边框的内边距</td>
</tr>
<tr class="even">
<td>labelspacing</td>
<td>the vertical space between the legend entries图例条目之间的垂直间距</td>
</tr>
<tr class="odd">
<td>handlelength</td>
<td>the length of the legend handles 图例句柄的长度</td>
</tr>
<tr class="even">
<td>handleheight</td>
<td>the height of the legend handles 图例句柄的高度</td>
</tr>
<tr class="odd">
<td>handletextpad</td>
<td>the pad between the legend handle and text 图例句柄和文本之间的间距</td>
</tr>
<tr class="even">
<td>borderaxespad</td>
<td>the pad between the axes and legend border轴与图例边框之间的距离</td>
</tr>
<tr class="odd">
<td>columnspacing</td>
<td>the spacing between columns 列间距</td>
</tr>
<tr class="even">
<td>title</td>
<td>the legend title</td>
</tr>
<tr class="odd">
<td>bbox_to_anchor</td>
<td>the bbox that the legend will be anchored.指定图例在轴的位置</td>
</tr>
<tr class="even">
<td>bbox_transform</td>
<td>the transform for the bbox. transAxes if None.</td>
</tr>
</tbody>
</table>
<p><strong>常用参数</strong>: - <code>loc</code> 设置图例位置</p>
<pre><code>`loc` 参数接收一个字符串或数字表示图例出现的位置。

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ax.legend(loc=<span class="string">&#x27;upper center&#x27;</span>)</span><br><span class="line"><span class="comment"># Equals to</span></span><br><span class="line">ax.legend(loc=<span class="number">9</span>)</span><br></pre></td></tr></table></figure>

&lt;center&gt; Table 3 Loc options &lt;/center&gt;

| Location String | Location Code |
| --------------- | ------------- |
| &#39;best&#39;          | 0             |
| &#39;upper right&#39;   | 1             |
| &#39;upper left&#39;    | 2             |
| &#39;lower left&#39;    | 3             |
| &#39;lower right&#39;   | 4             |
| &#39;right&#39;         | 5             |
| &#39;center left&#39;   | 6             |
| &#39;center right&#39;  | 7             |
| &#39;lower center&#39;  | 8             |
| &#39;upper center&#39;  | 9             |
| &#39;center&#39;        | 10            |

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig,axes = plt.subplots(<span class="number">1</span>,<span class="number">4</span>,figsize=(<span class="number">10</span>,<span class="number">4</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    axes[i].plot([<span class="number">0.5</span>],[<span class="number">0.5</span>])</span><br><span class="line">    axes[i].legend(labels=<span class="string">&#x27;a&#x27;</span>,loc=i)  <span class="comment"># 观察loc参数传入不同值时图例的位置</span></span><br><span class="line">fig.tight_layout()</span><br></pre></td></tr></table></figure>

Results:

&lt;img src=&#39;https://s4.ax1x.com/2022/01/14/715pXq.png&#39; style=&#39;zoom:80%&#39; /&gt;</code></pre>
<ul>
<li><p>设置图例边框及背景</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>,<span class="number">3</span>))</span><br><span class="line">axes = fig.subplots(<span class="number">1</span>,<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> i, ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axes):</span><br><span class="line">    ax.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],label=<span class="string">f&#x27;ax <span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line">axes[<span class="number">0</span>].legend(frameon=<span class="literal">False</span>) <span class="comment">#去掉图例边框</span></span><br><span class="line">axes[<span class="number">1</span>].legend(edgecolor=<span class="string">&#x27;blue&#x27;</span>) <span class="comment">#设置图例边框颜色</span></span><br><span class="line">axes[<span class="number">2</span>].legend(facecolor=<span class="string">&#x27;gray&#x27;</span>); <span class="comment">#设置图例背景颜色,若无边框,参数无效</span></span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/715Scn.png' style='zoom:80%' /></p></li>
<li><p>设置图例标题</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig,ax =plt.subplots()</span><br><span class="line">ax.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],label=<span class="string">&#x27;label&#x27;</span>)</span><br><span class="line">ax.legend(title=<span class="string">&#x27;legend title&#x27;</span>);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73Fib6.png' style='zoom:80%' /></p></li>
</ul>
<h2 id="thinking-3">5.4 Thinking</h2>
<p>请尝试使用两种方式模仿画出下面的图表(重点是柱状图上的标签)，本文学习的text方法和matplotlib自带的柱状图标签方法bar_label</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FPDx.png' style='zoom:80%' /></p>
<ul>
<li><p>常规的竖向图</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">names = [<span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;Dick&#x27;</span>, <span class="string">&#x27;Harry&#x27;</span>, <span class="string">&#x27;Slim&#x27;</span>, <span class="string">&#x27;Jim&#x27;</span>]</span><br><span class="line">idx = np.arange(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">values = <span class="number">8</span> + <span class="number">8</span>*np.random.rand(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">bias = np.random.rand(<span class="number">1</span>, <span class="number">5</span>).<span class="built_in">round</span>(<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">values = values.<span class="built_in">round</span>(<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line">plt.bar(names, values, orientation = <span class="string">&#x27;vertical&#x27;</span>, yerr = bias)</span><br><span class="line">ax.set_xticklabels(names, fontsize = <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">ax.xaxis.label.set_size(<span class="number">16</span>)</span><br><span class="line">ax.yaxis.label.set_size(<span class="number">16</span>) <span class="comment"># 设置坐标轴文字大小</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    ax.text(names[i], values[i] + bias[i] + <span class="number">0.2</span>, <span class="string">&#x27;±&#x27;</span> + <span class="built_in">str</span>(bias[i]), fontsize = <span class="number">13</span>, horizontalalignment = <span class="string">&#x27;center&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FCK1.png' style='zoom:80%' /></p></li>
<li><p>横向</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">names = [<span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;Dick&#x27;</span>, <span class="string">&#x27;Harry&#x27;</span>, <span class="string">&#x27;Slim&#x27;</span>, <span class="string">&#x27;Jim&#x27;</span>]</span><br><span class="line">idx = np.arange(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">values = <span class="number">8</span> + <span class="number">8</span>*np.random.rand(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">bias = np.random.rand(<span class="number">1</span>, <span class="number">5</span>).<span class="built_in">round</span>(<span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">values = values.<span class="built_in">round</span>(<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">16</span>, <span class="number">8</span>))</span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line">plt.barh(names, values, xerr = bias)</span><br><span class="line"></span><br><span class="line">ax.xaxis.label.set_size(<span class="number">16</span>)</span><br><span class="line">ax.yaxis.label.set_size(<span class="number">16</span>)</span><br><span class="line">ax.xaxis.set_ticks(np.arange(<span class="number">0</span>, <span class="number">20</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    ax.text(values[i] + bias[i] + <span class="number">1</span>, names[i], <span class="string">&#x27;±&#x27;</span> + <span class="built_in">str</span>(bias[i]), fontsize = <span class="number">13</span>, horizontalalignment = <span class="string">&#x27;center&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FS29.png' style='zoom:80%' /></p></li>
</ul>
<h1 id="样式色彩秀芳华">6. 样式色彩秀芳华</h1>
<p>本章详细介绍 <code>matplotlib</code> 种样式和颜色的使用，绘图样式和颜色是丰富可视化图表的重要手段，因此熟练掌握本章可以让可视化图表变得更美观，突出重点和凸显艺术性。</p>
<p>关于绘图样式，常见的有 <code>3</code> 种方法： - 修改预定义样式； - 自定义样式； - <code>rcParams</code>；</p>
<p>关于颜色使用，本章将介绍常见的5种表示单色颜色的基本方法，以及colormap多色显示的方法。</p>
<h2 id="matplotlib-的绘图样式style">6.1 <code>Matplotlib</code> 的绘图样式（<code>style</code>）</h2>
<p>在 <code>matplotlib</code> 中，要想设置绘制样式，最简单的方法是在绘制元素时单独设置样式。 但是有时候，当用户在做专题报告时，往往会希望保持整体风格的统一而不用对每张图一张张修改，因此 <code>matplotlib</code> 库还提供了四种批量修改全局样式的方式。</p>
<h3 id="matplotlib-预先定义样式">6.1.1 <code>matplotlib</code> 预先定义样式</h3>
<p><code>matplotlib</code> 贴心地提供了许多内置的样式供用户操作，使用方式很简单，只需在 <code>python</code> 脚本的最开始输入想使用 <code>style</code> 的名称即可调用，尝试调用不同内置样式，比较区别。</p>
<ul>
<li><p>Default</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib <span class="keyword">as</span> mpl</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;figure.figsize&#x27;</span>] = (<span class="number">12</span> ,<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">plt.style.use(<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73iI3j.png' style='zoom:80%' /></p></li>
<li><p>ggplot</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.style.use(<span class="string">&#x27;ggplot&#x27;</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73iTvn.png' style='zoom:80%' /></p></li>
</ul>
<p><code>matplotlib</code> 共内置了以下 <code>26</code> 种丰富的样式可供选择。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(plt.style.available)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&#39;Solarize_Light2&#39;, &#39;_classic_test_patch&#39;, &#39;bmh&#39;, &#39;classic&#39;, &#39;dark_background&#39;, </span><br><span class="line">&#39;fast&#39;, &#39;fivethirtyeight&#39;, &#39;ggplot&#39;, &#39;grayscale&#39;, &#39;seaborn&#39;, &#39;seaborn-bright&#39;, </span><br><span class="line">&#39;seaborn-colorblind&#39;, &#39;seaborn-dark&#39;, &#39;seaborn-dark-palette&#39;, &#39;seaborn-darkgrid&#39;, </span><br><span class="line">&#39;seaborn-deep&#39;, &#39;seaborn-muted&#39;, &#39;seaborn-notebook&#39;, &#39;seaborn-paper&#39;,</span><br><span class="line">&#39;seaborn-pastel&#39;, &#39;seaborn-poster&#39;, &#39;seaborn-talk&#39;, &#39;seaborn-ticks&#39;,</span><br><span class="line">&#39;seaborn-white&#39;, &#39;seaborn-whitegrid&#39;, &#39;tableau-colorblind10&#39;]</span><br></pre></td></tr></table></figure>
<h3 id="用户自定义-stylesheet">6.1.2 用户自定义 <code>stylesheet</code></h3>
<p>在任意路径下创建一个后缀名为 <code>mplstyle</code> 的样式清单，编辑文件添加以下样式内容：</p>
<blockquote>
<p>axes.titlesize : 24 axes.labelsize : 20 lines.linewidth : 3 lines.markersize : 10 xtick.labelsize : 16 ytick.labelsize : 16</p>
</blockquote>
<p>引用上述定义的 <code>stylesheet</code> 后观察图表变化：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.style.use(<span class="string">&#x27;./my.mplstyle&#x27;</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73ifUS.png' style='zoom:80%' /></p>
<ul>
<li><p>混合样式输入</p>
<p>值得特别注意的是，<code>matplotlib</code> 支持混合样式的引用，只需在引用时输入一个样式列表，若是几个样式中涉及到同一个参数，右边的样式表会覆盖左边的值。</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.style.use([<span class="string">&#x27;dark_background&#x27;</span>, <span class="string">&#x27;./my.mplstyle&#x27;</span>])</span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73ih4g.png' style='zoom:80%' /></p></li>
</ul>
<h3 id="设置-rcparams">6.1.3 设置 <code>rcparams</code></h3>
<p>我们还可以通过修改默认 <code>rc</code> 设置的方式改变样式，所有 <code>rc</code> 设置都保存在一个叫做 <code>matplotlib.rcParams</code> 的变量中。修改过后再绘图，可以看到绘图样式发生了变化。</p>
<ul>
<li><p>Default</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.style.use(<span class="string">&#x27;default&#x27;</span>) <span class="comment"># 恢复到默认样式</span></span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73iI3j.png' style='zoom:80%' /></p></li>
<li><p>虚线形式</p></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mpl.rcParams[<span class="string">&#x27;lines.linewidth&#x27;</span>] = <span class="number">2</span></span><br><span class="line">mpl.rcParams[<span class="string">&#x27;lines.linestyle&#x27;</span>] = <span class="string">&#x27;--&#x27;</span></span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73iogs.png' style='zoom:80%' /></p>
<ul>
<li>一次性修改多个样式</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mpl.rc(<span class="string">&#x27;lines&#x27;</span>, linewidth=<span class="number">4</span>, linestyle=<span class="string">&#x27;-.&#x27;</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73i5CQ.png' style='zoom:80%' /></p>
<h2 id="matplotlib-color-setting">6.2 <code>Matplotlib</code> color setting</h2>
<p>在可视化中，如何选择合适的颜色和搭配组合也是需要仔细考虑的，色彩选择要能够反映出可视化图像的主旨。从可视化编码的角度对颜色进行分析，可以将颜色分为 <strong>色相</strong>、<strong>亮度</strong> 和 <strong>饱和度</strong> 三个视觉通道。</p>
<ul>
<li>色相： 没有明显的顺序性、一般不用来表达数据量的高低，而是用来表达数据列的类别。</li>
<li>明度和饱和度： 在视觉上很容易区分出优先级的高低、被用作表达顺序或者表达数据量视觉通道。</li>
</ul>
<p>具体关于色彩理论部分的知识，可以参阅下列拓展材料进行学习。</p>
<ul>
<li><a href="https://vis.baidu.com/chartcolor/basis/">ECharts数据可视化实验室</a><br />
</li>
<li><a href="https://zhuanlan.zhihu.com/p/88892542">学会这6个可视化配色基本技巧，还原数据本身的意义</a></li>
</ul>
<p>在matplotlib中，设置颜色有以下几种方式：</p>
<ul>
<li><code>RGB</code> or <code>RGBA</code></li>
<li><code>HEX RGB</code> or <code>RGBA</code></li>
<li>灰度色阶</li>
<li>单字符基本颜色</li>
<li>颜色名称</li>
<li>使用 <code>colormap</code> 设置一组颜色</li>
</ul>
<h3 id="rgb-or-rgba">6.2.1 <code>RGB</code> or <code>RGBA</code></h3>
<p><code>RGBA</code> 颜色用 <code>[0,1]</code> 之间的浮点数表示，四个分量按顺序分别为 <code>(red, green, blue, alpha)</code>，其中 <code>alpha</code> 透明度可省略。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.style.use(<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],color=(<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.5</span>))</span><br><span class="line">plt.plot([<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],color=(<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FKKI.png' style='zoom:80%' /></p>
<h3 id="hex-rgb-or-rgba">6.2.2 <code>HEX RGB</code> or <code>RGBA</code></h3>
<p><code>HEX RGBA</code> 用十六进制颜色码表示，同样最后两位表示透明度，可省略。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],color=<span class="string">&#x27;#0f0f0f&#x27;</span>)</span><br><span class="line">plt.plot([<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],color=<span class="string">&#x27;#0f0f0f80&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FnxA.png' style='zoom:80%' /></p>
<h3 id="灰度色阶">6.2.3 灰度色阶</h3>
<p>当只有一个位于 <code>[0,1]</code> 的值时，表示灰度色阶。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],color=<span class="string">&#x27;0.5&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73Fm2d.png' style='zoom:80%' /></p>
<h3 id="单字符基本颜色">6.2.4 单字符基本颜色</h3>
<p><code>matplotlib</code> 有八个基本颜色，可以用单字符串来表示，分别是：</p>
<center>
Table color properties
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Character</th>
<th style="text-align: center;">Color</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>'b'</code></td>
<td style="text-align: center;">blue</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'g'</code></td>
<td style="text-align: center;">green</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'r'</code></td>
<td style="text-align: center;">red</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'c'</code></td>
<td style="text-align: center;">cyan（蓝绿色）</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'m'</code></td>
<td style="text-align: center;">magenta（品红）</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'y'</code></td>
<td style="text-align: center;">yellow</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'k'</code></td>
<td style="text-align: center;">black</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'w'</code></td>
<td style="text-align: center;">white</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.plot([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],color=<span class="string">&#x27;m&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73Fe8H.png' style='zoom:80%' /></p>
<h3 id="颜色名称">6.2.5 颜色名称</h3>
<p><code>matplotlib</code> 提供了颜色对照表，可供查询颜色对应的名称。</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FAUO.png' style='zoom:80%' /> <img src='https://s4.ax1x.com/2022/01/14/73FE5D.png' style='zoom:80%' /></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], color = <span class="string">&#x27;tan&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FZPe.png' style='zoom:80%' /></p>
<h3 id="使用-colormap-设置一组颜色">6.2.6 使用 <code>colormap</code> 设置一组颜色</h3>
<p>有些图表支持使用 <code>colormap</code> 的方式配置一组颜色，从而在可视化中通过色彩的变化表达更多信息。在 <code>matplotlib</code> 中，<code>colormap</code> 共有五种类型:</p>
<ul>
<li>顺序（<code>Sequential</code>）。通常使用单一色调，逐渐改变亮度和颜色渐渐增加，用于表示有顺序的信息</li>
<li>发散（<code>Diverging</code>）。改变两种不同颜色的亮度和饱和度，这些颜色在中间以不饱和的颜色相遇；当绘制的信息具有关键中间值（例如地形）或数据偏离零时，应使用此值。</li>
<li>循环（<code>Cyclic</code>）。改变两种不同颜色的亮度，在中间和开始/结束时以不饱和的颜色相遇。用于在端点处环绕的值，例如相角，风向或一天中的时间。</li>
<li>定性（<code>Qualitative</code>）。常是杂色，用来表示没有排序或关系的信息。</li>
<li>杂色（<code>Miscellaneous</code>）。一些在特定场景使用的杂色组合，如彩虹，海洋，地形等。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = np.random.randn(<span class="number">50</span>)</span><br><span class="line">y = np.random.randn(<span class="number">50</span>)</span><br><span class="line">plt.scatter(x,y,c=x,cmap=<span class="string">&#x27;RdPu&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<p><img src='https://s4.ax1x.com/2022/01/14/73FkVK.png' style='zoom:80%' /></p>
<p>在以下官网页面可以查询上述五种colormap的字符串表示和颜色图的对应关系，<a href="https://matplotlib.org/stable/tutorials/colors/colormaps.html">Here</a></p>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Matplotlib</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Data analysis</tag>
        <tag>Matplotlib</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux notes</title>
    <url>/2020/11/23/Linux/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<p><code>Linux</code>，全称为 <code>GNU/Linux</code>，是一种免费使用和自由传播的类 <code>UNIX</code> 操作系统。我们常说的 <code>Linux</code> ，指的是 <code>Linux</code> 内核，一个基于 <code>POSIX</code> 的多用户、多任务、支持多线程和多 <code>CPU</code> 的操作系统。</p>
<a id="more"></a>
<p><code>Linux</code> 现在已经是现代互联网体系中不可或缺的一部分了，可能你看不见它，但是它一直在你身边，各种嵌入式设备，如手表，机器人。还有广为人之的安卓。地球上大多数的服务器都是 <code>Linux</code> 操作系统。从航天到军事、从科研到金融、从手机到电脑，无处不在。</p>
<p>因其开源的特点，<code>Linux</code> 的发展速度以指数规模增长，无数开发者加入到 <code>Linux</code> 开发的行列中来。本篇博客主要简单概括一下 <code>Linux</code> 的特点以及常用的语法及包。</p>
<h2 id="why-linux">1.1 Why Linux</h2>
<p><code>Linux</code> 有以下众多特点：</p>
<ul>
<li><p><strong>开源免费</strong></p>
<p><code>Linux</code> 是完全免费的操作系统，并且开放源代码，任何人都可以随意修改其源代码。</p></li>
<li><p><strong>多用户、多任务</strong></p>
<p><code>Linux</code> 支持多用户，各个用户对于自己的文件设备有自己特殊的权利，保证了各用户之间互不影响。多任务则是现代电脑最主要的一个特点，<code>Linux</code> 可以使多个程序同时并独立地运行。</p></li>
<li><p><strong>安全可靠</strong></p>
<p><code>Linux</code> 的代码是开源的，所以每个人都可以参与进入修补漏洞。此外，<code>Linux</code> 的用户权限管理也使得安全风险降低</p></li>
<li><p><strong>稳定</strong></p>
<p><code>Linux</code> 服务器一直以稳定性闻名，可以持续运行很久都不易崩溃。</p></li>
<li><p><strong>多平台</strong></p>
<p><code>Linux</code> 可以运行在多种硬件平台上，<code>x86</code>，<code>arm</code> 及其他各种嵌入式设备。</p></li>
</ul>
<h2 id="linux-in-a-nutshell">1.2 Linux in a nutshell</h2>
<h3 id="常用发行版">1.2.1 常用发行版</h3>
<ol type="1">
<li><p><strong>Debian</strong></p>
<p>老牌发行版，非常稳定，适合用于服务器。</p></li>
<li><p><strong>Ubuntu</strong></p>
<p><code>Ubuntu</code> 是 <code>Debian</code> 的一款衍生版，侧重于它在这个市场的应用，在服务器、云计算、甚至一些运行 <code>Ubuntu Linux</code> 的移动设备上很常见。于 2004 年 9 月首次公布的。属于热门发行版之一，因其图形界面开发较完善以及良好的社区支持，很受初接触 <code>Linux</code> 的人群青睐。</p></li>
<li><p><strong>CentOS</strong></p>
<p><code>CentOS</code> 是一种对 RHEL（Red Hat Enterprise Linux）源代码再编译的产物，由于 <code>Linux</code> 是开发源代码的操作系统，并不排斥样基于源代码的再分发，<code>CentOS</code> 就是将商业的 <code>Linux</code> 操作系统 <code>RHEL</code> 进行源代码再编译后分发，并在 <code>RHEL</code> 的基础上修正了不少已知的漏洞。</p></li>
<li><p><strong>Fedora</strong></p></li>
</ol>
<p><code>Fedora Linux</code>（第七版以前为Fedora Core）是由 <code>Fedora</code> 项目社区开发、红帽公司赞助，目标是创建一套新颖、多功能并且自由（开放源代码）的操作系统。<code>Fedora</code> 是商业化的Red Hat Enterprise Linux发行版的上游源码。</p>
<ol start="5" type="1">
<li><p><strong>Kali</strong></p>
<p><code>Kali Linux</code> 是 <code>Debian</code> 的一款衍生版。旨在渗透测试和数字取证。它预先构建了用于渗透测试的多种工具。</p></li>
<li><p><strong>Arch</strong></p>
<p><code>Arch</code> 是一款采用滚动发行方式的操作系统，只要安装一次就够了，每当发行了某个新版本，就可以升级发行版，无需重新安装。<code>Pacman</code> 是 <code>Arch Linux</code>的软件包管理器。<code>Arch</code> 既支持 <code>X86</code> 处理器架构，又支持 <code>X86_64</code> 架构，安装程序可以从光盘或U盘来运行。</p></li>
</ol>
<h3 id="推荐阅读">1.2.2 推荐阅读</h3>
<p>有兴趣深入了解 <code>Linux</code> 以及自由软件，开源历史的，推荐阅读如下数据：</p>
<ul>
<li>《只是为了好玩》</li>
<li>《大教堂与集市》</li>
<li>《自由软件，自由社会》</li>
<li>《黑客与画家》</li>
</ul>
<h2 id="module-installation">1.3 Module installation</h2>
<h3 id="编译源码安装">1.3.1 编译源码安装</h3>
<p>使用源代码安装软件的优点：</p>
<ul>
<li>可以获得最新的软件，及时修复bug；</li>
<li>根据用户的需求，灵活定制软件功能</li>
</ul>
<p>步骤： 1. 解压</p>
<pre><code><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0. tar -xzvf soft.tar.gz  <span class="comment"># 解压一般会生成一个soft目录</span></span><br></pre></td></tr></table></figure></code></pre>
<ol start="2" type="1">
<li><p>检查环境变量及配置编译选项</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./configure <span class="comment"># 检查环境变量及配置编译选项</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>编译源代码</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make  <span class="comment"># 源代码编译成二进制文件</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>安装</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make install <span class="comment"># 将make编译出来的文件安装到指定位置(或默认位置)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定安装目录</span></span><br><span class="line">make install ./configure --prefix=目录名</span><br></pre></td></tr></table></figure></p></li>
<li><p>卸载</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make uninstall <span class="comment"># 或手动删除</span></span><br></pre></td></tr></table></figure></p>
<p>由于软件可能将文件分散地安装在系统的多个目录中，往往很难把它删除干净， 最好在编译前进行配置，指定软件将要安装到目标路径：</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make install ./configure --prefix=PATHNAME</span><br></pre></td></tr></table></figure></p>
<p>这样可以使用 <code>rm -rf PATHNAME</code> 命令来进行干净彻底的卸载。</p></li>
</ol>
<h3 id="在线安装">1.3.2 在线安装</h3>
<ol type="1">
<li><p><code>apt</code> 包管理</p>
<p>由于操作系统中软件包存在复杂的依赖关系，为了解决软件包的依赖性问题和获取问题，<code>APT</code> 顺势出现了。<code>APT</code> 是 <code>Ubuntu</code> 中的命令行软件包管理工具，用于获取、安装、编译、卸载和查询 <code>Deb</code> 软件包，以及检查软件包的依赖关系。</p>
<p><strong>常用命令</strong>：</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get update                       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新本地索引，即更新/var/lib/apt/lists 里边的内容</span></span><br><span class="line">sudo apt-get upgrade                      </span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新所有软件包</span></span><br><span class="line">sudo apt-get install xx                 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装软件</span></span><br><span class="line">sudo apt-get remove xx</span><br><span class="line"><span class="meta">#</span><span class="bash"> 卸载包</span></span><br><span class="line">sudo apt-get remove --purge name          </span><br><span class="line"><span class="meta">#</span><span class="bash"> 卸载并彻底清除</span></span><br><span class="line">sudo apt-get clean                        </span><br><span class="line"><span class="meta">#</span><span class="bash"> 清理下载文件的存档</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>换源</p>
<p>在线安装，如 <code>apt</code> 包管理的软件仓库地址可能在国外，国内连接速度较慢。所以可以将软件仓库地址改为国内源码库。</p>
<p><code>Ubuntu</code> 的软件源配置文件是 <code>/etc/apt/sources.list</code>。将系统自带的该文件做个备份，将该文件替换为下面内容，即可使用 <code>TUNA</code> 的软件源镜像。</p>
<p>用 <code>vim</code> 命令打开 <code>sources.list</code> 文件：</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure></p>
<p>将内容改为如下：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 预发布软件源，不建议启用</span></span><br><span class="line"><span class="comment"># deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse</span></span><br></pre></td></tr></table></figure></p>
<p>以上为 <code>ubuntu 20.04</code> 更换清华源码的一个例子。此外还有许多其他的优秀软件仓库，可以自行尝试：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 清华：</span></span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/<span class="built_in">help</span>/ubuntu/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 中科大</span></span><br><span class="line">https://mirrors.ustc.edu.cn/<span class="built_in">help</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 阿里</span></span><br><span class="line">http://mirrors.cloud.aliyuncs.com/ubuntu</span><br></pre></td></tr></table></figure></p>
<p><strong>Note:</strong> 查看 <code>Ubuntu</code> 的版本信息：</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LSB Version:    core-11.1.0ubuntu2-noarch:security-11.1.0ubuntu2-noarch</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04.3 LTS</span><br><span class="line">Release:        20.04</span><br><span class="line">Codename:       focal</span><br><span class="line"></span><br></pre></td></tr></table></figure></p></li>
</ol>
<h2 id="开发工具">1.4 开发工具</h2>
<h3 id="git">1.4.1 Git</h3>
<p><code>Git</code> 是一个开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目。</p>
<p>命令行安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure>
<h3 id="vim">1.4.2 <code>Vim</code></h3>
<p><code>Vim</code> 是从 <code>vi</code> 发展出来的一个文本编辑器。代码补完、编译及错误跳转等方便编程的功能特别丰富，在程序员中被广泛使用。和 <code>Emacs</code> 并列成为类 <code>Unix</code> 系统用户最喜欢的编辑器。 安装步骤：</p>
<ol type="1">
<li><p><strong>首先将vim的源码克隆下来，这里因为github可能很慢，使用码云的镜像</strong></p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://gitee.com/mirrors/vim.git</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>安装gcc（有则不必安装）和各依赖库</strong></p>
<p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">sudo apt<span class="literal">-get</span> install gcc</span><br><span class="line"></span><br><span class="line">sudo apt<span class="literal">-get</span> install libncurses5<span class="literal">-dev</span> python<span class="literal">-dev</span> python3<span class="literal">-dev</span> libatk1.<span class="number">0</span><span class="literal">-dev</span> libcairo2<span class="literal">-dev</span> libx11<span class="literal">-dev</span> libxpm<span class="literal">-dev</span> libxt<span class="literal">-dev</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>配置与安装</strong>（<code>vim</code> 目录）</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo ./configure --with-features=huge --enable-multibyte</span><br><span class="line">      --enable-rubyinterp --enable-pythoninterp --enable-python3interp</span><br><span class="line">      --enable-luainterp --enable-cscope --enable-gui=gtk3 --enable-perlinterp</span><br><span class="line">      --with-python-config-dir=/usr/lib/python2.7/config-x86_64-linux-gnu/</span><br><span class="line">      --with-python3-config-dir=/usr/lib/python3.6/config-3.6m-x86_64-linux-gnu/</span><br><span class="line">      --prefix=/usr/local/vim8</span><br></pre></td></tr></table></figure></p>
<p>参数说明：</p>
<ul>
<li>with-features=huge：支持最大特性</li>
<li>enable-rubyinterp：打开对 ruby 编写的插件的支持</li>
<li>enable-pythoninterp：打开对 python 编写的插件的支持</li>
<li>enable-python3interp：打开对 python3 编写的插件的支持</li>
<li>enable-luainterp：打开对 lua 编写的插件的支持</li>
<li>enable-perlinterp：打开对 perl 编写的插件的支持</li>
<li>enable-multibyte：打开多字节支持，可以在 Vim 中输入中文</li>
<li>enable-cscope：打开对cscope的支持</li>
<li>enable-gui=gtk3 表示生成采用 GNOME3 风格的 gvim</li>
<li>with-python-config-dir=/usr/lib/python2.7/config-x86_64-linux-gnu/ 指定 python 路径</li>
<li>with-python3-config-dir=/usr/lib/python3.6/config-3.6m-x86_64-linux-gnu/ 指定 python3路径(这里可以根据自己的版本做更改)</li>
<li>prefix=/usr/local/vim8：指定将要安装到的路径</li>
</ul>
<p><strong>Note:</strong> 更多有关 <code>Linux</code> 和 <code>Vim</code> 的相关操作，请查看本文博文 <a href="https://www.yangsuoly.com/2020/11/23/Linux/">Linux notes</a>，此处不再进行赘述。</p></li>
</ol>
<h1 id="shortcuts">1.5 Shortcuts</h1>
<h1 id="六常用终端快捷键">六、常用终端快捷键</h1>
<p>以下命令仅在 <code>ubuntu</code> 系统测试，其他发行版 <code>Linux</code> 未测试。</p>
<table>
<thead>
<tr class="header">
<th>快捷键</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Ctrl+a</td>
<td>光标移动到开始位置</td>
</tr>
<tr class="even">
<td>Ctrl+e</td>
<td>光标移动到最末尾</td>
</tr>
<tr class="odd">
<td>Ctrl+k</td>
<td>删除此处至末尾的所有内容</td>
</tr>
<tr class="even">
<td>Ctrl+u</td>
<td>删除此处至开始的所有内容</td>
</tr>
<tr class="odd">
<td>Ctrl+d</td>
<td>删除当前字符</td>
</tr>
<tr class="even">
<td>Ctrl+h</td>
<td>删除当前字符前一个字符</td>
</tr>
<tr class="odd">
<td>Ctrl+w</td>
<td>删除此处到左边的单词</td>
</tr>
<tr class="even">
<td>Ctrl+y</td>
<td>粘贴由Ctrl+u， Ctrl+d， Ctrl+w删除的单词</td>
</tr>
<tr class="odd">
<td>Ctrl+l</td>
<td>相当于clear，即清屏</td>
</tr>
<tr class="even">
<td>Ctrl+r</td>
<td>查找历史命令</td>
</tr>
<tr class="odd">
<td>Ctrl+b</td>
<td>向回移动光标</td>
</tr>
<tr class="even">
<td>Ctrl+f</td>
<td>向前移动光标</td>
</tr>
<tr class="odd">
<td>Ctrl+Left-Arrow</td>
<td>光标移动到上一个单词的词首</td>
</tr>
<tr class="even">
<td>Ctrl+Right-Arrow</td>
<td>光标移动到下一个单词的词尾</td>
</tr>
<tr class="odd">
<td>Ctrl+d</td>
<td>退出终端</td>
</tr>
<tr class="even">
<td>Ctrl+Alt+T</td>
<td>打开终端</td>
</tr>
</tbody>
</table>
<h1 id="command">2. Command</h1>
<p>This chapter introduce some commonly used <code>Linux</code> command, including <code>cd</code>, <code>pwd</code>, <code>ls</code>, <code>mkdir</code>, <code>rmdir</code>, <code>cp</code>, <code>rm</code>, <code>mv</code>, <code>tar</code>, <code>zip</code>, <code>unzip</code>.</p>
<h2 id="derectory-management">2.1 Derectory management</h2>
<ol type="1">
<li><p><code>cd</code></p>
<p>即 current directory，切换目录</p></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cd /home/YangSu/Desktop <span class="comment">#按TAB键可以自动补全</span></span><br><span class="line">cd ~/Desktop <span class="comment">#其中~特指用户的主目录</span></span><br><span class="line">cd.. <span class="comment"># 回到上一个目录</span></span><br><span class="line">cd <span class="comment">#回到用户目录位置</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>绝对路径</p>
<p>/home/YangSu/Desktop</p></li>
<li><p>相对路径</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">. 当前目录</span><br><span class="line">.. 上级目录</span><br><span class="line">../Videos 上级目录下的Videos子目录</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="pwd">1.1.2 <code>pwd</code></h3>
<p>即 print working directory 显示当前工作目录</p>
<h3 id="ls">1.1.3 ls</h3>
<p>即 list，列出文件和目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ls</span><br><span class="line">ls ~/Desktop</span><br><span class="line">ls -l ~/Desktop <span class="comment">#其中，-l参数表示详细模式</span></span><br></pre></td></tr></table></figure>
<h2 id="mkdir">1.4 mkdir</h2>
<p>即 make directory，创建目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mkdir abc</span><br><span class="line">mkdir -p abc/<span class="number">123</span>/test</span><br><span class="line"><span class="comment">#使用-p参数，可以将路径的层次目录全部创建</span></span><br></pre></td></tr></table></figure>
<h2 id="touch">1.5 touch</h2>
<p>新建一个文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">touch index.js</span><br><span class="line"><span class="comment"># 在当前目录下新建一个 index.js 文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># windows terminal中</span></span><br><span class="line">new-item index.js</span><br></pre></td></tr></table></figure>
<h2 id="rm">1.6 rm</h2>
<h3 id="rm-1">rm</h3>
<p>即 remove 删除文件或目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rm -rf abc <span class="comment">#删除abc目录，和子项一并删除</span></span><br><span class="line"><span class="comment">#其中，r:recursive, f:force</span></span><br></pre></td></tr></table></figure>
<h3 id="rmdir">rmdir</h3>
<p>即 remove directory，删除空目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rmdir abc <span class="comment">#删除空目录，如果目录非空，则会删除失败</span></span><br></pre></td></tr></table></figure>
<h2 id="cp">1.7 cp</h2>
<p>即 copy，复制文件或者目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cp -rf Test Test1</span><br></pre></td></tr></table></figure>
<h2 id="mv">1.8 mv</h2>
<p>即 move，移动文件或目录（重命名）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mv Test1 HelloWorld</span><br></pre></td></tr></table></figure>
<h2 id="tar">1.9 tar</h2>
<p>即 tape archive档案打包</p>
<h3 id="创建档案包">创建档案包</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tar -cvf example.tar example</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">c: create</span></span><br><span class="line"><span class="string">v: verbose，显示详情</span></span><br><span class="line"><span class="string">f: file</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 也可以多个目录打包</span></span><br><span class="line">tar -cvd xxx.tar file1 file2 file3</span><br></pre></td></tr></table></figure>
<h4 id="还原档案包">还原档案包</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tar -xvf example.tar</span><br><span class="line">tar -xvf example.tar -C outdir</span><br></pre></td></tr></table></figure>
<h4 id="归档并压缩">归档并压缩</h4>
<p>上述的tar格式并没有对文件进行压缩，体积较大</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 并档并压缩</span></span><br><span class="line">tar -czvf example.tar.gz example</span><br><span class="line"><span class="comment"># 解压缩</span></span><br><span class="line">tar -xzvf example.tar.gz -C outdir</span><br></pre></td></tr></table></figure>
<h2 id="man">1.10 man</h2>
<p>即 manual，手册</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">man tar</span><br></pre></td></tr></table></figure>
<h2 id="ln">1.11 ln</h2>
<p>软链接，即Windows中的 “ 快捷方式 ”</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ln -s source link</span><br><span class="line"><span class="comment"># s: soft</span></span><br><span class="line">ls -l <span class="comment"># 查看软链接，显示为：test -&gt; Test/</span></span><br><span class="line">ls -l / <span class="comment">#详细列出根目录</span></span><br></pre></td></tr></table></figure>
<h2 id="other">1.12 other</h2>
<ul>
<li>reset：重新初始化终端，即清屏</li>
<li>clear：清屏</li>
<li>history：查看命令历史</li>
<li>help：帮助</li>
<li>exit：推出</li>
<li>#：表示注释</li>
</ul>
<h1 id="management">2 Management</h1>
<h2 id="switch-user">2.1 Switch user</h2>
<ul>
<li>su</li>
</ul>
<p>即 switch user，切换用户。用户管理需要以管理员身份执行，所以，要先切换账户到 <strong>root</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">su root</span><br><span class="line">su <span class="comment"># 默认为 root</span></span><br></pre></td></tr></table></figure>
<h2 id="user-operation">2.2 User operation</h2>
<ul>
<li>useradd</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">useradd username</span><br></pre></td></tr></table></figure>
<ul>
<li>passwd</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">passwd username</span><br></pre></td></tr></table></figure>
<ul>
<li>userdel</li>
</ul>
<p>即 user delete</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">userdel username</span><br></pre></td></tr></table></figure>
<h2 id="group-operation">2.3 Group operation</h2>
<ul>
<li>groupadd</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">groupadd boys <span class="comment"># 创建用户组</span></span><br></pre></td></tr></table></figure>
<ul>
<li>groupdel</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">groupdel boys <span class="comment"># 删除用户组</span></span><br></pre></td></tr></table></figure>
<ul>
<li>useradd</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">useradd -g boys ming <span class="comment"># -g表示添加用户，同时添加到boys中</span></span><br></pre></td></tr></table></figure>
<ul>
<li>usermod</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">usermod -g boys YangSu <span class="comment"># 修改用户信息</span></span><br></pre></td></tr></table></figure>
<ul>
<li>cat</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cat /etc/group <span class="comment"># 查看用户组，每一行表示一个group的信息</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">输出为：名称 + ID</span></span><br><span class="line"><span class="string">YangSu:x:1000:</span></span><br><span class="line"><span class="string">boys:x:1001:</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">cat /etc/passwd <span class="comment"># 查看用户列表，每一行表示一个user信息</span></span><br></pre></td></tr></table></figure>
<h2 id="file-permission">2.4 File permission</h2>
<ul>
<li>View Permission</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ls -l test.txt</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">-rw-------</span></span><br><span class="line"><span class="string">第一个字母，如果是文件夹，则为d，文件则为-</span></span><br><span class="line"><span class="string">后面九个字符分为三部分：自己 | 同组 | 别人</span></span><br><span class="line"><span class="string">rwx------ # 自己可读可写可执行</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>chmod</li>
</ul>
<p>即 Change file mode，修改文件的访问权限</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">chmod o+w test.txt</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">o: other</span></span><br><span class="line"><span class="string">a: all</span></span><br><span class="line"><span class="string">u: user # 省略怎默认修改自己和本组的权限</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">+w: add write permission</span></span><br><span class="line"><span class="string">-w: delete write permission</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>chown</li>
</ul>
<p>即 Change owner，修改文件的属主，一般每个用户只操作自己用户目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">su</span><br><span class="line">mkdir /opt/source <span class="comment"># 在/opt目录下创建一个文件夹source</span></span><br><span class="line">chown -R YangSu /opt/source <span class="comment"># 将source目录分配给YangSu</span></span><br><span class="line">ls -ld /opt/source</span><br></pre></td></tr></table></figure>
<h2 id="script">2.5 Script</h2>
<ul>
<li>Shell 脚本： *.sh</li>
<li>Perl 脚本： *.pl</li>
<li>Python 脚本：*.py</li>
</ul>
<p>脚本程序本质上是一个文本文件，具有可执行权限</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Shell 脚本解释器：/<span class="built_in">bin</span>/sh</span><br><span class="line">Perl 脚本解释器：/<span class="built_in">bin</span>/perl</span><br><span class="line">Python 脚本解释器：/usr/<span class="built_in">bin</span>/python3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行一个脚本时，以下两种方式等效</span></span><br><span class="line">./hello.py</span><br><span class="line">/usr/<span class="built_in">bin</span>/python3 hello.py</span><br></pre></td></tr></table></figure>
<ul>
<li>Shell 脚本</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编辑一个文本文件</span></span><br><span class="line"><span class="comment">#!/bin/sh # 申明解释器</span></span><br><span class="line">echo <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存为Hello.sh</span></span><br><span class="line"><span class="comment"># 添加可执行权限，必须要有x权限，才能够执行</span></span><br><span class="line">chmod +x Hello.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行程序</span></span><br><span class="line">./Hello.sh <span class="comment"># 执行程序时，必须加上路径</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">./表示当前路径</span></span><br><span class="line"><span class="string">/home/YangSu/Test/Hello.sh</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Perl 脚本</li>
<li>Py 脚本</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br></pre></td></tr></table></figure>
<h2 id="shell">2.6 Shell</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 定义变量，NAME=value</span></span><br><span class="line">JAVA_HOME=/opt/java #中间不能有空格</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 调用命令</span></span><br><span class="line">echo $&#123;JAVA_HOME&#125;/bin</span><br><span class="line">ls $&#123;JAVA_HOME&#125; #使用变量</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 逻辑控制</span></span><br><span class="line">if ... while ...</span><br></pre></td></tr></table></figure>
<h1 id="enviroment">3 Enviroment</h1>
<h2 id="enviromental-viriables">3.1 Enviromental Viriables</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=/opt/jdk1.8 # 定义临时的环境变量</span><br><span class="line">echo $JAVA_HOME # 显示环境变量</span><br><span class="line">printenv #查看所有环境变量</span><br></pre></td></tr></table></figure>
<p>使用环境变量：</p>
<ul>
<li>在当前命令行中使用</li>
<li>在 Shell 脚本中使用</li>
</ul>
<h2 id="user-viriables">3.2 User Viriables</h2>
<p>用户环境变量定义在：~/.bash_profile 中（注：在 Linux 下，以 . 开头的文件为 <strong>隐藏文件</strong> ）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ls -la # a 表示 all，显示所有文件</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 用户环境变量，g 表示 GNU</span></span><br><span class="line">gedit ~/.bash_profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加</span></span><br><span class="line">export JAVA_HOME=/opt/jdk1.8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注销当前用户，再次登陆时生效</span></span><br><span class="line">echo $&#123;JAVA_HOME&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Delete this variables</span></span><br><span class="line">unset JAVA_HOME</span><br></pre></td></tr></table></figure>
<h2 id="system-variables">3.3 System Variables</h2>
<p>系统环境变量定义在：/etc/profile 中，其中的环境变量对 <strong>所有用户</strong> 有效</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 以 root 登录或执行</span></span><br><span class="line">gedit /etc/profile</span><br><span class="line"></span><br><span class="line">:&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">在 CentOS 中，一般不可以直接修改 /etc/profile，而是在 /etc/profile.d 创建一个自定义的脚本</span></span><br><span class="line">&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 用 gedit 创建一个脚本</span></span><br><span class="line">gedit /etc/profile.d/myprofile.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定义环境变量</span></span><br><span class="line">export TOMCAT=/opt/tomcat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 注销并重新登录</span></span><br></pre></td></tr></table></figure>
<h2 id="path-variables">3.4 PATH Variables</h2>
<p>PATH，最常见的环境变量，用来描述可执行程序的搜索路径</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo $PATH</span><br><span class="line"><span class="meta">#</span><span class="bash"> OUTPUT:/home/YangSu/.<span class="built_in">local</span>/bin:/home/YangSu/bin:/home/YangSu/.<span class="built_in">local</span>/bin:/home/YangSu/bin:/home/YangSu/.<span class="built_in">local</span>/bin:/home/YangSu/bin:/usr/<span class="built_in">local</span>/bin:/usr/<span class="built_in">local</span>/sbin:/usr/bin:/usr/sbin</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 多个路径之间用冒号分隔</span></span><br></pre></td></tr></table></figure>
<h2 id="network">3.5 Network</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ifconfig <span class="comment"># 检查IP地址，Windows 为ipconfig</span></span><br><span class="line">ping www.baidu.com <span class="comment"># 测试外网</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">虚拟机和宿主机时互相连通的</span></span><br><span class="line"><span class="string">虚拟机：192.168.11.128</span></span><br><span class="line"><span class="string">宿主机：192.168.11.1</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h1 id="centos8-图形界面和命令行切换">4 CentOS8 图形界面和命令行切换</h1>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看目前默认的启动默认</span></span><br><span class="line">systemctl get-default</span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令行模式:multi-user.target</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 图形界面模式:graphical.target</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置为图形界面模式</span></span><br><span class="line">systemctl set-default graphical.target</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置为命令行模式</span></span><br><span class="line">systemctl set-default multi-user.target</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Notes</category>
        <category>OS</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Influence</title>
    <url>/2021/01/18/Influence-1/</url>
    <content><![CDATA[<h1 id="引言">1. 引言</h1>
<p>影响力，一般认为指的是用一种为别人所乐于接受的方式，改变他人所乐于接受的方式，改变他人的思想和行动的能力。该书由著名社会心理学家 Robert B. Cialdini 所著， Cialdini 倾其职业生涯来研究影响力，在说服、顺从和谈判领域享有广泛的国际声誉。因其在商业道德和政策运用方面所作的前沿研究，常被称为“影响力教父”。</p>
<a id="more"></a>
<p>本书主要谈论了一些社会生活中常见，但我们通常容易忽视的小套路，从互惠、承诺和一致、社会认同、喜好、权威以及稀缺六个方面对这些套路进行归类，通过一番抽丝剥茧式的分析，来阐述人们面对这些套路时会陷入的思维定势以及应对措施。</p>
<p>在日常生活中，各种销售广告、推销手段层出不穷，一些经不起推敲的广告却有时能够取得奇效，一些看似损害商家自身利益的小套路却能够给商家带来更多利益……这些都是通过影响力这一手段来影响我们的决策。作者通过对影响力的作用方式进行剖析，解释了影响力的厉害关系。因为它，我们可能被无良商家诓骗而蒙受损失，甚至映射到社交生活中，前些年饱受诟病的“PUA”中也能看到影响力这一武器被滥用的影子。</p>
<p>作者的很多论述朴实无华，但却能在平凡的语言中让我有种感同身受的真实感。比如以承诺与一致为例，前段时间，偶然间翻看了两年前在简书上写的一篇文章《那些愿意永远坚守的执念》。我以前总是以信念、信仰之类的规诫自己，所以当时兴致偶发，记录了一些优秀的品质借以自勉。殊不知时过境迁，再次重温之时，竟发现这些执念已经在不知不觉之中已经深入记忆，成为了个人为人处世的一部分了。不免有些喟叹，如果当初没有记录的冲动，也许这些执念只会在人情世故中泯然消逝罢了。此外，还有其他许多因素，都能带给我发自内心的共鸣感，通过了解它们，可以帮助我更好地剖析遇到的问题，理解社会现象，避开一些本该能够避免的社会损失。</p>
<h2 id="按一下就播放">1.1 按一下就播放</h2>
<p>影响力对我们起作用的方式是作者称为“按一下就播放”的一种固定行为模式。这种模式最初是研究动物行为时所提，其基本特点是：构成模式的行为每次都是按照几乎无异的方式或相同的顺序发生，就好像这些方式是记录动物身体里内置的磁带上，只要到了特定环境，相应的行为就得到激活，进而按照标准的顺序展开一整套行为，就如同按下了播放键一样。最有意思的一点在于这个磁带的激活方式，促发者也许并不是对手这个整体，而是对手具备的一些特征。</p>
<p>而在人类社会中，同样存在按一下就播放的范式，比如别人在请求我们帮忙的时候，要是能给一个理由，我们通常会乐意提供帮助。“因为”这个词可以触发我我们的自动顺从反应，哪怕请求者并没有给出一个说得通的理由，但我们潜意识里会说服自己去帮助对方，就像是“因为”这个词语按下了我们顺从反应的按钮一般。</p>
<p>事实上，这种模式化的自动行为在人类活动中是相当普遍的。因为很多时候，它是最有效的行为方式。英国著名哲学家怀特海（Alfred North Whitehead） 曾断言：文明的进步，就是人们在不假思索中可以做的事情越来越多。我们都生活在一个极其复杂的环境中，为了应对社会生活的日新月异，我们需要捷径，因为我们没有足够的时间、精力和能力来对每一件事采取“谋定而后动”的策略。所以，我们需要频繁地根据少数关键特征把事情进行分类，以便下次碰到同样的触发特征，就可以不假思索地做出最为有利的反应。</p>
<h1 id="互惠">2 互惠</h1>
<h2 id="滴水之恩涌泉相报">2.1 滴水之恩，涌泉相报</h2>
<p>互惠原理指，当别人帮了我们的忙，给了我们好处，我们应当回报他，也即我们平时所说，滴水之恩，定当以涌泉相报。著名考古学家理查德·利基（Richard Leakey）认为：正是因为有了互惠体系，人类才成为人类。确实，倘若我们没有学会“有债必还”的道理，人类又如何会走上劳动分工的道路呢？更遑论让个体相互依赖，凝结成高效率的单位了。</p>
<p>该原理告诉我们，超市在希望消费者购买产品时，通常会先向向消费者施加小小的恩惠，如赠送样品，通过这种小技巧，就可以极大地提高消费者依其言行其事的概率。当然，在消费者不断被资本家割韭菜的今日，个人感觉这种小伎俩早已不足以打动消费者了。</p>
<p>此外，在无关金钱和商业交易的人际关系中，同样也受互惠原理的影响，他人通过硬塞给我们一些好处，就能触发我们的亏欠感。这份亏欠感会驱使我们对别人的付出进行弥补和偿还，而正是这份偿还义务构成了互惠原理的实质。古人云：滴水之恩，当涌泉相报。最初的小小善意会刺激人们报以大得多的恩惠，因为亏欠感会让我们心生内疚。</p>
<p>这一点让我倍感亲切，我妈从小教育我，不要贪图别人的小便宜，不要亏欠别人。我也一直践行着这一准则，总觉得自己不够强大，总觉得自己无以回报，哪怕自己真的需要，也会尽量避免找人帮忙，即便找人帮忙或者受人人情，最终也一定会以回报大于得到而终。因为我始终以高规格的精神标准要求自己，当心理亏欠的负担落在肩头，有时是比物质损失更难以忍受的折磨。</p>
<h2 id="互惠式让步">2.2 互惠式让步</h2>
<p>除了上述滴水之恩，涌泉相报的常规互惠范式之外，还有一种常见的套路“互惠式让步”。它的实现途径也比较简单，首先，它迫使接受了对方让步的人以同样的方式回应；其次，由于接受了让步的人有回报的义务，人们就乐意率先让步，从而启动有益的交换过程。</p>
<p>简单来说就是，假设你想让我答应你的某个请求，为了增加获胜的概率，你可以先向我提出一个大些的要求，等我拒绝之后，再提出一个稍小的要求，而这个要求才是你真正的目标。倘若你的要求设置巧妙，我会把你的第二个要求看成对我的让步，并有可能感到自己这边也应该让步，于是顺从了你的第二个要求。</p>
<p>这种手段也叫做“拒绝——后撤术”，常见于谈判和推销过程中，一些经验老道的销售员能够非常娴熟地使用这种手段，诱使消费者进入预先编织好的“陷阱”中，不但赢得了业绩，也引起了消费者对拒绝销售员最初的请求而使销售员蒙受顺势的愧疚中。而实际上也许蒙受损失的是我们自己，尽管该损失对我们造成的影响有时微乎其微。但如果我们能够识别这些伎俩，那么我们就有了更多的选择空间，而不会落入了别人的圈套中而不自知，被别人的话术引导我们做出与初心违背的决策。</p>
<h2 id="如何拒绝互惠">2.3 如何拒绝互惠</h2>
<p>正常情况下，我们都会屈从于互惠原理，顺从请求者的愿望；虽然我们也可能会拒绝服从，但这样以来，我们内心深处就会承受因违背互惠原理而带来的公平感和义务感的谴责。所以倘若别人的提议我们确实赞同，那就不妨大胆接受它；但如果该提议别有所图，那么我们就置之不理，并且可以有足够的理由在心理安慰自己。毕竟互惠原理只说要以善意回报善意，可没说用善意回报诡计。</p>
<p>比如说，有人给了我们恩惠，我们可以安心接受下来，同时认识到将来有回报他的义务，然而如果这个人企图通过互惠原理利用我们，那么我们就应该保持警惕，同时视情况心安理得的盘剥他之前给的恩惠，毕竟互惠原理也说了，公正的意思，就是盘剥的行为要还以盘剥。此外，通过这件事情，可以推测出其行事风格带有极强的目的性，在未来的相关人际交往中，应该敬而远之。</p>
<h1 id="承诺与一致">3 承诺与一致</h1>
<h2 id="言出必行">3.1 言出必行</h2>
<p>承诺和一致指的是，我们们个人都有一种言行一致的愿望。一旦做出了艰难的选择，我们就很乐意相信自己选对了，事实上，我们经常会一次次地欺骗自己，以便在做出选择之后，相信自己做的没错。这也跟社会认同有关，因为在社会中，言行前后不一致的人，很容易会被看成脑筋混乱、表里不一，甚至精神有毛病的人；而与之相对的，言行高度通常跟个性坚强、能力出众挂钩。</p>
<p>言行一致其实还跟人类进化过程中的经验有关，因为言行一致符合我们这一群体的最佳利益，所以在进化过程中，这些经验不断驱使我们养成保持一致的习惯，哪怕有时候这么做并不明智。在日新月异的信息化时代，我们面临的社会环境远远超过了我们大脑能够处理的维度，如果任何事情都经过深思熟虑之后，再做出与之相应的最优决策，这是不切实际的，所以为了适应复杂的现代生活，我们大脑很容易沉浸在舒适圈中，选择言行一致这样一条捷径。其次，机械地保持一致，有时也能够避免理性上的折磨，避免误入歧途。试想，当一系列重要性程度相差无几的事项需要我们去选择时，毫无疑问，我们会选择自己熟知或者承诺过的事项作优先处理。</p>
<h2 id="承诺">3.2 承诺</h2>
<p>一旦我们意识到，我们的行动要受到言行一致的潜在精神动力所指引，那么我们在日常生活中就更加应该注意到承诺的重要性。我们一旦进行了承诺，就有可能会影响自我认知。前一段时间，偶然间看到了两年前在简书上写的一篇文章《那些愿意永远坚守的执念》，写文章的初心假借文章来规诫自己，时过境迁，到现在再去看这篇文章时，发现这些信念已经在不知不觉中对我的为人处世的风格产生了潜移默化的影响，我自己也在不知不觉中成为了一个精神世界饱满的人，这些君子规诫也在不断影响我的言行举止。所以不要小看写作的力量，写作是一种书面宣言，它成了一个行为业已发生的物证，会让我们不自觉中朝着声明里的方向改变态度，不断暗示自己：我们真心相信所写下的事情。</p>
<p>在知晓了承诺的影响力之后，在日常生活中，我们在接受琐碎请求时务必小心谨慎，因为它不仅能提高我们对分量更大的类似请求的顺从度，还能使我们更乐意去做一些跟先前答应的小要求毫不相关的事情。每当我们当众选择了一种立场，便会产生维持它的动机，因为这样才能显得前后一致。而有时候，维持这一动机所要付出的努力并不轻松，这便牵扯到为承诺付出的额外的努力。</p>
<p>心理学告诉我们，当我们为一个承诺付出的努力越多，它对承诺的影响力也就越大。这很容易理解：费劲周折才得到某样东西的人，比轻轻松松就得到的人，对这件东西往往更为珍视。这就能够让人理解，在大学校园里，一些社团的凝聚力极强，宛如一捆绳将所有社员凝聚在一起，而有的社团却如一盘散沙。这其实或多或少跟入社团时所付出的努力以及在参与社团活动中的个人参与有关，当你在一个组织中参与度越高，你对其的认同感和归属感也就也强。所以对于组织管理者而言，要想让一个组织具有极强的凝聚力，这种在组织事物参与中形成的羁绊的作用不容忽视。</p>
<h2 id="内心抉择和抛低球">3.3 内心抉择和抛低球</h2>
<p>除了承诺之外，还有两种与之相关的现象较为常见。内心抉择是指，我们很容易相信，我们要对自己的所作所为负责，一旦做了就没有借口可找，没有退路可言。但人是理性的，很容易为自己的行为做理由和借口。当外界存在较为强大的压力时，我们很容易为自己的行为找借口。</p>
<p>就拿我自己来说，我平时爱好十分广泛，喜欢看各种领域的课外书。但是当一种领域内的知识成为我的专业课知识时，我就产生了抵触心理，会厌倦它，虽然我个人并不是很看重课程的成绩，会按照自己的处事风格去处理每一门课程，但终归在学习这一课程时体会不了那种扩充知识面的喜悦感，只会认为这种学习是一种应付，长久下来，心中所剩的只有满目疲倦。所以我很认同作者所说：只有当我们认为外界不存在强大的压力时，我们才会为自己的行为发自内心地负起责任，并对自己言行一致的事实产生骄傲和自豪。</p>
<p>抛低球行为则更常见了，指的是先给人一个甜头，诱使人做出有利的购买决定。而后，等决定做好了，交易还没最终排版，卖方巧妙地取消了最初的甜头。有点类似于言行不一致，这在人情世故中同样常见，但也同样让人厌恶，这种由得转失的心理落差只会让人心中更为郁闷，有一种被耍了还在帮别人数钱的感觉。我自己就遇见过两回这种事情，也许这种事情对于对方而言只是无关紧要的事情，但对我而言，这不仅仅是小事，而是关乎人性的问题。有时我在想，如果我看不透做个糊涂人多好，可偏偏看透了，之后还是得抬头不见低头见地继续打交道，着实折磨人。</p>
<h2 id="如何拒绝">3.4 如何拒绝</h2>
<p>虽然承诺和一致是十分重要的品质，但有时难免被别有用心的人利用，这在以前一般体现在推销过程中，但对于生活在信息化时代，饱受电话推销苦恼的我们而言，这种套路几乎不用过于担心。反而是在社会生活中，我们饱受这一原理的影响，为人所熟知的沉没成本就是这一原理的体现。人们很容易沉浸在已经付出的沉没成本中，无法痛下决心舍弃某一事物。</p>
<p>正如拉夫尔·沃尔多·爱默生所说：死脑筋地保持一致愚不可及。虽然在现实生活中，保持一致是有逻辑性和智力超群的表现，而缺乏这一特点，则会被看成脑筋不够用，智力有障碍。但我们不能在一件错误的事情上执迷不悟。为了应对这一原理，我们应该跟随直觉：知道了我现在掌握的这些情况，要是时间能够倒流，我还会做出同样的选择吗？如果答案是否定的话，那么我们应该有壮士断腕的胸襟，抛却过去所付出的努力，重新开始新的征程！</p>
<h1 id="社会认同">4 社会认同</h1>
<h2 id="模仿">4.1 模仿</h2>
<p>社会认同原理指出：在判断何为正确时，我们会根据别人的意见行事。大多数时候，我们对社会认同的方式完全是无意识的、条件反射式的。一个很常见的案例是邪教，有时候我们旁人看起来邪教宣扬的教义明显也站不住脚的，但仍然存在着许多教徒，其中很多教徒对邪教本身并没有归属感，而是见到了许多信仰程度极高的人，在“三人成虎”的影响下，这些缺乏主见的人逐渐会开始相信这种信仰，这就是社会认同原理。</p>
<p>有一个非常有意思的现象，一些邪教会主动创造一些末日预言，在应对预言的过程中，培养教徒对邪教的信赖感，当我们以为这种愚昧的预言落空时，这些教徒会重回正道，现实却并不如此，他们反而会朝着错误的方向渐行渐远。比如小时候有一些邪教大肆宣扬 2012，世界末日，而当我们以为 2013 年的钟声敲响时，这种愚昧的把戏会不攻自破，而邪教本身也会土崩瓦解，然而事实却并非如此。事实是之前大肆宣扬教义的信徒，在预言落空后，反而成为了更加坚定的信徒。</p>
<p>这其实也不难理解，根据上一节中所说的额外的努力可知，这些信徒心中十分坚定地相信着邪教本身，为了坚守其心中的坚定，他们抛弃了许多，甚至有的抛弃了家庭。当语言落空后，他们其实心中已经有了怀疑，然而沉没成本让他们心有不甘，更为重要的是，一旦确定自己一直以来所坚定的信仰本身就是错误的，那这种前景显得过于可怕。正如作者所说，在预言落空后，驱使信徒们宣扬其信仰的，并不是先前的确定感，而是一种逐渐扩散的怀疑。</p>
<h2 id="不确定性">4.2 不确定性</h2>
<p>销售顾问卡维特·罗伯特（Cavett Robert） 总结了社会认同原理：95%的人都爱模仿别人，只有5%的人能首先发起行动，所以要想把人说服，我们提供任何证据的效果都比不上别人的行动。我们模仿别人的初衷就是，当我们处于不确定时，我们很难主动地做出决定，这时我们大脑会不自觉地选择一条捷径 —— 模仿他人。因为我们潜意识里觉得，这些敢于行动的人知道的信息会比我们多，而在更多的先验信息条件下，他们的行为极有可能是正确的。</p>
<p>我们在观察力与我们相似的人的行为时，社会认同原理能发挥出最大的影响。我们会根据他人的行为来判断自己怎么做才合适，尤其是我们觉得这些人跟自己相似的时候。这有时候其实也会造成一些不利的影响—— <strong>多元无知效应</strong>。多元无知效应揭示了一种乱象：受害者迫切需要帮助，全体旁观者却无动于衷。也许这在法治社会的当下，显得有些过于遥远，但如果说一个熟知的事件：跌倒的老人，扶不扶？当然，在负面新闻的熏染下，这个问题已经不仅仅涉及社会心理了，还跟道德、法律等有关。</p>
<p><strong>多元无知效应</strong> 讲的是，当现场有大量其他旁观者在场时，人们对紧急情况伸出援手的可能性极低。这是因为： 1. 周围有其他可以帮忙的人，单个人要承担的责任就减少了。 2. 很多时候，紧急情况表面上看起来并不显得十分紧急。</p>
<p>在公共场合中，我们所有人都喜欢摆出从容不迫的模样来显示我们的成熟稳重，但其实很可能只是暗中瞟着周围的人，不动声色地寻找证据。如果所有人都选择袖手旁观，那么每个人很有可能都得出判断：既然没人在乎，那就应该没什么问题。所以很多时候，旁观者群体没能帮忙，不是因为现在的人变得更为冷漠了，而是因为他们不能确定。这也是为什么现在新闻十分重视宣扬见义勇为的好人好事，因为打破思维定势真的需要很大的勇气。</p>
<p>多元无知效应在陌生人里显得最为突出：因为我们喜欢在公众面前表现得优雅而成熟，又因为我们不熟悉陌生人的反应，所以，置身于一群素不相识的人里面，我们有可能无法流露出关切的表情，也无法正确地解读他人关切的表情。所以，在一个完全陌生的环境中，当我们需要紧急救助的时候，最佳策略是减少不确定性，让周围人注意到你的状况，搞清楚自己的责任。</p>
<h2 id="如何拒绝-1">4.3 如何拒绝</h2>
<p>乍一看，社会认同好像与商业领域并无关联，其实不然，社会认同原理为我们配备了一种奇妙的自动导航仪，而许多商家就会利用我们的导航仪，来为自己的门店营造出十分火爆的场面，比如互联网下的销量为王、刷单刷好评，都是这一原理应用的体现。由于自动导航仪的弊端主要处在系统输入数据错误的时候，所以识别储物数据，就是我们对抗其弊端的最佳方式。面对明显是伪造的社会证据时，我们只要多保持一点警惕感，就能很好的保护自己了。</p>
<p>总体而言，本章所讲的社会认同原理以及有样学样的模仿行为，为我们提供了一条捷径。虽然绝大多数时候，这个自动导航装置能够给我们带来很多便利，但我们绝对不能完全信任这种捷径，哪怕没有人故意往里面添加错误信息，装置也有可能会发生故障。所以在日常生活中，我们应该时刻保持警惕感，虽然不至于所有事项的决策都与社会认同原理反着来，但清楚了事物发展的背后原理之后再做决策，可以让我们减少蒙受损失的概率。</p>
<h1 id="喜好">5 喜好</h1>
<h2 id="喜好的因素">5.1 喜好的因素</h2>
<p>喜好原理无论是商业领域，还是社会交际过程中，都十分普遍。社会学家一直在研究产生好感的因素，为了获得消费者的好感，这些专业人士几乎把每一个因素都巧妙地运用上了。 - 外表</p>
<p>一个人的某个正面特征很容易主导他人的看法，这也是为什么我们很容易对外表姣好的人产生好感的原因，所以外表的光环很容易会为顺从专业人士所利用。比如大部分服务业在招聘服务人员时，会选择面容姣好的从业人员。因为这会在潜意识中收获消费者的好感。</p>
<ul>
<li><p>相似性</p>
<p>相似性原理也可以用感同身受来解释，当别人同我们有许多相似之处时，我们心中会不自觉地产生亲近之感。所以在销售领域，常用的套路就是将产品赋予特别的含义，来拉近与消费者之间的距离，从而获得消费者的好感。</p></li>
<li><p>恭维</p>
<p>虽然恭维这一词语乍一看仿佛带有贬义，其实不然，现如今很多商业品牌会给自己的品牌赋予一些头衔，比如情怀、富贵的象征等等，归根结底还是恭维原理在起作用。通过赋予品牌和使用品牌的人新的内涵，进而收获消费者的好感。</p></li>
<li><p>接触与合作</p>
<p>由于熟悉感会影响人的喜好，因为这种熟悉感会对我们的各种决定都产生着影响。接触与合作更多地是针对群体好感度的快速提升，许多公司会花大笔财力物力给员工举办团建活动，目的就是为了促进团队之间的好感度和对公司的归属感，通过这种好感度的提升，进而促进团队内部办事效率的提升。</p>
<p>还有一种较为常见的合作是唱红脸和唱白脸，这种手段多用在审讯犯人的时候。但其实在商业竞争中，我们也可以将两个寡头之间的竞争看作是这种手段的翻版。有了差异化的决策，就有了抉择，我们通常会对唱红脸的一方产生好感，所以在商业领域中，我们很容易看见“落井下石”的现象，就是为了在已有“白脸”的衬托下，自己做一回红脸。</p></li>
<li><p>条件反射和关联</p>
<p>制造商总是急着把自己的产品跟当前的文化热潮、名人、流行艺人联系起来。通过名人代言来收获好感。在社会交际中，这项原理同样适用，根据关联原理，倘若我们能用一些哪怕是非常表面的方式让自己跟成功联系起来，我们的公共形象也会显得光辉起来。所以我们经常听到别人公开吹嘘与其他成功者的关系，目的就是在于沾染反射而来的荣誉光彩。</p>
<p>虽然我们或多或少地想沾染一点荣耀的光彩，但有些人走的太远了。主要原因在于他们的自我适应太差。他们内心深处的个人价值感过低，没办法靠推动或实现自身成就来追求荣誉，只能靠着吹嘘自己与他人成就的关系来找回尊严，可悲亦可叹！</p></li>
</ul>
<h2 id="如何拒绝-2">5.2 如何拒绝</h2>
<p>虽然经济学告诉我们消费的目的是满足心中的效用，但我们也不能在被设计好的喜好中渐行渐远。应对喜好原理的关键点在于：把注意力放在效果上，而非成因上。在跟顺从专业人士接触的时候，我们只需关注跟好感有关的一件事就行：我们是不是觉得自己超乎寻常地、迅速地、热烈地喜欢上了对方？如果答案显而易见，那么我们就应该保持警惕了，也许对方只是为了博取你的好感，进而实现其目的罢了，而这些目的通常有可能是建立在你的损失之上的。</p>
<p>关注喜好原理的产生，并不是说要我们压抑好感因素产生的影响力，相反，我们应该听凭这些因素发挥力量，然后用这股力量反过来对付那些想从中获利的人。这股力量越大，其发作用也就越发明显，对我们的戒备防御也就越有帮助。</p>
<h1 id="权威">6 权威</h1>
<h2 id="权威的影响">6.1 权威的影响</h2>
<p>心理学教授 <a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1611393075&amp;ver=2846&amp;signature=qbwls350egVrZj372FInEd5SLaLArk5jDigKCXJqyBS1wmw8NAucXO2bdGRcCYSC9vj*te2U03nX3lh2bxX7Gt53EEhrlPEyufWVD4HnIncV7yaCEIlpgaNJOwDjhmZI&amp;new=1">米尔格拉姆的实验</a> 揭露了一个事实：在权威的命令下，人们几乎愿意干任何事情。权威表示教化下的敬重，在我们潜意识里，权威意味着正确。所以在不确定的情况下，我们很容易跟着权威走。然而这份顺从有时被别出心裁的商家所利用，让我们掉入商家精心设计的思维定势中。</p>
<p>每当面对人类行为背后的一种强力推动因素，我们都会很自然地想到，这种推动因素的存在是有着充分的理由的。服从权威人物的命令，总是能给我们带来一些实际的好处，因为它帮助我们节省了思考的时间。这也是为什么一些牙膏、药品广告中通常会出现一些身穿白大褂的人物形象，因为很多情况下，只要有正统的权威说了话，其他本来应该考虑的事情就变得不相关了，即便这种权威是伪装出来的，也会对我们的认知产生或多或少的影响。</p>
<p>将权威这一含义泛化一下，其实更容易理解。我们在写个人简历的时候，惯用的手法就是写上自身相关经历在上面，其实这也可以看作是权威原理起作用的表现方式之一，因为通过这种头衔、相关经历的阐述，可以传达一个自己在相关事项上的权威能力，这种“权威”通常能让我们在竞争中处于优势地位。除了头衔之外，面试时的衣着、身份标识（豪车、名表）等传达的也是类似的信息，通过这种公开信息，能够让我们在公众中收获特殊的尊重，哪怕这种尊重是单纯的畏惧，也会对当事人产生莫名的自豪和骄傲。</p>
<h2 id="如何拒绝-3">6.2 如何拒绝</h2>
<p>为了免受伪权威的误导，防御策略之一就是提前做好心理准备。我们通常会低估权威及其象征对自己行为的影响，然而事实是一旦它出现在要求顺从的场合，我们往往来不及提防。破解伪权威对我们决策的影响，我们只需在脑海中问自己两个问题： 1. 这个权威是真正的专家吗</p>
<p>这个问题能让我嗯我们把焦点放在：权威的资格，以及这些资格是否跟眼前的主题相关。帮助我们从兴许毫无意义的权威符号上挪开视线，转到真正的权威资格上。通过这种简单的方法，着眼于权威地位的证据，能让我们避免自动顺从带来的大部分问题。</p>
<ol start="2" type="1">
<li>这个专家说的是真话吗？</li>
</ol>
<p>哪怕是知识最丰富的权威，也不一定会开诚布公地把信息告知我们，因此，我们必须考虑一下他们在当前情形下的真实可信度。多思考一下专家会不会因为我们的顺从而得到好处，通过这样，我们就为自己又设立了一道安全网，防御权威不必要的影响。比较常见的一个小伎俩是——怀柔，即一些看似违背自己利益的做法。这无论是商业领域还是为人处世中，都会不自觉地被人们加以利用，通过这种看似违背自己利益的做法，可以拉近与对方的距离，增强对方对我们的好感度。</p>
<h1 id="稀缺">7 稀缺</h1>
<h2 id="物以稀为贵">7.1 物以稀为贵</h2>
<p>稀缺原理指的是，机会越少见，价值似乎就越高。对失去某种东西的恐惧通常比获得同一物品的渴望，更能激发我们的行动力。而有时，讽刺的地方也在这儿，倘若瑕疵把一样东西变得稀缺了，垃圾也能化身成值钱的宝贝，这在玩物收藏市场几乎是常态了。其实，现实生活中，我们最容易受稀缺原理的影响了，最常见的两种商业套路是： - 数量有限策略</p>
<ul>
<li>最后期限战术</li>
</ul>
<p>商家惯用的商业套路就是营造一些降价折扣的事由，来刺激消费者对商品进行购买，也许商品本身并不在消费者最初消费计划中，但是在稀缺性的刺激下，商品的认知价值在消费者心中突然有了大幅提升。其实降价也可以算在稀缺性原理中，因为相对于日常的高位价格，暂时性的降价折扣就显得颇为稀缺，错过了当下，以后可能需要花费更高额度的费用，这种期望落差通常会刺激消费者做出不理性的购买决策。</p>
<p>此外，另一种常见的套路就是有竞争性的稀缺资源，参与竞争稀缺资源的感觉，有着比单纯的稀有资源更为强大的吸引力。渴望拥有一件众人争抢的东西，几乎是出于本能的身体反应。所以在稀缺物品的竞拍中，我们通常能见到类似的现象，通过简单的心理博弈，能够让最终的成交价格朝着卖家预设的价位移动。</p>
<h2 id="逆反心理">7.2 逆反心理</h2>
<p>稀缺性原理起作用的力量主要来自两个方面。第一点它钻了我们思维捷径上的漏洞。在我们认知中，难以得到的东西，通常会让我们更为珍视。故此，我们基本可以根据获得一样东西的难易程度，迅速、准确地判断它质量，而这种判断在很大程度上是正确的。</p>
<p>第二点在于，机会越来越少的话，我们的自由也会随之丧失。每当有东西获取起来比以前难，我们拥有它的自由受了限制，我们就越发地想要得到它。我们痛恨失去本来拥有的自由，这种保住既得利益的愿望是心里逆反理论的核心。</p>
<p>詹姆斯·戴维斯（James Davies）曾指出，一个国家在经济和社会条件改善后，要是在短期内出现剧烈逆转，最有可能爆发革命。而且最容易企业的，不是那些传统上最受压迫的底层人民，而是品尝过了更美好生活的人。因为该群体得到了以前从来没有的自由，一点有人想要夺走这些自由，就注定要付出一些代价。</p>
<p>在实际生活中逆反心理也比较常见，最为人所熟知的一种现象就是青少年的叛逆期。通过上述阐述，我们知道自由这种东西，给一点又拿走，比完全不给更危险。所以管教前后不一的父母，更容易教出反叛心强的孩子。所以在教育孩子上，家长应该以身作则，给孩子树立良好的榜样，而不是严于律人，宽以待己。</p>
<h2 id="如何拒绝-4">7.3 如何拒绝</h2>
<p>在知晓我们如何拒绝稀缺原理影响我们决策时，我们应该知道一个道理：喜悦并非来自对稀缺商品的体验，而是来自对它的占有。稀缺的东西并不因为难以占有，就变得更好吃、好听、好看、好用了。所以一旦我们觉得我们在短缺影响下产生了高度的情绪波动，我们就应该把这种波动当成暂停的信号，并在心底询问自己，为什么我们想要那件东西，是为了拥有它，还是为了它的价值或功能。</p>
<p>谈若是因为想拥有它，那么我们应该利用它的稀缺性来判断改为它出多少钱，一旦价格超出该底线，我们应该心生警惕，因为这也许是商家在利用稀缺性原理在谋取的超额收益。如果是为了它的功能，那么我们应该牢记一点：该物品并不会因为稀缺而增强它的功能。换而言之，我们应该积极寻求它的等价替代产品，获取更多信息之后，在做出合理的决策。</p>
<h1 id="总结">8 总结</h1>
<p>作者写本书的目的并不是说，让我们对这些简单而常见的小套路避之不及，而是希望我们能洞悉事物发展背后的逻辑，至少在明事理之后，能让我们有了更多选择的权利，不至于让我们在被“戏耍”后而不自知。尽管只靠孤立数据容易做出愚蠢的决定，可现代生活的节奏又要求我们频繁使用这一捷径。</p>
<p>为了追求效率，有时候我们必须放弃耗时而复杂的全局决策过程，转而使用更简单、由单一特征出发的响应方式。它之所以最为常用，完全是因为它们的可靠性高，在我们人类进化过程中，通常都能指引我们做出正确决定，这也是为什么我们会潜意识里借助这些因素做出顺从决定。在没有意愿、时间、精力或认知资源对情况进行全面分析的时候，使用这些孤立的线索进行决策是简单而保险的决策方式。</p>
<p>正如作者所说一般，这种便捷的响应方式应当受到尊重。在日新月异的当下，技术的进步速度远远快于我们，所以我们处理信息的天然能力将有可能越来越难于应对当代生活中繁多的变化、选择和挑战。有时我们会发现自己陷入了跟低等动物一样的处境中：外界环境的错综复杂超出了我们心智的处理能力。从这个方面来说，我们的大脑潜意识里依赖可靠而合理的捷径和首选规则来应对生活的紧张节奏也是无可厚非的。</p>
<p>然而，我们真正值得警惕的是，那些知晓我们的响应机制，但通过别出心裁的设计来破坏我们的心理机制，或者说通过我们的响应机制来蒙蔽我们，来从我们身上谋取私利的人。虽然大多数时候，这种戏弄不会对我们造成太大的损失，但正如《三国志·蜀书·先主传》所说：“勿以善小而不为，勿以恶小而为之”，积小成多，聚沙成塔，终归会有一天对我们的反应机制产生不可逆的影响。</p>
<p>正如一直以来我对自己的要求：我可以不成为这一领域的专家，但其中的基本原理我得懂，这也是为什么这么多年来，我始终如一地扩充自己的知识面。一方面是因为获取知识的过程能给我带来确实的快感，另一方面则是因为，涉猎各领域的知识能够让我以更多的角度看待事物，不至于让自己的无知中变成一个智慧鹦鹉学舌而不会独立思考的人！</p>
<p>最后附上我最喜欢的一个著名投资家查理·芒格所说的一句话： &gt; 我这辈子遇到的聪明人（来自各行各业的聪明人）没有不每天阅读的 —— 没有，一个都没有。巴菲特读书之多，我读书之多，可能会让你感到吃惊。孩子们都笑话我，他们觉得我是一本长了两条腿的书。</p>
<p>很多人读书，追求的是干货，寻求的是立刻行之有效的解决方案。其实这是一种留在舒适区的阅读方法。在这个充满不确定的时代，答案不会简单地出现在书里，因为生活根本就没有标准确切的答案，你也不能期望过去的经验能够解决未来的问题。能简单地出现在书中的答案只有试卷，而这也是我不喜欢以考试来鞭策读书的原因之一，只可惜在现今成绩为王的时代，能做的只有在半顺从下坚持自己原则。除此之外，别无他法，可悲！</p>
<p>本书主要谈论了一些社会生活中常见，但我们通常容易忽视的小套路，从互惠、承诺和一致、社会认同、喜好、权威以及稀缺六个方面对这些套路进行归类，通过一番抽丝剥茧式的分析，来阐述人们面对这些套路时会陷入的思维定势以及应对措施。</p>
<p>在日常生活中，各种销售广告、推销手段层出不穷，一些经不起推敲的广告却有时能够取得奇效，一些看似损害商家自身利益的小套路却能够给商家带来更多利益……这些都是通过影响力这一手段来影响我们的决策。作者通过对影响力的作用方式进行剖析，解释了影响力的厉害关系。因为它，我们可能被无良商家诓骗而蒙受损失，甚至映射到社交生活中，前些年饱受诟病的“PUA”中也能看到影响力这一武器被滥用的影子。</p>
<p>作者的很多论述朴实无华，但却能在平凡的语言中让我有种感同身受的真实感。比如以承诺与一致为例，前段时间，偶然间翻看了两年前在简书上写的一篇文章《那些愿意永远坚守的执念》。我以前总是以信念、信仰之类的规诫自己，所以当时兴致偶发，记录了一些优秀的品质借以自勉。殊不知时过境迁，再次重温之时，竟发现这些执念已经在不知不觉之中已经深入记忆，成为了个人为人处世的一部分了。不免有些喟叹，如果当初没有记录的冲动，也许这些执念只会在人情世故中泯然消逝罢了。此外，还有其他许多因素，都能带给我发自内心的共鸣感，通过了解它们，可以帮助我更好地剖析遇到的问题，理解社会现象，避开一些本该能够避免的社会损失。</p>
<p>## 1.1 按一下就播放</p>
<p>影响力对我们起作用的方式是作者称为“按一下就播放”的一种固定行为模式。这种模式最初是研究动物行为时所提，其基本特点是：构成模式的行为每次都是按照几乎无异的方式或相同的顺序发生，就好像这些方式是记录动物身体里内置的磁带上，只要到了特定环境，相应的行为就得到激活，进而按照标准的顺序展开一整套行为，就如同按下了播放键一样。最有意思的一点在于这个磁带的激活方式，促发者也许并不是对手这个整体，而是对手具备的一些特征。</p>
<p>而在人类社会中，同样存在按一下就播放的范式，比如别人在请求我们帮忙的时候，要是能给一个理由，我们通常会乐意提供帮助。“因为”这个词可以触发我我们的自动顺从反应，哪怕请求者并没有给出一个说得通的理由，但我们潜意识里会说服自己去帮助对方，就像是“因为”这个词语按下了我们顺从反应的按钮一般。</p>
<p>事实上，这种模式化的自动行为在人类活动中是相当普遍的。因为很多时候，它是最有效的行为方式。英国著名哲学家怀特海（Alfred North Whitehead） 曾断言：文明的进步，就是人们在不假思索中可以做的事情越来越多。我们都生活在一个极其复杂的环境中，为了应对社会生活的日新月异，我们需要捷径，因为我们没有足够的时间、精力和能力来对每一件事采取“谋定而后动”的策略。所以，我们需要频繁地根据少数关键特征把事情进行分类，以便下次碰到同样的触发特征，就可以不假思索地做出最为有利的反应。</p>
<p># 2 互惠</p>
<p>## 2.1 滴水之恩，涌泉相报</p>
<p>互惠原理指，当别人帮了我们的忙，给了我们好处，我们应当回报他，也即我们平时所说，滴水之恩，定当以涌泉相报。著名考古学家理查德·利基（Richard Leakey）认为：正是因为有了互惠体系，人类才成为人类。确实，倘若我们没有学会“有债必还”的道理，人类又如何会走上劳动分工的道路呢？更遑论让个体相互依赖，凝结成高效率的单位了。</p>
<p>该原理告诉我们，超市在希望消费者购买产品时，通常会先向向消费者施加小小的恩惠，如赠送样品，通过这种小技巧，就可以极大地提高消费者依其言行其事的概率。当然，在消费者不断被资本家割韭菜的今日，个人感觉这种小伎俩早已不足以打动消费者了。</p>
<p>此外，在无关金钱和商业交易的人际关系中，同样也受互惠原理的影响，他人通过硬塞给我们一些好处，就能触发我们的亏欠感。这份亏欠感会驱使我们对别人的付出进行弥补和偿还，而正是这份偿还义务构成了互惠原理的实质。古人云：滴水之恩，当涌泉相报。最初的小小善意会刺激人们报以大得多的恩惠，因为亏欠感会让我们心生内疚。</p>
<p>这一点让我倍感亲切，我妈从小教育我，不要贪图别人的小便宜，不要亏欠别人。我也一直践行着这一准则，总觉得自己不够强大，总觉得自己无以回报，哪怕自己真的需要，也会尽量避免找人帮忙，即便找人帮忙或者受人人情，最终也一定会以回报大于得到而终。因为我始终以高规格的精神标准要求自己，当心理亏欠的负担落在肩头，有时是比物质损失更难以忍受的折磨。</p>
<p>## 2.2 互惠式让步</p>
<p>除了上述滴水之恩，涌泉相报的常规互惠范式之外，还有一种常见的套路“互惠式让步”。它的实现途径也比较简单，首先，它迫使接受了对方让步的人以同样的方式回应；其次，由于接受了让步的人有回报的义务，人们就乐意率先让步，从而启动有益的交换过程。</p>
<p>简单来说就是，假设你想让我答应你的某个请求，为了增加获胜的概率，你可以先向我提出一个大些的要求，等我拒绝之后，再提出一个稍小的要求，而这个要求才是你真正的目标。倘若你的要求设置巧妙，我会把你的第二个要求看成对我的让步，并有可能感到自己这边也应该让步，于是顺从了你的第二个要求。</p>
<p>这种手段也叫做“拒绝——后撤术”，常见于谈判和推销过程中，一些经验老道的销售员能够非常娴熟地使用这种手段，诱使消费者进入预先编织好的“陷阱”中，不但赢得了业绩，也引起了消费者对拒绝销售员最初的请求而使销售员蒙受顺势的愧疚中。而实际上也许蒙受损失的是我们自己，尽管该损失对我们造成的影响有时微乎其微。但如果我们能够识别这些伎俩，那么我们就有了更多的选择空间，而不会落入了别人的圈套中而不自知，被别人的话术引导我们做出与初心违背的决策。</p>
<p>## 2.3 如何拒绝互惠</p>
<p>正常情况下，我们都会屈从于互惠原理，顺从请求者的愿望；虽然我们也可能会拒绝服从，但这样以来，我们内心深处就会承受因违背互惠原理而带来的公平感和义务感的谴责。所以倘若别人的提议我们确实赞同，那就不妨大胆接受它；但如果该提议别有所图，那么我们就置之不理，并且可以有足够的理由在心理安慰自己。毕竟互惠原理只说要以善意回报善意，可没说用善意回报诡计。</p>
<p>比如说，有人给了我们恩惠，我们可以安心接受下来，同时认识到将来有回报他的义务，然而如果这个人企图通过互惠原理利用我们，那么我们就应该保持警惕，同时视情况心安理得的盘剥他之前给的恩惠，毕竟互惠原理也说了，公正的意思，就是盘剥的行为要还以盘剥。此外，通过这件事情，可以推测出其行事风格带有极强的目的性，在未来的相关人际交往中，应该敬而远之。</p>
<p># 3 承诺与一致</p>
<p>## 3.1 言出必行</p>
<p>承诺和一致指的是，我们们个人都有一种言行一致的愿望。一旦做出了艰难的选择，我们就很乐意相信自己选对了，事实上，我们经常会一次次地欺骗自己，以便在做出选择之后，相信自己做的没错。这也跟社会认同有关，因为在社会中，言行前后不一致的人，很容易会被看成脑筋混乱、表里不一，甚至精神有毛病的人；而与之相对的，言行高度通常跟个性坚强、能力出众挂钩。</p>
<p>言行一致其实还跟人类进化过程中的经验有关，因为言行一致符合我们这一群体的最佳利益，所以在进化过程中，这些经验不断驱使我们养成保持一致的习惯，哪怕有时候这么做并不明智。在日新月异的信息化时代，我们面临的社会环境远远超过了我们大脑能够处理的维度，如果任何事情都经过深思熟虑之后，再做出与之相应的最优决策，这是不切实际的，所以为了适应复杂的现代生活，我们大脑很容易沉浸在舒适圈中，选择言行一致这样一条捷径。其次，机械地保持一致，有时也能够避免理性上的折磨，避免误入歧途。试想，当一系列重要性程度相差无几的事项需要我们去选择时，毫无疑问，我们会选择自己熟知或者承诺过的事项作优先处理。</p>
<p>## 3.2 承诺</p>
<p>一旦我们意识到，我们的行动要受到言行一致的潜在精神动力所指引，那么我们在日常生活中就更加应该注意到承诺的重要性。我们一旦进行了承诺，就有可能会影响自我认知。前一段时间，偶然间看到了两年前在简书上写的一篇文章《那些愿意永远坚守的执念》，写文章的初心假借文章来规诫自己，时过境迁，到现在再去看这篇文章时，发现这些信念已经在不知不觉中对我的为人处世的风格产生了潜移默化的影响，我自己也在不知不觉中成为了一个精神世界饱满的人，这些君子规诫也在不断影响我的言行举止。所以不要小看写作的力量，写作是一种书面宣言，它成了一个行为业已发生的物证，会让我们不自觉中朝着声明里的方向改变态度，不断暗示自己：我们真心相信所写下的事情。</p>
<p>在知晓了承诺的影响力之后，在日常生活中，我们在接受琐碎请求时务必小心谨慎，因为它不仅能提高我们对分量更大的类似请求的顺从度，还能使我们更乐意去做一些跟先前答应的小要求毫不相关的事情。每当我们当众选择了一种立场，便会产生维持它的动机，因为这样才能显得前后一致。而有时候，维持这一动机所要付出的努力并不轻松，这便牵扯到为承诺付出的额外的努力。</p>
<p>心理学告诉我们，当我们为一个承诺付出的努力越多，它对承诺的影响力也就越大。这很容易理解：费劲周折才得到某样东西的人，比轻轻松松就得到的人，对这件东西往往更为珍视。这就能够让人理解，在大学校园里，一些社团的凝聚力极强，宛如一捆绳将所有社员凝聚在一起，而有的社团却如一盘散沙。这其实或多或少跟入社团时所付出的努力以及在参与社团活动中的个人参与有关，当你在一个组织中参与度越高，你对其的认同感和归属感也就也强。所以对于组织管理者而言，要想让一个组织具有极强的凝聚力，这种在组织事物参与中形成的羁绊的作用不容忽视。</p>
<p>## 3.3 内心抉择和抛低球</p>
<p>除了承诺之外，还有两种与之相关的现象较为常见。内心抉择是指，我们很容易相信，我们要对自己的所作所为负责，一旦做了就没有借口可找，没有退路可言。但人是理性的，很容易为自己的行为做理由和借口。当外界存在较为强大的压力时，我们很容易为自己的行为找借口。</p>
<p>就拿我自己来说，我平时爱好十分广泛，喜欢看各种领域的课外书。但是当一种领域内的知识成为我的专业课知识时，我就产生了抵触心理，会厌倦它，虽然我个人并不是很看重课程的成绩，会按照自己的处事风格去处理每一门课程，但终归在学习这一课程时体会不了那种扩充知识面的喜悦感，只会认为这种学习是一种应付，长久下来，心中所剩的只有满目疲倦。所以我很认同作者所说：只有当我们认为外界不存在强大的压力时，我们才会为自己的行为发自内心地负起责任，并对自己言行一致的事实产生骄傲和自豪。</p>
<p>抛低球行为则更常见了，指的是先给人一个甜头，诱使人做出有利的购买决定。而后，等决定做好了，交易还没最终排版，卖方巧妙地取消了最初的甜头。有点类似于言行不一致，这在人情世故中同样常见，但也同样让人厌恶，这种由得转失的心理落差只会让人心中更为郁闷，有一种被耍了还在帮别人数钱的感觉。我自己就遇见过两回这种事情，也许这种事情对于对方而言只是无关紧要的事情，但对我而言，这不仅仅是小事，而是关乎人性的问题。有时我在想，如果我看不透做个糊涂人多好，可偏偏看透了，之后还是得抬头不见低头见地继续打交道，着实折磨人。</p>
<p>## 3.4 如何拒绝</p>
<p>虽然承诺和一致是十分重要的品质，但有时难免被别有用心的人利用，这在以前一般体现在推销过程中，但对于生活在信息化时代，饱受电话推销苦恼的我们而言，这种套路几乎不用过于担心。反而是在社会生活中，我们饱受这一原理的影响，为人所熟知的沉没成本就是这一原理的体现。人们很容易沉浸在已经付出的沉没成本中，无法痛下决心舍弃某一事物。</p>
<p>正如拉夫尔·沃尔多·爱默生所说：死脑筋地保持一致愚不可及。虽然在现实生活中，保持一致是有逻辑性和智力超群的表现，而缺乏这一特点，则会被看成脑筋不够用，智力有障碍。但我们不能在一件错误的事情上执迷不悟。为了应对这一原理，我们应该跟随直觉：知道了我现在掌握的这些情况，要是时间能够倒流，我还会做出同样的选择吗？如果答案是否定的话，那么我们应该有壮士断腕的胸襟，抛却过去所付出的努力，重新开始新的征程！</p>
<p># 4 社会认同</p>
<p>## 4.1 模仿</p>
<p>社会认同原理指出：在判断何为正确时，我们会根据别人的意见行事。大多数时候，我们对社会认同的方式完全是无意识的、条件反射式的。一个很常见的案例是邪教，有时候我们旁人看起来邪教宣扬的教义明显也站不住脚的，但仍然存在着许多教徒，其中很多教徒对邪教本身并没有归属感，而是见到了许多信仰程度极高的人，在“三人成虎”的影响下，这些缺乏主见的人逐渐会开始相信这种信仰，这就是社会认同原理。</p>
<p>有一个非常有意思的现象，一些邪教会主动创造一些末日预言，在应对预言的过程中，培养教徒对邪教的信赖感，当我们以为这种愚昧的预言落空时，这些教徒会重回正道，现实却并不如此，他们反而会朝着错误的方向渐行渐远。比如小时候有一些邪教大肆宣扬 2012，世界末日，而当我们以为 2013 年的钟声敲响时，这种愚昧的把戏会不攻自破，而邪教本身也会土崩瓦解，然而事实却并非如此。事实是之前大肆宣扬教义的信徒，在预言落空后，反而成为了更加坚定的信徒。</p>
<p>这其实也不难理解，根据上一节中所说的额外的努力可知，这些信徒心中十分坚定地相信着邪教本身，为了坚守其心中的坚定，他们抛弃了许多，甚至有的抛弃了家庭。当语言落空后，他们其实心中已经有了怀疑，然而沉没成本让他们心有不甘，更为重要的是，一旦确定自己一直以来所坚定的信仰本身就是错误的，那这种前景显得过于可怕。正如作者所说，在预言落空后，驱使信徒们宣扬其信仰的，并不是先前的确定感，而是一种逐渐扩散的怀疑。</p>
<p>## 4.2 不确定性</p>
<p>销售顾问卡维特·罗伯特（Cavett Robert） 总结了社会认同原理：95%的人都爱模仿别人，只有5%的人能首先发起行动，所以要想把人说服，我们提供任何证据的效果都比不上别人的行动。我们模仿别人的初衷就是，当我们处于不确定时，我们很难主动地做出决定，这时我们大脑会不自觉地选择一条捷径 —— 模仿他人。因为我们潜意识里觉得，这些敢于行动的人知道的信息会比我们多，而在更多的先验信息条件下，他们的行为极有可能是正确的。</p>
<p>我们在观察力与我们相似的人的行为时，社会认同原理能发挥出最大的影响。我们会根据他人的行为来判断自己怎么做才合适，尤其是我们觉得这些人跟自己相似的时候。这有时候其实也会造成一些不利的影响—— <strong>多元无知效应</strong>。多元无知效应揭示了一种乱象：受害者迫切需要帮助，全体旁观者却无动于衷。也许这在法治社会的当下，显得有些过于遥远，但如果说一个熟知的事件：跌倒的老人，扶不扶？当然，在负面新闻的熏染下，这个问题已经不仅仅涉及社会心理了，还跟道德、法律等有关。</p>
<p><strong>多元无知效应</strong> 讲的是，当现场有大量其他旁观者在场时，人们对紧急情况伸出援手的可能性极低。这是因为：</p>
<p>\1. 周围有其他可以帮忙的人，单个人要承担的责任就减少了。</p>
<p>\2. 很多时候，紧急情况表面上看起来并不显得十分紧急。</p>
<p>在公共场合中，我们所有人都喜欢摆出从容不迫的模样来显示我们的成熟稳重，但其实很可能只是暗中瞟着周围的人，不动声色地寻找证据。如果所有人都选择袖手旁观，那么每个人很有可能都得出判断：既然没人在乎，那就应该没什么问题。所以很多时候，旁观者群体没能帮忙，不是因为现在的人变得更为冷漠了，而是因为他们不能确定。这也是为什么现在新闻十分重视宣扬见义勇为的好人好事，因为打破思维定势真的需要很大的勇气。</p>
<p>多元无知效应在陌生人里显得最为突出：因为我们喜欢在公众面前表现得优雅而成熟，又因为我们不熟悉陌生人的反应，所以，置身于一群素不相识的人里面，我们有可能无法流露出关切的表情，也无法正确地解读他人关切的表情。所以，在一个完全陌生的环境中，当我们需要紧急救助的时候，最佳策略是减少不确定性，让周围人注意到你的状况，搞清楚自己的责任。</p>
<p>## 4.3 如何拒绝</p>
<p>乍一看，社会认同好像与商业领域并无关联，其实不然，社会认同原理为我们配备了一种奇妙的自动导航仪，而许多商家就会利用我们的导航仪，来为自己的门店营造出十分火爆的场面，比如互联网下的销量为王、刷单刷好评，都是这一原理应用的体现。由于自动导航仪的弊端主要处在系统输入数据错误的时候，所以识别储物数据，就是我们对抗其弊端的最佳方式。面对明显是伪造的社会证据时，我们只要多保持一点警惕感，就能很好的保护自己了。</p>
<p>总体而言，本章所讲的社会认同原理以及有样学样的模仿行为，为我们提供了一条捷径。虽然绝大多数时候，这个自动导航装置能够给我们带来很多便利，但我们绝对不能完全信任这种捷径，哪怕没有人故意往里面添加错误信息，装置也有可能会发生故障。所以在日常生活中，我们应该时刻保持警惕感，虽然不至于所有事项的决策都与社会认同原理反着来，但清楚了事物发展的背后原理之后再做决策，可以让我们减少蒙受损失的概率。</p>
<p># 5 喜好</p>
<p>## 5.1 喜好的因素</p>
<p>喜好原理无论是商业领域，还是社会交际过程中，都十分普遍。社会学家一直在研究产生好感的因素，为了获得消费者的好感，这些专业人士几乎把每一个因素都巧妙地运用上了。</p>
<p>- 外表</p>
<p>一个人的某个正面特征很容易主导他人的看法，这也是为什么我们很容易对外表姣好的人产生好感的原因，所以外表的光环很容易会为顺从专业人士所利用。比如大部分服务业在招聘服务人员时，会选择面容姣好的从业人员。因为这会在潜意识中收获消费者的好感。</p>
<p>- 相似性</p>
<p>相似性原理也可以用感同身受来解释，当别人同我们有许多相似之处时，我们心中会不自觉地产生亲近之感。所以在销售领域，常用的套路就是将产品赋予特别的含义，来拉近与消费者之间的距离，从而获得消费者的好感。</p>
<p>- 恭维</p>
<p>虽然恭维这一词语乍一看仿佛带有贬义，其实不然，现如今很多商业品牌会给自己的品牌赋予一些头衔，比如情怀、富贵的象征等等，归根结底还是恭维原理在起作用。通过赋予品牌和使用品牌的人新的内涵，进而收获消费者的好感。</p>
<p>- 接触与合作</p>
<p>由于熟悉感会影响人的喜好，因为这种熟悉感会对我们的各种决定都产生着影响。接触与合作更多地是针对群体好感度的快速提升，许多公司会花大笔财力物力给员工举办团建活动，目的就是为了促进团队之间的好感度和对公司的归属感，通过这种好感度的提升，进而促进团队内部办事效率的提升。</p>
<p>还有一种较为常见的合作是唱红脸和唱白脸，这种手段多用在审讯犯人的时候。但其实在商业竞争中，我们也可以将两个寡头之间的竞争看作是这种手段的翻版。有了差异化的决策，就有了抉择，我们通常会对唱红脸的一方产生好感，所以在商业领域中，我们很容易看见“落井下石”的现象，就是为了在已有“白脸”的衬托下，自己做一回红脸。</p>
<p>- 条件反射和关联</p>
<p>制造商总是急着把自己的产品跟当前的文化热潮、名人、流行艺人联系起来。通过名人代言来收获好感。在社会交际中，这项原理同样适用，根据关联原理，倘若我们能用一些哪怕是非常表面的方式让自己跟成功联系起来，我们的公共形象也会显得光辉起来。所以我们经常听到别人公开吹嘘与其他成功者的关系，目的就是在于沾染反射而来的荣誉光彩。</p>
<p>虽然我们或多或少地想沾染一点荣耀的光彩，但有些人走的太远了。主要原因在于他们的自我适应太差。他们内心深处的个人价值感过低，没办法靠推动或实现自身成就来追求荣誉，只能靠着吹嘘自己与他人成就的关系来找回尊严，可悲亦可叹！</p>
<p>## 5.2 如何拒绝</p>
<p>虽然经济学告诉我们消费的目的是满足心中的效用，但我们也不能在被设计好的喜好中渐行渐远。应对喜好原理的关键点在于：把注意力放在效果上，而非成因上。在跟顺从专业人士接触的时候，我们只需关注跟好感有关的一件事就行：我们是不是觉得自己超乎寻常地、迅速地、热烈地喜欢上了对方？如果答案显而易见，那么我们就应该保持警惕了，也许对方只是为了博取你的好感，进而实现其目的罢了，而这些目的通常有可能是建立在你的损失之上的。</p>
<p>关注喜好原理的产生，并不是说要我们压抑好感因素产生的影响力，相反，我们应该听凭这些因素发挥力量，然后用这股力量反过来对付那些想从中获利的人。这股力量越大，其发作用也就越发明显，对我们的戒备防御也就越有帮助。</p>
<p># 6 权威</p>
<p>## 6.1 权威的影响</p>
<p>心理学教授 <a href="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1611393075&amp;ver=2846&amp;signature=qbwls350egVrZj372FInEd5SLaLArk5jDigKCXJqyBS1wmw8NAucXO2bdGRcCYSC9vj*te2U03nX3lh2bxX7Gt53EEhrlPEyufWVD4HnIncV7yaCEIlpgaNJOwDjhmZI&amp;new=1">米尔格拉姆的实验</a> 揭露了一个事实：在权威的命令下，人们几乎愿意干任何事情。权威表示教化下的敬重，在我们潜意识里，权威意味着正确。所以在不确定的情况下，我们很容易跟着权威走。然而这份顺从有时被别出心裁的商家所利用，让我们掉入商家精心设计的思维定势中。</p>
<p>每当面对人类行为背后的一种强力推动因素，我们都会很自然地想到，这种推动因素的存在是有着充分的理由的。服从权威人物的命令，总是能给我们带来一些实际的好处，因为它帮助我们节省了思考的时间。这也是为什么一些牙膏、药品广告中通常会出现一些身穿白大褂的人物形象，因为很多情况下，只要有正统的权威说了话，其他本来应该考虑的事情就变得不相关了，即便这种权威是伪装出来的，也会对我们的认知产生或多或少的影响。</p>
<p>将权威这一含义泛化一下，其实更容易理解。我们在写个人简历的时候，惯用的手法就是写上自身相关经历在上面，其实这也可以看作是权威原理起作用的表现方式之一，因为通过这种头衔、相关经历的阐述，可以传达一个自己在相关事项上的权威能力，这种“权威”通常能让我们在竞争中处于优势地位。除了头衔之外，面试时的衣着、身份标识（豪车、名表）等传达的也是类似的信息，通过这种公开信息，能够让我们在公众中收获特殊的尊重，哪怕这种尊重是单纯的畏惧，也会对当事人产生莫名的自豪和骄傲。</p>
<p>## 6.2 如何拒绝</p>
<p>为了免受伪权威的误导，防御策略之一就是提前做好心理准备。我们通常会低估权威及其象征对自己行为的影响，然而事实是一旦它出现在要求顺从的场合，我们往往来不及提防。破解伪权威对我们决策的影响，我们只需在脑海中问自己两个问题：</p>
<p>\1. 这个权威是真正的专家吗</p>
<p>这个问题能让我嗯我们把焦点放在：权威的资格，以及这些资格是否跟眼前的主题相关。帮助我们从兴许毫无意义的权威符号上挪开视线，转到真正的权威资格上。通过这种简单的方法，着眼于权威地位的证据，能让我们避免自动顺从带来的大部分问题。</p>
<p>\2. 这个专家说的是真话吗？</p>
<p>哪怕是知识最丰富的权威，也不一定会开诚布公地把信息告知我们，因此，我们必须考虑一下他们在当前情形下的真实可信度。多思考一下专家会不会因为我们的顺从而得到好处，通过这样，我们就为自己又设立了一道安全网，防御权威不必要的影响。比较常见的一个小伎俩是——怀柔，即一些看似违背自己利益的做法。这无论是商业领域还是为人处世中，都会不自觉地被人们加以利用，通过这种看似违背自己利益的做法，可以拉近与对方的距离，增强对方对我们的好感度。</p>
<p># 7 稀缺</p>
<p>## 7.1 物以稀为贵</p>
<p>稀缺原理指的是，机会越少见，价值似乎就越高。对失去某种东西的恐惧通常比获得同一物品的渴望，更能激发我们的行动力。而有时，讽刺的地方也在这儿，倘若瑕疵把一样东西变得稀缺了，垃圾也能化身成值钱的宝贝，这在玩物收藏市场几乎是常态了。其实，现实生活中，我们最容易受稀缺原理的影响了，最常见的两种商业套路是：</p>
<p>- 数量有限策略</p>
<p>- 最后期限战术</p>
<p>商家惯用的商业套路就是营造一些降价折扣的事由，来刺激消费者对商品进行购买，也许商品本身并不在消费者最初消费计划中，但是在稀缺性的刺激下，商品的认知价值在消费者心中突然有了大幅提升。其实降价也可以算在稀缺性原理中，因为相对于日常的高位价格，暂时性的降价折扣就显得颇为稀缺，错过了当下，以后可能需要花费更高额度的费用，这种期望落差通常会刺激消费者做出不理性的购买决策。</p>
<p>此外，另一种常见的套路就是有竞争性的稀缺资源，参与竞争稀缺资源的感觉，有着比单纯的稀有资源更为强大的吸引力。渴望拥有一件众人争抢的东西，几乎是出于本能的身体反应。所以在稀缺物品的竞拍中，我们通常能见到类似的现象，通过简单的心理博弈，能够让最终的成交价格朝着卖家预设的价位移动。</p>
<p>## 7.2 逆反心理</p>
<p>稀缺性原理起作用的力量主要来自两个方面。第一点它钻了我们思维捷径上的漏洞。在我们认知中，难以得到的东西，通常会让我们更为珍视。故此，我们基本可以根据获得一样东西的难易程度，迅速、准确地判断它质量，而这种判断在很大程度上是正确的。</p>
<p>第二点在于，机会越来越少的话，我们的自由也会随之丧失。每当有东西获取起来比以前难，我们拥有它的自由受了限制，我们就越发地想要得到它。我们痛恨失去本来拥有的自由，这种保住既得利益的愿望是心里逆反理论的核心。</p>
<p>詹姆斯·戴维斯（James Davies）曾指出，一个国家在经济和社会条件改善后，要是在短期内出现剧烈逆转，最有可能爆发革命。而且最容易企业的，不是那些传统上最受压迫的底层人民，而是品尝过了更美好生活的人。因为该群体得到了以前从来没有的自由，一点有人想要夺走这些自由，就注定要付出一些代价。</p>
<p>在实际生活中逆反心理也比较常见，最为人所熟知的一种现象就是青少年的叛逆期。通过上述阐述，我们知道自由这种东西，给一点又拿走，比完全不给更危险。所以管教前后不一的父母，更容易教出反叛心强的孩子。所以在教育孩子上，家长应该以身作则，给孩子树立良好的榜样，而不是严于律人，宽以待己。</p>
<p>## 7.3 如何拒绝</p>
<p>在知晓我们如何拒绝稀缺原理影响我们决策时，我们应该知道一个道理：喜悦并非来自对稀缺商品的体验，而是来自对它的占有。稀缺的东西并不因为难以占有，就变得更好吃、好听、好看、好用了。所以一旦我们觉得我们在短缺影响下产生了高度的情绪波动，我们就应该把这种波动当成暂停的信号，并在心底询问自己，为什么我们想要那件东西，是为了拥有它，还是为了它的价值或功能。</p>
<p>谈若是因为想拥有它，那么我们应该利用它的稀缺性来判断改为它出多少钱，一旦价格超出该底线，我们应该心生警惕，因为这也许是商家在利用稀缺性原理在谋取的超额收益。如果是为了它的功能，那么我们应该牢记一点：该物品并不会因为稀缺而增强它的功能。换而言之，我们应该积极寻求它的等价替代产品，获取更多信息之后，在做出合理的决策。</p>
<p># 8 总结</p>
<p>作者写本书的目的并不是说，让我们对这些简单而常见的小套路避之不及，而是希望我们能洞悉事物发展背后的逻辑，至少在明事理之后，能让我们有了更多选择的权利，不至于让我们在被“戏耍”后而不自知。尽管只靠孤立数据容易做出愚蠢的决定，可现代生活的节奏又要求我们频繁使用这一捷径。</p>
<p>为了追求效率，有时候我们必须放弃耗时而复杂的全局决策过程，转而使用更简单、由单一特征出发的响应方式。它之所以最为常用，完全是因为它们的可靠性高，在我们人类进化过程中，通常都能指引我们做出正确决定，这也是为什么我们会潜意识里借助这些因素做出顺从决定。在没有意愿、时间、精力或认知资源对情况进行全面分析的时候，使用这些孤立的线索进行决策是简单而保险的决策方式。</p>
<p>正如作者所说一般，这种便捷的响应方式应当受到尊重。在日新月异的当下，技术的进步速度远远快于我们，所以我们处理信息的天然能力将有可能越来越难于应对当代生活中繁多的变化、选择和挑战。有时我们会发现自己陷入了跟低等动物一样的处境中：外界环境的错综复杂超出了我们心智的处理能力。从这个方面来说，我们的大脑潜意识里依赖可靠而合理的捷径和首选规则来应对生活的紧张节奏也是无可厚非的。</p>
<p>然而，我们真正值得警惕的是，那些知晓我们的响应机制，但通过别出心裁的设计来破坏我们的心理机制，或者说通过我们的响应机制来蒙蔽我们，来从我们身上谋取私利的人。虽然大多数时候，这种戏弄不会对我们造成太大的损失，但正如《三国志·蜀书·先主传》所说：“勿以善小而不为，勿以恶小而为之”，积小成多，聚沙成塔，终归会有一天对我们的反应机制产生不可逆的影响。</p>
<p>正如一直以来我对自己的要求：我可以不成为这一领域的专家，但其中的基本原理我得懂，这也是为什么这么多年来，我始终如一地扩充自己的知识面。一方面是因为获取知识的过程能给我带来确实的快感，另一方面则是因为，涉猎各领域的知识能够让我以更多的角度看待事物，不至于让自己的无知中变成一个智慧鹦鹉学舌而不会独立思考的人！</p>
<p>最后附上我最喜欢的一个著名投资家查理·芒格所说的一句话：</p>
<p>&gt; 我这辈子遇到的聪明人（来自各行各业的聪明人）没有不每天阅读的 —— 没有，一个都没有。巴菲特读书之多，我读书之多，可能会让你感到吃惊。孩子们都笑话我，他们觉得我是一本长了两条腿的书。</p>
<p>很多人读书，追求的是干货，寻求的是立刻行之有效的解决方案。其实这是一种留在舒适区的阅读方法。在这个充满不确定的时代，答案不会简单地出现在书里，因为生活根本就没有标准确切的答案，你也不能期望过去的经验能够解决未来的问题。能简单地出现在书中的答案只有试卷，而这也是我不喜欢以考试来鞭策读书的原因之一，只可惜在现今成绩为王的时代，能做的只有在半顺从下坚持自己原则。除此之外，别无他法，可悲！</p>
]]></content>
      <categories>
        <category>Book review</category>
        <category>Influence</category>
        <category>Introduction</category>
      </categories>
      <tags>
        <tag>Book review</tag>
      </tags>
  </entry>
  <entry>
    <title>Latex</title>
    <url>/2021/01/19/Latex/</url>
    <content><![CDATA[<h1 id="recognize-latex">1 Recognize <span class="math inline">\(\LaTeX\)</span></h1>
<p>通过更换文档类型，可以正确显示中文。</p>
<a id="more"></a>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% English environment, can&#x27;t display chinese</span></span><br><span class="line"><span class="keyword">\documentclass</span>&#123;article&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;article&#125;</span><br><span class="line">	This is my first document.</span><br><span class="line"></span><br><span class="line">	Happy <span class="keyword">\TeX</span> ing!</span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>&#123;article&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">%---------------------------</span></span><br><span class="line"><span class="comment">% below is chinese environment</span></span><br><span class="line"><span class="keyword">\documentclass</span>[UTF8]&#123;ctexart&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;document&#125;</span><br><span class="line">	<span class="keyword">\section</span>&#123;文字&#125;</span><br><span class="line">	测试文字。</span><br><span class="line">	<span class="keyword">\section</span>&#123;数学&#125;</span><br><span class="line">	<span class="keyword">\[</span></span><br><span class="line">		a<span class="built_in">^</span>2 + b<span class="built_in">^</span>2 = c<span class="built_in">^</span>2</span><br><span class="line">	<span class="keyword">\]</span></span><br><span class="line"><span class="keyword">\end</span>&#123;document&#125;</span><br></pre></td></tr></table></figure>
<h2 id="从一个例子说起">1.1 从一个例子说起</h2>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="comment">% gougu.tex</span></span><br><span class="line"><span class="comment">% 勾股定理</span></span><br><span class="line"><span class="keyword">\documentclass</span>[UTF8]&#123;ctexart&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\title</span>&#123;杂谈勾股定理&#125;</span><br><span class="line"><span class="keyword">\author</span>&#123;张三&#125;</span><br><span class="line"><span class="keyword">\date</span>&#123;<span class="keyword">\today</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">\bibliographystyle</span>&#123;plain&#125; <span class="comment">% 声明参考文献的格式</span></span><br><span class="line"><span class="comment">% 导言区（preamble），对文档的性质做一些设置，或者自定义一些命令</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;document&#125;</span><br><span class="line">	<span class="keyword">\maketitle</span> <span class="comment">% 输出论文标题</span></span><br><span class="line">	<span class="keyword">\begin</span>&#123;abstract&#125;</span><br><span class="line">		这是一篇关于沟谷定理的小短文。</span><br><span class="line">	<span class="keyword">\end</span>&#123;abstract&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">\tableofcontents</span> <span class="comment">% 输出目录</span></span><br><span class="line">	<span class="keyword">\section</span>&#123;勾股定理在古代&#125;</span><br><span class="line">	西方称勾股定理为<span class="keyword">\emph</span>&#123;毕达哥拉斯定理&#125;，将勾股定理的发现归功于公元前 6 世纪的毕达哥拉斯学派。该学派得到了一个法则，可以求出可排成直角三角形三边的三元数组。毕达哥拉斯学派没有书面著作，该定理的严格表述和证明则见于欧几里德<span class="keyword">\footnote</span>&#123;欧几里得，约公元前 330--275年。&#125;《几何原本》的命题 47：“直角三角形斜边上的正方形等于两直角边上的两个正方形之和。”证明是用面积做的。</span><br><span class="line"></span><br><span class="line">	我国《周髀算经》载商高（约公元前 2 世纪）答周公问⋯⋯</span><br><span class="line"></span><br><span class="line">	<span class="comment">% 引用环境</span></span><br><span class="line">	<span class="keyword">\begin</span>&#123;quote&#125;</span><br><span class="line">		<span class="keyword">\zihao</span>&#123;-5&#125;<span class="keyword">\kaishu</span> 引用的内容 <span class="comment">% 小五号楷书</span></span><br><span class="line">	<span class="keyword">\end</span>&#123;quote&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">\section</span>&#123;勾股定理的近代形式&#125;</span><br><span class="line">	<span class="keyword">\bibliography</span>&#123;math&#125; <span class="comment">% 从文献数据库 math 中获取文献信息，打印文献列表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">\end</span>&#123;document&#125;</span><br></pre></td></tr></table></figure>
<p>整个文章的框架为：</p>
<ul>
<li>前面以百分号 <code>%</code> 开头的行是注释，TeXStudio 中的多行注释快捷键为<code>ctrl</code>+<code>T</code>，取消多行注释快捷键为<code>ctrl</code>+<code>U</code></li>
<li>第 4 行是文档类，中文短文所以使用 ctexart，并用 [UTF8] 说明编码</li>
<li>第 6-8 行声明了整个文章的标题、作者和写作日期，这些信息通过<code>\maketitle</code>出现在排版中</li>
<li><code>\bibliographstyle</code>声明参考文献的格式</li>
</ul>
<p>以上<code>\begin&#123;document&#125;</code>之前的部分为导言区（preamble），导言区用来对文档的性质做一些设置，或自定义一些命令</p>
<ul>
<li><p><code>\begin&#123;document&#125;</code>和<code>\end&#123;document&#125;</code>声明了一个 document 环境，里面是论文的正文部分，也就是直接输出的部分。</p></li>
<li><p><code>\tableofcontents</code>命令输出目录</p></li>
<li><p><code>\bibliography&#123;math&#125;</code>提示 <span class="math inline">\(\TeX\)</span> 从文献数据库 math 中获取文献信息，打印参考文献列表</p></li>
<li><p>为了格式上的清晰，源文件中适当使用了一些空行作为分隔，在正文外的部分，空行不表示任何意义。</p></li>
<li><p>通常汉字后的空格会被忽略，其他符号后面的空格会被保留</p></li>
</ul>
<h2 id="command-and-enviroment">1.2 Command and Enviroment</h2>
<ul>
<li><p><strong>Command</strong></p>
<ul>
<li><code>\footnote</code>：脚注</li>
<li><code>\emph&#123;Text&#125;</code>：强调</li>
<li><code>\zihao&#123;number&#125;</code>：字号</li>
<li><code>\qquad</code>：产生<code>2 em</code>（大约 2 个 ’M‘ 的宽度）的空白</li>
</ul></li>
<li><p><strong>Environment</strong></p>
<p>格式为</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;envi name&#125;</span><br><span class="line">	&lt; content &gt;</span><br><span class="line"><span class="keyword">\end</span>&#123;envi name&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>quote</code>：引用环境</li>
<li><code>abstract</code>：摘要环境</li>
<li><code>euqation</code>：公式环境</li>
</ul>
<p>特殊环境</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\newtheorem</span>&#123;thm&#125;&#123;定理&#125;</span><br><span class="line"><span class="keyword">\begin</span>&#123;thm&#125;[勾股定理]</span><br><span class="line">	直角三角形斜边的平方等于两腰的平方和。</span><br><span class="line"></span><br><span class="line">	可以用符号语言表述为……</span><br><span class="line"><span class="keyword">\end</span>&#123;thm&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="graph">1.3 graph</h2>
<p><code>\includegraphics[width]&#123;pic_dir&#125;</code>：插图</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;center&#125;</span><br><span class="line">	<span class="comment">% Requires \usepackage&#123;graphicx&#125;</span></span><br><span class="line">	<span class="keyword">\includegraphics</span>[width=0.9<span class="keyword">\textwidth</span>]&#123;pic<span class="built_in">_</span>dir&#125;</span><br><span class="line">	<span class="comment">% Requires \usepackage&#123;caption&#125;</span></span><br><span class="line">	<span class="keyword">\captionsetup</span>&#123;font=small&#125;</span><br><span class="line">	<span class="keyword">\captionsetup</span>&#123;labelsep=quad&#125;</span><br><span class="line">	<span class="keyword">\captionof</span>&#123;figure&#125;&#123;WTI crude oil price&#125;</span><br><span class="line">	<span class="keyword">\label</span>&#123;fig:WTI&#125;</span><br><span class="line"><span class="keyword">\end</span>&#123;center&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">% 可选参数 ht，表明浮动体可以出现在周围文本所在处（here）或一页顶部（top）</span></span><br><span class="line"><span class="keyword">\begin</span>&#123;figure&#125;[ht]</span><br><span class="line">	<span class="keyword">\centering</span></span><br><span class="line">	<span class="keyword">\includegraphics</span>[width=0.9<span class="keyword">\textwidth</span>]&#123;pic<span class="built_in">_</span>dir&#125;</span><br><span class="line">	<span class="keyword">\captionsetup</span>&#123;font=small&#125;</span><br><span class="line">	<span class="keyword">\captionsetup</span>&#123;labelsep=quad&#125;</span><br><span class="line">	<span class="keyword">\captionof</span>&#123;figure&#125;&#123;WTI crude oil price&#125;</span><br><span class="line">	<span class="keyword">\label</span>&#123;fig:WTI&#125; <span class="comment">% 给图形定义标签，使用这个标签可以再文章其他地方引用</span></span><br><span class="line"><span class="keyword">\end</span>&#123;figure&#125;</span><br></pre></td></tr></table></figure>
<p>插入的图形就是一个有内容的矩形盒子，在正文中和一个很大的字符没有区别。除了一些很小的标志图形，一般很少把插图直接夹在文字之中，而是使用可以变动相对位置的环境列出，称为浮动体（float）</p>
<h2 id="table">1.4 Table</h2>
<p>表格与<code>\includegraphics</code>命令得到的插图一样，都是比较大的盒子。一般也放在浮动环境<code>table</code>中</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% 参数 H 表示 ‘就放在这里，不浮动’，需要 \usepackage&#123;float&#125;</span></span><br><span class="line">下表列出了一些较小的勾股数：</span><br><span class="line"><span class="keyword">\begin</span>&#123;table&#125;[h]</span><br><span class="line">	<span class="keyword">\centering</span></span><br><span class="line">	<span class="keyword">\begin</span>&#123;tabular&#125;&#123;|c|c|c|&#125;</span><br><span class="line">		<span class="keyword">\hline</span></span><br><span class="line">		直角边 <span class="built_in">$</span>a<span class="built_in">$</span> <span class="built_in">&amp;</span> 直角边 <span class="built_in">$</span>b<span class="built_in">$</span> <span class="built_in">&amp;</span> 斜边 <span class="built_in">$</span>c<span class="built_in">$</span> <span class="keyword">\\</span></span><br><span class="line">		<span class="keyword">\hline</span></span><br><span class="line">		3 <span class="built_in">&amp;</span> 		4 <span class="built_in">&amp;</span>		5 <span class="keyword">\\</span></span><br><span class="line">		5 <span class="built_in">&amp;</span>		 	12 <span class="built_in">&amp;</span>	13 <span class="keyword">\\</span></span><br><span class="line">		<span class="keyword">\hline</span>			</span><br><span class="line">    <span class="keyword">\end</span>&#123;tabular&#125;</span><br><span class="line"><span class="keyword">\end</span>&#123;table&#125;</span><br></pre></td></tr></table></figure>
<p><code>tabular</code>环境有一个参数，里面声明了表格中列的模式：</p>
<ul>
<li><code>|c|c|c|</code>：三列，居中对其，不同列数据用表格线隔开</li>
<li><code>\\</code>：表格换行，内部不同数据单元用<code>&amp;</code>分隔</li>
<li><code>\hline</code>：横向表格线</li>
</ul>
<p>上表和正文是直接连在一起，不允许浮动，这里本来不应该使用浮动<code>table</code>环境的，但仍然使用了<code>table</code>环境，在表示位置的参数处使用了<code>[H]</code>，表示 “就放在这里，不浮动”，该参数是 <code>float</code>宏包提供的功能，需要在导言区使用<code>\usepackage&#123;float&#125;</code>。</p>
<h2 id="bibliography">1.5 Bibliography</h2>
<p>BibTeX 是专用于处理 $ $ 文档文献列表的程序，此时编译<code>test.tex</code>文档时运行程序四次：</p>
<ul>
<li>xelatex test.tex</li>
<li>bibtex test.tex</li>
<li>xelatex test.tex</li>
<li>xelatex test.tex</li>
</ul>
<p>正文中通过用命令<code>\cite&#123;label&#125;</code>引用文献，使用<code>\cite</code>命令会在引用的位置显示文献在列表中的编号，同时在辅助文件中说明文献将被引用。</p>
<p>如果要在列表中显示并不直接引用的文献，可以使用<code>\nocite</code>命令，一般是放在<code>\bibliography&#123;name&#125;</code>之前</p>
<p><strong>引用不仅局限于文献，图表、、公式的编号，只要事先设定了 label，同样可以通过<code>\ref</code>进行引用。实际中引用公式非常常用，数学宏包 <code>amsmath</code>就定义了<code>\eqref</code>命令，专用于公式的引用，并能产生括号。</strong></p>
<h2 id="设计文章格式">1.6 设计文章格式</h2>
<ul>
<li>设计页面尺寸可以使用<code>geometry</code>宏包</li>
</ul>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\usepackage</span>&#123;geometry&#125;</span><br><span class="line"><span class="keyword">\geometry</span>&#123;a6paper,centering,scale=0.8&#125;</span><br><span class="line"><span class="comment">% 定义页面为 A6 纸大小，版心居中，长宽占页面的 0.8 倍</span></span><br></pre></td></tr></table></figure>
<ul>
<li>改变图表标题格式可以使用 <code>caption</code>宏包</li>
</ul>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\usepackage</span>[format=hang,font=small.textfont=it]&#123;caption&#125;</span><br><span class="line"><span class="comment">% 设定图表标题使用悬挂式对齐方式（即编号向左突出），整体用小字号，而标题文本使用斜体（对汉字来说是楷书）</span></span><br></pre></td></tr></table></figure>
<ul>
<li>增加目录的项目可以用 <code>tocbibind</code>宏包</li>
</ul>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\usepackage</span>[nottoc]&#123;tocbibind&#125;</span><br><span class="line"><span class="comment">% 默认会在目录中加入目录项本身、参考文献、索引等项目，使用 nottoc 选项取消了在目录中显示本身</span></span><br></pre></td></tr></table></figure>
<ul>
<li>标题和作者的字体更改：</li>
</ul>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\title</span>&#123;<span class="keyword">\heiti</span> 杂谈勾股定理&#125; <span class="comment">% 黑体</span></span><br><span class="line"><span class="keyword">\author</span>&#123;<span class="keyword">\kaishu</span> 张三&#125; <span class="comment">% 楷书</span></span><br><span class="line"><span class="keyword">\date</span>&#123;<span class="keyword">\today</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 <code>quote</code>环境字体</li>
</ul>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\newenviroment</span>&#123;myquote&#125;</span><br><span class="line">&#123;<span class="keyword">\begin</span>&#123;quote&#125;<span class="keyword">\kaishu</span><span class="keyword">\zihao</span>&#123;-5&#125;&#125;</span><br><span class="line">&#123;<span class="keyword">\end</span>&#123;quote&#125;&#125;</span><br><span class="line"><span class="comment">% myquote 包含三个参数，第一个为环境名名字，后两个分别是在环境开始和末尾处的代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">\newcommand</span><span class="keyword">\degree</span>&#123;<span class="built_in">^</span><span class="keyword">\circ</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>取消连字（ligature）</p>
<p><span class="math inline">\(\LaTeX\)</span> 在排版中会将单词中的一些字母连写为一个字符，连字的有无和多少一般由使用的字体决定，偶尔出于美观的考虑，需要取消连字，可以用空的分组，或借用<code>\/</code>命令：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">shelfful shelf&#123;&#125;ful shelf<span class="keyword">\/</span>ful</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="organize-article">2 Organize article</h1>
<h2 id="标点">2.1 标点</h2>
<ul>
<li><p>引号 `<code></code> 和 <code>'</code></p>
<p>引号在 <span class="math inline">\(\LaTeX\)</span> 中使用 `<code></code> （左引号）或 <code>'</code>（右引号 表示，如果遇到单引号和双引号连续出现的情况，则在中间用<code>\</code> ,命令分开：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">``<span class="keyword">\,</span>`a&#x27; and `b&#x27;<span class="keyword">\,</span>&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p><code>\</code>, 命令会产生很小的间隔</p></li>
<li><p>减号<code>-</code></p>
<p><code>-</code> 在 <span class="math inline">\(\LaTeX\)</span> 正文中有多种用途</p>
<ul>
<li><p><code>-</code>：连字符（hyphen）</p></li>
<li><p><code>--</code>： en dash，用来表示数字范围，但按照中文的协作习惯，表示数字范围也常用符号：<span class="math inline">\(\sim\)</span></p></li>
<li><p><code>---</code>：em dash，即破折号</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">n inter-word dash or, hyphen, as in X-ray.</span><br><span class="line">  </span><br><span class="line">An medium dash for number range, like 1--2.</span><br><span class="line">  </span><br><span class="line">A punctuation dash---like this.</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>省略号<code>\ldots</code>和<code>\dots</code></p>
<p>西文的省略号（ellipsis）使用<code>\ldots</code>和<code>\dots</code>命令产生，相比直接输入三个句号，它所拉开的间距要合理的的：</p>
<p>Good: One, twe, three<span class="math inline">\(\dots\)</span></p>
<p>Bad: One, two, three...</p>
<p>西文的省略号在句中时，前后都需要加空格，而在句末时应该使用 4 个点。由于<code>\ldots</code>本身的后面也有间距，通常将其放入数学模式中，避免前后间距不一</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">She <span class="built_in">$</span><span class="keyword">\ldots</span><span class="built_in">$</span> she got it</span><br><span class="line">I&#x27;ve no idea <span class="keyword">\ldots</span></span><br></pre></td></tr></table></figure></li>
<li><p>不能直接录入的标点符号：</p>
<p>~, #, $, %, ^, &amp;, {, }, _, , x</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\#</span> <span class="keyword">\quad</span> <span class="keyword">\$</span> <span class="keyword">\quad</span> <span class="keyword">\%</span> <span class="keyword">\quad</span> <span class="keyword">\&amp;</span> <span class="keyword">\quad</span> <span class="keyword">\&#123;</span> <span class="keyword">\quad</span> <span class="keyword">\&#125;</span> <span class="keyword">\quad</span> <span class="keyword">\_</span> <span class="keyword">\quad</span> <span class="keyword">\textbackslash</span> <span class="keyword">\times</span></span><br></pre></td></tr></table></figure>
<p>可以使用没有字母的重音<code>\~&#123;&#125;</code>和<code>\^&#123;&#125;</code>输出<code>~</code>和<code>^</code>，但着连个符号一般不直接出现在普通正文中</p></li>
<li><p>标点格式</p>
<p><span class="math inline">\(\LaTeX\)</span> 并不会自动处理号汉字标点的宽度和间距，甚至不能保证标点的禁则（如娟红不允许出现在一行的开始）。</p>
<p>中文标点一般由<code>xeCJK</code>宏包控制，其提供了多种标点格式，默认时全角式，即所有标点占一个汉字宽度，只在行末和个别标点之间进行挤压。</p>
<p>还支持其他一些标点格式，可以使用<code>\punctstyle</code>命令修改：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\punctstyle</span>&#123;quanjiao&#125; 全角式，所有标点全角，有挤压。例如，“标点挤压”。又如《标点符号用法》。</span><br><span class="line"></span><br><span class="line"><span class="keyword">\punctstyle</span>&#123;banjiao&#125; 半角式，所有标点半角，有挤压。例如，“标点挤压”。又如《标点符号用法》。</span><br><span class="line"></span><br><span class="line"><span class="keyword">\punctstyle</span>&#123;kaiming&#125; 开明式，部分的标点半角，有挤压。例如，“标点挤压”。又如《标点符号用法》。</span><br><span class="line"></span><br><span class="line"><span class="keyword">\punctstyle</span>&#123;hangmobanjiao&#125; 行末半角式，仅行末挤压。例如，“标点挤压”。又如《标点符号用法》。</span><br><span class="line"></span><br><span class="line"><span class="keyword">\punctstyle</span>&#123;plain&#125; 无格式，只有禁则，无挤压。例如，“标点挤压”。又如《标点符号用法》。</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="空格和换行">2.2 空格和换行</h2>
<p>文本中的空格起分割单词的作用，任意多个空格与一个空格的功能相同；只有字符后面的空格式有效的，每行最前面的空格则会被忽略，这样有利于复杂代码的对其，单个换行也被视作一个空格。</p>
<ul>
<li><p>带空格的宏</p>
<p>以字母命名的宏，后面空格会被忽略。如果要在命令后面使用空格，可以在空格前加<code>\</code></p></li>
<li><p>带子<code>~</code></p>
<p>有一种不可打断的空格，在 <span class="math inline">\(\TeX\)</span> 中被称为带子（tties），用<code>~</code>表示。<span class="math inline">\(\TeX\)</span> 禁止在这种空格之间分行，因而可以用来表示一些不宜分开的情况</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">Question~1 <span class="comment">%名称与编号之间</span></span><br><span class="line">Donald~E. Knuth <span class="comment">% 教名之间，但姓可以断行</span></span><br><span class="line">Mr. Knuth <span class="comment">% 称谓缩写与名字间</span></span><br><span class="line">function~<span class="built_in">$</span>f(x)<span class="built_in">$</span> <span class="comment">% 名字后的短公式</span></span><br><span class="line">1，~2， and ~3 <span class="comment">% 序列的部分符号间</span></span><br></pre></td></tr></table></figure></li>
<li><p>幻影（phantom）</p>
<p><code>\phantom</code>有一个参数，作用是产生于参数内容一样大小的空盒子，没有内容，就像是参数的一个幻影一样，用来完成一些特殊的展位和对齐效果。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">幻影<span class="keyword">\phantom</span>&#123;参数&#125;快速隐形</span><br><span class="line">幻影参数快速隐形</span><br></pre></td></tr></table></figure>
<p>类似的还有<code>\hphantom</code>和<code>\vphantom</code>，分别表示水平方向和垂直方向的幻影（另一个方向大小为零）</p></li>
<li><p>分段</p>
<p>通常用两个换行表示分段，段与段之间会自动得到何使的缩进。</p>
<p>分段也可以用<code>\par</code>命令生成，这种用法一般只在命令或环境定义的内部使用，普通正文中不宜出现。</p>
<p>另起一行不分段：</p>
<ul>
<li><p><code>\\</code>命令直接另起一行，上一行保持原来的样子；该命令可以带一个可选的长度参数，表示换行后增加的额外垂直间距，如<code>\\[2cm]</code>。如果<code>\\</code>后面需要使用方括号，则应加空的分组以示分隔。</p></li>
<li><p><code>\linebreak</code>指定一行的断点，上一行仍按完整一行分散对齐。可以带一个 0-4 的可选参数，表述允许断行的程度：0 表示允许断行，默认的 4 表示必须断行；类似的，也有一个<code>\nolinebreak</code>命令，参数意义与<code>\linebreak</code>相反。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">这是一行文字<span class="keyword">\\</span> 另一行</span><br><span class="line">  </span><br><span class="line">这是一行文字<span class="keyword">\\</span>&#123;&#125;[] 另一行</span><br><span class="line">  </span><br><span class="line">这是一行文字<span class="keyword">\\</span>[1em] 另一行</span><br><span class="line">  </span><br><span class="line">这是一行文字<span class="keyword">\linebreak</span> 另一行</span><br><span class="line">这是一行文字<span class="keyword">\linebreak</span>[4] 另一行</span><br></pre></td></tr></table></figure>
<p><code>\\</code>一般用在特殊环境中，如排版诗歌的<code>verse</code>环境，特别是在对齐、表格和数学公式中使用广泛，很少出现在普通正文中。</p></li>
</ul></li>
<li><p>西文句末</p>
<p>西文的标点后面都会加空格，这可以保证正确的间隔，也能保证正确的换行。</p>
<p><span class="math inline">\(\LaTeX\)</span> 在西文句末（包括句号、问好和感叹号）后面使用的距离比单词间的距离大些。<span class="math inline">\(\LaTeX\)</span> 默认把大写字母后的点看作缩写标记，把小写字母后的点看作式句子结束，并对它们使用不同的间距。</p>
<p>偶尔也会有大写字母结束的句子，或小写字母的缩写，这是必须明确告诉 <span class="math inline">\(\LaTeX\)</span> 使用普通单词间的空格（空格前加<code>\</code>），或使用<code>\@.</code>指明式大写字母后的句末。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">A sentence, And anotehr.</span><br><span class="line">U.S.A. means United States Army?</span><br><span class="line">Tinker et al.<span class="keyword">\ </span>mad the double play.</span><br><span class="line">Roman number XII<span class="keyword">\@</span>. Yes.</span><br></pre></td></tr></table></figure>
<ul>
<li>有时也需要整体<strong>禁止</strong>这种标点后的不同间距，<strong>法语排版</strong>的习惯就是如此，此时可以使用<code>\frenchspacing</code>命令来禁止标点后的额外间距。</li>
</ul></li>
<li><p>中英文混排</p>
<p>汉字后的空格会被忽略，使用<code>xelatex</code>编译中文文档时，汉字和其他内容之间如果没有空格，<code>xeCJK</code>宏包会自动添加。个别时候需要忽略汉字和其他内容之间由<code>xeCJK</code>产生的空格，这是可以把汉字放进一个盒子里：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\mbox</span>&#123;条目&#125;-a 不同于条目-b</span><br></pre></td></tr></table></figure>
<p>有时需要完全禁用汉字和其他内容之间的空格，这是可以使用<code>CJKsetecglue</code>手工设置汉字与其他内容之间的内容为空（默认为一个空格）。</p></li>
</ul>
<h2 id="字体">2.3 字体</h2>
<ul>
<li><p>更改字体</p>
<p><span class="math inline">\(\LaTeX\)</span>提供了带参数和命令、字体声明两种修改字体的命令，前者用于少量字体的更换，后者用于分组或环境中字体的整体更换。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\textit</span>&#123;Italic font test&#125; <span class="comment">% 少量字体的更换</span></span><br><span class="line">&#123;<span class="keyword">\bfseries</span> Bond font test&#125; <span class="comment">% 分组或环境中字体的整体更换</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczRJS.md.png" /></p>
<p><span class="math inline">\(\LaTeX\)</span> 预定义命令中的字体信息如下：</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczcIf.png" /></p>
<center>
<p>fig. 4-1 预定义命令中的字体信息</p>
</center>
<p><img src="https://s3.ax1x.com/2021/01/19/scz6dP.md.png" /></p>
<center>
<p>fig. 4-2 字体坐标：族、形状和系列</p>
</center></li>
<li><p>字体恢复默认</p>
<p>除了上面列举的字体命令，还有<code>\textnormal&#123;&lt;text&gt;&#125;</code>和<code>\normalfont</code>命令，用来将字体设置为 ”普通“的格式，默认为<code>\rmfamily \mdseries \upshape</code>。</p>
<p>普通字体适用于复杂的字体环境中恢复普通的字体，尤其是在宏定义这类不知道外部字体设置的情况下，如：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">&#123;<span class="keyword">\sffamily</span><span class="keyword">\textbf</span>&#123;This is a paragraph of bold and <span class="keyword">\textit</span>&#123;italic font, sometimes returning to <span class="keyword">\textnormal</span>&#123;normal font&#125; is necessary.&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczrqI.md.png" /></p></li>
<li><p>斜体倾斜校正</p>
<p>使用斜体声明<code>\itshape</code>、<code>slshape</code>时，最后一个倾斜的字母会超出边界，使得后面的文字与它相距过紧，而使用带参数的命令<code>\textit</code>、<code>\textsl</code>可以自动修正距离，也可以手工使用<code>\/</code>命令进行这种倾斜校正（italic correction），会在字母后面加上一个小的距离，如：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">&#123;<span class="keyword">\itshape</span> M&#125;M</span><br><span class="line"><span class="keyword">\textit</span>&#123;M&#125;M</span><br><span class="line">&#123;<span class="keyword">\itshape</span> M<span class="keyword">\/</span>&#125;M</span><br><span class="line"><span class="keyword">\textit</span>&#123;M<span class="keyword">\nocorr</span>&#125;M <span class="comment">% 取消倾斜校正</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczWRg.md.png" /></p>
<p>很少情况下，<code>\textit</code>自动加入的倾斜校正时不必要的，此时可以使用<code>\nocorr</code>命令禁止校正。</p></li>
<li><p>中文字体</p>
<p>中文字体通常没有西文字体那样复杂的成套的 变体，各个字体之间一般都是独立的。对于中文字体，一般只使用不同的字体族进行区分。<code>xeCJK</code> 和 <code>CJK</code>宏包机制下， 中文字体的选择命令和西文字体是份力的，选择中文字体用<code>\CJKfamily</code>命令，如：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">&#123;<span class="keyword">\CJKfamily</span>&#123;zhehei&#125;这是黑体&#125;</span><br><span class="line">&#123;<span class="keyword">\CJKfamily</span>&#123;zhkai&#125;这是楷书&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>ctex</code>宏包及文档类下有一些预定义，在默认情况下（winfonts 选项）针对 Windows 常用字体配置了的四种字体族：zhsong（宋体）、zhhei（黑体）、zhkai（楷书）、zhfs（仿宋）。为了方便使用，<code>ctex</code>提供了简化的命令：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">&#123;<span class="keyword">\songti</span> 宋体&#125; <span class="keyword">\quad</span> &#123;<span class="keyword">\heiti</span> 黑体&#125; <span class="keyword">\quad</span> &#123;<span class="keyword">\fangsong</span> 仿宋&#125; <span class="keyword">\quad</span> &#123;<span class="keyword">\kaishu</span> 楷书&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>组合字体</p>
<p><code>ctex</code>宏包及文档类（如<code>ctexart</code>）另外定义了一些组合字体，可以让中文也具备使用粗体（<code>\bfsereies</code>）和意大利体（<code>\itshape</code>）的功能。默认中文字体族为 rm，其<strong>正常字体是宋体，粗体是黑体，意大利体是楷体</strong>。</p>
<p>类似的，<code>\sffamily</code>（对应 sf 中文字体族）和<code>\ttfamily</code>（对应 tt 中文字体族）也可以同时用作西文和中文，分别相当于<strong>幼圆和仿宋体</strong>。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">&#123;<span class="keyword">\rmfamily</span> <span class="keyword">\textbackslash</span> rmfamily 中文字体族下，正常字体是宋体，其<span class="keyword">\textbf</span>&#123;粗体&#125;与<span class="keyword">\textit</span>&#123;斜体&#125;。&#125; 				</span><br><span class="line">&#123;<span class="keyword">\sffamily</span> <span class="keyword">\textbackslash</span> sffamily  中文字体族下，正常字体是幼圆，其<span class="keyword">\textbf</span>&#123;粗体&#125;与<span class="keyword">\textit</span>&#123;斜体&#125;。&#125;			</span><br><span class="line">&#123;<span class="keyword">\ttfamily</span> <span class="keyword">\textbackslash</span> ttfamily 中文字体族下，正常字体是宋体，其<span class="keyword">\textbf</span>&#123;粗体&#125;与<span class="keyword">\textit</span>&#123;斜体&#125;。&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2021/01/19/scz4Mj.md.png" /></p></li>
<li><p>修改默认字体</p>
<p>通过fontspec 宏包的机制来调用字体，最基本的是设置正文罗马字体族、无衬线体字族和打字机字体族的命令：</p>
<p>​ <code>\setmainfont[&lt;可选选项&gt;]\&#123;&lt;字体名&gt;\&#125;</code></p>
<p>​ <code>\setsansfont[&lt;可选选项&gt;]\&#123;&lt;字体名&gt;\&#125;</code></p>
<p>​ <code>\setmnonofont[&lt;可选选项&gt;]\&#123;&lt;字体名&gt;\&#125;</code></p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% 设置全文字体为 Windows 提供的 Timees New Roman, Verdana, Courier New 字体</span></span><br><span class="line"><span class="keyword">\usepackage</span>&#123;fontspec&#125;</span><br><span class="line"><span class="keyword">\setmainfont</span>&#123;Times New Roman&#125;</span><br><span class="line"><span class="keyword">\setsansfont</span>&#123;Verdana&#125;</span><br><span class="line"><span class="keyword">\setmonofont</span>&#123;Courier New&#125;</span><br></pre></td></tr></table></figure>
<p>此时 <code>\rmfamily</code>，<code>\sffamily</code>，<code>\ttfamily</code> 就分别对应设置的三种字体，而且 <code>fontspec</code>宏包会自动找到并匹配对应的粗体、斜体等编题，尽量使 <code>\bfseries</code>， <code>\itshap</code>等命令也有效。</p>
<p>除此之外，还可以定义新的字体族命令：</p>
<p>​ <code>\newfontfamily&lt;命令&gt;[&lt;可选选项&gt;]&#123;&lt;字体命&gt;&#125;</code></p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% preamble</span></span><br><span class="line"><span class="keyword">\newfontfamily</span><span class="keyword">\lucidasans</span>&#123;Lucida Sans&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">% 正文</span></span><br><span class="line">&#123;<span class="keyword">\lucidasans</span> This is Lucida Sans.&#125;</span><br></pre></td></tr></table></figure>
<p><code>xeCJK</code>宏包（<code>ctex</code>宏包或文档类会自动调用）提供了与<code>fontspec</code>对应的中文字体设置命令</p>
<p>​ <code>\setCJKmainfont[&lt;可选选项&gt;]\&#123;&lt;字体名&gt;\&#125;</code></p>
<p>​ <code>\setCJKsansfont[&lt;可选选项&gt;]\&#123;&lt;字体名&gt;\&#125;</code></p>
<p>​ <code>\setCJKmonofont[&lt;可选选项&gt;]\&#123;&lt;字体名&gt;\&#125;</code></p>
<p>​ <code>\setCJKfamilyfont[&lt;可选选项&gt;]\&#123;&lt;字体名&gt;\&#125;</code></p></li>
</ul></li>
</ul>
<h2 id="强调文字">2.4 强调文字</h2>
<ul>
<li><p><code>\emph&#123;&#125;</code> and <code>\em</code></p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;itemize&#125;</span><br><span class="line">	<span class="keyword">\item</span> 命令形式：</span><br><span class="line">		You <span class="keyword">\emph</span>&#123;should&#125; use fonts carefully.</span><br><span class="line">		<span class="comment">% 常使用意大利体表示夹在正文中的强调句					</span></span><br><span class="line">		<span class="keyword">\textit</span>&#123;You <span class="keyword">\emph</span>&#123;should&#125; use fonts carefully.&#125;</span><br><span class="line">		<span class="comment">% 常使用正文夹在意大利体中表示强调</span></span><br><span class="line">	<span class="keyword">\item</span> 声明形式：</span><br><span class="line">		This is &#123;<span class="keyword">\em</span> emphasized<span class="keyword">\/</span>&#125; text</span><br><span class="line">		<span class="comment">% \/ 为斜度校正</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczfzQ.md.png" /></p></li>
<li><p>重新定义<code>\Emph</code>命令</p>
<p>有时仍然使用大写、小型大写或粗体进行更醒目的强调，此时可以定义一个新的<code>\Emph</code>命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\newcommand\Emph&#123;\textbf&#125; % bold</span><br><span class="line">This is \Emph&#123;emphasized&#125; text.</span><br></pre></td></tr></table></figure>
<p>Result:<img src="https://s3.ax1x.com/2021/01/19/sczILn.md.png" /></p></li>
<li><p><code>\underline</code></p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\underline</span>&#123;Emphasized&#125; text and <span class="keyword">\underline</span>&#123;another&#125;.</span><br></pre></td></tr></table></figure>
<p>Result: <img src="https://s3.ax1x.com/2021/01/19/scz5ss.md.png" /></p>
<p><code>\underline</code>的一个很大确定是下划线部分不能换行，并且下划线与文字的距离参差不齐。</p></li>
<li><p><code>\uline</code></p>
<p><code>\ulem</code>宏包的<code>\uline</code>命令解决了上述<code>\underline</code>的命令，并把默认的<code>\emph</code>命令也改为使用下划线方式（texlive 2018）中并未修改），如果不希望用下划线线替代标准的<code>\emph</code>命令，可以给<code>\ulem</code>宏包加<code>normalem</code>参数，或使用<code>\normalem</code>和<code>\ULforem</code>命令切换两种强调</p>
<p>除了下划线，<code>ulem</code>宏包也提供了其他修饰文字的命令：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\uuline</span>&#123;urgent&#125; <span class="keyword">\qquad</span> <span class="keyword">\uwave</span>&#123;boat&#125; <span class="keyword">\qquad</span>&#125; <span class="keyword">\sout</span>&#123;wrong&#125; <span class="keyword">\qquaad</span> <span class="keyword">\xout</span>&#123;removed&#125; <span class="keyword">\qquad</span> <span class="keyword">\dashuline</span>&#123;dashing&#125; <span class="keyword">\qquda</span> <span class="keyword">\dotuline</span>&#123;dotty&#125;</span><br></pre></td></tr></table></figure>
<p>Result:<img src="https://s3.ax1x.com/2021/01/19/sczTZq.md.png" /></p>
<p><code>CJKfntef</code>宏包对汉字也提供了类似的功能，同时进行了一些扩充：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\CJKunderdot</span>&#123;汉字，下点线&#125; <span class="keyword">\phantom</span>&#123;汉字下点线&#125; <span class="keyword">\CJKunderline</span>&#123;汉字，单下划线&#125; <span class="keyword">\phantom</span>&#123;字下点线&#125; <span class="keyword">\CJKunderdblline</span>&#123;汉字，双下划线&#125; <span class="keyword">\\</span></span><br><span class="line"><span class="keyword">\CJKunderwave</span>&#123;汉字，下划波浪线&#125; <span class="keyword">\phantom</span>&#123;下点线&#125; <span class="keyword">\CJKsout</span>&#123;汉字，删除线&#125; <span class="keyword">\phantom</span>&#123;爱好下点线&#125; <span class="keyword">\CJKxout</span>&#123;汉字，斜删除线&#125;</span><br></pre></td></tr></table></figure>
<p>Result:<img src="https://s3.ax1x.com/2021/01/19/sczHoV.md.png" /></p>
<p>此外，<code>CJKfntef</code> 宏包，还提供了 <code>CJKfilltwosides</code> 环境，让汉字分散对齐：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;CJKfilltwosides&#125;&#123;5cm&#125;</span><br><span class="line">	汉字，分散对齐</span><br><span class="line"><span class="keyword">\end</span>&#123;CJKfilltwosides&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>ctex</code>宏包及文档中，可以使用<code>\CTEXunderline</code>等以<code>\CTEX</code>开头的命令代替以 <code>\CJK</code>命令开头的命令：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\CTEXunderdot</span>&#123;汉字，加点&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="字号">2.5 字号</h2>
<ul>
<li><p>西文字体大小</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczqiT.md.png" /></p>
<center>
<p>fig. 4-3 预定义的西文字体调整命令</p>
</center></li>
<li><p>中文字体大小</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sgpQBR.png" alt="image-20200817162304003" style="zoom:67%;" /></p>
<center>
<p>fig. 4-4 预定义中文字号</p>
</center>
<p>字号命令表示的具体尺寸随所使用的文档类和大小选项不同而不同。在标准 $$ 文档类 aritcle，report 和 book 中，可以设置文档类选项 10pt，11pt 和 12pt，全局地设置文档内的字号，默认为10pt，即<code>\normalsize</code>的大小为 10pt。</p></li>
<li><p>不同文档类选项下的字号命令</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczLJU.md.png" /></p>
<center>
<p>fig.4-5 不同文档类选项下的字号</p>
</center></li>
</ul>
<h2 id="水平间距">2.6 水平间距</h2>
<ul>
<li><p>水平间距</p>
<p><span class="math inline">\(\LaTeX\)</span> 中的长度有如下几种：</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczXz4.md.png" /></p>
<center>
<p>fig. 4-6 水平间距</p>
</center>
<p><img src="https://s3.ax1x.com/2021/01/19/scz2i8.md.jpg" /></p>
<center>
<p>fig. 4-7 水平间距</p>
</center>
<p>使用水平间距的命令要注意适用，如 <code>\,</code>是不可断行的，因而就不适用于分隔很长的内容，单用来代替逗号给长数字分段就很合适：1,234,567,890。</p>
<ul>
<li>负距离</li>
</ul>
<p>负距离<code>\negthinspace</code>则可以用来细调符号距离或拼接两个符号。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\dag</span><span class="keyword">\negthinspace</span><span class="keyword">\dag</span> versus <span class="keyword">\dag</span><span class="keyword">\dag</span></span><br></pre></td></tr></table></figure>
<p>此外，还可以使用<code>\hspace&#123;距离&#125;</code>命令来产生指定的水平间距，该命令产生的距离是<strong>可断行</strong>的。</p>
<p>Space 1,cm</p>
<p>Result: <img src="https://s3.ax1x.com/2021/01/19/scz7d0.md.png" /></p>
<ul>
<li>强制段首空格</li>
</ul>
<p><code>\hspace</code>的作用是分隔左右的内容，在某些只有一边内容的地方（如强制断行的行首），<span class="math inline">\(\LaTeX\)</span> 会忽略产生的距离，此时可以用带星号的命令 <code>\hspace* &#123;distance&#125;</code>阻止命令被忽略。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">Space<span class="keyword">\linebreak</span> <span class="keyword">\hspace</span>&#123;1cm&#125; 1<span class="keyword">\,</span>cm</span><br><span class="line"></span><br><span class="line">Space<span class="keyword">\linebreak</span> <span class="keyword">\hspace</span>*&#123;1cm&#125; 1<span class="keyword">\,</span>cm</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczvQJ.md.png" /></p></li>
<li><p>橡皮长度</p>
<p><code>\hspace</code>可以产生随内容可伸缩的长度，即橡皮长度，这样才能保证在分行行末的对齐，语法为：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">&lt;normal legnth&gt;plus&lt;可伸长长度&gt;minus&lt;可缩短长度&gt;</span><br></pre></td></tr></table></figure>
<p>有一种特殊的橡皮长度<code>\fill</code>，<code>\fill</code>可以从零开始无限延伸，此时橡皮长度就真的像一个弹簧，可以用来把几个内容均匀排列在一行之中：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">left <span class="keyword">\hspace</span>&#123;<span class="keyword">\fill</span>&#125; middle <span class="keyword">\hfill</span> left</span><br><span class="line">left <span class="keyword">\hspace</span>&#123;<span class="keyword">\fill</span>&#125; middle <span class="keyword">\dotfill</span> left</span><br><span class="line">left <span class="keyword">\hspace</span>&#123;<span class="keyword">\fill</span>&#125; middle <span class="keyword">\hrulefill</span> left</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczzLR.md.png" /></p>
<p><code>\hfill</code>是命令<code>\hspace\&#123;fill&#125;</code>的简写，还可以用<code>\stretcg&#123;&lt;times&gt;&#125;</code>产生具有指定“弹力”的橡皮长度，如<code>\stretch&#123;2&#125;</code>相当于两倍的<code>\fill</code>。<code>\hrulefill</code>和 <code>\dotfill</code> 与 <code>\hfill</code>功能类似，只是中间填充内容不一样（横线和点线）.</p></li>
<li><p>自定义长度变量<code>setlength</code></p>
<p><span class="math inline">\(\LaTeX\)</span> 预定义了一些长度变量控制排版的参数，可以通过<code>\setlength</code> 命令来设置，如段首缩进：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">%导言处</span></span><br><span class="line"><span class="keyword">\seglegth</span> <span class="keyword">\parindent</span><span class="keyword">\&#123;</span>8em<span class="keyword">\&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>长度累加<code>addtolength</code></p>
<p>可以通过 <code>\addtolength</code>命令在长度变量上做累加，如</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">Para<span class="keyword">\par</span></span><br><span class="line"><span class="keyword">\addtolength</span><span class="keyword">\parindent</span>&#123;2em&#125;Para<span class="keyword">\par</span></span><br><span class="line"><span class="keyword">\addtolength</span><span class="keyword">\parindent</span>&#123;2em&#125;Para<span class="keyword">\par</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczxy9.md.png" /></p></li>
</ul>
<h2 id="盒子">2.7 盒子</h2>
<p>盒子 (box) 处理 <span class="math inline">\(\TeX\)</span> 中的基本处理单位，一个字符、一行文字、一个页面、一张表格在 <span class="math inline">\(\TeX\)</span> 中都是一个盒子。</p>
<ul>
<li><p>mbox and makebox</p>
<p>最简单的命令是 <code>\box&#123;&lt;text&gt;&#125;</code>，它产生一个内容以左右模式排列的盒子，可以用它表示<strong>不允许断行的内容</strong>，如果不在行末，其与普通内容无异，如：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\mbox</span>&#123;cannot be broken&#125;</span><br></pre></td></tr></table></figure>
<p><code>\makebox</code>与 <code>\mbox</code> 类似，但可以带两个可选参数，指定盒子的宽度和对齐方式(c(center, default), l(left), r(right), s(scatter))：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\textbackslash</span> makebox[&lt;width&gt;][&lt;loc&gt;]<span class="keyword">\&#123;</span>&lt;contex&gt;<span class="keyword">\&#125;</span></span><br></pre></td></tr></table></figure>
<p>还可以使用 <code>\makebox</code> 产生宽度为 0 的盒子，产生重叠(overlap) 的效果：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\makebox</span>[0pt][l]&#123;word&#125; 文字</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sgSpe1.md.png" /></p></li>
<li><p>overlap</p>
<p><span class="math inline">\(\LaTeX\)</span> 已经提供了两个命令来专门生成重叠的效果，即 <code>\llap</code>和 <code>\rlap</code>，分别表示把参数中的内容向当前位置的左侧和右侧重叠：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">语言文字 <span class="keyword">\llap</span>&#123;word&#125;<span class="keyword">\\</span>					</span><br><span class="line"><span class="keyword">\rlap</span>&#123;word&#125;语言文字</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sgS9dx.md.png" /></p></li>
<li><p>frame</p>
<p>命令 <code>\fbox</code> 和 <code>\framebox</code> 产生带边框的盒子，语法与<code>\mbox</code>和 <code>\makebox</code>类似：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\fbox</span>&#123;framed&#125; <span class="keyword">\qquad</span> <span class="keyword">\framebox</span>[3cm][s]&#123;framed box&#125;</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sgSCo6.md.png" /></p>
<p>边框与内容的距离由长度变量 <code>\fboxsep</code> 控制（默认为 3pt），边框线的粗细则由长度变量 <code>\fboxrule</code>控制（默认为 0.4 pt）。</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\setlength</span><span class="keyword">\fboxsep</span>&#123;0pt&#125; <span class="keyword">\fbox</span>&#123;tight&#125;</span><br><span class="line"><span class="keyword">\setlength</span><span class="keyword">\fboxsep</span>&#123;1em&#125; <span class="keyword">\fbox</span>&#123;loose&#125;</span><br></pre></td></tr></table></figure>
<p>Result:<img src="https://s3.ax1x.com/2021/01/19/sgSFJO.md.png" /></p>
<p>在<code>\makebox</code>、<code>\framebox</code> 等盒子命令的参数中，可以使用 <code>\width</code>、<code>\height</code>、<code>\depth</code>、<code>\totalheight</code>来分别表示盒子内容的<strong>自然宽度、深度、以及高度和深度之和</strong>。如下产生的盒子总宽度恰好是文字自然宽度的 3 倍:</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\framebox</span>[3<span class="keyword">\width</span>]&#123;带边框&#125;</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sgSiFK.md.png" /></p></li>
</ul>
<h1 id="玩转数学公式">4 玩转数学公式</h1>
<h2 id="mathematic-formula">4.1 Mathematic formula</h2>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\[</span></span><br><span class="line">a + b = b + a</span><br><span class="line"><span class="keyword">\]</span></span><br><span class="line"><span class="keyword">\begin</span>&#123;equation&#125;</span><br><span class="line">	a + b = b + a <span class="keyword">\label</span>&#123;eq:commutative&#125;</span><br><span class="line"><span class="keyword">\end</span>&#123;equation&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>amsmath package（P 223，表 4.1）</li>
</ul>
<p>amsmath 提供的 命令可以用来在数学公式中插入数字</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="built_in">$</span> <span class="keyword">\text</span>&#123;被减数&#125; - <span class="keyword">\text</span>&#123;减数&#125; = <span class="keyword">\text</span>&#123;差&#125;<span class="built_in">$</span></span><br></pre></td></tr></table></figure>
<p>$  -  = $</p>
<p>Note：在普通的文本中使用数学公式时也应该注意随时在文本模式和数学模式下转换。例如，行内数学公式中逗号等标点处不能换行，因此列举多项公式时就应该把每项放在单独的数学环境中，项项之间用逗号或句号隔开：</p>
<p>已知的变量有 <span class="math inline">\(a\)</span>, <span class="math inline">\(b\)</span>, <span class="math inline">\(c\)</span> 和 <span class="math inline">\(T\)</span></p>
<h2 id="mathematic-structure">4.2 Mathematic structure</h2>
<ul>
<li><p>上下标：</p>
<p>$ A_{ij} = 2 ^ {i + j} <span class="math inline">\(，\)</span> A_i^j = B^k_i$， <span class="math inline">\(K_{n_i} = K_{2^i} = 2^{n_i}\)</span>，<span class="math inline">\(3^{3^{3^{\cdot^{\cdot^3}}}}\)</span></p></li>
<li><p>撇号<code>'</code>：</p>
<p>数学公式中的撇号<code>'</code>就是一种特殊的商标，表示用符号 <code>\prime</code>（即<code>'</code>）作上标。撇号可以与下标混用，也可以连续使用（普通上标不能连续使用），但不能与上标直接混用：</p>
<p>$ a = a' = a^{}<span class="math inline">\(，\)</span>b_0' = b_0''<span class="math inline">\(，\)</span>{c'}^2 = (c')^2$</p></li>
<li><p>角度：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="built_in">$</span> <span class="keyword">\angle</span> a = <span class="keyword">\angle</span> BAC = 90 <span class="built_in">^</span><span class="keyword">\circ</span> = <span class="keyword">\pi</span> / 2  <span class="built_in">$</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% 或者定义一个意义明显的命令</span></span><br><span class="line"><span class="keyword">\newcommand</span><span class="keyword">\degree</span>&#123;<span class="built_in">^</span><span class="keyword">\circ</span>&#125;</span><br></pre></td></tr></table></figure>
<p>$ a = BAC = 90 ^= /2 $</p></li>
<li><p>特殊上下标</p>
<p><strong>数学算子：</strong> <span class="math display">\[
\max_n f(n) = \sum_{i=0}^n A_i
\]</span> <strong>积分算子：</strong> <span class="math display">\[
\int_0^1 f(t) \rm{d}t = \iint_D g(x,y) \mathrm{d}x \mathrm{d}y
\]</span></p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% 多数数学算子的上下标，位置时正上或正下方，但行内公式仍在角标位置</span></span><br><span class="line"><span class="keyword">\[</span></span><br><span class="line">    <span class="keyword">\max</span><span class="built_in">_</span>n f(n) = <span class="keyword">\sum</span><span class="built_in">_</span>&#123;i=0&#125;<span class="built_in">^</span>n A<span class="built_in">_</span>i</span><br><span class="line"><span class="keyword">\]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% 对于积分等个别算子，显示公式中的上下标在右上右下角</span></span><br><span class="line"><span class="comment">% 导言区 \DeclareMathOperator\dif&#123;d\!&#125;</span></span><br><span class="line"><span class="built_in">$</span><span class="keyword">\int</span><span class="built_in">_</span>o<span class="built_in">^</span>1 f(t) <span class="keyword">\dif</span> t = <span class="keyword">\iint</span><span class="built_in">_</span>D g(x,y) <span class="keyword">\dif</span> x <span class="keyword">\dif</span> y<span class="built_in">$</span></span><br></pre></td></tr></table></figure>
<p>在上下标前面使用<code>\limits</code>会使上下标在正上正下方，这是通常上下限（limits）的排版方式，而使用<code>\nolimits</code>则会使上下标在角标： <span class="math display">\[
\iiint\limits_D \mathrm{d}f = \max\nolimits_D g
\]</span> 有时需要在符号的左上、左下加角标，此时可以使用<code>$&#123;&#125;_m^n&#123;H&#125;_i^j$</code>的形式得到 <span class="math inline">\({}_m^n{H}_i^j\)</span>，但这种方式得到的效果不尽人意，间距和对齐都不合理，此时可以使用<code>amsmath</code>包提供的<code>\sideset</code>命令，如： <span class="math display">\[
\sideset{_m^n}{_i^j} H\limits_{i = 0}^n
\]</span></p>
<p><span class="math display">\[
\sideset{_m^n}{_c^d} \sum_{i = 0}^ n
\]</span></p>
<p>或者是<code>mathtools</code>宏包的<code>\prescript&lt;up&gt;&lt;down&gt;&lt;element&gt;</code>来处理</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% \usepackage&#123;mathtools&#125;</span></span><br><span class="line"><span class="built_in">$</span><span class="keyword">\prescript</span>&#123;n&#125;&#123;m&#125;&#123;H&#125;<span class="built_in">_</span>i<span class="built_in">^</span>j &lt; L <span class="built_in">$</span></span><br><span class="line"><span class="comment">% 或</span></span><br><span class="line"><span class="built_in">$</span> <span class="keyword">\sideset</span>&#123;<span class="built_in">_</span>m<span class="built_in">^</span>n&#125;&#123;<span class="built_in">_</span>i<span class="built_in">^</span>j&#125; H <span class="built_in">$</span></span><br></pre></td></tr></table></figure>
<p>此外，<code>amsmath</code>还提供了<code>\overset</code>，<code>\underset</code>命令，用来给任意符号的上下方添加标记，这种命令有点像是加了<code>\limits</code>的巨算符的上下标：<span class="math inline">\(\overset{*}{X}\)</span>，<span class="math inline">\(\underset{*}{X}\)</span></p>
<p><span class="math inline">\(A_m{}^n\)</span>或<span class="math inline">\(A_m^{\phantom{m}n}\)</span></p></li>
<li><p>化学式</p>
<p>将化学式直接作为数学式输入看起来十分笨拙，可以使用专业的化学宏包<code>mhchem</code>（使用最为广泛的化学宏包）</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% \usepackage&#123;mhchem&#125;</span></span><br><span class="line"></span><br><span class="line">醋中主要有 <span class="keyword">\ce</span>&#123;H2O&#125;，含有 <span class="keyword">\ce</span>&#123;CH3COO-&#125;。</span><br><span class="line"><span class="keyword">\ce</span>&#123;<span class="built_in">^</span>&#123;227&#125;<span class="built_in">_</span>&#123;90&#125;Th&#125; 元素具有强放射性</span><br><span class="line"></span><br><span class="line"><span class="keyword">\begin</span>&#123;equation&#125;</span><br><span class="line">	<span class="keyword">\ce</span>&#123;2H2 + O2 -&gt; [<span class="keyword">\text</span>&#123;燃烧&#125;] 2H2O&#125;</span><br><span class="line"><span class="keyword">\end</span>&#123;equation&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Result：</strong></p>
<p>醋中主要有$ $，含有 <span class="math inline">\(\ce{CH3COO-}\)</span>。 <span class="math inline">\(\ce{^{227}_{90}Th}\)</span> 元素具有强放射性</p>
<p>$ $</p></li>
<li><p>上下划线</p>
<p><code>\overline</code>和<code>\underline</code>命令可以用来在公式的上方和下方划横线，例如： <span class="math display">\[
\overline{a+b} = \overline a + \overline b
\]</span></p>
<p><span class="math display">\[
\underline a = (a_0, a_1, a_2, \dots)
\]</span></p>
<p><span class="math display">\[
\overline{\underline{\underline a} + \overline{b}^2} - c^{\overline n}
\]</span></p>
<p><code>amsmath</code>还提供了在公式上下加箭头的命令，使用方法与<code>\overline</code>和<code>\underline</code>类似：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="keyword">\overleftarrow</span>&#123;a + b&#125;<span class="built_in">$</span>，</span><br><span class="line"><span class="built_in">$</span><span class="keyword">\overrightarrow</span>&#123;a+b&#125;<span class="built_in">$</span>，</span><br><span class="line"><span class="built_in">$</span><span class="keyword">\overleftrightarrow</span>&#123;a+b&#125;<span class="built_in">$</span>，</span><br><span class="line"><span class="built_in">$</span><span class="keyword">\underleftarrow</span>&#123;a+b&#125;<span class="built_in">$</span>，</span><br><span class="line"><span class="built_in">$</span><span class="keyword">\underrightarrow</span>&#123;a+b&#125;<span class="built_in">$</span>，</span><br><span class="line"><span class="built_in">$</span><span class="keyword">\underleftrightarrow</span>&#123;a+b&#125;<span class="built_in">$</span></span><br></pre></td></tr></table></figure>
<p>$ <span class="math inline">\(，\)</span><span class="math inline">\(，\)</span><span class="math inline">\(，\)</span><span class="math inline">\(，\)</span><span class="math inline">\(，\)</span>$</p>
<p><strong>向量：</strong><span class="math inline">\(\vec{a}\)</span></p></li>
<li><p>花括号 <span class="math display">\[
\overbrace{a+b+c} = \underbrace{1+2+3}
\]</span> 使用上下标在花括号上下作标注： <span class="math display">\[
\overbrace{a_0, a_1, \dots, a_n}^{\text{共}\ n+1\ \text{项}} = \underbrace{1+2+3}_{n}
\]</span> 类似的，<code>mathtools</code>宏包还提供了在数学公式上下加方括号的命令：</p>
<p><code>\underbracket[&lt;线宽&gt;][&lt;伸出高度&gt;]&#123;&lt;内容&gt;&#125;</code></p>
<p><code>\overbracket[&lt;线宽&gt;][&lt;伸出高度&gt;]&#123;&lt;内容&gt;&#125;</code></p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">% \usepackage&#123;mathtools&#125;</span></span><br><span class="line"><span class="keyword">\[</span></span><br><span class="line">	<span class="keyword">\underbracket</span>&#123;<span class="keyword">\overbracket</span>&#123;1+2&#125;+3&#125;<span class="built_in">_</span>3</span><br><span class="line"><span class="keyword">\]</span></span><br></pre></td></tr></table></figure>
<p><code>\overbrace</code>和<code>\underbrace</code>等命令可以嵌套，但本身不能交错，如要实现交错可以分别生成两个括号：先为一部分公式的幻影<code>\phantom</code>加括号，为另一部分加括号，然后使用重叠<code>\rlap</code>的盒子将两部分合在一起： <span class="math display">\[
a+\rlap{\overbrace{\phantom{b+c+d}}^m}b+\underbrace{c+d+e}_n +f
\]</span></p></li>
<li><p>分式</p>
<p><code>\frac&lt;分子&gt;&lt;分母&gt;</code>： <span class="math display">\[
\frac{1}{2} + \frac 1{a} = \frac{2+a}{2a}
\]</span> <strong>行内公式会用较小的字号排版，以免超出文本高度：</strong><span class="math inline">\(\frac 12 + \frac 1a + \frac{2+a}{2a}\)</span></p>
<p><strong>已经在分子或分母中的分式，也会按行内公式的大小排版：</strong><span class="math inline">\(\frac 1{\frac 12(a+b)}\)</span></p>
<p>有时需要指定格式，可以使用<code>amsmath</code>提供的<code>\dfrac</code>和<code>\tfrac</code>分别指定显示格式（display style）和正文格式（text style）的分式： <span class="math display">\[
\tfrac 12 f(x) = \frac{1}{\dfrac 1a + \dfrac 1b + c}
\]</span> 连分式（continued fraction），<code>amsmath</code>提供的<code>\cfrac</code>专用于输入连分式，<code>\cfrac</code>可以带一个可选参数<code>l</code>或<code>r</code>，分别表示左、右对齐，默认居中对齐：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\cfrac</span>&#123;1&#125;&#123;1+<span class="keyword">\cfrac</span>&#123;2&#125;&#123;1+<span class="keyword">\cfrac</span>&#123;3&#125;&#123;1+x&#125;&#125;&#125; = <span class="keyword">\cfrac</span>[r]&#123;1&#125;&#123;1+<span class="keyword">\cfrac</span>&#123;2&#125;&#123;1+<span class="keyword">\cfrac</span>[l]&#123;3&#125;&#123;1+x&#125;&#125;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="symbol-and-type">4.3 Symbol and type</h2>
<h3 id="希腊字母">4.3.2 希腊字母</h3>
<ul>
<li><p>小写希腊字母：</p>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 24%" />
<col style="width: 25%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>\alpha</code>: <span class="math inline">\(\alpha\)</span></th>
<th style="text-align: center;"><code>\beta</code>: <span class="math inline">\(\beta\)</span></th>
<th style="text-align: center;"><code>\gamma</code>: <span class="math inline">\(\gamma\)</span></th>
<th style="text-align: center;"><code>\delta</code>: <span class="math inline">\(\delta\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>\epsilon</code>: <span class="math inline">\(\epsilon\)</span></td>
<td style="text-align: center;"><code>\zeta</code>: <span class="math inline">\(\zeta\)</span></td>
<td style="text-align: center;"><code>\eta</code>: <span class="math inline">\(\eta\)</span></td>
<td style="text-align: center;"><code>\theta</code>: <span class="math inline">\(\theta\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>\iota</code>: <span class="math inline">\(\iota\)</span></td>
<td style="text-align: center;"><code>\kappa</code>: <span class="math inline">\(\kappa\)</span></td>
<td style="text-align: center;"><code>\lambda</code>: <span class="math inline">\(\lambda\)</span></td>
<td style="text-align: center;"><code>\mu</code>:<span class="math inline">\(\mu\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>\nu</code>: <span class="math inline">\(\nu\)</span></td>
<td style="text-align: center;"><code>\xi</code>: <span class="math inline">\(\xi\)</span></td>
<td style="text-align: center;"><code>\pi</code>: <span class="math inline">\(\pi\)</span></td>
<td style="text-align: center;"><code>\rho</code>: <span class="math inline">\(\rho\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>\sigma</code>: <span class="math inline">\(\sigma\)</span></td>
<td style="text-align: center;"><code>\tau</code>: <span class="math inline">\(\tau\)</span></td>
<td style="text-align: center;"><code>\upsilon</code>: <span class="math inline">\(\upsilon\)</span></td>
<td style="text-align: center;"><code>\phi</code>: <span class="math inline">\(\phi\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>\chi</code>: <span class="math inline">\(\chi\)</span></td>
<td style="text-align: center;"><code>\psi</code>: <span class="math inline">\(\psi\)</span></td>
<td style="text-align: center;"><code>\omega</code>: <span class="math inline">\(\omega\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>\varepsilon</code>: <span class="math inline">\(\varepsilon\)</span></td>
<td style="text-align: center;"><code>\vartheta</code>: <span class="math inline">\(\vartheta\)</span></td>
<td style="text-align: center;"><code>\varkappa</code>: <span class="math inline">\(\varkappa\)</span>'</td>
<td style="text-align: center;"><code>\varpi</code>: <span class="math inline">\(\varpi\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>\varrho</code>: <span class="math inline">\(\varrho\)</span></td>
<td style="text-align: center;"><code>\varsigma</code>: <span class="math inline">\(\varsigma\)</span></td>
<td style="text-align: center;"><code>\varphi</code>: <span class="math inline">\(\varphi\)</span></td>
<td style="text-align: center;"><code>\digamma</code>: <span class="math inline">\(\digamma\)</span>'</td>
</tr>
</tbody>
</table>
<p>Note：前面带<code>var</code>的命令是原来字母的编题，<code>\digamma</code>（<span class="math inline">\(\digamma\)</span>）是<code>\gamma</code>（<span class="math inline">\(\gamma\)</span>）的变体；<code>'</code>标记的符号需要<code>amssymb</code>或类似的宏包</p></li>
<li><p>大学希腊字母：</p>
<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 24%" />
<col style="width: 24%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code>\Gamma</code>: <span class="math inline">\(\Gamma\)</span></th>
<th style="text-align: center;"><code>\Delta</code>: <span class="math inline">\(\Delta\)</span></th>
<th style="text-align: center;"><code>\Theta</code>: <span class="math inline">\(\Theta\)</span></th>
<th style="text-align: center;"><code>\Lambda</code>: <span class="math inline">\(\Lambda\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>\Xi</code>: <span class="math inline">\(\Xi\)</span></td>
<td style="text-align: center;"><code>\Pi</code>: <span class="math inline">\(\Pi\)</span></td>
<td style="text-align: center;"><code>\Sigma</code>: <span class="math inline">\(\Sigma\)</span></td>
<td style="text-align: center;"><code>\Upsilon</code>: <span class="math inline">\(\Upsilon\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>\Phi</code>: <span class="math inline">\(\Phi\)</span></td>
<td style="text-align: center;"><code>\Psi</code>: <span class="math inline">\(\Psi\)</span></td>
<td style="text-align: center;"><code>\Omega</code>: <span class="math inline">\(\Omega\)</span></td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>\varGamma</code>: <span class="math inline">\(\varGamma\)</span></td>
<td style="text-align: center;"><code>\varDelta</code>: <span class="math inline">\(\varDelta\)</span></td>
<td style="text-align: center;"><code>\varTheta</code>: <span class="math inline">\(\varTheta\)</span></td>
<td style="text-align: center;"><code>\varLambda</code>: <span class="math inline">\(\varLambda\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>\varXi</code>: <span class="math inline">\(\varXi\)</span></td>
<td style="text-align: center;"><code>\varPi</code>: <span class="math inline">\(\varPi\)</span></td>
<td style="text-align: center;"><code>\varSigma</code>: <span class="math inline">\(\varSigma\)</span></td>
<td style="text-align: center;"><code>\varUpsilon</code>: <span class="math inline">\(\varUpsilon\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>\varPhi</code>: <span class="math inline">\(\varPhi\)</span></td>
<td style="text-align: center;"><code>\varPsi</code>: <span class="math inline">\(\varPsi\)</span></td>
<td style="text-align: center;"><code>\varOmega</code>: <span class="math inline">\(\varOmega\)</span></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table></li>
<li><p>特殊字符</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczyZt.md.png" /></p>
<center>
<p>fig. 4-8 特殊字符</p>
</center>
<p>表（3）中，不带<code>\text</code>前缀的是文本模式和数学模式通用的。</p>
<ul>
<li><p><code>\symbol</code>命令可以直接用符号在字体中的编码来输入符号，<code>\symbol&#123;num&#125;</code></p>
<table>
<thead>
<tr class="header">
<th>表示法</th>
<th style="text-align: center;">语法形式</th>
<th style="text-align: center;">例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>十进制</td>
<td style="text-align: center;"><数字></td>
<td style="text-align: center;">90</td>
</tr>
<tr class="even">
<td>十六进制</td>
<td style="text-align: center;">''<数字></td>
<td style="text-align: center;">''5A</td>
</tr>
<tr class="odd">
<td>八进制</td>
<td style="text-align: center;">'<数字></td>
<td style="text-align: center;">'132</td>
</tr>
</tbody>
</table></li>
</ul></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">|  表示法  | 语法形式  |  例  |</span><br><span class="line">|  十进制  |  &lt;数字&gt;  |  <span class="number">90</span>  |</span><br><span class="line">| 十六进制 | <span class="string">&#x27;&#x27;</span>&lt;数字&gt; | <span class="string">&#x27;&#x27;</span>5A |</span><br><span class="line">|  八进制  | <span class="string">&#x27;&lt;数字&gt;  | &#x27;</span><span class="number">132</span> |</span><br><span class="line">| 字符形式 | `&lt;字符&gt;  |  `Z  |</span><br></pre></td></tr></table></figure>
<pre><code>注：如果字符形式中的字符是特殊字符，则需要在前面加`\`进行转义。</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% pdf ./Latex.pdf 600px %&#125;</span><br><span class="line">&lt;<span class="built_in">object</span> data=<span class="string">&quot;./Latex/Latex.pdf&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;application/pdf&quot;</span> width=<span class="string">&quot;100%&quot;</span> height=<span class="string">&quot;877px&quot;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Latex</category>
      </categories>
      <tags>
        <tag>Latex</tag>
      </tags>
  </entry>
  <entry>
    <title>Markdown</title>
    <url>/2021/01/19/Markdown/</url>
    <content><![CDATA[<h1 id="markdown">Markdown</h1>
<h2 id="title">1. Title</h2>
<h3 id="三级标题">三级标题</h3>
<h4 id="四级标题">四级标题</h4>
<p>格式及快捷键如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Markdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 1. Title</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 三级标题</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 四级标题</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="font">2. Font</h2>
<p><strong>加粗 </strong></p>
<p><em>斜体</em></p>
<p><u>下划线</u></p>
<p><del>删除线</del></p>
<p>==高亮==</p>
<p><code>底纹</code></p>
<p>$ _i = w x_i + b $ <span class="math display">\[
\hat{y}_i = w x_i + b
\]</span></p>
<p>格式及快捷键如下（其中 <code>#</code> 开头的行为注释行）：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">**加粗 ** (快捷键 ctrl + B)</span><br><span class="line">*斜体* (快捷键 ctrl + I)</span><br><span class="line">&lt;u&gt;下划线&lt;/u&gt;  (快捷键 ctrl + U)</span><br><span class="line">~~删除线~~</span><br><span class="line">==高亮==</span><br><span class="line">`底纹`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 行内公式 (In-line formula)</span></span><br><span class="line">$ \hat&#123;y&#125;_i = w x_i + b $ </span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示公式 (Display formula)</span></span><br><span class="line">$$</span><br><span class="line">\hat&#123;y&#125;_i = w x_i + b</span><br><span class="line">$$</span><br></pre></td></tr></table></figure>
<h2 id="citation">3. Citation</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 引用语法</span></span><br><span class="line">&gt; Author</span><br><span class="line">&gt;&gt; Author</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<blockquote>
<p>Author</p>
<blockquote>
<p>Author</p>
</blockquote>
</blockquote>
<h2 id="分割线">4. 分割线</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 分割线1</span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># 分割线2</span></span><br><span class="line">***</span><br></pre></td></tr></table></figure>
<hr />
<hr />
<h2 id="inset-image">5. Inset image</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在线图片/本地图片</span></span><br><span class="line">![My image1](/image/me.png) --image <span class="built_in">dir</span></span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2021/01/19/sczP2Q.png" /></p>
<center>
Fig. 1 Image demo
</center>
<p>注：Typora 支持直接复制粘贴图片，可以省去敲格式的环节，但注意在复制粘贴之前将图片储存的设置为自动保存，设置如下：</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczkKs.png" /></p>
<center>
Fig. 2 Typora image auto-save setting
</center>
<h2 id="link">6. Link</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 超链接语法，其中 [] 中为文字内容，()内为想要插入的连接</span></span><br><span class="line">[My link](https://www.bilibili.com/)</span><br></pre></td></tr></table></figure>
<p><a href="https://www.bilibili.com/">My bilibili</a></p>
<h2 id="list">7. List</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 无序列表</span></span><br><span class="line">- 目录<span class="number">1</span></span><br><span class="line">- 目录<span class="number">2</span></span><br><span class="line">- 目录<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有序列表，在目录 4 后键入回车，会自动生成有序列表</span></span><br><span class="line"><span class="number">1.</span> 目录<span class="number">4</span></span><br><span class="line"><span class="number">2.</span> 目录<span class="number">5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>目录1</li>
<li>目录2</li>
<li>目录3</li>
</ul>
<ol type="1">
<li>目录4</li>
<li>目录5</li>
</ol>
<h2 id="grid">8. Grid</h2>
<p>在 Typora 中按 <code>Ctrl + T</code> 快捷键，会出现对话框，便可以快速插入表格，如下：</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczivj.png" />)</p>
<center>
Fig. 3 Insert table
</center>
<table>
<thead>
<tr class="header">
<th>成绩</th>
<th>语文</th>
<th>数学</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td>45</td>
<td>35</td>
</tr>
</tbody>
</table>
<h2 id="段落格式">9. 段落格式</h2>
<p>以下为一下 <code>html</code> 语法，<code>Markdown</code> 可以兼容 <span class="math inline">\(\TeX\)</span> 数学公式和 <code>html</code> 语法，可以扩充已有的功能。</p>
<ul>
<li>居中</li>
</ul>
<center>
center
</center>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span> 内容居中 <span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>字体</li>
</ul>
<p><font face = "黑体">我是黑体</font></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">font</span> <span class="attr">face</span> = <span class="string">&quot;黑体&quot;</span>&gt;</span>我是黑体<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><font face="黑体" size=10>我是黑体10号字体</font></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">font</span> <span class="attr">face</span>=<span class="string">&quot;黑体&quot;</span> <span class="attr">size</span>=<span class="string">10</span>&gt;</span>我是黑体10号字体<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 字体颜色更改为红色</span><br><span class="line"><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">red</span> <span class="attr">size</span>=<span class="string">10</span>&gt;</span>我是黑体10号字体<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>Html 标签</p>
<p><img src="https://s3.ax1x.com/2021/01/19/sczC8g.png" /></p>
<center>
<p>Fig. 4 HTML Label</p>
</center></li>
</ul>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Markdown</category>
      </categories>
      <tags>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>Matplotlib</title>
    <url>/2020/11/30/Matplotlib/</url>
    <content><![CDATA[<h1 id="introduction">1 Introduction</h1>
<ul>
<li>中文显示乱码问题</li>
</ul>
<p>Matplotlib 库缺少中文字体，因此在图标上显示中文会出现乱码，解决办法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyplt <span class="keyword">import</span> mpl</span><br><span class="line">mpl.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">mpl.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="steps">2 Steps</h1>
<ul>
<li>import module and set font style to avoid messy code</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>]=[<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>]=<span class="literal">False</span></span><br></pre></td></tr></table></figure>
<ul>
<li>step one: create figure and fix size (inch)</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>)) <span class="comment"># length x width</span></span><br></pre></td></tr></table></figure>
<ul>
<li>setp two: generate data</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start_val = <span class="number">0</span> <span class="comment"># start value</span></span><br><span class="line">stop_val = <span class="number">10</span> <span class="comment"># end value</span></span><br><span class="line">num_val = <span class="number">1000</span> <span class="comment"># samples number</span></span><br><span class="line">x = np.linspace(start_val, stop_val, num_val)</span><br><span class="line">y = np.sin(x)</span><br><span class="line">plt.plot(x, y, <span class="string">&#x27;--g,&#x27;</span>, lw = <span class="number">2</span>, label = <span class="string">&#x27;$sin(x)$&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>step three: adjust axis and set label</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 调整坐标范围</span></span><br><span class="line">x_min, y_max = <span class="number">0</span>, <span class="number">10</span></span><br><span class="line">y_min, y_max = <span class="number">0</span>, <span class="number">1.5</span></span><br><span class="line">plt.xlim(x_min, x_max)</span><br><span class="line">plt.ylim(y_min, y_max)</span><br><span class="line"></span><br><span class="line"><span class="comment"># set axis label</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;x轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;y轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ticks: 刻度线</span></span><br><span class="line">x_location = np.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">x_labels = [<span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;2019-02-01&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="string">&#x27;2019-04-01&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>]</span><br><span class="line">y_location = np.arange(-<span class="number">1</span>, <span class="number">1.5</span>, <span class="number">1</span>)</span><br><span class="line">y_labels = [<span class="string">u&#x27;minimum&#x27;</span>, <span class="string">u&#x27;zero&#x27;</span>, <span class="string">u&#x27;maximum&#x27;</span>]</span><br><span class="line">plt.xticks(x_location, x_labels, rotation = <span class="number">45</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.yticks(y_location, y_labels, fontsize = <span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>step four: set grid and legend</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># grid</span></span><br><span class="line">plt.grid(<span class="literal">True</span>, ls = <span class="string">&#x27;:&#x27;</span>, color = <span class="string">&#x27;r&#x27;</span>, alpha = <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># title</span></span><br><span class="line">plt.title(<span class="string">&#x27;函数式绘图 vs 对象式绘图&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># legend</span></span><br><span class="line">plt.legend(loc = <span class="string">&#x27;upper right&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">plt.show(</span><br></pre></td></tr></table></figure>
<h2 id="函数式绘图">2.1 函数式绘图</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step one: create figure and fix size</span></span><br><span class="line">plt.figure(figsize = (<span class="number">12</span>, <span class="number">6</span>)) <span class="comment"># length x width</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># step two: generate data</span></span><br><span class="line">start_val = <span class="number">0</span> <span class="comment"># start value</span></span><br><span class="line">stop_val = <span class="number">10</span> <span class="comment"># end value</span></span><br><span class="line">num_val = <span class="number">1000</span> <span class="comment"># samples number</span></span><br><span class="line">x = np.linspace(start_val, stop_val, num_val)</span><br><span class="line">y = np.sin(x)</span><br><span class="line">plt.plot(x, y, <span class="string">&#x27;--g,&#x27;</span>, lw = <span class="number">2</span>, label = <span class="string">&#x27;$sin(x)$&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step three: adjust axis</span></span><br><span class="line">x_min = <span class="number">0</span></span><br><span class="line">x_max = <span class="number">10</span></span><br><span class="line">y_min = <span class="number">0</span></span><br><span class="line">y_max = <span class="number">1.5</span></span><br><span class="line">plt.xlim(x_min, x_max)</span><br><span class="line">plt.ylim(y_min, y_max)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step four: set axis label</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;x轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;y轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">x_location = np.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">x_labels = [<span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;2019-02-01&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="string">&#x27;2019-04-01&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>]</span><br><span class="line">y_location = np.arange(-<span class="number">1</span>, <span class="number">1.5</span>, <span class="number">1</span>)</span><br><span class="line">y_labels = [<span class="string">u&#x27;minimum&#x27;</span>, <span class="string">u&#x27;zero&#x27;</span>, <span class="string">u&#x27;maximum&#x27;</span>]</span><br><span class="line">plt.xticks(x_location, x_labels, rotation = <span class="number">45</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.yticks(y_location, y_labels, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># step five: set grid</span></span><br><span class="line"><span class="comment"># ls: linestyle</span></span><br><span class="line">plt.grid(<span class="literal">True</span>, ls = <span class="string">&#x27;:&#x27;</span>, color = <span class="string">&#x27;r&#x27;</span>, alpha = <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;函数式绘图&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line">plt.legend(loc = <span class="string">&#x27;upper right&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWKVf.md.png" /></p>
<center>
fig 2-1 函数式绘图
</center>
<h2 id="对象式绘图">2.2 对象式绘图</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对象式绘图</span></span><br><span class="line"><span class="comment"># pyplot 模块中的 figure() 函数创建名为 fig 的 Figure 对象</span></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Figure 对象中创建一个 Axes 对象，每个 Axes 对象即为一个绘图区域</span></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate data</span></span><br><span class="line">start_val, stop_val, num_val = <span class="number">0</span>, <span class="number">10</span>, <span class="number">1000</span></span><br><span class="line">x = np.linspace(start_val, stop_val, num_val)</span><br><span class="line">y = np.sin(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># y = sin(x)</span></span><br><span class="line"><span class="comment"># &#x27;--g,&#x27;: format_string, equals with a combination of linestyle, color, market, 即折线、绿色、像素点</span></span><br><span class="line">ax.plot(x, y, <span class="string">&#x27;--g&#x27;</span>, lw = <span class="number">2</span>, label = <span class="string">&#x27;sin(x)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调整坐标范围</span></span><br><span class="line">x_min, x_max = <span class="number">0</span>, <span class="number">10</span></span><br><span class="line">y_min, y_max = <span class="number">0</span>, <span class="number">1.5</span></span><br><span class="line">ax.set_xlim(x_min, x_max)</span><br><span class="line">ax.set_ylim(y_min, y_max)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置坐标轴标签</span></span><br><span class="line">plt.xlabel(<span class="string">&#x27;x轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;y轴&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">x_location = np.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">x_labels = [<span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;2019-02-01&#x27;</span>, <span class="string">&#x27;2019-03-01&#x27;</span>, <span class="string">&#x27;2019-04-01&#x27;</span>, <span class="string">&#x27;2019-05-01&#x27;</span>]</span><br><span class="line">y_location = np.arange(-<span class="number">1</span>, <span class="number">1.5</span>, <span class="number">1</span>)</span><br><span class="line">y_labels = [<span class="string">u&#x27;minimum&#x27;</span>, <span class="string">u&#x27;zero&#x27;</span>, <span class="string">u&#x27;maximum&#x27;</span>]</span><br><span class="line">plt.xticks(x_location, x_labels, rotation = <span class="number">45</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">plt.yticks(y_location, y_labels, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls: linestyle</span></span><br><span class="line">plt.grid(<span class="literal">True</span>, ls = <span class="string">&#x27;:&#x27;</span>, color = <span class="string">&#x27;r&#x27;</span>, alpha = <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;函数式绘图 vs 对象式绘图&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line">plt.legend(loc = <span class="string">&#x27;upper right&#x27;</span>, fontsize  = <span class="number">15</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgW1Pg.md.png" /></p>
<center>
fig 2-2 对象式绘图
</center>
<h1 id="figure-types">3 Figure types</h1>
<h2 id="line-attributes">3.1 Line attributes</h2>
<p>plot() 函数中，可设置参数以调整线条的属性：</p>
<ul>
<li>linestyle: 设定线条类型</li>
<li>color: 指定线条的颜色</li>
<li>marker: 指定线条的标记风格</li>
<li>linewidth: 设定线条的宽度</li>
<li>label: 设置线条的标签</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">start_val, stop_val, num_val = <span class="number">0</span>, <span class="number">10</span>, <span class="number">1000</span></span><br><span class="line">x = np.linspace(start_val, stop_val, num_val)</span><br><span class="line">y = np.sin(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># y = sin(x)</span></span><br><span class="line"><span class="comment"># &#x27;--g,&#x27;: format_string, equals with a combination of linestyle, color, market, 即折线、绿色、像素点</span></span><br><span class="line">ax.plot(x, y, <span class="string">&#x27;--g&#x27;</span>, lw = <span class="number">2</span>, label = <span class="string">&#x27;$sin(x)$&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="标注点的绘制">3.2 标注点的绘制</h2>
<p>当要在图形上给数据添加指向性注释文本时，可以使用 Matplotlib 的 annotate() 函数，支持箭头指示，方便在合适的位置添加描述信息。关键参数如下：</p>
<ul>
<li>s：注释文本内容</li>
<li>xy：备注是的坐标点，二维元组格式 (x, y)</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> xy : (<span class="built_in">float</span>, <span class="built_in">float</span>)</span><br><span class="line"><span class="comment"># The point *(x,y)* to annotate.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>xytext：注释文本的坐标点，二维元组格式 (x, y)</li>
<li>xycoords：被注释点的坐标系属性，默认为 'data'</li>
<li>textcoords：设置注释文本的坐标系属性，默认与 xycoords 属性值相同，通常设置为 'offset points' or 'offset pixels'， 即相对于被注释点 xy 的偏移量</li>
<li>arrowprops：设置箭头的样式，dict 格式</li>
</ul>
<p>If 'arrowprops' does not contain the key ' arrowstyle', the allowed keys are:</p>
<center>
tab 5-1 arrowstyle key-1
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Key</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">width</td>
<td style="text-align: left;">The width of the arrow in points</td>
</tr>
<tr class="even">
<td style="text-align: center;">headwidth</td>
<td style="text-align: left;">The width of the base of the arrow head in points</td>
</tr>
<tr class="odd">
<td style="text-align: center;">headlength</td>
<td style="text-align: left;">The length of the arrow head in points</td>
</tr>
<tr class="even">
<td style="text-align: center;">shrink</td>
<td style="text-align: left;">Fraction of total length to shrink from both ends</td>
</tr>
<tr class="odd">
<td style="text-align: center;">?</td>
<td style="text-align: left;">Any key to <code>matplotlib.patches.FancyArrowPatch</code></td>
</tr>
</tbody>
</table>
<p>如果 arrowprops 包含了关键词 ' arrowstyle'， the above keys are forbidden. The allowed values of 'arrowstyle' are:</p>
<center>
tab 5-2 arrowstyle key-2
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Name</th>
<th style="text-align: center;">Attrs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>'-'</code></td>
<td style="text-align: center;">None</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'-&gt;'</code></td>
<td style="text-align: center;">head_length=0.4,head_width=0.2</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'-['</code></td>
<td style="text-align: center;">widthB=1.0,lengthB=0.2,angleB=None</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'|-|'</code></td>
<td style="text-align: center;">widthA=1.0,widthB=1.0</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'-|&gt;'</code></td>
<td style="text-align: center;">head_length=0.4,head_width=0.2</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'&lt;-'</code></td>
<td style="text-align: center;">head_length=0.4,head_width=0.2</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'&lt;-&gt;'</code></td>
<td style="text-align: center;">head_length=0.4,head_width=0.2</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'&lt;|-'</code></td>
<td style="text-align: center;">head_length=0.4,head_width=0.2</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'&lt;|-|&gt;'</code></td>
<td style="text-align: center;">head_length=0.4,head_width=0.2</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'fancy'</code></td>
<td style="text-align: center;">head_length=0.4,head_width=0.4,tail_width=0.4</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'simple'</code></td>
<td style="text-align: center;">head_length=0.5,head_width=0.5,tail_width=0.2</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'wedge'</code></td>
<td style="text-align: center;">tail_width=0.3,shrink_factor=0.5</td>
</tr>
</tbody>
</table>
<p>Valid keys for <code>~matplotlib.patches.FancyArrowPatch</code> are:</p>
<center>
tab 5-3 ~matplotlib.patches.FancyArrowPatch
</center>
<table>
<thead>
<tr class="header">
<th>Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>arrowstyle</td>
<td>the arrow style</td>
</tr>
<tr class="even">
<td>connectionstyle</td>
<td>the connection style</td>
</tr>
<tr class="odd">
<td>relpos</td>
<td>default is (0.5, 0.5)</td>
</tr>
<tr class="even">
<td>patchA</td>
<td>default is bounding box of the text</td>
</tr>
<tr class="odd">
<td>patchB</td>
<td>default is None</td>
</tr>
<tr class="even">
<td>shrinkA</td>
<td>default is 2 points</td>
</tr>
<tr class="odd">
<td>shrinkB</td>
<td>default is 2 points</td>
</tr>
<tr class="even">
<td>mutation_scale</td>
<td>default is text size (in points)</td>
</tr>
<tr class="odd">
<td>mutation_aspect</td>
<td>default is 1</td>
</tr>
<tr class="even">
<td>?</td>
<td>any key for <code>matplotlib.patches.PathPatch</code></td>
</tr>
</tbody>
</table>
<ul>
<li>bbox：设置文本周围所添加的外框属性</li>
</ul>
<p>Case 1:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># add annotation</span></span><br><span class="line">ax.annotate(<span class="string">u&#x27;The top point&#x27;</span>,</span><br><span class="line">            xy = (np.pi/<span class="number">2</span>, <span class="number">1</span>), <span class="comment"># 箭头指向点的坐标</span></span><br><span class="line">            xytext = (np.pi/<span class="number">2</span>, <span class="number">1.3</span>), <span class="comment"># 注释文本左端的坐标</span></span><br><span class="line">            weight = <span class="string">&#x27;regular&#x27;</span>, <span class="comment"># 注释文本的字体粗细风格，bold：粗体，regular：正常粗细</span></span><br><span class="line">            color = <span class="string">&#x27;g&#x27;</span>, <span class="comment"># 注释文本颜色，green</span></span><br><span class="line">            fontsize = <span class="number">15</span>, <span class="comment"># 注释文本字体大小</span></span><br><span class="line">            arrowprops = &#123; <span class="comment"># arrowprops： arrow properties，以字典格式设置箭头属性</span></span><br><span class="line">                <span class="string">&#x27;arrowstyle&#x27;</span>: <span class="string">&#x27;-&gt;&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;connectionstyle&#x27;</span>: <span class="string">&#x27;arc3&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;color&#x27;</span>:<span class="string">&#x27;g&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;The low point&#x27;</span>,</span><br><span class="line">            xy = (np.pi*<span class="number">3</span>/<span class="number">2</span>, -<span class="number">1</span>), </span><br><span class="line">            xytext = (np.pi*<span class="number">3</span>/<span class="number">2</span>, -<span class="number">1.3</span>),</span><br><span class="line">            weight = <span class="string">&#x27;regular&#x27;</span>, </span><br><span class="line">            color = <span class="string">&#x27;r&#x27;</span>, <span class="comment"># red</span></span><br><span class="line">            fontsize = <span class="number">15</span>, </span><br><span class="line">            arrowprops = &#123; </span><br><span class="line">                <span class="string">&#x27;arrowstyle&#x27;</span>: <span class="string">&#x27;-&gt;&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;connectionstyle&#x27;</span>: <span class="string">&#x27;arc3&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;color&#x27;</span>:<span class="string">&#x27;r&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2020/11/30/DgWeKI.md.png" /></p>
<center>
fig 3-1 Annotation case1
</center>
<p>Case 2：绘制以下四种样式的标注点</p>
<ul>
<li>注释文本 'annotate1' 所对应的样式配置：在 arrowprops 参数中使用关键字 'arrowstyle' 设置 <strong>箭头样式</strong> '-&gt;'，关键字 connectionstyle 设置连接线的样式</li>
<li>注释文本 'annotate2' 所对应的样式配置：在 arrowprops 参数中使用关键字 'arrowstyle' ，允许配置箭头的宽度 width、 箭头两端收缩的百分比 shrink 等</li>
<li>注释文本 'annotate3' 所对应的样式配置：使用 bbox 参数在文本周围添加外框，设置外框为 round 格式</li>
<li>注释文本 'annotate1' 所对应的样式配置：使用 bbox 参数在文本周围添加外框， 设置外框为 round 样式</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Figure 对象中创建一个 Axes 对象，每个 Axes 对象即为一个绘图区域</span></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">x = np.arange(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line">y = np.around(np.log(x), <span class="number">2</span>)</span><br><span class="line">ax.plot(x, y, marker = <span class="string">&#x27;o&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式1&#x27;</span>, xy = (x[<span class="number">1</span>], y[<span class="number">1</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>, </span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(arrowstyle = <span class="string">&#x27;-&gt;&#x27;</span>, connectionstyle = <span class="string">&#x27;angle3, angleA = 80, angleB = 50&#x27;</span>))</span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式2&#x27;</span>, xy = (x[<span class="number">3</span>], y[<span class="number">3</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>, </span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(facecolor = <span class="string">&#x27;black&#x27;</span>, shrink = <span class="number">0.05</span>, width = <span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式3&#x27;</span>, xy = (x[<span class="number">5</span>], y[<span class="number">5</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>, </span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(facecolor = <span class="string">&#x27;green&#x27;</span>, headwidth = <span class="number">5</span>, headlength = <span class="number">10</span>),</span><br><span class="line">            bbox = <span class="built_in">dict</span>(boxstyle = <span class="string">&#x27;circle, pad = 0.5&#x27;</span>, fc = <span class="string">&#x27;yellow&#x27;</span>, ec = <span class="string">&#x27;k&#x27;</span>, lw = <span class="number">1</span>, alpha = <span class="number">0.5</span>))</span><br><span class="line"><span class="comment"># fc: facecolor, ec: edegcolor, lw: lineweight</span></span><br><span class="line"></span><br><span class="line">ax.annotate(<span class="string">u&#x27;样式4&#x27;</span>, xy = (x[<span class="number">7</span>], y[<span class="number">7</span>]), xytext = (<span class="number">80</span>, <span class="number">10</span>), textcoords = <span class="string">&#x27;offset points&#x27;</span>, </span><br><span class="line">            arrowprops = <span class="built_in">dict</span>(facecolor = <span class="string">&#x27;blue&#x27;</span>, headwidth = <span class="number">5</span>, headlength = <span class="number">10</span>),</span><br><span class="line">            bbox = <span class="built_in">dict</span>(boxstyle = <span class="string">&#x27;round, pad = 0.5&#x27;</span>, fc = <span class="string">&#x27;gray&#x27;</span>, ec = <span class="string">&#x27;k&#x27;</span>, lw = <span class="number">1</span>, alpha = <span class="number">0.5</span>))</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWMa8.png" /></p>
<center>
fig 3-2 annoatation case2
</center>
<h2 id="参考线区域的绘制">3.3 参考线/区域的绘制</h2>
<ul>
<li>axhline(), axvline()</li>
</ul>
<p>使用 Matplotlib 的 axhline() 函数、axvline() 函数分别在图形中添加水平参考线和垂直参考线，使用 axhline() 函数时给定 y 轴上的位置，同理axvline() 使用时需要给定 x 轴上的位置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ax.axhline(y = <span class="built_in">min</span>(y), c = <span class="string">&#x27;blue&#x27;</span>, ls = <span class="string">&#x27;:&#x27;</span>, lw = <span class="number">2</span>)</span><br><span class="line">ax.axvline(x = np.pi*<span class="number">3</span>/<span class="number">2</span>, c = <span class="string">&#x27;blue&#x27;</span>, ls = <span class="string">&#x27;-.&#x27;</span>, lw = <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="https://s3.ax1x.com/2020/11/30/DgW3GQ.png" /></p>
<center>
fig 3-3 Reference line
</center>
<ul>
<li>axhspan(), axvspan()</li>
</ul>
<p>使用 axhspan() 函数、axvspan() 函数分别在图形中添加 sin() 函数平行于 x 轴的参考区域和平行于 y 轴的参考区域，axhspan() 函数需给定 y 轴上的区间位置，同理在 axvspan() 中需给定 x 轴上的区间位置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ax.axhspan(ymin = <span class="number">0</span>, ymax = <span class="number">1</span>, facecolor = <span class="string">&#x27;purple&#x27;</span>, alpha = <span class="number">0.3</span>)</span><br><span class="line">ax.axvspan(xmin = np.pi *<span class="number">2</span>, xmax = np.pi * <span class="number">5</span>/<span class="number">2</span>, facecolor = <span class="string">&#x27;g&#x27;</span>, alpha = <span class="number">0.3</span>)</span><br></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="https://s3.ax1x.com/2020/11/30/DgW82j.png" /></p>
<center>
fig 3-4 Reference interval
</center>
<h2 id="双-y-轴图表的绘制">3.4 双 Y 轴图表的绘制</h2>
<ul>
<li>twinx(), twiny()</li>
</ul>
<p>如果要在同一个 x 轴上显示两个不同数量级别的序列， 可以将第二个序列绘制在右侧辅助的 y 轴上，借助 Matplotlib 的 twinx() 和 twiny() 可以实现两个 y 或 x 轴</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ax_aux = ax.twinx()</span><br><span class="line">ax_aux.plot(x, np.arange(<span class="number">1000</span>), color = <span class="string">&#x27;blue&#x27;</span>, label = <span class="string">&#x27;line 1000&#x27;</span>)</span><br><span class="line"></span><br><span class="line">y_location1 = np.arange(<span class="number">0</span>, <span class="number">1000</span>, <span class="number">100</span>)</span><br><span class="line">y_labels1 = np.arange(<span class="number">0</span>, <span class="number">1000</span>, <span class="number">100</span>)</span><br><span class="line">ax_aux.set_yticks(y_location1) <span class="comment"># 刻度</span></span><br><span class="line">ax_aux.set_yticklabels(y_labels1, fontsize= <span class="number">15</span>) <span class="comment"># 刻度标签</span></span><br><span class="line"></span><br><span class="line">ax_aux.set_ylabel(<span class="string">&#x27;Y 轴 - 辅助&#x27;</span>, fontsize= <span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="https://s3.ax1x.com/2020/11/30/DgWGxs.md.png" /></p>
<center>
fig 3-5 双 Y 轴 图表
</center>
<ul>
<li>添加图例</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig.legend(loc = <span class="string">&#x27;upper right&#x27;</span>, bbox_to_anchor = (<span class="number">1</span>, <span class="number">1</span>), bbox_transform = ax.transAxes, fontsize = <span class="number">15</span>)</span><br></pre></td></tr></table></figure>
<h2 id="条形图的绘制">3.5 条形图的绘制</h2>
<ul>
<li>bar()</li>
</ul>
<p>条形图时通过相同宽度条形的高度/宽度来表现数据差异的图表，可利用 bar() 函数绘制</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Figure 对象中创建一个 Axes 对象，每个 Axes 对象即为一个绘图区域</span></span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pandas 生成时间序列</span></span><br><span class="line">date_index = pd.date_range(<span class="string">&#x27;2019-01-01&#x27;</span>, freq = <span class="string">&#x27;D&#x27;</span>, periods = <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">y_location = np.arange(<span class="number">0</span>, <span class="number">1000</span>, <span class="number">200</span>)</span><br><span class="line">y_labels = np.arange(<span class="number">0</span>, <span class="number">1000</span>, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别模拟生成跌涨时的成交量数据</span></span><br><span class="line">red_bar = [<span class="number">1000</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">879</span>, <span class="number">986</span>, <span class="number">213</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">green_bar = [<span class="number">0</span>, <span class="number">200</span>, <span class="number">599</span>, <span class="number">567</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">234</span>, <span class="number">998</span>, <span class="number">489</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制条形图</span></span><br><span class="line">ax.bar(date_index, red_bar, facecolor = <span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">ax.bar(date_index, green_bar, facecolor = <span class="string">&#x27;green&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置轴标签</span></span><br><span class="line">ax.set_xlabel(<span class="string">u&#x27;交易日&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">u&#x27;手&#x27;</span>,fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置标题</span></span><br><span class="line">ax.set_title(<span class="string">u&#x27;成交量&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示图形</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="https://s3.ax1x.com/2020/11/30/DgWYMn.png" /></p>
<center>
fig 3-6 条形图
</center>
<h2 id="直方图">3.6 直方图</h2>
<ul>
<li>hist()</li>
</ul>
<p>绘制直方图，首先要将全部样本数据按照不同的区间范围划分为若干组，每个组为直方图的柱子，柱子宽度表示该组的区间，柱子的高度表示数据出现的次数</p>
<ul>
<li>x：绘制直方图的数据（一维数组形式），例如服从正态分布的随机数组</li>
<li>bins：直方图的柱数</li>
<li>desity：是否将直方图的频数（数据出现的次数）转换成频率（数据所占的比例）的表示，默认为 False，True表示显示频数统计结果</li>
<li>n：直方图中每一个 bar 区间数据的频数或频率， 由参数 density 设定</li>
<li>bins：用于返回各个 bin 的区间范围</li>
<li>patches：；列表形式返回每个 bin 的图形对象</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制直方图</span></span><br><span class="line">ax.hist(np.random.normal(loc = <span class="number">0</span>, scale = <span class="number">1</span>, size = <span class="number">1000</span>), bins = <span class="number">50</span>, density = <span class="literal">False</span>, color = <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置轴标签</span></span><br><span class="line">ax.set_xlabel(<span class="string">u&#x27;样本值&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">u&#x27;频数&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置标题</span></span><br><span class="line">ax.set_title(<span class="string">u&#x27;正态分布直方图&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWtrq.md.png" /></p>
<center>
fig 3-7 直方图
</center>
<h2 id="饼图">3.7 饼图</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> pylab <span class="keyword">import</span> *</span><br><span class="line">rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>]=[<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line"></span><br><span class="line">labels=[<span class="string">&quot;东部&quot;</span>,<span class="string">&quot;南部&quot;</span>,<span class="string">&quot;北部&quot;</span>,<span class="string">&quot;中部&quot;</span>]</span><br><span class="line">sizes=[<span class="number">5</span>,<span class="number">10</span>,<span class="number">20</span>,<span class="number">15</span>]</span><br><span class="line">colors=[<span class="string">&quot;red&quot;</span>,<span class="string">&quot;green&quot;</span>,<span class="string">&quot;blue&quot;</span>,<span class="string">&quot;yellow&quot;</span>]</span><br><span class="line">explode=(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.05</span>,<span class="number">0</span>) <span class="comment"># 突出</span></span><br><span class="line">plt.pie(sizes, explode = explode, labels = labels, colors = colors, labeldistance = <span class="number">1.1</span>,autopct = <span class="string">&quot;%3.1f%%&quot;</span>, shadow = <span class="literal">True</span>, startangle = <span class="number">90</span>, pctdistance = <span class="number">0.5</span>)</span><br><span class="line">plt.axis(<span class="string">&quot;equal&quot;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWwIU.png" /></p>
<center>
fig 3-8 饼图
</center>
<h2 id="k-线图">3.8 K 线图</h2>
<ul>
<li>candlestick_ochl(), candlestick2_ochl()</li>
</ul>
<p>股票的 K 线记录着一个时间段的开盘价、最高价、最低价、收盘价这 4 个数据，定义如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> mpl_finance <span class="keyword">as</span> mpf</span><br><span class="line">candlestick2_ochl(ax, opens, closea, highs, lows, width = <span class="number">4</span>, colorup = <span class="string">&#x27;k&#x27;</span>, colordown = <span class="string">&#x27;r&#x27;</span>, alpha = <span class="number">0.75</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>ochl: opens, closes, highs, lows, 分别表示开盘价、收盘价、最高价、最低价的序列</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> mpl_finance <span class="keyword">as</span> mpf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对象式绘图</span></span><br><span class="line"><span class="comment"># pyplt 模块中的 figure() 函数创建名为</span></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制 K 线图</span></span><br><span class="line">opens = [<span class="number">2320.36</span>, <span class="number">2300</span>, <span class="number">2295.35</span>, <span class="number">2347.22</span>, <span class="number">2360.75</span>, <span class="number">2385.43</span>, <span class="number">2376.41</span>, <span class="number">2424.92</span>, <span class="number">2411</span>, <span class="number">2432.68</span>]</span><br><span class="line">closes = [<span class="number">2320.26</span>, <span class="number">2291.3</span>, <span class="number">2347.5</span>, <span class="number">2358.98</span>, <span class="number">2382.48</span>, <span class="number">2385.42</span>, <span class="number">2419.02</span>, <span class="number">2428.15</span>, <span class="number">2433.13</span>, <span class="number">2334.48</span>]</span><br><span class="line">lows = [<span class="number">2287.3</span>, <span class="number">2288.26</span>, <span class="number">2295.35</span>, <span class="number">2337.35</span>, <span class="number">2347.89</span>, <span class="number">2371.23</span>, <span class="number">2369.57</span>, <span class="number">2417.58</span>, <span class="number">2403.3</span>, <span class="number">2427.7</span>]</span><br><span class="line">highs = [<span class="number">2362.94</span>, <span class="number">2308.38</span>, <span class="number">2345.92</span>, <span class="number">2363.8</span>, <span class="number">2382.48</span>, <span class="number">2383.76</span>, <span class="number">2391.82</span>, <span class="number">2421.15</span>, <span class="number">2440.38</span>, <span class="number">2441.73</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制 K 线走势</span></span><br><span class="line">mpf.candlestick2_ochl(ax, opens, closes, highs, lows, width = <span class="number">0.5</span>, colorup = <span class="string">&#x27;r&#x27;</span>, colordown = <span class="string">&#x27;g&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pandas 生成实践序列</span></span><br><span class="line">date_index = pd.date_range(<span class="string">&#x27;2019-01-01&#x27;</span>, freq = <span class="string">&#x27;D&#x27;</span>, periods = <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 x 轴的范围</span></span><br><span class="line">ax.set_xlim(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment"># x 轴刻度设定，每15天标一个日期</span></span><br><span class="line">ax.set_xticks(np.arange(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line"><span class="comment"># 标签设置为日期</span></span><br><span class="line">ax.set_xticklabels([date_index.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)[index] <span class="keyword">for</span> index <span class="keyword">in</span> ax.get_xticks()])</span><br><span class="line"><span class="comment"># 设置轴标签</span></span><br><span class="line">ax.set_xlabel(<span class="string">u&#x27;Date&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">ax.set_ylabel(<span class="string">u&#x27;Price&#x27;</span>, fontsize = <span class="number">15</span>)</span><br><span class="line">ax.set_title(<span class="string">u&#x27;日 K 线图&#x27;</span>, fontsize = <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWNq0.png" /></p>
<center>
fig 3-9 K 线图
</center>
<h2 id="time-series">3.9 Time series</h2>
<p>当横轴时间过长，不利于展示图片信息时，可以通过 matplotlib.datas 模块和<code>ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y'))</code>来调整仅显示年份</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib.dates <span class="keyword">as</span> mdates</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ticks</span></span><br><span class="line">data_ticks = pd.date_range(start = <span class="string">&#x27;1985-12&#x27;</span>, freq = <span class="string">&#x27;Y&#x27;</span>, end = <span class="string">&#x27;2019-01&#x27;</span>)</span><br><span class="line">data_labels = np.arange(<span class="number">1985</span>, <span class="number">2019</span>)</span><br><span class="line"></span><br><span class="line">data = pd.read_csv(<span class="string">r&#x27;D:\Demo\University\XMU\Thesis\Master\WTI.csv&#x27;</span>)</span><br><span class="line"><span class="comment"># date_index = data.loc[:, &#x27;日期&#x27;]</span></span><br><span class="line">x_index = pd.date_range(start = <span class="string">&#x27;1986-01&#x27;</span>, freq = <span class="string">&#x27;M&#x27;</span>, end = <span class="string">&#x27;2019-01&#x27;</span>)</span><br><span class="line">data1 = data.loc[:, <span class="string">&#x27;收盘&#x27;</span>]</span><br><span class="line">data_pt = data1.to_list()</span><br><span class="line"></span><br><span class="line">petrol_price = pd.DataFrame(data_pt, index = x_index, columns = [<span class="string">&#x27;Pt_price&#x27;</span>])</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">ax = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line">ax.plot(petrol_price, color = <span class="string">&#x27;b&#x27;</span>, lw = <span class="number">0.8</span>, label = <span class="string">&#x27;WTI现货离岸价格&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置时间显示格式，%Y%m%d%H 年月日时显示</span></span><br><span class="line">ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="string">&#x27;%Y&#x27;</span>))</span><br><span class="line"><span class="comment"># plt.xlim((1988, 2019))</span></span><br><span class="line">plt.xticks(ticks = data_ticks, label = data_labels, rotation = <span class="number">45</span>)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;1986-2018年油价（WTI现货离岸价格）趋势图&#x27;</span>, fontsize = <span class="number">16</span>)</span><br><span class="line">plt.legend()</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWgqx.md.png" /></p>
<center>
fig 3-10 WTI油价趋势表
</center>
<h1 id="subplot">4 Subplot</h1>
<p>当需要在图表上显示多个子图时，可以在 Figure 对象中创建 Axes 对象，于是每个 Axes 对象即为一个独立的绘图区域，创建子图的方法主要有 subplot()、add_subplot()、add_axes() 三种方法</p>
<h2 id="create-subplot">4.1 Create subplot</h2>
<h3 id="add_subplot">4.1.1 add_subplot()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>,  <span class="number">8</span>))</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">211</span>) <span class="comment"># 子图以 2 行 1 列排布</span></span><br><span class="line">ax2 = fig.add_subplot(<span class="number">212</span>) <span class="comment"># 创建另一个 Axes 对象</span></span><br><span class="line"></span><br><span class="line">ax1.plot(np.arange(<span class="number">100</span>), np.random.randint(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>), label = <span class="string">u&#x27;0-10 随机数&#x27;</span>, ls = <span class="string">&#x27;-&#x27;</span>, c =<span class="string">&#x27;r&#x27;</span>, lw = <span class="number">1</span>)</span><br><span class="line">ax1.set_title(<span class="string">u&#x27;0-10 随机数&#x27;</span>, fontsize = <span class="number">12</span>)</span><br><span class="line">ax1.legend(loc = <span class="string">&#x27;upper right&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax2.plot(np.arange(<span class="number">100</span>), np.random.randint(<span class="number">10</span>, <span class="number">20</span>, <span class="number">100</span>), label = <span class="string">u&#x27;10-20 随机数&#x27;</span>, ls = <span class="string">&#x27;-&#x27;</span>, c =<span class="string">&#x27;y&#x27;</span>, lw = <span class="number">1</span>)</span><br><span class="line">ax2.set_title(<span class="string">u&#x27;10-20 随机数&#x27;</span>, fontsize = <span class="number">12</span>)</span><br><span class="line">ax2.legend(loc = <span class="string">&#x27;upper right&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWsz9.png" /></p>
<center>
fig 4-1 subplot
</center>
<p>add_subplot() 本质上是以坐标来定位子图位置的，左下角坐标位置时子图在整个 Figure 对象上的绝对坐标，如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(ax1, ax2)</span><br><span class="line"><span class="comment"># AxesSubplot(0.125,0.536818;0.775x0.343182)</span></span><br><span class="line"><span class="comment"># AxesSubplot(0.125,0.125;0.775x0.343182)</span></span><br></pre></td></tr></table></figure>
<h3 id="add_axes">4.1.2 add_axes()</h3>
<p>使用 add_axes() 创建子图与 add_subplot() 有所不同，add_axes() 函数中需要给定子图在整个 Figure 对象上的绝对坐标[x0, y0, width, height]，即左下角的坐标 (x0, y0) 及其宽度和高度</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">ax1 = fig.add_axes([<span class="number">0.125</span>, <span class="number">0.536818</span>, <span class="number">0.775</span>, <span class="number">0.343182</span>])</span><br><span class="line">ax2 = fig.add_axes([<span class="number">0.125</span>, <span class="number">0.125</span>, <span class="number">0.775</span>, <span class="number">0.343182</span>])</span><br><span class="line">ax1.plot(np.arange(<span class="number">100</span>), np.random.randint(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>), label = <span class="string">u&#x27;0-10 随机数&#x27;</span>, ls = <span class="string">&#x27;-&#x27;</span>, c =<span class="string">&#x27;r&#x27;</span>, lw = <span class="number">1</span>)</span><br><span class="line">ax1.set_title(<span class="string">u&#x27;0-10 随机数&#x27;</span>, fontsize = <span class="number">12</span>)</span><br><span class="line">ax1.legend(loc = <span class="string">&#x27;upper right&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax2.plot(np.arange(<span class="number">100</span>), np.random.randint(<span class="number">10</span>, <span class="number">20</span>, <span class="number">100</span>), label = <span class="string">u&#x27;10-20 随机数&#x27;</span>, ls = <span class="string">&#x27;-&#x27;</span>, c =<span class="string">&#x27;y&#x27;</span>, lw = <span class="number">1</span>)</span><br><span class="line">ax2.set_title(<span class="string">u&#x27;10-20 随机数&#x27;</span>, fontsize = <span class="number">12</span>)</span><br><span class="line">ax2.legend(loc = <span class="string">&#x27;upper right&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWrRJ.png" /></p>
<center>
fig 4-2 add_axes
</center>
<p>当需要精确定位子图时，可使用 add_axes()，但获取子图精确的位置信息较繁琐</p>
<h3 id="subplot-1">4.1.3 subplot()</h3>
<p>add_subplot() 和 add_axes() 是对象式创建子图的方法，而 subplot() 是函数式创建子图的方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line">plt.subplot(<span class="number">211</span>)</span><br><span class="line">plt.plot(np.arange(<span class="number">100</span>), np.random.randint(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>), label = <span class="string">u&#x27;0-10 随机数&#x27;</span>, ls = <span class="string">&#x27;-&#x27;</span>, c =<span class="string">&#x27;r&#x27;</span>, lw = <span class="number">1</span>)</span><br><span class="line">plt.legend(loc = <span class="number">1</span>)</span><br><span class="line">plt.subplot(<span class="number">212</span>)</span><br><span class="line">plt.plot(np.arange(<span class="number">100</span>), np.random.randint(<span class="number">10</span>, <span class="number">20</span>, <span class="number">100</span>), label = <span class="string">u&#x27;10-20 随机数&#x27;</span>, ls = <span class="string">&#x27;-&#x27;</span>, c =<span class="string">&#x27;y&#x27;</span>, lw = <span class="number">1</span>)</span><br><span class="line">plt.legend(loc = <span class="number">1</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result is same as above figure.</p>
<ul>
<li>Demo: 使用 subplot 创建 2 行 3 列 排布的多子图，以遍历方式在子图上绘制折线图</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">fig_ps, axes_ps = plt.subplots(<span class="number">2</span>, <span class="number">3</span>) </span><br><span class="line"><span class="comment"># subplots 返回两个值，fig_ps 表示图像大小信息， axes_ps 表示子图位置信息</span></span><br><span class="line">print(fig_ps, axes_ps)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        axes_ps[i, j].plot(np.arange(<span class="number">100</span>), np.random.randint(<span class="number">0</span>, <span class="number">10</span>, <span class="number">100</span>), c =<span class="string">&#x27;y&#x27;</span>, alpha = <span class="number">0.5</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWBiF.png" /></p>
<center>
fig 4-3 mul-subplot
</center>
<h2 id="布局多子图对象">4.2 布局多子图对象</h2>
<ul>
<li>GridSpec module</li>
</ul>
<p>有时不仅要在多个子图上显示图形，而且也要协调多个子图的位置和比例。三种创建子图的方法中，使用较多的是 add_plot() 方法，而该方法所创建的子图是堆成的子图，因此该方法并不满足非对称子图的应用。 若要创建非对称的子图，可以使用 matplotlib 的 GridSpec 模块。GridSpec 可以自定义子图的位置和调整子图行和列的相对高度和宽度</p>
<p>Import module</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.gridspec <span class="keyword">as</span> gridspec <span class="comment"># 分割子图</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gridspec.GridSpec 的构造函数</span></span><br><span class="line">gridspec.GridSpec(nrows, ncols, figure = <span class="literal">None</span>, left = <span class="literal">None</span>, bottom = <span class="literal">None</span>, right = <span class="literal">None</span>, top = <span class="literal">None</span>, wspace = <span class="literal">None</span>, hspace = <span class="literal">None</span>, width_ratios = <span class="literal">None</span>, height_ratios = <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p>参数 nrows 和 ncols 分别表示网格的行列数。用 plt.figure() 创建图表，通过 gridspec.GridSpec() 将整个图表划分为多个区域。由于 GridSpec 返回的实例支持切片方式选取网格区域，因此可以结合 add_subplot() 方法更灵活地添加跨度不同网格大小的子图</p>
<p>left, bottom, right, top 分别控制子图与 Figure 左边、底部、右边、顶部的距离比例。gs[0, : ] 表示该子图占第 0 行和所有列</p>
<h3 id="创建多子图布局">4.2.1 创建多子图布局</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib.gridspec <span class="keyword">as</span> gridspec</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>), dpi = <span class="number">100</span>, facecolor = <span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">gs = gridspec.GridSpec(<span class="number">3</span>, <span class="number">3</span>)</span><br><span class="line">graph_ax1 = fig.add_subplot(gs[<span class="number">0</span>, :])</span><br><span class="line">graph_ax2 = fig.add_subplot(gs[<span class="number">1</span>, <span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">graph_ax3 = fig.add_subplot(gs[<span class="number">1</span>:<span class="number">3</span>, <span class="number">2</span>])</span><br><span class="line">graph_ax4 = fig.add_subplot(gs[<span class="number">2</span>, <span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgW6MR.png" /></p>
<center>
fig 4-4 多子图布局图
</center>
<h3 id="微调">4.2.2 微调</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib.gridspec <span class="keyword">as</span> gridspec</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize = (<span class="number">12</span>, <span class="number">8</span>), dpi = <span class="number">100</span>, facecolor = <span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">gs = gridspec.GridSpec(<span class="number">3</span>, <span class="number">3</span>, left = <span class="number">0.08</span>, bottom = <span class="number">0.15</span>, right = <span class="number">0.99</span>, </span><br><span class="line">                       top = <span class="number">0.96</span>, wspace = <span class="number">0.5</span>, hspace = <span class="number">0.5</span>, width_ratios = [<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>],</span><br><span class="line">                      height_ratios = [<span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">graph_ax1 = fig.add_subplot(gs[<span class="number">0</span>, :])</span><br><span class="line">graph_ax2 = fig.add_subplot(gs[<span class="number">1</span>, <span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">graph_ax3 = fig.add_subplot(gs[<span class="number">1</span>:<span class="number">3</span>, <span class="number">2</span>])</span><br><span class="line">graph_ax4 = fig.add_subplot(gs[<span class="number">2</span>, <span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWcs1.md.png" /></p>
<center>
fig 4-5 微调之后的多子图布局
</center>
<h1 id="figure-properties">5 Figure properties</h1>
<h2 id="plot">5.1 plot()</h2>
<p>Function definition:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 单线条：</span></span><br><span class="line">plot([x], y [, fmt], data = <span class="literal">None</span>, **kwargs)</span><br><span class="line"><span class="comment"># 多线条</span></span><br><span class="line">plot([x], y [, fmt], [x2], y2 [fmt2], ..., **kwargs)</span><br><span class="line"><span class="comment"># fmt = &#x27;[color][marker][line]&#x27;</span></span><br></pre></td></tr></table></figure>
<p>其中，[fmt]为可选参数，用一个字符串来定义图形的基本属性，包括颜色（color），点型（marker），线性（linestyle），具体如下：</p>
<ul>
<li>Colors</li>
</ul>
<center>
tab 5-4 color properties
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Character</th>
<th style="text-align: center;">Color</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>'b'</code></td>
<td style="text-align: center;">blue</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'g'</code></td>
<td style="text-align: center;">green</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'r'</code></td>
<td style="text-align: center;">red</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'c'</code></td>
<td style="text-align: center;">cyan（蓝绿色）</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'m'</code></td>
<td style="text-align: center;">magenta（品红）</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'y'</code></td>
<td style="text-align: center;">yellow</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'k'</code></td>
<td style="text-align: center;">black</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'w'</code></td>
<td style="text-align: center;">white</td>
</tr>
</tbody>
</table>
<ul>
<li>Markers</li>
</ul>
<center>
tab 5-5 marker properties
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Character</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>'.'</code></td>
<td style="text-align: center;">point marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>','</code></td>
<td style="text-align: center;">pixel marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'o'</code></td>
<td style="text-align: center;">circle marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'v'</code></td>
<td style="text-align: center;">triangle_down marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'^'</code></td>
<td style="text-align: center;">triangle_up marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'&lt;'</code></td>
<td style="text-align: center;">triangle_left marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'&gt;'</code></td>
<td style="text-align: center;">triangle_right marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'1'</code></td>
<td style="text-align: center;">tri_down marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'2'</code></td>
<td style="text-align: center;">tri_up marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'3'</code></td>
<td style="text-align: center;">tri_left marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'4'</code></td>
<td style="text-align: center;">tri_right marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'s'</code></td>
<td style="text-align: center;">square marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'p'</code></td>
<td style="text-align: center;">pentagon marker（五角形）</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'*'</code></td>
<td style="text-align: center;">star marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'h'</code></td>
<td style="text-align: center;">hexagon1 marker（六角形）</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'H'</code></td>
<td style="text-align: center;">hexagon2 marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'+'</code></td>
<td style="text-align: center;">plus marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'x'</code></td>
<td style="text-align: center;">x marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'D'</code></td>
<td style="text-align: center;">diamond marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'d'</code></td>
<td style="text-align: center;">thin_diamond marker</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'|'</code></td>
<td style="text-align: center;">vline marker</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'_'</code></td>
<td style="text-align: center;">hline marker</td>
</tr>
</tbody>
</table>
<ul>
<li>Line Styles</li>
</ul>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Character</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>'-'</code></td>
<td style="text-align: center;">solid line style</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'--'</code></td>
<td style="text-align: center;">dashed line style（虚线）</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'-.'</code></td>
<td style="text-align: center;">dash-dot line style</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>':'</code></td>
<td style="text-align: center;">dotted line style</td>
</tr>
</tbody>
</table>
<ul>
<li>Examples format strings:</li>
</ul>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Character</th>
<th style="text-align: center;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>'b'</code></td>
<td style="text-align: center;">blue markers with default shape</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'ro'</code></td>
<td style="text-align: center;">red circles</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'g-'</code></td>
<td style="text-align: center;">green solid line</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>'--'</code></td>
<td style="text-align: center;">dashed line with default color</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>'k^:'</code></td>
<td style="text-align: center;">black triangle_up markers connected by a dotted line</td>
</tr>
</tbody>
</table>
<p>Case:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>], <span class="string">&#x27;go--&#x27;</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], color = <span class="string">&#x27;green&#x27;</span>, marker = <span class="string">&#x27;o&#x27;</span>, linestyle = <span class="string">&#x27;dashed&#x27;</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], color = <span class="string">&#x27;g&#x27;</span>, marker = <span class="string">&#x27;o&#x27;</span>, linestyle = <span class="string">&#x27;dashed&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWaZV.png" /></p>
<center>
fig 5-1 plot parameter
</center>
<h2 id="abbreviation">5.2 Abbreviation</h2>
<p>Matplotlib 支持一些属性的关键词简写：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;linewidth&#x27;</span>: [<span class="string">&#x27;lw&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;linestyle&#x27;</span>: [<span class="string">&#x27;ls&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;facecolor&#x27;</span>: [<span class="string">&#x27;fc&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;edgecolor&#x27;</span>: [<span class="string">&#x27;ec&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;markerfacecolor&#x27;</span>: [<span class="string">&#x27;mfc&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;markeredgecolor&#x27;</span>: [<span class="string">&#x27;mec&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;markeredgewidth&#x27;</span>: [<span class="string">&#x27;mew&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;markersize&#x27;</span>: [<span class="string">&#x27;ms&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], color = <span class="string">&#x27;green&#x27;</span>, marker = <span class="string">&#x27;o&#x27;</span>, linestyle = <span class="string">&#x27;dashed&#x27;</span>, linewidth = <span class="number">2</span>)</span><br><span class="line">plt.plot([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], c = <span class="string">&#x27;g&#x27;</span>, marker = <span class="string">&#x27;o&#x27;</span>, linestyle = <span class="string">&#x27;dashed&#x27;</span>, lw = <span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWdaT.png" /></p>
<center>
fig 5-2 Abbreviation
</center>
<h2 id="ticks">5.3 Ticks</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">x = np.linspace(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">y1 = <span class="number">2</span> * x + <span class="number">1</span></span><br><span class="line">y2 = x**<span class="number">2</span></span><br><span class="line"></span><br><span class="line">plt.figure(num = <span class="number">1</span>)</span><br><span class="line">plt.plot(x, y1, color = <span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">plt.plot(x, y2, color = <span class="string">&#x27;green&#x27;</span>, linewidth = <span class="number">1.0</span>, linestyle = <span class="string">&#x27;--&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlim((-<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">plt.ylim((-<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">plt.xlabel(<span class="string">&#x27;I am x&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;I am y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_ticks = np.linspace(-<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line">print(new_ticks)</span><br><span class="line">plt.xticks(new_ticks) <span class="comment"># 刻度</span></span><br><span class="line">plt.yticks([-<span class="number">2</span>, -<span class="number">1.8</span>, -<span class="number">1</span>, <span class="number">1.22</span>, <span class="number">3</span>],</span><br><span class="line">           [<span class="string">r&#x27;$relly\ bad\ \alpha$&#x27;</span>, <span class="string">r&#x27;$bad$&#x27;</span>, <span class="string">r&#x27;$normal$&#x27;</span>, <span class="string">r&#x27;$good$&#x27;</span>, <span class="string">r&#x27;$really\ good$&#x27;</span>])</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://s3.ax1x.com/2020/11/30/DgWA8H.png" /></p>
<center>
fig 5-3 Ticks demo
</center>
<h2 id="axis-position">5.4 Axis position</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">x = np.linspace(-<span class="number">3</span>, <span class="number">3</span>, <span class="number">50</span>)</span><br><span class="line">y1 = <span class="number">2</span> * x + <span class="number">1</span></span><br><span class="line">y2 = x**<span class="number">2</span></span><br><span class="line"></span><br><span class="line">plt.figure(num = <span class="number">1</span>)</span><br><span class="line">plt.plot(x, y1, color = <span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">plt.plot(x, y2, color = <span class="string">&#x27;green&#x27;</span>, linewidth = <span class="number">1.0</span>, linestyle = <span class="string">&#x27;--&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlim((-<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">plt.ylim((-<span class="number">2</span>, <span class="number">4</span>))</span><br><span class="line">plt.xlabel(<span class="string">&#x27;I am x&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;I am y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_ticks = np.linspace(-<span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line">print(new_ticks)</span><br><span class="line">plt.xticks(new_ticks)</span><br><span class="line">plt.yticks([-<span class="number">2</span>, -<span class="number">1.8</span>, -<span class="number">1</span>, <span class="number">1.22</span>, <span class="number">3</span>],</span><br><span class="line">           [<span class="string">r&#x27;$relly\ bad\ \alpha$&#x27;</span>, <span class="string">r&#x27;$bad$&#x27;</span>, <span class="string">r&#x27;$normal$&#x27;</span>, <span class="string">r&#x27;$good$&#x27;</span>, <span class="string">r&#x27;$really\ good$&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># gca = get current axis</span></span><br><span class="line">ax = plt.gca()</span><br><span class="line">ax.spines[<span class="string">&#x27;right&#x27;</span>].set_color(<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line">ax.spines[<span class="string">&#x27;top&#x27;</span>].set_color(<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line">ax.xaxis.set_ticks_position(<span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line">ax.yaxis.set_ticks_position(<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">ax.spines[<span class="string">&#x27;bottom&#x27;</span>].set_position((<span class="string">&#x27;data&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">ax.spines[<span class="string">&#x27;left&#x27;</span>].set_position((<span class="string">&#x27;data&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:</p>
<p><img src="https://s3.ax1x.com/2020/11/30/DgWkPe.png" /></p>
<center>
fig 5-4 Modify axis position
</center>
<h2 id="legend">5.5 legend()</h2>
<ul>
<li>loc</li>
</ul>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Location String</th>
<th style="text-align: center;">Location Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">'best'</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">'upper right'</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">'upper left'</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="even">
<td style="text-align: center;">'lower left'</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="odd">
<td style="text-align: center;">'lower right'</td>
<td style="text-align: center;">4</td>
</tr>
<tr class="even">
<td style="text-align: center;">'right'</td>
<td style="text-align: center;">5</td>
</tr>
<tr class="odd">
<td style="text-align: center;">'center left'</td>
<td style="text-align: center;">6</td>
</tr>
<tr class="even">
<td style="text-align: center;">'center right'</td>
<td style="text-align: center;">7</td>
</tr>
<tr class="odd">
<td style="text-align: center;">'lower center'</td>
<td style="text-align: center;">8</td>
</tr>
<tr class="even">
<td style="text-align: center;">'upper center'</td>
<td style="text-align: center;">9</td>
</tr>
<tr class="odd">
<td style="text-align: center;">'center'</td>
<td style="text-align: center;">10</td>
</tr>
</tbody>
</table>
<h2 id="add-text">5.6 Add text</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ax.text(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;This is a test text.&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2020/11/30/DgWRZ6.png" /></p>
<center>
fig 5-5 Add text on figure
</center>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Matplotlib</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Data analysis</tag>
        <tag>Matplotlib</tag>
      </tags>
  </entry>
  <entry>
    <title>Numpy</title>
    <url>/2020/11/29/Numpy/</url>
    <content><![CDATA[<h1 id="numpy-version">1 NumPy version</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">print(np.__version__) <span class="comment"># 查看 numpy 版本</span></span><br></pre></td></tr></table></figure>
<p>NumPy( Numerical Python) 是 Python 数值计算最重要的基础库，核心是 N 维数组对象 ndarray ( N-dimensional array )。</p>
<a id="more"></a>
<h1 id="create-ndarray">2 Create ndarray</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">array_1x6 = np.array([<span class="number">1.0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], dtype = np.float64) <span class="comment"># 用 list 创建 array，可以通过 dtype 参数指定元素的类型  </span></span><br><span class="line"></span><br><span class="line">print(array_1x6.dtype)</span><br><span class="line"></span><br><span class="line"><span class="comment"># number of dimension</span></span><br><span class="line">print(<span class="string">&#x27;number of dim: &#x27;</span>,array_1x6.ndim)</span><br><span class="line">print(<span class="string">&#x27;shape: &#x27;</span>,array_1x6.shape)</span><br><span class="line">print(<span class="string">&#x27;size: &#x27;</span>,array_1x6.size)</span><br><span class="line"><span class="comment"># total number of elements</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(array_1x6) <span class="comment"># 空格分隔元素</span></span><br><span class="line">[<span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span>]</span><br></pre></td></tr></table></figure>
<h1 id="special-ndarray">4 Special ndarray</h1>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import numpy as np</span><br></pre></td></tr></table></figure>
<ul>
<li><p>零矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a1 = np.zeros((<span class="number">3</span>,<span class="number">4</span>)) <span class="comment"># 零矩阵</span></span><br></pre></td></tr></table></figure></li>
<li><p>矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a2 = np.ones((<span class="number">3</span>,<span class="number">4</span>)) <span class="comment"># 1 矩阵</span></span><br></pre></td></tr></table></figure></li>
<li><p>空矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a3 = np.empty((<span class="number">3</span>,<span class="number">4</span>)) <span class="comment"># 未初始化的空矩阵</span></span><br></pre></td></tr></table></figure></li>
<li><p>对角矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a7 = np.identity(<span class="number">5</span>) <span class="comment"># 5x5 的对角矩阵</span></span><br><span class="line">a8 = np.mat(np.identity(<span class="number">5</span>))</span><br></pre></td></tr></table></figure></li>
<li><p>线段</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a5 = np.arange(<span class="number">12</span>)</span><br><span class="line">a6 = np.linspace(<span class="number">1</span>, <span class="number">10</span>, <span class="number">5</span>) <span class="comment"># 5 个元素的线段</span></span><br><span class="line">print(a6 &lt; <span class="number">5</span>) <span class="comment"># 返回布尔类型的矩阵</span></span><br></pre></td></tr></table></figure></li>
<li><p>对角矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a7 = np.identity(<span class="number">5</span>) <span class="comment"># 5x5 的对角矩阵</span></span><br><span class="line">a8 = np.mat(np.identity(<span class="number">5</span>))</span><br></pre></td></tr></table></figure></li>
<li><p>随机矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = np.random.random((<span class="number">2</span>, <span class="number">4</span>)) <span class="comment"># 0-1的随机数</span></span><br><span class="line">print(np.<span class="built_in">sum</span>(a), np.<span class="built_in">min</span>(a), np.<span class="built_in">max</span>(a))</span><br><span class="line">np.<span class="built_in">sum</span>(a, axis = <span class="number">0</span>) <span class="comment"># 列操作，axis = 1行操作，the default, axis = None，will sum all of the elements of the input array</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="array-operations">4 Array operations</h1>
<h2 id="preparation">4.1 Preparation</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">a = np.array([[<span class="number">10</span>, <span class="number">20</span>], [<span class="number">30</span>, <span class="number">40</span>]])</span><br><span class="line">b = np.arange(<span class="number">4</span>).reshape(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">print(a, b, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[[<span class="number">10</span> <span class="number">20</span>]</span><br><span class="line"> [<span class="number">30</span> <span class="number">40</span>]]</span><br><span class="line">[[<span class="number">0</span> <span class="number">1</span>]</span><br><span class="line"> [<span class="number">2</span> <span class="number">3</span>]]</span><br></pre></td></tr></table></figure></p>
<h2 id="mathematical-operation">4.2 Mathematical operation</h2>
<ul>
<li><p>Plus &amp; minus <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">c1 = a + b</span><br><span class="line">c2 = a - b</span><br></pre></td></tr></table></figure></p></li>
<li><p>Multiply &amp; divide</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">c3 = a * b <span class="comment"># 对应元素相乘</span></span><br><span class="line">c4 = b / a</span><br></pre></td></tr></table></figure></li>
<li><p><code>dot</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">c5 = np.dot(a, b) <span class="comment"># 矩阵相乘，点乘</span></span><br><span class="line">c6 = a.dot(b) <span class="comment"># 和上式相同，a 值不改变</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="conditional-selection">4.3 Conditional selection</h2>
<ul>
<li><p><code>where</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">a = np.array([[<span class="number">10</span>, <span class="number">20</span>], [<span class="number">30</span>, <span class="number">40</span>]])</span><br><span class="line">row, col = np.where(a == <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">print(row, col, sep = <span class="string">&#x27;\t&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Reuslt: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="number">0</span>]     [<span class="number">1</span>]</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h1 id="array-basic-methods">5 Array basic methods</h1>
<ul>
<li><p>导入模块 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure></p></li>
<li><p>统计特征 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># find elements</span></span><br><span class="line">A = np.arange(<span class="number">2</span>, <span class="number">14</span>).reshape(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">index = np.argmax(A)  <span class="comment"># 最大值索引or argmin</span></span><br><span class="line">mean = np.mean(A) <span class="comment"># 均值</span></span><br><span class="line">median = np.median(A) <span class="comment"># 中位数</span></span><br><span class="line">print(index, mean, median, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure> 上述函数皆默认 <code>axis = None, the index is into the flattened array</code>，若添加参数：<code>axis = 1</code> 则返回每一行的相关操作，<code>axis = 0</code> 则返回每一列的相关操作，具体参照: <code>help(np.mean)</code>。</p></li>
<li><p>累加和差分 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># A：3x4 的数组</span></span><br><span class="line">cumsum = np.cumsum(A)</span><br><span class="line"><span class="comment"># 累加，axis默认为None，输出1x12数组</span></span><br><span class="line">diff = np.diff(A)</span><br><span class="line"><span class="comment"># 差分，默认axis=-1，即行操作与axis=1效果相同，返回3X3的数组，axis=0，返回2x4数组</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>查找数据 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">non = np.nonzero(A)</span><br></pre></td></tr></table></figure> 查找非零元素的索引，返回两个array，第一个为行索引，第二个为列索引，输出： <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], dtype=int64),</span><br><span class="line"> array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], dtype=int64))</span><br></pre></td></tr></table></figure></p></li>
<li><p>矩阵转置 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 矩阵转置, transpose array</span></span><br><span class="line">transpose1 = np.transpose(A)</span><br><span class="line">transpose2 = A.T</span><br><span class="line">print(transpose1, transpose2, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">print(transpose1.dot(A)) <span class="comment"># $&#123;A * A^T&#125;$</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>数据裁剪<code>clip</code> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = np.arange(<span class="number">2</span>, <span class="number">14</span>).reshape(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line">clip = np.clip(a, <span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">print(a, clip, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure> Given an interval [5, 9], values outside this interval are clipped to this interval edges, namely 5 and 9. Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">array([[<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>],</span><br><span class="line">       [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">       [<span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>]])</span><br></pre></td></tr></table></figure></p></li>
<li><p>迭代输出 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = np.arange(<span class="number">2</span>, <span class="number">14</span>).reshape(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="comment"># 行迭代输出</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> a:</span><br><span class="line">    print(row)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列迭代输出    </span></span><br><span class="line"><span class="keyword">for</span> column <span class="keyword">in</span> a.T:</span><br><span class="line">    print(column.T)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 元素迭代, flat返回迭代器，flatten()返回array</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> a.flat: <span class="comment"># or a.flatten()</span></span><br><span class="line">    print(item)</span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Row</span></span><br><span class="line">array([[<span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>],</span><br><span class="line">       [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">       [<span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>]])</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h1 id="array-joint">6 Array joint</h1>
<h2 id="vstack-and-hstack">6.1 vstack and hstack</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = np.array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">b = np.array([<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">c = np.vstack((a, b)) <span class="comment">#vertical stack 纵向</span></span><br><span class="line">d = np.hstack((a, b)) <span class="comment"># horizontal stack 横</span></span><br><span class="line">print(a.shape, c.shape) <span class="comment"># a 的shape为序列</span></span><br><span class="line">print(c, d, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(a.T.shape) <span class="comment"># 并未改变shape，0x3维</span></span><br><span class="line">a1 = a[:, np.newaxis] <span class="comment"># 在后面加维度，3x1维</span></span><br><span class="line">a2 = a[np.newaxis, :] <span class="comment"># add before, 1x3</span></span><br><span class="line">c= np.array([[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],[<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>]]) <span class="comment"># 2x3</span></span><br><span class="line">c1 = c[np.newaxis, :] <span class="comment"># add before 1x2x3</span></span><br><span class="line">c2 = c[:, np.newaxis] <span class="comment"># same as c3</span></span><br><span class="line">c3 = c[:, np.newaxis, :] <span class="comment"># 2x1x3</span></span><br><span class="line">c4 = c[:, :, np.newaxis] <span class="comment"># 2x3x1</span></span><br></pre></td></tr></table></figure>
<h2 id="concatenate">6.2 concatenate</h2>
<p>Join a sequence of arrays along a existing axis, default axis is o, if axis = None, arrays will be flattened before use.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">a = np.array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>])[:, np.newaxis]</span><br><span class="line">b = np.array([<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>])[:, np.newaxis]</span><br><span class="line"></span><br><span class="line">c1 = np.concatenate((a,b,b,a)) <span class="comment"># same as c2</span></span><br><span class="line">c2 = np.concatenate((a,b,b,a), axis = <span class="number">0</span>)</span><br><span class="line">c3 = np.concatenate((a,b,b,a), axis = <span class="number">1</span>)</span><br><span class="line">c4 = np.concatenate((a,b,b,a), axis = <span class="literal">None</span>)</span><br><span class="line">print(c1, c2, c3, c4, sep=<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h1 id="array-split">7 Array split</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.arange(<span class="number">2</span>, <span class="number">14</span>).reshape(<span class="number">3</span>, <span class="number">4</span>) <span class="comment"># 3x4</span></span><br><span class="line">print(a)</span><br><span class="line">print(np.split(a, <span class="number">3</span>, axis = <span class="number">0</span>)) <span class="comment"># vertical</span></span><br><span class="line">print(np.split(a, <span class="number">2</span>, axis = <span class="number">1</span>)) <span class="comment">#horizontal</span></span><br><span class="line"><span class="comment"># 只能进行相等的分割</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>np.split(ary, indices_or sections, axis = 0)</strong></li>
</ul>
<p>Array to be divided into multiple sub-arrays along the given 'axis ', if such split is not possible, then an error will be rasied.</p>
<h1 id="array-copy">8 Array copy</h1>
<ul>
<li><strong>Copy and deep copy</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.arange(<span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line">b = a <span class="comment"># shallow copy</span></span><br><span class="line">a[<span class="number">0</span>] = <span class="number">10</span></span><br><span class="line">print(a, b)</span><br><span class="line">b1 = a.copy() <span class="comment"># deep copy</span></span><br><span class="line">a[<span class="number">0</span>] = <span class="number">20</span></span><br><span class="line">print(a, b1)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Numpy</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Data analysis</tag>
        <tag>Numpy</tag>
      </tags>
  </entry>
  <entry>
    <title>PDF_test</title>
    <url>/2020/12/01/PDF-test/</url>
    <content><![CDATA[<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% pdf https://yangsuoly.com/file/Latex-Notes.pdf %&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Latex</category>
      </categories>
      <tags>
        <tag>Latex</tag>
      </tags>
  </entry>
  <entry>
    <title>Pandas</title>
    <url>/2020/11/27/Pandas/</url>
    <content><![CDATA[<h1 id="series">1 Series</h1>
<h2 id="preparation">1.1 Preparation</h2>
<ul>
<li>Import modules <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="different-data-type">1.2 Different data type</h2>
<ul>
<li><p>Time type <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>t = pd.Timestamp(<span class="string">&#x27;20180901&#x27;</span>) <span class="comment"># time type</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>t</span><br><span class="line">Timestamp(<span class="string">&#x27;2018-09-01 00:00:00&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<p>Created by means of <code>data_range</code>. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>dates = pd.date_range(<span class="string">&#x27;20200101&#x27;</span>, periods = <span class="number">6</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dates</span><br><span class="line">DatetimeIndex([<span class="string">&#x27;2020-01-01&#x27;</span>, <span class="string">&#x27;2020-01-02&#x27;</span>, <span class="string">&#x27;2020-01-03&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;2020-01-04&#x27;</span>,<span class="string">&#x27;2020-01-05&#x27;</span>, <span class="string">&#x27;2020-01-06&#x27;</span>],</span><br><span class="line">           dtype=<span class="string">&#x27;datetime64[ns]&#x27;</span>, freq=<span class="string">&#x27;D&#x27;</span>)</span><br></pre></td></tr></table></figure> <a id="more"></a></p></li>
</ul>
<h2 id="create-dataframe">1.3 Create DataFrame</h2>
<ul>
<li><p>By dict <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># create a dataframe based on dict</span></span><br><span class="line">df3 = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:<span class="number">1.</span>, <span class="string">&#x27;B&#x27;</span>:pd.Timestamp(<span class="string">&#x27;20160901&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;C&#x27;</span>:pd.Series(<span class="number">1</span>,index=<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>)),dtype=<span class="string">&#x27;float32&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;D&#x27;</span>:np.array([<span class="number">3</span>]*<span class="number">4</span>, dtype =<span class="string">&#x27;int32&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;E&#x27;</span>:pd.Categorical([<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>]),</span><br><span class="line">      <span class="string">&#x27;F&#x27;</span>:<span class="string">&#x27;foo&#x27;</span>&#125;)</span><br><span class="line">print(df3)</span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">    A       B         C    D     E      F</span><br><span class="line"><span class="number">0</span>  <span class="number">1.0</span>  <span class="number">2016</span>-09-01   <span class="number">1.0</span>   <span class="number">3</span>    test   foo</span><br><span class="line"><span class="number">1</span>  <span class="number">1.0</span>  <span class="number">2016</span>-09-01   <span class="number">1.0</span>   <span class="number">3</span>   train   foo</span><br><span class="line"><span class="number">2</span>  <span class="number">1.0</span>  <span class="number">2016</span>-09-01   <span class="number">1.0</span>   <span class="number">3</span>    test   foo</span><br><span class="line"><span class="number">3</span>  <span class="number">1.0</span>  <span class="number">2016</span>-09-01   <span class="number">1.0</span>   <span class="number">3</span>   train   foo</span><br></pre></td></tr></table></figure></p></li>
<li><p>By Series <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># np.nan means NaN</span></span><br><span class="line">s = pd.Series([<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, np.nan, <span class="number">44</span>, <span class="number">1</span>])</span><br><span class="line">print(s)</span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>     <span class="number">1.0</span></span><br><span class="line"><span class="number">1</span>     <span class="number">3.0</span></span><br><span class="line"><span class="number">2</span>     <span class="number">5.0</span></span><br><span class="line"><span class="number">3</span>     NaN</span><br><span class="line"><span class="number">4</span>    <span class="number">44.0</span></span><br><span class="line"><span class="number">5</span>     <span class="number">1.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure></p></li>
<li><p>By np.array <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># create a dataframe based on imported array</span></span><br><span class="line">df0 = pd.DataFrame(np.random.randn(<span class="number">6</span>,<span class="number">4</span>), index = dates, columns = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>])</span><br><span class="line">df1 = pd.DataFrame(np.arange(<span class="number">12</span>).reshape(<span class="number">3</span>,<span class="number">4</span>))</span><br><span class="line">print(df1, df3, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="basic-information">1.4 Basic information</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df3 = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:<span class="number">1.</span>, <span class="string">&#x27;B&#x27;</span>:pd.Timestamp(<span class="string">&#x27;20160901&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;C&#x27;</span>:pd.Series(<span class="number">1</span>,index=<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>)),dtype=<span class="string">&#x27;float32&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;D&#x27;</span>:np.array([<span class="number">3</span>]*<span class="number">4</span>, dtype =<span class="string">&#x27;int32&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;E&#x27;</span>:pd.Categorical([<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>]),</span><br><span class="line">      <span class="string">&#x27;F&#x27;</span>:<span class="string">&#x27;foo&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Dtype of each dimensional <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df3.dtypes <span class="comment"># dimensional type</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Row and column index <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df3.index <span class="comment"># row index name</span></span><br><span class="line">df3.columns <span class="comment"># column name</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Statistical description</p>
<p>Describe numerical characteristics, including count, mean, std, min etc. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df3.describe() <span class="comment"># describe numerical characteristics, including count, mean, std, min etc.</span></span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">        A    C    D</span><br><span class="line">count  <span class="number">4.0</span>  <span class="number">4.0</span>  <span class="number">4.0</span></span><br><span class="line">mean   <span class="number">1.0</span>  <span class="number">1.0</span>  <span class="number">3.0</span></span><br><span class="line">std    <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">0.0</span></span><br><span class="line"><span class="built_in">min</span>    <span class="number">1.0</span>  <span class="number">1.0</span>  <span class="number">3.0</span></span><br><span class="line"><span class="number">25</span>%    <span class="number">1.0</span>  <span class="number">1.0</span>  <span class="number">3.0</span></span><br><span class="line"><span class="number">50</span>%    <span class="number">1.0</span>  <span class="number">1.0</span>  <span class="number">3.0</span></span><br><span class="line"><span class="number">75</span>%    <span class="number">1.0</span>  <span class="number">1.0</span>  <span class="number">3.0</span></span><br><span class="line"><span class="built_in">max</span>    <span class="number">1.0</span>  <span class="number">1.0</span>  <span class="number">3.0</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>information <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df3.info()</span><br></pre></td></tr></table></figure> Result: <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;</span><br><span class="line">Int64Index: 4 entries, 0 to 3</span><br><span class="line">Data columns (total 6 columns):</span><br><span class="line"> #   Column  Non-Null Count  Dtype         </span><br><span class="line">---  ------  --------------  -----         </span><br><span class="line"> 0   A       4 non-null      float64       </span><br><span class="line"> 1   B       4 non-null      datetime64[ns]</span><br><span class="line"> 2   C       4 non-null      float32       </span><br><span class="line"> 3   D       4 non-null      int32         </span><br><span class="line"> 4   E       4 non-null      category      </span><br><span class="line"> 5   F       4 non-null      object        </span><br><span class="line">dtypes: category(1), datetime64[ns](1), float32(1), float64(1), int32(1), object(1)</span><br><span class="line">memory usage: 288.0+ bytes</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="data-type">1.5 Data type</h2>
<ul>
<li><p>Specifies the type when creation <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">dfx = pd.DataFrame([[<span class="string">&#x27;11&#x27;</span>, <span class="number">1.2</span>, <span class="number">3</span>], [<span class="string">&#x27;22&#x27;</span>, <span class="number">4.8</span>, <span class="number">5</span>],],</span><br><span class="line">    columns = <span class="built_in">list</span>(<span class="string">&#x27;abc&#x27;</span>), dtype = np.<span class="built_in">object</span>)</span><br><span class="line">dfx.dtypes</span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a       <span class="built_in">object</span></span><br><span class="line">b       <span class="built_in">object</span></span><br><span class="line">c       <span class="built_in">object</span></span><br><span class="line">dtype:  <span class="built_in">object</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Coercion <code>df.astype()</code> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dfx[[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]] = dfx[[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]].astype(<span class="string">&#x27;float&#x27;</span>))</span><br><span class="line">dfx.dtypes</span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a       float64</span><br><span class="line">b       float64</span><br><span class="line">c       float64</span><br><span class="line">dtype:  <span class="built_in">object</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Turn into numeric <code>pd.to_numeric()</code> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dfy = pd.DataFrame([[<span class="string">&#x27;11&#x27;</span>, <span class="number">1.2</span>, <span class="number">3</span>], [<span class="string">&#x27;22&#x27;</span>, <span class="number">4.8</span>, <span class="string">&#x27;?&#x27;</span>], ],</span><br><span class="line">        columns = <span class="built_in">list</span>(<span class="string">&#x27;abc&#x27;</span>), dtype = np.<span class="built_in">object</span>)</span><br><span class="line">dfy[<span class="string">&#x27;a&#x27;</span>] = pd.to_numeric(dfy[<span class="string">&#x27;a&#x27;</span>])</span><br><span class="line">print(dfy.dtypes)</span><br></pre></td></tr></table></figure></p>
<p>Use <code>pd.apply</code> to apply it to the entire dataframe. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dfy1 = dfy.apply(pd.to_numeric, errors = <span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"> <span class="comment"># Igonre and don&#x27;t change this column when meet errors,</span></span><br><span class="line">dfy2 = dfy.apply(pd.to_numeric, errors = <span class="string">&#x27;coerce&#x27;</span>)</span><br><span class="line"> <span class="comment"># Transfer the value into NaN when meet errors.</span></span><br><span class="line">print(dfy.dtypes)</span><br><span class="line">print(<span class="string">&#x27;-------------------------&#x27;</span>)</span><br><span class="line">print(dfy2)</span><br></pre></td></tr></table></figure> Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a       int64</span><br><span class="line">b       float64</span><br><span class="line">c       float64</span><br><span class="line">dtype:  <span class="built_in">object</span></span><br><span class="line">-------------------------</span><br><span class="line">    a   b    c</span><br><span class="line"><span class="number">0</span>  <span class="number">11</span>  <span class="number">1.2</span>  <span class="number">3.0</span></span><br><span class="line"><span class="number">1</span>  <span class="number">22</span>  <span class="number">4.8</span>  NaN</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h1 id="choose-data">2 Choose data</h1>
<h2 id="basic-operation">2.1 Basic operation</h2>
<ul>
<li><p>Import modules and generate datas <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:<span class="number">1.</span>, <span class="string">&#x27;B&#x27;</span>:pd.Timestamp(<span class="string">&#x27;20160901&#x27;</span>),</span><br><span class="line">       <span class="string">&#x27;C&#x27;</span>:pd.Series(<span class="number">1</span>,index=<span class="built_in">list</span>(arange(<span class="number">4</span>)),dtype=<span class="string">&#x27;float32&#x27;</span>),</span><br><span class="line">       <span class="string">&#x27;D&#x27;</span>:np.array([<span class="number">3</span>]*<span class="number">4</span>, dtype =<span class="string">&#x27;int32&#x27;</span>),</span><br><span class="line">       <span class="string">&#x27;E&#x27;</span>:pd.Categorical([<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>]),</span><br><span class="line">       <span class="string">&#x27;F&#x27;</span>:<span class="string">&#x27;foo&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Row operation <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df2 = df[<span class="number">0</span>:<span class="number">3</span>] <span class="comment"># row operation, 0-3 row</span></span><br><span class="line">df2_1 = df[<span class="number">0</span>:<span class="number">1</span>] <span class="comment"># single row</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Column operation <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df1 = df.A <span class="comment"># same sa df.[&#x27;A&#x27;]</span></span><br><span class="line">df2_2 = df[<span class="string">&#x27;A&#x27;</span>] <span class="comment"># single column</span></span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="index-methods">2.2 Index methods</h2>
<ul>
<li><p><code>loc</code></p>
<p>Select datas by label based index. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># select by label based index: loc</span></span><br><span class="line">df3 = df.loc[<span class="number">1</span>] <span class="comment"># the second row</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><code>iloc</code></p>
<p>Select datas by postitional index. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># selct by postitional index: iloc</span></span><br><span class="line">df4 = df.iloc[:,<span class="number">1</span>:<span class="number">3</span>] <span class="comment"># 1-3 column</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><code>ix</code></p>
<p>Select datas by mixed selection. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mixed selection: ix</span></span><br><span class="line">df5 = df.ix[:<span class="number">2</span>,[<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;D&#x27;</span>]] <span class="comment"># deprecated</span></span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="conditional-operation">2.3 Conditional operation</h2>
<ul>
<li>Logic expression <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df6 = df[df[<span class="string">&#x27;A&#x27;</span>] &gt; <span class="number">4</span>]</span><br></pre></td></tr></table></figure> <code>df['A'] &gt; 4</code> return the row index which number is bigger than 4, let me name this index as <code>iRow</code>, then <code>df[iRow]</code> return the row date that meets above filter condition.</li>
</ul>
<h2 id="functional-methods">2.4 Functional methods</h2>
<ul>
<li><code>tail</code> <code>df.tail(n)</code> returns last <code>n</code> rows from the DataFrame object based on position. It is useful for quickly verifying data. For negative values of <code>n</code>, it returns all rows except the first <code>n</code> rows, equivalent to <code>df[n:]</code>. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.tail() <span class="comment"># Default n is 5</span></span><br><span class="line">df.tail(<span class="number">3</span>) <span class="comment"># Return last 3 rows</span></span><br><span class="line">df.tail(-<span class="number">5</span>) <span class="comment"># Return all rows except the first 5 row.</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="dataframe-operation">3 DataFrame operation</h1>
<ul>
<li>Preparation <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:<span class="number">1.</span>, <span class="string">&#x27;B&#x27;</span>:pd.Timestamp(<span class="string">&#x27;20160901&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>:pd.Series(<span class="number">1</span>,index=<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>)),dtype=<span class="string">&#x27;float32&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span>:np.array([<span class="number">3</span>]*<span class="number">4</span>, dtype =<span class="string">&#x27;int32&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;E&#x27;</span>:pd.Categorical([<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>]),</span><br><span class="line">    <span class="string">&#x27;F&#x27;</span>:<span class="string">&#x27;foo&#x27;</span>&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="value-operation">3.1 Value operation</h2>
<ul>
<li><p>Set value</p>
<p>Pay attention to the difference. <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.iloc[<span class="number">2</span>, <span class="number">2</span>] = <span class="number">111</span></span><br><span class="line">df.loc[<span class="number">0</span>,<span class="string">&#x27;B&#x27;</span>] = pd.Timestamp(<span class="string">&#x27;20180901&#x27;</span>)</span><br><span class="line"><span class="comment"># Note: below command will create a new column named (0, &#x27;B&#x27;) which values are given</span></span><br><span class="line">df[<span class="number">0</span>,<span class="string">&#x27;B&#x27;</span>] = pd.Timestamp(<span class="string">&#x27;20180901&#x27;</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Change value</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.iloc[<span class="number">2</span>, <span class="number">2</span>] = <span class="number">111</span></span><br><span class="line">df.loc[<span class="number">0</span>,<span class="string">&#x27;C&#x27;</span>] = np.nan</span><br></pre></td></tr></table></figure></li>
<li><p>Fillna <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Fill NaN, can&#x27;t do it with df.fillna(0)</span></span><br><span class="line">df[<span class="string">&#x27;C&#x27;</span>] = df[<span class="string">&#x27;C&#x27;</span>].fillna(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># maybe below command also can work?</span></span><br><span class="line">df_1 = df.fillna(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Dropna <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Drop NaN</span></span><br><span class="line">df.dropna(axis =<span class="number">0</span>, how = <span class="string">&#x27;any&#x27;</span>)</span><br><span class="line"><span class="comment"># how = [&#x27;any, &#x27;all&#x27;], default is any</span></span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="advance-operation">3.2 Advance operation</h2>
<ul>
<li><p>isnull <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.isnull() <span class="comment"># find which position is null, return a dataframe same size as df</span></span><br><span class="line">np.<span class="built_in">any</span>(df.isnull()) == <span class="literal">True</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Transpose <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.T</span><br><span class="line">df.transpose() <span class="comment"># transpose array</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Sort <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.sort_index(axis = <span class="number">1</span>, ascending = <span class="literal">False</span>)</span><br><span class="line"><span class="comment"># horizontal descending sort</span></span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="delete-values">3.3 Delete values</h2>
<p>Deleting one columns from DataFrame. Preparation: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:<span class="number">1.</span>, <span class="string">&#x27;B&#x27;</span>:pd.Timestamp(<span class="string">&#x27;20160901&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>:pd.Series(<span class="number">1</span>,index=<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>)),dtype=<span class="string">&#x27;float32&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span>:np.array([<span class="number">3</span>]*<span class="number">4</span>, dtype =<span class="string">&#x27;int32&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;E&#x27;</span>:pd.Categorical([<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>]),</span><br><span class="line">    <span class="string">&#x27;F&#x27;</span>:<span class="string">&#x27;foo&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure> Representing: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">     A          B    C  D      E    F</span><br><span class="line"><span class="number">0</span>  <span class="number">1.0</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>   test  foo</span><br><span class="line"><span class="number">1</span>  <span class="number">1.0</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>  train  foo</span><br><span class="line"><span class="number">2</span>  <span class="number">1.0</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>   test  foo</span><br><span class="line"><span class="number">3</span>  <span class="number">1.0</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>  train  foo</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p><code>del</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">del</span> df[<span class="string">&#x27;A&#x27;</span>] <span class="comment"># Delete A column from A, and A will change</span></span><br></pre></td></tr></table></figure>
<p>Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">           B    C  D      E    F</span><br><span class="line"><span class="number">0</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>   test  foo</span><br><span class="line"><span class="number">1</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>  train  foo</span><br><span class="line"><span class="number">2</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>   test  foo</span><br><span class="line"><span class="number">3</span> <span class="number">2016</span>-09-01  <span class="number">1.0</span>  <span class="number">3</span>  train  foo</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>drop</code></p></li>
</ul>
<p>Adopting <code>drop</code> function, there are three equivalent expression.</p>
<p>直接输入 <code>df.drop('column', 1)</code>，不会改变内存，再次输入 <code>df</code> 时，还是显示原数据。 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>:<span class="number">1.</span>, <span class="string">&#x27;B&#x27;</span>:pd.Timestamp(<span class="string">&#x27;20160901&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>:pd.Series(<span class="number">1</span>,index=<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">4</span>)),dtype=<span class="string">&#x27;float32&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span>:np.array([<span class="number">3</span>]*<span class="number">4</span>, dtype =<span class="string">&#x27;int32&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;E&#x27;</span>:pd.Categorical([<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>,<span class="string">&#x27;test&#x27;</span>,<span class="string">&#x27;train&#x27;</span>]),</span><br><span class="line">    <span class="string">&#x27;F&#x27;</span>:<span class="string">&#x27;foo&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line">df1 = df.drop(<span class="string">&#x27;A&#x27;</span>, axis = <span class="number">1</span>)</span><br><span class="line">df2 = df.drop(<span class="string">&#x27;column_name&#x27;</span>, axis=<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure> 注：<code>aixs = 1</code> 表示该命令的操作聚焦于列这一维度。<code>inplace</code> 表示是否改变内存。默认为 <code>False</code>。</p>
<h1 id="merge-dataframes">4 Merge dataframes</h1>
<ul>
<li>Preparation <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 array multiply o is o</span></span><br><span class="line">df1 = pd.DataFrame(np.ones((<span class="number">3</span>, <span class="number">4</span>)) * <span class="number">0</span>, columns = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>])</span><br><span class="line">df2 = pd.DataFrame(np.ones((<span class="number">3</span>, <span class="number">4</span>)) * <span class="number">1</span>, columns = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>])</span><br><span class="line">df3 = pd.DataFrame(np.ones((<span class="number">3</span>, <span class="number">4</span>)) * <span class="number">2</span>, columns = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>])</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="concatenation">4.1 Concatenation</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">res = pd.concat([df1, df2, df3], axis = <span class="number">0</span>, ignore_index = <span class="literal">True</span>) <span class="comment"># default don&#x27;t ignore index, the difference seen in below pic</span></span><br></pre></td></tr></table></figure>
<p><img src="https://z3.ax1x.com/2020/11/25/DamaCR.png" /></p>
<center>
fig. 1 difference of ignoring index
</center>
<ul>
<li><p><strong>join = ['inner', 'outer']</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">df1 = pd.DataFrame(np.ones((<span class="number">3</span>, <span class="number">4</span>)) * <span class="number">0</span>, columns = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>], index = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">df2 = pd.DataFrame(np.ones((<span class="number">3</span>, <span class="number">4</span>)) * <span class="number">1</span>, columns = [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>], index = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># default join is outer, fill the null space with NaN</span></span><br><span class="line">df3 = pd.concat([df1, df2], axis = <span class="number">0</span>, join = <span class="string">&#x27;outer&#x27;</span>, sort=<span class="literal">False</span>, ignore_index = <span class="literal">True</span>)</span><br><span class="line"><span class="comment"># inner will take the intersection index of two arrays</span></span><br><span class="line">df4 = pd.concat([df1, df2], axis = <span class="number">0</span>, join = <span class="string">&#x27;inner&#x27;</span>, sort=<span class="literal">False</span>, ignore_index = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 df2 合并到 df1，并基于 index 去掉 df2 中有而 df1 没有的数据， 并填充 NaN</span></span><br><span class="line">df5 = pd.concat([df1, df2], axis = <span class="number">1</span>, join_axes = [df1.index])</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="append">4.2 append</h2>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import pandas as pd</span><br><span class="line">import numpy as np</span><br><span class="line"></span><br><span class="line">df1 &#x3D; pd.DataFrame(np.ones((3, 4)) * 0, columns &#x3D; [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;])</span><br><span class="line">df2 &#x3D; pd.DataFrame(np.ones((3, 4)) * 1, columns &#x3D; [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;])</span><br><span class="line">df3 &#x3D; pd.DataFrame(np.ones((3, 4)) * 1, columns &#x3D; [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;])</span><br><span class="line"></span><br><span class="line">res &#x3D; df1.append([df2, df3], ignore_index &#x3D; True)</span><br><span class="line"></span><br><span class="line"># add a row series into a df</span><br><span class="line">s1 &#x3D; pd.Series([1, 2, 3, 4], index &#x3D; [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;])</span><br><span class="line">res1 &#x3D; df1.append(s1, ignore_index &#x3D; True)</span><br></pre></td></tr></table></figure></p>
<h2 id="merge">4.3 merge</h2>
<ul>
<li><p>merged by single key</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">left = pd.DataFrame(&#123;<span class="string">&#x27;key&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K2&#x27;</span>, <span class="string">&#x27;K3&#x27;</span>],<span class="string">&#x27;A&#x27;</span>: [<span class="string">&#x27;A0&#x27;</span>, <span class="string">&#x27;A1&#x27;</span>, <span class="string">&#x27;A2&#x27;</span>, <span class="string">&#x27;A3&#x27;</span>],<span class="string">&#x27;B&#x27;</span>: [<span class="string">&#x27;B0&#x27;</span>, <span class="string">&#x27;B1&#x27;</span>, <span class="string">&#x27;B2&#x27;</span>, <span class="string">&#x27;B3&#x27;</span>]&#125;)</span><br><span class="line">right = pd.DataFrame(&#123;<span class="string">&#x27;key&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K2&#x27;</span>, <span class="string">&#x27;K3&#x27;</span>],<span class="string">&#x27;C&#x27;</span>: [<span class="string">&#x27;C0&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;C2&#x27;</span>, <span class="string">&#x27;C3&#x27;</span>],<span class="string">&#x27;D&#x27;</span>: [<span class="string">&#x27;D0&#x27;</span>, <span class="string">&#x27;D1&#x27;</span>, <span class="string">&#x27;D2&#x27;</span>, <span class="string">&#x27;D3&#x27;</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># merge two dfs based on the same key value</span></span><br><span class="line">res = pd.merge(left, right, on = <span class="string">&#x27;key&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>merged by multiple keys</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">left = pd.DataFrame(&#123;<span class="string">&#x27;key1&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K2&#x27;</span>],<span class="string">&#x27;key2&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>],<span class="string">&#x27;A&#x27;</span>: [<span class="string">&#x27;A0&#x27;</span>, <span class="string">&#x27;A1&#x27;</span>, 		<span class="string">&#x27;A2&#x27;</span>, <span class="string">&#x27;A3&#x27;</span>],<span class="string">&#x27;B&#x27;</span>: [<span class="string">&#x27;B0&#x27;</span>, <span class="string">&#x27;B1&#x27;</span>, <span class="string">&#x27;B2&#x27;</span>, <span class="string">&#x27;B3&#x27;</span>]&#125;)</span><br><span class="line">right = pd.DataFrame(&#123;<span class="string">&#x27;key1&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K2&#x27;</span>],<span class="string">&#x27;key2&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K0&#x27;</span>],<span class="string">&#x27;C&#x27;</span>: [<span class="string">&#x27;C0&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, 		<span class="string">&#x27;C2&#x27;</span>, <span class="string">&#x27;C3&#x27;</span>],<span class="string">&#x27;D&#x27;</span>: [<span class="string">&#x27;D0&#x27;</span>, <span class="string">&#x27;D1&#x27;</span>, <span class="string">&#x27;D2&#x27;</span>, <span class="string">&#x27;D3&#x27;</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># merge two dfs based the same key value, default how = inner</span></span><br><span class="line">res1 = pd.merge(left, right, on = [<span class="string">&#x27;key1&#x27;</span>,<span class="string">&#x27;key2&#x27;</span>])</span><br><span class="line">res2 = pd.merge(left, right, on = [<span class="string">&#x27;key1&#x27;</span>,<span class="string">&#x27;key2&#x27;</span>], how = <span class="string">&#x27;inner&#x27;</span>)</span><br><span class="line">res2 = pd.merge(left, right, on = [<span class="string">&#x27;key1&#x27;</span>,<span class="string">&#x27;key2&#x27;</span>], indicator = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><code>how = ['inner, 'outer','left','right']</code>, if <code>how = 'right'</code>, this operation will fill left void space with NaN when left haven't same key value with right, then merge into right.</p>
<p>default <code>indicator</code> is <code>False</code>, this parameter will create a new column named _merge(indicator = 'indicator_column', then the new column's name is indicator_column), which show if both arrays have a meanful value.</p></li>
<li><p>merged by index</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">left = pd.DataFrame(&#123;<span class="string">&#x27;A&#x27;</span>: [<span class="string">&#x27;A0&#x27;</span>, <span class="string">&#x27;A1&#x27;</span>, <span class="string">&#x27;A2&#x27;</span>, <span class="string">&#x27;A3&#x27;</span>],<span class="string">&#x27;B&#x27;</span>: [<span class="string">&#x27;B0&#x27;</span>, <span class="string">&#x27;B1&#x27;</span>, <span class="string">&#x27;B2&#x27;</span>, <span class="string">&#x27;B3&#x27;</span>]&#125;, index = [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K2&#x27;</span>,<span class="string">&#x27;K4&#x27;</span>])</span><br><span class="line">right = pd.DataFrame(&#123;<span class="string">&#x27;C&#x27;</span>: [<span class="string">&#x27;C0&#x27;</span>, <span class="string">&#x27;C1&#x27;</span>, <span class="string">&#x27;C2&#x27;</span>, <span class="string">&#x27;C3&#x27;</span>],<span class="string">&#x27;D&#x27;</span>: [<span class="string">&#x27;D0&#x27;</span>, <span class="string">&#x27;D1&#x27;</span>, <span class="string">&#x27;D2&#x27;</span>, <span class="string">&#x27;D3&#x27;</span>]&#125;, index = [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K3&#x27;</span>,<span class="string">&#x27;K5&#x27;</span>])</span><br><span class="line">print(left, right, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># left_index and right_index</span></span><br><span class="line">res1 = pd.merge(left, right, left_index = <span class="literal">True</span>, right_index = <span class="literal">True</span>, how = <span class="string">&#x27;inner&#x27;</span>) <span class="comment"># based on left_index = right_index</span></span><br><span class="line">res2 = pd.merge(left, right, left_index = <span class="literal">True</span>, right_index = <span class="literal">True</span>, how = <span class="string">&#x27;outer&#x27;</span>) <span class="comment"># fill the blank with NaN</span></span><br></pre></td></tr></table></figure></li>
<li><p>suffixes para</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">boys = pd.DataFrame(&#123;<span class="string">&#x27;K&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K2&#x27;</span>,<span class="string">&#x27;K4&#x27;</span>],<span class="string">&#x27;age&#x27;</span>: [<span class="number">11</span>, <span class="number">23</span>, <span class="number">32</span>, <span class="number">12</span>]&#125;)</span><br><span class="line">girls = pd.DataFrame(&#123;<span class="string">&#x27;K&#x27;</span>: [<span class="string">&#x27;K0&#x27;</span>, <span class="string">&#x27;K1&#x27;</span>, <span class="string">&#x27;K2&#x27;</span>,<span class="string">&#x27;K4&#x27;</span>],<span class="string">&#x27;age&#x27;</span>: [<span class="number">14</span>, <span class="number">43</span>, <span class="number">12</span>, <span class="number">22</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># suffixex means the named methods of same positional column</span></span><br><span class="line">res = pd.merge(boys, girls, on = <span class="string">&#x27;K&#x27;</span>, suffixes = [<span class="string">&#x27;_boys&#x27;</span>, <span class="string">&#x27;_girls&#x27;</span>], how = <span class="string">&#x27;inner&#x27;</span>)</span><br><span class="line">print(res) <span class="comment">#  age_boys  age_girls</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="read-and-save-file">5 Read and save file</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">data = pd.read_csv(<span class="string">&#x27;xx.csv&#x27;</span>) <span class="comment"># read</span></span><br><span class="line">data.to_csv(<span class="string">&#x27;xxx.csv&#x27;</span>) <span class="comment"># save file</span></span><br></pre></td></tr></table></figure>
<h1 id="matplotlib">6 matplotlib</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">data1 = pd.Series(np.random.randn(<span class="number">1000</span>), index = np.arange(<span class="number">1000</span>))</span><br><span class="line">data2 = pd.DataFrame(np.random.randn(<span class="number">1000</span>, <span class="number">4</span>), index = np.arange(<span class="number">1000</span>), columns = <span class="built_in">list</span>(<span class="string">&#x27;ABCD&#x27;</span>))</span><br><span class="line"><span class="comment"># print(data1, data2, sep = &#x27;\n&#x27;)</span></span><br><span class="line">data1 = data1.cumsum()</span><br><span class="line">data2 = data2.cumsum()</span><br><span class="line"><span class="comment"># print(data)</span></span><br><span class="line">data1.plot()</span><br><span class="line">data2.plot()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<ul>
<li><p>plot methods</p>
<p>bar, hist, box, kde, area, scatter, hexbin, pie</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">data = pd.DataFrame(np.random.randn(<span class="number">1000</span>, <span class="number">4</span>), index = np.arange(<span class="number">1000</span>), columns = <span class="built_in">list</span>(<span class="string">&#x27;ABCD&#x27;</span>))</span><br><span class="line"></span><br><span class="line">data = data.cumsum()</span><br><span class="line"></span><br><span class="line">ax = data.plot.scatter(x = <span class="string">&#x27;A&#x27;</span>, y = <span class="string">&#x27;B&#x27;</span>,color = <span class="string">&#x27;DarkBlue&#x27;</span>, label = <span class="string">&#x27;Class1&#x27;</span>)</span><br><span class="line">data.plot.scatter(x = <span class="string">&#x27;A&#x27;</span>, y = <span class="string">&#x27;C&#x27;</span>,color = <span class="string">&#x27;DarkGreen&#x27;</span>,label = <span class="string">&#x27;Class2&#x27;</span>,ax = ax)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://z3.ax1x.com/2020/11/25/Damd81.png" /></p>
<center>
<p>fig. 2 scatter figure</p>
</center></li>
</ul>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Pandas</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Data analysis</tag>
        <tag>Pandas</tag>
      </tags>
  </entry>
  <entry>
    <title>Prediction methods</title>
    <url>/2020/12/05/Prediction-methods/</url>
    <content><![CDATA[<h1 id="differential-equation-model">1 Differential equation model</h1>
<h2 id="introduction">1.1 Introduction</h2>
<ul>
<li>特点</li>
</ul>
<p>当描述实际对象的某些特征随时间（或空间）而演变的过程、分析它的变化规律、预测它的未来形态、研究它的控制手段时，通常需要建立对象的 <strong>动态微分方程模型</strong>。</p>
<p>微分模型求解的结果就是问题的答案，该答案是 <strong>唯一</strong> 的。</p>
<ul>
<li>典型的模型：
<ul>
<li>传染病的预测模型</li>
<li>经济增长预测模型</li>
<li>兰彻斯特（Lanchester）战争预测模型</li>
<li>药物在体内的分布于排除预测模型</li>
<li>人口的预测模型</li>
<li>烟雾的扩散与消失模型</li>
</ul></li>
</ul>
<p>模型的基本规律随着时间的增长趋势呈指数形式，根据变量的个数建立微分方程。</p>
<a id="more"></a>
<ul>
<li><strong>优点</strong></li>
</ul>
<p>短、中、长期的预测都能适用，既能反应 <strong>内部规律</strong> 以及 <strong>事物的内在关系</strong>，也能分析两个因素的 <strong>相关关系</strong>，精度相应的比较高，另外对模型的改进也比较容易理解和实现。</p>
<ul>
<li><strong>缺点</strong></li>
</ul>
<p>虽然反应的是内部规律，但由于方程的建立是以局部规律的独立性假定为基础，故中长期预测 <strong>偏差有点大</strong>，且 <strong>解较难得到</strong>。</p>
<h2 id="case">1.2 Case</h2>
<ul>
<li><p>Problem</p>
<p>硫黄岛位于东京以南 660 英里的海面上，是日军的重要空军基地。美军在1945 年2 月开始进攻，激烈的战斗持续了一个月，双方伤亡惨重，日方守军21500 人全部阵亡或被俘，美方投入兵力73000 人，伤亡20265 人，战争进行到28 天时美军宣布占领该岛，实际战斗到36 天才停止。美军的战地记录有按天统计的战斗减员和增援情况。日军没有后援，战地记录则全部遗失。</p></li>
<li><p>Solution Code</p>
<figure class="highlight matlab"><table><tr><td class="code"><pre><span class="line">dxy=@(t,x)[<span class="number">-0.0544</span>*x(<span class="number">2</span>)+<span class="number">54000</span>*(t&gt;=<span class="number">0</span> &amp; t&lt;<span class="number">1</span>)+<span class="number">6000</span>*(t&gt;=<span class="number">2</span> &amp; t&lt;<span class="number">3</span>)+<span class="number">13000</span>*(t&gt;=<span class="number">5</span> &amp; t&lt;<span class="number">6</span>)</span><br><span class="line">    <span class="number">-0.0106</span>*x(<span class="number">1</span>)];  <span class="comment">%用匿名函数定义方程右端项，这里用逻辑语句定义分段函数</span></span><br><span class="line">[t,xy]=ode45(dxy,[<span class="number">0</span>:<span class="number">36</span>],[<span class="number">0</span>,<span class="number">21500</span>])</span><br><span class="line">subplot(<span class="number">211</span>), <span class="built_in">plot</span>(t,xy(:,<span class="number">1</span>),<span class="string">&#x27;r*&#x27;</span>,t,xy(:,<span class="number">2</span>),<span class="string">&#x27;gD&#x27;</span>)</span><br><span class="line">xlabel(<span class="string">&#x27;时间t&#x27;</span>),  ylabel(<span class="string">&#x27;人数&#x27;</span>), <span class="built_in">legend</span>(<span class="string">&#x27;美军&#x27;</span>,<span class="string">&#x27;日军&#x27;</span>)</span><br><span class="line">subplot(<span class="number">212</span>),  <span class="built_in">plot</span>(xy(:,<span class="number">1</span>),xy(:,<span class="number">2</span>))  <span class="comment">%画微分方程组的轨线</span></span><br><span class="line">xlabel(<span class="string">&#x27;美军人数x&#x27;</span>),  ylabel(<span class="string">&#x27;日军人数y&#x27;</span>)  </span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/12/05/DLrAIJ.png" /></p>
<center>
<p>Fig. 1-1 Result of case 1</p>
</center></li>
</ul>
<h1 id="grey-model">2 Grey model</h1>
<h2 id="introduction-1">2.1 Introduction</h2>
<ul>
<li><p>主要特点</p>
<p>模型使用的不是原始数据序列，而是生成的数据序列，其核心体系是 <strong>灰色模型（Grey model, GM）</strong>， 即对原始数据作 <strong>累加生成</strong> 得到近似的 <strong>指数规律 </strong>再进行建模的方法。</p></li>
<li><p><strong>优点</strong></p>
<ul>
<li>不需要很多的数据，一般只需要4个数据，就能解决<strong>历史数据少、序列的完整性及可靠性低</strong>的问题；</li>
<li>能利用微分方程来充分挖掘系统的本质，精度高；</li>
<li>能将无规律的原始数据进行生成得到规律性较强的生成序列，预算简便，易于检验，不考虑分布规律，不考虑变化趋势。</li>
</ul></li>
<li><p><strong>缺点</strong></p>
<p>只适用于 <strong>中短期的预测</strong>，只适合 <strong>指数增长的预测</strong>。</p></li>
</ul>
<h2 id="categories">2.2 Categories</h2>
<h3 id="gm1-1-forecasting-model">2.2.1 GM(1, 1) forecasting model</h3>
<p>GM(1, 1) denotes the grey model is a <strong>first order difference equation</strong> and only include <strong>one variable</strong>.</p>
<p>Not finished, to be continued...</p>
<h3 id="gm2-1-dgm-and-verhulst-model">2.2.2 GM(2, 1), DGM and Verhulst model</h3>
<p>GM(1, 1) 模型适用于具有较强 <strong>指数规律</strong> 的序列，只能描述单调的变化过程，对于<strong>非单调的摆动发展序列</strong>或 <strong>有饱和的 S 形序列</strong>，可以考虑建立 GM(2, 1), DGM and Verhulst model。</p>
<ul>
<li><p>灰色 Verhulst 预测模型</p>
<p>Verhulst 模型主要用来描述具有剥和状态的过程，即 S 形过程，常用于</p>
<ul>
<li>人口预测</li>
<li>生物生长</li>
<li>繁殖预测</li>
<li>产品经济寿命预测</li>
</ul></li>
</ul>
<h1 id="difference-equation">3 Difference equation</h1>
<h2 id="introduction-2">3.1 Introduction</h2>
<p>在利用差分方程建模研究实际问题时，常需要根据统计数据用 <strong>最小二乘法</strong> 来 <strong>拟合 </strong>出差分方程的 <strong>系数</strong>。其系统稳定性讨论要用到代数方程的求根。</p>
<h3 id="一阶自回归ar1">3.1.1 一阶自回归（AR(1)）</h3>
<p>由于时间序列一般存在自相关，故最简单的预测方法为，使用过去值 <span class="math inline">\(y_{t-1}\)</span> 来预测当前值 <span class="math inline">\(y_{t}\)</span> ，即一阶自回归模型（AR(1)） <span class="math display">\[
y_t = \beta_0 + \beta_1 y_{t-1} + \varepsilon_t \ \ (t = 2, \dots, T)
\]</span> 其中，扰动项 <span class="math inline">\(\varepsilon_t\)</span> 为白噪声，故无自相关，即 <span class="math inline">\(\rm{Cov}(\varepsilon_t,\ \varepsilon_s) = 0, \forall t \neq s\)</span>。假设自回归系数 $|_1| &lt; 1 $，则 $ {y_t}$ 为渐进独立的平稳过程。</p>
<h3 id="高阶自回归arp">3.1.2 高阶自回归（AR(p)）</h3>
<p>在 AR(1) 模型中，假设扰动项为无自相关，故可用 <span class="math inline">\(OLS\)</span> 进行一致的估计。<strong>然而</strong>， 如果模型为 AR(2)，但却被误设为 AR(1)，则意味着二阶滞后项 <span class="math inline">\(\beta_2 y_{t-2}\)</span> 被纳入扰动项： <span class="math display">\[
y_t = \beta_0 + \beta_1 y_{t-1} + (\beta_2 y_{t-2} + \varepsilon_t)
\]</span> 其中，由于扰动项为 $(<em>2 y</em>{t-2} + _t) $，故扰动项与解释变量 <span class="math inline">\(y_{t-1}\)</span> 相关，因为 <span class="math inline">\(\rm{Cov}(y_{t-1},\ y_{t-2}) \neq 0\)</span>。此时，扰动项存在自相关，<span class="math inline">\(OLS\)</span> 不再一致，需引入 <span class="math inline">\(\beta_2 y_{t-2}\)</span> 才能得到一致估计。</p>
<p>另外，从预测的角度来看，更高阶的滞后项也可能包含有用的信息。为此，更一般地，考虑 $ p$ 阶自回归模型，记为 <span class="math inline">\(AR(p)\)</span>： <span class="math display">\[
y_t = \beta_0 + \beta_1 y_{t-1} + \dots + \beta_p y_{t-p} + \varepsilon_t
\]</span> 其中，扰动项 <span class="math inline">\(\varepsilon_t\)</span> 为白噪声，无自相关，故 <span class="math inline">\(OLS\)</span> 为一致估计。然而，通常我们并不知道滞后期 <span class="math inline">\(p\)</span>。</p>
<p>估计 <span class="math inline">\(\hat{p}\)</span> 的方法：</p>
<ul>
<li><p>设一个最大滞后期 <span class="math inline">\(p_{\max}\)</span>，然后令 $ = p_{} $ 进行估计，并对最后一个滞后期系数的显著性进行 <span class="math inline">\(t\)</span> 检验。</p>
<p>如果接受该系数为 0，则令 $ = p_{} -1 $，重新进行估计，再对最后一个滞后期的系数进行 <span class="math inline">\(t\)</span> 检验。</p></li>
<li><p>使用信息准则，选择 <span class="math inline">\(\hat{p}\)</span> 使得 <span class="math inline">\(AIC\)</span> 或 <span class="math inline">\(BIC\)</span> 最小化，分别记为 <span class="math inline">\(\hat{p}_{AIC}\)</span> 与 <span class="math inline">\(\hat{p}_{BIC}\)</span>。</p></li>
</ul>
<h3 id="自回归分布滞后模型adl">3.1.3 自回归分布滞后模型（ADL）</h3>
<p>在自回归 <span class="math inline">\(AR(p)\)</span> 中，为提高预测力或解释力，可引入其他解释变量，构成 <strong>自回归分布滞后模型</strong>（Autoregressive Distributed Lag Model, ADL(p, 1) or ARDL(p, q)）。 <span class="math display">\[
y_t = \beta_o + \beta_1 y_{t-1} + \dots + \beta_p y_{t-p} + \gamma_1 x_{t-1} + \dots + \gamma_q x_{t-q} + \varepsilon_t
\]</span> 其中，<span class="math inline">\(p\)</span> 为解释变量 <span class="math inline">\(y\)</span> 的自回归阶数，<span class="math inline">\(q\)</span> 为解释变量 <span class="math inline">\(x\)</span> 的滞后阶数。假定扰动项 <span class="math inline">\(\varepsilon_t\)</span> 为白噪声，则 <span class="math inline">\(OLS\)</span> 为一致估计。</p>
<h3 id="误差修正模型ecm">3.1.4 误差修正模型（ECM）</h3>
<p>ADL 是一种动态模型。从经济理论而言，<strong>相关变量之间可能存在长期的均衡关系，而变量的短期变动则是向着这个长期均衡关系的调整</strong>。ECM 正是这一思想在计量经济学中的体现。</p>
<p>考虑 ADL(1, 1) 模型： <span class="math display">\[
y_t = \beta_o + \beta_1 y_{t-1} + \gamma_1 x_{t-1} + \varepsilon_t
\]</span> 其中，<span class="math inline">\(|\beta_1| &lt; 1\)</span>，故为平稳过程。假设经济理论 认为 <span class="math inline">\((y,\ x)\)</span> 之间存在长期均衡关系： <span class="math display">\[
y = \phi + \theta x
\]</span> 其中，<span class="math inline">\(\phi\)</span> 和 <span class="math inline">\(\theta\)</span> 为待定参数。对方程两边求期望，并令 <span class="math inline">\(y^\star = \rm{E}(y_t) = \rm{E}(y_{t-1})\)</span>， <span class="math inline">\(x^\star = \rm{E}(x_t) = \rm{E}(x_{t-1})\)</span>，可得： <span class="math display">\[
y^\star = \frac{\beta_0}{1-\beta_1} + \frac{\gamma_1}{1-\beta_1} x^\star
\]</span> 所以，<span class="math inline">\(\phi = \frac{\beta_0}{1-\beta_1}\)</span>， <span class="math inline">\(\theta = \frac{\gamma_0}{1-\beta_1}\)</span>。其中 $ $ 即为长期程数，衡量当 <span class="math inline">\(x\)</span> 永久性变化 1 单位时，将导致 <span class="math inline">\(y\)</span> 的永久变化幅度。在方程（5）两边同时减去 <span class="math inline">\(y_{t-1}\)</span> 得： <span class="math display">\[
\Delta y_t = (\beta_1 -1)(y_{t-1} - \phi - \theta x_{t-1}) + \varepsilon_t
\]</span> 其中，<span class="math inline">\((y_{t-1} - \phi - \theta x_{t-1})\)</span> 衡量上一期对均衡条件 <span class="math inline">\(y = \phi + \theta x\)</span> 的偏离（误差），而 <span class="math inline">\((\beta_1 -1)(y_{t-1} - \phi - \theta x_{t-1})\)</span> 为根据上期的误差做的反向修正，成为 <code>误差修正项</code>。</p>
<ul>
<li><p>ECM 优点</p>
<p>一般 ADL 模型都可转化为 ECM 模型。ECM 模型经济含义十分明确，而且可以分别考察长期效益（长期均衡关系）与短期效应（误差修正效应）。</p></li>
</ul>
<h1 id="markov-model">4 Markov model</h1>
<h2 id="defination-of-markov-chain">4.1 Defination of Markov Chain</h2>
<p>现实生活中有很多这样的现象，某一系统在已知现在情况的条件下，系统未来时刻的情况只与现在有关，而与过去的历史无直接关系。</p>
<p>如，研究一个商店的累计销售额，如果现在时刻的累计销售额已知，未来某一时刻的累计销售额与现在时刻以前的任一时刻累计销售额无关。</p>
<p>描述这类 <strong>随机现象</strong> 的数学模型称为 <strong>马尔科夫模型</strong>，简称马氏模型</p>
<ul>
<li><strong>定义 1</strong></li>
</ul>
<p>设 <span class="math inline">\(\{\xi_n,\ n = 1,\ 2,\dots \}\)</span> 是一个随机序列，状态空间 <span class="math inline">\(E\)</span> 为有限或可列集，对于任意的正整数 $m, n $，若 <span class="math inline">\(i,\ j,\ ,\ i_k \in E\ (k=1, \dots, n-1)\)</span>，有： <span class="math display">\[
P\{\xi_{n+m} = j | \xi_n = i,\ \xi_{n-1} = i_{n-1}, \dots, \xi_1 = i_1\} = P\{\xi_{n+m} = j | \xi_n = i\}
\]</span> 则称 <span class="math inline">\(\{\xi_{n} , n = 1,\ 2, \dots\}\)</span> 是一个马尔可夫链。式 (9) 也被称为马氏性。</p>
<p>式 (9) 中，可以证明，对于 <span class="math inline">\(m = 1\)</span> 时成立，则它对 <strong>任意</strong> 的正整数 <span class="math inline">\(m\)</span> 都成立。因此，只要当 <span class="math inline">\(m=1\)</span> 式，式 (9) 成立，就可以称随机序列 <span class="math inline">\(\{\xi_n,\ n=1,\ 2, \dots\}\)</span> 具有 <strong>马氏性</strong>，即 <span class="math inline">\(\{\xi_{n} , n = 1,\ 2, \dots\}\)</span> 是一个马尔可夫链。</p>
<ul>
<li><strong>定义 2</strong></li>
</ul>
<p>设 <span class="math inline">\(\{\xi_n,\ n = 1,\ 2,\dots \}\)</span> 是一个马尔科夫链，如果式 (9) 右边的条件概率与 <span class="math inline">\(n\)</span> 无关，即： <span class="math display">\[
P\{\xi_{n+m} = j | \xi_n = i \} = p_{ij}(m)
\]</span> 则称 <span class="math inline">\(\{\xi_n,\ n = 1,\ 2,\dots \}\)</span> 为时齐的马尔可夫链。称 <span class="math inline">\(p_{ij}(m)\)</span> 为系统由状态 <span class="math inline">\(i\)</span> 经过 <span class="math inline">\(m\)</span> 个时间间隔（或 <span class="math inline">\(m\)</span> 步）转移到状态 <span class="math inline">\(j\)</span> 的转移概率。式 (10) 称为时齐性，它的含义式系统由状态 <span class="math inline">\(i\)</span> 到 状态 <span class="math inline">\(j\)</span> 的转移概率 <strong>只依赖与时间间隔的长短</strong>，与起始时刻无关。本章介绍的马尔可夫链都是时齐的，因此省略 <code>时齐</code> 二字。</p>
<h2 id="转移概率矩阵及柯尔莫哥洛夫定理">4.2 转移概率矩阵及柯尔莫哥洛夫定理</h2>
<h3 id="转移概率矩阵">4.2.1 转移概率矩阵</h3>
<p>对于马尔科夫链 <span class="math inline">\(\{\xi_n,\ n = 1,\ 2,\dots \}\)</span> ，称以 <span class="math inline">\(m\)</span> 步转移概率 <span class="math inline">\(p_{ij}(m)\)</span> 为元素的矩阵 <span class="math inline">\(P (m) = p_{ij}(m)\)</span> 为马尔科夫链的 <strong>$ m$ 步转移概率矩阵</strong>。当 <span class="math inline">\(m = 1\)</span>时，记 <span class="math inline">\(P(1) = P\)</span> 称为马尔可夫链的 <strong>一步转移矩阵</strong>，或简称 <strong>转移矩阵</strong>。</p>
<p>转移矩阵具有如下性质：</p>
<ul>
<li>对一切 $i, j E, 0 p_{ij}(m)  $，</li>
<li>对一切 $i E, <em> p</em>{ij}(m) = 1 $，-</li>
<li>对一切 <span class="math inline">\(i,\ j \in E, p_{ij}(0) = \delta_{ij} = \left\{\begin{array}{k}1,\ (i = j) \\ 0,\ (i \neq j) \end{array}\right.\)</span></li>
</ul>
<p>当实际问题可以用马尔可夫链来描述时，首先要确定它的 <strong>状态空间及参数集合</strong>，然后确定它的 <strong>一步转移概率</strong>。该概率的确定，可以由问题的 <strong>内在规律</strong> 得到，也可以由过去的经验给出，还可以根据 <strong>预测数据</strong> 来估计。案例可见 4.4 Cases 的 Case 1。</p>
<h3 id="柯尔莫哥洛夫定理">4.2.2 柯尔莫哥洛夫定理</h3>
<ul>
<li>柯尔莫哥洛夫- 开普曼定理</li>
</ul>
<p>设 <span class="math inline">\(\{\xi_n,\ n = 1,\ 2,\dots \}\)</span> 是一个马尔可夫链，其状态空间 <span class="math inline">\(E = \{1,\ 2,\dots\}\)</span>，则对任意正整数 <span class="math inline">\(m,\ n\)</span>，有： <span class="math display">\[
p_{ij}(n+m) = \sum_{k \in E} p_{ik}(n)p_{kj}(m)
\]</span> 其中：<span class="math inline">\(i,\ j \in E\)</span>。</p>
<ul>
<li><strong>定理</strong></li>
</ul>
<p>设 <span class="math inline">\(P\)</span> 是一步马尔科夫链转移矩阵（ <span class="math inline">\(P\)</span> 的行向量是概率向量），<span class="math inline">\(P^{(0)}\)</span> 是初始分布行向量，则第 <span class="math inline">\(n\)</span> 步的 <strong>概率分布</strong> 为： <span class="math display">\[
P^{(n)} = P^{(0)} P^n
\]</span></p>
<h2 id="转移概率的渐近性质极限概率分布">4.3 转移概率的渐近性质—极限概率分布</h2>
<h3 id="introduction-3">4.3.1 Introduction</h3>
<ul>
<li>随着 <span class="math inline">\(n\)</span> 的增大，<span class="math inline">\(P^n\)</span> 是否会趋于某以固定矩阵？</li>
</ul>
<p>先考虑一个简单的例子：</p>
转移矩阵 $ P =
<span class="math display">\[\begin{bmatrix}
0.5 &amp; 0.5 \\
0.7 &amp; 0.3 \\
\end{bmatrix}\]</span>
<p>$，当 <span class="math inline">\(n \rightarrow + \infty\)</span>，有： <span class="math display">\[
P^n \rightarrow \begin{bmatrix} \frac{7}{12} &amp; \frac{5}{12}\\
\frac{7}{12} &amp; \frac{5}{12} \\
\end{bmatrix}
\]</span> 若取 <span class="math display">\[
\begin{align*}
u = \begin{bmatrix} \frac{7}{12} &amp; \frac{5}{12}\\
\frac{7}{12} &amp; \frac{5}{12} \\
\end{bmatrix}
\end{align*}
\]</span> 则 <span class="math inline">\(uP = u\)</span>，<span class="math inline">\(u^T\)</span> 为矩阵 <span class="math inline">\(P^T\)</span> 的对应于特征值为 <span class="math inline">\(\lambda = 1\)</span> 的特征（概率）向量，<span class="math inline">\(u\)</span> 也称为 <span class="math inline">\(P\)</span> 的不动点向量。</p>
<ul>
<li><p>哪些转移矩阵具有不动点向量？</p>
<p><strong>定义：</strong>马尔可夫链的转移矩阵 <span class="math inline">\(P\)</span> 是正则 <span class="math inline">\(\Leftrightarrow \ \exist\ k \in N^+\)</span>，使 <span class="math inline">\(P^k\)</span> 任一元素都为正</p>
<p><strong>定理：</strong>若 <span class="math inline">\(P\)</span> 是一个马尔科夫链的正则阵，则：</p>
<ul>
<li><span class="math inline">\(P\)</span> 有 <strong>唯一</strong> 的不动点向量 <span class="math inline">\(W,\ W\)</span> 的每个分量都为正；</li>
<li><span class="math inline">\(P\)</span> 的 <span class="math inline">\(n\)</span> 次幂 <span class="math inline">\(P^n\)</span>（ <span class="math inline">\(n\)</span> 为正整数）随 <span class="math inline">\(n\)</span> 的增加趋于矩阵 <span class="math inline">\(\overline{W},\ \overline{W}\)</span> 的每一行向量<strong>均等于不动点向量</strong> <span class="math inline">\(W\)</span>。</li>
</ul></li>
</ul>
<p>设时齐马尔科夫链的状态空间为 <span class="math inline">\(E\)</span>，如果对于所有 <span class="math inline">\(i,\ j \in E\)</span>，转移概率 <span class="math inline">\(p_{ij}(n)\)</span> 存在极限： <span class="math display">\[
\lim_{n\to \infty}p_{ij}(n) = \pi_j\quad (\text{不依赖于 }i)
\]</span> 或： <span class="math display">\[
P(n) = P^n \underset{(n\to \infty)}{\longrightarrow} \begin{bmatrix} \pi_1 &amp; \pi_2 &amp; \dots &amp; \pi_j &amp; \dots \\
\pi_1 &amp; \pi_2 &amp; \dots &amp; \pi_j &amp; \dots \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \ddots \\
\pi_1 &amp; \pi_2 &amp; \ddots &amp; \pi_j &amp; \dots \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \ddots \\
\end{bmatrix}
\]</span> 则称此链具有 <strong>遍历性</strong>。若 <span class="math inline">\(\sum_\limits j \pi_j = 1\)</span>，则同时称 <span class="math inline">\(\vec {\pi} = [\pi_1,\  \pi_2, \dots]\)</span> 为链的 <strong>极限分布</strong>。</p>
<ul>
<li><p>就有限链的遍历性给出一个充分条件：</p>
<p><strong>定理：</strong>设时齐马尔可夫链 <span class="math inline">\(\{\xi_n,\ n = 1,\ 2,\dots \}\)</span> 的状态空间为 <span class="math inline">\(E = \{a_1,\dots,\ a_N\},\ P = (p_{ij})\)</span> 是它的一步转移矩阵，如果存在正整数 <span class="math inline">\(m\)</span>，使对任意的 <span class="math inline">\(a_i,\ a_j \in E\)</span>，都有： <span class="math display">\[
p_{ij}(m) &gt; 0,\ i, j = 1, 2, \dots, N
\]</span> 则此链具有 <strong>遍历性</strong>；且有极限分布 <span class="math inline">\(\vec \pi = [\pi_i, \dots, \pi_N]\)</span>，他是方程组： <span class="math display">\[
\pi = \pi P\quad \mathrm{or\quad} \pi_j = \sum_{i=1}^N \pi_i p_{ij}, \ j = 1, \dots,\ N
\]</span> 的满足条件 <span class="math inline">\(\pi_j &gt; 0,\ \sum_\limits{j=1}^N \pi_j = 1\)</span> 的唯一解。</p></li>
</ul>
<h2 id="cases">4.4 Cases</h2>
<ul>
<li><strong>Case 1:</strong></li>
</ul>
<p>某计算机机房的一台计算机经常出故障，研究者每隔15 分钟观察一次计算 机的运行状态，收集了24 小时的数据（共作97 次观察）。用1 表示正常状态，用0 表示不正常状态，所得的数据序列如下：</p>
<p>1110010011111110011110111111001111111110001101101 111011011010111101110111101111110011011111100111</p>
<p><strong>解：</strong>设 <span class="math inline">\(X_n (n = 1,\dots,97)\)</span> 为第 <span class="math inline">\(n\)</span> 个时段的计算机状态，可以认为它是一个时齐马氏链，状态空间 <span class="math inline">\(E = \{0,\ 1\}\)</span>，编写如下 <span class="math inline">\(Matlab\)</span> 程序：</p>
<figure class="highlight matlab"><table><tr><td class="code"><pre><span class="line">a1=<span class="string">&#x27;1110010011111110011110111111001111111110001101101&#x27;</span>;</span><br><span class="line">a2=<span class="string">&#x27;111011011010111101110111101111110011011111100111&#x27;</span>;</span><br><span class="line">a=[a1 a2];</span><br><span class="line">f00=<span class="built_in">length</span>(findstr(<span class="string">&#x27;00&#x27;</span>,a))</span><br><span class="line">f01=<span class="built_in">length</span>(findstr(<span class="string">&#x27;01&#x27;</span>,a))</span><br><span class="line">f10=<span class="built_in">length</span>(findstr(<span class="string">&#x27;10&#x27;</span>,a))</span><br><span class="line">f11=<span class="built_in">length</span>(findstr(<span class="string">&#x27;11&#x27;</span>,a))</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p>求得 96 次的转移情况是： <span class="math display">\[
\left\{
\begin{array}{c}
0 \rightarrow 0,\ \ 8 \text{次}; \qquad\ 0 \rightarrow 1,\ 18 \text{次} \\
1 \rightarrow 0,\ 18 \text{次}; \qquad 1 \rightarrow 1,\ 52 \text{次}
\end{array}
\right.
\]</span> 因此，一步转移概率可用频率近似地表示为： <span class="math display">\[
\left\{
\begin{array}{c}
P_{00} = P\{X_{n+1} = 0 | X_n = 0 \} \approx \frac{8}{8 + 18} = \frac{4}{13} \\
P_{01} = P\{X_{n+1} = 1 | X_n = 0 \} \approx \frac{18}{8 + 18} = \frac{9}{13} \\
P_{10} = P\{X_{n+1} = 0 | X_n = 1 \} \approx \frac{18}{18 + 52} = \frac{9}{35} \\
P_{11} = P\{X_{n+1} = 1 | X_n = 1 \} \approx \frac{52}{18 + 52} = \frac{26}{35} 
\end{array}
\right.
\]</span></p>
<ul>
<li><strong>Case 2:</strong></li>
</ul>
<p>若顾客的购买是无记忆的，即已知现在顾客购买情况，未来顾客的购买情况不受过去购买历史的影响，而只与现在购买情况有关。现在市场上供应 <span class="math inline">\(A,\ B,\ C\)</span> 三个不同厂家生产的 50 克袋装味精，用 <span class="math inline">\(\xi_n = 1,\ \xi_n, \ \xi_n = 3\)</span> 分别表示”顾客第 <span class="math inline">\(n\)</span> 次购买 <span class="math inline">\(A,\ B,\ C\)</span> 厂的味精”。显然，<span class="math inline">\(\{\xi_n, n = 1,\ 2,\dots\}\)</span> 是一个马氏链。若已知第一次顾客购买三个厂味精的概率依次为 <span class="math inline">\(0.2,\ 0.4,\ 0.4\)</span>。又知道一般顾客购买的倾向由表2给出。求</p>
<p>1）顾客第四次购买各家味精的概率；</p>
<p>2）预测经过长期的多次购买滞后，顾客的购买倾向如何？</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"></th>
<th style="text-align: center;">A</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">C</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">A</td>
<td style="text-align: center;">0.8</td>
<td style="text-align: center;">0.1</td>
<td style="text-align: center;">0.1</td>
</tr>
<tr class="even">
<td style="text-align: center;">B</td>
<td style="text-align: center;">0.5</td>
<td style="text-align: center;">0.1</td>
<td style="text-align: center;">0.4</td>
</tr>
<tr class="odd">
<td style="text-align: center;">C</td>
<td style="text-align: center;">0.5</td>
<td style="text-align: center;">0.3</td>
<td style="text-align: center;">0.2</td>
</tr>
</tbody>
</table>
<p>解：</p>
<p>1）第一次购买的概率分布为：<span class="math inline">\(P^{(1)} = [0.2,\ 0.4,\ 0.4]\)</span>，一步状态转移矩阵为：</p>
<p><span class="math inline">\(P = \begin{bmatrix}0.8 &amp; 0.1 &amp; 0.1 \\ 0.5 &amp; 0.1 &amp; 0.4 \\ 0.5 &amp; 0.3 &amp; 0.2\\\end{bmatrix}\)</span>，则顾客第四次购买各家味精的概率为： <span class="math display">\[
P^{(4)} = P^{(1)} P^3 = [0.7004, 0.136, 0.1636]
\]</span> 2）这个马尔可夫链的转移矩阵 <span class="math inline">\(P\)</span> 满足 <span class="math inline">\(p_{ij}(m) &gt; 0,\ i,\ j = 1, 2,\dots, N\)</span>，可以求出其极限概率分布。为此，解下列方程组： <span class="math display">\[
\left\{
\begin{array}{l}
p_1 = 0.2p_1 + 0.8p_2 + 0.1p_3,\\
p_2 = 0.8p_1 + 0.3p_3, \\
p_3 = 0.2p_2 + 0.6p_3, \\
p_1 + p_2 + p_3 = 1,
\end{array}
\right.
\]</span> 求得 <span class="math inline">\(p_1 = \frac{5}{7},\ p_2 = \frac{11}{84},\ p_3 = \frac{13}{84}\)</span>。这说明，无论第一次顾客购买的情况如何，经过长期多次购买后，<span class="math inline">\(A\)</span> 厂产的味精占有市场的 <span class="math inline">\(\frac{5}{7}\)</span>，<span class="math inline">\(B,\ C\)</span> 两厂的产品分别占有市场的 <span class="math inline">\(\frac{11}{84}\)</span> 和 <span class="math inline">\(\frac{13}{84}\)</span>。</p>
<p>Relative codes:</p>
<figure class="highlight matlab"><table><tr><td class="code"><pre><span class="line">format <span class="built_in">rat</span></span><br><span class="line">p=[<span class="number">0.8</span> <span class="number">0.1</span> <span class="number">0.1</span>;<span class="number">0.5</span> <span class="number">0.1</span> <span class="number">0.4</span>;<span class="number">0.5</span> <span class="number">0.3</span> <span class="number">0.2</span>];</span><br><span class="line">a=[p&#x27;-<span class="built_in">eye</span>(<span class="number">3</span>);<span class="built_in">ones</span>(<span class="number">1</span>,<span class="number">3</span>)];</span><br><span class="line">b=[<span class="built_in">zeros</span>(<span class="number">3</span>,<span class="number">1</span>);<span class="number">1</span>];</span><br><span class="line">p_limit=a\b</span><br></pre></td></tr></table></figure>
<p>或者利用求转移矩阵 <span class="math inline">\(P\)</span> 的转置矩阵 <span class="math inline">\(P^T\)</span> 的特征值 1 对应的特征(概率)向量，求得极 限概率。编写程序如下：</p>
<figure class="highlight matlab"><table><tr><td class="code"><pre><span class="line">clc,clear</span><br><span class="line">p=[<span class="number">0.8</span> <span class="number">0.1</span> <span class="number">0.1</span>;<span class="number">0.5</span> <span class="number">0.1</span> <span class="number">0.4</span>;<span class="number">0.5</span> <span class="number">0.3</span> <span class="number">0.2</span>];</span><br><span class="line">p=sym(p&#x27;);</span><br><span class="line">[x,y]=eig(p)</span><br><span class="line">y=<span class="built_in">diag</span>(y);y=double(y);</span><br><span class="line">ind=<span class="built_in">find</span>(y==<span class="built_in">max</span>(y));</span><br><span class="line">p=x(:,ind)/sum(x(:,ind))</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Class Notes</category>
        <category>Methods</category>
      </categories>
      <tags>
        <tag>Prediction</tag>
        <tag>Deep learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Python Figuration</title>
    <url>/2020/11/23/Python-Figuration/</url>
    <content><![CDATA[<h1 id="show-channel">1 Show channel</h1>
<p><code>conda config --show</code>显示所有的 conda 的config 信息，<code>conda config --show channels</code>显示所有 channel 信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>conda config --show channels</span><br><span class="line">channels:</span><br><span class="line">  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</span><br><span class="line">  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/win-<span class="number">64</span>/</span><br><span class="line">  - defaults</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p><code>pip</code> ：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip config <span class="built_in">list</span></span><br></pre></td></tr></table></figure>
<h1 id="delete-channel">2 Delete channel</h1>
<p>Using <code>conda config --remove channels</code> to delete channels from config</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">conda config --remove channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br></pre></td></tr></table></figure>
<h1 id="add-channel">3 Add channel</h1>
<h2 id="conda-add-channel">3.1 Conda add channel</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 channel 中安装包时显示channel 的url，这样就可以知道包的安装来源</span></span><br><span class="line">conda config --<span class="built_in">set</span> show_channel_urls yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装确认中，不默认yes，而是由我来决定</span></span><br><span class="line">conda config --<span class="built_in">set</span> always_yes false</span><br></pre></td></tr></table></figure>
<h2 id="pip">3.2 pip</h2>
<h3 id="temporary-configuration">3.2.1 Temporary configuration</h3>
<p>可以利用 <code>pip</code> 从镜像源安装第三方库，只需安装后加入 <code>-i source</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Install pandas</span></span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pandas</span><br><span class="line">    </span><br><span class="line"><span class="comment"># python-docx</span></span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple python-docx</span><br></pre></td></tr></table></figure>
<p>国内还有其他镜像可供选择：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 豆瓣</span></span><br><span class="line">http://pypi.douban.com/simple/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 阿里</span></span><br><span class="line">http://mirrors.aliyun.com/pypi/simple/</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 中国科学技术大学</span></span><br><span class="line">http://pypi.mirrors.ustc.edu.cn/simple/</span><br></pre></td></tr></table></figure>
<h3 id="permanently-configuration">3.2.2 Permanently configuration</h3>
<ul>
<li><p>自动配置镜像源</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 清华源</span></span><br><span class="line">pip config <span class="built_in">set</span> <span class="keyword">global</span>.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure></li>
<li><p>手动配置镜像源</p>
<p>在 <code>windows</code> 下，直接在 <code>user</code> 目录中创建一个 <code>pip</code> 目录，再新建文件 <code>pip.ini</code>，接着打开 <code>pip.ini</code> 文件，复制粘贴以下内容并保存。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">global</span>]</span><br><span class="line"> index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="install-package-offline">4 Install package offline</h1>
<h3 id="conda-install">4.1 Conda install</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">conda install --offline &lt; package &gt;</span><br><span class="line"></span><br><span class="line">conda install &lt;包名&gt; <span class="comment">#安装指定包</span></span><br><span class="line">conda remove &lt;包名&gt; <span class="comment">#移除指定包</span></span><br><span class="line">conda update &lt;包名&gt; <span class="comment">#更新指定包</span></span><br></pre></td></tr></table></figure>
<h3 id="pip-install-.whl-package">4.2 pip install '.whl' package</h3>
<p>再命令行窗口用 <code>cd</code> 命令跳转到 <code>whl</code> 文件所在目录，然后使用命令：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install ***.whl</span><br></pre></td></tr></table></figure>
<h1 id="virtual-environment">5 Virtual environment</h1>
<h2 id="steps">5.1 Steps</h2>
<ul>
<li><p>Open <code>terminal</code> or <code>Command prompt</code></p></li>
<li><p>Input <code>D:</code> to enter drive D</p></li>
<li><p>Then input <code>cd project_dir</code></p></li>
<li><p>Create a virtual environment</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -m venv &lt;venv name&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="activate-venv">5.2 Activate venv</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">.\&lt;venv name&gt;\Scripts\activate <span class="comment"># activate venv</span></span><br><span class="line"></span><br><span class="line">.\venv\Scripts\deactivate <span class="comment"># exit the current venv</span></span><br></pre></td></tr></table></figure>
<h2 id="import-module">5.3 Import module</h2>
<ul>
<li><p>主程序和模块程序在同一目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">`-- src</span><br><span class="line">    |-- mod1.py</span><br><span class="line">    `-- test.py</span><br></pre></td></tr></table></figure>
<p><code>test.py</code>导入模块 <code>mod1</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> mod1</span><br><span class="line"><span class="keyword">from</span> mod1 <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure></li>
<li><p>主程序所在目录是模块所在目录的父(或祖辈)目录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">`-- src</span><br><span class="line">    |-- mod1.py</span><br><span class="line">    |-- mod2</span><br><span class="line">    |   `-- mod2.py</span><br><span class="line">    `-- test1.py</span><br></pre></td></tr></table></figure>
<p><code>test1.py</code>中导入模块<code>mod2</code>，需要在<code>mod2</code>文件夹中创建<code>__init__.py</code>文件:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mod2.mod2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> mod2.mod2</span><br></pre></td></tr></table></figure></li>
<li><p>主程序导入上层目录中模块或其他目录(平级)下的模块</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">`-- src</span><br><span class="line">    |-- mod1.py</span><br><span class="line">    |-- mod2</span><br><span class="line">    |   `-- mod2.py</span><br><span class="line">    |-- sub</span><br><span class="line">    |   `-- test2.py</span><br><span class="line">    `-- test1.py</span><br></pre></td></tr></table></figure>
<p><code>test2.py</code> 中导入模块 <code>mod1</code> 和 <code>mod2</code>，首先需要在 <code>mod2</code> 下建立 <code>__init__.py</code> 文件，<code>src</code> 下不必建立该文件:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">&quot;..&quot;</span>)</span><br><span class="line"><span class="keyword">import</span> mod1</span><br><span class="line"><span class="keyword">import</span> mod2.mod2</span><br></pre></td></tr></table></figure></li>
</ul>
<p>从上面可以看出，导入模块关键是能够根据sys.path环境变量的值，找到具体模块的路径</p>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Software</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Anaconda</tag>
      </tags>
  </entry>
  <entry>
    <title>Pytorch-1-Introduction</title>
    <url>/2021/08/03/Pytorch-1-Introduction/</url>
    <content><![CDATA[<p>Statement: This series of post records the personal notes and experiences of learning the <a href="https://www.bilibili.com/">BiliBili</a> video tutorial <a href="https://www.bilibili.com/video/BV12741177Cu?p=1">"Pytorch 入门学习"</a>, most of code and pictures are from the courseware <a href="https://github.com/ZeweiChu/PyTorch-Course">PyTorch-Course</a>. All posted content is for personal study only, do not use for other purposes. If there is infringement, please contact <code>e-mail:yangsuoly@qq.com</code> to delete. <a id="more"></a></p>
<h1 id="introduction-to-deep-learning-models">1. Introduction to deep learning models</h1>
<h2 id="definition">1.1 Definition</h2>
<p><strong>Q</strong>: What is machine learning?<br />
<strong>A</strong>: Study of algorithms that: - Improve their <em>performance</em> P - At some <em>task</em> T - With <em>experience</em> E</p>
<p><strong>Conclusion</strong>: Modeling, Inference, learning <img src="https://z3.ax1x.com/2021/08/03/fi7u38.png" /></p>
<ul>
<li>Modeling: define score function</li>
<li>Inference: solve argmax</li>
<li>Learning: choose w</li>
</ul>
<p><span class="math display">\[ \text{classify} (x, w) = \mathop{\text{argmax}}\limits_{y} \  \text{score} (x, y, w)\]</span></p>
<p><strong>Q</strong>: What is deep learning? <strong>A</strong>: <img src="https://z3.ax1x.com/2021/08/03/fi7KgS.md.png" /></p>
<p><strong>Q</strong>: What is neural network? <strong>A</strong>: <img src="https://z3.ax1x.com/2021/08/03/fi7Mjg.png" /></p>
<h2 id="activation-function">1.2 Activation function</h2>
<p><img src="https://z3.ax1x.com/2021/08/03/fi7GEn.png" /></p>
<h3 id="commonly-used-activation-functions">1.2.1 Commonly used activation functions:</h3>
<ul>
<li><p><span class="math inline">\(sigmoid\)</span>: <span class="math display">\[
\sigma(x) = \frac{1}{1+e^{-x}}
\]</span></p></li>
<li><p><span class="math inline">\(tanh\)</span>: <span class="math display">\[
tanh(x) = 2 \sigma(2x) - 1
\]</span></p></li>
<li><p><span class="math inline">\(ReLU\)</span>: <span class="math display">\[
ReLU(x) = max(0, x)
\]</span></p></li>
<li><p><span class="math inline">\(Softmax\)</span>: <span class="math display">\[
z_i \rightarrow \frac{e^{z_i}}{\sum_{j=1}^{k} e^{z_j}}
\]</span></p></li>
</ul>
<h3 id="code-implementation">1.2.2 Code implementation</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = torch.linspace(-<span class="number">5</span>, <span class="number">5</span>, <span class="number">200</span>)</span><br><span class="line">x = Variable(x)</span><br><span class="line">x_np = x.data.numpy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># four activation function</span></span><br><span class="line">y_relu = F.relu(x).data.numpy()</span><br><span class="line">y_sigmoid = torch.sigmoid(x).data.numpy()</span><br><span class="line">y_tanh = F.tanh(x).data.numpy()</span><br><span class="line">y_softplus = F.softplus(x).data.numpy()</span><br><span class="line"></span><br><span class="line">plt.figure(<span class="number">1</span>, figsize=(<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line">plt.subplot(<span class="number">221</span>)</span><br><span class="line">plt.plot(x_np, y_relu, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">1</span>, <span class="number">5</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">222</span>)</span><br><span class="line">plt.plot(x_np, y_sigmoid, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;sigmoid&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">0.2</span>, <span class="number">1.2</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">223</span>)</span><br><span class="line">plt.plot(x_np, y_tanh, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;tanh&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">1.2</span>, <span class="number">1.2</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">224</span>)</span><br><span class="line">plt.plot(x_np, y_softplus, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;softplus&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">0.2</span>, <span class="number">6</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://z3.ax1x.com/2021/08/03/fi7VAI.png" /></p>
<h2 id="examples-of-nn">1.3 examples of NN</h2>
<ul>
<li><p>Standard feedforward NN <img src="https://z3.ax1x.com/2021/08/03/fi71Bj.png" /></p></li>
<li><p>Convolutional NN <img src="https://z3.ax1x.com/2021/08/03/fi7JNq.png" /></p></li>
<li><p>Recurrent NN <img src="https://z3.ax1x.com/2021/08/03/fi7ZNt.png" /></p></li>
<li><p>Seq2Seq with Attention <img src="https://z3.ax1x.com/2021/08/03/fi7Y40.png" /> <strong>Reference</strong>: <a href="https://arxiv.org/abs/1508.04025">Effective Approaches to Attention-based Neural Machine Translation</a></p></li>
</ul>
<h1 id="introduction-to-pytorch">2. Introduction to PyTorch</h1>
<h2 id="framework-for-deep-learning">2.1 Framework for deep learning</h2>
<p><img src="https://z3.ax1x.com/2021/08/03/fi7U3T.png" /></p>
<p>Difference between PyTorch and Tensorflow: - PyTorch: 动态计算图 Dynamic Computation Graph - Tensorflow: 静态计算图 Static Computation Graph</p>
<p>PyTorch 代码通俗易懂，非常接近 Python 原生代码，不会让人感觉是完全在学习一门新的语言。拥有 Facebook 支持，社区活跃。</p>
<p><strong>Q</strong>: What does the PyTorch do? <strong>A</strong>: <img src="https://z3.ax1x.com/2021/08/03/fi7agU.png" /></p>
<h2 id="some-interesting-project-with-pytorch">2.2. Some interesting project with PyTorch</h2>
<ul>
<li><p>ResNet <img src="https://z3.ax1x.com/2021/08/03/fi7e4P.md.png" /> Image classification: <a href="https://github.com/floydhub/imagenet">ResNet</a></p></li>
<li><p>Object Detection <img src="https://z3.ax1x.com/2021/08/03/fi7n9f.md.png" /> Project address: <a href="https://github.com/amdegroot/ssd.pytorch">Here</a></p></li>
<li><p>Image Style Transfer <img src="https://z3.ax1x.com/2021/08/03/fi7Db9.md.png" /> Project address: <a href="https://github.com/zhanghang1989/PyTorch-Multi-Style-Transfer">Here</a></p></li>
<li><p>CycleGAN <img src="https://z3.ax1x.com/2021/08/03/fi7luQ.png" /> Project address: <a href="https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix">Here</a></p></li>
<li><p>Image Captioning <img src="https://z3.ax1x.com/2021/08/03/fi7sER.md.png" /> Project address: <a href="https://github.com/ruotianluo/ImageCaptioning.pytorch">Here</a></p></li>
<li><p>Sentiment Analysis <img src="https://z3.ax1x.com/2021/08/03/fi7dvF.png" /> Project address: <a href="https://github.com/bentrevett/pytorch-sentiment-analysis">Here</a></p></li>
<li><p>Question Answering <img src="https://z3.ax1x.com/2021/08/03/fi7yU1.png" /> Project address: <a href="https://github.com/allenai/document-qa">Here</a></p></li>
<li><p>Translation: OpenNMT-py <img src="https://z3.ax1x.com/2021/08/03/fi7BDJ.png" /> Project address: <a href="https://github.com/OpenNMT/OpenNMT-py">Here</a></p></li>
<li><p>ChatBot <img src="https://z3.ax1x.com/2021/08/03/fi764x.png" /> Project address: <a href="https://github.com/czs0x55aa/pytorch-chatbot">Here</a></p></li>
<li><p>Deep Reinforcement Learning</p>
<p>Project address: <a href="https://github.com/jingweiz/pytorch-rl">Project 1</a>, <a href="https://pytorch.org/tutorials/intermediate/reinforcement_q_learning.html">Project 2</a></p></li>
</ul>
<h2 id="how-to-learn-pytorch">2.3 How to learn PyTorch</h2>
<ul>
<li>Basics of deep learning;</li>
<li>Pytorch official <a href="https://pytorch.org/tutorials/">tutorial</a>;</li>
<li>Learn tutorials on GitHub and various blogs;</li>
<li>Documentation and <a href="https://discuss.pytorch.org/">BBS</a></li>
<li>Re-creat the open source PyTorch project;</li>
<li>Read papers about deep learning model and implement them;</li>
<li>Create your own model.</li>
</ul>
<h1 id="note-content">3. Note content</h1>
<ol type="1">
<li>Pytorch framework with autograd introduction, simple forward neural networks;</li>
<li>Word vector;</li>
<li>Image classification, CNN, Transfer learning;</li>
<li>Language Model, Sentiment Classification, RNN, LSTM, GRU;</li>
<li>Translation Model, Seq2Seq, Attention;</li>
<li>Reading Comprehension, EIMo, BERT, GPT-2;</li>
<li>ChatBot;</li>
<li>GAN, Face generation, Style Transfer.</li>
</ol>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Pytorch</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Deep learning</tag>
        <tag>Pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>Python</title>
    <url>/2020/11/29/Python/</url>
    <content><![CDATA[<h1 id="python-数据类型">1. Python 数据类型</h1>
<h2 id="string">1.1 String</h2>
<ul>
<li>字符串的换行</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 长字符串的换行</span></span><br><span class="line">s2 = <span class="string">&#x27;It took me six months to write this Python tutorial. \</span></span><br><span class="line"><span class="string">    Please give me more support. \</span></span><br><span class="line"><span class="string">    I will keep it updated.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表达式的换行</span></span><br><span class="line">num = <span class="number">20</span> + <span class="number">3</span> / <span class="number">4</span> + \</span><br><span class="line">    <span class="number">2</span> * <span class="number">3</span></span><br><span class="line">print(num)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<ul>
<li>长字符串</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 长字符串中的换行，缩进等会如实输出</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Long string information</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>原始字符串</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rstr = <span class="string">r&#x27;D:\Program Files\Python 3.8\python.exe&#x27;</span></span><br><span class="line">print(rstr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原始字符串中的引号童谣要进行转义处理</span></span><br><span class="line">str2 = <span class="string">r&#x27;I\&#x27;m a great coder!&#x27;</span></span><br><span class="line">print(str1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串结尾的反斜杠，如表达：D:\Program Files\Python 3.8\</span></span><br><span class="line">str3 = <span class="string">r&#x27;D:\Program Files\Python 3.8&#x27;</span> + <span class="string">&#x27;\\&#x27;</span></span><br><span class="line">print(str1)</span><br></pre></td></tr></table></figure>
<h2 id="bytes">1.2 Bytes</h2>
<p>Bytes 类型表示一个字节串，时Python 3 新增的， python 2 中不存在</p>
<p>Bytes 和 string 的对比：</p>
<ul>
<li>string由若干个字符组成，以字符为单位进行操作；Bytes由字节组成</li>
<li>除了操作的处理单元不同，它们支持的所有方法基本相同</li>
<li>都是不可变序列，不能随意增加和删除数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 通过构造函数创建空 bytes</span></span><br><span class="line">b1 = <span class="built_in">bytes</span>()</span><br><span class="line"><span class="comment"># 通过空字符串创建空 bytes</span></span><br><span class="line">b2 = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 通过b前缀将字符串转换成 bytes</span></span><br><span class="line">b3 = <span class="string">b&#x27;http://c.biancheng.net/python/&#x27;</span></span><br><span class="line">print(<span class="string">&quot;b3: &quot;</span>, b3)</span><br><span class="line">print(b3[<span class="number">3</span>])</span><br><span class="line">print(b3[<span class="number">7</span>:<span class="number">22</span>])</span><br><span class="line"><span class="comment"># 为 bytes() 方法指定字符集</span></span><br><span class="line">b4 = <span class="built_in">bytes</span>(<span class="string">&#x27;C语言中文网8岁了&#x27;</span>, encoding=<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;b4: &quot;</span>, b4)</span><br><span class="line"><span class="comment"># 通过 encode() 方法将字符串转换成 bytes</span></span><br><span class="line">b5 = <span class="string">&quot;C语言中文网8岁了&quot;</span>.encode(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;b5: &quot;</span>, b5)</span><br><span class="line"><span class="comment"># 通过 decode() 方法将 bytes 转化为字符串</span></span><br><span class="line">str1 = b5.decode(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;str1: &quot;</span>, str1)</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">b3:  <span class="string">b&#x27;http://c.biancheng.net/python/&#x27;</span></span><br><span class="line"><span class="number">112</span></span><br><span class="line"><span class="string">b&#x27;c.biancheng.net&#x27;</span></span><br><span class="line">b4:  <span class="string">b&#x27;C\xe8\xaf\xad\xe8\xa8\x80\xe4\xb8\xad\xe6\x96\x87\xe7\xbd\x918\xe5\xb2\x81\xe4\xba\x86&#x27;</span></span><br><span class="line">b5:  <span class="string">b&#x27;C\xe8\xaf\xad\xe8\xa8\x80\xe4\xb8\xad\xe6\x96\x87\xe7\xbd\x918\xe5\xb2\x81\xe4\xba\x86&#x27;</span></span><br><span class="line">str1:  C语言中文网<span class="number">8</span>岁了</span><br></pre></td></tr></table></figure>
<p>从运行结果可以发现，对于非 ASCII 字符，print 输出的是它的字符编码值（十六进制形式），而不是字符本身。非 ASCII 字符一般占用两个字节以上的内存，而 bytes 是按照单个字节来处理数据的，所以不能一次处理多个字节。</p>
<h2 id="list">1.3 list</h2>
<h3 id="创建列表">1.3.1 创建列表</h3>
<ul>
<li>使用 [] 创建列表</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 可支持不同数据类型</span></span><br><span class="line">program = [<span class="string">&quot;C语言&quot;</span>, <span class="string">&quot;Python&quot;</span>, <span class="string">&quot;Java&quot;</span>]</span><br><span class="line"><span class="comment"># 支持创建空列表</span></span><br><span class="line">emptylist = [ ]</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 list() 函数创建列表</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将字符串转换成列表</span></span><br><span class="line">list1 = <span class="built_in">list</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">print(list1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将元组转换成列表</span></span><br><span class="line">tuple1 = (<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;C++&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>)</span><br><span class="line">list2 = <span class="built_in">list</span>(tuple1)</span><br><span class="line">print(list2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将字典转换成列表</span></span><br><span class="line">dict1 = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">42</span>, <span class="string">&#x27;c&#x27;</span>:<span class="number">9</span>&#125;</span><br><span class="line">list3 = <span class="built_in">list</span>(dict1)</span><br><span class="line">print(list3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将区间转换成列表</span></span><br><span class="line">range1 = <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)</span><br><span class="line">list4 = <span class="built_in">list</span>(range1)</span><br><span class="line">print(list4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建空列表</span></span><br><span class="line">print(<span class="built_in">list</span>())</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;o&#x27;</span>]</span><br><span class="line">[<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;C++&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>]</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>
<h3 id="访问列表元素">1.3.2 访问列表元素</h3>
<ul>
<li><p>使用索引访问列表元素</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listname[i]</span><br></pre></td></tr></table></figure></li>
<li><p>使用切片访问列表元素</p></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listname[start : end : step]</span><br></pre></td></tr></table></figure>
<h3 id="删除列表操作">1.3.3 删除列表操作</h3>
<ul>
<li>del 关键词删除列表</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">del</span> listname</span><br><span class="line"><span class="comment"># listname 表示要删除列表的名称</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> listname[index]</span><br><span class="line"><span class="keyword">del</span> listname[start : end]</span><br><span class="line"><span class="comment"># 删除从索引 start 到 end 之间的元素，不包括 end 位置的元素</span></span><br></pre></td></tr></table></figure>
<ul>
<li>pop() 方法：根据索引值删除元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listname.pop(index)</span><br><span class="line"><span class="comment"># index 表示索引值，如果不写 index 参数，默认会删除列表中的最后一个元素，类似于数据结构中“出栈”操作</span></span><br></pre></td></tr></table></figure>
<ul>
<li>remove() 方法：根据元素本身的值来进行删除操作</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># remove() 方法只会删除第一个与指定值相同的元素，而且必须保证该元素是存在的，否则会报ValueError 错误</span></span><br><span class="line"></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一次删除36</span></span><br><span class="line">nums.remove(<span class="number">36</span>)</span><br><span class="line">print(nums)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二次删除36</span></span><br><span class="line">nums.remove(<span class="number">36</span>)</span><br><span class="line">print(nums)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除78</span></span><br><span class="line">nums.remove(<span class="number">78</span>)</span><br><span class="line">print(nums)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="number">40</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">[<span class="number">40</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"></span><br><span class="line">  File <span class="string">&quot;D:\Demo\Python\Test\Test1.py&quot;</span>, line <span class="number">493</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    nums.remove(<span class="number">78</span>)</span><br><span class="line"></span><br><span class="line">ValueError: <span class="built_in">list</span>.remove(x): x <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">list</span></span><br></pre></td></tr></table></figure>
<ul>
<li>clear()方法：删除列表所有元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url = <span class="built_in">list</span>(<span class="string">&quot;http://c.biancheng.net/python/&quot;</span>)</span><br><span class="line">url.clear()</span><br><span class="line">print(url)</span><br><span class="line"><span class="comment"># clear() 会清空列表</span></span><br></pre></td></tr></table></figure>
<p>​ 运行结果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[]</span><br></pre></td></tr></table></figure>
<h3 id="列表添加元素">1.3.4 列表添加元素</h3>
<ul>
<li>用 '+' 进行拼接</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">language = [<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;Java&quot;</span>]</span><br><span class="line">birthday = [<span class="number">1991</span>, <span class="number">1998</span>, <span class="number">1995</span>]</span><br><span class="line">info = language + birthday</span><br><span class="line"></span><br><span class="line">print(<span class="string">&quot;language =&quot;</span>, language)</span><br><span class="line">print(<span class="string">&quot;birthday =&quot;</span>, birthday)</span><br><span class="line">print(<span class="string">&quot;info =&quot;</span>, info)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">+ 运算符可以将多个修了连接起来，相当于在第一个列表的末尾添加了另一个列表</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>append() 方法添加元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listname.append(obj)</span><br><span class="line"><span class="comment"># 用于在列表的末尾追加元素，obj 可以是单个元素，也可以是列表、元组等</span></span><br></pre></td></tr></table></figure>
<ul>
<li>inser() 方法插入元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listname.insert(index, obj)</span><br><span class="line"><span class="comment"># index 表示指定位置的索引值</span></span><br></pre></td></tr></table></figure>
<h3 id="列表修改元素">1.3.5 列表修改元素</h3>
<ul>
<li>修改单个元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line">nums[<span class="number">2</span>] = -<span class="number">26</span>  <span class="comment">#使用正数索引</span></span><br><span class="line">nums[-<span class="number">3</span>] = -<span class="number">66.2</span>  <span class="comment">#使用负数索引</span></span><br><span class="line">print(nums)</span><br></pre></td></tr></table></figure>
<ul>
<li>修改一组元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line"><span class="comment"># 修改第 1~4 个元素的值（不包括第4个元素）</span></span><br><span class="line">nums[<span class="number">1</span>: <span class="number">4</span>] = [<span class="number">45.25</span>, -<span class="number">77</span>, -<span class="number">52.5</span>]</span><br><span class="line">print(nums)</span><br><span class="line">·</span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line"><span class="comment"># 在4个位置插入元素</span></span><br><span class="line">nums[<span class="number">4</span>: <span class="number">4</span>] = [-<span class="number">77</span>, -<span class="number">52.5</span>, <span class="number">999</span>]</span><br><span class="line">print(nums)</span><br><span class="line"></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line"><span class="comment"># 使用切片语法赋值不支持单个值，会报TypeError</span></span><br><span class="line">nums[<span class="number">4</span>: <span class="number">4</span>] = -<span class="number">77</span></span><br><span class="line"></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>]</span><br><span class="line"><span class="comment"># 步长为2，为第1、3、5个元素赋值</span></span><br><span class="line">nums[<span class="number">1</span>: <span class="number">6</span>: <span class="number">2</span>] = [<span class="number">0.025</span>, -<span class="number">99</span>, <span class="number">20.5</span>]</span><br><span class="line">print(nums)</span><br></pre></td></tr></table></figure>
<h3 id="列表查找元素">1.3.6 列表查找元素</h3>
<ul>
<li>index() 方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listname.index(obj,start,end)</span><br><span class="line"><span class="comment"># 查找某个元素在列表中出现的位置，不存在则报ValueError错误，查找之前最好使用count()判断一下</span></span><br><span class="line">nums = [<span class="number">40</span>, <span class="number">36</span>, <span class="number">89</span>, <span class="number">2</span>, <span class="number">36</span>, <span class="number">100</span>, <span class="number">7</span>, -<span class="number">20.5</span>, -<span class="number">999</span>]</span><br><span class="line"><span class="comment"># 检索列表中的所有元素</span></span><br><span class="line">print( nums.index(<span class="number">2</span>) )</span><br><span class="line"><span class="comment"># 检索3~7之间的元素</span></span><br><span class="line">print( nums.index(<span class="number">100</span>, <span class="number">3</span>, <span class="number">7</span>) )</span><br><span class="line"><span class="comment"># 检索4之后的元素</span></span><br><span class="line">print( nums.index(<span class="number">7</span>, <span class="number">4</span>) )</span><br><span class="line"><span class="comment"># 检索一个不存在的元素</span></span><br><span class="line">print( nums.index(<span class="number">55</span>) )</span><br></pre></td></tr></table></figure>
<ul>
<li>count() 方法：统计某个元素在列表中出现的次数</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">listname.count(obj)</span><br><span class="line"><span class="comment"># count() 防回0，则表示列表中不存在该元素</span></span><br></pre></td></tr></table></figure>
<h2 id="tuple">1.4 tuple</h2>
<h3 id="创建元组">1.4.1 创建元组</h3>
<ul>
<li>使用 () 直接创建</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tuplename = (element1, element2, ... )</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 tuple() 函数创建元组</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">tuple</span>(data)</span><br><span class="line"><span class="comment"># data 表示可以转化为元组的数据，包括字符串、元组、range 对象等</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将字符串转换成元组</span></span><br><span class="line">tup1 = <span class="built_in">tuple</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">print(tup1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将列表转换成元组</span></span><br><span class="line">list1 = [<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;C++&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>]</span><br><span class="line">tup2 = <span class="built_in">tuple</span>(list1)</span><br><span class="line">print(tup2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将字典转换成元组</span></span><br><span class="line">dict1 = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">42</span>, <span class="string">&#x27;c&#x27;</span>:<span class="number">9</span>&#125;</span><br><span class="line">tup3 = <span class="built_in">tuple</span>(dict1)</span><br><span class="line">print(tup3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将区间转换成元组</span></span><br><span class="line">range1 = <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>)</span><br><span class="line">tup4 = <span class="built_in">tuple</span>(range1)</span><br><span class="line">print(tup4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建空元组</span></span><br><span class="line">print(<span class="built_in">tuple</span>())</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(<span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;C++&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>)</span><br><span class="line">(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">()</span><br></pre></td></tr></table></figure>
<h3 id="访问元组元素">1.4.2 访问元组元素</h3>
<ul>
<li>使用索引访问元组元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tuplename[i]</span><br></pre></td></tr></table></figure>
<ul>
<li>使用切片访问元组元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tuplename[start: end: step]</span><br></pre></td></tr></table></figure>
<h3 id="修改元组">1.4.3 修改元组</h3>
<p>元组是不可变序列，元组中的元素不能被修改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tup = (<span class="number">100</span>, <span class="number">0.5</span>, -<span class="number">36</span>, <span class="number">73</span>)</span><br><span class="line">print(tup)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用新的元组去替代旧的元组</span></span><br><span class="line">tup = (<span class="string">&#x27;Shell脚本&#x27;</span>,<span class="string">&quot;http://c.biancheng.net/shell/&quot;</span>)</span><br><span class="line">print(tup)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 + 运算符拼接形成新的元组</span></span><br></pre></td></tr></table></figure>
<h3 id="删除元组">1.4.4 删除元组</h3>
<ul>
<li>del 关键字</li>
</ul>
<h2 id="dict">1.5 dict</h2>
<p>dict 是一种无序的、可变的序列，他的元素以“键值对（key - value）”的形式存储</p>
<p><img src="https://s3.ax1x.com/2020/11/30/Dg2hm6.gif" alt="reflect1" style="zoom:80%;" /></p>
<center>
Fig. 1-1 字典数据结构
</center>
<h3 id="创建字典">1.5.1 创建字典</h3>
<ul>
<li>使用 {} 创建字典</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname = &#123;<span class="string">&#x27;key&#x27;</span>:<span class="string">&#x27;value1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>:<span class="string">&#x27;value2&#x27;</span>, ..., <span class="string">&#x27;keyn&#x27;</span>:valuen&#125;</span><br><span class="line"><span class="comment"># 同义字典中的各个键必须唯一，不能重复</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过 fromkeys() 方法创建字典</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname = <span class="built_in">dict</span>.fromkeys(<span class="built_in">list</span>, value = <span class="literal">None</span>)</span><br><span class="line"><span class="comment"># list 参数表示字典中的所有键的列表，value参数表示默认值，如果不写，则为空值None</span></span><br><span class="line"></span><br><span class="line">knowledge = &#123;<span class="string">&#x27;语文&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>&#125;</span><br><span class="line">scores = <span class="built_in">dict</span>.fromkeys(knowledge, <span class="number">60</span>)</span><br><span class="line">print(scores)</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 dict() 映射函数创建字典</li>
</ul>
<center>
表1-1 dict() 函数创建字典
</center>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>创建格式</th>
<th>注意事项</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>a = dict(str1=value1, str2=value2, str3=value3)</td>
<td>str 表示字符串类型的键，value 表示键对应的值。使用此方式创建字典时，字符串不能带引号。</td>
</tr>
<tr class="even">
<td>#方式1<br />demo = [('two',2), ('one',1), ('three',3)] <br />#方式2<br /> demo = [['two',2], ['one',1], ['three',3]] <br />#方式3 <br />demo = (('two',2), ('one',1), ('three',3)) <br />#方式4 <br />demo = (['two',2], ['one',1], ['three',3]) a = dict(demo)</td>
<td>向 dict() 函数传入列表或元组，而它们中的元素又各自是包含 2 个元素的列表或元组，其中第一个元素作为键，第二个元素作为值。</td>
</tr>
<tr class="odd">
<td>keys = ['one', 'two', 'three'] <br />#还可以是字符串或元组 <br />values = [1, 2, 3] <br />#还可以是字符串或元组 <br />a = dict( zip(keys, values) )</td>
<td>通过应用 dict() 函数和 zip() 函数，可将前两个列表转换为对应的字典。</td>
</tr>
</tbody>
</table>
<p>如果不为 dict() 函数传入任何参数，则表示创建空字典</p>
<h3 id="访问字典">1.5.2 访问字典</h3>
<ul>
<li>利用索引</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname[key]</span><br><span class="line"><span class="comment"># 由于字典中的元素是无序的，每个元素的位置都不固定，所以字典也不能像列表和元组那样，采用切片的方式一次性访问多个元素</span></span><br><span class="line"></span><br><span class="line">tup = ([<span class="string">&#x27;two&#x27;</span>,<span class="number">26</span>], [<span class="string">&#x27;one&#x27;</span>,<span class="number">88</span>], [<span class="string">&#x27;three&#x27;</span>,<span class="number">100</span>], [<span class="string">&#x27;four&#x27;</span>,-<span class="number">59</span>])</span><br><span class="line">dic = <span class="built_in">dict</span>(tup)</span><br><span class="line">print(dic[<span class="string">&#x27;one&#x27;</span>])  <span class="comment">#键存在</span></span><br><span class="line">print(dic[<span class="string">&#x27;five&#x27;</span>])  <span class="comment">#键不存在</span></span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">88</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">&quot;C:\Users\mozhiyan\Desktop\demo.py&quot;</span>, line <span class="number">4</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">        print(dic[<span class="string">&#x27;five&#x27;</span>])  <span class="comment">#键不存在</span></span><br><span class="line">KeyError: <span class="string">&#x27;five&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>get() 方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname.get(key[,default])</span><br><span class="line"><span class="comment"># default 用于指定要查询的键不存在时，此方法返回的默认值，如果不指定，则返回 None</span></span><br><span class="line"></span><br><span class="line">a = <span class="built_in">dict</span>(two=<span class="number">0.65</span>, one=<span class="number">88</span>, three=<span class="number">100</span>, four=-<span class="number">59</span>)</span><br><span class="line">print( a.get(<span class="string">&#x27;one&#x27;</span>) )</span><br><span class="line">print( a.get(<span class="string">&#x27;five&#x27;</span>, <span class="string">&#x27;该键不存在&#x27;</span>) )</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">88</span></span><br><span class="line">该键不存在</span><br></pre></td></tr></table></figure>
<h3 id="字典操作">1.6.3 字典操作</h3>
<ul>
<li>删除字典</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">del</span> dictname</span><br></pre></td></tr></table></figure>
<ul>
<li>添加键值对</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname[key] = value</span><br></pre></td></tr></table></figure>
<ul>
<li>修改键值对</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname[key] = new value</span><br><span class="line"><span class="comment"># key值不能被修改，只能修改value</span></span><br></pre></td></tr></table></figure>
<ul>
<li>删除键值对</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">del</span> dictname[key]</span><br></pre></td></tr></table></figure>
<ul>
<li>判断字典中是否存在指定键值对( in 或 not in 运算符)</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>&#125;</span><br><span class="line"><span class="comment"># 判断 a 中是否包含名为&#x27;数学&#x27;的key</span></span><br><span class="line">print(<span class="string">&#x27;数学&#x27;</span> <span class="keyword">in</span> a) <span class="comment"># True</span></span><br><span class="line"><span class="comment"># 判断 a 是否包含名为&#x27;物理&#x27;的key</span></span><br><span class="line">print(<span class="string">&#x27;物理&#x27;</span> <span class="keyword">in</span> a) <span class="comment"># False</span></span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h3 id="字典方法">1.6.4 字典方法</h3>
<ul>
<li><p>keys() : 返回字典的所有key</p></li>
<li><p>values() : 返回字典所有键值对应的value</p></li>
<li><p>items() : 防回字典中所有的键值对</p></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">scores = &#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>&#125;</span><br><span class="line">print(scores.keys())</span><br><span class="line">print(scores.values())</span><br><span class="line">print(scores.items())</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dict_keys([<span class="string">&#x27;数学&#x27;</span>, <span class="string">&#x27;语文&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>])</span><br><span class="line">dict_values([<span class="number">95</span>, <span class="number">89</span>, <span class="number">90</span>])</span><br><span class="line">dict_items([(<span class="string">&#x27;数学&#x27;</span>, <span class="number">95</span>), (<span class="string">&#x27;语文&#x27;</span>, <span class="number">89</span>), (<span class="string">&#x27;英语&#x27;</span>, <span class="number">90</span>)])</span><br><span class="line"><span class="comment"># keys()、values() 和 items() 返回值的类型分别为 dict_keys、dict_values 和 dict_items</span></span><br></pre></td></tr></table></figure>
<p>在 Python 2.x 中，上面三个方法的返回值都是列表（list）类型。但在 Python 3.x 中，它们的返回值并不是我们常见的列表或者元组类型，因为 Python 3.x 不希望用户直接操作这几个方法的返回值。</p>
<p>在 Python 3.x 中如果想使用这三个方法返回的数据，一般有下面两种方案：</p>
<ol type="1">
<li>使用 list() 函数，将他们转化为列表</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>&#125;</span><br><span class="line">b = <span class="built_in">list</span>(a.keys())</span><br><span class="line">print(b)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">&#x27;数学&#x27;</span>, <span class="string">&#x27;语文&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>]</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>使用 for in 循环遍历</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>&#125;</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> a.keys():</span><br><span class="line">    print(k,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;\n---------------&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> a.values():</span><br><span class="line">    print(v,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">print(<span class="string">&quot;\n---------------&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> a.items():</span><br><span class="line">    print(<span class="string">&quot;key:&quot;</span>,k,<span class="string">&quot; value:&quot;</span>,v)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">数学 语文 英语</span><br><span class="line">---------------</span><br><span class="line"><span class="number">95</span> <span class="number">89</span> <span class="number">90</span></span><br><span class="line">---------------</span><br><span class="line">key: 数学  value: <span class="number">95</span></span><br><span class="line">key: 语文  value: <span class="number">89</span></span><br><span class="line">key: 英语  value: <span class="number">90</span></span><br></pre></td></tr></table></figure>
<ul>
<li>update() 方法</li>
</ul>
<p>update方法可以使用一个字典所包含的简直对来更新已有的字典。</p>
<p>在执行 update（）方法是，如果被更新的字典中已包含对应的键值对，那么原 value会被覆盖；如果不包含对应的键值对，则该键值对被添加进去</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: <span class="number">3</span>&#125;</span><br><span class="line">a.update(&#123;<span class="string">&#x27;one&#x27;</span>:<span class="number">4.5</span>, <span class="string">&#x27;four&#x27;</span>: <span class="number">9.3</span>&#125;)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">4.5</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;four&#x27;</span>: <span class="number">9.3</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>pop() 和 popitem() 方法</li>
</ul>
<p>都是用来删除字典中键值对，不同的是，pop() 用来删除指定的键值对，而 popitem() 用来随机删除一个键值对</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname.pop(key)</span><br><span class="line">dictname.popitem()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>, <span class="string">&#x27;化学&#x27;</span>: <span class="number">83</span>, <span class="string">&#x27;生物&#x27;</span>: <span class="number">98</span>, <span class="string">&#x27;物理&#x27;</span>: <span class="number">89</span>&#125;</span><br><span class="line">print(a)</span><br><span class="line">a.pop(<span class="string">&#x27;化学&#x27;</span>)</span><br><span class="line">print(a)</span><br><span class="line">a.popitem()</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>, <span class="string">&#x27;化学&#x27;</span>: <span class="number">83</span>, <span class="string">&#x27;生物&#x27;</span>: <span class="number">98</span>, <span class="string">&#x27;物理&#x27;</span>: <span class="number">89</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>, <span class="string">&#x27;生物&#x27;</span>: <span class="number">98</span>, <span class="string">&#x27;物理&#x27;</span>: <span class="number">89</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;数学&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;语文&#x27;</span>: <span class="number">89</span>, <span class="string">&#x27;英语&#x27;</span>: <span class="number">90</span>, <span class="string">&#x27;生物&#x27;</span>: <span class="number">98</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>setdefault() 方法：返回某个 key 对应的 value</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dictname.setdefault(key, defaultvalue)</span><br><span class="line"><span class="comment"># defaultvalue 表示默认值（可以不写，不写的话是 None）</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">当指定的 key 不存在时，setdefault() 会先为这个不存在的 key 设置一个默认的 defaultvalue，然后再返回 defaultvalue</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">也就是说，setdefault() 方法总能返回指定 key 对应的 value：</span></span><br><span class="line"><span class="string">1) 如果该 key 存在，那么直接返回该 key 对应的 value；</span></span><br><span class="line"><span class="string">2) 如果该 key 不存在，那么先为该 key 设置默认的 defaultvalue，然后再返回该 key 对应的 defaultvalue。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="字典拷贝">1.6.5 字典拷贝</h3>
<p>copy() 返回一个字典的拷贝，即一个具有相同键值对的新字典</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]&#125;</span><br><span class="line">b = a.copy()</span><br><span class="line">print(b)</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;</span><br></pre></td></tr></table></figure>
<p>copy() 方法所遵循的拷贝原理，既有深拷贝，也有浅拷贝。</p>
<p>拿拷贝字典 a 为例，copy() 方法只会对最表层的键值对进行深拷贝，也就是说，它会再申请一块内存用来存放 {'one': 1, 'two': 2, 'three': []}；而对于某些列表类型的值来说，此方法对其做的是浅拷贝，也就是说，b 中的 [1,2,3] 的值不是自己独有，而是和 a 共有。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]&#125;</span><br><span class="line">b = a.copy()</span><br><span class="line"><span class="comment"># 向 a 中添加新键值对，由于b已经提前将 a 所有键值对都深拷贝过来，因此 a 添加新键值对，不会影响 b。</span></span><br><span class="line"></span><br><span class="line">a[<span class="string">&#x27;four&#x27;</span>]=<span class="number">100</span></span><br><span class="line">print(a)</span><br><span class="line">print(b)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于 b 和 a 共享[1,2,3]（浅拷贝），因此移除 a 中列表中的元素，也会影响 b。</span></span><br><span class="line">a[<span class="string">&#x27;three&#x27;</span>].remove(<span class="number">1</span>)</span><br><span class="line">print(a)</span><br><span class="line">print(b)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="string">&#x27;four&#x27;</span>: <span class="number">100</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]&#125;</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: [<span class="number">2</span>, <span class="number">3</span>], <span class="string">&#x27;four&#x27;</span>: <span class="number">100</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;three&#x27;</span>: [<span class="number">2</span>, <span class="number">3</span>]&#125;</span><br></pre></td></tr></table></figure>
<h2 id="set">1.6 set</h2>
<p>同一集合中，只能存储 <strong>不可变</strong> 的数据类型，包括整形、浮点型、字符串、元组，无法存储列表、字典、集合这些<strong>可变</strong> 的数据类型，否则会抛出 TypeError 错误。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;element1,element2,...,elementn&#125;</span><br><span class="line"><span class="comment"># Python 中有两种集合类型，一种是 set 类型的集合，另一种是 frozenset 类型的集合，它们唯一的区别是，set 类型集合可以做添加、删除元素的操作，而 forzenset 类型集合不行</span></span><br></pre></td></tr></table></figure>
<h3 id="创建-set-集合">1.6.1 创建 set 集合</h3>
<ul>
<li>使用 {} 创建</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">setname = &#123;element1,element2,...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>set() 函数创建集合</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">setname = <span class="built_in">set</span>(iteration)</span><br><span class="line"></span><br><span class="line"><span class="comment"># for example</span></span><br><span class="line">set1 = <span class="built_in">set</span>(<span class="string">&quot;c.biancheng.net&quot;</span>)</span><br><span class="line">set2 = <span class="built_in">set</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br><span class="line">set3 = <span class="built_in">set</span>((<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">print(<span class="string">&quot;set1:&quot;</span>,set1)</span><br><span class="line">print(<span class="string">&quot;set2:&quot;</span>,set2)</span><br><span class="line">print(<span class="string">&quot;set3:&quot;</span>,set3)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">set1: &#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;e&#x27;</span>&#125;</span><br><span class="line">set2: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">set3: &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="遍历-set-集合元素">1.6.2 遍历 set 集合元素</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="number">1</span>,<span class="string">&#x27;c&#x27;</span>,<span class="number">1</span>,(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),<span class="string">&#x27;c&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> ele <span class="keyword">in</span> a:</span><br><span class="line">    print(ele,end=<span class="string">&#x27; &#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="删除-set-集合">1.6.3 删除 set 集合</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = &#123;<span class="number">1</span>,<span class="string">&#x27;c&#x27;</span>,<span class="number">1</span>,(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),<span class="string">&#x27;c&#x27;</span>&#125;</span><br><span class="line">print(a)</span><br><span class="line"><span class="keyword">del</span>(a)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure>
<h3 id="集合的基本操作">1.6.4 集合的基本操作</h3>
<ul>
<li>添加元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">setname.add(element)</span><br><span class="line"><span class="comment"># 使用 add() 方法添加的元素，只能是数字、字符串、元组或者布尔类型（True 和 False）值，不能添加列表、字典、集合这类可变的数据，否则 Python 解释器会报 TypeError 错误</span></span><br></pre></td></tr></table></figure>
<ul>
<li>删除指定元素</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">setname.remove(element)</span><br></pre></td></tr></table></figure>
<ul>
<li>布尔运算（交集、并集、差集以及对称差集运算）</li>
</ul>
<p><img src="https://s3.ax1x.com/2020/11/30/DgR9hQ.gif" alt="booleanpic" style="zoom:80%;" /></p>
<center>
Fig. 1-2 集合的布尔运算
</center>
<center>
表 1-2 集合的布尔运算
</center>
<table>
<thead>
<tr class="header">
<th>运算操作</th>
<th>Python运算符</th>
<th>含义</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>交集</td>
<td>&amp;</td>
<td>取两集合公共的元素</td>
<td>&gt;&gt;&gt; set1 &amp; set2 {3}</td>
</tr>
<tr class="even">
<td>并集</td>
<td>|</td>
<td>取两集合全部的元素</td>
<td>&gt;&gt;&gt; set1 | set2 {1,2,3,4,5}</td>
</tr>
<tr class="odd">
<td>差集</td>
<td>-</td>
<td>取一个集合中另一集合没有的元素</td>
<td>&gt;&gt;&gt; set1 - set2 {1,2}</td>
</tr>
<tr class="even">
<td>对称差集</td>
<td>^</td>
<td>取集合 A 和 B 中不属于 A&amp;B 的元素</td>
<td>&gt;&gt;&gt; set1 ^ set2 {1,2,4,5}</td>
</tr>
</tbody>
</table>
<h3 id="set-集合方法详解">1.6.5 set 集合方法详解</h3>
<p><a href="http://c.biancheng.net/view/4402.html">set 集合方法详解</a></p>
<h1 id="python-函数操作">2. Python 函数操作</h1>
<h2 id="系统函数">2.1 系统函数</h2>
<h3 id="input">2.1.1 input()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span> = <span class="built_in">input</span>(tipmsg)</span><br></pre></td></tr></table></figure>
<ul>
<li>str 表示一个字符串类型的变量，input 会将读取到的字符串放入 str 中</li>
<li>tipmsg 表示提示信息，它会显示在控制台上，告诉用户应该输入什么样的内容；如果不写 tipmsg，就不会有任何提示信息</li>
</ul>
<h3 id="pirnt">2.1.2 pirnt()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(value,..., sep =<span class="string">&#x27;&#x27;</span>, end = <span class="string">&#x27;\n&#x27;</span>, file = sys.stdout, flush = <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>value 参数可以接受任意多个变量或值，如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user_name = <span class="string">&#x27;Charlie&#x27;</span></span><br><span class="line">user_age = <span class="number">8</span></span><br><span class="line"><span class="comment">#同时输出多个变量和字符串</span></span><br><span class="line">print(<span class="string">&quot;读者名：&quot;</span>,user_name,<span class="string">&quot;年龄：&quot;</span>,user_age, sep = <span class="string">&#x27;|&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="字符串方法">2.2 字符串方法</h2>
<h3 id="字符串拼接">2.2.1 字符串拼接</h3>
<ul>
<li>字符串和数字的拼接</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>(obj)</span><br><span class="line"><span class="built_in">repr</span>(obj)</span><br><span class="line"><span class="comment">#  Python 不允许直接拼接数字和字符串，需要借助str() 和 repr() 函数将数字转换为字符串</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>str() 和 repr() 的区别</strong></p>
<p>str() 和 repr() 函数虽然都可以将数字转换成字符串，但它们之间是有区别的： 1) str() 将数据转换成适合人类阅读的字符串形式 2) repr() 将数据转换成适合解释器阅读的字符串形式（Python 表达式的形式），适合在开发和调试阶段使用；如果没有等价的语法，则会发生 SyntaxError 异常。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="string">&quot;http://c.biancheng.net/shell/&quot;</span></span><br><span class="line">s_str = <span class="built_in">str</span>(s)</span><br><span class="line">s_repr = <span class="built_in">repr</span>(s)</span><br><span class="line">print( <span class="built_in">type</span>(s_str) )</span><br><span class="line"><span class="built_in">print</span> (s_str)</span><br><span class="line">print( <span class="built_in">type</span>(s_repr) )</span><br><span class="line"><span class="built_in">print</span> (s_repr)</span><br></pre></td></tr></table></figure>
<p>​ 运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">str</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">http</span>:</span>//c.biancheng.net/shell/</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">str</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">&#x27;<span class="title">http</span>:</span>//c.biancheng.net/shell/<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="截取字符串">2.2.2 截取字符串</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">strname[index]</span><br><span class="line">strname[start : end : step]</span><br></pre></td></tr></table></figure>
<h3 id="len">2.2.3 len()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">len</span>（<span class="built_in">str</span>）</span><br><span class="line"><span class="comment"># 在 Python 中，不同的字符所占的字节数不同，数字、英文字母、小数点、下划线以及空格，各占一个字节，而一个汉字可能占 2~4 个字节，具体占多少个，取决于采用的编码方式。例如，汉字在 GBK/GB2312 编码中占用 2 个字节，而在 UTF-8 编码中一般占用 3 个字节</span></span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2020/11/30/DgRPpj.gif" /></p>
<center>
图 2-1 UTF-8
</center>
<h3 id="split">2.2.4 split()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.split(sep,maxsplit)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">str: 表示要分割的字符串</span></span><br><span class="line"><span class="string">sep: 用于指定分隔符，可以包含多个字符，默认为 None，表示所有空字符</span></span><br><span class="line"><span class="string">maxsplit：可选参数，用于指定分割的次数，最后列表中子串的个数最多为 maxsplit+1。如果不指定或者指定为 -1，则表示分割次数没有限制。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="join">2.2.5 join()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">newstr = <span class="built_in">str</span>.join(iterable)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">newstr：表示合并后生成的新字符串；</span></span><br><span class="line"><span class="string">str：用于指定合并时的分隔符；</span></span><br><span class="line"><span class="string">iterable：做合并操作的源字符串数据，允许以列表、元组等形式提供。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span> = [<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;biancheng&#x27;</span>,<span class="string">&#x27;net&#x27;</span>]</span><br><span class="line"><span class="string">&#x27;.&#x27;</span>.join(<span class="built_in">list</span>)</span><br><span class="line"><span class="comment"># 运行结果： &#x27;c.biancheng.net&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="count">2.2.6 count()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.count(sub[,start[,end]])</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">str：表示原字符串；</span></span><br><span class="line"><span class="string">sub：表示要检索的字符串；</span></span><br><span class="line"><span class="string">start：指定检索的起始位置，也就是从什么位置开始检测。如果不指定，默认从头开始检索；</span></span><br><span class="line"><span class="string">end：指定检索的终止位置，如果不指定，则表示一直检索到结尾。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span> = <span class="string">&quot;c.biancheng.net&quot;</span></span><br><span class="line"><span class="built_in">str</span>.count(<span class="string">&#x27;.&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="find">2.2.7 find()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.find(sub[,start[,end]])</span><br></pre></td></tr></table></figure>
<h3 id="index">2.2.8 index()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.index(sub[,start[,end]])</span><br><span class="line"><span class="comment"># 同 find() 方法类似，index() 方法也可以用于检索是否包含指定的字符串，不同之处在于，当指定的字符串不存在时，index() 方法会抛出异常</span></span><br></pre></td></tr></table></figure>
<h3 id="对齐">2.2.9 对齐</h3>
<ul>
<li>ljust()</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">S.ljust(width[, fillchar])</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">S：表示要进行填充的字符串；</span></span><br><span class="line"><span class="string">width：表示包括本身长度在内，字符串要占的总长度；</span></span><br><span class="line"><span class="string">fillchar：作为可选参数，用来指定填充字符串时所用的字符，默认情况使用空格。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>rjust()</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">S.rjust(width[, fillchar])</span><br></pre></td></tr></table></figure>
<ul>
<li>center()</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">S.center(width[, fillchar])</span><br></pre></td></tr></table></figure>
<h3 id="startswith-和-endswith">2.2.10 startswith() 和 endswith()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.startswith(sub[,start[,end]])</span><br><span class="line"><span class="comment"># 检索字符串是否以指定字符串开头，如果是返回 True；反之返回 False</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span>.endswith(sub[,start[,end]])</span><br><span class="line"><span class="comment"># endswith() 方法用于检索字符串是否以指定字符串结尾，如果是则返回 True；反之则返回 False</span></span><br></pre></td></tr></table></figure>
<h3 id="大小写转换">2.2.11 大小写转换</h3>
<ul>
<li>title()</li>
<li>lower()</li>
<li>upper()</li>
</ul>
<h3 id="strip">2.2.12 strip()</h3>
<ul>
<li>strip()：删除串前后（左右两侧）的空格或特殊字符</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span> = <span class="string">&quot;  c.biancheng.net \t\n\r&quot;</span></span><br><span class="line"><span class="built_in">str</span>.strip()</span><br><span class="line"><span class="comment"># &#x27;c.biancheng.net&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span>.strip(<span class="string">&quot; ,\r&quot;</span>)</span><br><span class="line"><span class="comment"># &#x27;c.biancheng.net \t\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">str</span></span><br><span class="line"><span class="comment"># &#x27;  c.biancheng.net \t\n\r&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># strip() 并没有改变字符本身</span></span><br></pre></td></tr></table></figure>
<ul>
<li>lstrip()：删除字符串前面（左边）的空格或特殊字符</li>
<li>rstrip()：删除字符串后面（右边）的空格或特殊字符</li>
</ul>
<h3 id="format">2.2.13 format()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.<span class="built_in">format</span>(args)</span><br><span class="line"><span class="comment"># str 用于指定字符串的显示样式；args 用于指定要进行格式转换的项，如果有多项，之间有逗号进行分割</span></span><br></pre></td></tr></table></figure>
<p>学习 format() 方法的难点，在于搞清楚 str 显示样式的书写格式。在创建显示样式模板时，需要使用<code>&#123;&#125;</code>和<code>：</code>来指定占位符，其完整的语法格式为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123; [index][ : [ [fill] align] [sign] [<span class="comment">#] [width] [.precision] [type] ] &#125;</span></span><br></pre></td></tr></table></figure>
<p>具体参照：<a href="http://c.biancheng.net/view/4301.html">format完整</a></p>
<h3 id="encode-和-decode">2.2.14 encode() 和 decode()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.encode([encoding=<span class="string">&quot;utf-8&quot;</span>][,errors=<span class="string">&quot;strict&quot;</span>])</span><br><span class="line"><span class="comment"># encoding=&quot;GBK&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">bytes</span>.decode([encoding=<span class="string">&quot;utf-8&quot;</span>][,errors=<span class="string">&quot;strict&quot;</span>])</span><br></pre></td></tr></table></figure>
<center>
表 2-2 encode() 参数
</center>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 76%" />
</colgroup>
<thead>
<tr class="header">
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>str</td>
<td>表示要进行转换的字符串。</td>
</tr>
<tr class="even">
<td>encoding = "utf-8"</td>
<td>指定进行编码时采用的字符编码，该选项默认采用 utf-8 编码。例如，如果想使用简体中文，可以设置 gb2312。<br /> 当方法中只使用这一个参数时，可以省略前边的“encoding=”，直接写编码格式，例如 str.encode("UTF-8")。</td>
</tr>
<tr class="odd">
<td>errors = "strict"</td>
<td>指定错误处理方式，其可选择值可以是：<br />1) strict：遇到非法字符就抛出异常。<br />2) ignore：忽略非法字符。<br />3) replace：用“？”替换非法字符。<br />4) xmlcharrefreplace：使用 xml 的字符引用。该参数的默认值为 strict。</td>
</tr>
</tbody>
</table>
<h3 id="dir-和-help">2.2.15 dir() 和 help()</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dir</span>(obj)</span><br><span class="line"><span class="built_in">help</span>(obj)</span><br></pre></td></tr></table></figure>
<h1 id="python-运算符">3. Python 运算符</h1>
<h2 id="escape-character">3.1 Escape character</h2>
<p>转义字符以 <code>\0、\x</code> 开头，以 <code>\x</code> 开头表示后跟十六进制形势的编码值，Python中的转义字符只能使用八进制或十六进制</p>
<p>ASCII编码共收录了128个字符，<code>\0</code> 、<code>\x</code> 后面最多只能跟两位数字，所以八进制形势并不能表示所有的ASCII字符，只有十六进制才能表示所有的ASCII字符</p>
<center>
表3-1 转义字符一览表
</center>
<table>
<thead>
<tr class="header">
<th>转义字符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td>换行符，将光标位置移到下一行开头。</td>
</tr>
<tr class="even">
<td> 回车符，将光标位置移到本行开头。</td>
<td></td>
</tr>
<tr class="odd">
<td> 水平制表符，也即 Tab 键，一般相当于四个空格。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>蜂鸣器响铃。注意不是喇叭发声，现在的计算机很多都不带蜂鸣器了，所以响铃不一定有效。</td>
</tr>
<tr class="odd">
<td> 退格（Backspace），将光标位置移到前一列。</td>
<td></td>
</tr>
<tr class="even">
<td>\\</td>
<td>反斜线</td>
</tr>
<tr class="odd">
<td>\'</td>
<td>单引号</td>
</tr>
<tr class="even">
<td>\"</td>
<td>双引号</td>
</tr>
<tr class="odd">
<td>\</td>
<td>在字符串行尾的续行符，即一行未完，转到下一行继续写。</td>
</tr>
</tbody>
</table>
<h2 id="位运算符">3.2 位运算符</h2>
<p>位运算符是指按照数据在内存中的二进制位进行操作</p>
<center>
表3-2 位运算符一览表
</center>
<table>
<thead>
<tr class="header">
<th>位运算符</th>
<th>说明</th>
<th>适用形式</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>&amp;</td>
<td>按位与</td>
<td>a &amp; b</td>
<td>4 &amp; 5</td>
</tr>
<tr class="even">
<td>|</td>
<td>按位或</td>
<td>a | b</td>
<td>4 | 5</td>
</tr>
<tr class="odd">
<td>^</td>
<td>按位异或</td>
<td>a ^ b</td>
<td>4 ^ 5</td>
</tr>
<tr class="even">
<td>~</td>
<td>按位取反</td>
<td>~a</td>
<td>~4</td>
</tr>
<tr class="odd">
<td>&lt;&lt;</td>
<td>按位左移</td>
<td>a &lt;&lt; b</td>
<td>4 &lt;&lt; 2，表示整数 4 按位左移 2 位</td>
</tr>
<tr class="even">
<td>&gt;&gt;</td>
<td>按位右移</td>
<td>a &gt;&gt; b</td>
<td>4 &gt;&gt; 2，表示整数 4 按位右移 2 位</td>
</tr>
</tbody>
</table>
<h2 id="比较运算符">3.3 比较运算符</h2>
<center>
表3-3 比较运算符一览表
</center>
<table>
<thead>
<tr class="header">
<th>比较运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>&gt;</td>
<td>大于，如果<code>&gt;</code>前面的值大于后面的值，则返回 True，否则返回 False。</td>
</tr>
<tr class="even">
<td>&lt;</td>
<td>小于，如果<code>&lt;</code>前面的值小于后面的值，则返回 True，否则返回 False。</td>
</tr>
<tr class="odd">
<td>==</td>
<td>等于，如果<code>==</code>两边的值相等，则返回 True，否则返回 False。</td>
</tr>
<tr class="even">
<td>&gt;=</td>
<td>大于等于（等价于数学中的 ≥），如果<code>&gt;=</code>前面的值大于或者等于后面的值，则返回 True，否则返回 False。</td>
</tr>
<tr class="odd">
<td>&lt;=</td>
<td>小于等于（等价于数学中的 ≤），如果<code>&lt;=</code>前面的值小于或者等于后面的值，则返回 True，否则返回 False。</td>
</tr>
<tr class="even">
<td>!=</td>
<td>不等于（等价于数学中的 ≠），如果<code>!=</code>两边的值不相等，则返回 True，否则返回 False。</td>
</tr>
<tr class="odd">
<td>is</td>
<td>判断两个变量所引用的对象是否相同，如果相同则返回 True，否则返回 False。</td>
</tr>
<tr class="even">
<td>is not</td>
<td>判断两个变量所引用的对象是否不相同，如果不相同则返回 True，否则返回 False。</td>
</tr>
</tbody>
</table>
<ul>
<li>== 和 is 的区别</li>
</ul>
<p>== 用来比较两个变量的值是否相等，而 is 则用来比对两个变量引用的是否是同一个对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time  <span class="comment">#引入time模块</span></span><br><span class="line">t1 = time.gmtime() <span class="comment"># gmtime()用来获取当前时间</span></span><br><span class="line">t2 =  time.gmtime()</span><br><span class="line">print(t1 == t2) <span class="comment">#输出True</span></span><br><span class="line">print(t1 <span class="keyword">is</span> t2) <span class="comment">#输出False</span></span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">time 模块的 gmtime() 方法用来获取当前的系统时间，精确到秒级，因为程序运行非常快，所以 t1 和 t1 得到的时间是一样的。== 用来判断 t1 和 t2 的值是否相等，所以返回 True。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="逻辑运算符">3.4 逻辑运算符</h2>
<center>
表3-4 逻辑运算符一览表
</center>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 27%" />
<col style="width: 7%" />
<col style="width: 55%" />
</colgroup>
<thead>
<tr class="header">
<th>逻辑运算符</th>
<th>含义</th>
<th>基本格式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>and</td>
<td>逻辑与运算，等价于数学中的“且”</td>
<td>a and b</td>
<td>当 a 和 b 两个表达式都为真时，a and b 的结果才为真，否则为假。</td>
</tr>
<tr class="even">
<td>or</td>
<td>逻辑或运算，等价于数学中的“或”</td>
<td>a or b</td>
<td>当 a 和 b 两个表达式都为假时，a or b 的结果才是假，否则为真。</td>
</tr>
<tr class="odd">
<td>not</td>
<td>逻辑非运算，等价于数学中的“非”</td>
<td>not a</td>
<td>如果 a 为真，那么 not a 的结果为假；如果 a 为假，那么 not a 的结果为真。相当于对 a 取反。</td>
</tr>
</tbody>
</table>
<h2 id="三目运算符">3.5 三目运算符</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">max</span> = a <span class="keyword">if</span> a&gt;b <span class="keyword">else</span> b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上述代码实现如下功能</span></span><br><span class="line"><span class="keyword">if</span> a&gt;b:</span><br><span class="line">    <span class="built_in">max</span> = a;</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">max</span> = b;</span><br></pre></td></tr></table></figure>
<h2 id="数字操作符">3.6 数字操作符</h2>
<center>
表 3-5 数字操作符（优先级递减）
</center>
<table>
<thead>
<tr class="header">
<th>操作符</th>
<th>操作</th>
<th>示例</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>**</td>
<td>指数</td>
<td>2**3</td>
<td>8</td>
</tr>
<tr class="even">
<td>%</td>
<td>取模/取余数</td>
<td>22%8</td>
<td>6</td>
</tr>
<tr class="odd">
<td>//</td>
<td>整除/商数取整</td>
<td>22//8</td>
<td>2</td>
</tr>
<tr class="even">
<td>/</td>
<td>除法</td>
<td>22/8</td>
<td>2.75</td>
</tr>
<tr class="odd">
<td>*</td>
<td>乘法</td>
<td>3*5</td>
<td>15</td>
</tr>
<tr class="even">
<td>*</td>
<td>字符串复制</td>
<td>['s'] * 4</td>
<td>['s', ',s', 's', 's']</td>
</tr>
<tr class="odd">
<td>-</td>
<td>减法</td>
<td>5-2</td>
<td>3</td>
</tr>
<tr class="even">
<td>+</td>
<td>加法</td>
<td>2+2</td>
<td>4</td>
</tr>
</tbody>
</table>
<h1 id="python-流程控制">4. Python 流程控制</h1>
<h2 id="pass">4.1 pass</h2>
<p><strong>pass</strong> 是 Python 中的关键字，用来让解释器跳过此处，什么都不做</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">age = <span class="built_in">int</span>( <span class="built_in">input</span>(<span class="string">&quot;请输入你的年龄：&quot;</span>) )</span><br><span class="line"><span class="keyword">if</span> age &lt; <span class="number">12</span> :</span><br><span class="line">    print(<span class="string">&quot;婴幼儿&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> age &gt;= <span class="number">12</span> <span class="keyword">and</span> age &lt; <span class="number">18</span>:</span><br><span class="line">    print(<span class="string">&quot;青少年&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> age &gt;= <span class="number">18</span> <span class="keyword">and</span> age &lt; <span class="number">30</span>:</span><br><span class="line">    print(<span class="string">&quot;成年人&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> age &gt;= <span class="number">30</span> <span class="keyword">and</span> age &lt; <span class="number">50</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&quot;老年人&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="assert-断言">4.2 assert 断言</h2>
<p>assert 语句，又称断言语句，可看做是功能缩小版的 if 语句，用于判断某个表达式的值，如果值为真，则程序可以继续往下执行；反之，会报 AssertionError 错误</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">assert</span> 表达式</span><br><span class="line"></span><br><span class="line"><span class="comment"># 功能与下式类似</span></span><br><span class="line"><span class="keyword">if</span> 表达式==<span class="literal">True</span>:</span><br><span class="line">    程序继续执行</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    程序报 AssertionError 错误</span><br></pre></td></tr></table></figure>
<h2 id="break-和-continue">4.3 break 和 continue</h2>
<ul>
<li><p>break 语句，可以完全终止当前循环</p></li>
<li><p>continue 语句，可以跳过执行本次循环体中剩余的代码，转而执行下一次的循环</p></li>
</ul>
<h2 id="zip">4.4 zip()</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">zip</span>(iterable, ...)</span><br><span class="line"><span class="comment">#  iterable,... 表示多个列表、元组、字典、集合、字符串，甚至还可以为 range() 区间</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">my_list = [<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>]</span><br><span class="line">my_tuple = (<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line">print([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">zip</span>(my_list,my_tuple)])</span><br><span class="line"></span><br><span class="line">my_dic = &#123;<span class="number">31</span>:<span class="number">2</span>,<span class="number">32</span>:<span class="number">4</span>,<span class="number">33</span>:<span class="number">5</span>&#125;</span><br><span class="line">my_set = &#123;<span class="number">41</span>,<span class="number">42</span>,<span class="number">43</span>,<span class="number">44</span>&#125;</span><br><span class="line"></span><br><span class="line">print([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">zip</span>(my_dic)])</span><br><span class="line"></span><br><span class="line">my_pychar = <span class="string">&quot;python&quot;</span></span><br><span class="line">my_shechar = <span class="string">&quot;shell&quot;</span></span><br><span class="line"></span><br><span class="line">print([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">zip</span>(my_pychar,my_shechar)])</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[(<span class="number">11</span>, <span class="number">21</span>), (<span class="number">12</span>, <span class="number">22</span>), (<span class="number">13</span>, <span class="number">23</span>)]</span><br><span class="line">[(<span class="number">31</span>,), (<span class="number">32</span>,), (<span class="number">33</span>,)]</span><br><span class="line">[(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;s&#x27;</span>), (<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;h&#x27;</span>), (<span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;e&#x27;</span>), (<span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;l&#x27;</span>), (<span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;l&#x27;</span>)]</span><br></pre></td></tr></table></figure>
<h2 id="reversed">4.5 reversed()</h2>
<p>reserved() 可以返回一个给定序列的逆序序列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将列表进行逆序</span></span><br><span class="line">print([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">reversed</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将元组进行逆序</span></span><br><span class="line">print([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">reversed</span>((<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>))])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将字符串进行逆序</span></span><br><span class="line">print([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="string">&quot;abcdefg&quot;</span>)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 range() 生成的区间列表进行逆序</span></span><br><span class="line">print([x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(<span class="number">10</span>))])</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">[<span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]</span><br><span class="line">[<span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">[<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<h2 id="sorted">4.6 sorted()</h2>
<p>sorted() 用于给序列（列表、元组、字典、集合、字符串）进行排序</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span> = <span class="built_in">sorted</span>(iterable, key=<span class="literal">None</span>, reverse=<span class="literal">False</span>)  </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">key 参数可以自定义排序规则</span></span><br><span class="line"><span class="string">reverse 参数指定以升序（False，默认）还是降序（True）进行排序</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h1 id="python-程序打包">5 Python 程序打包</h1>
<h2 id="需求分析">5.1 需求分析</h2>
<p>在写 <code>python</code> 程序时，难免会遇到一些需求，比如给别人写一个小工具什么的但是除了写 <code>Python</code> 的，绝大多数人电脑里都没有<code>Python</code> 编译器，所以打包成 <code>exe</code>，让 <code>Windows</code> 用户双击就可以打开，就非常方便了。</p>
<p>打包最常用的工具有 <code>py2exe</code>, <code>cxfree</code>, <code>pyinstaller</code> 等多种方法，不同方法的优缺点自行谷歌，经过多次尝试和对比，笔者觉得 <code>pyintaller</code> 是最方便使用的，因此本节以 <code>pyintaller</code> 为例介绍如何将 <code>py</code> 文件打包为 <code>exe</code> 可执行文件。</p>
<h2 id="直接打包">5.2 直接打包</h2>
<ul>
<li><p>安装 pyinstaller</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install pyinstaller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接安装比较慢，建议从国内镜像站进行安装</span></span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pyinstaller</span><br></pre></td></tr></table></figure></li>
<li><p>打包命令</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pyinstaller -F -w py-file-path --distpath=outputpath</span><br><span class="line"><span class="comment"># py-file-path 为需要打包为exe文件的位置</span></span><br><span class="line"><span class="comment"># outputpath 为输出位置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For example</span></span><br><span class="line">pyinstaller -F -w <span class="string">&quot;./excel_to_word.py&quot;</span> --distpath=<span class="string">&quot;./output&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>虽然这种方式较为简单，但是打包过程非常缓慢，同时结果文件非常大，笔者写了一个十几行的代码，打包出来的代码有足足 <code>387M</code>。</p>
<p>有人说，这是因为 <code>Anaconda</code> 里内置了很多库，打包的时候打包了很多不必要的模块进去，要用纯净的 <code>Python</code> 来打包。因此介绍如何给 <code>exe</code> 文件瘦身。</p>
<h2 id="利用虚拟环境打包">5.2 利用虚拟环境打包</h2>
<ul>
<li><p>代码规范</p>
<p>在写代码时尽量使用 <code>from * import *</code> 的命令，而不是直接使用 <code>import</code> 命令，这样打包时会少导入一些模块内容。</p></li>
<li><p>创建虚拟环境</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cd <span class="string">&quot;D:\Program Datas\Python\Venv&quot;</span> <span class="comment"># 存放虚拟环境的目录</span></span><br><span class="line"></span><br><span class="line">python -m venv pyintall <span class="comment">#创建名为 pyintall 的虚拟环境</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入虚拟环境目录</span></span><br><span class="line">cd <span class="string">&quot;.\pyintall\Scripts\&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 激活虚拟环境</span></span><br><span class="line"><span class="string">activate.abat</span></span><br></pre></td></tr></table></figure></li>
<li><p>安装代码中需要的模块</p>
<p>该安装是在上述创建的虚拟环境中安装，后面的步骤也是在虚拟环境中进行处理。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 建议使用镜像安装和 pyinstaller</span></span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pakage-name</span><br></pre></td></tr></table></figure></li>
<li><p>打包</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pyinstaller -F -w <span class="string">&quot;./excel_to_word.py&quot;</span> --distpath=<span class="string">&quot;./output&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>退出虚拟环境</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 退出当前虚拟环境</span></span><br><span class="line">.\venv\Scripts\deactivate.bat</span><br></pre></td></tr></table></figure>
<p>如要删除虚拟环境，仅需将该文件夹直接删除就可。</p></li>
</ul>
<p>最后打包出来的文件足足缩小了十几倍，仅剩十几兆，因此，虽然该方法会麻烦些，但建议使用该方法进行打包。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cd <span class="string">&quot;D:\Program Datas\Python\Venv&quot;</span> <span class="comment"># 存放虚拟环境的目录</span></span><br><span class="line"></span><br><span class="line">python -m venv pyintall <span class="comment">#创建名为 pyintall 的虚拟环境</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入虚拟环境目录</span></span><br><span class="line">cd <span class="string">&quot;.\pyintall\Scripts\&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 激活虚拟环境</span></span><br><span class="line"><span class="string">activate.abat</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 退出当前虚拟环境</span></span><br><span class="line"><span class="string">.\venv\Scripts\deactivate.bat</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Notes</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Pytorch-2-Autogradient</title>
    <url>/2021/08/04/Pytorch-2-Autogradient/</url>
    <content><![CDATA[<h1 id="什么是pytorch">1. 什么是PyTorch?</h1>
<p>PyTorch是一个基于Python的科学计算库，它有以下特点:</p>
<ul>
<li>类似于 NumPy，但是它可以使用 GPU</li>
<li>可以用它定义深度学习模型，可以灵活地进行深度学习模型的训练和使用</li>
</ul>
<a id="more"></a>
<h2 id="tensors">1.1 Tensors</h2>
<p>Tensor 类似与 NumPy 的 ndarray，唯一的区别是 Tensor 可以在 GPU 上加速运算。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure>
<ul>
<li><p>构造一个未初始化的 5x3 矩阵:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.empty(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">x</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[1.0194e-38, 9.1837e-39, 8.4490e-39],
        [9.6429e-39, 8.4490e-39, 9.6429e-39],
        [9.2755e-39, 1.0286e-38, 9.0919e-39],
        [8.9082e-39, 9.2755e-39, 8.4490e-39],
        [1.0194e-38, 9.0919e-39, 8.4490e-39]])</code></pre></li>
<li><p>构建一个随机初始化的矩阵:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.rand(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">x</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[0.1782, 0.5218, 0.1660],
        [0.4009, 0.0275, 0.8139],
        [0.6904, 0.4813, 0.7811],
        [0.4067, 0.6289, 0.5081],
        [0.0305, 0.9687, 0.0834]])</code></pre></li>
<li><p>构建一个全部为 0，类型为 long 的矩阵:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.zeros(<span class="number">5</span>,<span class="number">3</span>,dtype=torch.long)</span><br><span class="line">x1 = torch.zeros(<span class="number">5</span>,<span class="number">3</span>).long() <span class="comment"># Equals</span></span><br><span class="line">x</span><br><span class="line">x2.dtype</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[0, 0, 0],
        [0, 0, 0],
        [0, 0, 0],
        [0, 0, 0],
        [0, 0, 0]])
torch.int64</code></pre></li>
<li><p>从数据直接直接构建 tensor:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.tensor([<span class="number">5.5</span>,<span class="number">3</span>])</span><br><span class="line">x</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([5.5000, 3.0000])</code></pre></li>
<li><p>1 矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = x.new_ones(<span class="number">5</span>,<span class="number">3</span>, dtype=torch.double)</span><br><span class="line">x</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[1., 1., 1.],
        [1., 1., 1.],
        [1., 1., 1.],
        [1., 1., 1.],
        [1., 1., 1.]], dtype=torch.float64)</code></pre></li>
<li><p>randn_like</p>
<p>也可以从一个已有的tensor构建一个tensor。这些方法会重用原来tensor的特征，例如，数据类型，除非提供新的数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.randn_like(x, dtype=torch.<span class="built_in">float</span>)</span><br><span class="line">x</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[-0.3863, -1.4149, -0.1054],
        [ 2.3531,  0.2044, -1.5104],
        [ 0.2127, -0.5231, -0.7806],
        [-0.9173, -0.0242,  0.1667],
        [-1.3101,  1.2451, -0.3665]])</code></pre></li>
<li><p>得到 tensor 的形状:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x.shape</span><br><span class="line">x.size()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>torch.Size([5, 3])
torch.Size([5, 3])</code></pre></li>
</ul>
<strong>Notes</strong>: <code>torch.Size</code> 返回的是一个tuple
</p>
</div>
<h2 id="operations">1.2 Operations</h2>
<p>有很多种tensor运算。我们先介绍加法运算。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y = torch.rand(<span class="number">5</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>加法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x + y <span class="comment"># Way 1</span></span><br><span class="line">torch.add(x, y) <span class="comment"># Way 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Store the Results into a new variable</span></span><br><span class="line">result = torch.empty(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">torch.add(x, y, out=result)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[-0.0267, -1.1529,  0.7544],
        [ 2.8445,  1.0922, -1.3458],
        [ 0.6769, -0.2879, -0.7209],
        [-0.1200,  0.8094,  0.3603],
        [-0.3267,  2.1897, -0.3474]])</code></pre></li>
<li><p>in-place加法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y.add_(x)</span><br><span class="line">y</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[-0.0267, -1.1529,  0.7544],                [ 2.8445,  1.0922, -1.3458],                [ 0.6769, -0.2879, -0.7209],                [-0.1200,  0.8094,  0.3603],                [-0.3267,  2.1897, -0.3474]])</code></pre>
<p><strong>Note</strong>: 任何 <code>in-place</code> 的运算都会以 <code>_</code> 结尾。举例来说：<code>x.copy_(y)</code>, <code>x.t_()</code>, 这些 <code>in-place</code> 方法会改变变量 <code>x</code>。</p></li>
<li><p>Index</p>
<p>各种类似 NumPy 的 indexing 都可以在 PyTorch tensor 上面使用。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x[<span class="number">1</span>:, <span class="number">1</span>:]</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[ 0.2044, -1.5104],        [-0.5231, -0.7806],        [-0.0242,  0.1667],        [ 1.2451, -0.3665]])</code></pre></li>
<li><p>Resizing</p>
<p>如果希望 <code>resize/reshape</code> 一个 <code>tensor</code>，可以使用 <code>torch.view</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.randn(<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">y = x.view(<span class="number">16</span>)</span><br><span class="line">z = x.view(-<span class="number">1</span>,<span class="number">8</span>)</span><br><span class="line">z</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[ 1.1355, -1.1149, -0.1322, -0.8217,  0.7920,  0.6061,  0.7453,  1.1177],
        [ 0.7566,  1.3975, -0.8014,  0.5999, -0.1476, -0.5695, -1.3861, -0.4741]])</code></pre></li>
<li><p>取得数值</p>
<p>如果你有一个只有一个元素的 <code>tensor</code>，使用 <code>.item()</code> 方法可以把里面的 value 变成 Python 数值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.randn(<span class="number">1</span>)</span><br><span class="line">x</span><br><span class="line">x.item()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([-1.4227])
-1.422684907913208</code></pre></li>
<li><p>转置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">z.transpose(<span class="number">1</span>, <span class="number">0</span>)z.t()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([[ 1.1355,  0.7566],        [-1.1149,  1.3975],        [-0.1322, -0.8014],        [-0.8217,  0.5999],        [ 0.7920, -0.1476],        [ 0.6061, -0.5695],        [ 0.7453, -1.3861],        [ 1.1177, -0.4741]])</code></pre></li>
</ul>
<p><strong>更多阅读</strong></p>
<p>各种 Tensor operations, 包括 transposing, indexing, slicing, mathematical operations, linear algebra, random numbers 在 <a href="https://pytorch.org/docs/torch">PyTorch Documentation</a>.</p>
<h2 id="numpy-和-tensor-之间的转化">1.3 Numpy 和 Tensor 之间的转化</h2>
<p>在 Torch Tensor 和 NumPy array 之间相互转化非常容易。</p>
<p><strong>Note</strong>: Torch Tensor和 NumPy array 会共享内存，所以改变其中一项也会改变另一项。</p>
<ul>
<li><p>Tensor to ndarray</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.ones(<span class="number">5</span>) <span class="comment"># a = tensor([1., 1., 1., 1., 1.])b = a.numpy() # b = array([1., 1., 1., 1., 1.], dtype=float32)</span></span><br></pre></td></tr></table></figure>
<p>改变numpy array里面的值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">b[<span class="number">1</span>] = <span class="number">2</span> <span class="comment"># b = array([1., 2., 1., 1., 1.], dtype=float32)         # a = tensor([1., 2., 1., 1., 1.])</span></span><br></pre></td></tr></table></figure></li>
<li><p>ndarray to Tensor</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = np.ones(<span class="number">5</span>)</span><br><span class="line">b = torch.from_numpy(a)</span><br><span class="line">np.add(a, <span class="number">1</span>, out=a)</span><br><span class="line">print(a)</span><br><span class="line">pirnt(a)</span><br></pre></td></tr></table></figure>
<pre><code>[2. 2. 2. 2. 2.]
[2. 2. 2. 2. 2.]</code></pre>
<p><strong>Note</strong>: 所有 <code>CPU</code> 上的 Tensor 都支持转成 numpy 或者从 numpy 转成 Tensor。</p></li>
</ul>
<h2 id="cuda-tensors">1.4 CUDA Tensors</h2>
<p>使用<code>.to</code>方法，Tensor可以被移动到别的device上。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">    device = torch.device(<span class="string">&quot;cuda&quot;</span>)    </span><br><span class="line">    y = torch.ones_like(x, device=device)    </span><br><span class="line">    x = x.to(device)    </span><br><span class="line">    z = x + y    </span><br><span class="line">    print(z)    </span><br><span class="line">    print(z.to(<span class="string">&quot;cpu&quot;</span>, torch.double))    </span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([-0.4227], device=&#39;cuda:0&#39;)
tensor([-0.4227], dtype=torch.float64)</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y.to(<span class="string">&quot;cpu&quot;</span>).data.numpy()y.cpu().data.numpy()</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>array([1.], dtype=float32)</code></pre>
<h1 id="bi-linear-nn-with-numpy">2. Bi-Linear NN with numpy</h1>
<p>一个全连接ReLU神经网络，一个隐藏层，没有 bias。用来从 x 预测 y，使用 L2 Loss。</p>
<ul>
<li><span class="math inline">\(h = W_1X\)</span></li>
<li><span class="math inline">\(a = max(0, h)\)</span></li>
<li><span class="math inline">\(y_{hat} = W_2a\)</span></li>
</ul>
<p>这一实现完全使用numpy来计算前向神经网络，loss，和反向传播。</p>
<ul>
<li>forward pass</li>
<li>loss</li>
<li>backward pass</li>
</ul>
<p>numpy ndarray 是一个普通的 n 维 array。它不知道任何关于深度学习或者梯度 ( <code>gradient</code>) 的知识，也不知道计算图 (<code>computation graph</code>)，只是一种用来计算数学运算的数据结构。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span><span class="comment"># 随机创建一些训练数据x = np.random.randn(N, D_in)y = np.random.randn(N, D_out)w1 = np.random.randn(D_in, H)w2 = np.random.randn(H, D_out)learning_rate = 1e-6for it in range(500):    # Forward pass    h = x.dot(w1) # N * H    h_relu = np.maximum(h, 0) # N * H    y_pred = h_relu.dot(w2) # N * D_out    # compute loss    loss = np.square(y_pred - y).sum()    if it%50 == 0:        print(it, loss)    # Backward pass    # compute the gradient    grad_y_pred = 2.0 * (y_pred - y)    grad_w2 = h_relu.T.dot(grad_y_pred)    grad_h_relu = grad_y_pred.dot(w2.T)    grad_h = grad_h_relu.copy()    grad_h[h&lt;0] = 0    grad_w1 = x.T.dot(grad_h)    # update weights of w1 and w2    w1 -= learning_rate * grad_w1    w2 -= learning_rate * grad_w2</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>0 30767183.85959570550 19309.70472025325100 927.7120364511059150 65.96723021925985200 5.451127574769099250 0.4979445419484826300 0.04972286885320139350 0.0053918752712101775400 0.0006287349147432031450 7.778529921424317e-05</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">h = x.dot(w1)h_relu = np.maximum(h, <span class="number">0</span>) <span class="comment"># N * Hy_pred = h_relu.dot(w2) # N * D_outab_loss = y_pred - yab_loss[:1]</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>array([[-2.31700647e-05, -6.28731777e-05,  4.77222071e-05,         1.18624504e-05, -4.80998287e-05,  1.52820208e-06,         6.16901569e-06, -8.37944967e-05, -2.06058305e-06,         1.23783963e-06]])</code></pre>
<p>可以发现，两者相差非常小，模型训练较为成功。</p>
<h1 id="bi-linear-nn-with-pytorch">3. Bi-Linear NN with PyTorch</h1>
<h2 id="implementation">3.1 Implementation</h2>
<p>这次我们使用 PyTorch tensors 来创建前向神经网络，计算损失，以及反向传播。</p>
<p>一个 PyTorch Tensor 很像一个 numpy 的 ndarray。但是它和 numpy ndarray 最大的区别是，PyTorch Tensor 可以在 CPU 或者 GPU 上运算。如果想要在 GPU 上运算，就需要把 Tensor 换成 cuda 类型。</p>
<p>与 numpy 不同的方法：</p>
<ul>
<li><code>mm</code>: 矩阵相乘，对应于 <code>dot</code></li>
<li><code>clamp</code>: 夹子，将值夹在两者之间，对应于 <code>maximum</code></li>
<li><code>pow</code>: 平方，对应于 <code>np.square</code></li>
<li><code>t</code>: 转置，对应于 <code>.t</code></li>
<li><code>clone</code>: 复制，对应于 <code>copy</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span><span class="comment"># 随机创建一些训练数据x = torch.randn(N, D_in)y = torch.randn(N, D_out)w1 = torch.randn(D_in, H)w2 = torch.randn(H, D_out)learning_rate = 1e-6for it in range(500):    # Forward pass    h = x.mm(w1) # N * H    h_relu = h.clamp(min=0) # N * H    y_pred = h_relu.mm(w2) # N * D_out    # compute loss    loss = (y_pred - y).pow(2).sum().item()    if it%50 == 0:        print(it, loss)    # Backward pass    # compute the gradient    grad_y_pred = 2.0 * (y_pred - y)    grad_w2 = h_relu.t().mm(grad_y_pred)    grad_h_relu = grad_y_pred.mm(w2.t())    grad_h = grad_h_relu.clone()    grad_h[h&lt;0] = 0    grad_w1 = x.t().mm(grad_h)    # update weights of w1 and w2    w1 -= learning_rate * grad_w1    w2 -= learning_rate * grad_w2</span></span><br></pre></td></tr></table></figure>
<pre><code>0 31964224.050 8884.4111328125100 245.90003967285156150 12.271601676940918200 0.7670953273773193250 0.05322442948818207300 0.0041369786486029625350 0.0005290982662700117400 0.00013705584569834173450 5.566925392486155e-05</code></pre>
<p>简单的autograd</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.tensor(<span class="number">1.</span>, requires_grad=<span class="literal">True</span>)w = torch.tensor(<span class="number">2.</span>, requires_grad=<span class="literal">True</span>)b = torch.tensor(<span class="number">3.</span>, requires_grad=<span class="literal">True</span>)y = w*x + b<span class="comment"># y = 2*1+3y.backward()# dy / dw = xprint(w.grad)print(x.grad)print(b.grad)</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor(1.)tensor(2.)tensor(1.)</code></pre>
<h2 id="pytorch-tensor-and-autograd">3.2 PyTorch: Tensor and autograd</h2>
<p>PyTorch 的一个重要功能就是 autograd，也就是说只要定义了 forward pass (前向神经网络)，计算了 loss 之后，PyTorch 可以自动求导计算模型所有参数的梯度。</p>
<p>一个 PyTorch 的 Tensor 表示计算图中的一个节点。如果 <code>x</code> 是一个 Tensor 并且 <code>x.requires_grad=True</code> 那么 <code>x.grad</code> 是另一个储存着 <code>x</code> 当前梯度(相对于一个 scalar，常常是 loss)的向量。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span><span class="comment"># 随机创建一些训练数据x = torch.randn(N, D_in)y = torch.randn(N, D_out)w1 = torch.randn(D_in, H, requires_grad=True)w2 = torch.randn(H, D_out, requires_grad=True)learning_rate = 1e-6for it in range(500):    # Forward pass    y_pred = x.mm(w1).clamp(min=0).mm(w2)    # compute loss    loss = (y_pred - y).pow(2).sum() # computation graph    if it%50 == 0:        print(it, loss.item())    # Backward pass    loss.backward()    # update weights of w1 and w2    with torch.no_grad():        w1 -= learning_rate * w1.grad        w2 -= learning_rate * w2.grad        w1.grad.zero_() # gradient 清零        w2.grad.zero_()</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>0 40281260.050 16265.544921875100 770.28857421875150 60.70436477661133200 5.996867656707764250 0.6809620261192322300 0.08519172668457031350 0.011621471494436264400 0.0019496456952765584450 0.0004842539201490581</code></pre>
<h2 id="pytorch-nn">3.3 PyTorch: nn</h2>
<p>这次我们使用 PyTorch 中 nn 这个库来构建网络。用 PyTorch autograd 来构建计算图和计算 gradients，然后 PyTorch 会帮我们自动计算 gradient。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nnN, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span><span class="comment"># 随机创建一些训练数据x = torch.randn(N, D_in)y = torch.randn(N, D_out)model = torch.nn.Sequential(    torch.nn.Linear(D_in, H, bias=False), # w_1 * x + b_1    torch.nn.ReLU(),    torch.nn.Linear(H, D_out, bias=False), # default bias is True)# 初始化权值torch.nn.init.normal_(model[0].weight)torch.nn.init.normal_(model[2].weight)# model = model.cuda()loss_fn = nn.MSELoss(reduction=&#x27;sum&#x27;)learning_rate = 1e-6for it in range(500):    # Forward pass    y_pred = model(x) # model.forward()    # compute loss    loss = loss_fn(y_pred, y) # computation graph    if it% 50 == 0:        print(it, loss.item())    # Backward pass    loss.backward()    # update weights of w1 and w2    with torch.no_grad():        for param in model.parameters(): # param (tensor, grad)            param -= learning_rate * param.grad    model.zero_grad()</span></span><br></pre></td></tr></table></figure>
<p>Results：</p>
<pre><code>0 37942064.050 13557.75390625100 482.86322021484375150 27.34326934814453200 1.863478183746338250 0.1420218050479889300 0.01187755074352026350 0.0013162594987079501400 0.00026860935031436384450 9.016783587867394e-05</code></pre>
<p><code>model[0].weight</code> 可得到模型中第一层的权重，<code>bia</code> 可得到偏置项。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model[<span class="number">0</span>].weight</span><br></pre></td></tr></table></figure>
<p>Results：</p>
<pre><code>Parameter containing:tensor([[-0.0218,  0.0212,  0.0243,  ...,  0.0230,  0.0247,  0.0168],    [-0.0144,  0.0177, -0.0221,  ...,  0.0161,  0.0098, -0.0172],    [ 0.0086, -0.0122, -0.0298,  ..., -0.0236, -0.0187,  0.0295],    ...,    [ 0.0266, -0.0008, -0.0141,  ...,  0.0018,  0.0319, -0.0129],    [ 0.0296, -0.0005,  0.0115,  ...,  0.0141, -0.0088, -0.0106],    [ 0.0289, -0.0077,  0.0239,  ..., -0.0166, -0.0156, -0.0235]],   requires_grad=True)</code></pre>
<h2 id="pytorch-optim">3.4 PyTorch: optim</h2>
<p>这一次我们不再手动更新模型的 weights,而是使用 optim 这个包来帮助我们更新参数。 optim 这个 package 提供了各种不同的模型优化方法，包括 SGD+momentum, RMSProp, Adam 等等。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nnN, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span><span class="comment"># 随机创建一些训练数据x = torch.randn(N, D_in)y = torch.randn(N, D_out)model = torch.nn.Sequential(    torch.nn.Linear(D_in, H, bias=False), # w_1 * x + b_1    torch.nn.ReLU(),    torch.nn.Linear(H, D_out, bias=False),)torch.nn.init.normal_(model[0].weight)torch.nn.init.normal_(model[2].weight)# model = model.cuda()loss_fn = nn.MSELoss(reduction=&#x27;sum&#x27;)# Adam 则可以不用参数初始化# learning_rate = 1e-4# optimizer = torch.optim.Adam(model.parameters(), lr=learning_rate)learning_rate = 1e-6optimizer = torch.optim.SGD(model.parameters(), lr=learning_rate)for it in range(500):    # Forward pass    y_pred = model(x) # model.forward()    # compute loss    loss = loss_fn(y_pred, y) # computation graph    if it%50 == 0:        print(it, loss.item())    optimizer.zero_grad()    # Backward pass    loss.backward()    # update model parameters    optimizer.step()</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>0 40010880.050 8527.947265625100 276.97821044921875150 18.40827751159668200 1.5830364227294922250 0.15364140272140503300 0.016014395281672478350 0.0019916763994842768400 0.0004044498491566628450 0.0001368314551655203</code></pre>
<h2 id="pytorch-自定义-nn-modules">3.5 PyTorch: 自定义 nn Modules</h2>
<p>我们可以定义一个模型，这个模型继承自 nn.Module 类。如果需要定义一个比 Sequential 模型更加复杂的模型，就需要定义 nn.Module 模型。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nnN, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span><span class="comment"># 随机创建一些训练数据x = torch.randn(N, D_in)y = torch.randn(N, D_out)class TwoLayerNet(torch.nn.Module):    def __init__(self, D_in, H, D_out):        super(TwoLayerNet, self).__init__()        # define the model architecture        self.linear1 = torch.nn.Linear(D_in, H, bias=False)        self.linear2 = torch.nn.Linear(H, D_out, bias=False)    def forward(self, x):        y_pred = self.linear2(self.linear1(x).clamp(min=0))        return y_predmodel = TwoLayerNet(D_in, H, D_out)loss_fn = nn.MSELoss(reduction=&#x27;sum&#x27;)learning_rate = 1e-4optimizer = torch.optim.Adam(model.parameters(), lr=learning_rate)for it in range(500):    # Forward pass    y_pred = model(x) # model.forward()    # compute loss    loss = loss_fn(y_pred, y) # computation graph    if it%100 == 0:        print(it, loss.item())    optimizer.zero_grad()    # Backward pass    loss.backward()    # update model parameters    optimizer.step()</span></span><br></pre></td></tr></table></figure>
<p>Results：</p>
<pre><code>  0 692.8556518554688  100 50.59251403808594  200 0.6749072074890137  300 0.01346816960722208  400 0.0009340611286461353</code></pre>
<h1 id="fuzzbuzz">4. Fuzzbuzz</h1>
<p><code>FizzBuzz</code> 是一个简单的小游戏。游戏规则如下：从 1 开始往上数数，当遇到 3 的倍数的时候，说 fizz，当遇到 5 的倍数，说 buzz，当遇到 15 的倍数，就说 fizzbuzz，其他情况下则正常数数。</p>
<p>我们可以写一个简单的小程序来决定要返回正常数值还是 fizz, buzz 或者 fizzbuzz。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># One-hot encode the desired outputs: [number, &quot;fizz&quot;, &quot;buzz&quot;, &quot;fizzbuzz&quot;]def fizz_buzz_encode(i):    if   i % 15 == 0: return 3    elif i % 5  == 0: return 2    elif i % 3  == 0: return 1    else:             return 0def fizz_buzz_decode(i, prediction):    return [str(i), &quot;fizz&quot;, &quot;buzz&quot;, &quot;fizzbuzz&quot;][prediction]print(fizz_buzz_decode(1, fizz_buzz_encode(1)))print(fizz_buzz_decode(2, fizz_buzz_encode(2)))print(fizz_buzz_decode(5, fizz_buzz_encode(5)))print(fizz_buzz_decode(12, fizz_buzz_encode(12)))print(fizz_buzz_decode(15, fizz_buzz_encode(15)))</span></span><br></pre></td></tr></table></figure>
<p>Resutls:</p>
<pre><code>12buzzfizzfizzbuzz</code></pre>
<p>我们首先定义模型的输入与输出(训练数据)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> npimport torchNUM_DIGITS = <span class="number">10</span><span class="comment"># Represent each input by an array of its binary digits.def binary_encode(i, num_digits):    return np.array([i &gt;&gt; d &amp; 1 for d in range(num_digits)])trX = torch.Tensor([binary_encode(i, NUM_DIGITS) for i in range(101, 2 ** NUM_DIGITS)])trY = torch.LongTensor([fizz_buzz_encode(i) for i in range(101, 2 ** NUM_DIGITS)])</span></span><br></pre></td></tr></table></figure>
<p>然后我们用PyTorch定义模型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define the model</span></span><br><span class="line">NUM_HIDDEN = <span class="number">100</span></span><br><span class="line">model = torch.nn.Sequential(</span><br><span class="line">    torch.nn.Linear(NUM_DIGITS, NUM_HIDDEN),</span><br><span class="line">    torch.nn.ReLU(),</span><br><span class="line">    torch.nn.Linear(NUM_HIDDEN, <span class="number">4</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"></span><br><span class="line">model = model.to(device)</span><br></pre></td></tr></table></figure>
<ul>
<li>为了让我们的模型学会 <code>FizzBuzz</code> 这个游戏，我们需要定义一个损失函数，和一个优化算法。</li>
<li>这个优化算法会不断优化（降低）损失函数，使得模型的在该任务上取得尽可能低的损失值。</li>
<li>损失值低往往表示我们的模型表现好，损失值高表示我们的模型表现差。</li>
<li>由于 <code>FizzBuzz</code> 游戏本质上是一个分类问题，我们选用 Cross Entropyy Loss 函数。</li>
<li>优化函数我们选用 Stochastic Gradient Descent。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">loss_fn = torch.nn.CrossEntropyLoss()</span><br><span class="line">optimizer = torch.optim.SGD(model.parameters(), lr = <span class="number">0.05</span>)</span><br></pre></td></tr></table></figure>
<p>以下是模型的训练代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Start training it</span></span><br><span class="line">BATCH_SIZE = <span class="number">128</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">for</span> start <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(trX), BATCH_SIZE):</span><br><span class="line">        end = start + BATCH_SIZE</span><br><span class="line">        batchX = trX[start:end].to(device)</span><br><span class="line">        batchY = trY[start:end].to(device)</span><br><span class="line"></span><br><span class="line">        y_pred = model(batchX)</span><br><span class="line">        loss = loss_fn(y_pred, batchY)</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find loss on training data</span></span><br><span class="line">    loss = loss_fn(model(trX.to(device)), trY.to(device)).cpu().item()</span><br><span class="line">    <span class="keyword">if</span> epoch%<span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">&#x27;Epoch:&#x27;</span>, epoch, <span class="string">&#x27;Loss:&#x27;</span>, loss)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>Epoch: 0 Loss: 1.1463667154312134
Epoch: 1000 Loss: 0.4962996244430542
Epoch: 2000 Loss: 0.15307655930519104
Epoch: 3000 Loss: 0.07736020535230637
Epoch: 4000 Loss: 0.044787853956222534
Epoch: 5000 Loss: 0.029076775535941124
Epoch: 6000 Loss: 0.020609091967344284
Epoch: 7000 Loss: 0.01560244057327509
Epoch: 8000 Loss: 0.012386537156999111
Epoch: 9000 Loss: 0.010154682211577892</code></pre>
<p>最后我们用训练好的模型尝试在 1 到 100 这些数字上玩 <code>FizzBuzz</code> 游戏</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Output now</span></span><br><span class="line">testX = torch.Tensor([binary_encode(i, NUM_DIGITS) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>)])</span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    testY = model(testX.to(device))</span><br><span class="line">predictions = <span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>), <span class="built_in">list</span>(testY.<span class="built_in">max</span>(<span class="number">1</span>)[<span class="number">1</span>].data.tolist()))</span><br><span class="line"></span><br><span class="line">print([fizz_buzz_decode(i, x) <span class="keyword">for</span> (i, x) <span class="keyword">in</span> predictions])</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>[&#39;1&#39;, &#39;2&#39;, &#39;fizz&#39;, &#39;4&#39;, &#39;buzz&#39;, &#39;fizz&#39;, &#39;7&#39;, &#39;8&#39;, &#39;fizz&#39;, &#39;10&#39;, &#39;11&#39;,
  &#39;fizz&#39;, &#39;13&#39;, &#39;14&#39;, &#39;fizzbuzz&#39;, &#39;16&#39;, &#39;17&#39;, &#39;fizz&#39;, &#39;19&#39;, &#39;buzz&#39;,
  &#39;fizz&#39;, &#39;22&#39;, &#39;23&#39;, &#39;fizz&#39;, &#39;buzz&#39;, &#39;26&#39;, &#39;fizz&#39;, &#39;28&#39;, &#39;29&#39;,
  &#39;fizzbuzz&#39;, &#39;31&#39;, &#39;32&#39;, &#39;fizz&#39;, &#39;34&#39;, &#39;buzz&#39;, &#39;fizz&#39;, &#39;37&#39;, &#39;38&#39;,
  &#39;fizz&#39;, &#39;buzz&#39;, &#39;41&#39;, &#39;42&#39;, &#39;43&#39;, &#39;44&#39;, &#39;fizzbuzz&#39;, &#39;46&#39;, &#39;47&#39;,
  &#39;fizz&#39;, &#39;49&#39;, &#39;buzz&#39;, &#39;fizz&#39;, &#39;52&#39;, &#39;53&#39;, &#39;fizz&#39;, &#39;buzz&#39;, &#39;56&#39;,
  &#39;fizz&#39;, &#39;58&#39;, &#39;59&#39;, &#39;fizzbuzz&#39;, &#39;61&#39;, &#39;62&#39;, &#39;fizz&#39;, &#39;64&#39;, &#39;buzz&#39;,
  &#39;fizz&#39;, &#39;67&#39;, &#39;68&#39;, &#39;69&#39;, &#39;buzz&#39;, &#39;71&#39;, &#39;fizz&#39;, &#39;73&#39;, &#39;74&#39;, &#39;fizzbuzz&#39;,
  &#39;76&#39;, &#39;77&#39;, &#39;fizz&#39;, &#39;79&#39;, &#39;buzz&#39;, &#39;fizz&#39;, &#39;82&#39;, &#39;83&#39;, &#39;84&#39;, &#39;buzz&#39;,
  &#39;86&#39;, &#39;fizz&#39;, &#39;88&#39;, &#39;89&#39;, &#39;fizzbuzz&#39;, &#39;91&#39;, &#39;92&#39;, &#39;93&#39;, &#39;94&#39;,
  &#39;buzz&#39;, &#39;fizz&#39;, &#39;97&#39;, &#39;98&#39;, &#39;fizz&#39;, &#39;buzz&#39;]</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(np.<span class="built_in">sum</span>(testY.cpu().<span class="built_in">max</span>(<span class="number">1</span>)[<span class="number">1</span>].numpy() == np.array([fizz_buzz_encode(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>)])))testY.cpu().<span class="built_in">max</span>(<span class="number">1</span>)[<span class="number">1</span>].numpy() == np.array([fizz_buzz_encode(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>)])</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>95
array([ True,  True,  True,  True,  True,  True,  True,  True,  True,       
        False,  True,  True,  True,  True,  True,  True,  True,  True,        
        True,  True,  True,  True,  True,  True,  True,  True,  True,        
        True,  True,  True,  True,  True,  True,  True,  True,  True,        
        True,  True,  True,  True,  True, False,  True,  True,  True,        
        True,  True,  True,  True,  True,  True,  True,  True,  True,        
        True,  True,  True,  True,  True,  True,  True,  True,  True,        
        True,  True,  True,  True,  True, False,  True,  True,  True,        
        True,  True,  True,  True,  True,  True,  True,  True,  True,        
        True,  True, False,  True,  True,  True,  True,  True,  True,        
        True,  True, False,  True,  True,  True,  True,  True,  True,        
        True])</code></pre>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Pytorch</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Deep learning</tag>
        <tag>Pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>Pytorch-4-LanguageModel</title>
    <url>/2021/08/06/Pytorch-4-LanguageModel/</url>
    <content><![CDATA[
]]></content>
  </entry>
  <entry>
    <title>Pytorch-3-Word2vec</title>
    <url>/2021/08/05/Pytorch-3-Word2vec/</url>
    <content><![CDATA[<h1 id="study-goals">1. Study goals</h1>
<ul>
<li>学习词向量的概念</li>
<li>用 Skip-thought 模型训练词向量</li>
<li>学习使用 PyTorch dataset和 dataloader</li>
<li>学习定义 PyTorch 模型</li>
<li>学习 torch.nn 中常见的 Module
<ul>
<li>Embedding</li>
</ul></li>
<li>学习常见的 PyTorch operations
<ul>
<li>bmm</li>
<li>logsigmoid</li>
</ul></li>
<li>保存和读取 PyTorch 模型</li>
</ul>
<a id="more"></a>
<h1 id="word-vector">2. Word vector</h1>
<p>在计算机中如何表示一个词：</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCUoR.png" style="zoom:80%;" /></p>
<p>可以使用一些上位词或同义词来形容某个词。但这样表示存在如下问题：</p>
<ul>
<li>不能分辨细节的差别</li>
<li>需要大量人为劳动</li>
<li>主观</li>
<li>无法发现新词</li>
<li>难以精确计算词之间的相似度</li>
</ul>
<h2 id="discrete-representation">2.1 Discrete representation</h2>
<h3 id="one-hot">2.1.1 One-hot</h3>
<p>使用 <code>One-hot</code> 来离散表示词向量。</p>
<ul>
<li><p>语料库 (Corpus)：</p>
<p>John likes to watch movies. Mary likes too.<br />
John also likes to watch football games.</p></li>
<li><p>词典 (Dictionary)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;John&quot;</span>: <span class="number">1</span>, <span class="string">&quot;likes&quot;</span>: <span class="number">2</span>, <span class="string">&quot;to&quot;</span>: <span class="number">3</span>, <span class="string">&quot;watch&quot;</span>: <span class="number">4</span>, <span class="string">&quot;movies&quot;</span>: <span class="number">5</span>, <span class="string">&quot;also&quot;</span>: <span class="number">6</span>, <span class="string">&quot;football&quot;</span>: <span class="number">7</span>, <span class="string">&quot;games&quot;</span>: <span class="number">8</span>, <span class="string">&quot;Mary&quot;</span>: <span class="number">9</span>, <span class="string">&quot;too&quot;</span>: <span class="number">10</span>&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>One-hot representation</p>
<p>John: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0] likes: [0, 1, 0, 0, 0, 0, 0, 0, 0, 0] too: [0, 0, 0, 0, 0, 0, 0, 0, 0, 1]</p></li>
</ul>
<p><code>One-hot</code> 表示的特点：</p>
<ol type="1">
<li>词典包含 10 个单词，每个单词有唯一索引</li>
<li>在词典中的顺序和在句子中的顺序没有关联</li>
</ol>
<h3 id="bag-of-words">2.2.2 Bag of Words</h3>
<ul>
<li><p>文档的向量表示可以直接将各词的词向量表示加和。如：</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZPM0H.png" /></p></li>
</ul>
<p>词权重表示（词在文档中的顺序没有被考虑）：</p>
<ol type="1">
<li><code>TF-IDF</code>(Term Frequency - Inverse Document Frequency)</li>
</ol>
<p>Specifically, <code>TF-IDF</code> is defines as: <span class="math display">\[ {\rm{tf}\text{-}\rm{idf}}(t, d, D) = f _{t,d} \cdot \log \frac{N}{n_t} \]</span></p>
<p>where <span class="math inline">\(f_{t, d}\)</span> is the raw frequency of term <span class="math inline">\(t\)</span> in document <span class="math inline">\(d\)</span>, <span class="math inline">\(N\)</span> is the total number of documents in the corpus, and <span class="math inline">\(n_t\)</span> is the total number of documents containing at least one occurrence of term <span class="math inline">\(t\)</span>.</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCNw9.png" /></p>
<ol start="2" type="1">
<li>Binary weighting</li>
</ol>
<p><img src="https://z3.ax1x.com/2021/08/05/fZPbjO.png" /></p>
<h3 id="bi-gram-and-n-gram">2.2.3 Bi-gram and N-gram</h3>
<p>为 <code>2-gram</code> 建立索引：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;John likes&quot;</span>:       <span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;likes to&quot;</span>:         <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;to watch&quot;</span>:         <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;watch movies&quot;</span>:     <span class="number">4</span>,</span><br><span class="line"><span class="string">&quot;Mary likes&quot;</span>:       <span class="number">5</span>,</span><br><span class="line"><span class="string">&quot;likes too&quot;</span>:        <span class="number">6</span>,</span><br><span class="line"><span class="string">&quot;John also&quot;</span>:        <span class="number">7</span>,</span><br><span class="line"><span class="string">&quot;also likes&quot;</span>:       <span class="number">8</span>,</span><br><span class="line"><span class="string">&quot;watch football&quot;</span>:   <span class="number">9</span>,</span><br><span class="line"><span class="string">&quot;football games&quot;</span>:  <span class="number">10</span>,</span><br></pre></td></tr></table></figure>
<p>所以可以得到如下表示：</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCJL4.png" style="zoom:80%;" /></p>
<p>而 <code>N-gram</code> 模型参数与 <code>N</code> 之间的关系：</p>
<center>
<img src="https://z3.ax1x.com/2021/08/05/fZipCt.png" style="zoom:50%;" />
</center>
<p><code>N-gram</code> 的优缺点：</p>
<ul>
<li>优点：考虑了词的顺序</li>
<li>缺点：词表的膨胀</li>
</ul>
<h2 id="distributed-representation">2.3 Distributed representation</h2>
<h3 id="preface">2.3.1 Preface</h3>
<p>从上一小节可以发现离散表示存在如下问题：</p>
<ol type="1">
<li><p>无法衡量词向量之间的关系</p>
<p>太稀疏，难以捕捉文本的含义。各种度量（与或非、距离）都不合适.</p></li>
</ol>
<center>
<img src="https://z3.ax1x.com/2021/08/05/fZCGyF.png" style="zoom:50%;" />
</center>
<ol start="2" type="1">
<li>词表维度随着语料库增长膨胀</li>
<li><code>N-gram</code> 词序列随着语料库膨胀更快</li>
<li>数据稀疏性问题</li>
</ol>
<p>为了弥补这些不足，对词编码表示提出如下要求：</p>
<ol type="1">
<li><p>词编码需要保证词的相似性。</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZC0W6.md.png" /></p></li>
<li><p>向量空间分布的相似性</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCwJx.png" /></p></li>
<li><p>向量空间子结构</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCsyD.md.png" /></p>
<p><span class="math display">\[
\begin{align}
V_{King} - V_{Queen} + V_{Women} &amp;= V_{Man} \\
V_{Paris} - V_{France} + V_{German} &amp;= V_{Berlin}
\end{align}
\]</span></p></li>
</ol>
<p><strong>最终目标</strong>：词向量表示作为机器学习、特别是深度学习的输入和表示空间。</p>
<p>因此，有学者考虑使用分布式表示来生成词向量。分布式表示即用一个词附近的其他词来表示该词。这也是现代统计自然语言处理中最有创意的想法之一。</p>
<p>如， <code>banking</code> 附近的词将会代表 <code>banking</code> 的含义。</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCXYq.png" /></p>
<h3 id="word2vec-skip-gram-model">2.3.2 Word2Vec: Skip-Gram model</h3>
<p>该模型具有以下特点：</p>
<ol type="1">
<li>无隐层</li>
<li>投影层也可省略</li>
<li>每个词向量作为log-linear模型的输入</li>
</ol>
<center>
<img src = "https://z3.ax1x.com/2021/08/05/fZCDSK.png" style = "zoom:60%" />
</center>
<ul>
<li><p>目标函数 (Objective function)：</p>
<p><span class="math display">\[ \frac{1}{T} \sum^{T}_{t=1} \sum_{-c \leq j \leq c,\ j \neq 0}  \log (p(w_{t+j} | w_t ))\]</span></p></li>
<li><p>概率密度 (Probability density)</p>
<p>概率密度由 <code>Softmax</code> 给出：</p>
<p><span class="math display">\[ p(o|c) = \frac{\exp \left(u^T_o v_c \right)}{\sum^W_{w=1} \exp \left(u^T_w v_c \right)} \]</span></p>
<p><span class="math inline">\(o\)</span> 表示 <code>output</code>, <span class="math inline">\(c\)</span> 表示 <code>center word</code> 即输入。该训练模型存在一个问题：分母有一个 <code>summation</code> 操作，表示需要用中心词对语料库中所有词做一个点积，这会导致需要非常大的内容，训练过程会很慢。</p></li>
<li><p>损失函数 (Loss function)</p>
<p><span class="math display">\[
\begin{aligned}
  \min J &amp;= -\log P\left(w_{c-m}, \ldots, w_{c-1}, w_{c+1}, \ldots, w_{c+m} \mid w_{c}\right) \\
  &amp;=-\log \prod_{j=0, j \neq m}^{2 m} P\left(w_{c-m+j} \mid w_{c}\right) \\
  &amp;=-\log \prod_{j=0, j \neq m}^{2 m} P\left(u_{c-m+j} \mid v_{c}\right) \\
  &amp;=-\log \prod_{j=0, j \neq m}^{2 m} \frac{\exp \left(u_{c-m+j}^{T} v_{c}\right)}{\sum_{k=1}^{|V|} \exp \left(u_{k}^{T} v_{c}\right)} \\
  &amp;=-\sum_{j=0, j \neq m}^{2 m} u_{c-m+j}^{T} v_{c}+2 m \log \sum_{k=1}^{|V|} \exp \left(u_{k}^{T} v_{c}\right)
\end{aligned}
\]</span></p></li>
<li><p>负采样 (Negative sampling)</p>
<p><span class="math inline">\(P(w|\text{context}(w))\)</span>：一个正样本，<span class="math inline">\(V-1\)</span> 个负样本，对负样本做采样。</p>
<p><span class="math display">\[
\begin{align}
P(D=1 \mid w, c, \theta) &amp;= \frac{1}{1+e^{\left(-v_{c}^{T} v_{w}\right)}} \\
\log \sigma\left(u_{c-m+j}^{T} \cdot v_{c}\right) &amp;+ \sum_{k=1}^{K} \log \sigma\left(-\tilde{u}_{k}^{T} \cdot v_{c}\right)
\end{align}
\]</span></p>
<p>where, <span class="math inline">\(\{ \tilde{u}_k | k = 1 \dots K \}\)</span> is obtained by negative sampling.</p></li>
</ul>
<h3 id="word-embendding-visualization">2.3.3 Word embendding visualization</h3>
<ul>
<li><p>词向：公司 —— CEO</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCrQO.md.png" /></p>
<p><span class="math display">\[
\begin{align*}
  \text{Fig. 公司} \leftrightarrow \rm{CEO}
\end{align*}
\]</span></p></li>
<li><p>词向：比较级和最高级</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCOkn.png" /></p>
<center>
<p>Fig. 比较级和最高级</p>
</center></li>
<li><p>评估效果：词类比任务</p>
<p><img src="https://z3.ax1x.com/2021/08/05/fZCyOe.md.png" /></p>
<center>
<p>Fig. Accuracy on the analogy task for 300-D vectors trained on different corpora</p>
</center>
<p>19544个类比问题:</p>
<ul>
<li>Athens is to Greece as Berlin is to __?</li>
<li>Bigger is to Big as Greater is to __?</li>
</ul></li>
<li><p>效果评估：词相似度任务</p>
<center>
<p><img src = "https://z3.ax1x.com/2021/08/05/fZCceH.png" style = "zoom:60%" /></p>
</center>
<p>其中，<code>SVD</code> 模型只保留出现次数最大的 1 万个词，记为 <span class="math inline">\(X_{trunc}\)</span>，<code>SVD-S</code> 为 <span class="math inline">\(\sqrt{X_{trunc}}\)</span>，<code>SVD-L</code> 为 <span class="math inline">\(\log (1+X_{trunc})\)</span>。</p></li>
<li><p>效果评估：作为特征用于 <code>CRF</code> 实体识别</p>
<p><code>NER</code> 任务包含 437, 905 个离散特征，额外的 50 维连续特征。</p>
<center>
<p><img src = "https://z3.ax1x.com/2021/08/05/fZC2TA.png" style = "zoom:60%" /></p>
</center></li>
</ul>
<h1 id="implement-word2vec-with-pytorch">3. Implement Word2Vec with pytorch</h1>
<h2 id="简介">3.1 简介</h2>
<p>该文档中使用的训练数据可从如下方式下载：<a href="https://www.aliyundrive.com/s/SVoAJqKvsME">Click Here</a>。</p>
<p>在本节的代码中，尽可能尝试复现论文 <a href="http://papers.nips.cc/paper/5021-distributed-representations-of-words-and-phrases-and-their-compositionality.pdf">Distributed Representations of Words and Phrases and their Compositionality</a> 中训练词向量的方法. 我们会实现 <code>Skip-gram</code> 模型，并且使用论文中 <code>noice contrastive sampling</code> 的目标函数。</p>
<p>这篇论文有很多模型实现的细节，这些细节对于词向量的好坏至关重要。虽然无法完全复现论文中的实验结果，主要是由于计算资源等各种细节原因，但是我们还是可以大致展示如何训练词向量。</p>
<p>以下是没有实现的细节:</p>
<ul>
<li>subsampling：参考论文section 2.3</li>
</ul>
<p>本章节的代码主要借助 <a href="https://colab.research.google.com/notebooks/intro.ipynb">Google colab</a> 平台进行实现。</p>
<h2 id="implementation">3.2 Implementation</h2>
<h3 id="platform-and-enviroment-setting">3.2.1 Platform and enviroment setting</h3>
<ul>
<li><p>Mount google driver</p>
<p>借助 <code>Google driver</code> 可以上传个人文件以及保存 <code>notebook</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> google.colab <span class="keyword">import</span> drive</span><br><span class="line">drive.mount(<span class="string">&#x27;/content/drive&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(&quot;/content/drive&quot;, force_remount=True).</code></pre></li>
<li><p>GPU Setting and information</p>
<p>由于训练量较大，使用 <code>GPU</code> 进行训练词嵌入模型，<code>Colab</code> 可以免费使用 <code>GPU</code> 和 <code>TPU</code>。操作方式：<span class="math inline">\(\rm{Edit \rightarrow Notebook settings \rightarrow Hardware accelerator \rightarrow GPU \rightarrow Save}\)</span>。</p>
<p>查看装在的 <code>GPU</code> 信息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">!nvidia-smi</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>Wed Aug  4 09:29:20 2021       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 470.42.01    Driver Version: 460.32.03    CUDA Version: 11.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  Tesla T4            Off  | 00000000:00:04.0 Off |                    0 |
| N/A   35C    P8     9W /  70W |      0MiB / 15109MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
|  No running processes found                                                 |
+-----------------------------------------------------------------------------+</code></pre></li>
</ul>
<h3 id="load-modules-and-procession">3.2.2 Load modules and procession</h3>
<ul>
<li><p>Load modules</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> tud</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scipy</span><br><span class="line"><span class="keyword">import</span> sklearn</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"></span><br><span class="line">USE_CUDA = torch.cuda.is_available()</span><br><span class="line"></span><br><span class="line">random.seed(<span class="number">1</span>)</span><br><span class="line">np.random.seed(<span class="number">1</span>)</span><br><span class="line">torch.manual_seed(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> USE_CUDA:</span><br><span class="line">  torch.cuda.manual_seed(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Seting hyper parameters</span></span><br><span class="line">K = <span class="number">100</span> <span class="comment"># number of negative samples</span></span><br><span class="line">C = <span class="number">3</span> <span class="comment"># context window</span></span><br><span class="line">NUM_EPOCHS = <span class="number">2</span> <span class="comment"># The number of epochs of training</span></span><br><span class="line">MAX_VOCAB_SIZE = <span class="number">30000</span> <span class="comment"># the vocabulary size</span></span><br><span class="line">BATCH_SIZE = <span class="number">128</span> <span class="comment"># the batch size</span></span><br><span class="line">LEARNING_RATE = <span class="number">0.2</span> <span class="comment"># the initial learning rate</span></span><br><span class="line">EMBEDDING_SIZE = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">LOG_FILE = <span class="string">&quot;word-embedding.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">word_tokenize</span>(<span class="params">text</span>):</span></span><br><span class="line">  <span class="keyword">return</span> text.split()</span><br></pre></td></tr></table></figure></li>
<li><p>Load data and count data</p>
<ul>
<li>从文本文件中读取所有的文字，通过这些文本创建一个 <code>vocabulary</code></li>
<li>由于单词数量可能太大，我们只选取最常见的 <code>MAX_VOCAB_SIZE</code> 个单词</li>
<li>我们添加一个 <code>UNK</code> 单词表示所有不常见的单词</li>
<li>我们需要记录单词到 <code>index</code> 的 <code>mapping</code>，以及 <code>index</code> 到单词的 <code>mapping</code>，单词的 <code>count</code>，单词的 <code>(normalized) frequency</code>，以及单词总数。</li>
</ul>
<p>加载数据和计算词频：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/content/drive/MyDrive/Word_embedding/text8.train.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> fin:</span><br><span class="line">  text = fin.read()</span><br><span class="line"></span><br><span class="line">text = text.split()</span><br><span class="line">vocab = <span class="built_in">dict</span>(Counter(text).most_common(MAX_VOCAB_SIZE - <span class="number">1</span>))</span><br><span class="line">vocab[<span class="string">&#x27;&lt;unk&gt;&#x27;</span>] = <span class="built_in">len</span>(text) - np.<span class="built_in">sum</span>(<span class="built_in">list</span>(vocab.values()))</span><br><span class="line"></span><br><span class="line">idx_to_word = [word <span class="keyword">for</span> word <span class="keyword">in</span> vocab.keys()]</span><br><span class="line">word_to_idx = &#123;word:i <span class="keyword">for</span> i, word <span class="keyword">in</span> <span class="built_in">enumerate</span>(idx_to_word)&#125;</span><br><span class="line"></span><br><span class="line">word_counts = np.array([count <span class="keyword">for</span> count <span class="keyword">in</span> vocab.values()], dtype = np.float32)</span><br><span class="line">word_freqs = word_counts / np.<span class="built_in">sum</span>(word_counts)</span><br><span class="line">word_freqs = word_freqs ** (<span class="number">3.</span>/<span class="number">4.</span>)</span><br><span class="line">word_freqs = word_counts / np.<span class="built_in">sum</span>(word_counts)  <span class="comment"># 用来做 negative sampling</span></span><br><span class="line">VOCAB_SIZE = <span class="built_in">len</span>(idx_to_word)</span><br></pre></td></tr></table></figure>
<p><strong>Notes:</strong> 本人将项目文件存储在谷歌云盘的 <code>/content/drive/MyDrive/Word_embedding/</code> 目录下，如想复现改代码，应将该项目文件夹改为个人文件夹目录，下同。</p></li>
<li><p>Create Dateset and Dataloader</p>
<p>一个 <code>dataloader</code> 需要以下内容：</p>
<ul>
<li>把所有text编码成数字，然后用 <code>subsampling</code> 预处理这些文字。</li>
<li>保存 vocabulary，单词 count，normalized word frequency</li>
<li>每个 iteration sample 一个中心词</li>
<li>根据当前的中心词返回 <code>context</code> 单词</li>
<li>根据中心词 sample 一些 negative 单词</li>
<li>返回单词的 counts</li>
</ul>
<p>有了 dataloader 之后，我们可以轻松随机打乱整个数据集，拿到一个 batch 的数据等等。这里有一个好的 tutorial 介绍如何使用 <a href="https://pytorch.org/tutorials/beginner/data_loading_tutorial.html">PyTorch dataloader</a>. 为了使用 dataloader，我们需要定义以下两个 function:</p>
<ul>
<li><code>__len__</code> <span class="math inline">\(\rm Function\)</span> 需要返回整个数据集中有多少个 <code>item</code></li>
<li><code>__get__</code> 根据给定的 <code>index</code> 返回一个 <code>item</code></li>
</ul>
<p>先创建 <code>Dataset</code> 类：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WordEmbeddingDataset</span>(<span class="params">tud.Dataset</span>):</span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, text, word_to_idx, idx_to_word, word_freqs, word_counts</span>):</span>        <span class="string">&#x27;&#x27;&#x27; text: a list of words, all text from the training dataset            word_to_idx: the dictionary from word to idx            idx_to_word: idx to word mapping            word_freq: the frequency of each word            word_counts: the word counts        &#x27;&#x27;&#x27;</span>        <span class="built_in">super</span>(WordEmbeddingDataset, self).__init__()        self.text_encoded = [word_to_idx.get(t, VOCAB_SIZE-<span class="number">1</span>) <span class="keyword">for</span> t <span class="keyword">in</span> text]        self.text_encoded = torch.Tensor(self.text_encoded).long()        self.word_to_idx = word_to_idx        self.idx_to_word = idx_to_word        self.word_freqs = torch.Tensor(word_freqs)        self.word_counts = torch.Tensor(word_counts)    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span>        <span class="string">&#x27;&#x27;&#x27; 返回整个数据集（所有单词）的长度        &#x27;&#x27;&#x27;</span>        <span class="keyword">return</span> <span class="built_in">len</span>(self.text_encoded)    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span>(<span class="params">self, idx</span>):</span>        <span class="string">&#x27;&#x27;&#x27; 这个function返回以下数据用于训练            - 中心词            - 这个单词附近的(positive)单词            - 随机采样的K个单词作为negative sample        &#x27;&#x27;&#x27;</span>        center_word = self.text_encoded[idx]        pos_indices = <span class="built_in">list</span>(<span class="built_in">range</span>(idx-C, idx)) + <span class="built_in">list</span>(<span class="built_in">range</span>(idx+<span class="number">1</span>, idx+C+<span class="number">1</span>)) <span class="comment"># window 内单词的 index        pos_indices = [i%len(self.text_encoded) for i in pos_indices] # 取余，防止超出 text 长度，将文本闭环 -1%10 = 9        pos_words = self.text_encoded[pos_indices]  # 周围单词        neg_words = torch.multinomial(self.word_freqs, K * pos_words.shape[0], True) # 负采样单词        return center_word, pos_words, neg_words</span></span><br></pre></td></tr></table></figure>
<p>创建 <code>Dataset</code> 和 <code>Dataloader</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dataset = WordEmbeddingDataset(text, word_to_idx, idx_to_word, word_freqs, word_counts)dataloader = tud.DataLoader(dataset, batch_size = BATCH_SIZE, shuffle = <span class="literal">True</span>, num_workers = <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>为了更好理解 <code>Dataloader</code> 中返回的内容，查看其信息：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> <span class="built_in">range</span>(NUM_EPOCHS):  <span class="keyword">for</span> i, (input_labels, pos_labels, neg_labels) <span class="keyword">in</span> <span class="built_in">enumerate</span>(dataloader):    print(input_labels, pos_labels, neg_labels)    <span class="keyword">if</span> i &gt; <span class="number">0</span>:      <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>tensor([ 1769,    62,    11, 21115,  6716, 29999,  1045,   138,   460, 29999,
        29999, 29999,     1,    18,  9235,     2,  8312,     9, 13824, 29999,
        29999,  1714,    22,  1562,     0,    30,     0,     0,    22,   990,
          445,    33,  4390,  7219,     0,   255,  1217,     5,     1,     4,
           29,    20,     0,  2487,  1534,   991,     3,    18,    28,   141,
          193,  2800,     1,     9,   337,   127,   157,   149,   107,   236,
            6,    84,    43, 29828,    52,   403,   186,    83,  1265,   552,
            2,   595,  2798,    33,    12,  8462,    10,   127,  8872,  1514,
         6620,   217,     1,  3680,  5804,     5, 29999,   956, 19058, 21389,
          495,    39,    30,   349,   416,    11,     5,     1,     1,     6,
            1,   122,   211,  2719,   873,     0,    22, 24620,    22,    93,
            0,   535,    99,  1734,     3,  1269,  5909,     3,    15,  5069,
         1706, 17024, 29999,    28,   169,   129,  5025, 10759]) tensor([[27921,     1,   107,  3219,    40,     5],
        [ 3832,   634,  1536,   116,  2567,   938],
        [  661,   296,   620,   227,   774,  4676],
        [   98,  8425,    29,    34,  1069,    60],
        [   22,   253,    66, 16886,    38,    49],
        [29999,   604, 29999,  4965,     3,     8],
        [ 2274,  1081,    10,     4,     0,  2128],
        [   11,    30,   616, 29999,    17,    52],
        [   15,     7,    22, 10132,     6, 14444],
        [   51, 29999,     2,    32,   194,    10],
        [13251,     0,   540,    17,    37, 29392],
        [   86,    11, 26305,     4,     0,    42],
        [ 6604,     0,   553,     0,  6818,   387],
        [  496,   246,   331,   482,   312,     0],
        [28413,   451,   400,  1494,  1861,     1],
        [  245,   143, 29999, 29999,     7,  4501],
        [ 6623,    26,    68,    75,  3511,    76],
        [    9,    15,     3,     7,     7,    15],
        [ 1812,     1,  3571,  9824,     0,   258],
        [ 1535,   811,   877,  1535,   811,   877],
        [    3,    20,     9, 26166,   537,    16],
        [ 1326,   168,   639, 29999,   325, 11916],
        [    3,     8,    15,    26,    17,   108],
        [10360,     2,   940,    60,     5,   182],
        [    2,  2319,    24,  4398,     1,   458],
        [    0,  3476,    38,   139,  1114,  3434],
        [    5, 26413,   143,  1797,    17,    45],
        [  617,    46,   736, 14267,    55,  3435],
        [    3,     8,     3, 29999, 12448,  7130],
        [   22,    15, 29999,    17,     0,    45],
        [  142,     0,  9504,    10,   205,  1181],
        [    2,  1305, 28342,  1968,     5,   979],
        [  420,   711,  2959,     1, 29999,     4],
        [    3,    16,    12,    47,   527,     0],
        [   11,   470,     1, 29999,     2,   780],
        [   31,  4261,    23,    96,   108,     1],
        [  199,   238,   100, 13330,     1,  1259],
        [  232,     6,    31,   851,  1244,  1210],
        [    1,  2191,  2570,   112,     1,  2191],
        [    2,   731,  5379,     3,     8,     3],
        [    0,   125,  6752,   686,    18,  5659],
        [    9,     7,     7,     0, 17323,    40],
        [    1,   158,     1,   674,  2110,   302],
        [ 1625,  2125,     2,   374, 28455,     4],
        [   19,     0,    66,  5072,  3224,  5683],
        [11916,   991, 29999,  6102,   634,   524],
        [13946,   277,   118,     8,     8,    12],
        [    0,   246,   365, 18480, 13442,     4],
        [  619,   598,  8108,   227,  8108,    26],
        [ 1978,    18,   183,  2042,  3594,   511],
        [   90,  1265,  1901,     1,    50,    63],
        [ 8943, 12354,     0,  1355,     2,    89],
        [   17,     5,   928,  8299,     1,  3773],
        [    3,    12,     3,  3180, 12330, 29999],
        [  389,     0,   246,     2,  1090,     4],
        [   29,  3445,    27,  3698,   185,    29],
        [11829,    28, 10866,  2075,     3,    20],
        [ 7794,     1,     0, 12126,     1,     0],
        [   18,  4313,    19,   767,    72,    70],
        [  932,  1981,     4,   788,  4574,  3862],
        [   37,    31, 16090,    11,     0, 29999],
        [    2,   114,     0,    80,   773,  1456],
        [  804, 12614,     2,  2046,     4,   187],
        [ 1705,  1218,    18,    35,    17,  1369],
        [  838,   609,     0,  7808,  4002, 10387],
        [ 2060,    47, 13230,     0, 29999,     2],
        [   27, 23856,    25,  3948,    23,     0],
        [ 6476,     6,    52,    26,    10,   696],
        [ 7862,    13,     0,   435,    41,    26],
        [   53,    56,  9364,   582,     0,  1797],
        [ 2546,    23,    65,    42, 29999,  4262],
        [  465,    82,     4,     2,  3584,     1],
        [ 2549,  1472,     2,  2005,    19,    33],
        [   16,     7,    14,  1167,    34, 14015],
        [  398,   274,     7,    20,     9,    16],
        [   55,   288,     0,     1,     0,   376],
        [  215,     6,  5502,   696,     6, 24355],
        [ 4479,     4,     0,    81,     1,     0],
        [ 5458,  6299,    23,    49, 14646, 29424],
        [ 1192,     6,    31, 17208,  4060,  1592],
        [    1,  7227,    67,     2,  3004,  3581],
        [  941,  1300,    23,  1918,  6600,  4329],
        [    0,   413,   113,  6058,    26,    40],
        [    0,  2736,   524,     5,   874,    23],
        [   14,   159,  6298,  1967,    38,   265],
        [16474,   188, 14056,   122,  4866,   109],
        [    1,     0, 29999, 29999,     5,   170],
        [ 1702,     2,     0,  3249,    10,  6748],
        [   45,  2249, 15372,  2155,   987,    24],
        [  738,    24,     0,   421,     3,     9],
        [    2, 22746,  1041,    13,    21,    81],
        [    0,  8999,  3115,   108,    64,  8659],
        [  347,    18, 11663,  2067,   223,  3300],
        [14809, 18381,  2367,    23, 29999, 29999],
        [  355,     5,  1485,     4,    44,  1213],
        [ 1699,    11,   110,    42, 17711,   105],
        [    0,  4378,    34,  1818,     1,     0],
        [  148,   300,   121,   325,   570,   225],
        [    5,   171,   137,     5, 29999,  2936],
        [   28,   603, 10573,    31,    59,     4],
        [    0,   979, 28719,  1363,     4,   387],
        [ 3548,  5920,    13, 14810,  8828,    27],
        [ 2763,    26, 29999,    12,    20,     7],
        [  143,     1,     0,  5336,  1628,   962],
        [ 7466,    50,     1,    39,  1705,   948],
        [    0,   172,    10,   120,     1,     5],
        [    4,    29,     3,    12,    15,  2973],
        [    7,     7,     8,     9,     7,     7],
        [  128,     9,     3,   128,    21,   128],
        [  114,    32,  2546,    19,     0, 19029],
        [   20,     2,     4,   937,     3,     8],
        [   13,    44, 29999,     2,    40,    37],
        [ 3267,     6, 29999,    26,  1284,   235],
        [    0, 26803,  2946,    32,   860,     4],
        [ 1278,   731,     2,   161,  3112,   211],
        [    0,  1598,     2,    32,   298,  1991],
        [    1,    16,  3998,    19,    25,  2796],
        [   12,     9,    16,    12,     8,    20],
        [   22,     3,     8,     3,   506,     3],
        [ 3402,    34,  4350,     6,   181,    97],
        [    1,   468,   845,     1, 14700,     2],
        [    1,   593,  2870, 12722,    10,   148],
        [  742,  1811,    74,     2, 19377,     0],
        [  256,    97,  3249,  6112,  7338,   213],
        [ 4258, 11709,  2797,   156,  3120, 29999],
        [    8,     3,    20,    12,     8,     3],
        [  261,     4,  1856,   321,     6,     5],
        [   82,  5767,     2, 20954,    79,     5]]) tensor([[    1,    12,    15,  ...,    65,     7, 11553],
        [10142,     0,    81,  ..., 28522,   147,    31],
        [    5,     0, 29999,  ...,  5896,     6, 29999],
        ...,
        [ 3780,   818,    58,  ...,     0,    24,   178],
        [ 1756,   416,    23,  ...,   398,  1444,     2],
        [    1,   203,  8880,  ...,     0, 16466,     3]])
tensor([  114, 24821,  3643,     0,  1354,   198,   808,  1074,   268,   231,
          223,  1095,     3,  2658,   484,     1, 10670,   208,   753,     4,
         6583,     2,    29,   345,   802,     0,  7046,    23,    85,   101,
           32,    49,   100,     8,     6,     5,     6,  6905,    12,  1525,
          166, 28670,   953,   796,   147,     7,   200,    74,  3542,    21,
            7,     2,   105,    22,    18,     3,    21,   880,    16,    18,
         2510,     0,    32,    32,     6,   592,    27,  2351,    34,    30,
            0,    74,   248,  7749,     3,     3,    90,     4,    12, 16497,
          374, 29999,    96,    49,     6,     1,     6, 18399,    15, 26517,
            0,     7,    92,    13,     7,   543,   349,   214,   318,  2925,
           15,  3925,   255,   889,    57, 10978, 29999,     3,   445,     6,
         1355,    14,  1061,   325,     6, 29999,   113,     3,   343,    16,
           56,  1841, 29379, 16743,     5,  1302,    15,     4]) tensor([[    5, 26934,  8395, 15733,    18,  6126],
        [18869,   348,    11,  3206,  4183,   673],
        [10297,     1,    32,    10,     0, 13983],
        [ 5245,    82,    23,   122,    76,     2],
        [   11,   547,     6,     0,  4723,    11],
        [   23,     0,  3048,     2,     0, 12032],
        [24168,    23, 29999,  3273,     6,  5672],
        [ 1399, 20662,  1048,    62,    26,   133],
        [   29,   164,  1606, 29931,  2455,     4],
        [ 5865,   251,     0,  4031,     1,  2551],
        [   22,   129,   947, 29999, 29999,     9],
        [  131,    18,     0,   271,    13,  1700],
        [  145,  1093,  2921,     8,    22,    16],
        [    6,  1327,   599,  3433,    19,  4501],
        [29999,  8372,    34,   168, 12123,   204],
        [    5,   379,   419,  9281,     6, 22491],
        [29999, 13761, 29999, 26259,     2, 29999],
        [ 1649,    41,     3,    93,  4492,     0],
        [17917,    40,    53,    26,    40,   297],
        [29999, 16765, 29999,     3,     8,     8],
        [   19,     0,   258,   275,    31,  3670],
        [29999,   153,  1263,   438,  4615,    73],
        [    3, 13732,  8965,  1661, 11719,    34],
        [  705,     6,    30, 12289,     9,   398],
        [ 1687,     1,     5,   562,  2086,     5],
        [    0,  2337,    60,  1566,     1,    20],
        [ 6824, 20608,     2,  3965,  6967,     0],
        [  100,    76,    11,     0,   986,     1],
        [ 2884,     0,    63,    35,     0,   295],
        [ 3259,     0, 21208,     1, 29999,  4596],
        [   19,    87,    93,    17,   124,    33],
        [  762,     6,    75,    69,     3,  6051],
        [  466, 29999,    14,  1217, 29252,     1],
        [23471, 20947,     3,    15,    15,     4],
        [   42,   418,   215,  1887,   106,     0],
        [   25,  8017, 14104,  6962,     1,  2039],
        [    2,     0,  4998,     0,  2337,    27],
        [29999,    33,    17,  4797,   154,  9199],
        [    3,     8,    20,   360,     4,   549],
        [   63,     0,   956,    17,   738,   237],
        [18393,    17,     5,   187,  1812,     2],
        [   15, 24879,  5332,     0,  5332,  2873],
        [ 3855,  1879,  9754,   303,     6,     0],
        [    0,   717,    19,  6867,   143,    10],
        [  796,    46,    38,   611,  4040,    69],
        [   15,     7,     7,     6,    12,     7],
        [    0,   574,  2500,  1681,  6476,     5],
        [24664,  6351,   336,    36,  1011,    30],
        [  109,   146,     0,  9640,     4,   100],
        [   18,   102, 27813,  2648,     8,  5062],
        [    7,     7,     7,     7,   548,   151],
        [  702,   124,    15,     3,  1710,     6],
        [  161,    31,  3692,    56,  3371,   487],
        [    9,    22,    22,    15,     8,     9],
        [    5, 15146,  6872, 29999,     0,  6617],
        [   32,  1952,    11,   267,    36,   988],
        [    7,     3,     8,    16, 10123,  1052],
        [  115,    34, 19711,     0, 19711,  1696],
        [ 4763,    72,     3,     9,    12,     3],
        [   74,    31,   195,     0,   131,     9],
        [ 4317,  3652,    10,  2683,  1950,    87],
        [  135,    48,     1,   296,   559,   488],
        [   13,   770,     4,  1271,  2752,    14],
        [    7,     7,     4,  3032,    21,    16],
        [   26,   909,  2175,  2157,  7098,  3073],
        [29999,    84,    80,  9183,  4937,    84],
        [12515,  2446,   334,     0,   228,   469],
        [    0,   252,    19,    30,   395,  1377],
        [27175,  2793,  2686, 29999,    39,  3184],
        [ 5926,     2, 29999,  1543,   113,    39],
        [  196,   103,   256,   219,  2892,     5],
        [  415, 20568,    19,  7434,  4395,    19],
        [  643,    33,    47,   131,    83,  3041],
        [  139,    11,    46,  3378,    43,   546],
        [    3,     8,    22,     3,     8,    22],
        [  168, 29999,     4,     9,     3,     9],
        [    0,     9,    20,     1,   522,  6825],
        [29999, 29999, 29999,     3,     8,     8],
        [    7,     3,     8,     7,    62,    33],
        [  879,   289,    18,  1881,     5,    45],
        [ 3138, 18947,    37,  2749,    34,   869],
        [  273,    18,   466,     2,     0, 21473],
        [  231,  2467,    55,  1557,   115,   103],
        [ 5183,  1341,   772,    28,   297,   423],
        [ 1989,     0,  4091,   179, 29999,   209],
        [ 2645,    11,   158,   832,     2,   556],
        [   17,   601,  1174,    31,  7189,    26],
        [  303,  5280,  1511,    25,     0,  3176],
        [  743,     3,    12,    22,     3,     8],
        [   63,     5,   932,  5046,  1782,    17],
        [ 2505,     1, 16297,  2090,   530,   785],
        [  904,     3,    22,     7,   324,     3],
        [    0,   194,  6603,    48,  1143,    32],
        [   49, 26787,   120,    26,    69,     0],
        [  117,     3,     8,    20,    16,    22],
        [   12,    12,    42,     1,     0,   120],
        [    1,  3640,    46,    23,    52,  9218],
        [  330,   194,  8839, 11850,  3811,     2],
        [   16,    12,    30,     1, 29999,     0],
        [  915,     2,     6,   148,   606,  8534],
        [   22,     3,    20,    20,    16,     3],
        [   43,   425,     4, 18482,    58,    25],
        [  111,    23,  2067,  1290,     4,   544],
        [  405,    85,     0,     1,    50,    16],
        [17000,   483,     5,    10,   420,    13],
        [    1,     0,    52,    78, 11046,     4],
        [29999,   607,   639,     4,   458,     9],
        [ 1625, 23748,  1948, 22018,    23, 29999],
        [    1,     0,  5176,  2223,   520,  5585],
        [    3,    20,    17,  2677,   115,    13],
        [  316,    13,  2508,     4,   544,   909],
        [ 3694,  5493,   486,   145,  3109,   759],
        [  178,     0,  3728,     1, 11821,   295],
        [    8,     3,    15,  9757, 17544,  4319],
        [    6,  5581,     2,  4700,  3564,    64],
        [ 5766, 10352,   370,   692,     9,     7],
        [   27,    30,  1383,     1,  4736,     0],
        [  492,     4,    68,     8,    12,     7],
        [  509,     3,     7,     6,  1654,    16],
        [    3,     8,    16,     2,     3,     8],
        [    0,   691,     1, 29999,    26,   160],
        [10949, 29999,     0,     1,     0,  3207],
        [   71,    82,    70,   646,    75,   125],
        [    4,  3299,   107,     2,  3490,     1],
        [  828, 14648,     4,   330,   277,     1],
        [ 3312,    62,   632,    44,  4414,    18],
        [   15,     3,    22,     9,    16,  8018],
        [   70,  2347,  1678,   321,  4501,    70]]) tensor([[   49,   600,   192,  ...,     8,  2511,   346],
        [  419,    28,  1657,  ...,     8, 29999, 29999],
        [  395,  4000,   707,  ...,   715,   501,     4],
        ...,
        [    1,     6,     0,  ...,    94,    16,  2011],
        [    1,   651,  2439,  ...,  2007,  2533, 29999],
        [   19,   149,     0,  ...,   322,  1110, 29999]])
tensor([    0,     2,     4,   639,    16,    46,     0,   586, 29999,     8,
          768,    16,  1193,  5799,  2742,    21,     0,     9,   592,     1,
            0,  1227,     5, 19147,  4886,     5,     2,   423,     1, 29999,
         1402,  1351,     8,   682,    27,    14,   279,     3,     0, 12738,
          291,    42,     0, 15221,     6,    13,    28,   288, 29999,   490,
           49, 15922,   122,     1, 29999,   247,     4,   416, 11035, 22725,
            7,     0,   371,     2,  1447,  3366, 29999,     1,  3731,  3974,
            1,    68,   598,   782,   619,     4,  3465,  1266,  2507, 29999,
          645,  3280,  1739,     4,    37,  7130,    38,    15,  1029,  1314,
           30,     4,   219, 17848,  9703,     0,    10,     0,   821,   654,
            2,     0,   163,  1818,  3401,    31, 29999,  6968,    14,     0,
            5,     6,    36,     1,   178,     1,     2,  8386,  1810, 25037,
            2,    25,   255,    18,     1, 29999,  3989,  7394]) tensor([[ 7312,   584,    98,    40,  1898,    30],
        [29999,  1178,  3594,   799,  4615,     1],
        [  885,    39,   432,     0,   231,  2085],
        [    2,  9176,     4, 28349,   315,     2],
        [    3,     8,     8,  2895,     5,    94],
        [  701, 29999,    28,    51,    31,  2399],
        [ 1850,    82,   747,   784,     1,     0],
        [   10,    36,     5,     2,  3095,    38],
        [    5,   457,     1, 12358,  7160,    18],
        [   12,     8,     8,  1981,   467,   860],
        [ 3798,     1,   147,   185,     0,   333],
        [ 4613,     2,     3,    42,   642,    80],
        [ 1787,   478,   652,  1714,     2,   239],
        [    0,   400,   351,     4, 21707,  2544],
        [   19,  1668,     4,  5599,  1940,  2846],
        [   20,  1632,  3205,     3,    22,     9],
        [    0,  1114,     1,  1563,     2,  1730],
        [29999, 29999, 29999,     7,     7,     7],
        [24326,  9658,   122,     3,     8,    16],
        [   10,     5,   143,  1283,    19,    10],
        [    4,     0,    71,   290,  3719,     3],
        [   23,     5, 29999,  4185,    91,    89],
        [   40,  2920,    11,   234,  4062,   444],
        [ 3155,     1,     5,   109,   146,     0],
        [29999,     1,     0,  9693,  2882,   529],
        [29999,  2139,  8300,    10,    37,    86],
        [29999,   539,  1821,  2458,    73,     3],
        [  293,  3278,     6,  7628,    41,  4317],
        [    1,     0,  8731,     0,  1821,  1259],
        [29999,   610,    14,  2231,  2798,  3175],
        [29999,   155,  1756,     4,    65,   591],
        [    1,    65,    25,   217,  1649,     2],
        [   85,     3,     8,    21,    76,     0],
        [  179,     1,   164,    24,     9,     7],
        [  768,     2,  2018,     0,  9733,     4],
        [ 1507,     1, 29999,  1507, 29999,   327],
        [ 3349,  1529, 17952,     9,   341,  1403],
        [  206,     3,  1188,     8,     3,     3],
        [   19,  1862,    18,   202,     5,   238],
        [  604,  1722, 28764,   810,  3046,  2817],
        [   24,   269,     1,    28,   728, 20483],
        [  483,     6,     0,    24,     0,     3],
        [29999,     2,   195,   101,     1, 23172],
        [   39,   417,   353, 23525,  5843,    28],
        [   10,    36,  1462,    46,    47,     5],
        [    6,    29,  6286,   211,     9,  2011],
        [    1,   671,    10,   275,    31,   121],
        [  339, 13848,    19,     4,   545,     9],
        [  199,    92,     1, 13518,     6,     5],
        [ 1190,   193,     2,   178, 29999,    35],
        [ 1158,     3,    28,  2772,  2160,    23],
        [   37,  1791,   212,   478, 15922,   559],
        [29999, 19796,   105,   187,    28,  4410],
        [  495,     0, 27209,    30,  1372,  1163],
        [  192,    46,    25,     2, 24540,     2],
        [  109,   146,   447, 16395, 10670, 29468],
        [  147,  3482,     2,   549,  1808,   157],
        [  173, 29999,    43,   213,    36,    76],
        [    5,     9,  5561,  3643,   781,  3643],
        [24853,    44, 12066,    37,  1173, 29999],
        [28163,   484,     9,     7,     9,   497],
        [    2,  1380,    18,  1230,   310,     0],
        [   30,  1029,    68,    48,    63,    11],
        [  167,   603,   147,    31,   603,  6968],
        [   23,     5,   494, 29999,    19,   335],
        [21385,   587,     0,  1119,    10,    30],
        [ 9226,     4,   116,     4,     0,   291],
        [   80,     4,   459,    44,  5568,    11],
        [    1, 26924,   142,    17,   186,   356],
        [   45,    17,     5,     1,   284,  1951],
        [   79,     3,   343,    57,  1428,     6],
        [ 1180,    98,    46,    66,    31,  3119],
        [ 1051,  1027,  6398,  2959,    14, 29999],
        [ 9620,    46, 12880,    93,  2007,    23],
        [  205,   167,    36,  1423,    58,    25],
        [    2,   634,  1824,     9,     7,     7],
        [11057,   817, 10302,   211,     0,  1203],
        [    0, 12412,   234,     1,  4465,   311],
        [   21,     7,     7,    22,    12,     7],
        [   33,  1895,    23, 29999,     2,   133],
        [  195,    24,     0,    11,     0,  5476],
        [ 1278,  1209,     6,   111,    27,     0],
        [ 6371,    19,     5,    47,   908,  3265],
        [  235,   405,  3466,  5567, 13254,    19],
        [13561,    41,    10, 10922,     0, 10922],
        [   22, 29999, 12448,   479, 28965,    73],
        [  107,     1,    35,    43,   201,  2090],
        [    0,   178,   109,     7,   845,     0],
        [  173,  1008,  9741,   660,  1436,   182],
        [   23,     0,  6179,     1,  4128,   842],
        [  550,   316,    60,  1487,  3936,  7674],
        [   25,   160,   513,     0,  1849,  4887],
        [ 6624,     4,     0,   276,     4,    52],
        [ 2194, 17379,     1,  1614,     4,     5],
        [29999,   238,     4,     3,     8,    16],
        [  108,  3690,    24,   920,   375, 15170],
        [15347, 15371,  2966,    30,   241,  1711],
        [ 5593, 29999, 24206,   947,  3006,     4],
        [ 1811,     4,    61,  1380,    18,   473],
        [    1,   187,    10, 22244,    18,   347],
        [    1,   361,  3312,   330, 29999,  3610],
        [ 4273,     2,  1181,    57, 11847,     1],
        [    0,  2950,   250,  1057,    84,  5706],
        [  444,    30, 29999,   259,    19,  3334],
        [    3,   226,  7404,  2139,    72,     3],
        [ 2936,  2747,   161,  2411,    64,     5],
        [  867, 16747,     2,     4,   549,    81],
        [  837,    10,    76,     2,    56,    72],
        [  989,   598,   811, 22407,    92,    10],
        [   19,   909,   845,  3167,     1,     0],
        [  618, 15522,    11,   348,    13,    83],
        [   55,   673,    24,     5,   855,   538],
        [    2,  3480,    17,  4124,  1429,     6],
        [   11,     5,  3806, 29999,     2, 29999],
        [    7,    14,   490, 18904,     0,   375],
        [   28,    79,   319,     0,  1839, 18476],
        [ 3316,  8058,  6485,  4175,   836,    40],
        [    8,    21,     0,   690,   301,   971],
        [ 1668,     4, 13742,     1,   946,  2552],
        [   15,    16,  6084, 23092, 10213,  1862],
        [   29,    16,  6412, 29999, 14780,  6112],
        [   20,  2207,   277, 29999,    77,     9],
        [  357,     1,     5,   524,  1175,     5],
        [  523,     1,  9470,  6530,   478,     1],
        [    5,   634,   863,  4150,  1583,    14],
        [  137,     1,     5,     4,     5,  4044],
        [ 2518,    73,  8433, 29999,     2, 15104],
        [    0,  8595,     1,    40,    53,  6398]]) tensor([[  145,    14,  5093,  ...,    32,  5613,     4],
        [   27,    28, 29999,  ...,   843,     1,    22],
        [   71,    18, 17354,  ...,  2574,     1,    50],
        ...,
        [ 2736,   338,  1649,  ..., 19324,   309,     6],
        [    6,     0,  1218,  ...,  3399,   594,    77],
        [  377,  1768,    11,  ...,     3,     2,    13]])
tensor([  469,    41,    88,     5,   889,  3089,   106,     0,   365,     9,
        29999,   981,   980,    13,     2,  6325,     0,     0,    99,   363,
            2,  3557,   308,  1270,  4474, 29999,  4082,  3310,  1827, 19417,
         1268,   204,     0,    22,    38,  4544,    11,     0,     1,     6,
          309,  8363,   903, 13397,     9,  5517,     0,  2786,    73,   267,
        10354,    19,   465,     2,    28, 18180,    12,  1531,    14,     4,
         7517,   139,   931,     2,  9675,     1,    24,   150,   184,  5197,
           37,   123,     3,     3,    26,  2065,  1373,    13,  2465,  4329,
          132,    22,    13,  3228,     0,  8287,   615,  2478,   130,     1,
        29999,    21,    15,    16,     0,  6788,  9517, 18483,     0,     7,
        29999,  1119,  4904,  1514,     3,  8084,   459,     0,  3162,     3,
           95,     1,    10,   107,  1607,     8,  1199,   105,     1, 29999,
         3014,    82,     2,    14,   132,     1,   833,  4458]) tensor([[ 1632,    24,    20,     3,    12,    12],
        [    6,    89,   111,   667,     4,     3],
        [ 5220,     0,    45, 12841,   341,  4117],
        [    6,    26,    11,   143,     1, 12144],
        [  434,   597,   657,    24,     0,  2190],
        [  355, 10888,  1030,     0, 29999,    17],
        [   33,    47,  3168,  3793,    19,   134],
        [    4,   410,     2,     9,     1,   111],
        [ 3259,    18,    61,   105,   149,  2311],
        [    7,     7,     7,     7,     7,     7],
        [   54,    11,  1236,   104,   251,  6075],
        [   14,  2623,  2199,     0,   472,  1581],
        [    1,  4360,    67,     3,     8,     8],
        [    0,   359,   488,  6312,  6566,  1275],
        [29999,   367,  3543,  3566,    23,  3223],
        [   22,     9,  3863,  2603,     1,    73],
        [   14,  2168,     1, 29999,     1,     0],
        [ 2333,  3067,  2354,  2434,  5456,     0],
        [  117,     7,   128,   128,    10,     0],
        [    1,  2389,  5642,    28, 10038,    48],
        [  117,   128,     3,   117,   128,     9],
        [    0, 29999,    46,    32,    10,   564],
        [    6,     0,  4380,  2320,    24,     0],
        [ 1668,     4,     5,  2494,     2,    30],
        [   42,    13,   137,    40,    49,  5288],
        [    2,   450,   848,    10,   181,     4],
        [    2, 12733,   471,     0, 29999,    47],
        [12149, 29999,     0,   911,     3,     8],
        [   41,   432,     0,     2,   783,     1],
        [  937, 19117, 29999,     0,   438,     1],
        [  109,   158,   317,     6,     0, 19400],
        [   54,    11, 15041,  2906,   360,  2939],
        [  491,   611,    69, 29999,    16,    10],
        [    7,     3,     9,    20,     6,     3],
        [  236,  3149,   478,  2920,   118,     0],
        [ 8833,     6,   441,    14,     5, 22586],
        [    0, 10293,  1345, 12819,   684,    60],
        [   42,  7937,    24,  1721,     2,     0],
        [  351,  4836,   681,  4709, 29999,     0],
        [   38,   489,   156,  7383,     3,  1575],
        [   86,    13,     0,   726,    27, 29999],
        [ 1946,   948,     4,   478, 11417,     5],
        [  164,  2847,   791, 14218,   593,  2460],
        [ 7685,  3830,     6,     0,  3502,    55],
        [    7,     7,  1666,    15,     7,     7],
        [    2,  1552,  1717,    97,    24,     0],
        [ 4602,    28,    19,   519,  5832,    74],
        [ 2786,     0,  1624,  1624,  1592,     5],
        [  128,     9,  6724,    16,   128,   159],
        [    0, 21206,   794, 21206,    40,    75],
        [ 7579, 24652, 29999,     2,  8494, 12774],
        [    5,   379,  2565,     0,   675,   726],
        [  219,     0,    61,    82,     3,     8],
        [  669,   336,   295,   284,   472,  5339],
        [   25,   958,  3997, 18536,     6,    18],
        [  411,  1440, 29999,    55,    10,     0],
        [  968,     9,    20,  7664,   667,    23],
        [ 5867,     1,     0,     1,    30,  4151],
        [ 1414,    14, 29999,   191,     4,     0],
        [ 3798,    10,  3211,     0,   272,    24],
        [    7,    21,  3815,   231,   301,  2467],
        [   29,  4117,  4973,   216,    33,  3421],
        [    0,  1477,    19,    17,  1521,   383],
        [29999, 29999, 29999, 29999, 29999,    60],
        [  355,    43,   201,    35,     4,    48],
        [  219,     0,  2197,     0,  1497,     4],
        [ 7299, 15056,   541,   919,    16,    22],
        [ 2279,     4,     0,    14,     2,   446],
        [  184,  6142,    62,  1554,    70,  2074],
        [    4,  6812,    32,    34,  1723,  1080],
        [ 1129,   168, 21868,   355,     5,  1481],
        [14526,    19,  1118,     0,  4019,     6],
        [ 4539, 29999,   209,     8,    21,     8],
        [    3,     8,    22,    33,    17,   432],
        [  177,     1,   505,    10,     0,  3372],
        [   35,    17,   186,    63,    32,  1473],
        [  553,     1,     0, 12193,    51,    31],
        [    5,   449,   183,  3159,   154,  3204],
        [  538,   160,     5,    49,  6445, 22543],
        [ 8112, 29999,    28,     0,    92,  8112],
        [ 1301,    25,     0,   326,     4,   263],
        [    3,    22,     8,   163,     4,  2899],
        [ 7274,  3580,  2692, 29999,    91,  3688],
        [   90,   119,   133,    24,  8457,   975],
        [   53,  2278,    27,  3819,   200,    34],
        [   27,    29,     9,    66,     5,  1130],
        [   16,   146,  6008,   622,  1182,  6539],
        [  444,    13,     0,  1213,  2140,   125],
        [  152,    26,    17,     6,    31,  9426],
        [ 3022,     0,    95,     0,   438,     4],
        [    9,    12,  4854,   100,  6755,    72],
        [  153,   741,    16,    16,    22,     3],
        [15768,  1424,   155,    15, 29999,     9],
        [    9,     7,     7,     0, 10050,  4656],
        [ 1177,     6,   705,   342,   385,     5],
        [   12, 29999,   289,  4361,    75,     3],
        [    1,     0,   679,     1,     0,     3],
        [   19,  2395,    96,    18,     5,  2792],
        [    7,  7846,  3948,   609,    52,     1],
        [  223,    34,   128,    41,    26,    40],
        [    8,     9,    16,    64,     5,   178],
        [   24,     0,   542,     1,     0,    45],
        [ 8650,     2, 16933,  3539,     0,  7187],
        [ 2309,     6,   761, 14652,     1,   675],
        [    1,     0,    72,    22,    39,  9232],
        [  113,   196,    51,    58,    10,   521],
        [   18,   407,   739,    13,  4476,   214],
        [   21,     3,     9,   500,   436,     2],
        [    5,  1632,   400,   927,   191,    34],
        [ 1184,    15,    22,  3769,    25, 11584],
        [  265,     5,  3254,     2,    39, 18622],
        [ 1549,    86,  6795,     0,    57,  1683],
        [   99,     0, 13281,    78,    16,     7],
        [12402,  1016,    18,  6434,     2,   227],
        [   17,     6,   371,    81,     4,     3],
        [    3,     8,     7,  1431,    56,   100],
        [   62,  2052,    45, 28316,     4,  2052],
        [   21,     7,    16,    19,  1283,     0],
        [   11,     0,    89,     0, 29999,    33],
        [    0,   911, 29999,     2,   484,   109],
        [  669,  3507,    18,  7612,   249,    11],
        [  197,     1,     0,     3,    22,     8],
        [  577,     6,  3128, 21252,    18,     0],
        [    0,   193,  2696,   607,  1976,  4675],
        [ 6192,    13,     0,  1602,    51,   293],
        [  102,    13,  2237,  3264,   111,     4],
        [   75,   792,   161,  4067,  3318,     1],
        [    2,  5582,     6, 20373,     2,  3928]]) tensor([[   32,    37,   276,  ..., 29999,    30,    17],
        [   14,     2,    25,  ...,    23,  9077,   159],
        [   21,  1714,    12,  ...,    10,   680,     9],
        ...,
        [ 2525,    13,    37,  ...,    33,  1831,    11],
        [    5,  7315,    34,  ...,   108,    23,   147],
        [    0,     0, 15665,  ...,  6368,  1104, 19705]])</code></pre></li>
</ul>
<h3 id="define-embedding-model">3.2.3 Define Embedding model</h3>
<ul>
<li><p>创建 <code>Embedding</code> 类：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmbeddingModel</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, vocab_size, embed_size</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27; 初始化输出和输出embedding</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">super</span>(EmbeddingModel, self).__init__()</span><br><span class="line">        self.vocab_size = vocab_size</span><br><span class="line">        self.embed_size = embed_size</span><br><span class="line"></span><br><span class="line">        initrange = <span class="number">0.5</span> / self.embed_size</span><br><span class="line">        self.out_embed = nn.Embedding(self.vocab_size, self.embed_size, sparse=<span class="literal">False</span>)</span><br><span class="line">        self.out_embed.weight.data.uniform_(-initrange, initrange)</span><br><span class="line"></span><br><span class="line">        self.in_embed = nn.Embedding(self.vocab_size, self.embed_size, sparse=<span class="literal">False</span>)</span><br><span class="line">        self.in_embed.weight.data.uniform_(-initrange, initrange)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, input_labels, pos_labels, neg_labels</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        input_labels: 中心词, [batch_size]</span></span><br><span class="line"><span class="string">        pos_labels: 中心词周围 context window 出现过的单词 [batch_size * (window_size * 2)]</span></span><br><span class="line"><span class="string">        neg_labelss: 中心词周围没有出现过的单词，从 negative sampling 得到 [batch_size, (window_size * 2 * K)]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        return: loss, [batch_size]</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        batch_size = input_labels.size(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        input_embedding = self.in_embed(input_labels) <span class="comment"># B * embed_size, [batch_size, embed_size]</span></span><br><span class="line">        pos_embedding = self.out_embed(pos_labels) <span class="comment"># B * (2*C) * embed_size, [batch_size, embed_size]</span></span><br><span class="line">        neg_embedding = self.out_embed(neg_labels) <span class="comment"># B * (2*C * K) * embed_size, [batch_size, (window_size * 2 * k), embed_size]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># input_embedding = input_embedding.unsqueeze(2) # [batch_size, embed_size, 1]</span></span><br><span class="line">        log_pos = torch.bmm(pos_embedding, input_embedding.unsqueeze(<span class="number">2</span>)).squeeze() <span class="comment"># B * (2*C), [batch_size, (window_size * 2)]</span></span><br><span class="line">        log_neg = torch.bmm(neg_embedding, -input_embedding.unsqueeze(<span class="number">2</span>)).squeeze() <span class="comment"># B * (2*C*K), [batch_size, (window_size * 2 * k)]</span></span><br><span class="line"></span><br><span class="line">        log_pos = F.logsigmoid(log_pos).<span class="built_in">sum</span>(<span class="number">1</span>)</span><br><span class="line">        log_neg = F.logsigmoid(log_neg).<span class="built_in">sum</span>(<span class="number">1</span>) <span class="comment"># batch_size</span></span><br><span class="line"></span><br><span class="line">        loss = log_pos + log_neg</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> -loss</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">input_embeddings</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.in_embed.weight.data.cpu().numpy()</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>实例化模型并移动到 <code>GPU</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model = EmbeddingModel(VOCAB_SIZE, EMBEDDING_SIZE)</span><br><span class="line"><span class="keyword">if</span> USE_CUDA:  </span><br><span class="line">  model.cuda()</span><br></pre></td></tr></table></figure></li>
<li><p>模型训练</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">optimizer = torch.optim.SGD(model.parameters(), lr = LEARNING_RATE)</span><br><span class="line"><span class="keyword">for</span> e <span class="keyword">in</span> <span class="built_in">range</span>(NUM_EPOCHS):</span><br><span class="line">  <span class="keyword">for</span> i, (input_labels, pos_labels, neg_labels) <span class="keyword">in</span> <span class="built_in">enumerate</span>(dataloader):</span><br><span class="line">    input_labels = input_labels.long()</span><br><span class="line">    pos_labels = pos_labels.long()</span><br><span class="line">    neg_labels = neg_labels.long()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> USE_CUDA:</span><br><span class="line">      input_labels = input_labels.cuda()</span><br><span class="line">      pos_labels = pos_labels.cuda()</span><br><span class="line">      neg_labels = neg_labels.cuda()</span><br><span class="line"></span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line">    loss = model(input_labels, pos_labels, neg_labels).mean()</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i%<span class="number">10000</span> == <span class="number">0</span>:</span><br><span class="line">      print(<span class="string">&#x27;epoch&#x27;</span>, e, <span class="string">&#x27;iteration&#x27;</span>, i, loss.cpu().item())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>epoch 0 iteration 0 420.04754638671875
epoch 0 iteration 10000 37.9792366027832
epoch 0 iteration 20000 33.68553924560547
epoch 0 iteration 30000 33.009620666503906
epoch 0 iteration 40000 33.17190170288086
epoch 0 iteration 50000 32.391265869140625
epoch 0 iteration 60000 32.888916015625
epoch 0 iteration 70000 32.370094299316406
epoch 0 iteration 80000 32.19983673095703
epoch 0 iteration 90000 31.926647186279297
epoch 0 iteration 100000 32.60920715332031
epoch 0 iteration 110000 32.57024383544922
epoch 1 iteration 0 31.93549346923828
epoch 1 iteration 10000 32.00389862060547
epoch 1 iteration 20000 32.29582214355469
epoch 1 iteration 30000 32.100887298583984
epoch 1 iteration 40000 32.123470306396484
epoch 1 iteration 50000 31.802623748779297
epoch 1 iteration 60000 32.11222839355469
epoch 1 iteration 70000 32.37131881713867
epoch 1 iteration 80000 31.90352439880371
epoch 1 iteration 90000 31.634069442749023
epoch 1 iteration 100000 31.78694725036621
epoch 1 iteration 110000 32.359596252441406</code></pre></li>
<li><p>保存参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">embedding_weights = model.input_embeddings()np.save(<span class="string">&quot;/content/drive/MyDrive/Word_embedding/embedding-&#123;&#125;&quot;</span>.<span class="built_in">format</span>(EMBEDDING_SIZE), embedding_weights)torch.save(model.state_dict(), <span class="string">&quot;/content/drive/MyDrive/Word_embedding/embedding-&#123;&#125;.th&quot;</span>.<span class="built_in">format</span>(EMBEDDING_SIZE))</span><br></pre></td></tr></table></figure></li>
<li><p>加载保存的模型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model.load_state_dict(torch.load(<span class="string">&quot;/content/drive/MyDrive/Word_embedding/embedding-&#123;&#125;.th&quot;</span>.<span class="built_in">format</span>(EMBEDDING_SIZE)))</span><br></pre></td></tr></table></figure></li>
<li><p>模型评估</p>
<p>下面是评估模型的代码，以及训练模型的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate</span>(<span class="params">filename, embedding_weights</span>):</span>  <span class="keyword">if</span> filename.endswith(<span class="string">&quot;.csv&quot;</span>):      data = pd.read_csv(filename, sep=<span class="string">&quot;,&quot;</span>)  <span class="keyword">else</span>:      data = pd.read_csv(filename, sep=<span class="string">&quot;\t&quot;</span>)  human_similarity = []  model_similarity = []  <span class="keyword">for</span> i <span class="keyword">in</span> data.iloc[:, <span class="number">0</span>:<span class="number">2</span>].index:      word1, word2 = data.iloc[i, <span class="number">0</span>], data.iloc[i, <span class="number">1</span>]      <span class="keyword">if</span> word1 <span class="keyword">not</span> <span class="keyword">in</span> word_to_idx <span class="keyword">or</span> word2 <span class="keyword">not</span> <span class="keyword">in</span> word_to_idx:          <span class="keyword">continue</span>      <span class="keyword">else</span>:          word1_idx, word2_idx = word_to_idx[word1], word_to_idx[word2]          word1_embed, word2_embed = embedding_weights[[word1_idx]], embedding_weights[[word2_idx]]          model_similarity.append(<span class="built_in">float</span>(sklearn.metrics.pairwise.cosine_similarity(word1_embed, word2_embed)))          human_similarity.append(<span class="built_in">float</span>(data.iloc[i, <span class="number">2</span>]))  <span class="keyword">return</span> scipy.stats.spearmanr(human_similarity, model_similarity)<span class="comment"># , model_similaritydef find_nearest(word):    index = word_to_idx[word]    embedding = embedding_weights[index]    cos_dis = np.array([scipy.spatial.distance.cosine(e, embedding) for e in embedding_weights])    return [idx_to_word[i] for i in cos_dis.argsort()[:10]]</span></span><br></pre></td></tr></table></figure></li>
<li><p>训练模型步骤：</p>
<ul>
<li>模型一般需要训练若干个 <code>epoch</code></li>
<li>每个 <code>epoch</code> 我们都把所有的数据分成若干个 <code>batch</code></li>
<li>把每个 <code>batch</code> 的输入和输出都包装成 cuda tensor</li>
<li>forward pass，通过输入的句子预测每个单词的下一个单词</li>
<li>用模型的预测和正确的下一个单词计算 cross entropy loss</li>
<li>清空模型当前 <code>gradient</code></li>
<li>backward pass</li>
<li>更新模型参数</li>
<li>每隔一定的 <code>iteration</code> 输出模型在当前 <code>iteration</code> 的 <code>loss，以及在验证数据集上做模型的评估</code></li>
</ul></li>
</ul>
<h3 id="在测试集上进行模型评估">3.2.4 在测试集上进行模型评估</h3>
<p>本例中，使用 MEN 和 Simplex-999 数据集进行样本外评估</p>
<ul>
<li><p>加载数据和评估</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">embedding_weights = model.input_embeddings()</span><br><span class="line">print(<span class="string">&quot;simlex-999&quot;</span>, evaluate(<span class="string">&quot;/content/drive/MyDrive/Word_embedding/simlex-999.txt&quot;</span>, embedding_weights))</span><br><span class="line">print(<span class="string">&quot;men&quot;</span>, evaluate(<span class="string">&quot;/content/drive/MyDrive/Word_embedding/men.txt&quot;</span>, embedding_weights))</span><br><span class="line">print(<span class="string">&quot;wordsim353&quot;</span>, evaluate(<span class="string">&quot;/content/drive/MyDrive/Word_embedding/wordsim353.csv&quot;</span>, embedding_weights))</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<pre><code>simlex-999 SpearmanrResult(correlation=0.16835319824603753, pvalue=1.6908393994875427e-07)men SpearmanrResult(correlation=0.18093374889038655, pvalue=1.9329614120922215e-20)wordsim353 SpearmanrResult(correlation=0.28416412711604, pvalue=2.440437723067791e-07)</code></pre></li>
</ul>
<h3 id="look-for-nearest-neighbors">3.2.5 Look for nearest neighbors</h3>
<ul>
<li><p>相似度分析</p>
<p>查找与给定单词最相关的词：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> [<span class="string">&quot;good&quot;</span>, <span class="string">&quot;fresh&quot;</span>, <span class="string">&quot;monster&quot;</span>, <span class="string">&quot;green&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;america&quot;</span>, <span class="string">&quot;chicago&quot;</span>, <span class="string">&quot;work&quot;</span>, <span class="string">&quot;computer&quot;</span>, <span class="string">&quot;language&quot;</span>]:</span><br><span class="line">  print(word, find_nearest(word))</span><br></pre></td></tr></table></figure>
<pre><code>good [&#39;good&#39;, &#39;bad&#39;, &#39;experience&#39;, &#39;future&#39;, &#39;hard&#39;, &#39;perfect&#39;, &#39;truth&#39;, &#39;money&#39;, &#39;love&#39;, &#39;personal&#39;]
fresh [&#39;fresh&#39;, &#39;grain&#39;, &#39;dense&#39;, &#39;lighter&#39;, &#39;sized&#39;, &#39;waste&#39;, &#39;noise&#39;, &#39;drinking&#39;, &#39;colour&#39;, &#39;concrete&#39;]
monster [&#39;monster&#39;, &#39;golem&#39;, &#39;giant&#39;, &#39;vampire&#39;, &#39;melody&#39;, &#39;cube&#39;, &#39;jaguar&#39;, &#39;finger&#39;, &#39;rod&#39;, &#39;horn&#39;]
green [&#39;green&#39;, &#39;blue&#39;, &#39;yellow&#39;, &#39;white&#39;, &#39;cross&#39;, &#39;red&#39;, &#39;black&#39;, &#39;orange&#39;, &#39;gold&#39;, &#39;mountain&#39;]
like [&#39;like&#39;, &#39;etc&#39;, &#39;rich&#39;, &#39;soft&#39;, &#39;unlike&#39;, &#39;similarly&#39;, &#39;bear&#39;, &#39;animals&#39;, &#39;sounds&#39;, &#39;fish&#39;]
america [&#39;america&#39;, &#39;africa&#39;, &#39;korea&#39;, &#39;india&#39;, &#39;australia&#39;, &#39;indian&#39;, &#39;europe&#39;, &#39;turkey&#39;, &#39;asia&#39;, &#39;pakistan&#39;]
chicago [&#39;chicago&#39;, &#39;boston&#39;, &#39;texas&#39;, &#39;london&#39;, &#39;illinois&#39;, &#39;berkeley&#39;, &#39;florida&#39;, &#39;massachusetts&#39;, &#39;indiana&#39;, &#39;austin&#39;]
work [&#39;work&#39;, &#39;writing&#39;, &#39;job&#39;, &#39;marx&#39;, &#39;recording&#39;, &#39;writings&#39;, &#39;speech&#39;, &#39;vision&#39;, &#39;label&#39;, &#39;ideas&#39;]
computer [&#39;computer&#39;, &#39;digital&#39;, &#39;software&#39;, &#39;audio&#39;, &#39;electronic&#39;, &#39;video&#39;, &#39;hardware&#39;, &#39;computers&#39;, &#39;graphics&#39;, &#39;programs&#39;]
language [&#39;language&#39;, &#39;languages&#39;, &#39;alphabet&#39;, &#39;arabic&#39;, &#39;spoken&#39;, &#39;programming&#39;, &#39;grammar&#39;, &#39;pronunciation&#39;, &#39;dialects&#39;, &#39;dialect&#39;]</code></pre></li>
</ul>
<h3 id="单词之间的关系">3.2.6 单词之间的关系</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">man_idx = word_to_idx[<span class="string">&quot;man&quot;</span>]</span><br><span class="line">king_idx = word_to_idx[<span class="string">&quot;king&quot;</span>]</span><br><span class="line">woman_idx = word_to_idx[<span class="string">&quot;woman&quot;</span>]</span><br><span class="line">embedding = embedding_weights[woman_idx] - embedding_weights[man_idx] + embedding_weights[king_idx]</span><br><span class="line">cos_dis = np.array([scipy.spatial.distance.cosine(e, embedding) <span class="keyword">for</span> e <span class="keyword">in</span> embedding_weights])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cos_dis.argsort()[:<span class="number">20</span>]:</span><br><span class="line">    print(idx_to_word[i])</span><br></pre></td></tr></table></figure>
<pre><code>king
henry
charles
queen
pope
iii
edward
elizabeth
prince
alexander
constantine
james
son
louis
iv
mary
william
francis
albert
joseph</code></pre>
<p>理想的效果的是得到的结果是 <code>queen</code> 的词向量，可以发现出现在第四位，勉强能捕捉到这一信息，但精度还有待提高，这跟训练的次数和语料库大小有关。</p>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Pytorch</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Deep learning</tag>
        <tag>Pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>Pytorch</title>
    <url>/2021/04/08/Pytorch/</url>
    <content><![CDATA[<h1 id="pytorch-brief">1 Pytorch brief</h1>
<h2 id="create-tensor">1.1 Create Tensor</h2>
<ul>
<li><p><code>empty</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">x1 = torch.empty(<span class="number">5</span>, <span class="number">3</span>) <span class="comment"># 构造未初始化的矩阵</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>rand</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x2 = torch.rand(<span class="number">5</span>, <span class="number">3</span>) <span class="comment"># 构造随机初始化的正态分布矩阵</span></span><br></pre></td></tr></table></figure></li>
</ul>
<a id="more"></a>
<ul>
<li><p><code>randn</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.randn(<span class="number">3</span>, <span class="number">3</span>)  <span class="comment"># [0,1]之间标准正态分布</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>arange</code></p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.arange(<span class="number">0</span>, <span class="number">10</span>, <span class="number">2</span>) <span class="comment"># 0-10, steps is 2</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><code>linspace</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.linspace(<span class="number">0</span>, <span class="number">10</span>, steps=<span class="number">5</span>)  <span class="comment"># 0到10，分5份</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>zeros</code> &amp; <code>ones</code> &amp; <code>eye</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x3 = torch.zeros(<span class="number">5</span>, <span class="number">3</span>) <span class="comment"># 类型为 float32</span></span><br><span class="line">x4 = torch.zeros(<span class="number">5</span>, <span class="number">3</span>, dtype=torch.long)</span><br><span class="line"></span><br><span class="line">a = torch.ones(<span class="number">3</span>, <span class="number">3</span>)  <span class="comment"># 3*3,全1矩阵</span></span><br><span class="line"></span><br><span class="line">a = torch.eye(<span class="number">3</span>, <span class="number">3</span>)  <span class="comment"># 3*3,对角矩阵</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>full</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.full([<span class="number">2</span>, <span class="number">3</span>], <span class="number">7</span>)  <span class="comment"># 2行3列，全是7</span></span><br></pre></td></tr></table></figure></li>
<li><p>From datum <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x5 = torch.tensor([<span class="number">5.4</span>, <span class="number">3</span>]) <span class="comment"># 从数据创建</span></span><br><span class="line">x6 = x5.new_ones(<span class="number">5</span>, <span class="number">3</span>) <span class="comment"># 同x5一样的数据类型</span></span><br><span class="line">x7 = torch.randn_like(x6, dtype = torch.<span class="built_in">float</span>) <span class="comment"># 创建同x6一样大小的正态 Tensor</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>From NumPy</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = np.array([<span class="number">2</span>, <span class="number">5.5</span>])</span><br><span class="line">print(a)</span><br><span class="line">b = torch.from_numpy(a)</span><br><span class="line">print(b)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="operations">1.2 Operations</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.rand(<span class="number">5</span>, <span class="number">3</span>)</span><br><span class="line">y = torch.rand(<span class="number">5</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<h3 id="attributions">1.2.1 Attributions</h3>
<ul>
<li><p>Type <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 x 的类型</span></span><br><span class="line">xType1 = x.<span class="built_in">type</span>()</span><br><span class="line">xType2 = x.dtype</span><br><span class="line">print(<span class="string">&#x27;first:&#123;&#125;, second: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(xType1, xType2))</span><br></pre></td></tr></table></figure></p></li>
<li><p>Shape <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看 Tensor 的形状</span></span><br><span class="line">print(x.size())</span><br><span class="line">print(x.shape)</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h3 id="numerical-operations">1.2.2 Numerical operations</h3>
<ul>
<li><p>Add <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 加法</span></span><br><span class="line">x + y</span><br><span class="line">x/y <span class="comment"># 除法</span></span><br><span class="line">torch.add(x, y, [out = result])</span><br><span class="line">y.add_(x)</span><br></pre></td></tr></table></figure> <code>in-place</code> 的运算都会以 <code>_</code> 结尾。 举例来说：<code>x.copy_(y)</code>, <code>x.t_()</code>, 该操作会改变 <code>x</code>。</p></li>
<li><p>Metric multiple</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.ones(<span class="number">2</span>, <span class="number">2</span>) * <span class="number">2</span></span><br><span class="line">b = torch.ones(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">print(torch.mm(a, b))  <span class="comment"># 只适用于2维数组</span></span><br><span class="line">print(a@b)</span><br><span class="line">a = torch.rand(<span class="number">4</span>, <span class="number">32</span>, <span class="number">28</span>, <span class="number">28</span>)</span><br><span class="line">b = torch.rand(<span class="number">4</span>, <span class="number">32</span>, <span class="number">28</span>, <span class="number">16</span>)</span><br><span class="line">print(torch.matmul(a, b).shape)  <span class="comment"># 可以适用于多维数组，只将最后两个维度相乘</span></span><br></pre></td></tr></table></figure>
<p><code>mm</code> 只适用于<code>2</code> 维数组的矩阵相乘，<code>matmul</code> 可以适用于多维数组，只将最后两个维度相乘。Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tensor([[<span class="number">4.</span>, <span class="number">4.</span>, <span class="number">4.</span>],</span><br><span class="line">        [<span class="number">4.</span>, <span class="number">4.</span>, <span class="number">4.</span>]])</span><br><span class="line">tensor([[<span class="number">4.</span>, <span class="number">4.</span>, <span class="number">4.</span>],</span><br><span class="line">        [<span class="number">4.</span>, <span class="number">4.</span>, <span class="number">4.</span>]])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">32</span>, <span class="number">28</span>, <span class="number">16</span>])</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>pow</code> &amp; <code>sqrt</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.ones(<span class="number">2</span>, <span class="number">2</span>) * <span class="number">2</span></span><br><span class="line"><span class="comment"># Pow</span></span><br><span class="line">a.<span class="built_in">pow</span>(<span class="number">2</span>)</span><br><span class="line">a**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sqrt</span></span><br><span class="line">a.sqrt()</span><br><span class="line">a**<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tensor([[<span class="number">4.</span>, <span class="number">4.</span>],</span><br><span class="line">        [<span class="number">4.</span>, <span class="number">4.</span>]])</span><br><span class="line">tensor([[<span class="number">4.</span>, <span class="number">4.</span>],</span><br><span class="line">        [<span class="number">4.</span>, <span class="number">4.</span>]])</span><br><span class="line">tensor([[<span class="number">1.4142</span>, <span class="number">1.4142</span>],</span><br><span class="line">        [<span class="number">1.4142</span>, <span class="number">1.4142</span>]])</span><br><span class="line">tensor([[<span class="number">1.4142</span>, <span class="number">1.4142</span>],</span><br><span class="line">        [<span class="number">1.4142</span>, <span class="number">1.4142</span>]])</span><br></pre></td></tr></table></figure></li>
<li><p><code>exp</code> &amp; <code>log</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Exp</span></span><br><span class="line">a = torch.exp(torch.ones(<span class="number">2</span>, <span class="number">2</span>))  <span class="comment"># e运算</span></span><br><span class="line">print(a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line">print(torch.log(a))  <span class="comment"># 取对数，默认以e为底</span></span><br></pre></td></tr></table></figure></li>
<li><p>Round</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.tensor(<span class="number">3.14</span>)</span><br><span class="line">print(a.floor())  <span class="comment"># 向下取整</span></span><br><span class="line">print(a.ceil())  <span class="comment"># 向上取整</span></span><br><span class="line">print(a.trunc())  <span class="comment"># 取整数部分</span></span><br><span class="line">print(a.frac())  <span class="comment"># 取小数部分</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>floor</code>：向下取整;</li>
<li><code>ceil</code>：向上取整;</li>
<li><code>traunc</code>：取整数部分：</li>
<li><code>frac</code>，取小数部分。</li>
</ul></li>
<li><p><code>clamp</code></p>
<p><code>clamp</code> 可以用来限定数组的范围。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.rand(<span class="number">2</span>, <span class="number">3</span>) * <span class="number">15</span></span><br><span class="line">print(a)</span><br><span class="line">print(a.clamp(<span class="number">2</span>))  <span class="comment"># 限定最小值为2</span></span><br><span class="line">print(a.clamp(<span class="number">2</span>, <span class="number">10</span>))  <span class="comment"># 取值范围在0-10</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tensor([[ <span class="number">0.7791</span>,  <span class="number">4.7365</span>,  <span class="number">4.2215</span>],</span><br><span class="line">        [<span class="number">12.7793</span>, <span class="number">11.7283</span>, <span class="number">13.1722</span>]])</span><br><span class="line">tensor([[ <span class="number">2.0000</span>,  <span class="number">4.7365</span>,  <span class="number">4.2215</span>],</span><br><span class="line">        [<span class="number">12.7793</span>, <span class="number">11.7283</span>, <span class="number">13.1722</span>]])</span><br><span class="line">tensor([[ <span class="number">2.0000</span>,  <span class="number">4.7365</span>,  <span class="number">4.2215</span>],</span><br><span class="line">        [<span class="number">10.0000</span>, <span class="number">10.0000</span>, <span class="number">10.0000</span>]])</span><br></pre></td></tr></table></figure></li>
<li><p><code>transpose</code> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 转置</span></span><br><span class="line">y = torch.randn(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line">z = y.transpose(<span class="number">1</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Switch to numpy <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># numpy 与 tensor 转换</span></span><br><span class="line">a = torch.ones(<span class="number">4</span>)</span><br><span class="line">b = a.numpy() <span class="comment"># tensor 转 numpy</span></span><br><span class="line">c = np.ones(<span class="number">5</span>)</span><br><span class="line">c = torch.from_numpy(c) <span class="comment"># numpy 转 tensor</span></span><br><span class="line">b[<span class="number">2</span>] = <span class="number">3</span> <span class="comment"># 浅拷贝，都会改变</span></span><br><span class="line"><span class="comment"># 所有CPU上的Tensor都支持转成numpy或从numpy转成Tensor</span></span><br></pre></td></tr></table></figure></p></li>
<li><p>Get values <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x.item() <span class="comment"># 将单元素的 tensor 转化为 Python 数值</span></span><br></pre></td></tr></table></figure></p></li>
</ul>
<h3 id="dimensional-operation">1.2.3 Dimensional operation</h3>
<ul>
<li><p>Truncate</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 截取</span></span><br><span class="line">print(x[:, <span class="number">1</span>])</span><br></pre></td></tr></table></figure></li>
<li><p>Concatenation: <code>cat</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.rand(<span class="number">4</span>, <span class="number">32</span>, <span class="number">8</span>)</span><br><span class="line">b = torch.rand(<span class="number">5</span>, <span class="number">32</span>, <span class="number">8</span>)</span><br><span class="line">c = torch.cat([a, b], dim=<span class="number">0</span>)</span><br><span class="line">print(c.shape)</span><br></pre></td></tr></table></figure>
<p>按第 <code>0</code> 维度进行拼接，除拼接之外的维度必须相同。Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">torch.Size([<span class="number">9</span>, <span class="number">32</span>, <span class="number">8</span>])</span><br></pre></td></tr></table></figure></li>
<li><p><code>stack</code></p>
<p>可以利用 <code>stack</code> 拼接，和 <code>cat</code> 命令不同，该命令会产生一个新的维度。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.rand(<span class="number">5</span>, <span class="number">32</span>, <span class="number">8</span>)</span><br><span class="line">b = torch.rand(<span class="number">5</span>, <span class="number">32</span>, <span class="number">8</span>)</span><br><span class="line">c = torch.stack([a, b], dim=<span class="number">0</span>)</span><br><span class="line">print(c.shape)</span><br></pre></td></tr></table></figure>
<p>产生一个新的维度，待拼接的向量维度相同。result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">torch.Size([<span class="number">2</span>, <span class="number">5</span>, <span class="number">32</span>, <span class="number">8</span>])</span><br></pre></td></tr></table></figure></li>
<li><p><code>split</code></p>
<p>按所制定的长度对张量进行拆分。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.rand(<span class="number">6</span>, <span class="number">32</span>, <span class="number">8</span>)</span><br><span class="line">b, c = a.split(<span class="number">3</span>, dim=<span class="number">0</span>)  <span class="comment"># 所给的是拆分后，每个向量的大小，指定拆分维度</span></span><br><span class="line">print(b.shape)</span><br><span class="line">print(c.shape)</span><br></pre></td></tr></table></figure>
<p><code>split</code> 所给的是拆分后，每个向量的大小，指定拆分维度。Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">torch.Size([<span class="number">3</span>, <span class="number">32</span>, <span class="number">8</span>])</span><br><span class="line">torch.Size([<span class="number">3</span>, <span class="number">32</span>, <span class="number">8</span>])</span><br></pre></td></tr></table></figure></li>
<li><p><code>chuck</code></p>
<p>按所给数量进行拆分。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = torch.rand(<span class="number">6</span>, <span class="number">32</span>, <span class="number">8</span>)</span><br><span class="line">b, c, d = a.chuck(<span class="number">3</span>, dim=<span class="number">0</span>)  <span class="comment"># 所给的是拆分的个数，即拆分成多少个小，指定拆分维度</span></span><br><span class="line">print(b.shape)</span><br><span class="line">print(c.shape)</span><br></pre></td></tr></table></figure>
<p>所给的是拆分的个数，即拆分成多少个。Result: <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">torch.Size([<span class="number">2</span>, <span class="number">32</span>, <span class="number">8</span>])</span><br><span class="line">torch.Size([<span class="number">2</span>, <span class="number">32</span>, <span class="number">8</span>])</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>reshape</code> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.randn(<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line">y = x.view(<span class="number">16</span>)</span><br><span class="line">z = x.view(-<span class="number">1</span>, <span class="number">8</span>)  <span class="comment"># the size -1 is inferred from other dimensions，自动计算</span></span><br><span class="line">print(x.size(), y.size(), z.size())</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="gpu-edition">1.3 GPU edition</h2>
<h3 id="basic-functions">1.3.1 Basic functions</h3>
<ul>
<li><p><code>is_available</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">torch.cuda.is_avaliable() <span class="comment"># 判断 CUDA 是否可用</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>device</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">device = torch.device(<span class="string">&#x27;cuda&#x27;</span>) <span class="comment"># 将 torch 对象放入 GPU 中</span></span><br></pre></td></tr></table></figure></li>
<li><p>Transfer tensor into CUDA</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.randn(<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line">y = torch.ones_like(x, device=device)</span><br><span class="line">x = x.to(device)  </span><br><span class="line"><span class="comment"># or just use strings ``.to(&quot;cuda&quot;)`</span></span><br><span class="line"></span><br><span class="line">z = x + y</span><br><span class="line">print(z)</span><br><span class="line">print(z.to(<span class="string">&quot;cpu&quot;</span>, torch.double))</span><br><span class="line"><span class="comment"># 先转到 cpu 中才能转numpy，因为 numpy 是在cpu上运行的</span></span><br></pre></td></tr></table></figure>
<p><code>to</code> can also change dtype together, such as <code>z.cuda()</code> or <code>z.to('cuda:0')</code>. Before turn into numpy, the data must be on cpu，becasue numpy run on cpu.</p></li>
<li><p>Full code</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">    device = torch.device(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line">  <span class="comment"># a CUDA device object</span></span><br><span class="line">    x = torch.randn(<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line">    y = torch.ones_like(x, device=device)  </span><br><span class="line">  <span class="comment"># directly create a tensor on GPU</span></span><br><span class="line">    x = x.to(device)                       </span><br><span class="line">  <span class="comment"># or just use strings ``.to(&quot;cuda&quot;)``</span></span><br><span class="line">    z = x + y</span><br><span class="line">    print(z)</span><br><span class="line">    print(z.to(<span class="string">&quot;cpu&quot;</span>, torch.double))       </span><br><span class="line">  <span class="comment"># ``.to`` can also change dtype together! such as z.cuda() or z.to(&#x27;cuda:0&#x27;)</span></span><br><span class="line"></span><br><span class="line">y.to(<span class="string">&#x27;cpu&#x27;</span>).data.numpy()</span><br><span class="line">y.cpu().data.numpy() <span class="comment"># 先转到 cpu 中才能转numpy，因为 numpy 是在cpu上运行的</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="gradient">1.4 Gradient</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line">x = torch.tensor(<span class="number">1.</span>, requires_grad = <span class="literal">True</span>)</span><br><span class="line">w = torch.tensor(<span class="number">2.</span>, requires_grad = <span class="literal">True</span>)</span><br><span class="line">b = torch.tensor(<span class="number">3.</span>, requires_grad = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">y = w*x + b</span><br><span class="line"></span><br><span class="line">y.backword(x.grad, w.grad, b.grad)</span><br></pre></td></tr></table></figure>
<ul>
<li>eg: Nural network</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line">dtype = torch.<span class="built_in">float</span></span><br><span class="line">device = torch.device(<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"><span class="comment"># device = torch.device(&quot;cuda:0&quot;) # Uncomment this to run on GPU</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># N is batch size; D_in is input dimension;</span></span><br><span class="line"><span class="comment"># H is hidden dimension; D_out is output dimension.</span></span><br><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create random input and output data</span></span><br><span class="line"><span class="comment"># 创建随机的Tensor来保存输入和输出</span></span><br><span class="line"><span class="comment"># 设定requires_grad=False表示在反向传播的时候我们不需要计算gradient</span></span><br><span class="line">x = torch.randn(N, D_in, device=device, dtype=dtype)</span><br><span class="line">y = torch.randn(N, D_out, device=device, dtype=dtype)</span><br><span class="line"><span class="comment"># print (x)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Randomly initialize weights</span></span><br><span class="line"><span class="comment"># 创建随机的Tensor和权重。</span></span><br><span class="line"><span class="comment"># 设置requires_grad=True表示我们希望反向传播的时候计算Tensor的gradient</span></span><br><span class="line">w1 = torch.randn(D_in, H, device=device, dtype=dtype, requires_grad = <span class="literal">True</span>)</span><br><span class="line">w2 = torch.randn(H, D_out, device=device, dtype=dtype, requires_grad = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">1e-6</span></span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">500</span>):</span><br><span class="line">    <span class="comment"># Forward pass: compute predicted y</span></span><br><span class="line">    <span class="comment"># 前向传播:通过Tensor预测y；这个和普通的神经网络的前向传播没有任何不同，</span></span><br><span class="line">    <span class="comment"># 但是我们不需要保存网络的中间运算结果，因为我们不需要手动计算反向传播。</span></span><br><span class="line">	pred = x.mm(w1).clamp(<span class="built_in">min</span> = <span class="number">0</span>).mm(w2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute loss</span></span><br><span class="line">    <span class="comment"># 通过前向传播计算loss</span></span><br><span class="line">    <span class="comment"># loss是一个形状为(1，)的Tensor</span></span><br><span class="line">    <span class="comment"># loss.item()可以给我们返回一个loss的scalar</span></span><br><span class="line">    loss = (y_pred - y).<span class="built_in">pow</span>(<span class="number">2</span>).<span class="built_in">sum</span>()</span><br><span class="line">    print(it, loss.item())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Backward pass</span></span><br><span class="line">    <span class="comment"># PyTorch给我们提供了autograd的方法做反向传播。如果一个Tensor的requires_grad=True，</span></span><br><span class="line">    <span class="comment"># backward会自动计算loss相对于每个Tensor的gradient。在backward之后，</span></span><br><span class="line">    <span class="comment"># w1.grad和w2.grad会包含两个loss相对于两个Tensor的gradient信息。</span></span><br><span class="line">    loss.backward()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># not remember gradient data</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="comment"># Update weights of w1 and w2</span></span><br><span class="line">        w1 -= learning_rate * w1.grad</span><br><span class="line">        w2 -= learning_rate * w2.grad</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Manually zero the gradients after updating weights</span></span><br><span class="line">        w1.grad.zero_()</span><br><span class="line">        w2.grad.zero_()</span><br></pre></td></tr></table></figure>
<h2 id="pytorch-methods">1.5 Pytorch methods</h2>
<h3 id="pytorch-nn">1.5.1 Pytorch: NN</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line">x = torch.randn(N, D_in)</span><br><span class="line">y = torch.randn(N, D_out)</span><br><span class="line"></span><br><span class="line">model = torch.nn.Sequential(</span><br><span class="line">    torch.nn.Linear(D_in, H), <span class="comment"># y = w_1 * x + b_1</span></span><br><span class="line">    torch.nn.ReLU(), <span class="comment"># a = max(0, h)</span></span><br><span class="line">    torch.nn.Linear(H, D_out), <span class="comment"># y_hat = w_2 * a + b_2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model = model.cuda()</span><br><span class="line"></span><br><span class="line">loss_fn = nn.MSELoss(reduction = <span class="string">&#x27;sum&#x27;</span>)</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">1e-4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    y_pred = model(x.cuda())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute loss</span></span><br><span class="line">    loss = loss_fn(y_pred.cuda(), y.cuda())</span><br><span class="line">    print(it, loss.cpu().item())</span><br><span class="line"></span><br><span class="line">    model.zero_grad()</span><br><span class="line"></span><br><span class="line">    loss.backward()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> model.parameters():</span><br><span class="line">            param -= learning_rate * param.grad</span><br></pre></td></tr></table></figure>
<h3 id="pytorch-optim">1.5.2 Pytorch: optim</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line">x = torch.randn(N, D_in)</span><br><span class="line">y = torch.randn(N, D_out)</span><br><span class="line"></span><br><span class="line">model = torch.nn.Sequential(</span><br><span class="line">    torch.nn.Linear(D_in, H), <span class="comment"># y = w_1 * x + b_1</span></span><br><span class="line">    torch.nn.ReLU(), <span class="comment"># a = max(0, h)</span></span><br><span class="line">    torch.nn.Linear(H, D_out), <span class="comment"># y_hat = w_2 * a + b_2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">model = model.cuda()</span><br><span class="line"></span><br><span class="line">loss_fn = nn.MSELoss(reduction = <span class="string">&#x27;sum&#x27;</span>)</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">1e-4</span></span><br><span class="line">optimizer = torch.optim.Adam(model.parameters(), lr = learning_rate)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    y_pred = model(x.cuda())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute loss</span></span><br><span class="line">    loss = loss_fn(y_pred.cuda(), y.cuda())</span><br><span class="line">    print(it, loss.cpu().item())</span><br><span class="line"></span><br><span class="line">    model.zero_grad()   </span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br></pre></td></tr></table></figure>
<h2 id="variable">1.6 Variable</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"></span><br><span class="line">tensor = torch.FloatTensor([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line">variable = Variable(tensor, requires_grad = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">t_out = torch.mean(tensor * tensor)</span><br><span class="line">v_out = torch.mean(variable * variable)</span><br><span class="line"></span><br><span class="line">v_out.backward()</span><br><span class="line"></span><br><span class="line">print(t_out, v_out, variable.grad, sep=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">variable_value = variable.data <span class="comment">#output tensor</span></span><br><span class="line">variable_numpy = variable.data.numpy()</span><br><span class="line"><span class="comment"># can&#x27;t finish above function with command: variable.numpy(), as variable isn&#x27;t tensor</span></span><br></pre></td></tr></table></figure>
<h1 id="nn">2 NN</h1>
<h2 id="快速实现神经网络">2.1 快速实现神经网络</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="comment"># method 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Net</span>(<span class="params">torch.nn.module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, n_feature, n_output</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Net, self).__init()</span><br><span class="line">        self.hidden = torch.nn.Linear(n_feature, n_hidden)</span><br><span class="line">        self.predict = torch.nn.Linear(n_hidden, n_output)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = F.relu(self.hiddec(x))</span><br><span class="line">        x = self.predic(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">net1 = Net(<span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># method 2</span></span><br><span class="line">net2 = torch.nn.Sequential(</span><br><span class="line">	torch.nn.Linear(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">	torch.nn.ReLU()</span><br><span class="line">	torch.nn.Linear(<span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">print(net1, net2, sep = <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Net (</span><br><span class="line">  (hidden): Linear (1 -&gt; 10)</span><br><span class="line">  (predict): Linear (10 -&gt; 1)</span><br><span class="line">)</span><br><span class="line">Sequential (</span><br><span class="line">  (0): Linear (1 -&gt; 10)</span><br><span class="line">  (<span class="number">1</span>): ReLU ()</span><br><span class="line">  (2): Linear (10 -&gt; 1)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="load-and-save-nn">2.2 load and save nn</h2>
<ul>
<li>Import modules</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">torch.manual_seed(<span class="number">1</span>)    <span class="comment"># reproducible</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Generate fake data</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = torch.unsqueeze(torch.linspace(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">100</span>), dim=<span class="number">1</span>)  </span><br><span class="line"><span class="comment"># 纵向挤压，x data (tensor), shape=(100, 1)</span></span><br><span class="line">y = x.<span class="built_in">pow</span>(<span class="number">2</span>) + <span class="number">0.2</span>*torch.rand(x.size())  </span><br><span class="line"><span class="comment"># noisy y data (tensor), shape=(100, 1)</span></span><br><span class="line">x, y = Variable(x, requires_grad=<span class="literal">False</span>), Variable(y, requires_grad=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Save net</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span>():</span></span><br><span class="line">    <span class="comment"># save net1</span></span><br><span class="line">    net1 = torch.nn.Sequential(</span><br><span class="line">        torch.nn.Linear(<span class="number">1</span>, <span class="number">10</span>),</span><br><span class="line">        torch.nn.ReLU(),</span><br><span class="line">        torch.nn.Linear(<span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line">    )</span><br><span class="line">    optimizer = torch.optim.SGD(net1.parameters(), lr=<span class="number">0.5</span>)</span><br><span class="line">    loss_func = torch.nn.MSELoss()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        prediction = net1(x)</span><br><span class="line">        loss = loss_func(prediction, y)</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># plot result</span></span><br><span class="line">    plt.figure(<span class="number">1</span>, figsize=(<span class="number">10</span>, <span class="number">3</span>))</span><br><span class="line">    plt.subplot(<span class="number">131</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Net1&#x27;</span>)</span><br><span class="line">    plt.scatter(x.data.numpy(), y.data.numpy())</span><br><span class="line">    plt.plot(x.data.numpy(), prediction.data.numpy(), <span class="string">&#x27;r-&#x27;</span>, lw=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2 ways to save the net</span></span><br><span class="line">    torch.save(net1, <span class="string">&#x27;net.pkl&#x27;</span>)  <span class="comment"># save entire net</span></span><br><span class="line">    torch.save(net1.state_dict(), <span class="string">&#x27;net_params.pkl&#x27;</span>)   <span class="comment"># save only the parameters</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Reload net</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restore_net</span>():</span></span><br><span class="line">    <span class="comment"># restore entire net1 to net2</span></span><br><span class="line">    net2 = torch.load(<span class="string">&#x27;net.pkl&#x27;</span>)</span><br><span class="line">    prediction = net2(x)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># plot result</span></span><br><span class="line">    plt.subplot(<span class="number">132</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Net2&#x27;</span>)</span><br><span class="line">    plt.scatter(x.data.numpy(), y.data.numpy())</span><br><span class="line">    plt.plot(x.data.numpy(), prediction.data.numpy(), <span class="string">&#x27;r-&#x27;</span>, lw=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Reload net parameters</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restore_params</span>():</span></span><br><span class="line">    <span class="comment"># restore only the parameters in net1 to net3</span></span><br><span class="line">    net3 = torch.nn.Sequential(</span><br><span class="line">        torch.nn.Linear(<span class="number">1</span>, <span class="number">10</span>),</span><br><span class="line">        torch.nn.ReLU(),</span><br><span class="line">        torch.nn.Linear(<span class="number">10</span>, <span class="number">1</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># copy net1&#x27;s parameters into net3</span></span><br><span class="line">    net3.load_state_dict(torch.load(<span class="string">&#x27;net_params.pkl&#x27;</span>))</span><br><span class="line">    prediction = net3(x)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># plot result</span></span><br><span class="line">    plt.subplot(<span class="number">133</span>)</span><br><span class="line">    plt.title(<span class="string">&#x27;Net3&#x27;</span>)</span><br><span class="line">    plt.scatter(x.data.numpy(), y.data.numpy())</span><br><span class="line">    plt.plot(x.data.numpy(), prediction.data.numpy(), <span class="string">&#x27;r-&#x27;</span>, lw=<span class="number">5</span>)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<ul>
<li>Test</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># save net1</span></span><br><span class="line">save()</span><br><span class="line"><span class="comment"># restore entire net (may slow)</span></span><br><span class="line">restore_net()</span><br><span class="line"><span class="comment"># restore only the net parameters</span></span><br><span class="line">restore_params()</span><br></pre></td></tr></table></figure>
<p>result<img src="https://z3.ax1x.com/2021/04/08/cJXH4H.md.png" /></p>
<center>
fig 1-1 save net
</center>
<h2 id="批训练">2.3 批训练</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> Data</span><br><span class="line"></span><br><span class="line">torch.manual_seed(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">BATCH_SIZE = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">x = torch.linspace(<span class="number">1</span>, <span class="number">10</span>, <span class="number">10</span>)       <span class="comment"># this is x data (torch tensor)</span></span><br><span class="line">y = torch.linspace(<span class="number">10</span>, <span class="number">1</span>, <span class="number">10</span>)       <span class="comment"># this is y data (torch tensor)</span></span><br><span class="line"></span><br><span class="line">torch_dataset = Data.TensorDataset(x, y)</span><br><span class="line">loader = Data.DataLoader(</span><br><span class="line">    dataset=torch_dataset,      <span class="comment"># torch TensorDataset format</span></span><br><span class="line">    batch_size=BATCH_SIZE,      <span class="comment"># mini batch size</span></span><br><span class="line">    shuffle=<span class="literal">True</span>,               <span class="comment"># 打乱数据次序</span></span><br><span class="line">    num_workers=<span class="number">2</span>,              <span class="comment"># subprocesses for loading data</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):   <span class="comment"># train entire dataset 3 times</span></span><br><span class="line">    <span class="keyword">for</span> step, (batch_x, batch_y) <span class="keyword">in</span> <span class="built_in">enumerate</span>(loader):  </span><br><span class="line">        <span class="comment"># train your data...</span></span><br><span class="line">        print(<span class="string">&#x27;Epoch: &#x27;</span>, epoch, <span class="string">&#x27;| Step: &#x27;</span>, step, <span class="string">&#x27;| batch x: &#x27;</span>,batch_x.numpy(), <span class="string">&#x27;| batch y: &#x27;</span>, batch_y.numpy())</span><br></pre></td></tr></table></figure>
<h2 id="optimizer">2.4 Optimizer</h2>
<h3 id="optimization-methods">2.4.1 Optimization methods:</h3>
<ul>
<li>Newton's method（牛顿法）</li>
<li>Least Squares method（最小二乘法）</li>
<li>Gradient Descent（梯度下降法：神经网络）</li>
</ul>
<h3 id="gradient-descent">2.4.2 Gradient Descent:</h3>
<ul>
<li>Cost Function（误差方程）:</li>
</ul>
<p><span class="math display">\[
\begin{align*}
Cost = (predicted - real)^2 &amp;= (Wx - y)^2 \\
&amp;=(W - o)^2
\end{align*}
\]</span></p>
<h3 id="code">2.4.3 Code</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> Data</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line">torch.manual_seed(<span class="number">1</span>)    <span class="comment"># reproducible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hyper parameters</span></span><br><span class="line">LR = <span class="number">0.01</span></span><br><span class="line">BATCH_SIZE = <span class="number">32</span></span><br><span class="line">EPOCH = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># generate datas</span></span><br><span class="line">x = torch.unsqueeze(torch.linspace(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1000</span>), dim=<span class="number">1</span>)</span><br><span class="line">y = x.<span class="built_in">pow</span>(<span class="number">2</span>) + <span class="number">0.1</span>*torch.normal(torch.zeros(*x.size()))</span><br><span class="line"><span class="comment"># unsqueeze: Returns a new tensor with a dimension of size one inserted at the specified position.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># plot dataset</span></span><br><span class="line">plt.scatter(x.numpy(), y.numpy())</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># batch training</span></span><br><span class="line">torch_dataset = Data.TensorDataset(x, y)</span><br><span class="line">loader = Data.DataLoader(</span><br><span class="line">    dataset=torch_dataset,</span><br><span class="line">    batch_size=BATCH_SIZE,</span><br><span class="line">    shuffle=<span class="literal">True</span>, num_workers=<span class="number">2</span>,)</span><br><span class="line"></span><br><span class="line"><span class="comment"># define neural network</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Net</span>(<span class="params">torch.nn.Module</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Net, self).__init__()</span><br><span class="line">        self.hidden = torch.nn.Linear(<span class="number">1</span>, <span class="number">20</span>)  </span><br><span class="line">        self.predict = torch.nn.Linear(<span class="number">20</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = F.relu(self.hidden(x)) <span class="comment"># activation function for hidden layer</span></span><br><span class="line">        x = self.predict(x) <span class="comment"># linear output</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="comment"># different optimizer</span></span><br><span class="line">net_SGD         = Net()</span><br><span class="line">net_Momentum    = Net()</span><br><span class="line">net_RMSprop     = Net()</span><br><span class="line">net_Adam        = Net()</span><br><span class="line">nets = [net_SGD, net_Momentum, net_RMSprop, net_Adam]</span><br><span class="line"></span><br><span class="line">opt_SGD         = torch.optim.SGD(net_SGD.parameters(), lr=LR)</span><br><span class="line">opt_Momentum    = torch.optim.SGD(net_Momentum.parameters(), lr=LR, momentum=<span class="number">0.8</span>)</span><br><span class="line">opt_RMSprop     = torch.optim.RMSprop(net_RMSprop.parameters(), lr=LR, alpha=<span class="number">0.9</span>)</span><br><span class="line">opt_Adam        = torch.optim.Adam(net_Adam.parameters(), lr=LR, betas=(<span class="number">0.9</span>, <span class="number">0.99</span>))</span><br><span class="line"></span><br><span class="line">optimizers = [opt_SGD, opt_Momentum, opt_RMSprop, opt_Adam]</span><br><span class="line"></span><br><span class="line"><span class="comment"># loss function</span></span><br><span class="line">loss_func = torch.nn.MSELoss()</span><br><span class="line">losses_his = [[], [], [], []]   <span class="comment"># record loss</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># training</span></span><br><span class="line"><span class="comment"># training</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(EPOCH):</span><br><span class="line">    print(<span class="string">&#x27;Epoch: &#x27;</span>, epoch)</span><br><span class="line">    <span class="keyword">for</span> step, (batch_x, batch_y) <span class="keyword">in</span> <span class="built_in">enumerate</span>(loader):          <span class="comment"># for each training step</span></span><br><span class="line">        b_x = Variable(batch_x)</span><br><span class="line">        b_y = Variable(batch_y)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> net, opt, l_his <span class="keyword">in</span> <span class="built_in">zip</span>(nets, optimizers, losses_his):</span><br><span class="line">            output = net(b_x)              <span class="comment"># get output for every net</span></span><br><span class="line">            loss = loss_func(output, b_y)  <span class="comment"># compute loss for every net</span></span><br><span class="line">            opt.zero_grad()                <span class="comment"># clear gradients for next train</span></span><br><span class="line">            loss.backward()                <span class="comment"># backpropagation, compute gradients</span></span><br><span class="line">            opt.step()                     <span class="comment"># apply gradients</span></span><br><span class="line">            l_his.append(loss.item())     <span class="comment"># loss recoder</span></span><br><span class="line"></span><br><span class="line">labels = [<span class="string">&#x27;SGD&#x27;</span>, <span class="string">&#x27;Momentum&#x27;</span>, <span class="string">&#x27;RMSprop&#x27;</span>, <span class="string">&#x27;Adam&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> i, l_his <span class="keyword">in</span> <span class="built_in">enumerate</span>(losses_his):</span><br><span class="line">    plt.plot(l_his, label=labels[i])</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Steps&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Loss&#x27;</span>)</span><br><span class="line">plt.ylim((<span class="number">0</span>, <span class="number">0.2</span>))</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>result:<img src="https://z3.ax1x.com/2021/04/08/cJX7Ue.md.png" /></p>
<center>
fig 1-2 Different optimizer
</center>
<h2 id="activation-function">2.5 Activation Function</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = torch.linspace(-<span class="number">5</span>, <span class="number">5</span>, <span class="number">200</span>)</span><br><span class="line">x = Variable(x)</span><br><span class="line">x_np = x.data.numpy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># four activation function</span></span><br><span class="line">y_relu = F.relu(x).data.numpy()</span><br><span class="line">y_sigmoid = torch.sigmoid(x).data.numpy()</span><br><span class="line">y_tanh = F.tanh(x).data.numpy()</span><br><span class="line">y_softplus = F.softplus(x).data.numpy()</span><br><span class="line"></span><br><span class="line">plt.figure(<span class="number">1</span>, figsize=(<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line">plt.subplot(<span class="number">221</span>)</span><br><span class="line">plt.plot(x_np, y_relu, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">1</span>, <span class="number">5</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">222</span>)</span><br><span class="line">plt.plot(x_np, y_sigmoid, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;sigmoid&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">0.2</span>, <span class="number">1.2</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">223</span>)</span><br><span class="line">plt.plot(x_np, y_tanh, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;tanh&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">1.2</span>, <span class="number">1.2</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">224</span>)</span><br><span class="line">plt.plot(x_np, y_softplus, c=<span class="string">&#x27;red&#x27;</span>, label=<span class="string">&#x27;softplus&#x27;</span>)</span><br><span class="line">plt.ylim((-<span class="number">0.2</span>, <span class="number">6</span>))</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<figure>
<img src="D:\Demo\Markdown\Pytorch.assets\activation%20function.png" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<center>
fig.4-1 four activation function
</center>
<p><span class="math inline">\(sigmoid\)</span> 激活函数： <span class="math display">\[
\sigma(x) = \frac{1}{1+e^{-x}}
\]</span> <span class="math inline">\(tanh\)</span> 激活函数： <span class="math display">\[
tanh(x) = 2 \sigma(2x) - 1
\]</span> <span class="math inline">\(ReLU\)</span> 激活函数： <span class="math display">\[
ReLU(x) = max(0, x)
\]</span></p>
<p><span class="math inline">\(Softmax\)</span> 激活函数： <span class="math display">\[
z_i \rightarrow \frac{e^{z_i}}{\sum_{j=1}^{k} e^{z_j}}
\]</span></p>
<h1 id="examples-for-nn">3 Examples for NN</h1>
<h2 id="numpy">3.1 Numpy</h2>
<p>一个全连接ReLU神经网络，一个隐藏层，没有bias。用来从x预测y，使用L2 Loss。</p>
<ul>
<li>$ h = W_1 X + b_1$</li>
<li>$ a = max(0, h)$</li>
<li>$ y_{hat} = W_2 a + b_2$</li>
<li>$ loss = (y_{hat} - y) ** 2$</li>
</ul>
<p>Goals: 把 1000 维的向量转化维 10 维的向量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># N is batch size; D_in is input dimension;</span></span><br><span class="line"><span class="comment"># H is hidden dimension; D_out is output dimension.</span></span><br><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create random input and output data</span></span><br><span class="line">x = np.random.randn(N, D_in)</span><br><span class="line">y = np.random.randn(N, D_out)</span><br><span class="line"><span class="comment"># print (x)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Randomly initialize weights</span></span><br><span class="line">w1 = np.random.randn(D_in, H)</span><br><span class="line">w2 = np.random.rand(H, D_out)</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">1e-6</span></span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    <span class="comment"># Forward pass: compute predicted y</span></span><br><span class="line">    h = x.dot(w1) <span class="comment"># 64 x 1000 array multiply 1000 x 100, hide layer turn 1000D data into 10D，N * H array</span></span><br><span class="line">    h_relu = np.maximum(h, <span class="number">0</span>) <span class="comment"># activate function，N * H</span></span><br><span class="line">    y_pred = h_relu.dot(w2) <span class="comment"># N * D_out</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute loss</span></span><br><span class="line">    <span class="comment"># loss = (y_pred - y) ** 2</span></span><br><span class="line">    loss = np.square(y_pred - y).<span class="built_in">sum</span>()</span><br><span class="line">    print(it, loss)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Backward pass</span></span><br><span class="line">    <span class="comment"># Backprop to compute gradients of w1 and w2 with respect to loss</span></span><br><span class="line">    <span class="comment"># Compute the gradient based on loss</span></span><br><span class="line">    grad_y_pred = <span class="number">2.0</span> * (y_pred - y)</span><br><span class="line">    grad_w2 = h_relu.T.dot(grad_y_pred) <span class="comment"># h _relu: N * H, grad_y_pred: N * D_out</span></span><br><span class="line">    grad_h_relu = grad_y_pred.dot(w2.T)</span><br><span class="line">    grad_h = grad_h_relu.copy()</span><br><span class="line">    grad_h[h&lt;<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    grad_w1 = x.T.dot(grad_h)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update weights of w1 and w2</span></span><br><span class="line">    w1 -= learning_rate * grad_w1</span><br><span class="line">    w2 -= learning_rate * grad_w2</span><br></pre></td></tr></table></figure>
<h2 id="torch">3.2 Torch</h2>
<ul>
<li>Modify according to above codes</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># N is batch size; D_in is input dimension;</span></span><br><span class="line"><span class="comment"># H is hidden dimension; D_out is output dimension.</span></span><br><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create random input and output data</span></span><br><span class="line">x = torch.randn(N, D_in)</span><br><span class="line">y = torch.randn(N, D_out)</span><br><span class="line"><span class="comment"># print (x)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Randomly initialize weights</span></span><br><span class="line">w1 = torch.randn(D_in, H)</span><br><span class="line">w2 = torch.rand(H, D_out)</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">1e-6</span></span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    <span class="comment"># Forward pass: compute predicted y</span></span><br><span class="line">    h = x.mm(w1) <span class="comment"># 64 x 1000 array multiply 1000 x 100, hide layer turn 1000D data into 10D，N * H array</span></span><br><span class="line">    h_relu = h.clamp(<span class="built_in">min</span> = <span class="number">0</span>) <span class="comment"># activate function，N * H</span></span><br><span class="line">    y_pred = h_relu.mm(w2) <span class="comment"># N * D_out</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute loss</span></span><br><span class="line">    <span class="comment"># loss = (y_pred - y) ** 2</span></span><br><span class="line">    loss = (y_pred - y).<span class="built_in">pow</span>(<span class="number">2</span>).<span class="built_in">sum</span>().item()</span><br><span class="line"><span class="comment"># tensor.item()： turn tensor into value</span></span><br><span class="line">    print(it, loss)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Backward pass</span></span><br><span class="line">    <span class="comment"># Backprop to compute gradients of w1 and w2 with respect to loss</span></span><br><span class="line">    <span class="comment"># Compute the gradient based on loss</span></span><br><span class="line">    grad_y_pred = <span class="number">2.0</span> * (y_pred - y)</span><br><span class="line">    grad_w2 = h_relu.t().mm(grad_y_pred) <span class="comment"># h _relu: N * H, grad_y_pred: N * D_out</span></span><br><span class="line">    grad_h_relu = grad_y_pred.mm(w2.T)</span><br><span class="line">    grad_h = grad_h_relu.clone()</span><br><span class="line">    grad_h[h&lt;<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    grad_w1 = x.t().mm(grad_h)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update weights of w1 and w2</span></span><br><span class="line">    w1 -= learning_rate * grad_w1</span><br><span class="line">    w2 -= learning_rate * grad_w2</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line">dtype = torch.<span class="built_in">float</span></span><br><span class="line">device = torch.device(<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"><span class="comment"># device = torch.device(&quot;cuda:0&quot;) # Uncomment this to run on GPU</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># N is batch size; D_in is input dimension;</span></span><br><span class="line"><span class="comment"># H is hidden dimension; D_out is output dimension.</span></span><br><span class="line">N, D_in, H, D_out = <span class="number">64</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create random input and output data</span></span><br><span class="line">x = torch.randn(N, D_in, device=device, dtype=dtype)</span><br><span class="line">y = torch.randn(N, D_out, device=device, dtype=dtype)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Randomly initialize weights</span></span><br><span class="line">w1 = torch.randn(D_in, H, device=device, dtype=dtype)</span><br><span class="line">w2 = torch.randn(H, D_out, device=device, dtype=dtype)</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">1e-6</span></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">500</span>):</span><br><span class="line">    <span class="comment"># Forward pass: compute predicted y</span></span><br><span class="line">    h = x.mm(w1)</span><br><span class="line">    h_relu = h.clamp(<span class="built_in">min</span>=<span class="number">0</span>)</span><br><span class="line">    y_pred = h_relu.mm(w2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute and print loss</span></span><br><span class="line">    loss = (y_pred - y).<span class="built_in">pow</span>(<span class="number">2</span>).<span class="built_in">sum</span>().item()</span><br><span class="line">    print(t, loss)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Backprop to compute gradients of w1 and w2 with respect to loss</span></span><br><span class="line">    grad_y_pred = <span class="number">2.0</span> * (y_pred - y)</span><br><span class="line">    grad_w2 = h_relu.t().mm(grad_y_pred)</span><br><span class="line">    grad_h_relu = grad_y_pred.mm(w2.t())</span><br><span class="line">    grad_h = grad_h_relu.clone()</span><br><span class="line">    grad_h[h &lt; <span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    grad_w1 = x.t().mm(grad_h)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update weights using gradient descent</span></span><br><span class="line">    w1 -= learning_rate * grad_w1</span><br><span class="line">    w2 -= learning_rate * grad_w2</span><br></pre></td></tr></table></figure>
<h2 id="fizz_buzz-demo">3.3 fizz_buzz demo</h2>
<p>FizzBuzz是一个简单的小游戏。游戏规则如下：从1开始往上数数，当遇到3的倍数的时候，说fizz，当遇到5的倍数，说buzz，当遇到15的倍数，就说fizzbuzz，其他情况下则正常数数。</p>
<p>可以写一个简单的小程序来决定要返回正常数值还是fizz, buzz 或者 fizzbuzz</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fizz_buzz_encode</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">15</span> == <span class="number">0</span>:        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> i % <span class="number">5</span> == <span class="number">0</span>:       <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> i % <span class="number">3</span>  == <span class="number">0</span>:      <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fizz_buzz_decode</span>(<span class="params">i, prediction</span>):</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">str</span>(i), <span class="string">&#x27;fizz&#x27;</span>, <span class="string">&#x27;buzz&#x27;</span>, <span class="string">&#x27;fizzbuzz&#x27;</span>][prediction]</span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in range(1, 15):</span></span><br><span class="line"><span class="comment">#     print(fizz_buzz_decode(i, fizz_buzz_encode(i)))</span></span><br></pre></td></tr></table></figure>
<p>定义模型的训练数据，并传入 GPU 中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hyper parameters</span></span><br><span class="line">NUM_DIGITS = <span class="number">10</span></span><br><span class="line">NUM_HIDDEN = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def binary_encode(i, num_digits):</span></span><br><span class="line"><span class="comment">#     return np.array([i &gt;&gt; d &amp; 1 for d in range(num_digits)])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_encode</span>(<span class="params">i, num_digits</span>):</span></span><br><span class="line">    binary = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bin</span>(i)[<span class="number">2</span>:]:</span><br><span class="line">        binary.append(<span class="built_in">int</span>(i))</span><br><span class="line">    size = <span class="built_in">len</span>(binary)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">0</span>] * (num_digits - size):</span><br><span class="line">        binary.insert(<span class="number">0</span>, <span class="built_in">int</span>(j))</span><br><span class="line">    <span class="keyword">return</span> np.array(binary)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trX = torch.Tensor([binary_encode(i, NUM_DIGITS)  for i in range(101, 2 ** NUM_DIGITS)])</span></span><br><span class="line"><span class="comment"># trY = torch.LongTensor([fizz_buzz_encode(i) for i in range(101, 2 ** NUM_DIGITS)])</span></span><br><span class="line"></span><br><span class="line">trX = torch.Tensor([binary_encode(i, NUM_DIGITS) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">101</span>, <span class="number">2</span> ** NUM_DIGITS)])</span><br><span class="line">trY = torch.LongTensor([fizz_buzz_encode(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">101</span>, <span class="number">2</span>**NUM_DIGITS)])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">    device = torch.device(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    device = torch.device(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">trX.to(device)</span><br><span class="line">trY.to(device)</span><br></pre></td></tr></table></figure>
<p>定义神经网络模型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model = torch.nn.Sequential(</span><br><span class="line">    torch.nn.Linear(NUM_DIGITS, NUM_HIDDEN),</span><br><span class="line">    torch.nn.ReLU(),</span><br><span class="line">    torch.nn.Linear(NUM_HIDDEN, <span class="number">4</span>)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<ul>
<li>为了让我们的模型学会FizzBuzz这个游戏，我们需要定义一个损失函数，和一个优化算法。</li>
<li>这个优化算法会不断优化（降低）损失函数，使得模型的在该任务上取得尽可能低的损失值。</li>
<li>损失值低往往表示我们的模型表现好，损失值高表示我们的模型表现差。</li>
<li>由于FizzBuzz游戏本质上是一个分类问题，我们选用Cross Entropyy Loss函数。</li>
<li>优化函数我们选用Stochastic Gradient Descent。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># loss function</span></span><br><span class="line">loss_fn = torch.nn.CrossEntropyLoss()</span><br><span class="line">optimizer = torch.optim.SGD(model.parameters(), lr = <span class="number">5e-2</span>)</span><br></pre></td></tr></table></figure>
<p>训练模型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">BATCH_SIZE = <span class="number">128</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">for</span> start <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(trX), BATCH_SIZE):</span><br><span class="line">        end = start + BATCH_SIZE</span><br><span class="line">        batchX = trX[start:end]</span><br><span class="line">        batchY = trY[start:end]</span><br><span class="line"></span><br><span class="line">        y_pred = model(batchX)</span><br><span class="line">        loss = loss_fn(y_pred, batchY)</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">    loss = loss_fn(model(trX), trY).item()</span><br><span class="line">    print(<span class="string">&#x27;Epoch:&#x27;</span>, epoch, <span class="string">&#x27;Loss:&#x27;</span>, loss, sep = <span class="string">&#x27;\t&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>最后用训练好的模型尝试在 1-100 中玩 FizzBuzz 邮箱</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">testX = torch.Tensor([binary_encode(i, NUM_DIGITS) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>)])</span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    testY = model(testX)</span><br><span class="line">predictions = <span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>), <span class="built_in">list</span>(testY.<span class="built_in">max</span>(<span class="number">1</span>)[<span class="number">1</span>].data.tolist()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ouptut prediction</span></span><br><span class="line">print([fizz_buzz_decode(i, x) <span class="keyword">for</span> (i, x) <span class="keyword">in</span> predictions])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Output False when prediction is imprecise</span></span><br><span class="line">print(np.<span class="built_in">sum</span>(testY.<span class="built_in">max</span>(<span class="number">1</span>)[<span class="number">1</span>].numpy() == np.array([fizz_buzz_encode(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>)])))</span><br></pre></td></tr></table></figure>
<h3 id="full-code">3.3.1 Full code</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fizz_buzz_encode</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">15</span> == <span class="number">0</span>:        <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">elif</span> i % <span class="number">5</span> == <span class="number">0</span>:       <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> i % <span class="number">3</span>  == <span class="number">0</span>:      <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fizz_buzz_decode</span>(<span class="params">i, prediction</span>):</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">str</span>(i), <span class="string">&#x27;fizz&#x27;</span>, <span class="string">&#x27;buzz&#x27;</span>, <span class="string">&#x27;fizzbuzz&#x27;</span>][prediction]</span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in range(1, 15):</span></span><br><span class="line"><span class="comment">#     print(fizz_buzz_decode(i, fizz_buzz_encode(i)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># hyper parameters</span></span><br><span class="line">NUM_DIGITS = <span class="number">10</span></span><br><span class="line">NUM_HIDDEN = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def binary_encode(i, num_digits):</span></span><br><span class="line"><span class="comment">#     return np.array([i &gt;&gt; d &amp; 1 for d in range(num_digits)])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_encode</span>(<span class="params">i, num_digits</span>):</span></span><br><span class="line">    binary = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">bin</span>(i)[<span class="number">2</span>:]:</span><br><span class="line">        binary.append(<span class="built_in">int</span>(i))</span><br><span class="line">    size = <span class="built_in">len</span>(binary)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">0</span>] * (num_digits - size):</span><br><span class="line">        binary.insert(<span class="number">0</span>, <span class="built_in">int</span>(j))</span><br><span class="line">    <span class="comment"># bin_array = np.array(binary) # array</span></span><br><span class="line">    <span class="keyword">return</span> np.array(binary)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trX = torch.Tensor([binary_encode(i, NUM_DIGITS)  for i in range(101, 2 ** NUM_DIGITS)])</span></span><br><span class="line"><span class="comment"># trY = torch.LongTensor([fizz_buzz_encode(i) for i in range(101, 2 ** NUM_DIGITS)])</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">    device = torch.device(<span class="string">&#x27;cuda&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    device = torch.device(<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line">trX = torch.Tensor([binary_encode(i, NUM_DIGITS) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">101</span>, <span class="number">2</span> ** NUM_DIGITS)])</span><br><span class="line">trY = torch.LongTensor([fizz_buzz_encode(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">101</span>, <span class="number">2</span>**NUM_DIGITS)])</span><br><span class="line">trX.to(device)</span><br><span class="line">trY.to(device)</span><br><span class="line"></span><br><span class="line">model = torch.nn.Sequential(</span><br><span class="line">    torch.nn.Linear(NUM_DIGITS, NUM_HIDDEN),</span><br><span class="line">    torch.nn.ReLU(),</span><br><span class="line">    torch.nn.Linear(NUM_HIDDEN, <span class="number">4</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># loss function</span></span><br><span class="line">loss_fn = torch.nn.CrossEntropyLoss()</span><br><span class="line">optimizer = torch.optim.SGD(model.parameters(), lr = <span class="number">5e-2</span>)</span><br><span class="line"></span><br><span class="line">BATCH_SIZE = <span class="number">128</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">for</span> start <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(trX), BATCH_SIZE):</span><br><span class="line">        end = start + BATCH_SIZE</span><br><span class="line">        batchX = trX[start:end]</span><br><span class="line">        batchY = trY[start:end]</span><br><span class="line"></span><br><span class="line">        y_pred = model(batchX)</span><br><span class="line">        loss = loss_fn(y_pred, batchY)</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">    loss = loss_fn(model(trX), trY).item()</span><br><span class="line">    print(<span class="string">&#x27;Epoch:&#x27;</span>, epoch, <span class="string">&#x27;Loss:&#x27;</span>, loss, sep = <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line"></span><br><span class="line">testX = torch.Tensor([binary_encode(i, NUM_DIGITS) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>)])</span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    testY = model(testX)</span><br><span class="line">predictions = <span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>), <span class="built_in">list</span>(testY.<span class="built_in">max</span>(<span class="number">1</span>)[<span class="number">1</span>].data.tolist()))</span><br><span class="line"></span><br><span class="line">print([fizz_buzz_decode(i, x) <span class="keyword">for</span> (i, x) <span class="keyword">in</span> predictions])</span><br><span class="line">print(np.<span class="built_in">sum</span>(testY.<span class="built_in">max</span>(<span class="number">1</span>)[<span class="number">1</span>].numpy() == np.array([fizz_buzz_encode(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">101</span>)])))</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Pytorch</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Deep learning</tag>
        <tag>Pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>Recommentation-Backend</title>
    <url>/2021/12/27/Recommentation-Backend/</url>
    <content><![CDATA[<p>本文属于新闻推荐实战—前后端基础及交互—前后端交互部分。在前两节，我们分别简单的介绍了与本项目相关的前后的基础知识，目的是为了让大家更加细致的了解整个系统的前后端交互细节，以及更全面的了解一个推荐系统所需的组成部分。本文将从前后端的交互逻辑出发，更加全面的为大家讲解系统的每个细节，了解一个简单的推荐系统内的内部组成。</p>
<a id="more"></a>
<h3 id="项目样式展现">项目样式展现</h3>
<p>下面主要展现的是项目的整体部分，主要分为推荐页，热门页以及新闻详情页。</p>
<p><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20211203154557244.png" alt="image-20211203154557244" style="zoom:70%;" /><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20211203155028564.png" alt="image-20211203155028564" style="zoom:70%;" /><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20211203155058020.png" alt="image-20211203155058020" style="zoom:70%;" /></p>
<h2 id="后端目录结构">后端目录结构</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">news_rec_sys&#x2F;</span><br><span class="line">    conf&#x2F;</span><br><span class="line">    	dao_config.py</span><br><span class="line">    controller&#x2F;  </span><br><span class="line">    dao&#x2F;</span><br><span class="line">    materials&#x2F;</span><br><span class="line">    	news_scrapy&#x2F;</span><br><span class="line">    	user_proccess&#x2F;</span><br><span class="line">    	material_proccess</span><br><span class="line">    recpocess&#x2F;</span><br><span class="line">    	recall&#x2F;</span><br><span class="line">    	rank&#x2F;</span><br><span class="line">    	online.py</span><br><span class="line">    	offline.py</span><br><span class="line">    scheduler&#x2F;</span><br><span class="line">    server.py</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>conf/dao_config.py: 候选整体配置文件</strong></li>
<li><strong>controller/ : 项目中用于操作数据库的接口</strong></li>
<li><strong>dao/ : 项目的实体类，对应数据库表</strong></li>
<li><strong>materials/: 项目的物料部分，主要用户爬取物料以及处理用户画像和新闻画像</strong></li>
<li><strong>recpocess/: 项目的推荐模块，主要包含召回和排序，以及一些线上服务和线下处理部分</strong></li>
<li>scheduler: 项目的定时任务的脚本部分，</li>
<li>server.py: 项目后端的入口部分，主要包含项目整体的后端接口部分。</li>
</ul>
<p>在该项目中，前端主要使用的是Vue框架+mint-ui，后端主要使用的是Flask+Mysql+Mongodb+Redis来完成的，并且前后端采用分离的额方式，通过json的数据格式进行数据传递。其中该项目后端的主要逻辑在在server.py中，其中主要包含用户注册，登录，推荐列表，热门列表，获取新闻详情页以及用户的行为等功能。接下来将主要按照这几部分详细的介绍一下前后端是如何进行交互。</p>
<h3 id="用户注册登录">1、用户注册登录</h3>
<p>为了能够对用户进行千人千面的推荐，因此需要每个使用该系统的人都需要明确先进行注册登入，为每个用户生成唯一的用户id，根据用户的历史行为，实现对用户进行个性化推荐的效果。</p>
<p>​ <strong>注册部分：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户注册&quot;&quot;&quot;</span></span><br><span class="line">    request_str = request.get_data()</span><br><span class="line">    request_dict = json.loads(request_str)</span><br><span class="line">    </span><br><span class="line">    user = RegisterUser()</span><br><span class="line">    user.username = request_dict[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">    user.passwd = request_dict[<span class="string">&quot;passwd&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询当前用户名是否已经被用过了</span></span><br><span class="line">    result = UserAction().user_is_exist(user, <span class="string">&quot;register&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> result != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;mgs&quot;</span>: <span class="string">&quot;this username is exists&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    user.userid = snowflake.client.get_guid() <span class="comment"># 雪花算法生成唯一的用户id</span></span><br><span class="line">    </span><br><span class="line">    user.age = request_dict[<span class="string">&quot;age&quot;</span>]</span><br><span class="line">    user.gender = request_dict[<span class="string">&quot;gender&quot;</span>]</span><br><span class="line">    user.city = request_dict[<span class="string">&quot;city&quot;</span>]</span><br><span class="line"></span><br><span class="line">    save_res = UserAction().save_user(user)   <span class="comment"># 将注册用户信息加入mysql</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> save_res:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;mgs&quot;</span>: <span class="string">&quot;register fail.&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">200</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;register success.&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>可以看到，上面的注册部分主要是记录一些用户的一些基础属性，并将用户的注册信息写入msyql表当中。值得注意的是，为了防止并发问题导致用户id出现冲负问题，因此这里采用了Twitter的雪花算法来为给每个用户生成一个唯一的id。</p>
<p>​ <strong>登录部分：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/recsys/login&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户登录</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    request_str = request.get_data()</span><br><span class="line">    request_dict = json.loads(request_str)</span><br><span class="line">    </span><br><span class="line">    user = RegisterUser()</span><br><span class="line">    user.username = request_dict[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">    user.passwd = request_dict[<span class="string">&quot;passwd&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询数据库中的用户名或者密码是否存在</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = UserAction().user_is_exist(user, <span class="string">&quot;login&quot;</span>)</span><br><span class="line">        <span class="comment"># print(result,&quot;login&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> result == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">200</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;login success&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">elif</span> result == <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># 密码错误</span></span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;passwd is error&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;this username is not exist!&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;mgs&quot;</span>: <span class="string">&quot;login fail.&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>用户登陆部分，前端通过将输入的账号密码通过POST请求传给 /recsys/login，通过UserAction().user_is_exist()方法查询数据库中的用户名或者密码是否存在，其中1表示账号密码正确，2表示密码错误，0表示用户不存在。</p>
<h3 id="推荐页列表">2、推荐页列表</h3>
<p>在项目样式展现的部分中，第一附图就是推荐页列表的样式，通过瀑布流的方式将新闻内容进行展现。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/recsys/rec_list&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rec_list</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;推荐页&quot;&quot;&quot;</span></span><br><span class="line">    user_name = request.args.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">    page_id = request.args.get(<span class="string">&#x27;page_id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询用户的id</span></span><br><span class="line">    user_id = UserAction().get_user_id_by_name(user_name)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user_id:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> user_id <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> page_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">2000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;user_id or page_id is none!&quot;</span>&#125;) </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 获取推荐列表新闻信息</span></span><br><span class="line">        rec_news_list = recsys_server.get_rec_list(user_id, page_id)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(rec_news_list) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;rec_list data is empty.&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">200</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;request rec_list success.&quot;</span>, <span class="string">&quot;data&quot;</span>: rec_news_list, <span class="string">&quot;user_id&quot;</span>: user_id&#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">500</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;redis fail.&quot;</span>&#125;) </span><br></pre></td></tr></table></figure>
<p>该部分的主要逻辑是前端通过请求 "/recsys/rec_list" 接口，后端通过前端传递过来的用户姓名，从数据库中获取用户id，再根据用户id去推荐服务(recsys_server)中获取到推荐列表。</p>
<h4 id="获取用户推荐列表">2.1、获取用户推荐列表</h4>
<p>我们知道用户的推荐列表是通过推荐服务的 get_rec_list(user_id, page_id) 接口获取到的。其中需要两个参数：</p>
<ul>
<li>user_id：通过用户id，我们可以去redis中查找已经给用户构建好的新闻列表，将新闻信息返回给前端。</li>
<li>page_id：通过page id定位到目前已经给用户推荐到列表的位置，然后在从该位置之后去新的新闻内容。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rec_list</span>(<span class="params">self, user_id, page_id</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;给定页面的展示范围进行展示  user_id 后面做个性化推荐的时候需要用到&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 根据page id计算需要获取redis中哪些范围的news_id, 假设每一页展示10个新闻</span></span><br><span class="line">    s = (<span class="built_in">int</span>(page_id) - <span class="number">1</span>) * <span class="number">10</span></span><br><span class="line">    e = s + <span class="number">9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回的是一个news_id列表</span></span><br><span class="line">    news_id_list = self.reclist_redis_db.zrange(<span class="string">&quot;rec_list&quot;</span>, start=s, end=e) </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据news_id获取新闻的具体内容，并返回一个列表，列表中的元素是按照顺序展示的新闻信息字典</span></span><br><span class="line">    news_info_list = []</span><br><span class="line">    news_expose_list = []</span><br><span class="line">    <span class="keyword">for</span> news_id <span class="keyword">in</span> news_id_list:</span><br><span class="line">        news_info_dict = self._get_news_simple(news_id)</span><br><span class="line">        news_info_list.append(news_info_dict)</span><br><span class="line">        news_expose_list.append(news_info_dict[<span class="string">&quot;news_id&quot;</span>])  <span class="comment"># 记录在用户曝光表上[user_exposure]</span></span><br><span class="line"></span><br><span class="line">    self._save_user_exposure(user_id,news_expose_list)  <span class="comment"># 曝光落表</span></span><br><span class="line">    <span class="keyword">return</span> news_info_list</span><br></pre></td></tr></table></figure>
<p>这里的逻辑，主要是先根据page id，计算从redis中推荐列表取的范围。在得到新闻id列表之后，通过_get_news_simple() 方法从mysql何redis中获取新闻列表所需的展现内容。</p>
<p>为了提高用户体验，这里考虑将已经在推荐列表中给用户曝光过的新闻，当天内不会再通过热门页对用户进行曝光。因此这里需要利用_save_user_exposure()方法来将已经曝光过的新闻存储到redis中，这样在热门推荐中，针对用户的曝光会对热门推荐的内容进行过滤。</p>
<p>返回的数据格式如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;data&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;news_id&quot;</span>: <span class="string">&quot;4bfb8aab-bcd8-4c74-b7fd-92b28ca5df69&quot;</span>, </span><br><span class="line">      <span class="attr">&quot;cate&quot;</span>: <span class="string">&quot;国内&quot;</span>, </span><br><span class="line">      <span class="attr">&quot;read_num&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;likes&quot;</span>: <span class="number">0</span>, </span><br><span class="line">      <span class="attr">&quot;collections&quot;</span>: <span class="number">0</span>, </span><br><span class="line">      <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2021-11-30 12:07&quot;</span>, </span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;北京市政协十三届五次会议将于2022年1月5日召开&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">        ...</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;news_id&quot;</span>: <span class="string">&quot;4ded60ac-aa2f-408b-af4d-09ca0c58b50a&quot;</span>, </span><br><span class="line">      <span class="attr">&quot;cate&quot;</span>: <span class="string">&quot;国内&quot;</span>, </span><br><span class="line">      <span class="attr">&quot;read_num&quot;</span>: <span class="number">6</span>, </span><br><span class="line">      <span class="attr">&quot;likes&quot;</span>: <span class="number">1</span>, </span><br><span class="line">      <span class="attr">&quot;collections&quot;</span>: <span class="number">0</span>, </span><br><span class="line">      <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2021-11-30 10:44&quot;</span>, </span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;江西万载县委原书记胡全顺获刑十一年六个月&quot;</span></span><br><span class="line">    &#125;]</span><br></pre></td></tr></table></figure>
<h3 id="热门推荐页">3、热门推荐页</h3>
<p>热门推荐页部分，前端通过请求'/recsys/hot_list'接口，通过传递用户姓名和当前页号来获取热门新闻列表。主要的逻辑和获取推荐页相同，区别在于热门新闻信息主要是通过推荐服务(recsys_server)中的get_hot_list()方法来获取到热门新闻推荐列表。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/recsys/hot_list&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hot_list</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;热门页面&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        user_name = request.args.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">        page_id = request.args.get(<span class="string">&#x27;page_id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user_name <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> page_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">2000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;user_name or page_id is none!&quot;</span>&#125;) </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 查询用户的id</span></span><br><span class="line">        user_id = UserAction().get_user_id_by_name(user_name)  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_id:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># # 获取热门列表新闻信息</span></span><br><span class="line">        rec_news_list = recsys_server.get_hot_list(user_id) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(rec_news_list) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">200</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;request redis data fail.&quot;</span>&#125;)</span><br><span class="line">        <span class="comment"># rec_news_list = recsys_server.get_hot_list(user_id, page_id)</span></span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">200</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;request hot_list success.&quot;</span>, <span class="string">&quot;data&quot;</span>: rec_news_list, <span class="string">&quot;user_id&quot;</span>: user_id&#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">2000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;request hot_list fail.&quot;</span>&#125;) </span><br></pre></td></tr></table></figure>
<p>可以看到这里其实在后端逻辑上和推荐列表部分相似，主要在于get_hot_list()和get_rec_list()的区别；而热门推荐部分内在的细节内容，将会在后面详细介绍，这里不再赘述。</p>
<h3 id="新闻详情页">4、 新闻详情页</h3>
<p>在项目样式展现的部分中，第三附图就是新闻详情页的样式。该部分主要包含一些新闻的详细信息，其中还有两个按钮，用于收集用户的显性反馈，用户可以根据自己对该文章的喜好程度进行喜欢和收藏的反馈内容。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/recsys/news_detail&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">news_detail</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;一篇文章的详细信息&quot;&quot;&quot;</span></span><br><span class="line">    user_name = request.args.get(<span class="string">&#x27;user_name&#x27;</span>)</span><br><span class="line">    news_id = request.args.get(<span class="string">&#x27;news_id&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    user_id = UserAction().get_user_id_by_name(user_name)  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># if news_id is None or user_id is None:</span></span><br><span class="line">    <span class="keyword">if</span> news_id <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> user_name <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">2000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;news_id is none or user_name is none!&quot;</span>&#125;) </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        news_detail = recsys_server.get_news_detail(news_id)</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> UserAction().get_likes_counts_by_user(user_id,news_id) &gt; <span class="number">0</span>:</span><br><span class="line">            news_detail[<span class="string">&quot;likes&quot;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            news_detail[<span class="string">&quot;likes&quot;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> UserAction().get_coll_counts_by_user(user_id,news_id) &gt; <span class="number">0</span>:</span><br><span class="line">            news_detail[<span class="string">&quot;collections&quot;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            news_detail[<span class="string">&quot;collections&quot;</span>] = <span class="literal">False</span></span><br><span class="line">        <span class="comment"># print(&quot;test&quot;,news_detail)</span></span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">0</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;request news_detail success.&quot;</span>, <span class="string">&quot;data&quot;</span>: news_detail&#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">2000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;error&quot;</span>&#125;) </span><br></pre></td></tr></table></figure>
<p>上面就是详情页的后端逻辑，通过用户名字从mysql中获取用户id信息。防止用户id或者 page id出现空值的情况，需要进行判断。紧接着通过recsys_server服务的get_news_detail()方法，根据新闻的id进行获取内容。</p>
<p>如果用户对该新闻之前点击过喜欢或收藏，再次点击该新闻应该在喜欢或收藏按钮应该是点亮状态，因此还需要根据mysql中再次查询用户与该新闻是否存在记录，并将结果返回给前端，将其进行点亮展示。这里采用两个字段likes和collections，通过True，False来判断用户对该文章之前是否点击过喜欢或收藏。</p>
<p>返回的数据格式如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;code&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">  	<span class="attr">&quot;news_id&quot;</span>: <span class="string">&quot;4ded60ac-aa2f-408b-af4d-09ca0c58b50a&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;cate&quot;</span>: <span class="string">&quot;军事&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;运-20加油机首次现身台海上空 堪称“战力倍增器”&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;content&quot;</span>: <span class="string">&quot;原标题：视频丨运-20加油机首次现身台海上空，堪称“战力倍增器”据台湾“中央社”报道，台防务部门晚间发布最新动态，11月28日白天解放军空军有27架次多型战机出现在了台湾所谓“西南空域”。首度被台媒披露现身台海的运油-20，是以国产运-20大型远程运输机为平台改装的空中加油机。据媒体测算，运油-20加油机装载燃油超过100吨，能大幅提升战机的空中续航能力，堪称“战力倍增器”。&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;collections&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="attr">&quot;read_num&quot;</span>: <span class="number">6</span>, </span><br><span class="line">    <span class="attr">&quot;likes&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="attr">&quot;ctime&quot;</span>: <span class="string">&quot;2021-11-30 10:44&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://news.sina.com.cn/c/2021-11-30/doc-ikyakumx1093113.shtml&quot;</span></span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;request news_detail success.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="用户的行为">5、用户的行为</h3>
<p>在该系统中，用户在看新闻时主要会留下三种用户行为：一是阅读，即用户在点击一篇新闻的详细页时，用户产生的行为；二是喜欢，在新闻详情页下面会存在喜欢按钮，用户可以通过点击按钮触发系统记录该行为；三是收藏，和喜欢行为同理，需要通过用户主动的方式来触发。</p>
<p>因此在用户点进一篇新闻的详情页时候，前端会发送一个请求，并给后端传递一个json格式数据：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;user_name&quot;</span>:<span class="string">&quot;wang&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;news_id&quot;</span>:<span class="string">&quot;0a745412-db48-4e37-bf13-9a5b56028f7e&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;action_time&quot;</span>:<span class="number">1638532127190</span>,</span><br><span class="line">	<span class="attr">&quot;action_type&quot;</span>:<span class="string">&quot;read&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在点击喜欢或收藏按钮的时候同样会产生一个请求，并发送json数据：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//点击喜欢</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;user_name&quot;</span>:<span class="string">&quot;wang&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;news_id&quot;</span>:<span class="string">&quot;0a745412-db48-4e37-bf13-9a5b56028f7e&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;action_time&quot;</span>:<span class="number">1638532127190</span>,</span><br><span class="line">	<span class="attr">&quot;action_type&quot;</span>:<span class="string">&quot;like:ture&quot;</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//点击收藏</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;user_name&quot;</span>:<span class="string">&quot;wang&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;news_id&quot;</span>:<span class="string">&quot;0a745412-db48-4e37-bf13-9a5b56028f7e&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;action_time&quot;</span>:<span class="number">1638532127190</span>,</span><br><span class="line">	<span class="attr">&quot;action_type&quot;</span>:<span class="string">&quot;collections:true&quot;</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过前端的传递的数据，后端对应的接口可以通过传递的参数对用户行为进行记录：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/recsys/action&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">actions</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户的行为：阅读，点赞，收藏&quot;&quot;&quot;</span></span><br><span class="line">    request_str = request.get_data()</span><br><span class="line">    request_dict = json.loads(request_str)</span><br><span class="line">    </span><br><span class="line">    username = request_dict.get(<span class="string">&#x27;user_name&#x27;</span>)</span><br><span class="line">    newsid = request_dict.get(<span class="string">&#x27;news_id&#x27;</span>)</span><br><span class="line">    actiontype = request_dict.get(<span class="string">&quot;action_type&quot;</span>)</span><br><span class="line">    actiontime = request_dict.get(<span class="string">&quot;action_time&quot;</span>)</span><br><span class="line"></span><br><span class="line">    userid = UserAction().get_user_id_by_name(username)   <span class="comment"># 获取用户 id</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> userid:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">2000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;user not register&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    action_type_list = actiontype.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(action_type_list) == <span class="number">2</span>:</span><br><span class="line">        _action_type = action_type_list[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> action_type_list[<span class="number">1</span>] == <span class="string">&quot;false&quot;</span>: <span class="comment"># 如果这个参数为false的话, 表示数据库中存在记录  需要删除数据 </span></span><br><span class="line">            <span class="keyword">if</span> _action_type==<span class="string">&quot;likes&quot;</span>: </span><br><span class="line">                UserAction().del_likes_by_user(userid,newsid)    <span class="comment"># 删除用户喜欢记录</span></span><br><span class="line">            <span class="keyword">elif</span> _action_type==<span class="string">&quot;collections&quot;</span>:</span><br><span class="line">                UserAction().del_coll_by_user(userid,newsid)     <span class="comment"># 删除用户收藏记录 </span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">if</span> _action_type==<span class="string">&quot;likes&quot;</span>:  <span class="comment"># 如果这个参数为true的话, 表示数据库中不存在记录  需要添加数据 </span></span><br><span class="line">                userlikes = UserLikes()</span><br><span class="line">                userlikes.new(userid,username,newsid)</span><br><span class="line">                UserAction().save_one_action(userlikes)       <span class="comment"># 记录用户喜欢记录</span></span><br><span class="line">            <span class="keyword">elif</span> _action_type==<span class="string">&quot;collections&quot;</span>:</span><br><span class="line">                usercollections = UserCollections()</span><br><span class="line">                usercollections.new(userid,username,newsid)</span><br><span class="line">                UserAction().save_one_action(usercollections)   <span class="comment"># 记录用户收藏记录 </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 落日志</span></span><br><span class="line">        logitem = LogItem()</span><br><span class="line">        logitem.new(userid,newsid,action_type_list[<span class="number">0</span>])</span><br><span class="line">        LogController().save_one_log(logitem)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新redis中的展示数据   新闻侧</span></span><br><span class="line">        recsys_server.update_news_dynamic_info(news_id=newsid,action_type=action_type_list)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">200</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;action success&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;code&quot;</span>: <span class="number">2000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;action error&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>上述代码中主要存在三部分内容：</p>
<p><strong>用户行为记录：</strong></p>
<p>在前端传递过来的数据中存在一个字段 "action_type":"like:ture" 或 "action_type":"like:false"（收藏行为类似），对于action_type参数，其值会是一个组合字符串，冒号前面表示用户的具体行为，冒号后面表示用户当前的行为是点击喜欢还是取消喜欢（例如用户误触导致，用户再次点击则会取消）。</p>
<p>通过<strong>true</strong>和<strong>false</strong>我们不仅可以知道当前用户是点击还是取消，其实还可以知道在数据库中是否存在该用户对该新闻的行为记录。原因是当传递来的是<strong>false</strong>时，表明<strong>like</strong>的状态是从<strong>true</strong>变为<strong>false</strong>，因此数据库中肯定会存在该记录，如果是<strong>true</strong>，表明like的状态是从<strong>false</strong>变为<strong>true</strong>，表明此时数据库中不存在该用户对该新闻的行为记录。通过这样的方式，我们可以比较简单的对数据库进行操作，记录用户的行为。</p>
<p><strong>用户行为落日志：</strong></p>
<p>在企业中，任何系统都会有日志的存在，其中最主要的作用是，日志相当于一个监控器，可以随时监测系统是否出现故障，通过日志可以及时定位系统中可能存在的问题。但是我们说的日志还有所区别，我们这里所说的日志主要是记录的一些线上信息，通过日志的方式进行记录，类似于我们这个系统，用户线上存在的行为，对于我们来说是十分具有意义的，我们需要通过分析这样的用户行为来更好的了解用户兴趣，从而进行更加个性化的推荐。因此我们可以借助日志的方式来记录有意义的用户数据，通过日志数据去分析数据，构建模型，这对于一个算法工程师来说是十分重要的内容。</p>
<p>当然在我们这个新闻推荐系统中，我们这么做的原因有一下几点：</p>
<ul>
<li>通过这样的方式让大家体会到日志的意义，我们可以直接通过日志获取一些线上有意义的用户数据。</li>
<li>通过日志数据，可以帮助我们更新用户画像中的一些动态特征。</li>
<li>在后面构建模型时，我们也能获取到用户的一些点击率，收藏率的建模，为后面的工作提供数据基础。</li>
</ul>
<p>上诉代码中，我们通过 LogController() 的 save_one_log() 方法对数据进行了存储到了mysql中。</p>
<p><strong>新闻动态数据更新</strong></p>
<p>由于我们在展现时会显示该新闻的阅读人数、喜欢人数和收藏人数，因此用户的行为实际上会改变新闻这三个属性。因此我们需要更新redis中新闻的这些动态的数据。</p>
<p>主要是通过推荐服务里面的 update_news_dynamic_info()方法进行更新。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_news_dynamic_info</span>(<span class="params">self, news_id,action_type</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;更新新闻展示的详细信息&quot;&quot;&quot;</span></span><br><span class="line">    news_dynamic_info_str = self.dynamic_news_info_redis_db.get(<span class="string">&quot;dynamic_news_detail:&quot;</span> + news_id)</span><br><span class="line">    news_dynamic_info_str = news_dynamic_info_str.replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span> ) <span class="comment"># 将单引号都替换成双引号</span></span><br><span class="line">    news_dynamic_info_dict = json.loads(news_dynamic_info_str)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(action_type) == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> action_type[<span class="number">1</span>] == <span class="string">&quot;true&quot;</span>:</span><br><span class="line">            news_dynamic_info_dict[action_type[<span class="number">0</span>]] +=<span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> action_type[<span class="number">1</span>] == <span class="string">&quot;false&quot;</span>:</span><br><span class="line">            news_dynamic_info_dict[action_type[<span class="number">0</span>]] -=<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        news_dynamic_info_dict[<span class="string">&quot;read_num&quot;</span>] +=<span class="number">1</span></span><br><span class="line"> </span><br><span class="line">    news_dynamic_info_str = json.dumps(news_dynamic_info_dict)</span><br><span class="line"> </span><br><span class="line">    news_dynamic_info_str = news_dynamic_info_str.replace(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&quot;&#x27;&quot;</span> )</span><br><span class="line">    res = self.dynamic_news_info_redis_db.<span class="built_in">set</span>(<span class="string">&quot;dynamic_news_detail:&quot;</span> + news_id, news_dynamic_info_str)</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>
<p>上述代码主要是新闻动态特征更新的部分，主要是获取redis中的信息，根据前端传递过来的行为来更新对用新闻属性的值。更改完之后，从新将新的结果从新存储到redis中。</p>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Recommentation</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Recommentation</tag>
      </tags>
  </entry>
  <entry>
    <title>Recommentation-Construct</title>
    <url>/2021/12/30/Recommentation-Construct/</url>
    <content><![CDATA[<p><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片Untitled.png" /></p>
<p>本篇文章主要是讲解推荐系统流程构建，主要包括Offline和Online两个部分。</p>
<h1 id="offline">Offline</h1>
<p>offline部分主要是基于前面存储好的物料画像和用户画像进行离线计算， 为每个用户提供一个热门页列表和推荐页列表并进行缓存， 方便online服务的列表获取。 所以下面主要帮大家梳理这两个列表的生成以及缓存到redis的流程。</p>
<a id="more"></a>
<h2 id="热门页列表">热门页列表</h2>
<p>当用户进入系统， 点击热门按钮时， online服务就会为当前用户获取热门页列表， 而这个列表是在用户登录进入的时候， 离线部分事先为用户生成好缓存到了redis中。online服务获取，只需要从redis中拉取即可。</p>
<p>所谓热门页， 就是对于每篇文章，会根据它的发布时间，用户对它的行为记录(获得的点赞数，收藏数和阅读数)去计算该文章的热度信息， 然后根据热度值进行排序得到， 所以计算文章的热门记录， 只需要文章画像的动静态信息即可，天级更新， 逻辑如下:</p>
<p>每天凌晨物料处理完，会得到每篇文章的发布时间(静态特征)以及每篇文章目前为止累计的获赞数，被收藏数和被阅读数(动态特征)，这时候，我们就可以遍历物料池中的每篇文章， 拿到文章的发布时间，与当前时间作差得到文章的时效性，然后根据时效性过滤掉发布太久的文章，然后再结合文章的动态特征，基于热度公式，就能计算文章的热度值。每篇文章都有一个热度值，根据热度值排序，就可以得到文章热门列表，把该列表以zset的形式缓存到redis，之所以zset，是因为可以帮助我们根据hot value自动排好序。 这是一份公共的热门列表，这个可以作为每个用户热门列表的初始化状态。</p>
<p>由于每个用户的喜好兴趣不同，对于同一个热门页，点击的文章可能会有所不同，而我们给用户曝光的时候，往往是会先过滤掉对用户曝光过的内容，所以为了每个用户的个性化曝光，当用户登录的时候，我们会给每个用户单独生成一个热门页列表， 初始化状态就是上面的公共列表。之后，用户再去点击热门的时候，就从自己的热门页列表中获取文章了，当然这块是online服务， 我们放后面详细说。</p>
<p>所以，离线热门页列表生成过程总结起来，就是每天遍历物料池， 对于每篇文章，基于动态信息和静态特征计算热度值，并进行热度值排序，生成公共热门模板，作为每个用户单独热门列表的初始。代码如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hot_rec_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取物料的点赞，收藏和创建时间等信息，计算热度并生成热度推荐列表存入redis</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 遍历物料池里面的所有文章</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.feature_protrail_collection.find():</span><br><span class="line">            news_id = item[<span class="string">&#x27;news_id&#x27;</span>]</span><br><span class="line">            news_cate = item[<span class="string">&#x27;cate&#x27;</span>]</span><br><span class="line">            news_ctime = item[<span class="string">&#x27;ctime&#x27;</span>]</span><br><span class="line">            news_likes_num = item[<span class="string">&#x27;likes&#x27;</span>]</span><br><span class="line">            news_collections_num = item[<span class="string">&#x27;collections&#x27;</span>]</span><br><span class="line">            news_read_num = item[<span class="string">&#x27;read_num&#x27;</span>]</span><br><span class="line">            news_hot_value = item[<span class="string">&#x27;hot_value&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment">#print(news_id, news_cate, news_ctime, news_likes_num, news_collections_num, news_read_num, news_hot_value)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 时间转换与计算时间差   前提要保证当前时间大于新闻创建时间，目前没有捕捉异常</span></span><br><span class="line">            news_ctime_standard = datetime.strptime(news_ctime, <span class="string">&quot;%Y-%m-%d %H:%M&quot;</span>)</span><br><span class="line">            cur_time_standard = datetime.now()</span><br><span class="line">            time_day_diff = (cur_time_standard - news_ctime_standard).days</span><br><span class="line">            time_hour_diff = (cur_time_standard - news_ctime_standard).seconds / <span class="number">3600</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 只要最近3天的内容</span></span><br><span class="line">            <span class="keyword">if</span> time_day_diff &gt; <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 计算热度分，这里使用魔方秀热度公式， 可以进行调整, read_num 上一次的 hot_value  上一次的hot_value用加？  因为like_num这些也都是累加上来的， 所以这里计算的并不是增值，而是实时热度吧</span></span><br><span class="line">            <span class="comment"># news_hot_value = (news_likes_num * 6 + news_collections_num * 3 + news_read_num * 1) * 10 / (time_hour_diff+1)**1.2</span></span><br><span class="line">            <span class="comment"># 72 表示的是3天，</span></span><br><span class="line">            news_hot_value = (news_likes_num * <span class="number">0.6</span> + news_collections_num * <span class="number">0.3</span> + news_read_num * <span class="number">0.1</span>) * <span class="number">10</span> / (<span class="number">1</span> + time_hour_diff / <span class="number">72</span>) </span><br><span class="line"></span><br><span class="line">            <span class="comment">#print(news_likes_num, news_collections_num, time_hour_diff)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 更新物料池的文章hot_value</span></span><br><span class="line">            item[<span class="string">&#x27;hot_value&#x27;</span>] = news_hot_value</span><br><span class="line">            self.feature_protrail_collection.update(&#123;<span class="string">&#x27;news_id&#x27;</span>:news_id&#125;, item)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#print(&quot;news_hot_value: &quot;, news_hot_value)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保存到redis中</span></span><br><span class="line">            self.reclist_redis.zadd(<span class="string">&#x27;hot_list&#x27;</span>, &#123;<span class="string">&#x27;&#123;&#125;_&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(news_cate, news_id): news_hot_value&#125;, nx=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h3 id="推荐页列表">推荐页列表</h3>
<p>当用户进入系统， 映入眼帘的就是推荐页， online服务会给当前用户获取推荐页列表， 这个列表同样是用户进入的时候，离线事先生成缓存到redis中。</p>
<p>推荐页，也正是我们推荐系统发挥效用的部分，对于每个用户，我们会生成不同的推荐页面，这就是我们所知悉的"千人千面"，如何做到这一点？ 就需要借助已经存好的用户画像和物品画像，制作特征，然后通过模型预测排序，做到所谓的个性化。 当然，对于一个新来的用户，由于我们事先没有存储好用户画像，这就意味着可能没法走个性化推荐流程，这里我们当做冷启动处理。所以这块分成了冷启动和个性化推荐两块进行梳理，逻辑如下:</p>
<ul>
<li><p>冷启动: 冷启动主要是针对新用户，我们没有太详细的用户画像信息，所以只能通过一些粗略的信息，比如年龄，性别(用户注册时会获取到)等，获取到一些大类别下的文章(适合该年龄，该性别看的文章)，然后再根据文章的热度信息，给新用户生成一份冷启动推荐列表。 当然这里只是说了一种简单的方式，冷启动其实也是一种比较复杂的场景，感兴趣同学可以查阅一些其他资料，也欢迎和我们讨论。这里是根据用户的年龄和性别自定义分成了四类人群</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_cold_start_news_list_to_redis_for_register_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;给已经注册的用户制作冷启动新闻列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> user_info <span class="keyword">in</span> self.register_user_sess.query(RegisterUser).<span class="built_in">all</span>():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">int</span>(user_info.age) &lt; <span class="number">23</span> <span class="keyword">and</span> user_info.gender == <span class="string">&quot;female&quot;</span>:</span><br><span class="line">                redis_key = <span class="string">&quot;cold_start_group:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">                self.copy_redis_sorted_set(user_info.userid, redis_key)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">int</span>(user_info.age) &gt;= <span class="number">23</span> <span class="keyword">and</span> user_info.gender == <span class="string">&quot;female&quot;</span>:</span><br><span class="line">                redis_key = <span class="string">&quot;cold_start_group:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">                self.copy_redis_sorted_set(user_info.userid, redis_key)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">int</span>(user_info.age) &lt; <span class="number">23</span> <span class="keyword">and</span> user_info.gender == <span class="string">&quot;male&quot;</span>:</span><br><span class="line">                redis_key = <span class="string">&quot;cold_start_group:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">                self.copy_redis_sorted_set(user_info.userid, redis_key)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">int</span>(user_info.age) &gt;= <span class="number">23</span> <span class="keyword">and</span> user_info.gender == <span class="string">&quot;male&quot;</span>:</span><br><span class="line">                redis_key = <span class="string">&quot;cold_start_group:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">                self.copy_redis_sorted_set(user_info.userid, redis_key)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span> </span><br><span class="line">        print(<span class="string">&quot;generate_cold_start_news_list_to_redis_for_register_user.&quot;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>个性化: 个性化推荐主要是针对老用户，我们通过正常推荐流程， 捕捉其兴趣爱好，做到个性推荐，优化用户体验。 所以这块走正常推荐流程，比如我们所熟知的召回→排序→重排→个性化列表生成， 召回的目的是根据用户部分特征，从海量物品库，快速找到小部分用户潜在感兴趣的物品交给精排，重点强调快，精排主要是融入更多特征，使用复杂模型，来做个性化推荐，强调准。 而重排侧，主要是结合精排的结果，再加上各种业务策略，比如去重，插入，打散，多样性保证等，主要是技术产品策略主导或改善用户体验的。 所以这几个环节组合起来，以"迅雷不及掩耳漏斗之势"，组成了个性化推荐系统的整个架构。由于这是推荐的重点环节， 每个模块都有非常丰富的知识细节，这里就不过多介绍了，后面有机会的话单独整理。</p></li>
</ul>
<p>所以， 推荐页列表生成过程总结起来， 首先先根据用户的类型分成两波， 如果是新用户， 就走冷启动推荐流程，通过用户粗略信息，给用户生成一份冷启动推荐列表。 如果是老用户， 就走个性化推荐流程， 通过召回→排序→重排等，给老用户生成一份个性化列表。最终都存储到Redis中。</p>
<p>至此， offline流程结束， 通过offline， 对于每个用户， 我们离线生成好热门页列表， 推荐页列表。</p>
<p>接下来，我们看online。</p>
<h1 id="online">Online</h1>
<p>Online是为用户在使用APP或者系统的过程中触发的行为提供一系列服务，当用户刚进入系统的时候， 会进入新闻的推荐页面，此时系统会为该用户获取推荐页文章并进行展示，当用户进入热门页， 系统就会为该用户获取热门页列表并进行展示， 下面主要介绍这两块线上获取过程中的一些细节。</p>
<ul>
<li><p>获取推荐页列表： 这个服务在用户刚进入系统，以及在推荐页中浏览文章刷新下拉过程中进行触发，当系统触发该服务的时候， 首先会判断该用户是新用户还是老用户</p>
<ul>
<li>如果是新用户， 就从离线存储好的冷启动列表中读取推荐列表， 选择指定的数目(比如一次触发给用户推荐10篇)的文章推荐，但推荐之前，需要去除已曝光的文章(避免重复曝光，影响用户体验)，所以对于每个用户，我们还会记录一份已曝光列表，方便我们去重， 同时，当批文章曝光出去，还要即使更新我们的曝光列表。</li>
<li>如果是老用户， 就从离线存储好的个性化推荐列表中读取， 和上面一样， 选择指定数目的文章，去掉曝光，生成最终推荐列表，同时更新用户曝光记录。</li>
<li>这样就完成了推荐页的推荐服务。</li>
</ul></li>
<li><p>获取热门页列表: 这个服务是用户点击热门页，以及在热门页中浏览文章刷新下来过程中进行触发，当该服务触发的时候，依然会判断新用户和老用户</p>
<ul>
<li>如果是新用户， 需要从离线存储好的公共冷启动模板中为该用户生成一份热门页列表，然后获取，选择指定数目文章推荐，和上面一样，去曝光，生成最终推荐列表，更新曝光记录。</li>
<li>如果是老用户， 从离线存储好的该用户热门列表中读取，选择指定数目文章推荐，去曝光，生成最终推荐列表，更新曝光记录。</li>
<li>这样就完成了热门页的推荐服务。</li>
</ul>
<p>代码如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hot_list</span>(<span class="params">self, user_id</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;热门页列表结果&quot;&quot;&quot;</span></span><br><span class="line">        hot_list_key_prefix = <span class="string">&quot;user_id_hot_list:&quot;</span></span><br><span class="line">        hot_list_user_key = hot_list_key_prefix + <span class="built_in">str</span>(user_id)</span><br><span class="line"></span><br><span class="line">        user_exposure_prefix = <span class="string">&quot;user_exposure:&quot;</span></span><br><span class="line">        user_exposure_key = user_exposure_prefix + <span class="built_in">str</span>(user_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 当数据库中没有这个用户的数据，就从热门列表中拷贝一份 </span></span><br><span class="line">        <span class="keyword">if</span> self.reclist_redis_db.exists(hot_list_user_key) == <span class="number">0</span>: <span class="comment"># 存在返回1，不存在返回0</span></span><br><span class="line">            print(<span class="string">&quot;copy a hot_list for &#123;&#125;&quot;</span>.<span class="built_in">format</span>(hot_list_user_key))</span><br><span class="line">            <span class="comment"># 给当前用户重新生成一个hot页推荐列表， 也就是把hot_list里面的列表复制一份给当前user， key换成user_id</span></span><br><span class="line">            self.reclist_redis_db.zunionstore(hot_list_user_key, [<span class="string">&quot;hot_list&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 一页默认10个item, 但这里候选20条，因为有可能有的在推荐页曝光过</span></span><br><span class="line">        article_num = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 返回的是一个news_id列表   zrevrange排序分值从大到小</span></span><br><span class="line">        candiate_id_list = self.reclist_redis_db.zrevrange(hot_list_user_key, <span class="number">0</span>, article_num-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(candiate_id_list) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 根据news_id获取新闻的具体内容，并返回一个列表，列表中的元素是按照顺序展示的新闻信息字典</span></span><br><span class="line">            news_info_list = []</span><br><span class="line">            selected_news = []   <span class="comment"># 记录真正被选了的</span></span><br><span class="line">            cou = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 曝光列表</span></span><br><span class="line">            print(<span class="string">&quot;self.reclist_redis_db.exists(key)&quot;</span>,self.exposure_redis_db.exists(user_exposure_key))</span><br><span class="line">            <span class="keyword">if</span> self.exposure_redis_db.exists(user_exposure_key) &gt; <span class="number">0</span>:</span><br><span class="line">                exposure_list = self.exposure_redis_db.smembers(user_exposure_key)</span><br><span class="line">                news_expose_list = <span class="built_in">set</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>], exposure_list))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                news_expose_list = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(candiate_id_list)):</span><br><span class="line">                candiate = candiate_id_list[i]</span><br><span class="line">                news_id = candiate.split(<span class="string">&#x27;_&#x27;</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># 去重曝光过的，包括在推荐页以及hot页</span></span><br><span class="line">                <span class="keyword">if</span> news_id <span class="keyword">in</span> news_expose_list:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># TODO 有些新闻可能获取不到静态的信息，这里应该有什么bug</span></span><br><span class="line">                <span class="comment"># bug 原因是，json.loads() redis中的数据会报错，需要对redis中的数据进行处理</span></span><br><span class="line">                <span class="comment"># 可以在物料处理的时候过滤一遍，json无法load的新闻</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    news_info_dict = self.get_news_detail(news_id)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/home/recsys/news_rec_server/logs/news_bad_cases.log&quot;</span>, <span class="string">&quot;a+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        f.write(news_id + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                        print(<span class="string">&quot;there are not news detail info for &#123;&#125;&quot;</span>.<span class="built_in">format</span>(news_id))</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment"># 需要确认一下前端接收的json，key需要是单引号还是双引号</span></span><br><span class="line">                news_info_list.append(news_info_dict)</span><br><span class="line">                news_expose_list.add(news_id)</span><br><span class="line">                <span class="comment"># 注意，原数的key中是包含了类别信息的</span></span><br><span class="line">                selected_news.append(candiate)</span><br><span class="line">                cou += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> cou == <span class="number">10</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(selected_news) &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># 手动删除读取出来的缓存结果, 这个很关键, 返回被删除的元素数量，用来检测是否被真的被删除了</span></span><br><span class="line">                removed_num = self.reclist_redis_db.zrem(hot_list_user_key, *selected_news)</span><br><span class="line">                print(<span class="string">&quot;the numbers of be removed:&quot;</span>, removed_num)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 曝光重新落表</span></span><br><span class="line">            self._save_user_exposure(user_id,news_expose_list)</span><br><span class="line">            <span class="keyword">return</span> news_info_list </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment">#TODO 临时这么做，这么做不太好</span></span><br><span class="line">            self.reclist_redis_db.zunionstore(hot_list_user_key, [<span class="string">&quot;hot_list&quot;</span>])</span><br><span class="line">            print(<span class="string">&quot;copy a hot_list for &#123;&#125;&quot;</span>.<span class="built_in">format</span>(hot_list_user_key))</span><br><span class="line">            <span class="comment"># 如果是把所有内容都刷完了再重新拷贝的数据，还得记得把今天的曝光数据给清除了</span></span><br><span class="line">            self.exposure_redis_db.delete(user_exposure_key)</span><br><span class="line">            <span class="keyword">return</span>  self.get_hot_list(user_id)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>至此， Online部分的推荐相关流程结束， Online的推荐流程，主要为用户的推荐页以及热门页产生推荐列表进行服务。</p>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Recommentation</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Recommentation</tag>
      </tags>
  </entry>
  <entry>
    <title>Recommentation-Materials</title>
    <url>/2021/12/22/Recommentation-Materials/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<p>本文属于新闻推荐实战-数据层-构建物料池之 <code>scrapy</code> 爬虫框架基础。对于开源的推荐系统来说数据的不断获取是非常重要的，<code>scrapy</code> 是一个非常易用且强大的爬虫框架，有固定的文件结构、类和方法，在实际使用过程中我们只需要按照要求实现相应的类方法，就可以完成我们的爬虫任务。文中给出了新闻推荐系统中新闻爬取的实战代码，以便读者可以快速掌握 <code>scrapy</code> 的基本使用方法，并能够举一反三。</p>
<a id="more"></a>
<h1 id="scrapy-基础及新闻爬取实战">2. <code>Scrapy</code> 基础及新闻爬取实战</h1>
<h3 id="python环境的安装">python环境的安装</h3>
<p>python 环境，使用 miniconda 搭建，安装miniconda的参考链接：https://blog.csdn.net/pdcfighting/article/details/111503057。</p>
<p>在安装完 miniconda 之后，创建一个新闻推荐的虚拟环境，我这边将其命名为news_rec_py3，<strong>这个环境将会在整个新闻推荐项目中使用。</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">conda create -n news_rec_py3 python==<span class="number">3.8</span></span><br></pre></td></tr></table></figure>
<h3 id="scrapy的简介与安装">Scrapy的简介与安装</h3>
<p>Scrapy 是一种快速的高级 web crawling 和 web scraping 框架，<strong>用于对网站内容进行爬取，并从其页面提取结构化数据</strong>。</p>
<p>Ubuntu下安装Scrapy，需要先安装依赖Linux依赖</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python3 python3-dev python3-pip libxml2-dev libxslt1-dev zlib1g-dev libffi-dev libssl-dev</span><br></pre></td></tr></table></figure>
<p>在新闻推荐系统虚拟conda环境中安装scrapy</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">pip install scrapy</span><br></pre></td></tr></table></figure>
<h4 id="scrapy项目结构">scrapy项目结构</h4>
<p>默认情况下，所有scrapy项目的项目结构都是相似的，在指定目录对应的命令行中输入如下命令，就会在当前目录创建一个scrapy项目</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy startproject myproject</span><br></pre></td></tr></table></figure>
<p>项目的目录结构如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">myproject/</span><br><span class="line">    scrapy.cfg</span><br><span class="line">    </span><br><span class="line">    myproject/  </span><br><span class="line">        __init__.py</span><br><span class="line">        items.py</span><br><span class="line">        middlewares.py</span><br><span class="line">        pipelines.py</span><br><span class="line">        settings.py</span><br><span class="line">        spiders/</span><br><span class="line">            __init__.py</span><br></pre></td></tr></table></figure>
<ul>
<li>scrapy.cfg: 项目配置文件</li>
<li>myproject/ : 项目python模块, 代码将从这里导入</li>
<li><strong>myproject/ items.py: 项目items文件，</strong></li>
<li><strong>myproject/ pipelines.py: 项目管道文件，将爬取的数据进行持久化存储</strong></li>
<li>myproject/ settings.py: 项目配置文件，可以配置数据库等</li>
<li><strong>myproject/ spiders/: 放置spider的目录，爬虫的具体逻辑就是在这里实现的（具体逻辑写在spider.py文件中）,可以使用命令行创建spider，也可以直接在这个文件夹中创建spider相关的py文件</strong></li>
<li>myproject/ middlewares：中间件，请求和响应都将经过他，可以配置请求头、代理、cookie、会话维持等</li>
</ul>
<h4 id="spider">spider</h4>
<p><strong>spider是定义一个特定站点（或一组站点）如何被抓取的类，包括如何执行抓取（即跟踪链接）以及如何从页面中提取结构化数据（即抓取项）。换言之，spider是为特定站点（或者在某些情况下，一组站点）定义爬行和解析页面的自定义行为的地方。</strong></p>
<p>爬行器是自己定义的类，Scrapy使用它从一个网站(或一组网站)中抓取信息。它们必须继承 <code>Spider</code> 并定义要做出的初始请求，可选的是如何跟随页面中的链接，以及如何解析下载的页面内容以提取数据。</p>
<p>对于spider来说，抓取周期是这样的：</p>
<ol type="1">
<li>首先生成对第一个URL进行爬网的初始请求，然后指定一个回调函数，该函数使用从这些请求下载的响应进行调用。要执行的第一个请求是通过调用 <code>start_requests()</code> 方法，该方法(默认情况下)生成 <code>Request</code> 中指定的URL的 <code>start_urls</code> 以及 <code>parse</code> 方法作为请求的回调函数。</li>
<li>在回调函数中，解析响应(网页)并返回 <a href="https://www.osgeo.cn/scrapy/topics/items.html#topics-items">item objects</a> ， <code>Request</code> 对象，或这些对象的可迭代。这些请求还将包含一个回调(可能相同)，然后由Scrapy下载，然后由指定的回调处理它们的响应。</li>
<li>在回调函数中，解析页面内容，通常使用 <a href="https://www.osgeo.cn/scrapy/topics/selectors.html#topics-selectors">选择器</a> （但您也可以使用beautifulsoup、lxml或任何您喜欢的机制）并使用解析的数据生成项。</li>
<li>最后，从spider返回的项目通常被持久化到数据库（在某些 <a href="https://www.osgeo.cn/scrapy/topics/item-pipeline.html#topics-item-pipeline">Item Pipeline</a> ）或者使用 <a href="https://www.osgeo.cn/scrapy/topics/feed-exports.html#topics-feed-exports">Feed 导出</a> .</li>
</ol>
<p><strong>下面是官网给出的Demo:</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&quot;quotes&quot;</span> <span class="comment"># 表示一个spider 它在一个项目中必须是唯一的，即不能为不同的spider设置相同的名称。</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 必须返回请求的可迭代(您可以返回请求列表或编写生成器函数)，spider将从该请求开始爬行。后续请求将从这些初始请求中相继生成。</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        urls = [</span><br><span class="line">            <span class="string">&#x27;http://quotes.toscrape.com/page/1/&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;http://quotes.toscrape.com/page/2/&#x27;</span>,</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(url=url, callback=self.parse) <span class="comment"># 注意，这里callback调用了下面定义的parse方法</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 将被调用以处理为每个请求下载的响应的方法。Response参数是 TextResponse 它保存页面内容，并具有进一步有用的方法来处理它。</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="comment"># 下面是直接从response中获取内容，为了更方便的爬取内容，后面会介绍使用selenium来模拟人用浏览器，并且使用对应的方法来提取我们想要爬取的内容</span></span><br><span class="line">        page = response.url.split(<span class="string">&quot;/&quot;</span>)[-<span class="number">2</span>]</span><br><span class="line">        filename = <span class="string">f&#x27;quotes-<span class="subst">&#123;page&#125;</span>.html&#x27;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.body)</span><br><span class="line">        self.log(<span class="string">f&#x27;Saved file <span class="subst">&#123;filename&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="xpath">Xpath</h4>
<p><strong>XPath 是一门在 XML 文档中查找信息的语言，XPath 可用来在 XML 文档中对元素和属性进行遍历。在爬虫的时候使用xpath来选择我们想要爬取的内容是非常方便的</strong>，这里就提一下xpath中需要掌握的内容，参考资料中的内容更加的详细（建议花一个小时看看）。</p>
<p>要了解xpath, 需要先了解一下HTML（是用来描述网页的一种语言）, 这个的细节就不详细展开</p>
<p><strong>划重点：</strong></p>
<ol type="1">
<li><p><strong>xpath路径表达式：</strong>XPath 使用路径表达式来选取 XML 文档中的节点或者节点集。这些路径表达式和我们在常规的电脑文件系统中看到的表达式非常相似。节点是通过沿着路径 (path) 或者步 (steps) 来选取的。</p></li>
<li><p><strong>了解如何使用xpath语法选取我们想要的内容，所以需要熟悉xpath的基本语法</strong></p></li>
</ol>
<h4 id="scrapy爬取新闻内容实战">scrapy爬取新闻内容实战</h4>
<p>在介绍这个项目之前先说一下这个项目的基本逻辑。</p>
<p><strong>环境准备：</strong></p>
<ol type="1">
<li>首先Ubuntu系统里面需要安装好MongoDB数据库，这个可以参考开源项目MongoDB基础</li>
<li>python环境中安装好了scrapy, pymongo包</li>
</ol>
<p><strong>项目逻辑：</strong></p>
<ol type="1">
<li>每天定时从新浪新闻网站上爬取新闻数据存储到mongodb数据库中，并且需要监控每天爬取新闻的状态（比如某天爬取的数据特别少可能是哪里出了问题，需要进行排查）</li>
<li>每天爬取新闻的时候只爬取当天日期的新闻，主要是为了防止相同的新闻重复爬取（当然这个也不能完全避免爬取重复的新闻，爬取新闻之后需要有一些单独的去重的逻辑）</li>
<li>爬虫项目中实现三个核心文件，分别是sina.py（spider）,items.py（抽取数据的规范化及字段的定义），pipelines.py（数据写入数据库）</li>
</ol>
<p>因为新闻爬取项目和新闻推荐系统是放在一起的，为了方便提前学习，下面直接给出项目的目录结构以及重要文件中的代码实现，最终的项目将会和新闻推荐系统一起开源出来</p>
<p><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20211103214124327.png" alt="image-20211103214124327" style="zoom: 80%;" /></p>
<ol type="1">
<li><strong>创建一个scrapy项目：</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scrapy startproject sinanews</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><strong>实现item.py逻辑</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># https://docs.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Item, Field</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义新闻数据的字段</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SinanewsItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;数据格式化，数据不同字段的定义</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    title = Field() <span class="comment"># 新闻标题</span></span><br><span class="line">    ctime = Field() <span class="comment"># 新闻发布时间</span></span><br><span class="line">    url = Field() <span class="comment"># 新闻原始url</span></span><br><span class="line">    raw_key_words = Field() <span class="comment"># 新闻关键词（爬取的关键词）</span></span><br><span class="line">    content = Field() <span class="comment"># 新闻的具体内容</span></span><br><span class="line">    cate = Field() <span class="comment"># 新闻类别</span></span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li><p><strong>实现sina.py (spider)逻辑</strong></p>
<p>这里需要注意的一点，这里在爬取新闻的时候选择的是一个比较简洁的展示网站进行爬取的，相比直接去最新的新浪新闻观光爬取新闻简单很多，简洁的网站大概的链接：https://news.sina.com.cn/roll/#pageid=153&amp;lid=2509&amp;k=&amp;num=50&amp;page=1</p></li>
</ol>
<p><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20211103213354334.png" alt="image-20211103213354334" style="zoom: 50%;" /></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> SinanewsItem</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SinaSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    <span class="comment"># spider的名字</span></span><br><span class="line">    name = <span class="string">&#x27;sina_spider&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, pages=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SinaSpider).__init__()</span><br><span class="line"></span><br><span class="line">        self.total_pages = <span class="built_in">int</span>(pages)</span><br><span class="line">        <span class="comment"># base_url 对应的是新浪新闻的简洁版页面，方便爬虫，并且不同类别的新闻也很好区分</span></span><br><span class="line">        self.base_url = <span class="string">&#x27;https://feed.mix.sina.com.cn/api/roll/get?pageid=153&amp;lid=&#123;&#125;&amp;k=&amp;num=50&amp;page=&#123;&#125;&amp;r=&#123;&#125;&#x27;</span></span><br><span class="line">        <span class="comment"># lid和分类映射字典</span></span><br><span class="line">        self.cate_dict = &#123;</span><br><span class="line">            <span class="string">&quot;2510&quot;</span>:  <span class="string">&quot;国内&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2511&quot;</span>:  <span class="string">&quot;国际&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2669&quot;</span>:  <span class="string">&quot;社会&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2512&quot;</span>:  <span class="string">&quot;体育&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2513&quot;</span>:  <span class="string">&quot;娱乐&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2514&quot;</span>:  <span class="string">&quot;军事&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2515&quot;</span>:  <span class="string">&quot;科技&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2516&quot;</span>:  <span class="string">&quot;财经&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2517&quot;</span>:  <span class="string">&quot;股市&quot;</span>,</span><br><span class="line">            <span class="string">&quot;2518&quot;</span>:  <span class="string">&quot;美股&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;返回一个Request迭代器</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 遍历所有类型的论文</span></span><br><span class="line">        <span class="keyword">for</span> cate_id <span class="keyword">in</span> self.cate_dict.keys():</span><br><span class="line">            <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.total_pages + <span class="number">1</span>):</span><br><span class="line">                lid = cate_id</span><br><span class="line">                <span class="comment"># 这里就是一个随机数，具体含义不是很清楚</span></span><br><span class="line">                r = random.random()</span><br><span class="line">                <span class="comment"># cb_kwargs 是用来往解析函数parse中传递参数的</span></span><br><span class="line">                <span class="keyword">yield</span> Request(self.base_url.<span class="built_in">format</span>(lid, page, r), callback=self.parse, cb_kwargs=&#123;<span class="string">&quot;cate_id&quot;</span>: lid&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response, cate_id</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析网页内容，并提取网页中需要的内容</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        json_result = json.loads(response.text) <span class="comment"># 将请求回来的页面解析成json</span></span><br><span class="line">        <span class="comment"># 提取json中我们想要的字段</span></span><br><span class="line">        <span class="comment"># json使用get方法比直接通过字典的形式获取数据更方便，因为不需要处理异常</span></span><br><span class="line">        data_list = json_result.get(<span class="string">&#x27;result&#x27;</span>).get(<span class="string">&#x27;data&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> data_list:</span><br><span class="line">            item = SinanewsItem()</span><br><span class="line"></span><br><span class="line">            item[<span class="string">&#x27;cate&#x27;</span>] = self.cate_dict[cate_id]</span><br><span class="line">            item[<span class="string">&#x27;title&#x27;</span>] = data.get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">            item[<span class="string">&#x27;url&#x27;</span>] = data.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">            item[<span class="string">&#x27;raw_key_words&#x27;</span>] = data.get(<span class="string">&#x27;keywords&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ctime = datetime.fromtimestamp(int(data.get(&#x27;ctime&#x27;)))</span></span><br><span class="line">            <span class="comment"># ctime = datetime.strftime(ctime, &#x27;%Y-%m-%d %H:%M&#x27;)</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保留的是一个时间戳</span></span><br><span class="line">            item[<span class="string">&#x27;ctime&#x27;</span>] = data.get(<span class="string">&#x27;ctime&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># meta参数传入的是一个字典，在下一层可以将当前层的item进行复制</span></span><br><span class="line">            <span class="keyword">yield</span> Request(url=item[<span class="string">&#x27;url&#x27;</span>], callback=self.parse_content, meta=&#123;<span class="string">&#x27;item&#x27;</span>: item&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_content</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析文章内容</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        item = response.meta[<span class="string">&#x27;item&#x27;</span>]</span><br><span class="line">        content = <span class="string">&#x27;&#x27;</span>.join(response.xpath(<span class="string">&#x27;//*[@id=&quot;artibody&quot; or @id=&quot;article&quot;]//p/text()&#x27;</span>).extract())</span><br><span class="line">        content = re.sub(<span class="string">r&#x27;\u3000&#x27;</span>, <span class="string">&#x27;&#x27;</span>, content)</span><br><span class="line">        content = re.sub(<span class="string">r&#x27;[ \xa0?]+&#x27;</span>, <span class="string">&#x27; &#x27;</span>, content)</span><br><span class="line">        content = re.sub(<span class="string">r&#x27;\s*\n\s*&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>, content)</span><br><span class="line">        content = re.sub(<span class="string">r&#x27;\s*(\s)&#x27;</span>, <span class="string">r&#x27;\1&#x27;</span>, content)</span><br><span class="line">        content = <span class="string">&#x27;&#x27;</span>.join([x.strip() <span class="keyword">for</span> x <span class="keyword">in</span> content])</span><br><span class="line">        item[<span class="string">&#x27;content&#x27;</span>] = content</span><br><span class="line">        <span class="keyword">yield</span> item </span><br></pre></td></tr></table></figure>
<ol start="4" type="1">
<li><p><strong>数据持久化实现，piplines.py</strong></p>
<p>这里需要注意的就是实现SinanewsPipeline类的时候，里面很多方法都是固定的，不是随便写的，不同的方法又不同的功能，这个可以参考scrapy官方文档。</p></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don&#x27;t forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"><span class="comment"># useful for handling different item types with a single interface</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"><span class="keyword">from</span> pymongo.errors <span class="keyword">import</span> DuplicateKeyError</span><br><span class="line"><span class="keyword">from</span> sinanews.items <span class="keyword">import</span> SinanewsItem</span><br><span class="line"><span class="keyword">from</span> itemadapter <span class="keyword">import</span> ItemAdapter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新闻item持久化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SinanewsPipeline</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;数据持久化：将数据存放到mongodb中</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host, port, db_name, collection_name</span>):</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.db_name = db_name</span><br><span class="line">        self.collection_name = collection_name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod    </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;自带的方法，这个方法可以重新返回一个新的pipline对象，并且可以调用配置文件中的参数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> cls(</span><br><span class="line">            host = crawler.settings.get(<span class="string">&quot;MONGO_HOST&quot;</span>),</span><br><span class="line">            port = crawler.settings.get(<span class="string">&quot;MONGO_PORT&quot;</span>),</span><br><span class="line">            db_name = crawler.settings.get(<span class="string">&quot;DB_NAME&quot;</span>),</span><br><span class="line">            <span class="comment"># mongodb中数据的集合按照日期存储</span></span><br><span class="line">            collection_name = crawler.settings.get(<span class="string">&quot;COLLECTION_NAME&quot;</span>) + \</span><br><span class="line">                <span class="string">&quot;_&quot;</span> + time.strftime(<span class="string">&quot;%Y%m%d&quot;</span>, time.localtime())</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;开始爬虫的操作，主要就是链接数据库及对应的集合</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.client = pymongo.MongoClient(self.host, self.port)</span><br><span class="line">        self.db = self.client[self.db_name]</span><br><span class="line">        self.collection = self.db[self.collection_name]</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;关闭爬虫操作的时候，需要将数据库断开</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.client.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理每一条数据，注意这里需要将item返回</span></span><br><span class="line"><span class="string">        注意：判断新闻是否是今天的，每天只保存当天产出的新闻，这样可以增量的添加新的新闻数据源</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, SinanewsItem):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># TODO 物料去重逻辑，根据title进行去重，先读取物料池中的所有物料的title然后进行去重</span></span><br><span class="line"></span><br><span class="line">                cur_time = <span class="built_in">int</span>(item[<span class="string">&#x27;ctime&#x27;</span>])</span><br><span class="line">                str_today = <span class="built_in">str</span>(datetime.date.today())</span><br><span class="line">                min_time = <span class="built_in">int</span>(time.mktime(time.strptime(str_today + <span class="string">&quot; 00:00:00&quot;</span>, <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)))</span><br><span class="line">                max_time = <span class="built_in">int</span>(time.mktime(time.strptime(str_today + <span class="string">&quot; 23:59:59&quot;</span>, <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)))</span><br><span class="line">                <span class="keyword">if</span> cur_time &gt; min_time <span class="keyword">and</span> cur_time &lt;= max_time:</span><br><span class="line">                    self.collection.insert(<span class="built_in">dict</span>(item))</span><br><span class="line">            <span class="keyword">except</span> DuplicateKeyError:</span><br><span class="line">                <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                说明有重复</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span></span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>
<ol start="5" type="1">
<li>配置文件，settings.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Scrapy settings for sinanews project</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For simplicity, this file contains only settings considered important or</span></span><br><span class="line"><span class="comment"># commonly used. You can find more settings consulting the documentation:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     https://docs.scrapy.org/en/latest/topics/settings.html</span></span><br><span class="line"><span class="comment">#     https://docs.scrapy.org/en/latest/topics/downloader-middleware.html</span></span><br><span class="line"><span class="comment">#     https://docs.scrapy.org/en/latest/topics/spider-middleware.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Collection</span><br><span class="line"></span><br><span class="line">BOT_NAME = <span class="string">&#x27;sinanews&#x27;</span></span><br><span class="line"></span><br><span class="line">SPIDER_MODULES = [<span class="string">&#x27;sinanews.spiders&#x27;</span>]</span><br><span class="line">NEWSPIDER_MODULE = <span class="string">&#x27;sinanews.spiders&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Crawl responsibly by identifying yourself (and your website) on the user-agent</span></span><br><span class="line"><span class="comment">#USER_AGENT = &#x27;sinanews (+http://www.yourdomain.com)&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Obey robots.txt rules</span></span><br><span class="line">ROBOTSTXT_OBEY = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure maximum concurrent requests performed by Scrapy (default: 16)</span></span><br><span class="line"><span class="comment">#CONCURRENT_REQUESTS = 32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure a delay for requests for the same website (default: 0)</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/settings.html#download-delay</span></span><br><span class="line"><span class="comment"># See also autothrottle settings and docs</span></span><br><span class="line"><span class="comment"># DOWNLOAD_DELAY = 3</span></span><br><span class="line"><span class="comment"># The download delay setting will honor only one of:</span></span><br><span class="line"><span class="comment">#CONCURRENT_REQUESTS_PER_DOMAIN = 16</span></span><br><span class="line"><span class="comment">#CONCURRENT_REQUESTS_PER_IP = 16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable cookies (enabled by default)</span></span><br><span class="line"><span class="comment">#COOKIES_ENABLED = False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable Telnet Console (enabled by default)</span></span><br><span class="line"><span class="comment">#TELNETCONSOLE_ENABLED = False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Override the default request headers:</span></span><br><span class="line"><span class="comment">#DEFAULT_REQUEST_HEADERS = &#123;</span></span><br><span class="line"><span class="comment">#   &#x27;Accept&#x27;: &#x27;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&#x27;,</span></span><br><span class="line"><span class="comment">#   &#x27;Accept-Language&#x27;: &#x27;en&#x27;,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable or disable spider middlewares</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/spider-middleware.html</span></span><br><span class="line"><span class="comment">#SPIDER_MIDDLEWARES = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;sinanews.middlewares.SinanewsSpiderMiddleware&#x27;: 543,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable or disable downloader middlewares</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/downloader-middleware.html</span></span><br><span class="line"><span class="comment">#DOWNLOADER_MIDDLEWARES = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;sinanews.middlewares.SinanewsDownloaderMiddleware&#x27;: 543,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable or disable extensions</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/extensions.html</span></span><br><span class="line"><span class="comment">#EXTENSIONS = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;scrapy.extensions.telnet.TelnetConsole&#x27;: None,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure item pipelines</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"><span class="comment"># 如果需要使用itempipline来存储item的话需要将这段注释打开</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&#x27;sinanews.pipelines.SinanewsPipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable and configure the AutoThrottle extension (disabled by default)</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/autothrottle.html</span></span><br><span class="line"><span class="comment">#AUTOTHROTTLE_ENABLED = True</span></span><br><span class="line"><span class="comment"># The initial download delay</span></span><br><span class="line"><span class="comment">#AUTOTHROTTLE_START_DELAY = 5</span></span><br><span class="line"><span class="comment"># The maximum download delay to be set in case of high latencies</span></span><br><span class="line"><span class="comment">#AUTOTHROTTLE_MAX_DELAY = 60</span></span><br><span class="line"><span class="comment"># The average number of requests Scrapy should be sending in parallel to</span></span><br><span class="line"><span class="comment"># each remote server</span></span><br><span class="line"><span class="comment">#AUTOTHROTTLE_TARGET_CONCURRENCY = 1.0</span></span><br><span class="line"><span class="comment"># Enable showing throttling stats for every response received:</span></span><br><span class="line"><span class="comment">#AUTOTHROTTLE_DEBUG = False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable and configure HTTP caching (disabled by default)</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/downloader-middleware.html#httpcache-middleware-settings</span></span><br><span class="line"><span class="comment">#HTTPCACHE_ENABLED = True</span></span><br><span class="line"><span class="comment">#HTTPCACHE_EXPIRATION_SECS = 0</span></span><br><span class="line"><span class="comment">#HTTPCACHE_DIR = &#x27;httpcache&#x27;</span></span><br><span class="line"><span class="comment">#HTTPCACHE_IGNORE_HTTP_CODES = []</span></span><br><span class="line"><span class="comment">#HTTPCACHE_STORAGE = &#x27;scrapy.extensions.httpcache.FilesystemCacheStorage&#x27;</span></span><br><span class="line"></span><br><span class="line">MONGO_HOST = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">MONGO_PORT = <span class="number">27017</span></span><br><span class="line">DB_NAME = <span class="string">&quot;SinaNews&quot;</span></span><br><span class="line">COLLECTION_NAME = <span class="string">&quot;news&quot;</span></span><br></pre></td></tr></table></figure>
<ol start="6" type="1">
<li>监控脚本，monitor_news.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys, time</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"><span class="keyword">import</span> scrapy </span><br><span class="line"><span class="keyword">from</span> sinanews.settings <span class="keyword">import</span> MONGO_HOST, MONGO_PORT, DB_NAME, COLLECTION_NAME</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    news_num = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">    time_str = time.strftime(<span class="string">&quot;%Y%m%d&quot;</span>, time.localtime())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 实际的collection_name</span></span><br><span class="line">    collection_name = COLLECTION_NAME + <span class="string">&quot;_&quot;</span> + time_str</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 链接数据库</span></span><br><span class="line">    client = pymongo.MongoClient(MONGO_HOST, MONGO_PORT)</span><br><span class="line">    db = client[DB_NAME]</span><br><span class="line">    collection = db[collection_name]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查找当前集合中所有文档的数量</span></span><br><span class="line">    cur_news_num = collection.count()</span><br><span class="line"></span><br><span class="line">    print(cur_news_num)</span><br><span class="line">    <span class="keyword">if</span> (cur_news_num &lt; news_num):</span><br><span class="line">        print(<span class="string">&quot;the news nums of &#123;&#125;_&#123;&#125; collection is less then &#123;&#125;&quot;</span>.\</span><br><span class="line">            <span class="built_in">format</span>(COLLECTION_NAME, time_str, news_num))</span><br></pre></td></tr></table></figure>
<ol start="7" type="1">
<li>运行脚本，run_scrapy_sina.sh</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">新闻爬取及监控脚本</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置python环境</span></span><br><span class="line">python=<span class="string">&quot;/home/recsys/miniconda3/envs/news_rec_py3/bin/python&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新浪新闻网站爬取的页面数量</span></span><br><span class="line">page=<span class="string">&quot;1&quot;</span></span><br><span class="line">min_news_num=<span class="string">&quot;1000&quot;</span> <span class="comment"># 每天爬取的新闻数量少于500认为是异常</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 爬取数据</span></span><br><span class="line">scrapy crawl sina_spider -a pages=$&#123;page&#125;  </span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo <span class="string">&quot;scrapy crawl sina_spider --pages $&#123;page&#125; success.&quot;</span></span><br><span class="line"><span class="keyword">else</span>   </span><br><span class="line">    echo <span class="string">&quot;scrapy crawl sina_spider --pages $&#123;page&#125; fail.&quot;</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查今天爬取的数据是否少于min_news_num篇文章，这里也可以配置邮件报警</span></span><br><span class="line">python monitor_news.py $&#123;min_news_num&#125;</span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">    echo <span class="string">&quot;run python monitor_news.py success.&quot;</span></span><br><span class="line"><span class="keyword">else</span>   </span><br><span class="line">    echo <span class="string">&quot;run python monitor_news.py fail.&quot;</span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<ol start="8" type="1">
<li>运行项目命令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sh run_scrapy_sina.sh</span><br></pre></td></tr></table></figure>
<p>最终查看数据库中的数据：</p>
<p><img src="http://ryluo.oss-cn-chengdu.aliyuncs.com/图片image-20211103214611171.png" alt="image-20211103214611171" style="zoom:80%;" /></p>
<h3 id="参考资料">参考资料</h3>
<ol type="1">
<li><p><a href="https://github.com/datawhalechina/fun-rec/blob/master/docs/%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98/2.2%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%AE%9E%E6%88%98/docs/MongoDB%E5%9F%BA%E7%A1%80.md">MongoDB基础</a></p></li>
<li><p><a href="https://blog.csdn.net/sxf1061700625/article/details/106866547/">Scrapy框架新手入门教程</a></p></li>
<li><p><a href="https://www.osgeo.cn/scrapy/index.html">scrapy中文文档</a></p></li>
<li><p><a href="https://www.w3school.com.cn/xpath/index.asp">Xpath教程</a></p></li>
<li><p>https://github.com/Ingram7/NewsinaSpider</p></li>
<li><p>https://www.cnblogs.com/zlslch/p/6931838.html</p></li>
</ol>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Recommentation</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Recommentation</tag>
      </tags>
  </entry>
  <entry>
    <title>Stata Introduction</title>
    <url>/2020/12/15/Stata-introduction/</url>
    <content><![CDATA[<h1 id="stata-operation">1 Stata operation</h1>
<h2 id="import-data">1.1 Import data</h2>
<ul>
<li><p>use</p>
<p><code>grilic_small.dta</code> 文件的目录请根据自己的文件目录填写，数据文件可在陈强老师的网站下载，<a href="http://www.econometrics-stata.com/col.jsp?id=101">Click here</a>，选择《计量经济学及Stata应用》中的数据集下载。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">use <span class="string">&quot;D:\Demo\University\XMU\Class_files\Econometrics\Econometrics and Stata application\Data-Finished-bachelor\grilic_small.dta&quot;</span>, clear</span><br></pre></td></tr></table></figure></li>
</ul>
<a id="more"></a>
<ul>
<li><p>clear</p>
<p>关闭一个数据集，以便使用另外一个数据集</p></li>
<li><p><code>d</code>escribe</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看数据集中的变量名称、标签等</span></span><br><span class="line">describe <span class="keyword">or</span> d</span><br></pre></td></tr></table></figure></li>
<li><p>set more off/on</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连续滚屏显示命令运行结果</span></span><br><span class="line"><span class="built_in">set</span> more off</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分页显示命令运行结果</span></span><br><span class="line"><span class="built_in">set</span> more on</span><br></pre></td></tr></table></figure></li>
<li><p><code>l</code>ist</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看变量 s 和 lnw 的前 5 个数据</span></span><br><span class="line"><span class="built_in">list</span> s lnw <span class="keyword">in</span> <span class="number">1</span>/<span class="number">5</span> <span class="comment"># or</span></span><br><span class="line">l s lnw <span class="keyword">in</span> <span class="number">1</span>/<span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 罗列第 11-15 个观测值</span></span><br><span class="line"><span class="built_in">list</span> ss lnw <span class="keyword">in</span> <span class="number">11</span>/<span class="number">15</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出满足条件 ‘s&gt;=16&#x27; 的数据</span></span><br><span class="line"><span class="built_in">list</span> s lnw <span class="keyword">if</span> s &gt;= <span class="number">16</span></span><br><span class="line"><span class="comment"># &gt;=: 等于  &lt;=：小于等于  ==：等于  ~= or !=：不等于  =：赋值</span></span><br></pre></td></tr></table></figure></li>
<li><p>drop / keep</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除满足 ’s&gt;=16&#x27; 的观测值</span></span><br><span class="line">drop <span class="keyword">if</span> s &gt;= <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只保留满足 &#x27;s&gt;=16&#x27; 的观测值</span></span><br><span class="line">keep <span class="keyword">if</span> s &gt;= <span class="number">16</span></span><br></pre></td></tr></table></figure>
<p>注：Stata 并不提供 undo 功能，故需慎重删除数据，最好保留备份-</p></li>
<li><p>sort / gsort</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将数据按照变量 s 的升序排列</span></span><br><span class="line">sort s</span><br><span class="line">lsit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 降序排列</span></span><br><span class="line">gsort -s</span><br><span class="line"><span class="built_in">list</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="plot">1.2 Plot</h2>
<h3 id="直方图">1.3.1 直方图</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">histogram s, width(<span class="number">1</span>) frequency</span><br><span class="line">hist s, w(<span class="number">1</span>) freq</span><br><span class="line"><span class="comment"># histogram: 直方图,</span></span><br><span class="line"><span class="comment"># 选择项 &#x27;width(1)&#x27; 表示将组宽设为 1（否则将使用 Stata 根据样本容量计算的默认分组数）</span></span><br><span class="line"><span class="comment"># 选择项 ‘frequency&#x27; 表示将纵坐标定为频数（默认使用密度）</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKz0OK.png" alt="image-20201210163044446" style="zoom:80%;" /></p>
<center>
Fig. 1-1 Histogram figure
</center>
<ul>
<li>查看帮助文档</li>
</ul>
<p>对于任何 <code>Stata</code> 命令，只需要输入 <code>help command_name</code> 即可查看该命令的帮助文档，<strong>初学者应养成经常查看帮助文档的习惯</strong>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">help</span> histogram</span><br><span class="line">h hist</span><br><span class="line"><span class="comment"># 查看 histogram 命令的帮助文档</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">histogram varname [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, [continuous_opts | discrete_opts] options]</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">[if], [in]: 条件操作</span></span><br><span class="line"><span class="string">[weight]: 权重</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[continuous_opts]: 连续型变量选择项</span></span><br><span class="line"><span class="string">[discrete_opts]: 离散型选择项</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">continuous_opts        Description</span></span><br><span class="line"><span class="string">----------------------------------------</span></span><br><span class="line"><span class="string">Main</span></span><br><span class="line"><span class="string">  bin(#)               set number of bins to #</span></span><br><span class="line"><span class="string">  width(#)             set width of bins to #</span></span><br><span class="line"><span class="string">  start(#)         	   set lower limit of first bin to #</span></span><br><span class="line"><span class="string">-------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">discrete_opts          Description</span></span><br><span class="line"><span class="string">------------------------------------------</span></span><br><span class="line"><span class="string">Main</span></span><br><span class="line"><span class="string">  discrete             specify that data are discrete</span></span><br><span class="line"><span class="string">  width(#)             set width of bins to #</span></span><br><span class="line"><span class="string">  start(#)             set theoretical minimum value to #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">options                Description</span></span><br><span class="line"><span class="string">-------------------------------------------</span></span><br><span class="line"><span class="string">Main</span></span><br><span class="line"><span class="string">  density               draw as density; the default</span></span><br><span class="line"><span class="string">  fraction              draw as fractions</span></span><br><span class="line"><span class="string">  frequency             draw as frequencies</span></span><br><span class="line"><span class="string">  percent               draw as percentages</span></span><br><span class="line"><span class="string">  bar_options           rendition of bars</span></span><br><span class="line"><span class="string">  binrescale  | recalculate bin sizes when by() is specified</span></span><br><span class="line"><span class="string">  addlabels             add height labels to bars</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Density plots</span></span><br><span class="line"><span class="string">  normal                  add a normal density to the graph</span></span><br><span class="line"><span class="string">  normopts(line_options)  affect rendition of normal density</span></span><br><span class="line"><span class="string">  kdensity     | add a kernel density estimate to the graph</span></span><br><span class="line"><span class="string">  kdenopts(kdensity_options) | affect rendition of kernel density</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Add plots</span></span><br><span class="line"><span class="string">  addplot(plot)           add other plots to the histogram</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="散点图">1.3.2 散点图</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">scatter lnw s</span><br><span class="line">sc lnw s</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKzrwD.png" alt="image-20201210163409860" style="zoom:80%;" /></p>
<center>
Fig. 1-2 Scatter between lnw and s
</center>
<ul>
<li>标签</li>
</ul>
<p>如果想在散点图上标注每个点对应于哪个观测值，可先定义变量 <span class="math inline">\(n\)</span>，表示第 <span class="math inline">\(n\)</span> 个观测值：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gen n = _n</span><br><span class="line">scatter lnw s, mlabel(n) <span class="comment"># 选择变量 n 作为标签（mark label）</span></span><br></pre></td></tr></table></figure>
<p>其中，<code>_n</code> 表示第 <span class="math inline">\(n\)</span> 个观测值。然后以变量作为每个点的标签来画散点图。结果如下：</p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKzsTe.png" alt="image-20201210164351554" style="zoom:80%;" /></p>
<center>
Fig. 1-3 Scatter with mark label
</center>
<h3 id="核密度估计图">1.3.3 核密度估计图</h3>
<p>直方图必然是不连续的，如果想得到密度函数的连续估计，可输入命令：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">kdensity lnw, normal normop (lpattern (dash))</span><br><span class="line">kdensity lnw, normal normop (lp (dash))</span><br></pre></td></tr></table></figure>
<p>其中</p>
<ul>
<li><code>kdensity</code>：核密度估计（kernel density estimation）；</li>
<li><code>normal</code>：画正态分布的密度函数作为对比；</li>
<li><code>normop (lp (Dash))</code>：将正态密度用虚线来画。
<ul>
<li><code>normop</code>：normal options</li>
<li><code>lpattern</code>： line pattern.</li>
</ul></li>
</ul>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKzRSI.md.png" alt="image-20201210224215508" style="zoom:80%;" /></p>
<center>
Fig. 1-4 Kernel density estimate
</center>
<h2 id="statistical-analysis">1.3 Statistical analysis</h2>
<ul>
<li><p>统计特征</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">summarize s</span><br><span class="line">su s</span><br><span class="line"></span><br><span class="line"><span class="built_in">sum</span> lnw, detail <span class="comment"># 显示更多统计指标，如偏度、峰度</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKzDeO.png" alt="image-20201210164927010" style="zoom:80%;" /></p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKzgfA.png" alt="image-20201210223033995" style="zoom:80%;" /></p>
<center>
<p>Fig. 1-4 Statistical description</p>
</center>
<p>显示了变量 <span class="math inline">\(s\)</span> 的样本容量、平均值、标准差、最小值于最大值。如 <strong>不指明变量</strong>，则显示 <strong>所有变量</strong> 的统计指标。</p></li>
<li><p>经验累计分布函数（Empirical cumulative distribution function）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tabulate s <span class="comment"># 显示 s 的经验累积分布番薯</span></span><br><span class="line">ta s</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKzwy6.png" alt="image-20201210165710687" style="zoom:80%;" /></p>
<center>
<p>Fig. 1-5 Empirical cummlative distribution</p>
</center>
<p>其中，<code>Freq</code> 表示频数，<code>Percent</code> 表示百分比，而 <code>Cum.</code> 表示累积百分比。</p></li>
<li><p>相关系数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pwcorr lnw s expr, sig star(<span class="number">.05</span>)</span><br><span class="line"><span class="comment"># 对工资对数、教育年限于工龄之间的相关系数</span></span><br></pre></td></tr></table></figure>
<p>其中，</p>
<ul>
<li><code>pwcorr</code> ： <code>pairwise correlation</code>，即两两相关；</li>
<li>选择项 <code>sig</code> ：相关系数的显著性水平，即 <code>p-value</code>，列在相关系数的下方 ；</li>
<li>选择项 <code>star (.05)</code> ：所有显著性水平小于或等于 5% 的相关系数打赏星号。</li>
</ul>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/12/15/rKz6FH.png" alt="image-20201210170540089" style="zoom:80%;" /></p>
<center>
<p>Fig.1-6 Correlation coefficient</p>
</center>
<p>结果显示，<span class="math inline">\(\rm{ln} w\)</span> 与 <span class="math inline">\(s\)</span> 的相关系数为 0.5368，且在 1% 水平上显著（ <span class="math inline">\(p\)</span> 值为0.0022）；<span class="math inline">\(\rm{ln} w\)</span> 与 <span class="math inline">\(expr\)</span> 的相关系数为 -0.1132，但此相关关系也不显著（<span class="math inline">\(p-value\)</span> 为0.5514）</p></li>
</ul>
<h2 id="generate-new-variable">1.4 Generate new variable</h2>
<h3 id="basic-operation">1.4.1 Basic operation</h3>
<ul>
<li>对数</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">generate lns = log(s)</span><br><span class="line">g lns = log(s) <span class="comment"># 对数</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>平方</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gen s2 = s ^<span class="number">2</span> <span class="comment"># 平方项</span></span><br></pre></td></tr></table></figure></li>
<li><p>互动项（乘法）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gen exprs = s * expr <span class="comment"># s 与 expr 的互动项</span></span><br></pre></td></tr></table></figure></li>
<li><p>指数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gen w = exp(lnw) <span class="comment"># 指数</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="虚拟变量">1.4.2 虚拟变量</h3>
<p>假设定义 <span class="math inline">\(s \geq 16\)</span> 为 ”受过高等教育“，并使用 变量 <span class="math inline">\(college\)</span> 来表示:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gen colleg = (s &gt;= <span class="number">16</span>)</span><br></pre></td></tr></table></figure>
<p>其中，括弧 <code>()</code> 表示对括弧中的表达式进行逻辑评估：如果此表达式为真，则取值为1；如果为假，则取值为0。</p>
<ul>
<li><p>变量重命名</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rename colleg college</span><br><span class="line">ren colleg college</span><br></pre></td></tr></table></figure></li>
<li><p>变量重定义</p>
<p>将 ”受过高等教育“的定义改为 <span class="math inline">\(s \geq 15\)</span>，但仍用 <span class="math inline">\(college\)</span> 作为变量名：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Method one</span></span><br><span class="line">drop college</span><br><span class="line">gen college = (s &gt;= <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method two</span></span><br><span class="line">replace college = (s &gt;= <span class="number">15</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>变量输入</p>
<p>对于较长的变量，一一输入较为麻烦，，有如下简便方式：</p>
<ul>
<li><p>在变量 窗口双击需要的变量；</p></li>
<li><p><span class="math inline">\(s1 - s5\)</span> 来选择这 5 个变量；</p></li>
<li><p>用 <code>*</code> 来简化变量名的书写。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">drop s* <span class="comment"># 去掉所有以 s 开头的变量</span></span><br></pre></td></tr></table></figure></li>
</ul></li>
</ul>
<h2 id="other">1.5 Other</h2>
<h3 id="calculator">1.5.1 Calculator</h3>
<p><code>Stata</code> 也可作为计算器来使用，命令格式为 <code>display expression</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">display log(<span class="number">2</span>) <span class="comment"># 计算 ln2</span></span><br><span class="line">di log(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">dis <span class="number">2</span>^<span class="number">0.5</span> <span class="comment"># 计算 $\sqrt&#123;2&#125;$</span></span><br></pre></td></tr></table></figure>
<h3 id="invoke-and-terminate-commands">1.5.2 Invoke and terminate commands</h3>
<ul>
<li>调用旧命令
<ul>
<li>使用键盘上的 <code>Pg Up</code> 和 <code>Pg Dn</code> 键；</li>
<li>在历史命令窗口 <strong>单击</strong> 旧命令，将命令调入命令窗口；</li>
<li>在历史命令窗口 <strong>双击</strong> 旧命令，再次执行此命令。</li>
</ul></li>
<li>停止执行当前执行命令
<ul>
<li>点击 <code>Break</code> 图标的快捷键；</li>
<li>同时按住 <code>Ctrl + Break</code>。</li>
</ul></li>
</ul>
<h3 id="log-file">1.5.3 Log file</h3>
<p><code>Stata</code> 日志文件的扩展名为 <code>smcl</code>。可通过快捷键 <code>Log</code> 图标使用，也可通过输入如下命令：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">log using today <span class="comment"># 在当前路径中生成一个名为 &#x27;today.smcl&#x27; 的日志文件</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># Result:</span></span><br><span class="line"><span class="string">log using &quot;D:\Demo\University\XMU\Class_files\Econometrics\Econometrics and Stata application\Test\Test-log.smcl&quot;</span></span><br><span class="line"><span class="string">--------------------------------------------</span></span><br><span class="line"><span class="string">name:  &lt;unnamed&gt;</span></span><br><span class="line"><span class="string">log:  D:\Demo\University\XMU\Class_files\Econometrics\Econometrics and Stata application\Test\Test-log.smcl</span></span><br><span class="line"><span class="string">log type:  smcl</span></span><br><span class="line"><span class="string">opened on:  10 Dec 2020, 19:10:30</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>暂时关闭日志</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">log off</span><br></pre></td></tr></table></figure></li>
<li><p>恢复使用日志</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">log on</span><br></pre></td></tr></table></figure></li>
<li><p>彻底退出日志</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">log close</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="updata-stata-lib">1.5.4 Updata stata lib</h3>
<p>更新 <code>Stata</code> 命令库（ <code>Stata "ado"</code>文件及其他可执行文件）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">updata <span class="built_in">all</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>非官方命令</p>
<p>最流行的非官方命令下载平台为 <a href="https://ideas.repec.org/s/boc/bocode.html">统计软件成分</a> (Statistical Software Components, SSC)，从 <code>SCC</code> 下载 <code>Stata</code> 程序的命令为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">scc install newcommand</span><br></pre></td></tr></table></figure>
<p>如果非官方命令不是来自 <code>SSC</code>，则需要手工安装。只需要将所有相关文件下载到制定的 <code>Stata</code> 文件夹中即可（通常为 <code>ado\plus\</code>）。如果不清楚应把文件复制到哪个文件夹，可输入以下命令，显示 <code>Stata</code> 的系统路径（System directories）：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sysdir</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">. sysdir</span><br><span class="line">   STATA:  D:\Program files\Stata <span class="number">16</span>\</span><br><span class="line">    BASE:  D:\Program files\Stata <span class="number">16</span>\ado\base\</span><br><span class="line">    SITE:  D:\Program files\Stata <span class="number">16</span>\ado\site\</span><br><span class="line">    PLUS:  C:\Users\YangSu\ado\plus\ <span class="comment"># 复制到此文件夹</span></span><br><span class="line">PERSONAL:  C:\Users\YangSu\ado\personal\</span><br><span class="line">OLDPLACE:  c:\ado\</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="search-and-findit">1.5.5 Search and findit</h3>
<ul>
<li><p>Search command</p>
<p>如果想使用某种估计方法，但不知道它是否存在，可输入命令：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">search keyword</span><br></pre></td></tr></table></figure>
<p>此命令搜索 <code>Stata</code> 帮助文件、<code>Stata</code> 常见问题、<code>Stata</code> 案例、<code>Stata Journal</code>、<code>Stata Technical Bulletin</code>等。</p></li>
<li><p>Findit keyword</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">findit keyword</span><br></pre></td></tr></table></figure>
<p><code>findit</code>搜索范围更广，还包括 <code>Stata</code> 的网络资源。</p></li>
</ul>
]]></content>
      <categories>
        <category>Class Notes</category>
        <category>Econometrics</category>
      </categories>
      <tags>
        <tag>Econometrics</tag>
        <tag>stata</tag>
      </tags>
  </entry>
  <entry>
    <title>Scikit-learn</title>
    <url>/2020/11/22/Scikit-learn/</url>
    <content><![CDATA[<h1 id="installing-scikit-learn">1 Installing scikit-learn</h1>
<ul>
<li><p>Windows</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install -U scikit-learn</span><br></pre></td></tr></table></figure></li>
<li><p>macOS</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install -U scikit-learn</span><br></pre></td></tr></table></figure></li>
<li><p>Linux</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip3 install -U scikit-learn</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Check installation:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip show scikit-learn</span><br></pre></td></tr></table></figure>
<p>See more about scikit-learn via clicking <a href="https://scikit-learn.org/stable/index.html#">here</a>.</p>
<a id="more"></a>
<h1 id="general-study-mode">2 General study mode</h1>
<p>Steps:</p>
<ol type="1">
<li>Load datas</li>
<li>Split datas into two part: train and test part</li>
<li>Training model</li>
<li>Testing and evaluating model</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># instance for iris</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np </span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"></span><br><span class="line">iris = datasets.load_iris()</span><br><span class="line">iris_x = iris.data <span class="comment"># features</span></span><br><span class="line">iris_y = iris.target <span class="comment"># types</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(iris_X[:2, :])</span></span><br><span class="line">x_train, x_test, y_train, y_test = train_test_split(iris_x, iris_y, test_size = <span class="number">0.3</span>) <span class="comment"># split original data into train and test part</span></span><br><span class="line"><span class="comment"># the percentage of test sets is 30%</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(y_train) # 会打乱原始数据</span></span><br><span class="line">knn = KNeighborsClassifier() <span class="comment"># Classifier</span></span><br><span class="line">knn.fit(x_train, y_train) <span class="comment"># Train</span></span><br><span class="line">print(knn.predict(x_test)) <span class="comment"># Use trained model to predict</span></span><br><span class="line">print(y_test)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<h1 id="sklearn.datasets">3 Sklearn.datasets</h1>
<h2 id="generate-regressiong-datas">3.1 Generate regressiong datas</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># instance for making datasets</span></span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">X, y = datasets.make_regression(n_samples = <span class="number">100</span>, </span><br><span class="line">                n_features = <span class="number">1</span>, n_targets = <span class="number">1</span>, noise = <span class="number">2</span>)</span><br><span class="line"><span class="comment"># X, y = datasets.make_regression(n_samples = 100, </span></span><br><span class="line"><span class="comment">#                 n_features = 1, n_targets = 1, noise = 10)</span></span><br><span class="line"></span><br><span class="line">plt.scatter(X, y)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>Result:<img src="https://s3.ax1x.com/2020/11/25/DUaqr4.png" /></p>
<center>
fig. 3-1 Synthetic data
</center>
<h2 id="load-datasets-of-linear-regression">3.2 Load datasets of Linear Regression</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># instance for loading boston datasets</span></span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression</span><br><span class="line"></span><br><span class="line"><span class="comment"># LinearRegression example</span></span><br><span class="line">loaded_data = datasets.load_boston()</span><br><span class="line"><span class="comment"># X, y = datasets_loadboston(retern_X_y = true)</span></span><br><span class="line">data_X, data_y = loaded_data.data, loaded_data.target</span><br><span class="line"></span><br><span class="line">model = LinearRegression()</span><br><span class="line">model.fit(data_X, data_y)</span><br><span class="line"></span><br><span class="line">print(data_y[:<span class="number">4</span>])</span><br><span class="line">print(model.predict(data_X[:<span class="number">4</span>, :]))</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="number">24.</span>  <span class="number">21.6</span> <span class="number">34.7</span> <span class="number">33.4</span>]</span><br><span class="line">[<span class="number">30.00384338</span> <span class="number">25.02556238</span> <span class="number">30.56759672</span> <span class="number">28.60703649</span>]</span><br></pre></td></tr></table></figure>
<h2 id="normalization">3.3 Normalization</h2>
<ul>
<li><p>Demo</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> preprocessing</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="comment"># cross_validation 更新为 model_selection</span></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets.samples_generator <span class="keyword">import</span> make_classification</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"> a = np.array([[<span class="number">10</span>, <span class="number">2.7</span>, <span class="number">3.6</span>],</span><br><span class="line">               [-<span class="number">100</span>, <span class="number">5</span>, <span class="number">2</span>],</span><br><span class="line">               [<span class="number">120</span>, <span class="number">20</span>, <span class="number">40</span>]], dtype = np.float64)</span><br><span class="line"></span><br><span class="line">print(a)</span><br><span class="line">print(preprocessing.scale(a)) <span class="comment"># normalization</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[[  <span class="number">10.</span>     <span class="number">2.7</span>    <span class="number">3.6</span>]</span><br><span class="line"> [-<span class="number">100.</span>     <span class="number">5.</span>     <span class="number">2.</span> ]</span><br><span class="line"> [ <span class="number">120.</span>    <span class="number">20.</span>    <span class="number">40.</span> ]]</span><br><span class="line">[[ <span class="number">0.</span>         -<span class="number">0.85170713</span> -<span class="number">0.66102858</span>]</span><br><span class="line"> [-<span class="number">1.22474487</span> -<span class="number">0.55187146</span> -<span class="number">0.75220493</span>]</span><br><span class="line"> [ <span class="number">1.22474487</span>  <span class="number">1.40357859</span>  <span class="number">1.41323351</span>]]</span><br></pre></td></tr></table></figure></li>
<li><p>Comparison of accuracy before and after normalization</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> preprocessing</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="comment"># cross_validation 更新为 model_selection</span></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets.samples_generator <span class="keyword">import</span> make_classification</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">X, y = make_classification(n_samples = <span class="number">300</span>, n_features = <span class="number">2</span>, n_redundant = <span class="number">0</span>,n_informative = <span class="number">2</span>, random_state = <span class="number">22</span>, n_clusters_per_class = <span class="number">1</span>, scale = <span class="number">100</span>)</span><br><span class="line"><span class="comment"># random_state: 固定随机数</span></span><br><span class="line"></span><br><span class="line">plt.scatter(X[:, <span class="number">0</span>], X[:, <span class="number">1</span>], c = y)</span><br><span class="line">plt.title(<span class="string">&#x27;Classification samples&#x27;</span>)</span><br><span class="line">plt.show() <span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>Plot the generated samples:<img src="https://s3.ax1x.com/2020/11/25/DUajaR.png" /></p>
<center>
<p>fig. 3-2 Samples</p>
</center>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y ,test_size = <span class="number">.3</span>)</span><br><span class="line">clf = SVC()</span><br><span class="line">clf.fit(X_train, y_train)</span><br><span class="line">print(clf.score(X_test, y_test))</span><br><span class="line"></span><br><span class="line">X = preprocessing.scale(X) <span class="comment"># normalization</span></span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y ,test_size = <span class="number">.3</span>)</span><br><span class="line">clf = SVC()</span><br><span class="line">clf.fit(X_train, y_train)</span><br><span class="line">print(clf.score(X_test, y_test))</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0.9111111111111111</span></span><br><span class="line"><span class="number">0.9555555555555556</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="model-features-and-attributes">4 Model features and attributes</h1>
<h2 id="basic-parameters">4.1 Basic parameters</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># LinearRegression example</span></span><br><span class="line">loaded_data = datasets.load_boston()</span><br><span class="line"><span class="comment"># X, y = datasets_loadboston(retern_X_y = true)</span></span><br><span class="line">data_X, data_y = loaded_data.data, loaded_data.target</span><br><span class="line"></span><br><span class="line">model = LinearRegression()</span><br><span class="line">model.fit(data_X, data_y)</span><br><span class="line"></span><br><span class="line">print(data_y[:<span class="number">4</span>])</span><br><span class="line">print(model.predict(data_X[:<span class="number">4</span>, :]))</span><br><span class="line"></span><br><span class="line">print(model.coef_) <span class="comment"># 系数</span></span><br><span class="line">print(model.intercept_) <span class="comment"># 截距</span></span><br><span class="line">print(model.get_params) <span class="comment"># 参数</span></span><br><span class="line">print(model.score(data_X, data_y)) <span class="comment"># default is R^2 coefficietn of determination</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[24.  21.6 34.7 33.4]</span><br><span class="line">[30.00384338 25.02556238 30.56759672 28.60703649]</span><br><span class="line">[-1.08011358e-01  4.64204584e-02  2.05586264e-02  2.68673382e+00</span><br><span class="line"> -1.77666112e+01  3.80986521e+00  6.92224640e-04 -1.47556685e+00</span><br><span class="line">  3.06049479e-01 -1.23345939e-02 -9.52747232e-01  9.31168327e-03</span><br><span class="line"> -5.24758378e-01]</span><br><span class="line">36.459488385089855</span><br><span class="line">&lt;bound method BaseEstimator.get_params of LinearRegression()&gt;</span><br><span class="line">0.7406426641094095</span><br></pre></td></tr></table></figure>
<h2 id="cross-validation">4.2 Cross validation</h2>
<ul>
<li><p>Evaluate the NN</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_iris</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line">iris = load_iris()</span><br><span class="line">X = iris.data</span><br><span class="line">y = iris.target</span><br><span class="line"></span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, random_state = <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">knn = KNeighborsClassifier(n_neighbors = <span class="number">5</span>)</span><br><span class="line"><span class="comment"># knn.fit(X_train, y_train)</span></span><br><span class="line"><span class="comment"># print(knn.score(X_test, y_test))</span></span><br><span class="line">scores = cross_val_score(knn, X, y, cv = <span class="number">5</span>, scoring = <span class="string">&#x27;accuracy&#x27;</span>) <span class="comment"># 将test进行5次划分</span></span><br><span class="line">print(scores.mean()) <span class="comment"># 取平均值</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0.9733333333333334</span></span><br></pre></td></tr></table></figure></li>
<li><p>Cross validation</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span>  learning_curve</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_digits</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">digits = load_digits()</span><br><span class="line">X = digits.data</span><br><span class="line">y = digits.target</span><br><span class="line">train_sizes, train_loss, test_loss= learning_curve( SVC(gamma=<span class="number">0.01</span>), X, y, cv=<span class="number">10</span>, scoring=<span class="string">&#x27;neg_mean_squared_error&#x27;</span>, train_sizes=[<span class="number">0.1</span>, <span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">0.75</span>, <span class="number">1</span>])</span><br><span class="line"><span class="comment"># &#x27;neg_mean_squared_error&#x27; 非 &#x27;mean_squared_error&#x27;</span></span><br><span class="line"></span><br><span class="line">train_loss_mean = -np.mean(train_loss, axis=<span class="number">1</span>)</span><br><span class="line">test_loss_mean = -np.mean(test_loss, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">plt.plot(train_sizes, train_loss_mean, <span class="string">&#x27;o-&#x27;</span>, color=<span class="string">&quot;r&quot;</span>,</span><br><span class="line">             label=<span class="string">&quot;Training&quot;</span>)</span><br><span class="line">plt.plot(train_sizes, test_loss_mean, <span class="string">&#x27;o-&#x27;</span>, color=<span class="string">&quot;g&quot;</span>,</span><br><span class="line">             label=<span class="string">&quot;Cross-validation&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&quot;Training examples&quot;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&quot;Loss&quot;</span>)</span><br><span class="line">plt.legend(loc=<span class="string">&quot;best&quot;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DUabMF.md.png" /></p>
<center>
<p>fig 4-1 Vross-validation</p>
</center></li>
<li><p>Adjustment parameter-1</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_iris</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"></span><br><span class="line">iris = load_iris()</span><br><span class="line">X = iris.data</span><br><span class="line">y = iris.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># test train split #</span></span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, random_state=<span class="number">4</span>)</span><br><span class="line">knn = KNeighborsClassifier(n_neighbors=<span class="number">5</span>)</span><br><span class="line">knn.fit(X_train, y_train)</span><br><span class="line">y_pred = knn.predict(X_test)</span><br><span class="line">print(knn.score(X_test, y_test))</span><br><span class="line"></span><br><span class="line"><span class="comment"># this is how to use cross_val_score to choose model and configs #</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">k_range = <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">31</span>)</span><br><span class="line">k_scores = []</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> k_range:</span><br><span class="line">    knn = KNeighborsClassifier(n_neighbors=k)</span><br><span class="line"><span class="comment">##    loss = -cross_val_score(knn, X, y, cv=10, scoring=&#x27;mean_squared_error&#x27;) # for regression</span></span><br><span class="line">    scores = cross_val_score(knn, X, y, cv=<span class="number">10</span>, scoring=<span class="string">&#x27;accuracy&#x27;</span>) <span class="comment"># for classification</span></span><br><span class="line">    k_scores.append(scores.mean())</span><br><span class="line"></span><br><span class="line">plt.plot(k_range, k_scores)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Value of K for KNN&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Cross-Validated Accuracy&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DUaXZ9.png" /></p>
<center>
<p>fig. 4-2 Adjustment parameters</p>
</center></li>
<li><p>Adjustment parameter-2</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> validation_curve</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_digits</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">digits = load_digits()</span><br><span class="line">X = digits.data</span><br><span class="line">y = digits.target</span><br><span class="line">param_range = np.logspace(-<span class="number">6</span>, -<span class="number">2.3</span>, <span class="number">5</span>)</span><br><span class="line">train_loss, test_loss = validation_curve(</span><br><span class="line">        SVC(), X, y, param_name=<span class="string">&#x27;gamma&#x27;</span>, param_range=param_range, cv=<span class="number">10</span>,</span><br><span class="line">        scoring= <span class="string">&#x27;neg_mean_squared_error&#x27;</span>)</span><br><span class="line">train_loss_mean = -np.mean(train_loss, axis=<span class="number">1</span>)</span><br><span class="line">test_loss_mean = -np.mean(test_loss, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">plt.plot(param_range, train_loss_mean, <span class="string">&#x27;o-&#x27;</span>, color=<span class="string">&quot;r&quot;</span>,</span><br><span class="line">             label=<span class="string">&quot;Training&quot;</span>)</span><br><span class="line">plt.plot(param_range, test_loss_mean, <span class="string">&#x27;o-&#x27;</span>, color=<span class="string">&quot;g&quot;</span>,</span><br><span class="line">             label=<span class="string">&quot;Cross-validation&quot;</span>)</span><br><span class="line"></span><br><span class="line">plt.xlabel(<span class="string">&quot;gamma&quot;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&quot;Loss&quot;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Overfitting problem&#x27;</span>)</span><br><span class="line">plt.legend(loc=<span class="string">&quot;best&quot;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DUaLqJ.png" /></p>
<center>
<p>fig 4-3 Adjustment parameters</p>
</center></li>
</ul>
<h2 id="transform-target-in-regression-model">4.3 Transform target in regression model</h2>
<p>将原始数据转化为分类模式，可以有效地提高预测的精度，效果如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(__doc__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> make_regression</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> RidgeCV</span><br><span class="line"><span class="keyword">from</span> sklearn.compose <span class="keyword">import</span> TransformedTargetRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> median_absolute_error, r2_score</span><br><span class="line"><span class="keyword">from</span> sklearn.utils.fixes <span class="keyword">import</span> parse_version</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> parse_version(matplotlib.__version__) &gt;= parse_version(<span class="string">&#x27;2.1&#x27;</span>):</span><br><span class="line">    desity_param = &#123;<span class="string">&#x27;density&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    density_param = &#123;<span class="string">&#x27;normed&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    </span><br><span class="line">X, y = make_regression(n_samples = <span class="number">10000</span>, noise = <span class="number">100</span>, random_state = <span class="number">0</span>)</span><br><span class="line">y = np.exp((y + <span class="built_in">abs</span>(y.<span class="built_in">min</span>()))/<span class="number">200</span>)</span><br><span class="line">y_trans = np.log1p(y)</span><br><span class="line"></span><br><span class="line">f, (ax0, ax1) = plt.subplots(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># density: normalization</span></span><br><span class="line">ax0.hist(y, bins = <span class="number">100</span>, density = <span class="literal">True</span>)</span><br><span class="line">ax0.set_xlim([<span class="number">0</span>, <span class="number">2000</span>])</span><br><span class="line">ax0.set_ylabel(<span class="string">&#x27;Probability&#x27;</span>)</span><br><span class="line">ax0.set_xlabel(<span class="string">&#x27;Target&#x27;</span>)</span><br><span class="line">ax0.set_title(<span class="string">&#x27;Target distribution&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax1.hist(y_trans, bins = <span class="number">100</span>, density = <span class="literal">True</span>)</span><br><span class="line">ax1.set_ylabel(<span class="string">&#x27;Probability&#x27;</span>)</span><br><span class="line">ax1.set_xlabel(<span class="string">&#x27;Target&#x27;</span>)</span><br><span class="line">ax1.set_title(<span class="string">&#x27;Transformed target distribution&#x27;</span>)</span><br><span class="line"></span><br><span class="line">f.suptitle(<span class="string">&#x27;Synthetic data&#x27;</span>, y = <span class="number">0.035</span>)</span><br><span class="line">f.tight_layout(rect = [<span class="number">0.05</span>, <span class="number">0.05</span>, <span class="number">0.95</span>, <span class="number">0.95</span>])</span><br><span class="line"></span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, random_state = <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2020/11/25/DUavI1.png" /></p>
<center>
fig.4-4 Comparison of Transformation
</center>
<p>然后，再来测试其对预测精度的影响：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, random_state=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">f, (ax0, ax1) = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, sharey=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">regr = RidgeCV()</span><br><span class="line">regr.fit(X_train, y_train)</span><br><span class="line">y_pred = regr.predict(X_test)</span><br><span class="line"></span><br><span class="line">ax0.scatter(y_test, y_pred)</span><br><span class="line">ax0.plot([<span class="number">0</span>, <span class="number">2000</span>], [<span class="number">0</span>, <span class="number">2000</span>], <span class="string">&#x27;--k&#x27;</span>)</span><br><span class="line">ax0.set_ylabel(<span class="string">&#x27;Target predicted&#x27;</span>)</span><br><span class="line">ax0.set_xlabel(<span class="string">&#x27;True Target&#x27;</span>)</span><br><span class="line">ax0.set_title(<span class="string">&#x27;Ridge regression \n without target transformation&#x27;</span>)</span><br><span class="line">ax0.text(<span class="number">100</span>, <span class="number">1750</span>, <span class="string">r&#x27;$R^2$=%.2f, MAE=%.2f&#x27;</span> % (</span><br><span class="line">    r2_score(y_test, y_pred), median_absolute_error(y_test, y_pred)))</span><br><span class="line">ax0.set_xlim([<span class="number">0</span>, <span class="number">2000</span>])</span><br><span class="line">ax0.set_ylim([<span class="number">0</span>, <span class="number">2000</span>])</span><br><span class="line"></span><br><span class="line">regr_trans = TransformedTargetRegressor(regressor=RidgeCV(), func=np.log1p,inverse_func=np.expm1)</span><br><span class="line"></span><br><span class="line">regr_trans.fit(X_train, y_train)</span><br><span class="line">y_pred = regr_trans.predict(X_test)</span><br><span class="line"></span><br><span class="line">ax1.scatter(y_test, y_pred)</span><br><span class="line">ax1.plot([<span class="number">0</span>, <span class="number">2000</span>], [<span class="number">0</span>, <span class="number">2000</span>], <span class="string">&#x27;--k&#x27;</span>)</span><br><span class="line">ax1.set_ylabel(<span class="string">&#x27;Target predicted&#x27;</span>)</span><br><span class="line">ax1.set_xlabel(<span class="string">&#x27;True Target&#x27;</span>)</span><br><span class="line">ax1.set_title(<span class="string">&#x27;Ridge regression \n with target transformation&#x27;</span>)</span><br><span class="line">ax1.text(<span class="number">100</span>, <span class="number">1750</span>, <span class="string">r&#x27;$R^2$=%.2f, MAE=%.2f&#x27;</span> % (</span><br><span class="line">    r2_score(y_test, y_pred), median_absolute_error(y_test, y_pred)))</span><br><span class="line">ax1.set_xlim([<span class="number">0</span>, <span class="number">2000</span>])</span><br><span class="line">ax1.set_ylim([<span class="number">0</span>, <span class="number">2000</span>])</span><br><span class="line"></span><br><span class="line">f.suptitle(<span class="string">&quot;Synthetic data&quot;</span>, y=<span class="number">0.035</span>)</span><br><span class="line">f.tight_layout(rect=[<span class="number">0.05</span>, <span class="number">0.05</span>, <span class="number">0.95</span>, <span class="number">0.95</span>])</span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2020/11/25/DUazPx.png" /></p>
<center>
fig. 4-5 Comparison before and after transforming
</center>
<p>从结果可以看出，经过预处理转化后的数据集能有效地提高预测的精度，降低 <code>MAE</code> 的值。</p>
<h1 id="save-model">5 Save model</h1>
<p>Train model</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> svm</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"></span><br><span class="line">clf = svm.SVC()</span><br><span class="line">iris = datasets.load_iris()</span><br><span class="line">X, y = iris.data, iris.target</span><br><span class="line">clf.fit(X, y)</span><br></pre></td></tr></table></figure>
<p>Then, we can use two methods to save our trained models:</p>
<ol type="1">
<li><p>pickle</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="comment"># Save</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;save/clf.pickle&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(clf, f)</span><br><span class="line"><span class="comment"># Restore</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;save/clf.pickle&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">	clf2 = pickle.load(f)</span><br><span class="line">print(clf2.predict(X[<span class="number">0</span>:<span class="number">1</span>]))</span><br></pre></td></tr></table></figure></li>
<li><p>joblib</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> joblib</span><br><span class="line"><span class="comment"># Save</span></span><br><span class="line">joblib.dump(clf, <span class="string">&#x27;./save/clf.pkl&#x27;</span>)</span><br><span class="line"><span class="comment"># restore</span></span><br><span class="line">clf3 = joblib.load(<span class="string">&#x27;save/clf.pkl&#x27;</span>)</span><br><span class="line">print(clf3.predict(X[<span class="number">0</span>:<span class="number">1</span>]))</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Notes</category>
        <category>Python module</category>
        <category>Sklearn</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Deep learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Recommentation-Database</title>
    <url>/2021/12/18/Recommentation-Database/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<p>本文属于新闻推荐实战—数据层—构建物料池之 <code>MySQL</code>。<code>MySQL</code> 数据库在该项目中会用来存储结构化的数据（用户、新闻特征），作为算法工程师需要了解常用的 <code>MySQL</code>语法（比如增删改查，排序等），因为在实际的工作经常会用来统计相关数据或者抽取相关特征。本着这个目的，本文对 <code>MySQL</code> 常见的语法及 <code>Python</code> 操作 <code>MySQL</code> 进行了总结，方便大家快速了解。</p>
<a id="more"></a>
<h1 id="mysql-in-a-nutshell">2. MySQL in a nutshell</h1>
<h2 id="mysql简介">2.1 MySQL简介</h2>
<p><code>MySQL</code> 是一个关系型数据库管理系统，由瑞典 MySQL AB 公司开发，属于 <code>Oracle</code> 旗下产品。<code>MySQL</code> 是最流行的关系型数据库管理系统之一，在 <code>WEB</code> 应用方面，MySQL是最好的 <code>RDBMS</code> (Relational Database Management System，关系数据库管理系统) 应用软件之一。</p>
<p><code>MySQL</code> 在过去由于性能高、成本低、可靠性好，已经成为最流行的开源数据库，因此被广泛地应用在 <code>Internet</code> 上的中小型网站中。随着 <code>MySQL</code> 的不断成熟，它也逐渐用于更多大规模网站和应用，比如维基百科、<code>Google</code> 和 <code>Facebook</code> 等网站。非常流行的开源软件组合 <code>LAMP</code> 中的 <code>M</code> 指的就是 <code>MySQL</code>。</p>
<h2 id="ubuntu下安装mysql">2.2 Ubuntu下安装MySQL</h2>
<p>安装教程是在<code>Ubuntu20.04</code>下进行的，安装的 <code>MySQL</code> 版本为 <code>8.0.27</code>。</p>
<h3 id="安装">2.2.1 安装</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install mysql-server mysql-client</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>注</strong>：在输入之后可能会出现如下报错：</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Unable to locate package mysql-server</span><br></pre></td></tr></table></figure></p>
<p>这是因为更换软件源头之后，没有 <code>update</code>，可以通过执行下面的命令进行更新：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sudo apt-get updata</span><br></pre></td></tr></table></figure></p></li>
</ul>
<p>After updating, try it again:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install mysql-server mysql-client</span><br></pre></td></tr></table></figure>
<p>在输入密码后，再输入<code>yes</code>即可开始安装。安装完成后，通过运行命令<code>mysql -V</code>查看版本号：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -V</span><br><span class="line">mysql  Ver 8.0.27-0ubuntu0.20.04.1 <span class="keyword">for</span> Linux on x86_64 ((Ubuntu))</span><br></pre></td></tr></table></figure>
<p>验证MySQL服务正在运行，命令行下输入：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo service mysql status</span><br></pre></td></tr></table></figure>
<p>如果正在运行，则会显示：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">● mysql.service - MySQL Community Server</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/mysql.service; enabled; vendor preset: enabled)</span><br><span class="line">     Active: active (running) since Tue 2021-12-14 20:53:58 CST; 1h 44min ago</span><br><span class="line">   Main PID: 96729 (mysqld)</span><br><span class="line">     Status: <span class="string">&quot;Server is operational&quot;</span></span><br><span class="line">      Tasks: 39 (<span class="built_in">limit</span>: 2191)</span><br><span class="line">     Memory: 355.1M</span><br><span class="line">     CGroup: /system.slice/mysql.service</span><br><span class="line">             └─96729 /usr/sbin/mysqld</span><br><span class="line"></span><br><span class="line">Dec 14 20:53:57 iZwz9d6oh1bh7ljio2oybnZ systemd[1]: Starting MySQL Community Server...</span><br><span class="line">Dec 14 20:53:58 iZwz9d6oh1bh7ljio2oybnZ systemd[1]: Started MySQL Community Server.</span><br></pre></td></tr></table></figure>
<h3 id="配置mysql的安全性">2.2.2 配置MySQL的安全性</h3>
<p>接下来，我们进行 <code>MySQL</code> 的安全性设置：</p>
<ol type="1">
<li><p>首先，运行命令<code>mysql_secure_installation</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure></li>
<li><p><code>VALIDATE PASSWORD COMPONENT</code></p>
<p>设置验证密码插件。它被用来测试<code>MySQL</code>用户的密码强度，并且提高安全性。如果想设置验证密码插件，请输入<code>y</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Connecting to MySQL using a blank password.</span><br><span class="line"></span><br><span class="line">VALIDATE PASSWORD COMPONENT can be used to <span class="built_in">test</span> passwords</span><br><span class="line">and improve security. It checks the strength of password</span><br><span class="line">and allows the users to <span class="built_in">set</span> only those passwords <span class="built_in">which</span> are</span><br><span class="line">secure enough. Would you like to setup VALIDATE PASSWORD component?</span><br><span class="line"></span><br><span class="line">Press y|Y <span class="keyword">for</span> Yes, any other key <span class="keyword">for</span> No: y</span><br></pre></td></tr></table></figure>
<p>接下来，将进行密码验证等级设置，根据数字设置对应等级，这里设置为0：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">There are three levels of password validation policy:</span><br><span class="line"></span><br><span class="line">LOW    Length &gt;= 8</span><br><span class="line">MEDIUM Length &gt;= 8, numeric, mixed <span class="keyword">case</span>, and special characters</span><br><span class="line">STRONG Length &gt;= 8, numeric, mixed <span class="keyword">case</span>, special characters and dictionary file</span><br><span class="line"></span><br><span class="line">Please enter 0 = LOW, 1 = MEDIUM and 2 = STRONG: 0</span><br></pre></td></tr></table></figure></li>
<li><p>设置密码</p>
<p>为 <code>MySQL root</code> 用户设置密码，设置过程中密码不会显示。如果设置了验证密码插件，将会显示密码的强度。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Please set the password for root here.</span><br><span class="line">New password:</span><br><span class="line"></span><br><span class="line">Re-enter new password:</span><br><span class="line"></span><br><span class="line">Estimated strength of the password: 25</span><br><span class="line">Do you wish to continue with the password provided?(Press y|Y for Yes, any other key for No) : y</span><br></pre></td></tr></table></figure></li>
<li><p>移除匿名用户</p>
<p>默认情况下，<code>MySQL</code> 安装有一个匿名用户，允许任何人登录 <code>MySQL</code>，而不必为他们创建用户帐户。输入<code>y</code>进行删除：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">By default, a MySQL installation has an anonymous user,</span><br><span class="line">allowing anyone to log into MySQL without having to have</span><br><span class="line">a user account created for them. This is intended only for</span><br><span class="line">testing, and to make the installation go a bit smoother.</span><br><span class="line">You should remove them before moving into a production</span><br><span class="line">environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? (Press y|Y for Yes, any other key for No) : y</span><br><span class="line">Success.</span><br></pre></td></tr></table></figure></li>
<li><p>禁止远程root用户登录</p>
<p>输入<code>y</code>后按<code>enter</code>，将会禁止<code>root</code>用户登录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Normally, root should only be allowed to connect from</span><br><span class="line">&#39;localhost&#39;. This ensures that someone cannot guess at</span><br><span class="line">the root password from the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? (Press y|Y for Yes, any other key for No) : y</span><br><span class="line">Success.</span><br></pre></td></tr></table></figure></li>
<li><p>删除测试库</p>
<p>输入<code>y</code>后按<code>enter</code>，将会删除测试库。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">By default, MySQL comes with a database named &#39;test&#39; that</span><br><span class="line">anyone can access. This is also intended only for testing,</span><br><span class="line">and should be removed before moving into a production</span><br><span class="line">environment.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Remove test database and access to it? (Press y|Y for Yes, any other key for No) : y</span><br><span class="line"> - Dropping test database...</span><br><span class="line">Success.</span><br></pre></td></tr></table></figure></li>
<li><p>重新加载特权表</p>
<p>输入<code>y</code>后按<code>enter</code>，将会重新加载特权表。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> - Removing privileges on test database...</span><br><span class="line">Success.</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes</span><br><span class="line">made so far will take effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? (Press y|Y for Yes, any other key for No) : y</span><br><span class="line">Success.</span><br><span class="line"></span><br><span class="line">All done!</span><br></pre></td></tr></table></figure>
<p>至此，配置完成。</p></li>
</ol>
<h3 id="以-root-用户登录">2.2.3 以 root 用户登录</h3>
<p>在 <code>MySQL 8.0</code> 上，root 用户默认通过 <code>auth_socket</code> 插件授权。<code>auth_socket</code> 插件通过 Unix socket 文件来验证所有连接到 <code>localhost</code> 的用户。</p>
<p>这意味着你不能通过提供密码，验证为 root。此时，输入 <code>mysql -uroot -p</code> 可能会被拒绝访问：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -uroot -p</span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">ERROR 1698 (28000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span></span><br></pre></td></tr></table></figure>
<p>若要以 <code>root</code> 用户身份登录 MySQL 服务器，输入<code>sudo mysql</code>，如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登录密码为linux系统用户的root密码</span></span><br><span class="line">$ sudo mysql</span><br><span class="line">[sudo] Enter password：</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 55</span><br><span class="line">Server version: 8.0.27-0ubuntu0.20.04.1 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>退出 <code>MySQL</code>，请输入<code>exit</code>命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">lyons@ubuntu:~$</span><br></pre></td></tr></table></figure>
<p>如果你想以 root 身份登录 <code>MySQL</code> 服务器，便于使用其他的程序。可以将验证方法从 <code>auth_socket</code> 修改成 <code>mysql_native_password</code>。</p>
<ol type="1">
<li><p>Modify the privilige of root</p>
<p>可以通过运行下面的命令实现，语法中的 '你的密码' 指的是你自己设置的登录密码，可设置为字母数字组合：</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;你的密码&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></p>
<p>在 <code>mysql</code> 下，将密码设置为 <code>mysql123</code>，示例：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;mysql123&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>刷新系统权限：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>退出：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure></p>
<p>现在便可以通过 <code>mysql -uroot -p</code> 登录，登录密码为前面设置的 <code>mysql123</code></p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ mysql -uroot -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 57</span><br><span class="line">Server version: 8.0.27-0ubuntu0.20.04.1 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure></p>
<p>同时，命令 <code>sudo mysql</code> 会被拒绝访问：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lyons@ubuntu:~$ sudo mysql</span><br><span class="line">ERROR 1045 (28000): Access denied for user &#39;root&#39;@&#39;localhost&#39; (using password: NO)</span><br></pre></td></tr></table></figure></p>
<p>当然，若要再次修改回 <code>sudo mysql</code> 的方式来登录 <code>root</code> 用户，方法类似：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH auth_socket BY &#39;你的密码&#39;;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></p></li>
<li><p>Create a new account</p>
<p>【推荐选项】创建一个新的独立管理用户，拥有所有数据库的访问权限：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 创建用户</span><br><span class="line">CREATE USER &#39;用户名&#39;@&#39;localhost&#39; identified by &#39;你的密码&#39;</span><br><span class="line"></span><br><span class="line"># 赋予admin用户全部的权限，你也可以只授予部分权限</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#39;用户名&#39;@&#39;localhost&#39;;</span><br></pre></td></tr></table></figure></p>
<p>示例：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">create user <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;mysql123&#x27;</span>;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p><strong>注：</strong> 上述代码可能遇到如下错误：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ERROR <span class="number">1819</span> (HY000): Your password does <span class="keyword">not</span> satisfy the current policy requirements</span><br></pre></td></tr></table></figure>
<p>通过查阅资料发现，是因为代码不符合当前的安全策略要求。为了解决这种问题，可以修改几个关于密码验证的设置的值。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;validate_password%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">+<span class="comment">--------------------------------------+--------+</span></span><br><span class="line">| Variable_name                        | Value  |</span><br><span class="line">+<span class="comment">--------------------------------------+--------+</span></span><br><span class="line">| validate_password.check_user_name    | ON     |</span><br><span class="line">| validate_password.dictionary_file    |        |</span><br><span class="line">| validate_password.length             | 8      |</span><br><span class="line">| validate_password.mixed_case_count   | 1      |</span><br><span class="line">| validate_password.number_count       | 1      |</span><br><span class="line">| validate_password.policy             | MEDIUM |</span><br><span class="line">| validate_password.special_char_count | 1      |</span><br><span class="line">+<span class="comment">--------------------------------------+--------+</span></span><br><span class="line">7 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>可以发现，密码长度要求8位，验证策略是<code>MEDIUM</code>，就是长度，数字，大小写，特殊字符都得验证，因此出现如此所示的错误，就很正常了。我们可以修改 <code>validate_password_policy=0</code>，这样就是只检查长度。另外我们觉着 8 位太长了，我们可以改为4。这样可以设置 <code>root</code> 密码为 <code>root</code>。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> validate_password.policy=<span class="number">0</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> validate_password.length=<span class="number">4</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>问题解决，接下来继续创建新用户，首先创建名为 <code>admin</code> 的用户，密码为 <code>mysql123</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create user &#39;admin&#39;@&#39;localhost&#39; identified by &#39;mysql123&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>将访问所有 database 以及表的权利授权用户 <code>admin</code>，<code>with gran option</code> 表示该用户可给其它用户赋予权限，但不可能超过该用户已有的权限</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant all privileges on *.* to &#39;admin&#39;@&#39;localhost&#39; with grant option;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 刷新</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 查看已有的用户</span><br><span class="line">select user, host from mysql.user;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| user             | host      |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| admin            | localhost |</span><br><span class="line">| debian-sys-maint | localhost |</span><br><span class="line">| mysql.infoschema | localhost |</span><br><span class="line">| mysql.session    | localhost |</span><br><span class="line">| mysql.sys        | localhost |</span><br><span class="line">| root             | localhost |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>退出 <code>root</code> 用户登录，登录 <code>admin</code> 用户，输入密码 <code>mysql123</code> 即可登录成功：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line"></span><br><span class="line"># 登录admin用户，输入密码mysql123即可登录成功</span><br><span class="line">lyons@ubuntu:~$ mysql -uadmin -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 16</span><br><span class="line">Server version: 8.0.27-0ubuntu0.20.04.1 (Ubuntu)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2021, Oracle and&#x2F;or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br></pre></td></tr></table></figure></p>
<p>说明：<code>'admin'@'localhost'</code>中，<code>localhost</code>指本地才可连接，可以将其换成<code>%</code>指任意<code>ip</code>都能连接，也可以指定<code>ip</code>连接。</p></li>
</ol>
<h3 id="修改密码">2.2.4 修改密码</h3>
<p>将用户<code>admin</code>的登录密码修改为<code>mysql321</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER USER &#39;admin&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;mysql321&#39;;</span><br></pre></td></tr></table></figure>
<h3 id="撤销用户授权">2.2.5 撤销用户授权</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查看用户的权限</span><br><span class="line">show grants for &#39;admin&#39;@&#39;localhost&#39;;</span><br><span class="line"></span><br><span class="line"># 撤销用户的权限</span><br><span class="line"># 用户有什么权限就撤销什么</span><br><span class="line">revoke all privileges on *.* from &#39;admin&#39;@&#39;localhost&#39;;</span><br></pre></td></tr></table></figure>
<h3 id="删除用户">2.2.6 删除用户</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drop user &#39;admin&#39;@&#39;localhost&#39;;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：MySQL 8.0版本和5.0部分命令有所改掉，上述语法都是在8.0版本下运行通过的；请务必检查自己的MySQL版本号。</p>
<h2 id="mysql预备知识">2.3 MySQL预备知识</h2>
<p>在正式学习MySQL之前，我们先来了解一下 SQL 语句的书写规范以及命名规则等。</p>
<h3 id="sql书写规范">2.3.1 SQL书写规范</h3>
<p>在写SQL语句时，要求按照如下规范进行：</p>
<ul>
<li><p>SQL 语句要以分号（;）结尾</p></li>
<li><p>SQL 不区分关键字的大小写 ，这对于表名和列名同样适用。</p></li>
<li><p>插入到表中的数据是区分大小写的。例如，数据 Computer、COMPUTER 或 computer，三者是不一样的。</p></li>
<li><p>常数的书写方式是固定的，在 SQL 语句中直接书写的字符串、日期或者数字等称为常数。常数的书写方式如下所示。</p>
<ul>
<li>SQL 语句中含有字符串的时候，需要像 'abc' 这样，使用单引号（'）将字符串括起来，用来标识这是一个字符串。</li>
<li>SQL 语句中含有日期的时候，同样需要使用单引号将其括起来。日期的格式有很多种（ '26 Jan 2010' 或者 '10/01/26' 等）。</li>
<li>在 SQL 语句中书写数字的时候，不需要使用任何符号标识，直接写成 1000 这样的数字即可。</li>
</ul></li>
<li><p>单词之间需要用半角空格或者换行来分隔。</p></li>
<li><p>SQL 中的注释主要采用 <code>--</code> 和 <code>/* ... */</code> 的方式，第二种方式可以换行。在 MySQL 下，还可以通过 <code>#</code> 来进行注释。</p></li>
<li><p>命名规则：</p>
<ul>
<li>在数据库中，只能使用半角英文字母、数字、下划线（_）作为数据库、表和列的名称 。</li>
<li>名称必须以半角英文字母作为开头。</li>
<li>名称不能重复，同一个数据库下不能有 2 张相同的表。</li>
</ul></li>
</ul>
<h3 id="数据类型">2.3.2 数据类型</h3>
<p><code>MySQL</code> 支持所有标准 <code>SQL</code> 数值数据类型，包括：</p>
<h4 id="数值类型">（1）数值类型</h4>
<p>数值包含的类型如下：</p>
<ul>
<li><p>整型数据：<code>TINYINT</code>、<code>INTEGER</code>、<code>SMALLINT</code>、<code>MEDIUMINT</code>、<code>DECIMAL</code> 、<code>NUMERIC</code> 和<code>BIGINT</code>。</p></li>
<li><p>浮点型数据：<code>DECIMAL</code>、<code>FLOAT</code>、<code>REAL</code> 和 <code>DOUBLE PRECISION</code>)。</p></li>
</ul>
<p>其中，关键字<code>INT</code>是<code>INTEGER</code>的同义词，关键字DEC是的同义词。</p>
<p>不同关键字的主要区别就是表示的范围或精度不一样。具体如下表：</p>
<table style="width:100%;">
<colgroup>
<col style="width: 6%" />
<col style="width: 21%" />
<col style="width: 32%" />
<col style="width: 32%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">类型</th>
<th style="text-align: center;">大小</th>
<th style="text-align: left;">范围（有符号）</th>
<th style="text-align: left;">范围（无符号）</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">TINYINT</td>
<td style="text-align: center;">1 Bytes</td>
<td style="text-align: left;">(-128，127)</td>
<td style="text-align: left;">(0，255)</td>
<td style="text-align: left;">小整数值</td>
</tr>
<tr class="even">
<td style="text-align: center;">SMALLINT</td>
<td style="text-align: center;">2 Bytes</td>
<td style="text-align: left;">(-32 768，32 767)</td>
<td style="text-align: left;">(0，65 535)</td>
<td style="text-align: left;">大整数值</td>
</tr>
<tr class="odd">
<td style="text-align: center;">MEDIUMINT</td>
<td style="text-align: center;">3 Bytes</td>
<td style="text-align: left;">(-8 388 608，8 388 607)</td>
<td style="text-align: left;">(0，16 777 215)</td>
<td style="text-align: left;">大整数值</td>
</tr>
<tr class="even">
<td style="text-align: center;">INT或INTEGER</td>
<td style="text-align: center;">4 Bytes</td>
<td style="text-align: left;">(-2 147 483 648，2 147 483 647)</td>
<td style="text-align: left;">(0，4 294 967 295)</td>
<td style="text-align: left;">大整数值</td>
</tr>
<tr class="odd">
<td style="text-align: center;">BIGINT</td>
<td style="text-align: center;">8 Bytes</td>
<td style="text-align: left;">(-9,223,372,036,854,775,808，9 223 372 036 854 775 807)</td>
<td style="text-align: left;">(0，18 446 744 073 709 551 615)</td>
<td style="text-align: left;">极大整数值</td>
</tr>
<tr class="even">
<td style="text-align: center;">FLOAT</td>
<td style="text-align: center;">4 Bytes</td>
<td style="text-align: left;">(-3.402 823 466 E+38，-1.175 494 351 E-38)，0，(1.175 494 351 E-38，3.402 823 466 351 E+38)</td>
<td style="text-align: left;">0，(1.175 494 351 E-38，3.402 823 466 E+38)</td>
<td style="text-align: left;">单精度 浮点数值</td>
</tr>
<tr class="odd">
<td style="text-align: center;">DOUBLE</td>
<td style="text-align: center;">8 Bytes</td>
<td style="text-align: left;">(-1.797 693 134 862 315 7 E+308，-2.225 073 858 507 201 4 E-308)，0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)</td>
<td style="text-align: left;">0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)</td>
<td style="text-align: left;">双精度 浮点数值</td>
</tr>
<tr class="even">
<td style="text-align: center;">DECIMAL</td>
<td style="text-align: center;">对DECIMAL(M,D) ，如果M&gt;D，为M+2否则为D+2</td>
<td style="text-align: left;">依赖于M和D的值</td>
<td style="text-align: left;">依赖于 M 和 D 的值</td>
<td style="text-align: left;">小数值</td>
</tr>
</tbody>
</table>
<h4 id="日期和时间类型">（2）日期和时间类型</h4>
<p>表示时间值的日期和时间类型为<code>DATETIME</code>、<code>DATE</code>、<code>TIMESTAMP</code>、<code>TIME</code> 和 <code>YEAR</code>。具体如下表：</p>
<table>
<colgroup>
<col style="width: 7%" />
<col style="width: 10%" />
<col style="width: 48%" />
<col style="width: 15%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">类型</th>
<th style="text-align: left;">大小 ( bytes)</th>
<th style="text-align: left;">范围</th>
<th style="text-align: left;">格式</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">DATE</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">1000-01-01/9999-12-31</td>
<td style="text-align: left;">YYYY-MM-DD</td>
<td style="text-align: left;">日期值</td>
</tr>
<tr class="even">
<td style="text-align: left;">TIME</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">'-838:59:59'/'838:59:59'</td>
<td style="text-align: left;">HH:MM:SS</td>
<td style="text-align: left;">时间值或持续时间</td>
</tr>
<tr class="odd">
<td style="text-align: left;">YEAR</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">1901/2155</td>
<td style="text-align: left;">YYYY</td>
<td style="text-align: left;">年份值</td>
</tr>
<tr class="even">
<td style="text-align: left;">DATETIME</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">1000-01-01 00:00:00/9999-12-31 23:59:59</td>
<td style="text-align: left;">YYYY-MM-DD HH:MM:SS</td>
<td style="text-align: left;">混合日期和时间值</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TIMESTAMP</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">1970-01-01 00:00:00/2038 结束时间是第 2147483647 秒，北京时间 2038-1-19 11:14:07，格林尼治时间 2038年1月19日凌晨 03:14:07</td>
<td style="text-align: left;">YYYYMMDD HHMMSS</td>
<td style="text-align: left;">混合日期和时间值，时间戳</td>
</tr>
</tbody>
</table>
<h4 id="字符串类型">（3）字符串类型</h4>
<p>字符串类型指 <code>CHAR</code>、<code>VARCHAR</code>、<code>BINARY</code>、<code>VARBINARY</code>、<code>BLOB</code>、<code>TEXT</code>、<code>ENUM</code> 和 <code>SET</code>。具体如下表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">类型</th>
<th style="text-align: left;">大小</th>
<th style="text-align: left;">用途</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CHAR</td>
<td style="text-align: left;">0-255 bytes</td>
<td style="text-align: left;">定长字符串</td>
</tr>
<tr class="even">
<td style="text-align: left;">VARCHAR</td>
<td style="text-align: left;">0-65535 bytes</td>
<td style="text-align: left;">变长字符串</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TINYBLOB</td>
<td style="text-align: left;">0-255 bytes</td>
<td style="text-align: left;">不超过 255 个字符的二进制字符串</td>
</tr>
<tr class="even">
<td style="text-align: left;">TINYTEXT</td>
<td style="text-align: left;">0-255 bytes</td>
<td style="text-align: left;">短文本字符串</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BLOB</td>
<td style="text-align: left;">0-65 535 bytes</td>
<td style="text-align: left;">二进制形式的长文本数据</td>
</tr>
<tr class="even">
<td style="text-align: left;">TEXT</td>
<td style="text-align: left;">0-65 535 bytes</td>
<td style="text-align: left;">长文本数据</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MEDIUMBLOB</td>
<td style="text-align: left;">0-16 777 215 bytes</td>
<td style="text-align: left;">二进制形式的中等长度文本数据</td>
</tr>
<tr class="even">
<td style="text-align: left;">MEDIUMTEXT</td>
<td style="text-align: left;">0-16 777 215 bytes</td>
<td style="text-align: left;">中等长度文本数据</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LONGBLOB</td>
<td style="text-align: left;">0-4 294 967 295 bytes</td>
<td style="text-align: left;">二进制形式的极大文本数据</td>
</tr>
<tr class="even">
<td style="text-align: left;">LONGTEXT</td>
<td style="text-align: left;">0-4 294 967 295 bytes</td>
<td style="text-align: left;">极大文本数据</td>
</tr>
</tbody>
</table>
<ul>
<li><p><code>char</code> 声明的是定长字符串。若实际中字符串长度不足，则会在末尾使用空格进行填充至声明的长度。</p></li>
<li><p><code>varchar</code> 声明的是可变长字符串。存储过程中，只会按照字符串的实际长度来存储，但会多占用一位来存放实际字节的长度。</p></li>
</ul>
<h3 id="数据库的基本操作">2.3.3 数据库的基本操作</h3>
<p>首先，我们来学习在 MySQL下如何操作数据库。</p>
<ol type="1">
<li><p>数据库的创建</p>
<p>通过 <code>CREATE</code> 命令，可以创建指定名称的数据库，语法结构如下：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE [IF NOT EXISTS] &lt;数据库名称&gt;;</span><br></pre></td></tr></table></figure></p>
<p>如创建名为shop的数据库</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE shop;</span><br></pre></td></tr></table></figure></p>
<p><strong>注</strong>：</p>
<ol type="1">
<li><p><code>MySQL</code> 的数据存储区将以目录方式表示 <code>MySQL</code> 数据库，因此数据库名称必须符合操作系统的文件夹命名规则，不能以数字开头，尽量要有实际意义。</p></li>
<li><p><code>MySQL</code> 下不运行存在两个相同名字的数据库，否则会报错。如果使用 <code>IF NOT EXISTS</code>（可选项），可以避免此类错误。</p></li>
</ol></li>
<li><p>数据库的查看</p>
<ul>
<li><p>查看所有存在的数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW DATABASES [LIKE &#39;数据库名&#39;];;</span><br></pre></td></tr></table></figure>
<p><code>LIKE</code>从句是可选项，用于匹配指定的数据库名称。<code>LIKE</code> 从句可以部分匹配，也可以完全匹配。</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW DATABASES [like &#39;shop&#39;];</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">+-----------------+</span><br><span class="line">| Database (shop) |</span><br><span class="line">+-----------------+</span><br><span class="line">| shop            |</span><br><span class="line">+-----------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- %表示任意0个或多个字符，可匹配任意类型和长度的字符。</span><br><span class="line">SHOW DATABASES LIKE &#39;S%&#39;;</span><br><span class="line"></span><br><span class="line">-- 结果如下</span><br><span class="line">+---------------+</span><br><span class="line">| Database (s%) |</span><br><span class="line">+---------------+</span><br><span class="line">| shop          |</span><br><span class="line">| sys           |</span><br><span class="line">+---------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li>
<li><p>查看创建的数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW CREATE DATABASE &lt;数据库名&gt;;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW CREATE DATABASE shop;</span><br><span class="line">    </span><br><span class="line">-- 或者</span><br><span class="line">SHOW CREATE DATABASE shop \G</span><br></pre></td></tr></table></figure>
<p>结果如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Database: shop</span><br><span class="line">Create Database: CREATE DATABASE &#96;shop&#96; &#x2F;*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci *&#x2F; &#x2F;*!80016 DEFAULT ENCRYPTION&#x3D;&#39;N&#39; *&#x2F;</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><code>CHARACTER SET utf8mb4</code> 表示编码字符集为 <code>utf8mb4</code>。</p></li>
</ul></li>
<li><p>选择数据库</p>
<p>在操作数据库前，必须指定所要操作的数据库。通过 <code>USE</code> 命令，可以切换到对应的数据库下。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">USE &lt;数据库名&gt;</span><br></pre></td></tr></table></figure></p>
<p>示例：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 切换到数据库shop下。</span><br><span class="line">USE shop;</span><br><span class="line"></span><br><span class="line">-- 结果如下</span><br><span class="line">Database changed</span><br></pre></td></tr></table></figure></p></li>
<li><p>删除数据库</p>
<p>通过<code>DROP</code>命令，可以将相应数据库进行删除。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP DATABASE [IF EXISTS] &lt;数据库名&gt;</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>IF EXISTS</code>为可选性，用于防止数据库不存在时报错。</p>
<p>示例：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 1.</span><br><span class="line">DROP DATABASE shop;</span><br><span class="line"># Results:</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">SHOW DATABASES; # the shop database has beed deleted.</span><br><span class="line"></span><br><span class="line">## 2.</span><br><span class="line">drop database if exists ep;</span><br><span class="line"># Results:</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>考虑到后面表的操作都是 <code>shop</code> 数据库下，在实验完<code>DROP</code>删除数据库命令后，请从新创建数据库 <code>shop</code> 并通过<code>USE</code>命令切换到该数据库下。</p></li>
</ol>
<h2 id="表的基本操作">2.4 表的基本操作</h2>
<p>表相当于文件，表中的一条记录就相当于文件的一行内容，不同的是，表中的一条记录有对应的标题，称为表的字段。</p>
<h3 id="表的创建">2.4.1 表的创建</h3>
<p>创建表的语法结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &lt;表名&gt; （&lt;字段1&gt; &lt;数据类型&gt; &lt;该列所需约束&gt;，</span><br><span class="line">   &lt;字段2&gt; &lt;数据类型&gt; &lt;该列所需约束&gt;，</span><br><span class="line">   &lt;字段3&gt; &lt;数据类型&gt; &lt;该列所需约束&gt;，</span><br><span class="line">   &lt;字段4&gt; &lt;数据类型&gt; &lt;该列所需约束&gt;，</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   &lt;该表的约束1&gt;， &lt;该表的约束2&gt;，……）；</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 创建一个名为Product的表</span><br><span class="line">CREATE TABLE Product(</span><br><span class="line">      product_id CHAR(4) NOT NULL,</span><br><span class="line">      product_name VARCHAR(100) NOT NULL,</span><br><span class="line">      product_type VARCHAR(32) NOT NULL,</span><br><span class="line">      sale_price INT,</span><br><span class="line">      purchase_price INT,</span><br><span class="line">      regist_date DATE,</span><br><span class="line">      PRIMARY KEY (product_id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">-- Results:</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure>
<p>在第二章中，我们介绍过不同的数据类型：</p>
<ul>
<li><p><code>CHAR</code> 为定长字符，这里 <code>CHAR</code> 旁边括号里的数字表示该字段最长为多少字符，少于该数字将会使用空格进行填充。</p></li>
<li><p><code>VARCHAR</code> 表示变长字符，括号里的数字表示该字段最长为多少字符，存储时只会按照字符的实际长度来存储，但会使用额外的1-2字节来存储值长度。</p></li>
</ul>
<p>简单介绍一下该语句中出现的约束条件，约束条件在后面会详细介绍：</p>
<ul>
<li><code>PRIMARY KEY</code>：主键，表示该字段对应的内容唯一且不能为空。</li>
<li><code>NOT NULL</code>：在 <code>NULL</code> 之前加上了表示否定的 <code>NOT</code>，表示该字段不能输入空白。</li>
</ul>
<p>通过 <code>SHOW TABLES</code> 命令来查看当前数据库下的所有的表名：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW TABLES;</span><br><span class="line"></span><br><span class="line">-- 结果如下</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_shop |</span><br><span class="line">+----------------+</span><br><span class="line">| Product        |</span><br><span class="line">| customer       |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>通过<code>DESC &lt;表名&gt;</code>来查看表的结构：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DESC Product;</span><br><span class="line"></span><br><span class="line">-- 结果如下</span><br><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field          | Type         | Null | Key | Default | Extra |</span><br><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">| product_id     | char(4)      | NO   | PRI | NULL    |       |</span><br><span class="line">| product_name   | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| product_type   | varchar(32)  | NO   |     | NULL    |       |</span><br><span class="line">| sale_price     | int          | YES  |     | NULL    |       |</span><br><span class="line">| purchase_price | int          | YES  |     | NULL    |       |</span><br><span class="line">| regist_date    | date         | YES  |     | NULL    |       |</span><br><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="表的删除">2.4.2 表的删除</h3>
<p>删除表的语法结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP TABLE &lt;表名&gt;;</span><br><span class="line"></span><br><span class="line">-- 例如：DROP TABLE Product;</span><br></pre></td></tr></table></figure>
<p>说明：通过 <code>DROP</code> 删除的表示无法恢复的，在删除表的时候请谨慎。</p>
<h3 id="表的更新">2.4.3 表的更新</h3>
<p>通过 <code>ALTER TABLE</code> 语句，我们可以对表字段进行不同的操作，下面通过示例来具体学习用法。</p>
<p>示例：</p>
<ol type="1">
<li><p>创建一张名为 <code>Student</code> 的表</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE Student(</span><br><span class="line">      id INT PRIMARY KEY,</span><br><span class="line">      name CHAR(15)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">DESC Student;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| Field | Type     | Null | Key | Default | Extra |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">| id    | int      | NO   | PRI | NULL    |       |</span><br><span class="line">| name  | char(15) | YES  |     | NULL    |       |</span><br><span class="line">+-------+----------+------+-----+---------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>更改表名</p>
<p>通过 <code>RENAME</code> 命令，将表名从 Student =&gt; Students。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Student RENAME Students;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>插入新的字段</p>
<p>通过 <code>ADD</code> 命令，新增字段 sex 和 age。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 不同的字段通过逗号分开</span><br><span class="line">ALTER TABLE Students ADD sex CHAR(1), ADD age INT;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>其它插入技巧：</p>
<ul>
<li><p>通过 <code>FIRST</code> 在表首插入字段 <code>stu_num</code>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Students ADD stu_num INT FIRST;</span><br></pre></td></tr></table></figure>
<p>Results: <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p></li>
<li><p>指定在字段sex后插入字段height</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Students ADD height INT AFTER sex;</span><br></pre></td></tr></table></figure>
<p>Results: <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p>
<p>最后，查看当前 <code>Students</code> 的数据类型： <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DESC Students;</span><br></pre></td></tr></table></figure></p>
<p>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+---------+----------+------+-----+---------+-------+</span><br><span class="line">| Field   | Type     | Null | Key | Default | Extra |</span><br><span class="line">+---------+----------+------+-----+---------+-------+</span><br><span class="line">| stu_num | int      | YES  |     | NULL    |       |</span><br><span class="line">| id      | int      | NO   | PRI | NULL    |       |</span><br><span class="line">| name    | char(15) | YES  |     | NULL    |       |</span><br><span class="line">| sex     | char(1)  | YES  |     | NULL    |       |</span><br><span class="line">| height  | int      | YES  |     | NULL    |       |</span><br><span class="line">| age     | int      | YES  |     | NULL    |       |</span><br><span class="line">+---------+----------+------+-----+---------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>字段的删除</p>
<p>通过<code>DROP</code>命令，可以对不在需要的字段进行删除。如删除字段 <code>stu_num</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Students DROP stu_num;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p></li>
<li><p>字段的修改</p>
<p>通过<code>MODIFY</code>修改字段的数据类型。如修改字段 <code>age</code> 的数据类型</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Students MODIFY age CHAR(3);</span><br></pre></td></tr></table></figure></p>
<p>通过<code>CHANGE</code>命令，修改字段名或类型。如修改字段 <code>name</code> 为 <code>stu_name</code>，但是不修改数据类型：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Students CHANGE name stu_name CHAR(15);</span><br></pre></td></tr></table></figure></p>
<p>以及修改字段 <code>sex</code> 为 <code>stu_sex</code>，数据类型修改为 <code>int</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Students CHANGE sex stu_sex INT;</span><br></pre></td></tr></table></figure></p>
<p>最后，查看更改后的数据类型：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DESC Students;</span><br><span class="line"></span><br><span class="line">-- 结果如下</span><br><span class="line">+----------+----------+------+-----+---------+-------+</span><br><span class="line">| Field    | Type     | Null | Key | Default | Extra |</span><br><span class="line">+----------+----------+------+-----+---------+-------+</span><br><span class="line">| id       | int      | NO   | PRI | NULL    |       |</span><br><span class="line">| stu_name | char(20) | YES  |     | NULL    |       |</span><br><span class="line">| stu_sex  | int      | YES  |     | NULL    |       |</span><br><span class="line">| height   | int      | YES  |     | NULL    |       |</span><br><span class="line">| age      | char(3)  | YES  |     | NULL    |       |</span><br><span class="line">+----------+----------+------+-----+---------+-------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h3 id="表的查询">2.4.4 表的查询</h3>
<p>通过 <code>SELECT</code>语句，可以从表中取出所要查看的字段的内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;字段名&gt;, ……</span><br><span class="line">     FROM &lt;表名&gt;;</span><br></pre></td></tr></table></figure>
<p>如要直接查询表的全部字段：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">     FROM &lt;表名&gt;;</span><br></pre></td></tr></table></figure>
<p>其中，__星号（*）__ 代表全部字段的意思。</p>
<ol type="1">
<li><p>建表并插入数据</p>
<p>在 MySQL 中，我们通过 <code>INSERT</code> 语句往表中插入数据，该语句在后面会详细介绍，该小节的重点是学会使用 <code>SELECT</code>。</p>
<p>向 <code>Product</code> 表中插入数据：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO Product VALUES</span><br><span class="line">      (&#39;0001&#39;, &#39;T恤衫&#39;, &#39;衣服&#39;, 1000, 500, &#39;2009-09-20&#39;),</span><br><span class="line">      (&#39;0002&#39;, &#39;打孔器&#39;, &#39;办公用品&#39;, 500, 320, &#39;2009-09-11&#39;),</span><br><span class="line">      (&#39;0003&#39;, &#39;运动T恤&#39;, &#39;衣服&#39;, 4000, 2800, NULL),</span><br><span class="line">      (&#39;0004&#39;, &#39;菜刀&#39;, &#39;厨房用具&#39;, 3000, 2800, &#39;2009-09-20&#39;),</span><br><span class="line">      (&#39;0005&#39;, &#39;高压锅&#39;, &#39;厨房用具&#39;, 6800, 5000, &#39;2009-01-15&#39;),</span><br><span class="line">      (&#39;0006&#39;, &#39;叉子&#39;, &#39;厨房用具&#39;, 500, NULL, &#39;2009-09-20&#39;),</span><br><span class="line">      (&#39;0007&#39;, &#39;擦菜板&#39;, &#39;厨房用具&#39;, 880, 790, &#39;2008-04-28&#39;),</span><br><span class="line">      (&#39;0008&#39;, &#39;圆珠笔&#39;, &#39;办公用品&#39;, 100, NULL,&#39;2009-11-11&#39;)</span><br><span class="line"> ;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 8 rows affected (0.00 sec)</span><br><span class="line">Records: 8  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p></li>
<li><p>查看表的内容</p>
<ul>
<li><p>查看 <strong>全部内容</strong></p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| product_id | product_name | product_type | sale_price | purchase_price | regist_date |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| 0001       | T恤衫        | 衣服         |       1000 |            500 | 2009-09-20  |</span><br><span class="line">| 0002       | 打孔器       | 办公用品     |        500 |            320 | 2009-09-11  |</span><br><span class="line">| 0003       | 运动T恤      | 衣服         |       4000 |           2800 | NULL        |</span><br><span class="line">| 0004       | 菜刀         | 厨房用具     |       3000 |           2800 | 2009-09-20  |</span><br><span class="line">| 0005       | 高压锅       | 厨房用具     |       6800 |           5000 | 2009-01-15  |</span><br><span class="line">| 0006       | 叉子         | 厨房用具     |        500 |           NULL | 2009-09-20  |</span><br><span class="line">| 0007       | 擦菜板       | 厨房用具     |        880 |            790 | 2008-04-28  |</span><br><span class="line">| 0008       | 圆珠笔       | 办公用品     |        100 |           NULL | 2009-11-11  |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>查看 <strong>部分字段</strong> 包含的内容</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select product_id, product_name, sale_price from Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+------------+</span><br><span class="line">| product_id | product_name | sale_price |</span><br><span class="line">+------------+--------------+------------+</span><br><span class="line">| 0001       | T恤衫        |       1000 |</span><br><span class="line">| 0002       | 打孔器       |        500 |</span><br><span class="line">| 0003       | 运动T恤      |       4000 |</span><br><span class="line">| 0004       | 菜刀         |       3000 |</span><br><span class="line">| 0005       | 高压锅       |       6800 |</span><br><span class="line">| 0006       | 叉子         |        500 |</span><br><span class="line">| 0007       | 擦菜板       |        880 |</span><br><span class="line">| 0008       | 圆珠笔       |        100 |</span><br><span class="line">+------------+--------------+------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
</ul></li>
<li><p>对查看的字段建立别名</p>
<p>通过<code>AS</code>语句对展示的字段另起别名，这不会修改表内字段的名字。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">  product_id AS ID,</span><br><span class="line">  product_type AS TYPE</span><br><span class="line"> FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------+--------------+</span><br><span class="line">| ID   | TYPE         |</span><br><span class="line">+------+--------------+</span><br><span class="line">| 0001 | 衣服         |</span><br><span class="line">| 0002 | 办公用品     |</span><br><span class="line">| 0003 | 衣服         |</span><br><span class="line">| 0004 | 厨房用具     |</span><br><span class="line">| 0005 | 厨房用具     |</span><br><span class="line">| 0006 | 厨房用具     |</span><br><span class="line">| 0007 | 厨房用具     |</span><br><span class="line">| 0008 | 办公用品     |</span><br><span class="line">+------+--------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>设定汉语别名时需要使用双引号 <code>"</code> 或单引号 <code>'</code> 括起来，英文字符则不需要。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT  </span><br><span class="line">  product_id AS &quot;产品编号&quot;,</span><br><span class="line">  product_type AS &quot;产品类型&quot;  </span><br><span class="line"> FROM Product;</span><br></pre></td></tr></table></figure></p></li>
<li><p>常数的查询</p>
<p><code>SELECT</code>子句中，除了可以写字段外，还可以写常数。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">  &#39;商品&#39; AS string,</span><br><span class="line">  &#39;2009-05-24&#39; AS date,</span><br><span class="line">  product_id,</span><br><span class="line">  product_name</span><br><span class="line"> FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------+------------+------------+--------------+</span><br><span class="line">| string | date       | product_id | product_name |</span><br><span class="line">+--------+------------+------------+--------------+</span><br><span class="line">| 商品   | 2009-05-24 | 0001       | T恤衫        |</span><br><span class="line">| 商品   | 2009-05-24 | 0002       | 打孔器       |</span><br><span class="line">| 商品   | 2009-05-24 | 0003       | 运动T恤      |</span><br><span class="line">| 商品   | 2009-05-24 | 0004       | 菜刀         |</span><br><span class="line">| 商品   | 2009-05-24 | 0005       | 高压锅       |</span><br><span class="line">| 商品   | 2009-05-24 | 0006       | 叉子         |</span><br><span class="line">| 商品   | 2009-05-24 | 0007       | 擦菜板       |</span><br><span class="line">| 商品   | 2009-05-24 | 0008       | 圆珠笔       |</span><br><span class="line">+--------+------------+------------+--------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>删除重复行</p>
<p>在<code>SELECT</code>语句中使用<code>DISTINCT</code>可以去除重复行。</p>
<ul>
<li><p>单列</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">  DISTINCT regist_date</span><br><span class="line"> FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------------+</span><br><span class="line">| regist_date |</span><br><span class="line">+-------------+</span><br><span class="line">| 2009-09-20  |</span><br><span class="line">| 2009-09-11  |</span><br><span class="line">| NULL        |</span><br><span class="line">| 2009-01-15  |</span><br><span class="line">| 2008-04-28  |</span><br><span class="line">| 2009-11-11  |</span><br><span class="line">+-------------+</span><br><span class="line">6 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>在使用<code>DISTINCT</code> 时，<code>NULL</code>也被视为一类数据。<code>NULL</code>存在于多行中时，会被合并为一条<code>NULL</code>数据。</p></li>
<li><p>组合列</p>
<p>还可以通过组合使用，来去除列组合重复的数据。<code>DISTINCT</code>关键字只能用在第一个列名之前。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">  DISTINCT product_type, regist_date</span><br><span class="line"> FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+-------------+</span><br><span class="line">| product_type | regist_date |</span><br><span class="line">+--------------+-------------+</span><br><span class="line">| 衣服         | 2009-09-20  |</span><br><span class="line">| 办公用品     | 2009-09-11  |</span><br><span class="line">| 衣服         | NULL        |</span><br><span class="line">| 厨房用具     | 2009-09-20  |</span><br><span class="line">| 厨房用具     | 2009-01-15  |</span><br><span class="line">| 厨房用具     | 2008-04-28  |</span><br><span class="line">| 办公用品     | 2009-11-11  |</span><br><span class="line">+--------------+-------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
</ul></li>
<li><p>指定查询条件</p>
<p>首先通过<code>WHERE</code> 子句查询出符合指定条件的记录，然后再选取出<code>SELECT</code>语句指定的列，语法结构如下：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;字段名&gt;, ……</span><br><span class="line">  FROM &lt;表名&gt;</span><br><span class="line"> WHERE &lt;条件表达式&gt;;</span><br></pre></td></tr></table></figure></p>
<pre><code>     示例：</code></pre>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_name</span><br><span class="line">  FROM Product</span><br><span class="line">WHERE product_type &#x3D; &#39;衣服&#39;;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| product_name |</span><br><span class="line">+--------------+</span><br><span class="line">| T恤衫        |</span><br><span class="line">| 运动T恤      |</span><br><span class="line">+--------------+</span><br><span class="line">2 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>注意，<code>WHERE</code> 子句要紧跟在 <code>FROM</code> 子句之后。</p></li>
</ol>
<h3 id="表的复制">2.4.5 表的复制</h3>
<p>表的复制可以将表结构与表中的数据全部复制，或者只复制表的结构。</p>
<ol type="1">
<li><p>复制整个表</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE Product_COPY1</span><br><span class="line">  	SELECT * FROM Product;</span><br><span class="line"></span><br><span class="line">-- Show</span><br><span class="line">SELECT * FROM Product_COPY1;</span><br></pre></td></tr></table></figure></p>
<p>Resutls:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| product_id | product_name | product_type | sale_price | purchase_price | regist_date |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| 0001       | T恤衫        | 衣服         |       1000 |            500 | 2009-09-20  |</span><br><span class="line">| 0002       | 打孔器       | 办公用品     |        500 |            320 | 2009-09-11  |</span><br><span class="line">| 0003       | 运动T恤      | 衣服         |       4000 |           2800 | NULL        |</span><br><span class="line">| 0004       | 菜刀         | 厨房用具     |       3000 |           2800 | 2009-09-20  |</span><br><span class="line">| 0005       | 高压锅       | 厨房用具     |       6800 |           5000 | 2009-01-15  |</span><br><span class="line">| 0006       | 叉子         | 厨房用具     |        500 |           NULL | 2009-09-20  |</span><br><span class="line">| 0007       | 擦菜板       | 厨房用具     |        880 |            790 | 2008-04-28  |</span><br><span class="line">| 0008       | 圆珠笔       | 办公用品     |        100 |           NULL | 2009-11-11  |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>复制表格结构</p>
<p>可以借助 <code>LIKE</code> 关键字复制表结构：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE Product_COPY2</span><br><span class="line">	  LIKE Product;</span><br><span class="line"></span><br><span class="line">SELECT * FROM Product_COPY2;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>可以发现此时表格是空的。接下来，查看表格结构：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DESC Product_COPY2;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field          | Type         | Null | Key | Default | Extra |</span><br><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">| product_id     | char(4)      | NO   | PRI | NULL    |       |</span><br><span class="line">| product_name   | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| product_type   | varchar(32)  | NO   |     | NULL    |       |</span><br><span class="line">| sale_price     | int          | YES  |     | 0       |       |</span><br><span class="line">| purchase_price | int          | YES  |     | NULL    |       |</span><br><span class="line">| regist_date    | date         | YES  |     | NULL    |       |</span><br><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">6 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>可以发现，虽然表格没有具体的值，但是表结构已复制成功。</p></li>
</ol>
<h2 id="运算符">2.5 运算符</h2>
<h3 id="算术运算符">2.5.1 算术运算符</h3>
<p>我们可以在<code>SELECT</code>语句中使用计算表达式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">  product_name,</span><br><span class="line">  sale_price,</span><br><span class="line">  sale_price * 2 AS &quot;sale_price_x2&quot;</span><br><span class="line"> FROM Product;</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+------------+---------------+</span><br><span class="line">| product_name | sale_price | sale_price_x2 |</span><br><span class="line">+--------------+------------+---------------+</span><br><span class="line">| T恤衫        |       1000 |          2000 |</span><br><span class="line">| 打孔器       |        500 |          1000 |</span><br><span class="line">| 运动T恤      |       4000 |          8000 |</span><br><span class="line">| 菜刀         |       3000 |          6000 |</span><br><span class="line">| 高压锅       |       6800 |         13600 |</span><br><span class="line">| 叉子         |        500 |          1000 |</span><br><span class="line">| 擦菜板       |        880 |          1760 |</span><br><span class="line">| 圆珠笔       |        100 |           200 |</span><br><span class="line">+--------------+------------+---------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>四则运算所使用的运算符 <code>+</code>、<code>-</code>、<code>*</code> 和 <code>/</code> 称为算术运算符。</p></li>
<li><p>在运算表达式中，也可以使用 <code>()</code>，括号中的运算表达式优先级会得到提升。</p></li>
<li><p><code>NULL</code> 的计算结果，仍然还是 <code>NULL</code>。</p></li>
</ul>
<h3 id="比较运算符">2.5.2 比较运算符</h3>
<p>在 <code>WHERE</code> 子句中通过使用比较运算符可以组合出各种各样的条件表达式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_name, product_type</span><br><span class="line">  FROM Product</span><br><span class="line"> WHERE sale_price &#x3D; 500;</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+--------------+</span><br><span class="line">| product_name | product_type |</span><br><span class="line">+--------------+--------------+</span><br><span class="line">| 叉子         | 厨房用具     |</span><br><span class="line">| 打孔器       | 办公用品     |</span><br><span class="line">+--------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>常见比较运算符如下表：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">运算符</th>
<th style="text-align: center;">含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">=</td>
<td style="text-align: center;">相等</td>
</tr>
<tr class="even">
<td style="text-align: center;">&lt;&gt;</td>
<td style="text-align: center;">不相等</td>
</tr>
<tr class="odd">
<td style="text-align: center;">&gt;=</td>
<td style="text-align: center;">大于等于</td>
</tr>
<tr class="even">
<td style="text-align: center;">&gt;</td>
<td style="text-align: center;">大于</td>
</tr>
<tr class="odd">
<td style="text-align: center;">&lt;=</td>
<td style="text-align: center;">小于等于</td>
</tr>
<tr class="even">
<td style="text-align: center;">&lt;</td>
<td style="text-align: center;">小于</td>
</tr>
</tbody>
</table>
<ul>
<li><p>不能对 <code>NULL</code> 使用任何比较运算符，只能通过 <code>IS NULL</code> 语句来判断：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">   product_name,</span><br><span class="line">   purchase_price</span><br><span class="line">  FROM Product</span><br><span class="line"> WHERE purchase_price IS NULL;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+----------------+</span><br><span class="line">| product_name | purchase_price |</span><br><span class="line">+--------------+----------------+</span><br><span class="line">| 叉子         |           NULL |</span><br><span class="line">| 圆珠笔       |           NULL |</span><br><span class="line">+--------------+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<pre><code>      希望选取不是 `NULL` 的记录时，需要使用`IS NOT NULL`运算符。</code></pre></li>
<li><p>对字符串使用比较符</p>
<p><code>MySQL</code> 中字符串的排序与数字不同，典型的规则就是按照字典顺序进行比较，也就是像姓名那样，按照条目在字典中出现的顺序来进行排序。例如：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;1&#39;  &lt; &#39;10&#39; &lt; &#39;11&#39; &lt; &#39;2&#39; &lt; &#39;222&#39; &lt; &#39;3&#39;</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h3 id="逻辑运算符">2.5.3 逻辑运算符</h3>
<ol type="1">
<li><p>使用<code>NOT</code>否认某一条件：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">  product_name,</span><br><span class="line">  product_type,</span><br><span class="line">  sale_price</span><br><span class="line">  FROM Product</span><br><span class="line"> WHERE NOT sale_price &gt;&#x3D; 1000;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+--------------+------------+</span><br><span class="line">| product_name | product_type | sale_price |</span><br><span class="line">+--------------+--------------+------------+</span><br><span class="line">| 叉子         | 厨房用具     |        500 |</span><br><span class="line">| 擦菜板       | 厨房用具     |        880 |</span><br><span class="line">| 圆珠笔       | 办公用品     |        100 |</span><br><span class="line">| 打孔器       | 办公用品     |        500 |</span><br><span class="line">+--------------+--------------+------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>AND</code>运算符</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_type, sale_price</span><br><span class="line">    FROM Product</span><br><span class="line">	WHERE product_type &#x3D; &#39;厨房用具&#39;</span><br><span class="line">	AND sale_price &gt;&#x3D; 3000;</span><br></pre></td></tr></table></figure></p>
<p>Resuls:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+------------+</span><br><span class="line">| product_type | sale_price |</span><br><span class="line">+--------------+------------+</span><br><span class="line">| 厨房用具     |       3000 |</span><br><span class="line">| 厨房用具     |       6800 |</span><br><span class="line">+--------------+------------+</span><br><span class="line">2 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>OR</code>运算符</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_type, sale_price</span><br><span class="line">		FROM Product</span><br><span class="line">	WHERE product_type &#x3D; &#39;厨房用具&#39;</span><br><span class="line">	OR sale_price &gt;&#x3D; 3000;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+------------+</span><br><span class="line">| product_type | sale_price |</span><br><span class="line">+--------------+------------+</span><br><span class="line">| 衣服         |       4000 |</span><br><span class="line">| 厨房用具     |       3000 |</span><br><span class="line">| 厨房用具     |       6800 |</span><br><span class="line">| 厨房用具     |        500 |</span><br><span class="line">| 厨房用具     |        880 |</span><br><span class="line">+--------------+------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>逻辑运算符和真值</p>
<ul>
<li><p>符 <code>NOT</code>、<code>AND</code> 和 <code>OR</code> 称为逻辑运算符；</p></li>
<li><p>真值就是值为<strong>真</strong> <code>TRUE</code> 或 <strong>假</strong> <code>FALSE</code>；</p></li>
<li><p>在查询 <code>NULL</code> 时，SQL中存在第三种真值，<strong>不确定</strong> <code>UNKNOWN</code>，<code>NULL</code> 和任何值做逻辑运算结果都是不确定；</p></li>
<li><p>考虑 <code>NULL</code> 时的条件判断也会变得异常复杂，因此尽量给字段加上 <code>NOT NULL</code> 的约束。</p></li>
</ul></li>
</ol>
<h2 id="分组查询">2.6 分组查询</h2>
<h3 id="聚合函数">2.6.1 聚合函数</h3>
<p>通过 SQL 对数据进行某种操作或计算时需要使用函数。</p>
<ul>
<li><p><code>COUNT</code>：计算表中的记录数（行数）</p></li>
<li><p><code>SUM</code>： 计算表中数值列中数据的合计值</p></li>
<li><p><code>AVG</code>： 计算表中数值列中数据的平均值</p></li>
<li><p><code>MAX</code>： 求出表中任意列中数据的最大值</p></li>
<li><p><code>MIN</code>： 求出表中任意列中数据的最小值</p></li>
</ul>
<p>示例：</p>
<ul>
<li><p>计数</p>
<p>计算全部数据的行数</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(*) FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| COUNT(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        8 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p><strong>Note 1:</strong> 除了 <code>COUNT</code> 可以将 <code>*</code> 作为参数，其它的函数均不可以。</p></li>
<li><p>最大值</p>
<p>计算最高的销售价格</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT MAX(sale_price) FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-----------------+</span><br><span class="line">| MAX(sale_price) |</span><br><span class="line">+-----------------+</span><br><span class="line">|          680000 |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p><strong>Note 2:</strong> 当将字段名作为参数传递给函数时，只会计算不包含 <code>NULL</code> 的行。</p>
<ul>
<li><p>Example</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--</span><br><span class="line">SELECT purchase_price FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----------------+</span><br><span class="line">| purchase_price |</span><br><span class="line">+----------------+</span><br><span class="line">|            500 |</span><br><span class="line">|            320 |</span><br><span class="line">|           2800 |</span><br><span class="line">|            700 |</span><br><span class="line">|           1250 |</span><br><span class="line">|           NULL |</span><br><span class="line">|            198 |</span><br><span class="line">|           NULL |</span><br><span class="line">+----------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>可以发现 <code>purchase_price</code> 字段是包含 <code>NULL</code> 值的，且共有 <code>8</code> 个值。</p>
<p>首先，以 <code>*</code> 为参数传递给 <code>COUNT</code> 函数</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(*) FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| COUNT(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        8 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>其次，以 <code>purchase_price</code> 为参数传递给 <code>COUNT</code> 函数</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(purchase_price) FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-----------------------+</span><br><span class="line">| COUNT(purchase_price) |</span><br><span class="line">+-----------------------+</span><br><span class="line">|                     6 |</span><br><span class="line">+-----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>可以看到两次结果结果并不一样，函数忽略了值为 <code>NULL</code> 的行。</p></li>
</ul>
<p><strong>Note 3:</strong> <code>SUM</code>，<code>AVG</code> 函数在计算时也会进行同样的操作，并不会将 <code>NULL</code> 当做 <code>0</code> 来处理！ 特别注意 <code>AVG</code> 函数，计算时分母也不会算上<code>NULL</code>行。</p>
<p><strong>Note 4:</strong> <code>MAX/MIN</code> 函数几乎适用于所有数据类型的列，包括字符和日期。<code>SUM/AVG</code>函数只适用于数值类型的列。</p></li>
<li><p>计算唯一值数</p>
<p>在聚合函数删除重复值：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(DISTINCT product_type)</span><br><span class="line"> FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------------------------+</span><br><span class="line">| COUNT(DISTINCT product_type) |</span><br><span class="line">+------------------------------+</span><br><span class="line">|                            3 |</span><br><span class="line">+------------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p><strong>Note 5:</strong> <code>DISTINCT</code>必须写在括号中。这是因为必须要在计算行数之前删除 product_type 字段中的重复数据。</p></li>
</ul>
<h3 id="对表分组">2.6.2 对表分组</h3>
<p>如果对 <code>Pandas</code> 熟悉，那么应该很了解 <code>groupby</code> 函数，借助该函数可以根据指定的列名，对对表进行分组。在 <code>MySQL</code> 中，也存在同样作用的函数，即 <code>GROUP BY</code>。</p>
<p>语法结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;列名1&gt;, &lt;列名2&gt;, &lt;列名3&gt;, ……</span><br><span class="line">   FROM &lt;表名&gt;</span><br><span class="line">   GROUP BY &lt;列名1&gt;, &lt;列名2&gt;, &lt;列名3&gt;, ……;</span><br></pre></td></tr></table></figure>
<p>按照 <code>product_type</code> 字段进行分组，并统计各组的数量：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_type, COUNT(*)</span><br><span class="line"> FROM Product</span><br><span class="line"> GROUP BY product_type;</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+----------+</span><br><span class="line">| product_type | COUNT(*) |</span><br><span class="line">+--------------+----------+</span><br><span class="line">| 衣服         |        2 |</span><br><span class="line">| 厨房用具     |        4 |</span><br><span class="line">| 办公用品     |        2 |</span><br><span class="line">+--------------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>在该语句中，我们首先通过 <code>GROUP BY</code> 函数对指定的字段 <code>product_type</code> 进行分组。分组时，<code>product_type</code> 字段中具有相同值的行会汇聚到同一组。最后，通过 <code>COUNT</code> 函数，统计不同分组的包含的行数。</p>
<p>简单来理解：</p>
<ul>
<li><p>例如做操时，老师将不同身高的同学进行分组，相同身高的同学会被分到同一组，分组后我们又统计了每个小组的学生数。</p></li>
<li><p>将这里的同学可以理解为表中的一行数据，身高理解为表的某一字段。</p></li>
<li><p>分组操作就是 <code>GROUP BY</code>，<code>GROUP BY</code> 后面接的字段等价于按照身高分组，统计学生数就等价于在 <code>SELECT</code> 后用了 <code>COUNT(*)</code> 函数。</p></li>
</ul>
<p><strong>Note:</strong> <code>GROUP BY</code> 子句的位置一定要写在 <code>FROM</code> 语句之后（如果有 <code>WHERE</code> 子句的话需要写在 <code>WHERE</code> 子句之后）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. SELECT → 2. FROM → 3. WHERE → 4. GROUP BY</span><br></pre></td></tr></table></figure>
<p>当被聚合的键中，包含 <code>NULL</code> 时，在结果中会以 <strong>不确定</strong> 行（空行）的形式表现出来，也就是字段中为 <code>NULL</code> 的数据会被聚合为一组。</p>
<h3 id="使用-where-语句">2.6.3 使用 <code>WHERE</code> 语句</h3>
<p>在对表进行分组之前，也可以是先使用 <code>WHERE</code> 对表进行条件过滤，然后再进行分组处理。语法结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;列名1&gt;, &lt;列名2&gt;, &lt;列名3&gt;, ……</span><br><span class="line"> FROM &lt;表名&gt;</span><br><span class="line"> WHERE</span><br><span class="line"> GROUP BY &lt;列名1&gt;, &lt;列名2&gt;, &lt;列名3&gt;, ……;</span><br></pre></td></tr></table></figure>
<p>我们先通过 <code>WHERE</code> 语句将表中类型为衣服的行筛选出来，然后再按照 <code>purchase_price</code> 来进行分组：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT purchase_price, COUNT(*)</span><br><span class="line"> FROM Product</span><br><span class="line"> WHERE product_type &#x3D; &#39;衣服&#39;</span><br><span class="line"> GROUP BY purchase_price;</span><br></pre></td></tr></table></figure>
<p>Results:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----------------+----------+</span><br><span class="line">| purchase_price | COUNT(*) |</span><br><span class="line">+----------------+----------+</span><br><span class="line">|           2800 |        1 |</span><br><span class="line">|            500 |        1 |</span><br><span class="line">+----------------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><strong>Note</strong>: 该语法实际的执行顺序为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM → WHERE → GROUP BY → SELECT</span><br></pre></td></tr></table></figure>
<p>此外，</p>
<ul>
<li><p>使用 <code>GROUP BY</code>子句时，<code>SELECT</code> 子句中不能出现聚合键之外的字段名（因为 <code>SELECT</code> 语句是在 <code>GROUP BY</code> 语句之后执行的）；</p>
<p>即，若 <code>GROUP BY</code>选中 <code>purchase_price</code> 字段进行分组，则在 <code>SELECT</code> 语句中只能选中 <code>purchase_price</code> 字段，其它字段如 <code>product_id</code> 等均不行。</p></li>
<li><p><code>WHERE</code> 语句中，不可以使用聚合函数。</p>
<p><code>WHERE</code> 子句只能指定记录（行）的条件，而不能用来指定组的条件。即<code>WHERE MAX(purchase_price) &gt; 1000</code>这样的语句是非法的。</p></li>
</ul>
<h3 id="为聚合结果指定条件">2.6.4 为聚合结果指定条件</h3>
<p>前面提到了 <code>WHERE</code> 语句中不能使用聚合函数，但是实际操作时需要通过聚合函数来进行过滤怎么办呢？这就要用到 <code>HAVING</code> 语句了。语法结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;列名1&gt;, &lt;列名2&gt;, &lt;列名3&gt;, ……</span><br><span class="line"> FROM &lt;表名&gt;</span><br><span class="line"> GROUP BY &lt;列名1&gt;, &lt;列名2&gt;, &lt;列名3&gt;, ……</span><br><span class="line">HAVING &lt;分组结果对应的条件&gt;</span><br></pre></td></tr></table></figure>
<p>在 <code>HAVING</code> 的子句中能够使用的 3 种要素如下所示：</p>
<ul>
<li>常数</li>
<li>聚合函数</li>
<li><code>GROUP BY</code>子句中指定的字段名（即聚合键）</li>
</ul>
<ol type="1">
<li><p>不使用 <code>HAVING</code> 语句</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_type, AVG(sale_price)</span><br><span class="line"> FROM Product</span><br><span class="line"> GROUP BY product_type;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+-----------------+</span><br><span class="line">| product_type | AVG(sale_price) |</span><br><span class="line">+--------------+-----------------+</span><br><span class="line">| 衣服         |       2500.0000 |</span><br><span class="line">| 厨房用具     |       2795.0000 |</span><br><span class="line">| 办公用品     |        300.0000 |</span><br><span class="line">+--------------+-----------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>使用 <code>HAVING</code> 语句</p>
<p>通过 <code>HAVING</code> 语句选择销售平均价格大于或等于2500的数据：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_type, AVG(sale_price)</span><br><span class="line"> FROM Product</span><br><span class="line"> GROUP BY product_type</span><br><span class="line">HAVING AVG(sale_price) &gt;&#x3D; 2500;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+-----------------+</span><br><span class="line">| product_type | AVG(sale_price) |</span><br><span class="line">+--------------+-----------------+</span><br><span class="line">| 衣服         |       2500.0000 |</span><br><span class="line">| 厨房用具     |       2795.0000 |</span><br><span class="line">+--------------+-----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p>可以看到使用<code>HAVING</code>语句后，输出的结果有所变化。大致流程如下：</p>
<ul>
<li>首先，<code>FROM</code> 语句会选中表 <code>Product</code>；</li>
<li>然后，<code>GROUP BY</code>语句会选中字段 <code>product_type</code> 进行分组；</li>
<li>之后，通过 <code>HAVING</code> 语句将销售平均价格大于等于 <code>2500</code> 的组保留下来；</li>
<li>最后，通过 <code>SELECT</code> 语句将保留下的组的产品类型和平均价格显示出来；</li>
</ul>
<p>如果是对<strong>表的行</strong>进行条件指定，<code>WHERE</code>和<code>HAVING</code>都可以生效。下面两条语句执行结果一致：</p>
<ul>
<li><p><code>HAVING</code></p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_type, COUNT(*)</span><br><span class="line">  FROM Product</span><br><span class="line">  GROUP BY product_type</span><br><span class="line"> HAVING product_type &#x3D; &#39;衣服&#39;;</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>WHERE</code></p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_type, COUNT(*)</span><br><span class="line">  FROM Product</span><br><span class="line">  WHERE product_type &#x3D; &#39;衣服&#39;</span><br><span class="line"> GROUP BY product_type;</span><br></pre></td></tr></table></figure></p></li>
</ul>
<p>Results:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------+----------+</span><br><span class="line">| product_type | COUNT(*) |</span><br><span class="line">+--------------+----------+</span><br><span class="line">| 衣服         |        2 |</span><br><span class="line">+--------------+----------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong> 一般而言如果是对表的行进行条件指定，最好还是使用 <code>WHERE</code> 语句，因为 <code>WHERE</code> 的执行速度更快。</p>
<h3 id="对表的查询结果进行排序">2.6.5 对表的查询结果进行排序</h3>
<p>如果希望对表的查询结果根据某指定的字段进行排序，可以使用<code>ORDER BY</code>语句。语法结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;列名1&gt;, &lt;列名2&gt;, &lt;列名3&gt;, ……</span><br><span class="line"> FROM &lt;表名&gt;</span><br><span class="line"> ORDER BY &lt;排序基准列1&gt;, &lt;排序基准列2&gt;, ……</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_id, product_name, sale_price, purchase_price</span><br><span class="line"> FROM Product;</span><br><span class="line"></span><br><span class="line">-- 结果如下</span><br><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">| product_id | product_name | sale_price | purchase_price |</span><br><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">| 0001       | T恤衫        |       1000 |            500 |</span><br><span class="line">| 0002       | 打孔器       |        500 |            320 |</span><br><span class="line">| 0003       | 运动T恤      |       4000 |           2800 |</span><br><span class="line">| 0004       | 菜刀         |     300000 |            700 |</span><br><span class="line">| 0005       | 高压锅       |     680000 |           1250 |</span><br><span class="line">| 0006       | 叉子         |      50000 |           NULL |</span><br><span class="line">| 0007       | 擦菜板       |      88000 |            198 |</span><br><span class="line">| 0008       | 圆珠笔       |        100 |           NULL |</span><br><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">8 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>根据字段 <code>sale_price</code> 的值进行升序排序</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_id, product_name, sale_price, purchase_price</span><br><span class="line"> FROM Product</span><br><span class="line">ORDER BY sale_price;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">| product_id | product_name | sale_price | purchase_price |</span><br><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">| 0008       | 圆珠笔       |        100 |           NULL |</span><br><span class="line">| 0002       | 打孔器       |        500 |            320 |</span><br><span class="line">| 0001       | T恤衫        |       1000 |            500 |</span><br><span class="line">| 0003       | 运动T恤      |       4000 |           2800 |</span><br><span class="line">| 0006       | 叉子         |      50000 |           NULL |</span><br><span class="line">| 0007       | 擦菜板       |      88000 |            198 |</span><br><span class="line">| 0004       | 菜刀         |     300000 |            700 |</span><br><span class="line">| 0005       | 高压锅       |     680000 |           1250 |</span><br><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>可以看到 <code>ORDER BY</code> 默认是按照升序的方式进行排序的，正式的书写方式应该是在字段后加上关键字 <code>ASC</code>，即 <code>ORDER BY sale_price ASC</code>。</p></li>
<li><p>降序排列</p>
<p>如果我们希望按照降序的方式，可以通过<code>DESC</code>关键词进行指定。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT product_id, product_name, sale_price, purchase_price</span><br><span class="line"> FROM Product</span><br><span class="line">ORDER BY sale_price DESC;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">| product_id | product_name | sale_price | purchase_price |</span><br><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">| 0005       | 高压锅       |     680000 |           1250 |</span><br><span class="line">| 0004       | 菜刀         |     300000 |            700 |</span><br><span class="line">| 0007       | 擦菜板       |      88000 |            198 |</span><br><span class="line">| 0006       | 叉子         |      50000 |           NULL |</span><br><span class="line">| 0003       | 运动T恤      |       4000 |           2800 |</span><br><span class="line">| 0001       | T恤衫        |       1000 |            500 |</span><br><span class="line">| 0002       | 打孔器       |        500 |            320 |</span><br><span class="line">| 0008       | 圆珠笔       |        100 |           NULL |</span><br><span class="line">+------------+--------------+------------+----------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>组合排序</p>
<p>前面展示了指定一个字段来对表进行排序，实际上我们可以指定多个字段来进行排序。</p>
<p>示例：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT regist_date, product_id, sale_price, purchase_price</span><br><span class="line"> FROM Product</span><br><span class="line">ORDER BY regist_date, product_id;</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-------------+------------+------------+----------------+</span><br><span class="line">| regist_date | product_id | sale_price | purchase_price |</span><br><span class="line">+-------------+------------+------------+----------------+</span><br><span class="line">| 2009-10-10  | 0002       |        500 |            320 |</span><br><span class="line">| 2009-10-10  | 0003       |       4000 |           2800 |</span><br><span class="line">| 2009-10-10  | 0004       |     300000 |            700 |</span><br><span class="line">| 2009-10-10  | 0005       |     680000 |           1250 |</span><br><span class="line">| 2009-10-10  | 0006       |      50000 |           NULL |</span><br><span class="line">| 2009-10-10  | 0007       |      88000 |            198 |</span><br><span class="line">| 2009-10-10  | 0008       |        100 |           NULL |</span><br><span class="line">| 2021-10-30  | 0001       |       1000 |            500 |</span><br><span class="line">+-------------+------------+------------+----------------+</span><br></pre></td></tr></table></figure></p>
<p>可以看到先按照 <code>regist_date</code> 的大小进行排序，在字段 <code>regist_date</code> 中具有相同的值的行，接着会按照 <code>product_id</code> 进行排序。</p>
<p><strong>Note:</strong> 使用含有 <code>NULL</code> 的列作为排序键时，<code>NULL</code> 会在结果的开头或末尾汇总显示。</p></li>
<li><p>定义别名</p>
<p>在 <code>ORDER BY</code> 子句中可以使用 <code>SELECT</code> 子句中定义的别名。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 将product_id命名为ID，然后按照ID进行排序</span><br><span class="line">SELECT product_id as ID, product_name, sale_price, purchase_price</span><br><span class="line"> FROM Product</span><br><span class="line">ORDER BY ID;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------+--------------+------------+----------------+</span><br><span class="line">| ID   | product_name | sale_price | purchase_price |</span><br><span class="line">+------+--------------+------------+----------------+</span><br><span class="line">| 0001 | T恤衫        |       1000 |            500 |</span><br><span class="line">| 0002 | 打孔器       |        500 |            320 |</span><br><span class="line">| 0003 | 运动T恤      |       4000 |           2800 |</span><br><span class="line">| 0004 | 菜刀         |     300000 |            700 |</span><br><span class="line">| 0005 | 高压锅       |     680000 |           1250 |</span><br><span class="line">| 0006 | 叉子         |      50000 |           NULL |</span><br><span class="line">| 0007 | 擦菜板       |      88000 |            198 |</span><br><span class="line">| 0008 | 圆珠笔       |        100 |           NULL |</span><br><span class="line">+------+--------------+------------+----------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p><strong>思考</strong>： 为什么 <code>ORDER BY</code> 中可以使用 <code>SELECT</code> 定义的别名呢？</p>
<p>这是因为在 <code>MySQL</code> 中，<code>ORDER BY</code>的执行次序在 <code>SELECT</code> 之后。</p></li>
</ul>
<h2 id="数据的插入及更新">2.7 数据的插入及更新</h2>
<h3 id="数据的插入">2.7.1 数据的插入</h3>
<p>通过命令<code>INSERT</code>，可以向表中插入数据：</p>
<ol type="1">
<li><p>往表中插入一行数据</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO &lt;表名&gt; (字段1, 字段2, 字段3, ……) VALUES (值1, 值2, 值3, ……);</span><br></pre></td></tr></table></figure></p></li>
<li><p>往表中插入多行数据</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO &lt;表名&gt; (字段1, 字段2, 字段3, ……) VALUES</span><br><span class="line">	(值1, 值2, 值3, ……),</span><br><span class="line">	(值1, 值2, 值3, ……),</span><br><span class="line">	...</span><br><span class="line">	;</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p>示例：</p>
<ul>
<li><p>创建表</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE ProductIns</span><br><span class="line">(product_id CHAR(4) NOT NULL,</span><br><span class="line"> product_name VARCHAR(100) NOT NULL,</span><br><span class="line"> product_type VARCHAR(32) NOT NULL,</span><br><span class="line"> sale_price INTEGER DEFAULT 0, -- DEFAULT 0：表示将字段sale_price的默认值设为0</span><br><span class="line"> purchase_price INT ,</span><br><span class="line"> regist_date DATE ,</span><br><span class="line"> PRIMARY KEY (product_id));</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>通过单行方式插入数据</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO</span><br><span class="line"> ProductIns(product_id, product_name, product_type, sale_price, purchase_price, regist_date)</span><br><span class="line"> VALUES (&#39;0001&#39;, &#39;打孔器&#39;, &#39;办公用品&#39;, 500, 320, &#39;2009-09-11&#39;);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br></pre></td></tr></table></figure></p>
<p><strong>Note:</strong> 当对表插入全字段时，可以省略表后的字段清单</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO ProductIns VALUES(&#39;0002&#39;, &#39;高压锅&#39;, &#39;厨房用具&#39;, 6800, 5000, &#39;2009-01-15&#39;);</span><br></pre></td></tr></table></figure></p></li>
<li><p>通过多行方式插入</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO ProductIns VALUES</span><br><span class="line"> (&#39;0003&#39;, &#39;菜刀&#39;, &#39;厨房用具&#39;, 3000, 2800, &#39;2009-09-20&#39;),</span><br><span class="line"> (&#39;0004&#39;, &#39;订书机&#39;, &#39;办公用品&#39;, 100, 50, &#39;2009-09-11&#39;),</span><br><span class="line"> (&#39;0005&#39;, &#39;裙子&#39;, &#39;衣服&#39;, 4100, 3200, &#39;2009-01-23&#39;),</span><br><span class="line"> (&#39;0006&#39;, &#39;运动T恤&#39;, &#39;衣服&#39;, 4000, 2800, NULL),</span><br><span class="line"> (&#39;0007&#39;, &#39;牙刷&#39;, &#39;日用品&#39;, 20, 10, &#39;2010-03-22&#39;);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 5 rows affected (0.01 sec)</span><br><span class="line">Records: 5  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p></li>
<li><p>查看数据</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM ProductIns;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| product_id | product_name | product_type | sale_price | purchase_price | regist_date |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| 0001       | 打孔器       | 办公用品     |        500 |            320 | 2009-09-11  |</span><br><span class="line">| 0002       | 高压锅       | 厨房用具     |       6800 |           5000 | 2009-01-15  |</span><br><span class="line">| 0003       | 菜刀         | 厨房用具     |       3000 |           2800 | 2009-09-20  |</span><br><span class="line">| 0004       | 订书机       | 办公用品     |        100 |             50 | 2009-09-11  |</span><br><span class="line">| 0005       | 裙子         | 衣服         |       4100 |           3200 | 2009-01-23  |</span><br><span class="line">| 0006       | 运动T恤      | 衣服         |       4000 |           2800 | NULL        |</span><br><span class="line">| 0007       | 牙刷         | 日用品       |         20 |             10 | 2010-03-22  |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>插入 <code>NULL</code></p>
<p><code>INSERT</code>语句中想给某一列赋予 <code>NULL</code> 值时，可以直接在<code>VALUES</code>子句的值清单中写入 <code>NULL</code>。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO ProductIns VALUES (&#39;0008&#39;, &#39;叉子&#39;, &#39;厨房用具&#39;, 500, NULL, &#39;2009-09-20&#39;);</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>插入默认值</p>
<p>在前面我们创建表时，字段 <code>sale_price</code> 包含了一条约束条件，默认为 <code>0</code>。我们在插入数据时，可以直接用<code>DEFAULT</code>对该字段赋值。前提是，该字段被指定了默认值。</p>
<ol type="1">
<li><p>通过显式方法设定默认值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO</span><br><span class="line"> ProductIns (product_id, product_name, product_type, sale_price, purchase_price, regist_date)</span><br><span class="line"> VALUES (&#39;0009&#39;, &#39;擦菜板&#39;, &#39;厨房用具&#39;, DEFAULT, 790, &#39;2009-04-28&#39;);</span><br></pre></td></tr></table></figure></li>
<li><p>通过隐式方法插入默认值</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO</span><br><span class="line"> ProductIns (product_id, product_name, product_type, purchase_price, regist_date)</span><br><span class="line"> VALUES (&#39;0010&#39;, &#39;擦菜板&#39;, &#39;厨房用具&#39;, 790, &#39;2009-04-28&#39;);</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h3 id="数据的删除">2.7.2 数据的删除</h3>
<p>通过 <code>DROP TABLE</code> 或者 <code>DELETE</code> 语句，可以对表进行删除，但二者存在一定的区别。</p>
<ol type="1">
<li><p><code>DROP TABLE</code> 语句可以将表完全删除。</p>
<p>语法结构为：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP &lt;表名&gt;;</span><br></pre></td></tr></table></figure></p></li>
<li><p><code>DELETE</code> 语句会留下表结构，而删除表中的全部数据，即 <code>DELETE</code>语句的删除对象并不是表或者列，而是记录（行）。</p>
<p>语法结构如下，记得要加<code>FROM</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELETE FROM &lt;表名&gt;;</span><br></pre></td></tr></table></figure></p>
<p>同时，也可以通过<code>WHERE</code>语句来指定删除的条件：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELETE FROM &lt;表名&gt;</span><br><span class="line">	WHERE &lt;条件&gt;;</span><br></pre></td></tr></table></figure></p>
<p><strong>Note:</strong> 无论通过哪种方式删除，数据都是难以恢复的。</p>
<ul>
<li><p><strong>Case</strong>：查看数据：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| product_id | product_name | product_type | sale_price | purchase_price | regist_date |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| 0001       | T恤衫        | 衣服         |       1000 |            500 | 2009-09-20  |</span><br><span class="line">| 0002       | 打孔器       | 办公用品     |        500 |            320 | 2009-09-11  |</span><br><span class="line">| 0003       | 运动T恤      | 衣服         |       4000 |           2800 | NULL        |</span><br><span class="line">| 0004       | 菜刀         | 厨房用具     |       3000 |           2800 | 2009-09-20  |</span><br><span class="line">| 0005       | 高压锅       | 厨房用具     |       6800 |           5000 | 2009-01-15  |</span><br><span class="line">| 0006       | 叉子         | 厨房用具     |        500 |           NULL | 2009-09-20  |</span><br><span class="line">| 0007       | 擦菜板       | 厨房用具     |        880 |            790 | 2008-04-28  |</span><br><span class="line">| 0008       | 圆珠笔       | 办公用品     |        100 |           NULL | 2009-11-11  |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>删除销售价格大于等于4000的行:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELETE FROM Product</span><br><span class="line"> WHERE sale_price &gt;&#x3D; 4000;</span><br><span class="line">    </span><br><span class="line">SELECT * FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| product_id | product_name | product_type | sale_price | purchase_price | regist_date |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| 0001       | T恤衫        | 衣服         |       1000 |            500 | 2009-09-20  |</span><br><span class="line">| 0002       | 打孔器       | 办公用品     |        500 |            320 | 2009-09-11  |</span><br><span class="line">| 0004       | 菜刀         | 厨房用具     |       3000 |           2800 | 2009-09-20  |</span><br><span class="line">| 0006       | 叉子         | 厨房用具     |        500 |           NULL | 2009-09-20  |</span><br><span class="line">| 0007       | 擦菜板       | 厨房用具     |        880 |            790 | 2008-04-28  |</span><br><span class="line">| 0008       | 圆珠笔       | 办公用品     |        100 |           NULL | 2009-11-11  |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
</ul></li>
<li><p>通过 <code>TRUNCATE</code>进行删除</p>
<p>在 <code>MySQL</code> 中，还存在一种删除表的方式，就是利用 <code>TRUNCATE</code> 语句。它的功能和 <code>DROP</code>类似，但是不能通过 <code>WHERE</code> 指定条件，优点是速度比 <code>DROP</code> 快得多。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TRUNCATE Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DESC Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field          | Type         | Null | Key | Default | Extra |</span><br><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">| product_id     | char(4)      | NO   | PRI | NULL    |       |</span><br><span class="line">| product_name   | varchar(100) | NO   |     | NULL    |       |</span><br><span class="line">| product_type   | varchar(32)  | NO   |     | NULL    |       |</span><br><span class="line">| sale_price     | int          | YES  |     | NULL    |       |</span><br><span class="line">| purchase_price | int          | YES  |     | NULL    |       |</span><br><span class="line">| regist_date    | date         | YES  |     | NULL    |       |</span><br><span class="line">+----------------+--------------+------+-----+---------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h3 id="数据的更新">2.7.3 数据的更新</h3>
<p>当我们使用 <code>INSERT</code> 语句插入错误的数据后，若我们不想删除后重新插入，那就要使用到 <code>UPDATE</code> 语句。</p>
<p><strong><code>UPDATE</code>的语法结构如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE &lt;表名&gt;</span><br><span class="line">	SET &lt;字段名&gt; &#x3D; &lt;表达式&gt;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>数据准备</p>
<p><strong>Note:</strong> 由于前面演示删除语句时，表 <code>Product</code> 的内容已清空，所以，这里重新进行数据插入）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO Product VALUES</span><br><span class="line">  (&#39;0001&#39;, &#39;T恤衫&#39;, &#39;衣服&#39;, 1000, 500, &#39;2009-09-20&#39;),</span><br><span class="line">  (&#39;0002&#39;, &#39;打孔器&#39;, &#39;办公用品&#39;, 500, 320, &#39;2009-09-11&#39;),</span><br><span class="line">  (&#39;0003&#39;, &#39;运动T恤&#39;, &#39;衣服&#39;, 4000, 2800, NULL),</span><br><span class="line">  (&#39;0004&#39;, &#39;菜刀&#39;, &#39;厨房用具&#39;, 3000, 2800, &#39;2009-09-20&#39;),</span><br><span class="line">  (&#39;0005&#39;, &#39;高压锅&#39;, &#39;厨房用具&#39;, 6800, 5000, &#39;2009-01-15&#39;),</span><br><span class="line">  (&#39;0006&#39;, &#39;叉子&#39;, &#39;厨房用具&#39;, 500, NULL, &#39;2009-09-20&#39;),</span><br><span class="line">  (&#39;0007&#39;, &#39;擦菜板&#39;, &#39;厨房用具&#39;, 880, 790, &#39;2008-04-28&#39;),</span><br><span class="line">  (&#39;0008&#39;, &#39;圆珠笔&#39;, &#39;办公用品&#39;, 100, NULL,&#39;2009-11-11&#39;)</span><br><span class="line"> ;</span><br></pre></td></tr></table></figure></li>
<li><p>修改表中所有行 <code>regist_date</code> 的值</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE Product</span><br><span class="line"> SET regist_date &#x3D; &#39;2009-10-10&#39;;</span><br><span class="line"></span><br><span class="line">SELECT * FROM Product;</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| product_id | product_name | product_type | sale_price | purchase_price | regist_date |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">| 0001       | T恤衫        | 衣服         |       1000 |            500 | 2009-10-10  |</span><br><span class="line">| 0002       | 打孔器       | 办公用品     |        500 |            320 | 2009-10-10  |</span><br><span class="line">| 0003       | 运动T恤      | 衣服         |       4000 |           2800 | 2009-10-10  |</span><br><span class="line">| 0004       | 菜刀         | 厨房用具     |       3000 |           2800 | 2009-10-10  |</span><br><span class="line">| 0005       | 高压锅       | 厨房用具     |       6800 |           5000 | 2009-10-10  |</span><br><span class="line">| 0006       | 叉子         | 厨房用具     |        500 |           NULL | 2009-10-10  |</span><br><span class="line">| 0007       | 擦菜板       | 厨房用具     |        880 |            790 | 2009-10-10  |</span><br><span class="line">| 0008       | 圆珠笔       | 办公用品     |        100 |           NULL | 2009-10-10  |</span><br><span class="line">+------------+--------------+--------------+------------+----------------+-------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p></li>
<li><p>指定条件:</p>
<p>语法结构为：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE &lt;表名&gt;</span><br><span class="line">	SET &lt;列名&gt; &#x3D; &lt;表达式&gt;</span><br><span class="line">	WHERE &lt;条件&gt;;</span><br></pre></td></tr></table></figure></p>
<p>指定 <code>product_id</code> 为 <code>0001</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE Product</span><br><span class="line"> SET regist_date &#x3D; &#39;2021-10-30&#39;</span><br><span class="line"> WHERE product_id &#x3D; &#39;0001&#39;;</span><br></pre></td></tr></table></figure></p>
<p><strong>Note:</strong> 也可使用 <code>NULL</code> 对表进行更新，不过更新的字段必须满足没有 <strong>主键</strong> 和 <code>NOT NULL</code> 的约束条件。</p></li>
<li><p>多列更新</p>
<p>多列更新只需要用逗号（，）连接更改的字段即可。</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE Product</span><br><span class="line"> SET</span><br><span class="line"> 	sale_price &#x3D; sale_price * 10,</span><br><span class="line">  purchase_price &#x3D; purchase_price &#x2F; 2</span><br><span class="line"> WHERE product_type &#x3D; &#39;厨房用具&#39;;</span><br></pre></td></tr></table></figure></p></li>
</ul>
<h2 id="pymysql-的使用">2.8 <code>Pymysql</code> 的使用</h2>
<p>在正式介绍<code>pymysql</code>的用法之前，我们先思考一件事，我们希望借助<code>pymysql</code>完成什么事情？</p>
<p>之前，我们在命令行下，通过输入SQL语句来完成对数据库和表的增删改查。那么，我们也希望能够在Python下能够完成同样的操作，并且能够返回相应的反馈。具体任务包括：</p>
<ol type="1">
<li>登陆并连接到MySQL下的用户；</li>
<li>切换到相应的数据库下；</li>
<li>完成对表的增删改查；</li>
</ol>
<p>接下来的内容将围绕这3部分来介绍。</p>
<h3 id="安装pymysql">2.8.1 安装pymysql</h3>
<p>通过<code>pip</code>，我们可以完成对<code>pymysql</code>的安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -m pip install PyMySQL</span><br></pre></td></tr></table></figure>
<h3 id="连接数据库">2.8.2 连接数据库</h3>
<p>如果希望在 <code>Python</code> 中操作 <code>MySQL</code> 数据库，那么首先就要登陆到 <code>MySQL</code> 下的用户。</p>
<p>我们通过创建库 <code>pymysql</code> 下的类 <code>connect</code> 的一个实例来登陆到数据库。</p>
<p>示例：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里登陆到我之前创建的admin账户</span></span><br><span class="line">db = pymysql.connect(</span><br><span class="line">     host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">     user=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">     password=<span class="string">&#x27;mysql123&#x27;</span>,</span><br><span class="line">     database=<span class="string">&#x27;shop&#x27;</span>,				</span><br><span class="line">     charset=<span class="string">&#x27;utf8mb4&#x27;</span>,</span><br><span class="line">     cursorclass=pymysql.cursors.DictCursor</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>参数解释：</p>
<ul>
<li><code>host</code>：数据库服务器地址，默认<code>localhost</code>；</li>
<li><code>user</code>：所要登陆的用户名；</li>
<li><code>password</code>：用户的登录密码；</li>
<li><code>database</code>：所要连接的数据库库名；</li>
<li><code>charset</code>：使用的字符类型；</li>
<li><code>cursorclass</code>：定义游标使用的类型，通过指定游标使用的类型，在返回输出的结果时将按照指定的类型进行返回。例如，这里设置为字典游标。</li>
</ul>
<p>Results:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pymysql.err.OperationalError: (<span class="number">1044</span>, <span class="string">&quot;Access denied for user &#x27;admin&#x27;@&#x27;localhost&#x27; to database &#x27;shop&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这说明给定的权限不足，需要修改相应权限，或赋予相应权限。退出 <code>python</code> 环境，进入 <code>mysql</code> 环境：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant all on *.* to &#39;admin&#39;@&#39;localhost&#39;;</span><br></pre></td></tr></table></figure>
<h3 id="创建游标">2.8.3 创建游标</h3>
<p>关于游标，可以理解为在命令行中的光标。在命令行中，我们是在光标处键入语句的。这里游标的起到类似作用。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建游标</span></span><br><span class="line">cursor = db.cursor()</span><br></pre></td></tr></table></figure>
<p>实际上，除了在初始化<code>connect</code>的实例时指定游标类型，我们在初始化游标时也可以指定游标类型，默认为元组类型。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cursor = db.cursor(cursor=pymysql.cursors.DictCursor)</span><br></pre></td></tr></table></figure>
<p><code>cursors</code>共支持四类游标：</p>
<ul>
<li><p><code>Cursor</code>: 默认，元组类型</p></li>
<li><p><code>DictCursor</code>: 字典类型</p></li>
<li><p><code>SSCursor</code>: 无缓冲元组类型</p></li>
<li><p><code>SSDictCursor</code>: 无缓冲字典类型</p></li>
</ul>
<h3 id="类方法">2.8.4 类方法</h3>
<p>初始化完类<code>connect</code>和<code>cursor</code>的实例后，我们先来了解一下这两个类下包含的方法。了解这些方法有利于我们后面在python下操作mysql：</p>
<ul>
<li><code>connect</code>下的类方法：
<ul>
<li><code>close()</code>：在完成操作后，需要关闭与数据库之间的连接；</li>
<li><code>commit()</code>：如果执行语句中发生了数据更改，需要提交更改到稳定的存储器；</li>
<li><code>cursor(cursor=None)</code>：创建一个游标，前面我们在初始化<code>connect</code>类是指定了游标类型，通过<code>cursor</code>初始化游标时，也可以进行游标类型指定；</li>
<li><code>rollback()</code>：事务回滚；</li>
</ul></li>
<li><code>pymysql.cursors</code>下的类方法：
<ul>
<li><code>close()</code>：结束时，关闭游标；</li>
<li><code>execute()</code>：通过游标执行语句；</li>
<li><code>executemany()</code>：通过游标执行多条语句；</li>
<li><code>fetchone()</code>：获取单条数据；</li>
<li><code>fetchmany(size=None)</code>：获取size条数据；</li>
<li><code>fetchall()</code>：获取单条数据；</li>
<li><code>scroll(value, mode)</code>：数据的查询操作都是基于游标，可以通过<code>scroll</code>控制游标的位置。
<ul>
<li><code>mode=absolute</code>：绝对位置移动，控制游标位置到上一次查询的第<code>value</code>条数据，最小值为<code>0</code>；</li>
<li><code>mode=relative</code>：相对位置移动，基于当前位置，跳过<code>value</code>条数据；</li>
</ul></li>
</ul></li>
</ul>
<p>更详细的资料，可参考官方的 <a href="https://pymysql.readthedocs.io/en/latest/modules/index.html#">API</a> 或者 <a href="https://github.com/PyMySQL/PyMySQL">Github</a>。</p>
<h3 id="实战">2.8.5 实战</h3>
<p>在此次实战中，我们使用 <code>Ubuntu</code> 平台来进行实战演练，由于未使用图形界面，因此，我们先进行前置工作，安装 <code>vim</code> 来编写 <code>python</code> 脚本文件。</p>
<ul>
<li><p>安装 <code>Git</code></p>
<p>首先我们先安装 <code>git</code> 工具。 <code>Git</code> 是一个开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目。命令行安装：</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure></p></li>
<li><p>安装 <code>vim</code></p>
<p><code>Vim</code> 是从 <code>vi</code> 发展出来的一个文本编辑器。代码补完、编译及错误跳转等方便编程的功能特别丰富，在程序员中被广泛使用。和 <code>Emacs</code> 并列成为类 <code>Unix</code> 系统用户最喜欢的编辑器。 安装步骤：</p>
<p><strong>(1) 首先将vim的源码克隆下来，这里因为github可能很慢，使用码云的镜像</strong></p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://gitee.com/mirrors/vim.git</span><br></pre></td></tr></table></figure></p>
<p><strong>(2) 安装gcc（有则不必安装）和各依赖库</strong></p>
<p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">sudo apt<span class="literal">-get</span> install gcc</span><br><span class="line"></span><br><span class="line">sudo apt<span class="literal">-get</span> install libncurses5<span class="literal">-dev</span> python<span class="literal">-dev</span> python3<span class="literal">-dev</span> libatk1.<span class="number">0</span><span class="literal">-dev</span> libcairo2<span class="literal">-dev</span> libx11<span class="literal">-dev</span> libxpm<span class="literal">-dev</span> libxt<span class="literal">-dev</span></span><br></pre></td></tr></table></figure></p>
<p><strong>(3) 配置与安装</strong>（<code>vim</code> 目录）</p>
<p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo ./configure --with-features=huge --enable-multibyte --enable-rubyinterp --enable-pythoninterp --enable-python3interp --enable-luainterp --enable-cscope --enable-gui=gtk3 --enable-perlinterp --with-python-config-dir=/usr/lib/python2.7/config-x86_64-linux-gnu/ --with-python3-config-dir=/usr/lib/python3.6/config-3.6m-x86_64-linux-gnu/ --prefix=/usr/local/vim8</span><br></pre></td></tr></table></figure></p>
<ul>
<li>with-features=huge：支持最大特性</li>
<li>enable-rubyinterp：打开对 ruby 编写的插件的支持</li>
<li>enable-pythoninterp：打开对 python 编写的插件的支持</li>
<li>enable-python3interp：打开对 python3 编写的插件的支持</li>
<li>enable-luainterp：打开对 lua 编写的插件的支持</li>
<li>enable-perlinterp：打开对 perl 编写的插件的支持</li>
<li>enable-multibyte：打开多字节支持，可以在 Vim 中输入中文</li>
<li>enable-cscope：打开对cscope的支持</li>
<li>enable-gui=gtk3 表示生成采用 GNOME3 风格的 gvim</li>
<li>with-python-config-dir=/usr/lib/python2.7/config-x86_64-linux-gnu/ 指定 python 路径</li>
<li>with-python3-config-dir=/usr/lib/python3.6/config-3.6m-x86_64-linux-gnu/ 指定 python3路径(这里可以根据自己的版本做更改)</li>
<li>prefix=/usr/local/vim8：指定将要安装到的路径</li>
</ul>
<p><strong>Note:</strong> 更多有关 <code>Linux</code> 和 <code>Vim</code> 的相关操作，请查看本文博文 <a href="https://www.yangsuoly.com/2020/11/23/Linux/">Linux notes</a>，此处不再进行赘述。</p></li>
</ul>
<h4 id="case-operation">Case Operation：</h4>
<p>在这个示例中，我们将做两件事情：创建表和插入数据。</p>
<ul>
<li><p>创建 <code>sql_test1.py</code> 文件</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch sql_test1.py</span><br></pre></td></tr></table></figure></p></li>
<li><p>使用 <code>vim</code> 进行编辑</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim sql_test1.py</span><br></pre></td></tr></table></figure></p></li>
<li><p>输入 <code>python</code> 代码</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以admin身份连接到数据库shop</span></span><br><span class="line">connection = pymysql.connect(</span><br><span class="line">    host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    user=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    password=<span class="string">&#x27;mysql123&#x27;</span>,</span><br><span class="line">    database=<span class="string">&#x27;shop&#x27;</span>,</span><br><span class="line">    charset=<span class="string">&#x27;utf8mb4&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建游标</span></span><br><span class="line">cursor = connection.cursor(cursor=pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止再次运行代码时报错，我们加一个删除表格的操作，如果时第一运行改代码，comment 下面两行</span></span><br><span class="line">sql = <span class="string">&#x27;DROP TABLE Employee&#x27;</span></span><br><span class="line">cursor.execute(sql)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 创建了一个表</span></span><br><span class="line">sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">CREATE TABLE Employee(</span></span><br><span class="line"><span class="string">    id INT PRIMARY KEY,</span></span><br><span class="line"><span class="string">    name CHAR(15) NOT NULL</span></span><br><span class="line"><span class="string">    )</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交执行</span></span><br><span class="line">cursor.execute(sql)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 往表中插入数据</span></span><br><span class="line">sql = <span class="string">&quot;INSERT INTO Employee (id, name) VALUES (%s, %s)&quot;</span></span><br><span class="line">values = [(<span class="number">1</span>, <span class="string">&#x27;XiaoBai&#x27;</span>),</span><br><span class="line">          (<span class="number">2</span>, <span class="string">&#x27;XiaoHei&#x27;</span>),</span><br><span class="line">          (<span class="number">3</span>, <span class="string">&#x27;XiaoHong&#x27;</span>),</span><br><span class="line">          (<span class="number">4</span>, <span class="string">&#x27;XiaoMei&#x27;</span>),</span><br><span class="line">          (<span class="number">5</span>, <span class="string">&#x27;XiaoLi&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">		<span class="comment"># 通过executemany可以插入多条数据</span></span><br><span class="line">    cursor.executemany(sql, values)</span><br><span class="line">    <span class="comment"># 提交事务</span></span><br><span class="line">    connection.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    connection.rollback()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 关闭光标及连接</span></span><br><span class="line">cursor.close()</span><br><span class="line">connection.close()</span><br></pre></td></tr></table></figure></p></li>
<li><p>运行 <code>sql_test1.py</code></p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sql_test1.py</span><br></pre></td></tr></table></figure></p></li>
<li><p>进行查询</p>
<p>接下来，继续执行查询工作。首先创建 <code>sql_test2.py</code> 并使用 <code>vim</code> 进行编辑：</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch sql_test2.py</span><br><span class="line"></span><br><span class="line">vim sql_test2.py</span><br></pre></td></tr></table></figure></p>
<p>编写代码：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以admin身份连接到数据库shop</span></span><br><span class="line">connection = pymysql.connect(</span><br><span class="line">    host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    user=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    password=<span class="string">&#x27;mysql123&#x27;</span>,</span><br><span class="line">    database=<span class="string">&#x27;shop&#x27;</span>,</span><br><span class="line">    charset=<span class="string">&#x27;utf8mb4&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> connection:</span><br><span class="line">    <span class="comment"># 创建游标</span></span><br><span class="line">    cursor = connection.cursor(cursor=pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. 通过fetchone只查询一条</span></span><br><span class="line">    cursor.execute(<span class="string">&quot;SHOW CREATE TABLE Employee&quot;</span>)</span><br><span class="line">    result = cursor.fetchone()</span><br><span class="line">    print(<span class="string">f&#x27;查询结果1： \n<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 通过fetchmany查询size条</span></span><br><span class="line">    cursor.execute(<span class="string">&quot;DESC Employee&quot;</span>)</span><br><span class="line">    result = cursor.fetchmany(size=<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">f&#x27;查询结果2： \n<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 通过fetchall查询所有</span></span><br><span class="line">    cursor.execute(<span class="string">&quot;SELECT * FROM Employee&quot;</span>)</span><br><span class="line">    result = cursor.fetchall()</span><br><span class="line">    print(<span class="string">f&#x27;查询结果3： \n<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. 通过scroll回滚到第0条进行查询</span></span><br><span class="line">    cursor.scroll(<span class="number">0</span>, mode=<span class="string">&#x27;absolute&#x27;</span>)</span><br><span class="line">    result = cursor.fetchone()</span><br><span class="line">    print(<span class="string">f&#x27;查询结果4： \n<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. 通过scroll跳过2条进行查询</span></span><br><span class="line">    cursor.scroll(<span class="number">2</span>, mode=<span class="string">&#x27;relative&#x27;</span>)</span><br><span class="line">    result = cursor.fetchone()</span><br><span class="line">    print(<span class="string">f&#x27;查询结果5： \n<span class="subst">&#123;result&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cursor.close()</span><br></pre></td></tr></table></figure></p>
<p>运行脚本文件：</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sql_test2.py</span><br></pre></td></tr></table></figure></p>
<p>Results:</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">查询结果<span class="number">1</span>：</span><br><span class="line">&#123;<span class="string">&#x27;Table&#x27;</span>: <span class="string">&#x27;Employee&#x27;</span>, <span class="string">&#x27;Create Table&#x27;</span>: <span class="string">&#x27;CREATE TABLE `Employee` (\n  `id` int NOT NULL,\n  `name` char(15) NOT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci&#x27;</span>&#125;</span><br><span class="line">查询结果<span class="number">2</span>：</span><br><span class="line">[&#123;<span class="string">&#x27;Field&#x27;</span>: <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;Type&#x27;</span>: <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;Null&#x27;</span>: <span class="string">&#x27;NO&#x27;</span>, <span class="string">&#x27;Key&#x27;</span>: <span class="string">&#x27;PRI&#x27;</span>, <span class="string">&#x27;Default&#x27;</span>: <span class="literal">None</span>, <span class="string">&#x27;Extra&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;, &#123;<span class="string">&#x27;Field&#x27;</span>: <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Type&#x27;</span>: <span class="string">&#x27;char(15)&#x27;</span>, <span class="string">&#x27;Null&#x27;</span>: <span class="string">&#x27;NO&#x27;</span>, <span class="string">&#x27;Key&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;Default&#x27;</span>: <span class="literal">None</span>, <span class="string">&#x27;Extra&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;]</span><br><span class="line">查询结果<span class="number">3</span>：</span><br><span class="line">[&#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoBai&#x27;</span>&#125;, &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoHei&#x27;</span>&#125;, &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoHong&#x27;</span>&#125;, &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoMei&#x27;</span>&#125;, &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoLi&#x27;</span>&#125;]</span><br><span class="line">查询结果<span class="number">4</span>：</span><br><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoBai&#x27;</span>&#125;</span><br><span class="line">查询结果<span class="number">5</span>：</span><br><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoMei&#x27;</span>&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p>插入数据</p>
<p>接下来使用 <code>sql_test3.py</code> 脚本演示 <code>SQL</code> 注入的问题。首先生成脚本文件并进入 <code>vim</code> 编辑模式：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch sql_test3.py</span><br><span class="line"></span><br><span class="line">vim sql_test3.py</span><br></pre></td></tr></table></figure>
<p>先建立一个表并插入数据：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以admin身份连接到数据库shop</span></span><br><span class="line">connection = pymysql.connect(</span><br><span class="line">    host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    user=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    password=<span class="string">&#x27;mysql123&#x27;</span>,</span><br><span class="line">    database=<span class="string">&#x27;shop&#x27;</span>,</span><br><span class="line">    charset=<span class="string">&#x27;utf8mb4&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建游标</span></span><br><span class="line">cursor = connection.cursor(cursor=pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止再次运行代码时报错，我们加一个删除表格的操作，如果时第一运行改代码，comment 下面两行</span></span><br><span class="line">sql = <span class="string">&#x27;DROP TABLE UserInfo&#x27;</span></span><br><span class="line">cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        CREATE TABLE UserInfo(</span></span><br><span class="line"><span class="string">          id INT PRIMARY KEY,</span></span><br><span class="line"><span class="string">          name VARCHAR(15),</span></span><br><span class="line"><span class="string">          password CHAR(15) NOT NULL</span></span><br><span class="line"><span class="string">          )</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">sql = <span class="string">&quot;INSERT INTO UserInfo (id, name, password) VALUES (%s, %s, %s)&quot;</span></span><br><span class="line">values = [(<span class="number">1</span>, <span class="string">&#x27;XiaoBai&#x27;</span>, <span class="string">&#x27;123&#x27;</span>),</span><br><span class="line">          (<span class="number">2</span>, <span class="string">&#x27;XiaoHei&#x27;</span>, <span class="string">&#x27;234&#x27;</span>),</span><br><span class="line">          (<span class="number">3</span>, <span class="string">&#x27;XiaoHong&#x27;</span>, <span class="string">&#x27;567&#x27;</span>),</span><br><span class="line">          (<span class="number">4</span>, <span class="string">&#x27;XiaoMei&#x27;</span>, <span class="string">&#x27;321&#x27;</span>),</span><br><span class="line">          (<span class="number">5</span>, <span class="string">&#x27;XiaoLi&#x27;</span>, <span class="string">&#x27;789&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">cursor.executemany(sql, values)</span><br><span class="line">connection.commit()</span><br><span class="line">cursor.close()</span><br></pre></td></tr></table></figure></p></li>
<li><p>读取信息进行登录验证</p>
<p>接下来，我们再写一个程序，根据刚刚插入的数据来判定账号信息是否匹配。</p>
<p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">touch sql_test4.py</span><br><span class="line"></span><br><span class="line">vim sql_test4.py</span><br></pre></td></tr></table></figure></p>
<p>编辑脚本进行账户验证：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以admin身份连接到数据库shop</span></span><br><span class="line">connection = pymysql.connect(</span><br><span class="line">    host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    user=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    password=<span class="string">&#x27;mysql123&#x27;</span>,</span><br><span class="line">    database=<span class="string">&#x27;shop&#x27;</span>,</span><br><span class="line">    charset=<span class="string">&#x27;utf8mb4&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建游标</span></span><br><span class="line">cursor = connection.cursor(cursor=pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    user = <span class="built_in">input</span>(<span class="string">&quot;输入用户：&quot;</span>).strip()</span><br><span class="line">    password = <span class="built_in">input</span>(<span class="string">&quot;输入密码：&quot;</span>).strip()</span><br><span class="line">    sql = <span class="string">&quot;select name, password from UserInfo where name=&#x27;%s&#x27; and password=&#x27;%s&#x27; &quot;</span> % (user, password)</span><br><span class="line"></span><br><span class="line">    cursor.execute(sql)</span><br><span class="line">    <span class="comment"># 打印用户和密码</span></span><br><span class="line">    result=cursor.fetchone()</span><br><span class="line">    print(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        print(<span class="string">&quot;成功登陆\n&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&quot;登陆失败\n&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<p>在控制台下，我们进行了三组用户和密码的验证：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">输入用户：XiaoBai</span><br><span class="line">输入密码：<span class="number">123</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoBai&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;</span><br><span class="line">成功登陆</span><br><span class="line"></span><br><span class="line">输入用户：XiaoBai</span><br><span class="line">输入密码：<span class="number">321</span></span><br><span class="line"><span class="literal">None</span></span><br><span class="line">登陆失败</span><br><span class="line"></span><br><span class="line">输入用户：XiaoBai<span class="string">&#x27; -- dsd&#x27;</span></span><br><span class="line">输入密码：<span class="number">321</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;XiaoBai&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;</span><br><span class="line">成功登陆</span><br></pre></td></tr></table></figure></p>
<p>可以看出，第1组和第2组验证正常，但是第三组出现了异常，输入错误的密码却可以正确登陆。</p>
<p>这是因为在MySQL中 <code>--</code> 的含义是注释，如果通过字符串进行拼接：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select name, password from UserInfo where name&#x3D;&#39;XiaoBai&#39; -- dsd&#39; and password&#x3D;&#39;321&#39;</span><br></pre></td></tr></table></figure></p>
<p>实际等价于：</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sselect name, password from UserInfo where name&#x3D;&#39;XiaoBai&#39;</span><br></pre></td></tr></table></figure></p>
<p>解决办法：通过 <code>execute</code> 或者 <code>executemany</code> 来进行拼接。将语句：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sql = <span class="string">&quot;select name, password from UserInfo where name=&#x27;%s&#x27; and password=&#x27;%s&#x27; &quot;</span> % (user, password)</span><br><span class="line">cursor.execute(sql)</span><br></pre></td></tr></table></figure></p>
<p>改为：</p>
<p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sql = <span class="string">&quot;select name, password from UserInfo where name=%s and password=%s&quot;</span></span><br><span class="line">cursor.execute(sql, (user, password))</span><br></pre></td></tr></table></figure></p></li>
</ul>
]]></content>
      <categories>
        <category>DataWhale</category>
        <category>Recommentation</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Recommentation</tag>
      </tags>
  </entry>
  <entry>
    <title>Stata</title>
    <url>/2021/03/18/Stata/</url>
    <content><![CDATA[<h1 id="stata-data-operation">1 Stata data operation</h1>
<h2 id="data-operation">1.1 Data Operation</h2>
<h3 id="browse-data">1.1.1 Browse data</h3>
<ul>
<li><p>browse / edit</p>
<p><code>browse</code> 用于打开或编辑数据浏览器，相当于单击数据浏览器或编辑按钮。命令格式:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">browse</span>/<span class="keyword">edit</span> [<span class="keyword">varlist</span>] [<span class="keyword">if</span>] [<span class="keyword">in</span>]</span><br></pre></td></tr></table></figure></li>
<li><p>rename</p>
<p><code>rename</code> 用于对变量重新命名。格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">rename</span> (oldname) (newname)</span><br></pre></td></tr></table></figure></li>
</ul>
<a id="more"></a>
<ul>
<li><p>save</p>
<p><code>save</code> 用于将内存中的数据保存到硬盘上。基本格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">save</span> [filename] [, save_options]</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="import-data">1.1.2 Import data</h3>
<p><strong>导入原则</strong>：</p>
<ol type="1">
<li><p>打开新数据集之前，必须用 <code>clear</code> 命令清除存在于内存中的数据集；</p></li>
<li><p>如果某些数据集超出了现有的设定的内存空间，则需要使用 <code>set memory</code> 来设定内存空间大小；</p></li>
<li><p>使用 <code>use</code> 命令读入 Stata 格式数据，使用 <code>edit</code> 命令输入数据；</p></li>
<li><p>使用 excel 文件复制粘贴数据。</p></li>
<li><p>use</p></li>
</ol>
<p>读取 Stata 自身数据的命令，基本语法：</p>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> filename [, <span class="keyword">clear</span> nolabel]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clear: 指明目前内存中的数据尚未保存，仍然可以用新的数据来代替它</span></span><br><span class="line"><span class="comment">// Nolabel：在载入数据时不载入相关的标签</span></span><br></pre></td></tr></table></figure></p>
<h3 id="descriptive-commands">1.1.3 Descriptive commands</h3>
<ul>
<li><p><code>describe</code></p>
<p><code>describe</code> 用于产生一个对数据集的简明总结表格。输出的结果中包含每个变量的名称、存储方式（<code>byte</code>、<code>float</code>，<code>double</code> 和 <code>int</code>）、显示格式、变量标签和变量值标签。命令格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">describe</span> [<span class="keyword">varlist</span>] [, memory_options]</span><br><span class="line"><span class="keyword">d</span> [<span class="keyword">varlist</span>] [, memory_options]</span><br></pre></td></tr></table></figure>
<p>memory_options:</p>
<ul>
<li>simple(si): display only variable names;</li>
<li>short(s): display only general information;</li>
<li>fullnames(f): do not abbreviate variable names;</li>
<li>numbers(n): display variable number along with name;</li>
</ul></li>
<li><p><code>list</code></p>
<p><code>list</code> 用于显示变量的数值，其后可以跟需要显示的变量名称。如果没有设定变量，则默认显示所有的变量数值。命令格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">list</span> [<span class="keyword">varlist</span>]] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, options]</span><br><span class="line"><span class="keyword">l</span> [<span class="keyword">varlist</span>]] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, options]</span><br></pre></td></tr></table></figure></li>
<li><p><code>codebook</code></p>
<p><code>codebook</code> 用于详尽地描述变量的内容，包括变量名称、变量标签和变量的赋值。基本格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">codebook</span> [<span class="keyword">varlist</span>] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, options]</span><br></pre></td></tr></table></figure></li>
<li><p><code>summarize</code></p>
<p><code>summarize</code> 命令计算并显示各种单变量摘要统计信息。如果未指定 <code>varlist</code>，则计算数据集中所有变量的摘要统计信息。对于任何的数据分析，使用 <code>summarize</code> 命令进行数据的核对都是很有必要的，尤其对于缺失值、无效值、奇异值的探测都很有帮助。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">summarize</span> [<span class="keyword">varlist</span>] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br></pre></td></tr></table></figure>
<p>其中，<code>varlist</code>表示需要统计的变量，<code>if</code>为样本条件，<code>in</code>为样本范围，<code>weight</code>为样本权重。</p></li>
<li><p><code>tabstat</code></p>
<p><code>tabstat</code> 命令主要用于统计量组合，与 <code>summarize</code> 类似。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">tabstat</span> <span class="keyword">varlist</span>  [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">`options`选项中的 `stat` ：示设定所需要的统计量，`col` ：将结果报表转置。</span></span><br><span class="line"><span class="comment">统计量主要有平均数、观测值数目，求和，平均标准误差等。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">generate</span> lwage = <span class="built_in">log</span>(wage)</span><br><span class="line"><span class="keyword">tabstat</span> wage lwage, stat(<span class="keyword">count</span> <span class="keyword">mean</span> p50 p75 skewness <span class="keyword">median</span>)</span><br><span class="line"><span class="keyword">tabstat</span> wage lwage, stat(<span class="keyword">count</span> <span class="keyword">mean</span> p50 p75 skewness <span class="keyword">median</span>) col(stat)</span><br><span class="line"><span class="keyword">tabstat</span> wage lwage, <span class="keyword">by</span>(married) stat(<span class="keyword">count</span> <span class="keyword">mean</span> p50 p75 skewness <span class="keyword">median</span>) col(stat)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62AzJe.png" /></p></li>
</ul>
<h3 id="merge-data">1.1.4 Merge data</h3>
<ul>
<li><p>Horizontal merge</p>
<p>横向合并是指将两个数据文件的变量加总在一起。合并后数据的样本不变，但变量的数目增加了，使得数据文件变宽。横向合并的两个数据的样本是一样的，只是被存储在不同的数据文件里。横向合并主要通过命令 <code>merge</code> 完成。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">merge</span> [<span class="keyword">varlist</span>] using filename [filename...][, option]</span><br><span class="line"></span><br><span class="line"><span class="keyword">merge</span> 1: 1 make using autocost <span class="comment">// 对make变量进行1比1合并autocost文件</span></span><br></pre></td></tr></table></figure></li>
<li><p>Vertical Merge</p>
<p>纵向合并指的是把两个数据的样本加总在一起，合并后的数据变量数目不变，但样本数增加了，使得数据变长了。</p>
<p>最常见的纵向合并情况是使用同样的问卷在不同地方或不同时间调查得来的数据。合并步骤主要包括：</p>
<ul>
<li>两个数据文件里相同变量的变量名要一致</li>
<li>两个数据文件里相同变量的变量数目一致</li>
<li>两个数据文件里个案序号不能重复</li>
<li>每个数据要生成一个新的变量来辨别合并后该数据的样本</li>
</ul>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">append</span> using filename [filename...][, option]</span><br><span class="line"></span><br><span class="line"><span class="keyword">merge</span> 1: 1 make using autocost <span class="comment">// 对make变量进行1比1合并autocost文件</span></span><br></pre></td></tr></table></figure></li>
<li><p>Cross Merge</p>
<p>交叉合并指的是把一个数据的个案和另外一个数据的个案交叉搭配生成新的数据。从数据的结构和用途上讲，交叉合并要比纵向和横向合并更加复杂。交叉合并有两类：</p>
<ul>
<li><p>组内交叉：<code>joinby</code> 命令；</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">joinby</span> [<span class="keyword">varlist</span>] using filename [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> child</span><br><span class="line"><span class="keyword">webuse</span> parent</span><br><span class="line">descirbe</span><br><span class="line"><span class="keyword">list</span>, sep(0)</span><br><span class="line"><span class="keyword">sort</span> family_id</span><br><span class="line"><span class="keyword">joinby</span> family_id using https:<span class="comment">//www.stata-press.com/data/r16/child</span></span><br><span class="line"><span class="comment">// 组内合并，将 child 文件中的多余数据交叉合并到 parent中，重复的变量以parent为准</span></span><br></pre></td></tr></table></figure></li>
<li><p>一一交叉：<code>cross</code> 命令。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cross</span> using filename</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> str6 sex <span class="comment">// create sex dataset</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">sex variable:</span></span><br><span class="line"><span class="comment">        sex</span></span><br><span class="line"><span class="comment">1\. male</span></span><br><span class="line"><span class="comment">2\. female</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">then, save sex dataset and drop it from memory</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> agecat <span class="comment">// create agecat dataset</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">      agecat</span></span><br><span class="line"><span class="comment">1\. 20</span></span><br><span class="line"><span class="comment">2\. 30</span></span><br><span class="line"><span class="comment">3\. 40</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cross</span> using sex <span class="comment">//</span></span><br><span class="line"><span class="keyword">list</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62AoRJ.png" /></p></li>
</ul></li>
</ul>
<h3 id="data-extraction">1.1.5 Data extraction</h3>
<p>对于一些大型的数据，如人口普查数据和计算机记录的市场交易数据，因为其样本量太大，不适宜直接进行分析。最常用的方法是从数据中随机抽取一个样本，然后对样本进行分析，通常使用 <code>sample</code> 命令完成。语法格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sample</span> # [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, <span class="keyword">count</span> <span class="keyword">by</span> (groupvars)]~~~~</span><br><span class="line"><span class="comment">// 随机从内存里的数据中抽取样本，# 是样本容量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> nlswork</span><br><span class="line"><span class="keyword">describe</span>, short</span><br><span class="line"><span class="keyword">sample</span> 10</span><br><span class="line"><span class="keyword">describe</span>, short</span><br></pre></td></tr></table></figure>
<h3 id="数据处理">1.1.6 数据处理</h3>
<ul>
<li><p>z 得分</p>
<p><code>Z</code> 得分，也叫标准分数（<code>standard score</code>），是一个数与平均数的差再除以标准差的过程。在统计学中，标准分数是一个观测或数据点的值高于被观测值或测量值的平均值的标准差的符号数。等于一个观测值是否异常最方便的方法就是计算 <code>Z</code> 得分。</p>
<p>根据切比雪夫法则，不论数据的分布是什么形状，都至少有 <code>3/4</code> 的测量值落在平均值的两个标准差的范围内，至少有 <code>8/9</code>的测量值落在均值的三个标准差范围内。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">quietly</span> <span class="keyword">summarize</span> wage</span><br><span class="line"><span class="keyword">generate</span> z = (wage - <span class="built_in">r</span>(<span class="keyword">mean</span>))</span><br><span class="line"><span class="keyword">list</span> wage z <span class="keyword">if</span> z &gt; 3</span><br></pre></td></tr></table></figure></li>
<li><p>箱线图</p>
<p>箱线图在数据探索中有巨大的作用。箱线图一般指箱型图。箱型图 (<code>Box-plot</code>) 又称为盒须图、盒式图或箱线图，是一种用作显示一组数据分散情况资料的统计图。因形状如箱子而得名。在各种领域也经常被使用，常见于品质管理。它主要用于反应原始数据分散的特征。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">graph</span> box yvars [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"><span class="keyword">graph</span> hbox yvars [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">graph</span> box wage</span><br><span class="line"><span class="keyword">graph</span> hbox wage, over(married)</span><br><span class="line"><span class="keyword">graph</span> hbox wage, over(married, <span class="keyword">sort</span>(<span class="keyword">l</span>))</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62ESRH.md.png" /></p>
<center>
<p>Fig 箱型图</p>
</center></li>
<li><p>分位正态图</p>
<p>利用分位正态图可以判断一个变量的分布是否近似于正态。基本语法： <figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">qnorm</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">qnorm</span> wage, grid</span><br></pre></td></tr></table></figure> Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62Epzd.md.png" /></p>
<center>
<p>Fig 分位正态图</p>
</center>
<p>命令独有的选项是 <code>grid</code>。加入 <code>grid</code> 选项可以在图中依次标注 0.05、0.10、0.25、0.50、0.75、0.90、0.95 百分位数的坐标刻度。分位正态图将观测变量分布的分位数 (<code>y</code> 轴) 与一个具有相同平均数和标准查的理论正态分布的分位数进行比较 (<code>x</code> 轴)，这样可以就变量分布的每个部分对正态性的偏离进行直观的审查。</p></li>
<li><p>偏度-峰度正态性统计检验</p>
<p>偏度衡量随机变量概率分布的不对称性，是相对于平均值不对称程度的度量，通过对偏度系数的测量，我们能够判定数据分布的不对称程度以及方向。</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62EPsI.md.png" /></p>
<center>
<p>Fig 偏度</p>
</center>
<p>峰度，是研究数据分布陡峭或平滑的统计量，通过对峰度系数，可以判定数据相对于正态分布而言是更陡峭还是平缓。</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62ECQA.png" /></p>
<center>
<p>Fig 峰度</p>
</center>
<p>基本语法： <figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sktest</span> <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, noadjust]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">sktest</span> tenure</span><br></pre></td></tr></table></figure></p>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62EiLt.md.png" /></p>
<center>
<p>Fig. 偏度-峰度检验</p>
</center>
<p>其中，<code>kurtosis</code> 的 <code>P</code> 值检验为 0，落入拒绝域，说明不满足正态分布（<code>P</code> 值检验口诀：大同小异。小于 0.0000，说明落入拒绝域）。</p></li>
<li><p><code>Shapiro-Wilk</code> <code>W</code> 统计检验</p>
<p>夏皮罗-威尔克检验 (<code>shapiro-wilk test</code>) 是一种在频率上统计检验中检验正态性的方法。它在 1965 年由夏皮罗和威尔克发表。<code>W</code> 检验基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">swilk</span> <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, options]</span><br></pre></td></tr></table></figure></li>
<li><p><code>Pearson</code> 相关系数</p>
<p><code>Pearson</code> 相关系数又叫相关系数或自相关系数，一般用字母 <code>r</code> 表示，由两个变量的样本取值得到。是关于描述性相关强度的量，取值于 <code>-1</code> 和 <code>1</code> 之间。当两个变量有很强的线性相关时，相关系数接近于 <code>1</code> (正相关) 或 <code>-1</code> (负相关)。</p>
<p><code>correlate</code> 命令计算变量之间的 <code>Pearson</code> 相关系数或者协方差矩阵，如果不指定变量，则默认对数据集中的所有变量计算响应的矩阵。<code>pwcorr</code> 命令的好处是尽可能使用两两变量中所有没有缺失的数据，而不像 <code>correlate</code> 只采用没有任何缺失数据的完整的观测值。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">correlate</span> [<span class="keyword">varlist</span>] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, correlate_options]</span><br><span class="line"><span class="keyword">pwcorr</span> [<span class="keyword">varlist</span>] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, pwcorr_options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">correlate</span> wage hours tenure <span class="comment">// 相关系数</span></span><br><span class="line"><span class="keyword">correlate</span> wage hours tenure, covariance <span class="comment">// 协方差</span></span><br><span class="line"><span class="keyword">pwcorr</span> wage hours tenure, sig star(.05) <span class="keyword">print</span>(.05)</span><br></pre></td></tr></table></figure></li>
<li><p><code>Spearman</code> 相关系数</p>
<p><code>Spearman</code> 相关系数是衡量两个变量的依赖性的非参数指标。它利用单调方程评价两个统计变量的相关性。不管变量之间的关系是不是线性的，只要变量之间具有严格的单调增加的函数关系，变量之间的斯皮尔曼相关系数就是 <code>1</code>。如果数据中没有重复值，并且当两个变量完全单调相关时，斯皮尔曼相关系数则为 <code>+1</code> 或 <code>-1</code>。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">spearman</span> [<span class="keyword">varlist</span>] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, spearman_options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">spearman</span> mpg rep78</span><br></pre></td></tr></table></figure></li>
<li><p>偏相关系数</p>
<p>偏相关系数类似于多元线性回归。当研究某一种因素对另一种因素的影响或相关程度，把其他因素的影响排除在外，而单独研究这两种因素之间的相关系数时，就要使用偏相关分析方法。</p>
<p>偏相关程度用片相关系数来衡量。即当有多个变量存在时，为了研究任意两个变量之间的关系，而使与这两个变量有联系的其他变量都保持不变，即控制其他变量，计算这两个变量之间的相关性。使用 <code>pcorr</code> 可以计算偏相关系数，基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pcorr</span> varname1 <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">pcorr</span> wage tenure hour age</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="数据分布">1.1.7 数据分布</h3>
<p>如果一个变量不符合正态分布可以考虑对数据进行非线性变换，常用的转换包括平方、三次方、自然对数等。<code>Stata</code> 提供了一个非常强大的工具 “幂阶梯” (<code>ladder of powers</code>) 可以尝试转换，然后依次进行偏度-峰度检验。主要的转换包括立方、平方、原始、平方根、对数等。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ladder</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wage  </span><br><span class="line"><span class="keyword">ladder</span> wage</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EAdf.png" />
<center>
Fig. ladder 数据分布
</center>
<p>此外，还可以通过 <code>qladder</code> 和 <code>gladder</code> 分别制作直方图和分位正态图。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">webuse</span> wage</span><br><span class="line"><span class="keyword">qladder</span> wage</span><br><span class="line"><span class="keyword">gladder</span> wage</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62Enzj.md.png" />
<center>
Fig. qladder 分位正态图 (左) 和 gladder 直方图 (右)
</center>
<h2 id="operations">1.2 Operations</h2>
<h3 id="relational-symbols">1.2.1 Relational symbols</h3>
<ul>
<li><code>==</code>: Equal;</li>
<li><code>!=</code>: Not equal;</li>
</ul>
<h3 id="mathematical-operation">1.2.2 Mathematical operation</h3>
<p>数学运算，命令格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">display</span> expression</span><br><span class="line"><span class="keyword">di</span> expression</span><br></pre></td></tr></table></figure>
<h3 id="logical-operation">1.2.3 Logical operation</h3>
<ul>
<li><code>!</code>: not</li>
<li><code>&amp;</code>: and</li>
<li><code>|</code>: or</li>
</ul>
<p>Example:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sysuse</span> auto, <span class="keyword">Clear</span></span><br><span class="line"><span class="keyword">list</span> price foreign <span class="keyword">if</span> price &gt; 1000</span><br><span class="line"><span class="keyword">list</span> price foreign <span class="keyword">if</span> ((price &gt; 1000) &amp; (price &lt; 4000))</span><br></pre></td></tr></table></figure>
<h2 id="function">1.3 Function</h2>
<h3 id="in-函数">1.3.1 in 函数</h3>
<ul>
<li><p><code>in</code> 函数简介</p>
<p><code>in</code> 用于指定观测值，可以是某一个观测值，也可以是某个区间的观测值。比如从第 10 个到 20 个观测值，基本语法如下：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">command <span class="keyword">in</span> <span class="keyword">range</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto, <span class="keyword">clear</span></span><br><span class="line"><span class="keyword">list</span> price <span class="keyword">in</span> 300/500</span><br><span class="line"><span class="keyword">list</span> price <span class="keyword">in</span> 10/<span class="keyword">l</span> <span class="comment">//last</span></span><br></pre></td></tr></table></figure>
<p>其中，<code>command</code> 是命令，<code>range</code> 是从某个数到另外一个数</p></li>
</ul>
<h3 id="if-函数">1.3.2 if 函数</h3>
<p><code>if</code> 函数用于一个命令后，用来满足表达式的数据集，基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">command <span class="keyword">if</span> expression</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto, <span class="keyword">clear</span></span><br><span class="line"><span class="keyword">list</span> make <span class="keyword">if</span> price  &gt; 10000</span><br></pre></td></tr></table></figure>
<p>其中，<code>command</code> 代表某个 stata 命令，<code>exp</code> 是需要满足的表达式，表达式可以利用不同的运算符连接起来变量。</p>
<h3 id="by-语句">1.3.3 by 语句</h3>
<p>Stata 语句大部分都允许使用 <code>by</code> 前置语句，用来对某些变量具有相同赋值的样本子集重复执行命令，<code>by</code> 语句的语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">by</span> <span class="keyword">varlist</span>: stata_cmd</span><br><span class="line"><span class="keyword">bysort</span> <span class="keyword">varlist</span>: stata_cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">by</span> foreign: <span class="keyword">summarize</span> rep78 <span class="comment">// 按 rep78  变量来进行汇总</span></span><br><span class="line"><span class="keyword">bysort</span> rep78: <span class="keyword">tabulate</span> foreign <span class="comment">// 以表格的形式呈现并排序</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">by</span> group, <span class="keyword">sort</span>: <span class="keyword">regress</span> Y x1 x2</span><br></pre></td></tr></table></figure>
<p>Result：</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62A5iF.md.png" /></p>
<center>
Fig. 1-1 by 语句
</center>
<p><img src="https://s3.ax1x.com/2021/03/18/62AIG4.md.png" /></p>
<center>
Fig. 1-2 bysort 语句
</center>
<p>其中，<code>stata_cmd</code> 表示要执行的命令，<code>by</code> 和 <code>bysort</code> 的命令区别是是否对变量进行排序。</p>
<h3 id="generate-variables">1.3.4 generate variables</h3>
<p><code>generate</code> 用于创建一个新变量，命令格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">generate</span> [<span class="keyword">type</span>] newva = exp [<span class="keyword">if</span>] [<span class="keyword">in</span>]</span><br><span class="line"><span class="comment">//type 默认是浮点型</span></span><br></pre></td></tr></table></figure>
<h3 id="real-函数简介">1.3.5 real 函数简介</h3>
<p><code>real</code> 函数用于从合适的字符串表达式中得到数值，所以这个函数的定义域是各种字符串，而值域是数字和缺失值。命令格式：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="built_in">real</span>(expression) = result</span><br><span class="line"></span><br><span class="line"><span class="built_in">real</span>(<span class="string">&quot;5.2&quot;</span>) + 1 = 6.2 <span class="comment">// 从字符串中得到真实数字，若无数字则返回缺失值</span></span><br><span class="line"><span class="built_in">real</span>(<span class="string">&quot;hello&quot;</span>) = . <span class="comment">// &quot;.&quot; 表示缺失值</span></span><br></pre></td></tr></table></figure>
<h2 id="variables">1.4 Variables</h2>
<h3 id="dummy-variable">1.4.2 Dummy variable</h3>
<p>虚拟变量是最常见的指示指标，通常通过一个连续的变量进行转换可得。最简单的类别变量是取值为 0 和 1 的虚拟变量。生成虚拟变量的方法有两种。</p>
<ol type="1">
<li>利用 <code>generate</code> 和 <code>replace</code> 命令组合生成虚拟变量，基本语法：</li>
</ol>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">gen</span> college = 0 <span class="comment">// 生成一个常数变量，赋值为 0</span></span><br><span class="line"><span class="keyword">replace</span> college = 1 <span class="keyword">if</span> educ &gt;= 12</span><br></pre></td></tr></table></figure></p>
<ol start="2" type="1">
<li>使用 <code>generate newvar</code> 命令生成虚拟变量。基本语法：</li>
</ol>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">generate</span> college = (educ &gt;= 12) <span class="comment">// 等同于上两个语句</span></span><br></pre></td></tr></table></figure></p>
<h3 id="classified-variables">1.4.3 Classified variables</h3>
<p>生成分类变量可以使用很多方法，常用的命令有 <code>generate</code> 和 <code>replace</code> 命令组合，<code>tabulate</code> 命令以及 <code>recode</code> 命令，还可以使用 <code>autocode(), recode(), group()</code> 3 个函数。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">recoded <span class="keyword">varlist</span> (rule) [(rule)...] [, <span class="keyword">generate</span>(newvar)]</span><br><span class="line"><span class="comment">// varlist 表示需要进行转换赋值的变量名，rule 是事先确定的转换规则。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">recode</span> x(1=2), <span class="keyword">gen</span>(nx) <span class="comment">// 将x值由1变为2，并将新变量保存为nx变量</span></span><br><span class="line"><span class="keyword">recode</span> x(1=2)(2=1), <span class="keyword">gen</span>(nx1) <span class="comment">//将1变为2，2变为1</span></span><br><span class="line"><span class="keyword">recode</span> x2(1 2 = 1)(3=2)(4/7=3), <span class="keyword">gen</span>(nx2) <span class="comment">// 将1-2变为1，4-7的值变为3</span></span><br></pre></td></tr></table></figure>
<h1 id="drawing-operation">2 Drawing operation</h1>
<h2 id="绘图简介">2.1 绘图简介</h2>
<p>Stata 的制图引擎提供了一整套制图工具与选项。不同目的、不同水平的用户都可以自由地选择自己需要的制图工具。如绘制二维散点图:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">graph</span> <span class="keyword">twoway</span> <span class="keyword">scatter</span> var1 var2</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> autotech</span><br><span class="line"><span class="keyword">graph</span> <span class="keyword">twoway</span> <span class="keyword">scatter</span> weight length <span class="comment">// 创建二维散点图</span></span><br></pre></td></tr></table></figure>
<p>图形的组成可以分为四部分：</p>
<ul>
<li>由横轴和纵轴围成的图行的核心部分；</li>
<li>核心部分中诸如轴线间隔、连线、数值显示等附件部分；</li>
<li>用户在核心部分周围添加的诸如图形名称、轴线说明、图例名称、数据来源等文字；</li>
<li>在复杂图形中，用户添加在黑犀牛部分上的其他图行的叠加部分。</li>
</ul>
<h2 id="scatter-plot">2.2 scatter plot</h2>
<h3 id="散点图简介">2.2.1 散点图简介</h3>
<p>当用户面对的是两个连续变量时，散点图可以直观将数据呈现。散点图在探索变量的关系，为进一步的统计分级做准备工作中得到较为广泛的运用。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">twoway</span>] <span class="keyword">scatter</span> <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">scatter</span> yvar xvar <span class="comment">// 以yvar为y变量，xvar为x变量</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">connect: 连线属性，默认none(i)</span></span><br><span class="line"><span class="comment">msymbol：点形状</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">graph</span> export <span class="keyword">test</span>.png <span class="comment">// 导出图片</span></span><br></pre></td></tr></table></figure>
<p>如果命令后紧跟两个变量名，Stata 会默认第一个变量为 <code>y</code> 轴变量， 第二个为 <code>x</code> 轴变量。如果命令后跟着两个以上的变量，Stata 会将除最后一个以外的变量作为 <code>y</code> 轴变量，最后一个作为 <code>x</code> 轴变量。</p>
<center>
Tab. 2-1 散点图的参数
</center>
<table>
<thead>
<tr class="header">
<th>options</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>marker_options</td>
<td>change markers' look (color, size, etc.)</td>
</tr>
<tr class="even">
<td>marker_label_options</td>
<td>add marker labels; change look, position</td>
</tr>
<tr class="odd">
<td>connect_options</td>
<td>change look of lines or connecting method</td>
</tr>
<tr class="even">
<td>composite_style_option</td>
<td>overall style of the plot</td>
</tr>
<tr class="odd">
<td>jitter_options</td>
<td>jitter marker positions using random noise</td>
</tr>
<tr class="even">
<td>axis_choice_options</td>
<td>associate plost with alternate axis</td>
</tr>
<tr class="odd">
<td>twoway_options</td>
<td>titles, legends, axes, aspect ratio, etc.</td>
</tr>
</tbody>
</table>
<h3 id="散点设定-marker_options">2.2.2 散点设定 <code>marker_options</code></h3>
<p>散点显示选项的设定主要包括三点的形状、颜色、大小等。散点的形状 <code>msymbol(symbolstylelist)</code>、散点的颜色 <code>mcolor(colorstylelist)</code> 和三点的大小 <code>msize(markersizestylelist)</code> 等。</p>
<p>具体设定包含如下5个方面：</p>
<ul>
<li>散点的形状 <code>symbol</code>；</li>
<li>散点的大小 <code>markersize</code>;</li>
<li>整体颜色；</li>
<li>内部的填充颜色</li>
<li>外保险的形状、厚度和颜色。</li>
</ul>
<center>
Tab. 2-2 marker_options
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">marker_options</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">msymbol (<code>m</code>)</td>
<td style="text-align: left;">shape of marker</td>
</tr>
<tr class="even">
<td style="text-align: center;">mcolor (<code>mc</code>)</td>
<td style="text-align: left;">color and opacity of marker, inside and out</td>
</tr>
<tr class="odd">
<td style="text-align: center;">msize (<code>msiz</code>)</td>
<td style="text-align: left;">size of marker</td>
</tr>
<tr class="even">
<td style="text-align: center;">msangle (<code>msa</code>)</td>
<td style="text-align: left;">angle of marker symbol</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mfcolor (<code>mfc</code>)</td>
<td style="text-align: left;">inside or "fill" color and opacity</td>
</tr>
<tr class="even">
<td style="text-align: center;">mlcolor (<code>mlc</code>)</td>
<td style="text-align: left;">color and opacity of outline</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mlwidth (<code>mlw</code>)</td>
<td style="text-align: left;">thickness of outline</td>
</tr>
<tr class="even">
<td style="text-align: center;">mlalign (<code>mla</code>)</td>
<td style="text-align: left;">outline alignment (inside, outside, center)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mlstyle (<code>mls</code>)</td>
<td style="text-align: left;">overall style of outline</td>
</tr>
<tr class="even">
<td style="text-align: center;">mstyle (<code>msty</code>)</td>
<td style="text-align: left;">overall style of marker</td>
</tr>
</tbody>
</table>
<h3 id="标签设定-marker_label_options">2.2.3 标签设定 <code>marker_label_options</code></h3>
<p>散点标签选项 <code>marker_label_options</code> 用于设定散点图标签（位于每个散点旁的用于说明散点所代表个体的文字），常见的选项由：</p>
<ul>
<li><code>mlabel(varname)</code>：用于设定标签变量；</li>
<li><code>mlabstyle(markerlabelstyle)</code>：用于设定标签的整体样式，包括：标签的位置、大小、方向等，取值在 <code>p1-p15</code> 之间。</li>
<li><code>mlabposition(clockposstyle)</code>、<code>mlabvposition(varname)</code>：用于设定标签的位置，它们之间是可以相互替代的，前者设定一个常数应用到所有的点，后者设定一个变量指示每个变量的标签的方向，这个变量的取值在 0~12 之间。</li>
</ul>
<center>
Tab. 2-3 marker_label_options
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">marker_label_options</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">mlabel</td>
<td>specify marker variables</td>
</tr>
<tr class="even">
<td style="text-align: center;">mlabposition (<code>mlabp</code>)</td>
<td>where to locate label</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mlabvposition (<code>mlabv</code>)</td>
<td>where to locate label 2</td>
</tr>
<tr class="even">
<td style="text-align: center;">mlabgap (<code>mlabg</code>)</td>
<td>gap between marker and label</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mlabangle (<code>mlabang</code>)</td>
<td>angle of label</td>
</tr>
<tr class="even">
<td style="text-align: center;">mlabsize (<code>mlabs</code>)</td>
<td>size of label</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mlabcolor (<code>mlabc</code>)</td>
<td>color and opacity of label</td>
</tr>
<tr class="even">
<td style="text-align: center;">mlabtextstyle (<code>mlabt</code>)</td>
<td>overall style of text</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mlabstyle (<code>mlabsty</code>)</td>
<td>overall style of label</td>
</tr>
</tbody>
</table>
<h3 id="连线选项-connect_options">2.2.4 连线选项 <code>connect_options</code></h3>
<p>散点图的连线设置。</p>
<center>
Tab. 2-4 connect_options
</center>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">connect_options</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">connect (<code>c</code>)</td>
<td>how to connect points</td>
</tr>
<tr class="even">
<td style="text-align: center;">sort</td>
<td>how to order data before connecting</td>
</tr>
<tr class="odd">
<td style="text-align: center;">cmissing (<code>cmis</code>)</td>
<td>missing values are ignored</td>
</tr>
<tr class="even">
<td style="text-align: center;">lpattern (<code>l</code>)</td>
<td>line pattern (solid, dashed, etc.)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">lwidth (<code>lw</code>)</td>
<td>thickness of line</td>
</tr>
<tr class="even">
<td style="text-align: center;">lcolor (<code>lc</code>)</td>
<td>color and opacity of line</td>
</tr>
<tr class="odd">
<td style="text-align: center;">lalign (<code>la</code>)</td>
<td>line alignment (inside, outside, center)</td>
</tr>
<tr class="even">
<td style="text-align: center;">lstyle (<code>lsty</code>)</td>
<td>overall style of line</td>
</tr>
</tbody>
</table>
<ul>
<li><p>connect</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">connectstyle  Synonym     Description</span><br><span class="line">---------------------------------------------------------------</span><br><span class="line"> none            i        <span class="keyword">do</span> not connect</span><br><span class="line"> direct          <span class="keyword">l</span>        connect with straight lines</span><br><span class="line"> ascending       <span class="keyword">L</span>        direct, but only <span class="keyword">if</span> x[j+1] &gt; x[j]</span><br><span class="line"> stairstep       J        flat, then vertical</span><br><span class="line"> stepstair                vertical, then flat</span><br><span class="line">---------------------------------------------------------------</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="振荡选项-jitter_options">2.2.5 振荡选项 <code>jitter_options</code></h3>
<p>有时候，由于数据点太密集，甚至产生了重叠，使得在观察数据中的趋势时受到影响。这时，需要将这些数据点轻微地挪动位置，使得重合的数据点相互分开，在 <code>Stata</code> 中振荡选项 <code>jitter_options</code> 就是用来达到振荡数据点的目的的。一旦设定了振荡选项 <code>jitter(#)</code>，<code>scatter</code> 会在绘图前向数据中增加白噪声，选项中的 <code>#</code> 用来指定一个数字，表明振荡的程度占绘图区域的百分比。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">scatter</span> mpg weight, jitter(8)</span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2021/03/18/62AcMn.md.png" /></p>
<center>
Fig. 2-1 振荡后结果
</center>
<h3 id="坐标选项-axis_choice_options">2.2.6 坐标选项 <code>axis_choice_options</code></h3>
<p>坐标选项 <code>axis_options</code>。主要包括：</p>
<ol type="1">
<li><code>axis_title_options</code>;</li>
<li><code>axis_label_options</code>;</li>
<li><code>axis_scale_options</code>;</li>
<li><code>axis_choice_options</code>;</li>
<li><code>axis_title_options</code></li>
</ol>
<p>坐标轴标题选项组 <code>axis_title_options</code> 用于设定坐标轴的标题，主要包括:</p>
<ul>
<li><code>ytitle(axis_title)</code>;</li>
<li><code>xtitle(axis_title)</code>;</li>
<li><code>ttitle(axis_title)</code>;</li>
<li><code>ztitle(axis_title)</code>;</li>
</ul>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">scatter</span> mpg price, ytitle(<span class="string">&quot;YYY&quot;</span>) xtitle(<span class="string">&quot;XXX&quot;</span>) <span class="comment">// <span class="doctag">note:</span> &#x27; ！= &quot;</span></span><br><span class="line"><span class="keyword">scatter</span> mpg price, ytitle(<span class="string">&quot;111YYY&quot;</span> <span class="string">&quot;222YYY2&quot;</span>) xtitle(<span class="string">&quot;111XXX&quot;</span> <span class="string">&quot;222XXX&quot;</span> <span class="string">&quot;333XXX&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<ol start="6" type="1">
<li><code>axis_label_options</code></li>
</ol>
<p>坐标轴刻度选项组 <code>axis_label_options</code> 主要用于控制坐标轴的刻度和刻度的标识。主要包括:</p>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">axis_label_options                Description</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">&#123;y|x|t|z&#125;<span class="keyword">label</span>(rule_or_values)    major ticks plus labels</span><br><span class="line">&#123;y|x|t|z&#125;tick(rule_or_values)     major ticks only</span><br><span class="line">&#123;y|x|t|z&#125;mlabel(rule_or_values)   minor ticks plus labels</span><br><span class="line">&#123;y|x|t|z&#125;mtick(rule_or_values)    minor ticks only</span><br><span class="line">-------------------------------------------------------</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p><code>rule</code> 的设定；</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">rule    Example    Description</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">##      #6         approximately 6 nice values</span><br><span class="line">###     ##10       10-1=9 values between major ticks;</span><br><span class="line">           allowed with mlabel() and mtick() only</span><br><span class="line">#(#)#   -4(.5)3    specified <span class="keyword">range</span>: -4 to 3 <span class="keyword">in</span> steps of .5</span><br><span class="line">minmax  minmax     minimum and maximum values</span><br><span class="line">none    none       <span class="keyword">label</span> <span class="keyword">no</span> values</span><br><span class="line">.        .           skip the rule</span><br><span class="line">-------------------------------------------------------</span><br></pre></td></tr></table></figure></li>
<li><p><code>rules</code> 和 <code>numlists</code> 的设定；</p></li>
<li><p>子选项 <code>valuelable</code> 的使用；</p></li>
<li><p><code>alternate</code> 选项的设定；</p></li>
<li><p><code>grid</code> 和 <code>nogrid</code> 选项的设定。</p></li>
</ul>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">webuse</span> auto</span><br><span class="line"><span class="keyword">scatter</span> mpg weight, ylabel(#5) xlabel(#5)</span><br><span class="line"><span class="keyword">scatter</span> mpg weight, ylabel(10(5)45) xlabel(1500 2000 3000 4000 4500 5000)</span><br><span class="line"><span class="keyword">scatter</span> mpg weight, ymtick(#20, grid) xmtick(#20, grid gmax)</span><br></pre></td></tr></table></figure></p>
<ol start="7" type="1">
<li><code>axis_scale_option</code></li>
</ol>
<p>坐标量度选项 <code>axis_scale_option</code>，用于对坐标轴进行量度科刻画。</p>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">webuse</span> auto</span><br><span class="line"></span><br><span class="line"><span class="keyword">generate</span> ln_weight = <span class="built_in">log</span>(weight)</span><br><span class="line"><span class="keyword">scatter</span> mpg ln_weight</span><br><span class="line"></span><br><span class="line"><span class="keyword">scatter</span> mpg weight, xscale(<span class="keyword">log</span>)</span><br></pre></td></tr></table></figure></p>
<ol start="8" type="1">
<li><code>axis_choice_options</code></li>
</ol>
<p>坐标尺度选项组 <code>axis_choice_options</code>，尺度选项的主要功能在于决定坐标轴时采用正常的算术刻度、对数刻度还是反方向刻度，坐标轴的数值范围以及坐标线的显示。主要包括设定 <code>y</code> 轴的外观、<code>x</code> 轴的外观和设定 <code>t</code> 轴的外观。在设定的同时，还可以设定子选项的外观。</p>
<h3 id="twoway_options">2.2.7 twoway_options</h3>
<p>主要包含如下信息：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">twoway_options</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">added_line_options</td>
<td>draw lines at specified y or x values</td>
</tr>
<tr class="even">
<td style="text-align: center;">added_text_options</td>
<td>display text at specified (y,x) value</td>
</tr>
<tr class="odd">
<td style="text-align: center;">axis_options</td>
<td>labels, ticks, grids, log scales</td>
</tr>
<tr class="even">
<td style="text-align: center;">title_options</td>
<td>titles, subtitles, notes, captions</td>
</tr>
<tr class="odd">
<td style="text-align: center;">legend_options</td>
<td>legend explaining what means what</td>
</tr>
<tr class="even">
<td style="text-align: center;">scale(#)</td>
<td>resize text and markers</td>
</tr>
<tr class="odd">
<td style="text-align: center;">region_options</td>
<td>outlining, shading, aspect ratio</td>
</tr>
<tr class="even">
<td style="text-align: center;">aspect_option</td>
<td>constrain aspect ratio of plot region</td>
</tr>
<tr class="odd">
<td style="text-align: center;">scheme(schemename)</td>
<td>overall look</td>
</tr>
<tr class="even">
<td style="text-align: center;">play(recordingname)</td>
<td>play edits from recordingname</td>
</tr>
<tr class="odd">
<td style="text-align: center;">by(varlist, ...)</td>
<td>repeat for subgroups</td>
</tr>
<tr class="even">
<td style="text-align: center;">nodraw</td>
<td>suppress display of graph</td>
</tr>
<tr class="odd">
<td style="text-align: center;">name(name, ...)</td>
<td>specify name for graph</td>
</tr>
<tr class="even">
<td style="text-align: center;">saving(filename, ...)</td>
<td>save graph in file</td>
</tr>
<tr class="odd">
<td style="text-align: center;">advanced_options</td>
<td>difficult to explain</td>
</tr>
</tbody>
</table>
<ul>
<li><p><code>added_line_options</code></p>
<p>增加线选项 <code>added_line_options</code> 用于在二维图形上添加增加先，主要包括增加水平线，垂直线和特定的 <code>t</code> 轴上增加垂直线。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">xline(linearing), yline(linearing), tline(linearing)</span><br><span class="line"><span class="comment">// 其中 linearing 表示：numlist [, suboptions]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">scatter</span> mpg price, yline(10)</span><br><span class="line"><span class="keyword">scatter</span> mpg price, yline(10, lstyle(foreground))</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62AXdK.md.png" /></p>
<center>
<p>Fig.2-2 added_line_options</p>
</center>
<p>其中，<code>suboptions</code> 可以设定增加线的总样式、增加线的样式、增加线的粗细和增加线的颜色。</p></li>
<li><p><code>axis_options</code></p>
<p>轴选项包括：</p>
<ul>
<li><p><code>axis_title_options</code>;</p>
<p>轴线选择项 <code>yaxis(# [# ...])</code> 和 <code>xaxis(# [# ...])</code> 用来设定使用的是哪一个坐标，其中 <code>#</code> 取值为1到9，默认设置是 <code>yaxis(1)</code> 和 <code>xaxis(1)</code>，最常用的是对于 <code>y</code> 轴的选择，第一个 <code>y</code> 轴出现在图形的左侧，第二个 <code>y</code> 轴出现在图形的优策，而设定 <code>yaxis(12)</code> 将允许用户拥有两个相同的轴线。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">twoway</span>(<span class="keyword">scatter</span> mpg weight)(<span class="keyword">scatter</span> price weight, yaxis(2))</span><br><span class="line"><span class="comment">// 二维图，等价于：</span></span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">scatter</span> price weight, yaxis(2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">scatter</span> price weight, yaxis(2) || ,  xlabel(#10) ytick(#10, axis(2)) ylabel(#8, axis(1))</span><br></pre></td></tr></table></figure>
<p>Result: <img src="https://s3.ax1x.com/2021/03/18/62AOZ6.md.png" /></p>
<center>
<p>Fig. 2-3 Example of pie figure</p>
</center></li>
<li><p><code>axis_label_options</code>;</p></li>
<li><p><code>axis_scale_options</code>;</p></li>
<li><p><code>axis_choice_options</code>。</p></li>
</ul></li>
<li><p><code>legend_options</code></p>
<p>当图形中包含多个组别的相似的内容时，<code>Stata</code> 将会生成图例。图例表示图形当中的不同符号对应着的内容，它使得读者能够轻松地读懂图中不同符号的含义。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">legend([contents] [location])</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> uslifeexp</span><br><span class="line"><span class="keyword">line</span> le year</span><br><span class="line"><span class="keyword">line</span> le_m le_f year <span class="comment">// default legend</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">line</span> le year, legend(<span class="keyword">on</span>)</span><br><span class="line"><span class="keyword">line</span> le_m le_f year, legend(off)</span><br><span class="line"></span><br><span class="line"><span class="keyword">label</span> <span class="keyword">var</span> le_m <span class="string">&quot;Males&quot;</span></span><br><span class="line"><span class="keyword">label</span> <span class="keyword">var</span> le_f <span class="string">&quot;Females&quot;</span></span><br><span class="line"><span class="keyword">line</span> le_m le_f year</span><br><span class="line"></span><br><span class="line"><span class="keyword">line</span> le_m le_f year, legend(<span class="keyword">label</span>(1 <span class="string">&quot;Males&quot;</span>) <span class="keyword">label</span>(2 <span class="string">&quot;Females&quot;</span>))</span><br><span class="line"><span class="keyword">scatter</span> le_m le_f year, c(<span class="keyword">l</span>)legend(<span class="keyword">label</span>(1 <span class="string">&quot;Males&quot;</span>) <span class="keyword">label</span>(2 <span class="string">&quot;Females&quot;</span>))</span><br><span class="line"><span class="comment">// c(l): 表示实现连线 connect(line)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">scatter</span> le_m le_f year, c(<span class="keyword">l</span>)legend(pos(5) ring(0) col(1) <span class="keyword">label</span>(1 <span class="string">&quot;Males&quot;</span>) <span class="keyword">label</span>(2 <span class="string">&quot;Females&quot;</span>))</span><br><span class="line"><span class="comment">// pos指时钟方位，ring(0) 表示离画图区域位置的距离。col指cols</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>scale(#)</code></p>
<p><code>scale(#)</code> 选项设定一个数字以便调整整个图像包括文本、标记和线段的大小，可这个选项实际上是整个图形的放大镜或者缩小镜。</p>
<ul>
<li><code>scale(1)</code> ：默认设置，表示不改变图像大小；</li>
<li><code>scale(1.2)</code>：使整个图像增大20%可以设置；</li>
<li><code>scake(.8)</code>：为了使整个图像减少 20%，可以设置 。</li>
</ul>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sysuse</span> lifeexp</span><br><span class="line"><span class="keyword">scatter</span> lexp lgnp, scale(1.3)</span><br></pre></td></tr></table></figure></li>
<li><p><code>by_options</code></p>
<p>设定选项 <code>by()</code> 后，<code>Stata</code> 会根据变量中的不同取值重复作图，因此 <code>by</code> 的依据往往是分类变量，比如性别、民族、国内国外等。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">by</span>(<span class="keyword">varlist</span> [, byopts])</span><br><span class="line"><span class="comment">// 其中，varlist是作图的根据变量，byopts是子选项关于by选项的设定</span></span><br></pre></td></tr></table></figure>
<ol type="1">
<li>选项 <code>total</code> 表示除了对每一个组别分别作图外，还要添加一个含有全部样本的图行； 2) 选项 <code>row(#)</code> 和 <code>cols(#)</code> 是相互替代的，指设定所有图行共排列 <code>#</code> 行或列。</li>
</ol>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> auto</span><br><span class="line"><span class="keyword">scatter</span> mpg weight, <span class="keyword">by</span>(foreign)</span><br><span class="line"><span class="keyword">scatter</span> mpg weight, <span class="keyword">by</span>(foreign, <span class="keyword">total</span>)</span><br><span class="line"><span class="keyword">scatter</span> mpg weight, <span class="keyword">by</span>(foreign, <span class="keyword">total</span> row(1))</span><br><span class="line"><span class="keyword">scatter</span> mpg weight, <span class="keyword">by</span>(foreign, <span class="keyword">total</span> title(<span class="string">&quot;test&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>Result: <img src="https://s3.ax1x.com/2021/03/18/62Abs1.md.png" /></p>
<center>
<p>Fig.2-4 by_options</p>
</center></li>
<li><p><code>save_options</code></p>
<p><strong>图形保存选项：</strong></p>
<p>与处理数据文件一样，<code>Stata</code> 将本身生成的图形存储分为两种形式：一种是内存中的激活状态，另一种是存入硬盘的状态。在用户把当前文件存入硬盘之前，用户所绘制的图形均在内存中。用户可以选择是清楚或者存储，如果用户绘制另外一个图形，则自动清除之前保留在内存中的图形。基本语法： <figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">graph</span> <span class="keyword">describe</span></span><br><span class="line"><span class="keyword">graph</span> <span class="keyword">save</span> myfile, <span class="keyword">replace</span></span><br></pre></td></tr></table></figure> <strong>图形输出选项：</strong></p>
<p>为了使生成的图形与其他设备或者图形、文字处理软件相连接，<code>Stata</code> 还提供了图形输出的工具，包括将图形输出到打印设备上和将图形输出成为其他格式的文件。主要包括：</p>
<ol type="1">
<li>图形的打印 <code>graph print</code>；</li>
<li>存储为其他格式 <code>graph export newfilename.suffix</code>。</li>
</ol></li>
</ul>
<h3 id="点图">2.2.8 点图</h3>
<p>点图是一种散点图，其值在垂直方向上组合在一起（如直方图中的"合并"），而绘制的点在水平方向上分开。目的是在一个紧凑的图形中显示几个变量或组的所有数据。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">dotplot</span> <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> dotgr</span><br><span class="line"><span class="keyword">dotplot</span> g1r1-g1r10</span><br><span class="line"><span class="keyword">dotplot</span> g1r1-g1r10, title(<span class="string">&quot;Tumor volume, cu mm&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="标绘图">2.2.9 标绘图</h3>
<ul>
<li><p>曲线标绘图</p>
<p>曲线标绘图，就是其中的点用线段连接起来的散点图，和散点图一样，曲线标绘图的不同类型也属于 <code>Stata</code> 功能强大的 <code>graph twoway</code> 族命令。</p>
<p>散点图中控制添加坐标轴标签和标识的选项对曲线标绘图也起作用，新的选项可以控制曲线本身的特征。与散点图相比，曲线标绘图往往有不同的用法，如绘制描述随时间变化的变量。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">twoway</span>] <span class="keyword">line</span> <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [,options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> uslifeexp</span><br><span class="line"><span class="keyword">graph</span> <span class="keyword">twoway</span> <span class="keyword">line</span> le year</span><br><span class="line"><span class="comment">// twoway line le year</span></span><br><span class="line"><span class="comment">// line le year</span></span><br><span class="line"><span class="keyword">scatter</span> le year, msymbol(none) connect(<span class="keyword">l</span>)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62AjIO.md.png" /></p>
<center>
<p>Fig.2-5 曲线标绘图</p>
</center></li>
<li><p>连线标绘图</p>
<p>在曲线标绘图中，数据点是看不见的，只能看到连线，使用连线标绘图可以把图中的数据点加以标记。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">twoway</span> connected <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, scatter_options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> uslifeexp</span><br><span class="line"><span class="keyword">twoway</span> connected le year</span><br><span class="line"><span class="keyword">scatter</span> le year, connect(<span class="keyword">l</span>)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62AxiD.md.png" /></p>
<center>
<p>Fig. 2-6 连线标绘图</p>
</center></li>
</ul>
<h3 id="拟合图">2.2.10 拟合图</h3>
<ul>
<li><p>一次拟合图形</p>
<p>一次拟合图形的绘制分两步：首先 <code>Stata</code> 使用 <code>yvar</code> 为因变量，<code>xvar</code> 为自变量进行一元线性回归，然后得到 <code>yvar</code> 的拟合值。比如说是 <code>hat</code>，然后使用 <code>hat</code> 对 <code>xvar</code> 做曲线标绘图，同时复合原始数据的散点。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">twoway</span> <span class="keyword">lfit</span> yvar xvar [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">lfit</span> mpg weight</span><br><span class="line"><span class="comment">// 等价于下述</span></span><br><span class="line"><span class="keyword">regress</span> mpg weight</span><br><span class="line"><span class="keyword">predict</span> fitted</span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">line</span> fitter weight</span><br></pre></td></tr></table></figure></li>
<li><p>二次拟合图形</p>
<p>二次拟合图形的绘制分两步：首先 <code>Stata</code> 使用 <code>yvar</code> 为因变量，<code>xvar</code> 和 <code>xvar</code> 的平方为自变量进行二元线性回归，得到 <code>yvar</code> 的拟合值如取名为 <code>hat</code>，然后使用 <code>hat</code> 对 <code>xvar</code> 做曲线标绘图，同时复合原始数据的散点图。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">twoway</span> qfit yvar xvar [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">lfit</span> mpg weight</span><br><span class="line"><span class="comment">// 原理类似于下述</span></span><br><span class="line"><span class="keyword">generate</span> <span class="keyword">tempvar</span> = weight^2</span><br><span class="line"><span class="keyword">regress</span> mpg weight <span class="keyword">tempvar</span></span><br><span class="line"><span class="keyword">predict</span> fitted</span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">line</span> fitted weight</span><br></pre></td></tr></table></figure></li>
<li><p><code>lowess</code> 拟合图形</p>
<p>命令 <code>lowess</code> 和 <code>graph twoway lowess</code> 皆可实现一种被称作 "<code>lowess</code> 修匀" 的非参数拟合图的绘制。由于具有可对拟合过程进行控制的选项，<code>lowess</code> 命令总的来说更为专业也更为强大。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">twoway</span> <span class="keyword">lowess</span> yvar xvar [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">lfit</span> mpg weight || <span class="keyword">lowess</span> mpg weight</span><br><span class="line"><span class="keyword">scatter</span> mpg weight || <span class="keyword">lfit</span> mpg weight || <span class="keyword">lowess</span> mpg weight||, <span class="keyword">by</span>(foreign)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="饼图">2.3 饼图</h2>
<h3 id="简介">2.3.1 简介</h3>
<p>基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">graph</span> pie varname [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight], over(varname) [options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">input</span> sales marketing research development</span><br><span class="line"></span><br><span class="line">         sales  marketing   research  develop~t</span><br><span class="line">  1\. 12 14 2 8</span><br><span class="line">  2\. end</span><br><span class="line"></span><br><span class="line"><span class="keyword">label</span> <span class="keyword">var</span> sales <span class="string">&quot;Sales&quot;</span></span><br><span class="line"><span class="keyword">label</span> <span class="keyword">var</span> marketing <span class="string">&quot;Marketing&quot;</span></span><br><span class="line"><span class="keyword">label</span> <span class="keyword">var</span> research <span class="string">&quot;Research&quot;</span></span><br><span class="line"><span class="keyword">label</span> <span class="keyword">var</span> develop  <span class="string">&quot;Development&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">graph</span> pie sales marketing research development, plabel(_all name, size(*1.5) color(white)) legend(off) plotregion(lstyle(none)) title(<span class="string">&quot;Expenditures, XYZ Corp.&quot;</span>) subtitle(<span class="string">&quot;2002&quot;</span>) <span class="keyword">note</span>(<span class="string">&quot;Source:  2002 Financia&gt; l Report (fictional data)&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Result: <img src="https://s3.ax1x.com/2021/03/18/62Aqqx.md.png" /></p>
<center>
Fig. 2-5 Example of pie figure
</center>
<h2 id="条形图">2.4 条形图</h2>
<h3 id="简介-1">2.4.1 简介</h3>
<p>条形图显示较为直观，可以显示众多的描述性统计量，同一个条形图中可以显示多个变量的统计量，比如均值、中位数、和、计数、标准差、最大值。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">graph</span> bar yvar [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options] <span class="comment">// 纵向</span></span><br><span class="line"><span class="keyword">graph</span> hbar yvars [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options] <span class="comment">// 横向</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">graph</span> bar mpg foreign</span><br></pre></td></tr></table></figure>
<h1 id="sample-related">3 Sample related</h1>
<h2 id="列联表-table">3.1 列联表 <code>table</code></h2>
<p><code>table</code> 命令可以用于生成一维到多维的列联表，表中不仅可以包含常见的频数，还可以包含任意其他变量的描述性统计量。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">table</span> rowvar [colvar [supercolvar]] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"><span class="comment">// 其中，`rowvar` 表示行变量，`colvar` 表示列变量，`supercolvar` 代表高阶的列变量。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">table</span> foreign rep78, c(<span class="keyword">mean</span> mpg) <span class="keyword">format</span>(%9.2f) center <span class="comment">// 居中并 format</span></span><br><span class="line"><span class="keyword">table</span> foreign rep78, c(<span class="keyword">mean</span> mpg) <span class="keyword">format</span>(%9.2f) center row col <span class="comment">// row和col表示添加汇总</span></span><br><span class="line"><span class="keyword">table</span> rep78, contents(<span class="keyword">n</span> mpg <span class="keyword">mean</span> mpg sd mpg <span class="keyword">median</span> mpg)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EEo8.png" />
<center>
Fig. 列联表实例
</center>
<h2 id="列联表-tabulate">3.2 列联表 <code>tabulate</code></h2>
<p><code>tabulate</code> 命令主要用于生成一维或者二维的表格，对于二维表格还可以进行独立性检验。<code>tabulate</code> 的一维命令主要用于生成含有频数的一维表格。二维 <code>tabulate</code> 命令在生成二维表格的同时，可以计算多种独立性检验统计量和相关测量统计量，包括常用的 <code>Pearson's chi-squared</code>、<code>likelihood-ratio chi-squared</code>、<code>Cram's V</code>、<code>Fisher's exact test</code>、<code>Goodman and Kruskal's gamma</code>、 <code>Kendall's tau-b</code>。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">tabulate</span> <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, tab1_options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">tabulate</span> foreign, nolabel</span><br></pre></td></tr></table></figure>
<h2 id="样本-t-检验">3.3 样本 <code>t</code> 检验</h2>
<h3 id="单样本-t-检验">3.3.1 单样本 <code>t</code> 检验</h3>
<p>单样本检验的目的是比较样本均数所代表的未知总体均数 <span class="math inline">\(\mu\)</span> 和已知总体均数 <span class="math inline">\(\mu_0\)</span> 是否相等。其千题假设有散点：1) 已知一个总体均数；2) 可得到一个样本均数及该样本标准误；3) 样本来自正态或近似正态总体。计算公式为：</p>
<p><span class="math display">\[
t = \frac{\bar{X} - \mu_0}{s/\sqrt{n}}
\]</span></p>
<p>单样本检验步骤： 1. 建立假设，确定检验水准； 2. 计算统计量； 3. 确定 <span class="math inline">\(p\)</span> 值，得出结论。</p>
<p>基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ttest</span> varname  == # [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, level]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">ttest</span> mpg == 20</span><br><span class="line"><span class="keyword">ttest</span> mpg == 20, level(90)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62ArGQ.md.png" />
<center>
Fig. 单样本 t 检验
</center>
<h3 id="多样本-t-检验">3.3.2 多样本 <code>t</code> 检验</h3>
<p>多样本 <code>t</code> 检验分为两个正态总体的方差检验和两个正态总体的均值检验。基本语法：</p>
<ul>
<li><p>两个正态总体的方差检验:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sdtest</span> varname1 == varname2 [<span class="keyword">if</span>] [<span class="keyword">in</span>], [, level(#)]</span><br><span class="line"><span class="keyword">sdtest</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>], <span class="keyword">by</span>(groupvar) [level(#)] <span class="comment">// 借助分组</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> fuel</span><br><span class="line"><span class="keyword">sdtest</span> mpg1 == mpg2</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62EmWQ.md.png" /></p>
<center>
<p>Fig. 两个样本的方差检验</p>
</center>
<p>其中，<code>P</code> 值未落入拒绝域，即表明两个方差默认相同。</p></li>
<li><p>两个正态总体的均值检验：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ttest</span> varname1 == varname2 [<span class="keyword">if</span>] [<span class="keyword">in</span>] ,[, level(#)]</span><br><span class="line"><span class="keyword">ttest</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>], <span class="keyword">by</span>(groupvar) [option] <span class="comment">// 借助分组</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> fuel3</span><br><span class="line"><span class="keyword">ttest</span> mpg, <span class="keyword">by</span>(treated)</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62EeJg.md.png" /></p>
<center>
<p>Fig. 两个样本的 t 检验</p>
</center></li>
</ul>
<h2 id="方差分析">3.4 方差分析</h2>
<h3 id="单因素方差分析">3.4.1 单因素方差分析</h3>
<p>单因素方差分析是指对单因素试验结果进行分析，检验因素对实验结果有无显著性影响的方法。单因素方差分析是两个样本平均数比较的引伸，它是用来检验多个平均数之间的差异，从而确定因素对实验结果有无显著性影响的一种统计方法。</p>
<p>单因素方差分析相关概念：1) 因素：影响研究对象的某一指标、变量。2) 水平：因素变化的各种状态或因素变化所分的等级或组别。3) 单因素实验：考虑的因素只有一个的试验叫单因素试验。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">oneway</span> response_var factor_var [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> apple</span><br><span class="line"><span class="keyword">oneway</span> weight treatment, <span class="keyword">tabulate</span></span><br><span class="line"><span class="keyword">oneway</span> weight treated</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62Ayxs.md.png" />
<center>
Fig. 单因素方差分析
</center>
<h3 id="多因素方差分析">3.4.2 多因素方差分析</h3>
<p>多因素方差分析法是一种统计分析方法，可以用来分析两个因素的不同水平对结果是否有显著影响。以及两因素之间是否存在交互效应。一般运用双因素方差分析法，先对两个因素的不同水平的组合进行设计试验，要求每个组合下所得到的样本的含量是相同的。基本语法:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">anova</span> varname [termlist] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> systolic</span><br><span class="line"><span class="keyword">anova</span> systolic drug <span class="comment">// one-way anova</span></span><br><span class="line"><span class="keyword">anova</span> systolic drug disease <span class="comment">// two-way anova</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62ADPg.md.png" />
<center>
Fig. 多因素方差分析
</center>
<h3 id="协方差分析">3.4.3 协方差分析</h3>
<p>协方差分析将人为很难控制的控制因素作为协变量，并在排除协变量对观测变量影响的条件下，分析控制变量（可控）对观测变量的作用，从而更加准确地对控制因素进行评价。</p>
<p>协方差分析拓展了多因素方差分析，使之可以包含分类变量和连续变量的情况。当出现连续变量时，定义此变量，方差分析便可进行。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">anova</span> varname [termlist] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] c.(<span class="keyword">varlist</span>) [, options]</span><br><span class="line"><span class="comment">// c.(varlist) 指明该变量为连续变量，为指明则默认为分类变量。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">anova</span> drate region c.mage region#c.mage <span class="comment">// # 表示交互项</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EMyn.md.png" />
<center>
Fig. 协方差分析
</center>
<h3 id="重复测量方差分析">3.4.4 重复测量方差分析</h3>
<p>在某些实验研究中，常常需要考虑时间因素对实验的影响，当需要对同一观察单位在不同时间重复进行多次测量，每个样本的测量数据之间存在相关性，因而不能简单地使用方差分析进行研究，而需要使用重复测量方差分析。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">anova</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, repeated(varname)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> t43</span><br><span class="line"><span class="keyword">anova</span> <span class="keyword">score</span> person drug, repeated(drug)</span><br><span class="line"><span class="keyword">regress</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EQLq.md.png" />
<center>
Fig. 重复测量方差分析
</center>
<h2 id="假设检验">3.5 假设检验</h2>
<h3 id="单个总体的假设检验分析">3.5.1 单个总体的假设检验分析</h3>
<p>单个总体的假设检验时利用某些检验统计量，对样本的均值方差进行检验。主要分为三种：一直方差、未知方差、未知期望。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">input</span> kdqd</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">        kdqd</span></span><br><span class="line"><span class="comment">1. 32.56</span></span><br><span class="line"><span class="comment">2. 29.66</span></span><br><span class="line"><span class="comment">3. 31.64</span></span><br><span class="line"><span class="comment">4. 20</span></span><br><span class="line"><span class="comment">5. 31.87</span></span><br><span class="line"><span class="comment">6. 31.03</span></span><br><span class="line"><span class="comment">7. end</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">replace</span> kdqd = 30 <span class="keyword">in</span> 4</span><br></pre></td></tr></table></figure>
<ul>
<li><p>正态分布，方差已知的均值检验</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">quietly</span> <span class="keyword">summarize</span></span><br><span class="line"><span class="keyword">scalar</span> z = (<span class="built_in">r</span>(<span class="keyword">mean</span>) - 32.5)/(1.1/<span class="built_in">sqrt</span>(6)) <span class="comment">// z 检验</span></span><br><span class="line"><span class="keyword">scalar</span> cri = <span class="built_in">invnormal</span>(1-0.05/2) <span class="comment">// 95% 置信度水平的临界值</span></span><br><span class="line"><span class="keyword">scalar</span> p = (1-<span class="built_in">normal</span>(<span class="built_in">abs</span>(z)))/2 <span class="comment">// p 值</span></span><br><span class="line"><span class="keyword">scalar</span> <span class="keyword">list</span> z cri p</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62E3wV.png" /></p>
<center>
<p>Fig. 方差已知的均值检验</p>
</center></li>
<li><p>正态分布，方差未知的均值检验</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ttest</span> varname == # [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, level(#)] <span class="comment">// 正态分布，方差未知的均值检验</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ttest</span> kdqd == 32.5</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62A2q0.md.png" /></p>
<center>
<p>Fig. 方差未知的均值检验</p>
</center></li>
<li><p>期望未知检验方差</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sdtest</span> varname == # [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, level(#)] <span class="comment">// 期望未知检验方差。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sdtest</span> kdqd == 1.1</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<p><img src="https://s3.ax1x.com/2021/03/18/62E8oT.md.png" /></p>
<center>
<p>Fig. 期望未知的方差检验</p>
</center></li>
</ul>
<h3 id="两个总体的假设检验">3.5.2 两个总体的假设检验</h3>
<p>在实际工作中，有时会用到两个正态总体的假设检验，两个正态中体的假设检验通常分为两种情况： 1. 均值（独立样本）：<span class="math inline">\(z\)</span> 检验（大样本）、<span class="math inline">\(t\)</span> 检验（小样本）。</p>
<p>基本语法：</p>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ttest</span> varname1 == varname2 [<span class="keyword">if</span>] [<span class="keyword">in</span>] [unequal, welch, level(#)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">ttest</span> mpg1 == mpg2, unpaired <span class="comment">// 非对称样本，数据并非针对同一个体</span></span><br></pre></td></tr></table></figure> Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EYYF.md.png" />
<center>
Fig. 均值检验
</center>
<ol start="2" type="1">
<li>方差：<span class="math inline">\(F\)</span> 检验。</li>
</ol>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sdtest</span> varname1 == varname2 [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, level(#)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> fuel</span><br><span class="line"><span class="keyword">sdtest</span> mpg1 == mpg2</span><br></pre></td></tr></table></figure> Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EmWQ.md.png" />
<center>
Fig. 方差检验
</center>
<h2 id="最小二乘法分析">3.6 最小二乘法分析</h2>
<h3 id="小样本的普通最小二乘分析">3.6.1 小样本的普通最小二乘分析</h3>
<p>普通最小二乘估计方法 (Ordinary Least Square，简记为 <code>OLS</code>)，是单一方程线性回归模型最常用、最基本的估计方法。<code>OLS</code> 的基本思想就是通过让残差 <code>e</code> 的平方和最小，从而使得模型的估计称为可能。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">regress</span> depvar [indepvar] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">regress</span> mpg weight foreign</span><br></pre></td></tr></table></figure>
<img src="https://s3.ax1x.com/2021/03/18/62EtW4.md.png" />
<center>
Fig. 小样本的 OLS
</center>
<h3 id="大样本的普通最小二乘分析">3.6.2 大样本的普通最小二乘分析</h3>
<p>大样本普通最小二乘估计方法 (<code>OLS</code>) 适应性更强。在大样本下，只要研究其渐近分布就可以了，而渐近分布比较容易推到。大样本 <code>OLS</code> 经常采用稳健标准差估计 (<code>robust</code>)。</p>
<p>稳健标准差是指其标准差对于模型中可能存在的异方差或自相关问题不敏感，基于稳健标准差计算的稳健 <code>t</code> 统计量仍然渐近服从 <code>t</code> 分布。基本命令：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">regress</span> depvar [indepvar] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, robust]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">generate</span> gpmw = ((1/mpg)/weight)*100*1000</span><br><span class="line"><span class="keyword">regress</span> gpmw foreign, <span class="keyword">vce</span>(robust)</span><br><span class="line"><span class="comment">// regress gpmw foreign, robust</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EUSJ.md.png" />
<center>
Fig. 大样本的 OLS
</center>
<h3 id="约束回归">3.6.3 约束回归</h3>
<p>在做回归分析时，有时会希望某些变量的系数相同或满足某种关系。约束回归通常可以通过对变量进行变换实现。</p>
<p><span class="math display">\[
Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2
\]</span></p>
<p>基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">constraint</span> [define] # [exp = exp | coeflist]</span><br><span class="line"><span class="keyword">cnsreg</span> depvar indepvars [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] , constraints(constraints) [options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">constraint</span> 1 price = weight</span><br><span class="line"><span class="keyword">constraint</span> 2 displacement = weight</span><br><span class="line"><span class="keyword">cnsreg</span> mpg price weight foreign length, c(1) <span class="comment">// 使用第一个条件</span></span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62Eal9.md.png" />
<center>
Fig. 约束回归
</center>
<h3 id="非线性最小二乘法">3.6.4 非线性最小二乘法</h3>
<p>非线性最小二乘 (Nonlinear Least Square, <code>NLS</code>) 方法是一种以误差的平方和最小为准则来估计非线性静态模型参数的一种参数估计方法。通常情况下，非线性最小二乘方法没有解析解，一般使用数值方法求解。基本语法:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">nl</span> (depvar = &lt;sexp&gt;) [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"><span class="comment">// &lt;sexp&gt; is a substitutable expression;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// nl (y = &#123;alpha&#125; + &#123;beta&#125;*x^&#123;gamma=1&#125;)</span></span><br><span class="line"><span class="keyword">nl</span> (y = &#123;b0&#125; + &#123;b1&#125; / x), initial(b0 2 b1 3)</span><br></pre></td></tr></table></figure>
<h1 id="model-specification">4. Model specification</h1>
<h2 id="dummy-variables">4.1 Dummy variables</h2>
<p>对于定性数据，通常不能将其直接纳入模型中进行回归分析。需要进行虚拟变量进行处理。一般情况下，如果分类变量总供有 <code>N</code> 类，为了避免多重共线性的出现，通常引入 <code>N-1</code> 个虚拟变量。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">generate</span> varname = value <span class="comment">// 生成带初始值的虚拟变量</span></span><br></pre></td></tr></table></figure>
<h2 id="变量分组统计分析">4.2 变量分组统计分析</h2>
<p><code>statsby</code> 是对变量分组 (<code>bysort</code>) 进行统计分析 (<code>statstics</code>)。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">statsby</span> [exp_list] [, options]: command</span><br><span class="line"><span class="comment">// by(varlist) 用于设定分组变量，如公司代码、行业分类等</span></span><br><span class="line"><span class="comment">// [exp_list] 用于制定返回值。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">statsby</span> <span class="keyword">mean</span>=<span class="built_in">r</span>(<span class="keyword">mean</span>) sd=<span class="built_in">r</span>(sd) size=<span class="built_in">r</span>(<span class="keyword">N</span>), <span class="keyword">by</span>(rep78):  <span class="keyword">summarize</span> mpg</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EdyR.md.png" />
<center>
Fig. statsby 分组统计
</center>
<h2 id="遗漏变量">4.3 遗漏变量</h2>
<p>遗漏变量属于解释变量选取错误的一种。因为某些数据难以获取，有时未获得的数据会降低模型的精度。可以通过遗漏变量进行处理。<code>Stata</code> 提供两种遗漏变量检验方法：<code>Link</code> 检验和 <code>Ramsey</code> 检验。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">linktest</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [, cmd_options]</span><br><span class="line"><span class="keyword">estat</span> overtest [, rhs]</span><br></pre></td></tr></table></figure>
<h2 id="自变量熟练的选择">4.4 自变量熟练的选择</h2>
<p>在统计模型的设计过程中，通常希望模型简介简单。通常使用信息准则来确定解释变量的个数。常见的信息准则有：</p>
<ol type="1">
<li>赤池信息准则</li>
</ol>
<p>在衡量统计模型拟合优良性 (<code>Gooodness of fit</code>) 的一种标准。它建立在熵的概念基础上，可以权衡所估计模型的复杂度和此模型拟合数据的优良性。</p>
<ol start="2" type="1">
<li>贝叶斯信息准则</li>
</ol>
<p>是在不完全请报下，对部分未知的状态用主观概率估计，然后用贝叶斯公式对发生概率进行修正，最后再利用期望值和修正概率做出最优决策</p>
<p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">estatic [, <span class="keyword">n</span>(#)]</span><br></pre></td></tr></table></figure></p>
<h2 id="极端数据的诊断与处理">4.5 极端数据的诊断与处理</h2>
<p>再全体观测值中，会有一些样本和总体样题距离较远，这些样本再回归中可能会对斜率或者截距的估计产生较大的影响。</p>
<p>在 <code>Stata</code> 中，如果解释变量过多或者是面板数据，绘图方式并不直观。通常使用 <code>leverage</code> 影响力方法判断该数据是否是极端数据。若数据的 <code>leverage</code> 影响力值高于平均值，则对回归系数影响较大，可能会产生极端数据的影响。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">regress</span> price mpg weight foreign</span><br><span class="line"><span class="keyword">predict</span> lev, <span class="keyword">leverage</span> <span class="comment">// 计算所有观测值的 lev 值，计算数据诊断</span></span><br><span class="line"><span class="keyword">gsort</span> lev <span class="comment">// 降序排列</span></span><br><span class="line"><span class="keyword">sum</span> lev</span><br><span class="line"><span class="keyword">list</span> 1/3</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EwO1.md.png" />
<center>
Fig. 极端数据诊断
</center>
<h2 id="多重共线性与逐步回归法">4.6 多重共线性与逐步回归法</h2>
<ul>
<li><p>多重共线性 (陈强，<span class="math inline">\(P_{171}\)</span>)</p>
<p>多重共线性问题，在多元线性回归分析中很常见。非常容易导致方程回归系数估计的标准误差变大，系数估计值的精度降低等。多重共线性的通常症状时，虽然整个回归方程的 <span class="math inline">\(\mathcal{R}^2\)</span> 较大、<span class="math inline">\(F\)</span> 检验也很显著，但单个系数的 <span class="math inline">\(t\)</span> 检验却不显著。</p>
<p>当确认模型存在多重共线性时，通常有两种解决方法来消除影响：1) 收集更多的数据，增大样本容量。2) 通过逐步分析回归改进模型的形式。</p></li>
<li><p>逐步回归法</p>
<p>逐步回归法的基本原理时分别拟合被解释变量，对于每一个解释变量的一元回归，并将各回归方程的拟合优度按照大小顺序排列，然后将拟合优度最大的解释变量作为基础变量，逐步将其他变量加入模型中，观测 <code>t</code> 值的变化。</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">stepwise</span> [, options] : command</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="异方差检验与处理-陈强p_132">4.7 异方差检验与处理 (陈强，<span class="math inline">\(P_{132}\)</span>)</h2>
<p>异方差，是指误差项 <span class="math inline">\(u\)</span> 对不同的的个体是不同的，即条件方差 <span class="math inline">\(Var(\varepsilon_i | X)\)</span> 依赖于 <span class="math inline">\(i\)</span>，而不是常数 <span class="math inline">\(\sigma^2\)</span>。 违反了球形误差的假设。异方差的检验通常有三种方法： 1. 较为直观地观察方法进行回归后画出残差图 <code>ecdplot varname</code> 2. BP 检验 <code>estat hettest, normal</code> 3. 怀特检验 <code>estat imtest, white</code></p>
<p>异方差的处理： 1. 稳健便准差 <code>OLS</code> 法 2. <code>GLS</code> 法（广义最小二乘法）</p>
<h2 id="内生性-陈强p_193">4.7 内生性 (陈强，<span class="math inline">\(P_{193}\)</span>)</h2>
<p><code>OLS</code> 能够成立的最重要条件是解释变量于扰动项不相关（同期外生性）。内生性指解释变量于扰动项相关。内生性通常来源于遗漏变量偏差、经典的测量误差问题和联立性（逆向因果）。如果出现内生性问题，通常解决办法是使用工具变量，利用二阶段最小二乘方法进行解决。基本语法:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">ivregress 2sls y [<span class="keyword">varlist</span> 1] (varlist2 = instlist) [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, option]</span><br></pre></td></tr></table></figure>
<h2 id="二值选择模型">4.8 二值选择模型</h2>
<h3 id="二值选择模型-陈强p_212">4.8.1 二值选择模型 (陈强，<span class="math inline">\(P_{212}\)</span>)</h3>
<p>当被解释的变量可选值只有两个的时候，可以建立二值选择模型进行分析问题。<code>Stata</code> 二值选择模型主要有 <code>Probit</code> 和 <code>Logit</code> 模型。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">logit</span> depvar [indepvars] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"><span class="keyword">probit</span> depvar [indepvars] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br></pre></td></tr></table></figure>
<h3 id="多指选择模型">4.8.2 多指选择模型</h3>
<p>当选择为多个且互相独立时，可以选用多值选择模型。比如，消费者选择不同品牌，旅游者选择不同的交通方式等。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mlogit</span> depvar [indepvars] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"><span class="keyword">mprobit</span> depvar [indepvars] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br></pre></td></tr></table></figure>
<h3 id="排序选择模型">4.8.3 排序选择模型</h3>
<p>在因变量不止两种选择时，就要用到多元选择模型。多元离散选择问题普遍存在于经济生活中。例如：一个人面临多重职业选择，将可共选择的职业排队，用0，1，2，3 表示。影响选择的因素有不同职业的收入、发展前景和个人偏好等。所谓“排序”是指在各个选项之间有一定的顺序或级别种类。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ologit</span> depvar [indepvars] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"><span class="keyword">oprobit</span> depvar [indepvars] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br></pre></td></tr></table></figure>
<h3 id="条件-logit-模型">4.8.4 条件 Logit 模型</h3>
<p>面临多个选择时，选择的依据是个体的特点。但有时，在模型选择过程中，个体选择受外部因素影响，此时可以选用条件 <code>Logit</code> 模型，模型可以解决解释变量中存在的选择特征问题。基本问题：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">clogit</span> y x1 x2 [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] , <span class="built_in">group</span>(varname) [options]</span><br></pre></td></tr></table></figure>
<h3 id="嵌套-logit-模型">4.8.5 嵌套 Logit 模型</h3>
<p>在进行模型选择的时候，很多个体的选择是分层次的，下面层次的选择受到上面层次的限制，相同层次之间的选择具有替代性，层次之间的选择又不相关。这时可以选择嵌套 <code>Logit</code> 模型进行处理。嵌套 <code>Logit</code> 模型的参数估计方法有两种：一种是两阶段最大似然法；另一种是完全信息最大似然法。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">nlogitgen</span> newvar = alvar(bracnchlist) [, nolog]</span><br></pre></td></tr></table></figure>
<h2 id="主成分分析">4.9 主成分分析</h2>
<p>主成分分析是设法将原来众多具有一定相关性（比如 <span class="math inline">\(P\)</span> 个指标)，重新组合成一组新的互相无关的综合指标来代替原来的指标。在许多领域的研究与应用中，往往需要反映事物的多个变量进行大量的观测，收集大量数据以便进行分析寻找规律。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">pca</span> <span class="keyword">varlist</span> [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">pca</span> price mpg rep78 weight</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62EBex.md.png" />
<center>
Fig. 主成分分析
</center>
<h1 id="时间序列">5 时间序列</h1>
<h2 id="时间序列的定义">5.1 时间序列的定义</h2>
<p>时间序列分析方法通常适用于多种领域，包括经济、气象、过程控制等。通常依据变量自身的变化规律，利用外推机制描述时间序列的变化。在使用时间序列数据进行分析前，通常需要定义时间变量，通过新的观测值，或者需要对时间序列进行预测。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">tsset</span> timevar [, option]</span><br><span class="line"><span class="comment">// tsset 定义时间变量；timevar 用于标识时间序列数据的变量名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> idle2</span><br><span class="line"><span class="keyword">tsset</span> time</span><br><span class="line"><span class="keyword">generate</span> newm = tm(2003m6) + time - 1</span><br><span class="line"><span class="keyword">list</span> time newm 1/5</span><br><span class="line"><span class="keyword">format</span> newm %tm <span class="comment">// 将时间格式化为以月份显示</span></span><br></pre></td></tr></table></figure>
Result： <img src="https://s3.ax1x.com/2021/03/18/62EDw6.png" />
<center>
Fig. 时间序列
</center>
<ul>
<li><p>时间序列拓展</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">webuse</span> idle2</span><br><span class="line"><span class="keyword">generate</span> newm = tm(2003m6) + time - 1</span><br><span class="line"><span class="keyword">tsset</span> newm, monthly</span><br><span class="line"><span class="keyword">tsappend</span>, add(12) <span class="comment">// 时间序列拓展</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="时间序列图与白噪声">5.2 时间序列图与白噪声</h2>
<p>时间序列的相关性代表了信息，自相关函数和偏自相关函数可以直观观测信息度。同时，可以采用 <code>Q</code> 统计量来检验白噪声。基本语法:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">corrgram</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>], [, corrgram_options]</span><br><span class="line"><span class="keyword">ac</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>], [, ac_options] <span class="comment">// 自相关绘制</span></span><br><span class="line"><span class="keyword">pac</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>], [pac_options] <span class="comment">// 偏自相关绘制</span></span><br><span class="line"><span class="keyword">wntestq</span> varname [<span class="keyword">if</span>] [<span class="keyword">in</span>], [, lags(#)] <span class="comment">// 白噪声</span></span><br></pre></td></tr></table></figure>
<h2 id="arima-模型">5.3 ARIMA 模型</h2>
<h3 id="arima-模型-1">5.3.1 <code>ARIMA</code> 模型</h3>
<p><code>ARIMA</code> 模型差分整合移动平均自回归模型，常用模型包括：自回归模型 (<code>AR</code>)、滑动平均模型 (<code>MA</code>)、自回归-滑动平均混合模型 (<code>ARMA</code>)、差分整合移动平均自回归莫i选哪个 (<code>ARIMA</code>)。基本语法:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">arima</span> depvar [indepvars], ar(<span class="keyword">numlist</span>) <span class="keyword">ma</span>(<span class="keyword">numlist</span>)</span><br><span class="line"><span class="keyword">arima</span> depvar, <span class="keyword">arima</span>(#p, #<span class="keyword">d</span>, #q)</span><br><span class="line"></span><br><span class="line"><span class="keyword">webuse</span> wpi1</span><br><span class="line"><span class="keyword">line</span> wpi t, yline(0)</span><br><span class="line"><span class="keyword">line</span> <span class="keyword">d</span>.wpi1 t, yline(0) <span class="comment">// 一阶差分</span></span><br></pre></td></tr></table></figure>
<h3 id="smarima-模型">5.3.2 <code>SMARIMA</code> 模型</h3>
<p>在某些时间序列中，存在明显的周期变化。这种周期是由于季节性变化（包括季度、月度、周度变化）或其他一些固有因素引起的。这类序列称为季节性序列。经济领域中，季节性时间序列更为常见。如季度时间序列、月度时间序列、周度时间序列等。基本语法:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">arima</span> depvar, <span class="keyword">arima</span>(#p, #<span class="keyword">d</span>, #q) sarima(#P, #<span class="keyword">D</span>, #Q, #s)</span><br></pre></td></tr></table></figure>
<h3 id="arimax-模型">5.3.3 <code>ARIMAX</code> 模型</h3>
<p><code>ARIMAX</code> 模型，分别是名称 <code>ARMA</code> 和 <code>ARIMA</code> 的扩展，<code>ARMAX</code> 和 <code>ARIMAX</code>。添加到末尾 <code>X</code> 代表“外源”。它表示建议添加一个单独的不同外部变量以帮助测量内生变量。基本语法:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">arima</span> depvar [indepvars] [<span class="keyword">if</span>] [<span class="keyword">in</span>] [weight] [, options]</span><br></pre></td></tr></table></figure>
<h2 id="自助法">5.3 自助法</h2>
<p>自助法 (<code>Bootstrap</code>) 是一种从给定训练样本集中有放回的均匀抽样。每当选中一个样本，它等可能地被再次选中并被再次添加到训练集中。自助法优点是不必对模型的数据生成过程做出假定。基本语法：</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">bootstrap</span> exp_list [, options eform_option] : command</span><br><span class="line"></span><br><span class="line"><span class="keyword">sysuse</span> auto</span><br><span class="line"><span class="keyword">bootstrap</span>, reps(100) seed(123): <span class="keyword">regress</span> mpg weight gear foreign</span><br><span class="line"><span class="keyword">estat</span> <span class="keyword">bootstrap</span>, all</span><br></pre></td></tr></table></figure>
<p>Result:</p>
<img src="https://s3.ax1x.com/2021/03/18/62AWZV.md.png" />
<center>
Fig. Bootstrap 自举法
</center>
<h1 id="软件相关">6 软件相关</h1>
<h2 id="do-文件">6.1 do 文件</h2>
<p>快捷键：<code>ctrl</code> + <code>9</code></p>
<h2 id="注释">6.2 注释</h2>
<ol type="1">
<li>通过 <code>*</code> 声明一行注释</li>
<li>通过 <code>/*</code> 和 <code>*/</code> 进行注释</li>
<li>通过 <code>//</code> 注释</li>
<li>通过 <code>///</code> 注释</li>
</ol>
<h2 id="临时文件">6.3 临时文件</h2>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">tempvar</span> var1 var2 <span class="comment">// 临时变量</span></span><br><span class="line"><span class="keyword">tempname</span> ms1 ms2 <span class="comment">// 临时矩阵</span></span><br><span class="line"><span class="keyword">tempfile</span> file1 file2 <span class="comment">// 临时文件</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Class Notes</category>
        <category>Econometrics</category>
      </categories>
      <tags>
        <tag>Econometrics</tag>
      </tags>
  </entry>
  <entry>
    <title>test</title>
    <url>/2021/09/01/test/</url>
    <content><![CDATA[<p>This is a test file!</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">print(<span class="string">&#x27;This is a test file&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><span id="inline-yellow">Yellow block</span></p>
<p><span id="inline-blue">Blue block</span></p>
<p><span id="inline-green">Green block</span></p>
<p><span id="inline-purple">Purple block</span></p>
<p id="div-left-blue">
左侧蓝色块
</p>
<p id="div-border-left-red">
左侧边框红色块级
</p>
<p id="div-border-left-yellow">
左侧边框黄色块级
</p>
<p id="div-border-left-green">
左侧边框绿色块级
</p>
<p id="div-border-left-blue">
左侧边框蓝色块级
</p>
<p id="div-border-left-purple">
左侧边框紫色块级
</p>
<p id="div-border-right-red">
右侧边框红色块级
</p>
<p id="div-border-right-yellow">
右侧边框黄色块级
</p>
<p id="div-border-right-green">
右侧边框绿色块级
</p>
<p id="div-border-right-blue">
右侧边框蓝色块级
</p>
<p id="div-border-right-purple">
右侧边框紫色块级
</p>
<p id="div-border-top-red">
上侧边框红色块级
</p>
<p id="div-border-top-yellow">
上侧边框黄色块级
</p>
<p id="div-border-top-green">
上侧边框绿色块级
</p>
<p id="div-border-top-blue">
上侧边框蓝色块级
</p>
<p id="div-border-top-purple">
上侧边框紫色块级
</p>
<p><a id="download" href="https://www.yangsuoly.com" target="_blank"><i class="fa fa-download"></i><span> Download Now </span> </a></p>
]]></content>
  </entry>
  <entry>
    <title>Text-mining</title>
    <url>/2021/09/01/Text-mining/</url>
    <content><![CDATA[<h1 id="introduction">1. Introduction</h1>
<ol type="1">
<li>投资者情绪等指数对石油价格（收益率）的预测（or predictability）；如投资者看涨、看跌的情绪.</li>
<li>投资者关注度。如对石油市场的关注度（可以借助谷歌指数）、对石油政策、绿色消费、碳中和等的关注度等；</li>
<li><strong>基于数据挖掘对石油价格的预测</strong>。挖掘一些新的创意点对油价进行预测，初步拟定爬取新闻文本，之后借助自然语言处理分析投资者情绪，情感分析，投资者关注度等。</li>
</ol>
<p>虽然研究的是油价预测，但油价其实只是一个载体，换成其他的商品处理逻辑也差不多，只是因为课题是能源金融，需要一个载体来契合这个点。</p>
<a id="more"></a>
<h1 id="methodology">2. Methodology</h1>
<ol type="1">
<li>可使用的工具：</li>
</ol>
<ul>
<li>爬虫: 多线程和多进程爬重</li>
<li>机器学习：<code>SVM</code>, <code>Lasso</code>, <code>Random Forest</code>, <code>LightGBM</code>;</li>
<li>深度学习: <code>CNN</code></li>
<li><code>NLP</code>: Text classification, Sentiment analysis, Topic modelling.</li>
</ul>
<h1 id="text-mining">3. Text mining</h1>
<h2 id="get-news-information">3.1 Get news information</h2>
<h3 id="爬取信息">3.1.1 爬取信息</h3>
<p>参考 <a href="https://linkinghub.elsevier.com/retrieve/pii/S0263224120309982">Wu et al.</a>，我们也选择 <a href="https://oilprice.com/">OilPrice.com</a> 的 <code>ARTICLE ARCHIVE | PAGE 1</code> 部分的所有新闻，作为我们的新闻来源，我们借助 <code>Python</code> 爬虫工具从该栏目中爬取了 1300 页，每页有 20 条新闻，合计 26000 条新闻。</p>
<p>爬虫分两步：</p>
<ol type="1">
<li><p>利用多线程爬虫（<code>threading</code>) 爬取所有新闻的链接</p>
<p>最终，得到了总计 26000 条新闻的所有链接。</p></li>
<li><p>利用多进程爬虫 （<code>multiprocessing</code>) 爬取所有新闻的内容</p>
<p>由于数据量过于庞大，要对总计 26000 条新闻链接进行访问和获取包含标题、发布时间、作者、新闻内容在内所有信息，因此如果一条条的进行爬取的话，会非常耗时。因此，此处借助多 <code>CPU</code> 的优点，选择使用多进程 <code>multiprocessing</code> 爬虫进行处理。</p>
<p>此外，由于个人电脑的 <code>CPU</code> 数量并不多，<code>Google Colab</code> 平台的 <code>CPU</code> 数为 2，综合考虑之后，此处使用阿里云平台的 <a href="https://dsw-dev.data.aliyun.com/">Data Science Workshop</a> 进行处理，因为其 <code>CPU</code> 数为 24。最终得到 25695 条新闻数据的全部文本内容。</p></li>
</ol>
<h2 id="news-propression">3.2 News propression</h2>
<h3 id="text-cleaning">3.2.1 Text cleaning</h3>
<p>First of all, we need process data cleaning. 1. Load news content and and remove the data outside the time frame of our study. 2. Turn the Time columns (string) to timetype. 3. Extract the daily and hourly information for further analysis.</p>
<p>Finally we get 24308 news, each item contains nine columns:</p>
<ul>
<li>Link: Links to articles;</li>
<li>No: Counter;</li>
<li>Content: full content of articles;</li>
<li>Title</li>
<li>Author</li>
<li>Time: Posted time</li>
<li>Date: daily information</li>
<li>Hour: Post hour</li>
<li>H-M-S: hour-minute-second</li>
</ul>
<p>The last five items are show in Table 1:</p>
<center>
Table 1 The last five items of news
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Link
</th>
<th>
No
</th>
<th>
Content
</th>
<th>
Title
</th>
<th>
Author
</th>
<th>
Time
</th>
<th>
Date
</th>
<th>
Hour
</th>
<th>
H-M-S
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
24303
</th>
<td>
https://oilprice.com/Energy/Energy-General/Exx...
</td>
<td>
81
</td>
<td>
Higher oil and gas demand and the best-ever qu...
</td>
<td>
ExxonMobil Beats Earnings Estimates As Its Che...
</td>
<td>
Tsvetana Paraskova
</td>
<td>
2021-07-30 09:00:00
</td>
<td>
2021-07-30
</td>
<td>
9
</td>
<td>
09:00:00
</td>
</tr>
<tr>
<th>
24304
</th>
<td>
https://oilprice.com/Energy/Natural-Gas/Natura...
</td>
<td>
80
</td>
<td>
Natural gas prices are rising across Europe an...
</td>
<td>
Natural Gas Deficit Causes Prices To Soar
</td>
<td>
Irina Slav
</td>
<td>
2021-07-30 10:00:00
</td>
<td>
2021-07-30
</td>
<td>
10
</td>
<td>
10:00:00
</td>
</tr>
<tr>
<th>
24305
</th>
<td>
https://oilprice.com/Energy/Oil-Prices/Analyst...
</td>
<td>
79
</td>
<td>
Oil analysts and economists believe that $70 a...
</td>
<td>
Analysts See Oil Trading Closer To $70 Through...
</td>
<td>
Tsvetana Paraskova
</td>
<td>
2021-07-30 11:00:00
</td>
<td>
2021-07-30
</td>
<td>
11
</td>
<td>
11:00:00
</td>
</tr>
<tr>
<th>
24306
</th>
<td>
https://oilprice.com/Energy/Energy-General/US-...
</td>
<td>
78
</td>
<td>
The number of oil and gas rigs in the United S...
</td>
<td>
U.S. Oil Rig Count Slips Amid Drop In U.S. Oil...
</td>
<td>
Julianne Geiger
</td>
<td>
2021-07-30 12:11:00
</td>
<td>
2021-07-30
</td>
<td>
12
</td>
<td>
12:11:00
</td>
</tr>
<tr>
<th>
24307
</th>
<td>
https://oilprice.com/Energy/Energy-General/Oil...
</td>
<td>
77
</td>
<td>
Oil prices climbed this week as U.S. inventori...
</td>
<td>
Oil Bulls Remain Confident Despite Covid Concerns
</td>
<td>
Tom Kool
</td>
<td>
2021-07-30 14:00:00
</td>
<td>
2021-07-30
</td>
<td>
14
</td>
<td>
14:00:00
</td>
</tr>
</tbody>
</table>
<h3 id="load-oil-price">3.2.2 Load oil price</h3>
<p>We use WTI future oil price (collecte from Wind database) as the movement index, from 2011.8.1 to 2021.07.30 (7.31 is also non-trading day), 10 years and 2545 samples in total, six samples see Table 2.</p>
<center>
Table 2 The last six item of historical oil price
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Date
</th>
<th>
Price
</th>
<th>
Movement
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
2539
</th>
<td>
2021-07-23
</td>
<td>
72.07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2540
</th>
<td>
2021-07-26
</td>
<td>
71.91
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
2541
</th>
<td>
2021-07-27
</td>
<td>
71.65
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
2542
</th>
<td>
2021-07-28
</td>
<td>
72.39
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2543
</th>
<td>
2021-07-29
</td>
<td>
73.62
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2544
</th>
<td>
2021-07-30
</td>
<td>
73.95
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
<h3 id="preparation">3.2.3 Preparation</h3>
<p>Before carrying out sentiment analysis, we need preprocess the original data. Considering that news information can be published in either trading days or non-trading days, and also can be published in either trading hours or non-trading hours, we need to preprocess the attribution date of news. The specific processing rules are as follows:</p>
<ul>
<li>News posted before 17:00 on the same day is classified as the news of the trading day</li>
<li>The news released after 17:00 on the day is classified as the news of the next trading day</li>
</ul>
<p>More details see Fig. 1:</p>
<p><img src = 'https://z3.ax1x.com/2021/09/01/hwsS3D.png' style="zoom:80%;" /></p>
<center>
Fig.1 News Timeline
</center>
<p><strong>Note</strong>: This guide describes the news timeline. Considering that the closing/opening time of WTI future oil price is 17:00/18:00 pm EST, so we regard news form 18:00 pm (the T-1 -th day) to 17:00 pm (the T-th day) as news posted on T-th, and the use these news (features information extracted by deep learning technique) to predict oil prices.</p>
<h4 id="analysis-with-merged-data">Analysis with merged data</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The total number of days news was issued:  3358</span><br><span class="line">The total number of trading days:  2545</span><br><span class="line">Days on which news was issued in non-trading days:  857</span><br><span class="line">Days on which no news issused:  44</span><br><span class="line">The number of news posted on on-trading days: 4274</span><br></pre></td></tr></table></figure>
<p>From above, we can see that all of 24308 news were issued in 3358 days among 10 years. In total, there are 4274 news posted on non-trading days. Then, we need to:</p>
<ol type="1">
<li><p>Classify these news to news trading days.</p></li>
<li><p>Classify news according to posted hours. If a news is posted after 17:00 PM, we consider to regard this news as next day's news</p></li>
</ol>
<h2 id="sentiment-analysis-with-finbert">3.3 Sentiment analysis with FinBERT</h2>
<h3 id="introduction-1">3.3.1 Introduction</h3>
<p>FinBERT is a pre-trained NLP model to analyze sentiment of financial text. It is built by further training the BERT language model in the finance domain, using a large financial corpus and thereby fine-tuning it for financial sentiment classification. <a href="https://www.researchgate.net/publication/251231107_Good_Debt_or_Bad_Debt_Detecting_Semantic_Orientations_in_Economic_Texts">Financial PhraseBank</a> by Malo et al. (2014) is used for fine-tuning. For more details, please see the paper <a href="https://arxiv.org/abs/1908.10063">FinBERT: Financial Sentiment Analysis with Pre-trained Language Models</a> and related <a href="https://medium.com/prosus-ai-tech-blog/finbert-financial-sentiment-analysis-with-bert-b277a3607101">blog</a> post on Medium.</p>
<p>In this subsection, we ultilize the <a href="https://huggingface.co/ProsusAI/finbert">Hosted inference API</a> and <a href="https://github.com/ProsusAI/finBERT">Github project</a> to analysis the sentiment characteristics hidden in the news text.</p>
<h4 id="data-exploration-to-financial-phrasebank">Data exploration to Financial PhraseBank</h4>
<p>Financial Phrasebank (<a href="https://www.researchgate.net/publication/251231107_Good_Debt_or_Bad_Debt_Detecting_Semantic_Orientations_in_Economic_Texts">Malo et al. (2014)</a>) consists of 4845 english sentences selected randomly from financial news found on LexisNexis database. These sentences then were annotated by 16 people with background in finance and business. The annotators were asked to give labels according to how they think the information in the sentence might affect the mentioned company stock price. The dataset also includes information regarding the agreement levels on sentences among annotators.</p>
<p><strong>Note</strong>: Please make sure to abid by the license and copyright for the use of the data. Please check with the author.</p>
<p>Download the data from this <a href="https://www.researchgate.net/profile/Pekka_Malo/publication/251231364_FinancialPhraseBank-v10/data/0c96051eee4fb1d56e000000/FinancialPhraseBank-v10.zip?origin=publication_list">link</a> and unzip it under <code>finphrase_dir</code> set above.</p>
<ul>
<li><p>Data information</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Total number of record <span class="keyword">in</span> the file:  <span class="number">4846</span></span><br><span class="line">Total number of record after dropping duplicates:  <span class="number">4840</span></span><br><span class="line">Missing label:  <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>Some samples see Table 3:</p>
<center>
<p>Table 3 Some examples in Financial Phrasebank corpus</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>sentence</p>
</th>
<th>
<p>label</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>3200</p>
</th>
<td>
<p>The company serves customers in various industries , including process and resources , industrial machinery , architecture , building , construction , electrical , transportation , electronics , chemical , petrochemical , energy , and information technology , as well as catering and households .</p>
</td>
<td>
<p>neutral</p>
</td>
</tr>
<tr>
<th>
<p>2527</p>
</th>
<td>
<p>Officials did not disclose the contract value .</p>
</td>
<td>
<p>neutral</p>
</td>
</tr>
<tr>
<th>
<p>4101</p>
</th>
<td>
<p>The extracted filtrates are very high in clarity while the dried filter cakes meet required transport moisture limits (TMLs)for their ore grades .</p>
</td>
<td>
<p>neutral</p>
</td>
</tr>
<tr>
<th>
<p>1926</p>
</th>
<td>
<p>The tool is a patent pending design that allows consumers to lay out their entire project on a removable plate using multiple clear stamps of any kind .</p>
</td>
<td>
<p>neutral</p>
</td>
</tr>
<tr>
<th>
<p>1536</p>
</th>
<td>
<p>In Finland , the corresponding service is Alma Media 's Etuovi.com , Finland 's most popular and best known nationwide online service for home and property sales .</p>
</td>
<td>
<p>neutral</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>Histogram</p>
<p>From Fig. 2, we find that more than 60% of the data are labeled as "neutral". Sometimes imbalanced data are balanced using methods like resampling (oversampling, under-sampling) as models tend to predict the majority class more. SMOTE or the Synthetic Minority Over-sampling Technique is a popular technique for oversampling but it is a statistical method for numerical data.</p>
<p><img src = 'https://z3.ax1x.com/2021/09/01/hws9jH.md.png' style="zoom:80%;" /></p>
<center>
<p>Fig.2 The word distribution of Financial PhraseBank</p>
</center>
<p>In addition, this imbalance should be also taken into consideration if this happends in the real world.</p></li>
<li><p>Word frequency</p>
<p><img src="https://z3.ax1x.com/2021/09/01/hwspge.png" alt="png" style="zoom:80%;" /></p>
<center>
<p>Fig.3 The word frequency of Financial PhraseBank</p>
</center></li>
<li><p>Word cloud</p>
<p><img src="https://z3.ax1x.com/2021/09/01/hwsFHI.png" alt="png" style="zoom:80%;" /></p>
<center>
<p>Fig.4 The wordcloud of Financial PhraseBank</p>
</center></li>
</ul>
<h3 id="load-pre-trained-model">3.3.2 Load pre-trained model</h3>
<ol type="1">
<li><p>Download FinBert model</p></li>
<li><p>Load dependency files</p></li>
<li><p>Test:</p>
<center>
<p>Table 4 Two test for FinBERT model</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>sentence</p>
</th>
<th>
<p>logit</p>
</th>
<th>
<p>prediction</p>
</th>
<th>
<p>sentiment_score</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>Stock prices will continue to rise over the ne...</p>
</td>
<td>
<p>[0.84775513, 0.08607003, 0.066174865]</p>
</td>
<td>
<p>positive</p>
</td>
<td>
<p>0.761685</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>Stock prices will continue to fall over the ne...</p>
</td>
<td>
<p>[0.0089766085, 0.9678817, 0.023141773]</p>
</td>
<td>
<p>negative</p>
</td>
<td>
<p>-0.958905</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong></p>
<ul>
<li>Because some of the original code didn't fit perfectly in our prediction work, hence, we made some changes to the source code.</li>
<li>The initial prediction function did not support input lists of strings (as shown in the following examples), so we made some changes to the original code.</li>
</ul></li>
</ol>
<h3 id="analysis-sentiment-features">3.3.3 Analysis sentiment features</h3>
<p>In this part, we perform sentiment analysis for both news headlines and news bodies, and the output results include five parts:</p>
<ul>
<li>Senti: sentiment score, obatain by subtracting negative prob. from positive prob. (title and full-text)</li>
<li>Prediction: this item is considered <code>Positive</code>, <code>neutral</code> or <code>negative</code> by the FinBert (title and full-text).</li>
</ul>
<h2 id="subjective-analysis-with-textblob">3.4 Subjective analysis with TextBlob</h2>
<h3 id="introduction-2">3.4.1 Introduction</h3>
<p><a href="https://textblob.readthedocs.io/en/dev/">TextBlob</a> is a Python library for processing textual data. It provides a simple API for diving into common natural language processing (NLP) tasks such as part-of-speech tagging, noun phrase extraction, sentiment analysis, classification, translation, and more. Many scholars used this library to perform textual sentiment analysis, such as, <a href="https://doi.org/10.1016/j.ijforecast.2018.07.006">Li et al.</a>, <a href="https://www.sciencedirect.com/science/article/pii/S0169207021001060?via%3Dihub">Bai et al.</a>.</p>
<p>However, the sentiment analyzers of TextBlod is the Naive Bayes classifier on the movie review corpus. We know that there are certain ambiguities in language expressions in different fields. Our research fields are finance and economics, so there may be some errors in using this classifier. Therefore, we just ultilize this library to carry out subjective analysis to obtain each new's subjectivity score according to <code>Title</code> and <code>full-text</code>. Subjectivity scores are values within the range [0.0, 1.0], where 0.0 is very objective and 1.0 is very subjective.</p>
<h2 id="oil-price-trends-with-cnn">3.5 Oil price trends with CNN</h2>
<h3 id="introduction-3">3.5.1 Introduction</h3>
<p>In this subsection, we employs a CNN interface from the library, <em>PyTorch</em>, for implementing the prescribed network architecture of <a href="https://paperswithcode.com/paper/a-sensitivity-analysis-of-and-practitioners">Zhang and Wallace's (2017)</a> CNN model. This approach is developed specifically for the sentiment analysis of short text.</p>
<blockquote>
<p><strong>Note</strong>： The CNN model begins with a tokenized sentence which is then converted to a sentence matrix, the rows of which are word vector representations of each token. We treat the sentence matrix as an ‘image’, and perform convolution on it via linear filters. The dimensionality of the feature map generated by each filter will vary as a function of the sentence length and the filter region size. Thus, a pooling function is applied to each feature map to induce a fixed-length vector. A common strategy is 1-max pooling (<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C5&amp;q=A+theoretical+analysis+of+feature+pooling+in+visual+recognition&amp;btnG=">Boureau, Ponce, &amp; LeCun, 2010</a>), which extracts a scalar from each feature map. Together, the outputs generated from the filter maps can be concatenated into a fixed-length, ‘top-level’ feature vector, which is then fed through a softmax function to generate the final classification.</p>
</blockquote>
<p>The advantage of the CNN classifier is based on multi-layer networks and convolution architecture. Since convolutional layers of CNNs apply a convolution operation to the input matrix, they are able to compose different semantic fragments of sentences and learn the interactions between composed fragments, thereby fully exploiting inter-modal semantic relations of crude oil news. Price movements either up or down within the transaction day are used as the output of the CNN classification.</p>
<p>The outputs of the CNN classification represent the fluctuation of daily crude oil prices, either increase or decrease. Specifically, the price movement <span class="math inline">\(M_t\)</span> is defined as:</p>
<p><span class="math display">\[
M = \left\{
      \begin{array}{ll}
          0,\ P_t &lt; P_{t-1} \\
          1,\ p_t \geq p_{t-1}
          \end{array}\right.
\]</span></p>
<p>Where, <span class="math inline">\(p_t\)</span> denotes the oil price at the end of day <span class="math inline">\(t\)</span>.</p>
<p>In this way, the CNN model is trained to learn hidden patterns embedded within news headlines that affect the oil price. to improve our understanding of the CNN algorithm. The procedures are described as follows:</p>
<ul>
<li><p>Step 1: Data preprocessing. The dataset is divided into training data (2011.08.01 - 2018.07.31) and testing data (2018.08.01 - 2021.07.31).</p></li>
<li><p>Step 2: Text vectorization. Convert news text to word vector with pretrainded word embedding. In this research, we utlize an unsupervised learning algorithm for word representation call GloVe (<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C5&amp;q=Glove%3A+Global+vectors+for+word+representation.+In+Proceedings+of+the+2014+conference+on+empirical+methods+in+natural+language+processing&amp;btnG=">Pennington et al., 2014</a>) proposed by Stanford University and is a new global log-bilinear regression model that aims to combine the advantages of the global matrix and local context window methods.</p>
<blockquote>
<p>Word embedding is a dimension reduction technique that maps high-dimensional words (unstructured information) to low-dimensional numerical vectors (structured information). In other words, word embedding aims to convert documents into mathematical representations as computer-readable input and thus is essential for text analysis problems (<a href="https://www.sciencedirect.com/science/article/pii/S0169207021001060?via%3Dihub">Bai et al.</a>).</p>
</blockquote></li>
<li><p>Step 3: Train CNN model using the training sample. Word vector is feed into CNN model. The process of CNN model includes “Convolutional operation,” “Max Pooling,” and “Softmax classification”. A concise and complete flowchart is shown in Fig. 4.</p>
<p><img src="https://z3.ax1x.com/2021/09/01/hwsiDA.png" alt="png" style="zoom:80%;" /></p>
<center>
<p>Fig.4 The flowchart of CNN model</p>
</center></li>
<li><p>Step 3: Using the best trained CNN model classifies the test sample.</p></li>
</ul>
<p>In this study, CNN is coded by Python 3.8. We employ a Python library, PyTorch, which provides convenient APIs for building Deep learning network.</p>
<h3 id="code-implementation">3.5.2 Code implementation</h3>
<h4 id="prepare-data">Prepare data</h4>
<ol type="1">
<li><p>Import modelus</p></li>
<li><p>Load data</p>
<p>Examples for news data and oil price movement, see Table 5:</p>
<center>
<p>Table 5 Examples for news and oil price movement</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Date</p>
</th>
<th>
<p>Movement</p>
</th>
<th>
<p>Title</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>2011-08-01</p>
</td>
<td>
<p>-1.0</p>
</td>
<td>
<p>Debt Ceiling Agreement Pushes Crude Oil Prices Higher. Biofuels and Tequila: Agave May Make a Suitable Ethanol Crop. Jesters, Economics, and American Dollar Supremacy. Natural Gas Analysis for the Week of August 1, 2011. The Quiet Revolution: Latin America Moving Away from Washingtons Influence</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>Spilt data into train/valid test</p></li>
<li><p>Generate dataset</p>
<ul>
<li><p>Examples for built dataset.</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#39;text&#39;: [&#39;The&#39;, &#39;Death&#39;, &#39;of&#39;, &#39;the&#39;, &#39;Bond&#39;, &#39;Vigilantes&#39;, &#39;.&#39;, &#39;Promising&#39;,</span><br><span class="line"> &#39;Economic&#39;, &#39;and&#39;, &#39;Environmental&#39;, &#39;Developments&#39;, &#39;in&#39;, &#39;Oil&#39;, &#39;Sands&#39;,</span><br><span class="line"> &#39;Production&#39;, &#39;.&#39;, &#39;Are&#39;, &#39;High&#39;, &#39;Fuel&#39;, &#39;Taxes&#39;, &#39;the&#39;, &#39;Answer&#39;, &#39;to&#39;,</span><br><span class="line"> &#39;Solving&#39;, &#39;our&#39;, &#39;Energy&#39;, &#39;Problems&#39;, &#39;?&#39;, &#39;.&#39;, &#39;Oil&#39;, &#39;and&#39;, &#39;Misinformation&#39;,</span><br><span class="line"> &#39;:&#39;, &#39;The&#39;, &#39;Truth&#39;, &#39;about&#39;, &#39;Oil&#39;, &#39;Companies&#39;, &#39;.&#39;, &#39;Arab&#39;, &#39;Spring&#39;, &#39;Roils&#39;,</span><br><span class="line"> &#39;Israel&#39;, &quot;&#39;s&quot;, &#39;Energy&#39;, &#39;Imports&#39;, &#39;-&#39;, &#39;and&#39;, &#39;Israel&#39;], &#39;label&#39;: &#39;-1.0&#39;&#125;</span><br><span class="line">&#123;&#39;text&#39;: [&#39;Is&#39;, &#39;A&#39;, &#39;Supply&#39;, &#39;Crunch&#39;, &#39;In&#39;, &#39;Oil&#39;, &#39;Markets&#39;, &#39;Inevitable&#39;,</span><br><span class="line"> &#39;?&#39;, &#39;.&#39;, &#39;China&#39;, &#39;Sets&#39;, &#39;Up&#39;, &#39;EV&#39;, &#39;Battery&#39;, &#39;Recycling&#39;, &#39;Scheme&#39;, &#39;.&#39;,</span><br><span class="line"> &#39;U.S.&#39;, &#39;Military&#39;, &#39;Bases&#39;, &#39;In&#39;, &#39;Europe&#39;, &#39;Depend&#39;, &#39;On&#39;, &#39;Russian&#39;, &#39;Energy&#39;,</span><br><span class="line"> &#39;.&#39;, &#39;Russias&#39;, &#39;High&#39;, &#39;Risk&#39;, &#39;Global&#39;, &#39;Oil&#39;, &#39;Strategy&#39;, &#39;.&#39;, &#39;Oil&#39;, &#39;Prices&#39;,</span><br><span class="line"> &#39;Fall&#39;, &#39;After&#39;, &#39;EIA&#39;, &#39;Confirms&#39;, &#39;Crude&#39;, &#39;Inventory&#39;, &#39;Build&#39;, &#39;.&#39;, &#39;Exxons&#39;,</span><br><span class="line"> &#39;Shocking&#39;, &#39;Supply&#39;, &#39;And&#39;, &#39;Demand&#39;, &#39;Predictions&#39;, &#39;.&#39;, &#39;Was&#39;, &#39;The&#39;, &#39;Aramco&#39;,</span><br><span class="line"> &#39;IPO&#39;, &#39;Destined&#39;, &#39;To&#39;, &#39;Fail&#39;, &#39;?&#39;, &#39;.&#39;, &#39;Kuwait&#39;, &#39;Oil&#39;, &#39;Production&#39;, &#39;Hits&#39;,</span><br><span class="line"> &#39;18-Month&#39;, &#39;High&#39;, &#39;.&#39;, &#39;U.S.&#39;, &#39;Oil&#39;, &#39;Production&#39;, &#39;Is&#39;, &#39;nt&#39;, &#39;Growing&#39;, &#39;As&#39;,</span><br><span class="line"> &#39;Fast&#39;, &#39;As&#39;, &#39;Expected&#39;], &#39;label&#39;: &#39;-1.0&#39;&#125;</span><br></pre></td></tr></table></figure></p></li>
</ul></li>
<li><p>Build vocabulary and iterator</p>
<p>vocabulary size is 11023. And an example:</p>
<pre><code> torch.Size([4, 125])
 Oil Prices At Risk Of Economic Downturn . Oil Sector Under Fire In Libyan
 Corruption Crackdown . Houston To Overtake Cushing As Key Hub . Oil Prices
 Slip As OPEC+ Compliance Falls To 120 Percent In June . Is This The Next Global
 Leader In Ride Hailing Services ? . China Just Doubled Oil Shipments To North Korea .
 Has The Movement For CO2 Controls Peaked ? . Iran Files Complaint Against U.S.
 For Unlawful Sanctions . Oil Prices Rebound As Saudis Expect Reduced Exports In
 August &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt;
 &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt;
 &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt; &lt;pad&gt;

 1.0</code></pre></li>
<li><p>The top 20 of most frequents:</p>
<p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[(&#39;.&#39;, 21723), (&#39;Oil&#39;, 10901), (&#39;The&#39;, 6349), (&#39;To&#39;, 4153), (&#39;?&#39;, 3750),</span><br><span class="line">(&#39;In&#39;, 3002), (&#39;Is&#39;, 2705), (&#39;Energy&#39;, 2585), (&#39;Prices&#39;, 2342), (&#39;For&#39;, 2230),</span><br><span class="line">(&#39;A&#39;, 2119), (&#39;U.S.&#39;, 1919), (&#39;:&#39;, 1864), (&#39;Of&#39;, 1840), (&#39;Gas&#39;, 1714),</span><br><span class="line">(&#39;On&#39;, 1697), (&#39;-&#39;, 1629), (&#39;,&#39;, 1474), (&#39;the&#39;, 1422), (&#39;As&#39;, 1395)]</span><br><span class="line">[(&#39;1.0&#39;, 1310), (&#39;-1.0&#39;, 1207)]</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h4 id="model-specification">Model specification</h4>
<ol type="1">
<li><p>Model definition</p></li>
<li><p>Creat CNN model</p></li>
<li><p>Define metrics</p></li>
<li><p>Train and evaluation</p></li>
<li><p>Predict with trained model</p>
<ul>
<li><p>Full-sample evaluation</p>
<pre><code>Loss:0.53
Accuracy:0.83

Classification Report:
              precision    recall  f1-score   support

         0.0       0.91      0.70      0.79      1207
         1.0       0.77      0.94      0.85      1310

    accuracy                           0.83      2517
   macro avg       0.84      0.82      0.82      2517
weighted avg       0.84      0.83      0.82      2517</code></pre></li>
<li><p>Out-of-sample evaluation (test dataset)</p>
<pre><code>Loss:0.58
Accuracy:0.58

Classification Report:
              precision    recall  f1-score   support

         0.0       0.58      0.28      0.38       352
         1.0       0.58      0.83      0.68       418

    accuracy                           0.58       770
   macro avg       0.58      0.55      0.53       770
weighted avg       0.58      0.58      0.54       770</code></pre></li>
<li><p>Examples of trends</p>
<pre><code>Date
2011-08-02    0.475409
2011-08-01    0.533262
2011-08-01    0.426512
2011-08-01    0.278523
2011-08-01    0.662444
Name: Title, dtype: float64</code></pre></li>
<li><p>Examples of titles</p>
<pre><code>Date
2014-11-28           Global Energy Advisory  28th November 2014
2016-02-16       UAE Offers India Free Oil To Ease Storage Woes
2017-10-09    Oil Stable After OPEC Chief Suggests Extraordi...
2019-09-17                          Why Oil Prices Just Fell 6%
2020-05-01             The Oil Nations On The Brink Of Collapse
Name: Title, dtype: object</code></pre></li>
<li><p>View all data (Table 6)</p>
<center>
<p>Table 6 All processed data</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Date</p>
</th>
<th>
<p>Movement</p>
</th>
<th>
<p>Title</p>
</th>
<th>
<p>Prediction</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>2011-08-01</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>Debt Ceiling Agreement Pushes Crude Oil Prices...</p>
</td>
<td>
<p>0.415019</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>2011-08-02</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>The Death of the Bond Vigilantes. Promising Ec...</p>
</td>
<td>
<p>0.247126</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>2011-08-03</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>What the Markets Are Telling Us. Putin Calls U...</p>
</td>
<td>
<p>0.304862</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>2011-08-04</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>China's Rare Earth Industry Coming under Great...</p>
</td>
<td>
<p>0.251284</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>2011-08-05</p>
</td>
<td>
<p>1.0</p>
</td>
<td>
<p>Here is Where to Watch for the Turn. Why High ...</p>
</td>
<td>
<p>0.777504</p>
</td>
</tr>
<tr>
<th>
<p>...</p>
</th>
<td>
<p>...</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>...</p>
</td>
</tr>
<tr>
<th>
<p>2512</p>
</th>
<td>
<p>2021-07-26</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>Can Iran Avoid A Major National Uprising?. Mid...</p>
</td>
<td>
<p>0.375821</p>
</td>
</tr>
<tr>
<th>
<p>2513</p>
</th>
<td>
<p>2021-07-27</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>The EV Battery Conundrum: Commodity Rally Coul...</p>
</td>
<td>
<p>0.409420</p>
</td>
</tr>
<tr>
<th>
<p>2514</p>
</th>
<td>
<p>2021-07-28</p>
</td>
<td>
<p>1.0</p>
</td>
<td>
<p>The Best Risk-Reward Plays In Oil. 5 Reasons W...</p>
</td>
<td>
<p>0.462076</p>
</td>
</tr>
<tr>
<th>
<p>2515</p>
</th>
<td>
<p>2021-07-29</p>
</td>
<td>
<p>1.0</p>
</td>
<td>
<p>Shrinking Global Populations Poses An Existent...</p>
</td>
<td>
<p>0.644484</p>
</td>
</tr>
<tr>
<th>
<p>2516</p>
</th>
<td>
<p>2021-07-30</p>
</td>
<td>
<p>1.0</p>
</td>
<td>
<p>Is Americas Oil Industry Too Big To Fail?. Net...</p>
</td>
<td>
<p>0.659020</p>
</td>
</tr>
</tbody>
</table>
<p>
<p>2517 rows × 4 columns</p>
</p></li>
</ul></li>
</ol>
<h2 id="lda-topic-model">3.6 LDA topic model</h2>
<h3 id="introduction-4">3.6.1 Introduction</h3>
<p>Referring to <a href="https://doi.org/10.1016/j.ijforecast.2018.07.006">Li et al.</a>, We also apply the Latent Dirichlet Allocation (LDA) modelling approach of <a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C5&amp;q=Latent+Dirichlet+allocation.+Journal+of+Machine+Learning+Research&amp;btnG=">Blei, Ng, and Jordan (2003)</a> in order to identify latent topics embedded within the news headlines corpus. We mainly adopt two Python library, <a href="https://github.com/MIND-Lab/OCTIS/blob/master/octis/evaluation_metrics/diversity_metrics.py#L12">OCITS</a> and <a href="https://radimrehurek.com/gensim/">gensim</a>, for implementing the LDA model.</p>
<p>The LDA model is based on the assumption that <strong>each document is a mixture of various topics, and each topic has a corresponding probability distribution for different words.</strong> Each document <span class="math inline">\(d\)</span> is viewed as a multinomial distribution <span class="math inline">\(\theta (d)\)</span> over <span class="math inline">\(T\)</span> topics, and each topic <span class="math inline">\(z_j\)</span>, <span class="math inline">\(j = 1 \dots T\)</span>, is assumed to have a multinomial distribution <span class="math inline">\(\phi (j)\)</span> over the set of words <span class="math inline">\(W\)</span>. In order to uncover both the topics that are present and the distribution of these topics in each document from a corpus of documents, <span class="math inline">\(D\)</span>, estimates of <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\phi\)</span> are required.</p>
<p>Previously, topic models are usually compared by fixing their hyperparameters. However, <a href="https://aclanthology.org/2021.eacl-demos.31/">Terragni et al.</a> points out that choosing the optimal hyperparameter configuration for given dataset and a given evaluation metrics is fundamental to induce each model at the best of its capabilities, and therefore to gurantee a fair comparison with othr models. Therefore, to select a optimal topic number for topic modelling, we employ a unified and open-source evaluation framework, <a href="https://github.com/MIND-Lab/OCTIS">OCTIS</a> for comparing Topic Models, whose optimal hyper-parameters configuration can be determined according to Bayesian Optimization strategy (<a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C5&amp;q=Bayesian+Optimization+and+Data+Science&amp;btnG=">Archetti and Candelieri, 2019</a>; <a href="https://proceedings.neurips.cc/paper/2012/hash/05311655a15b75fab86956663e1819cd-Abstract.html">Snoek et al.</a>, 2012; <a href="https://link.springer.com/article/10.1007/s10287-020-00376-3">Galuzzi et al., 2020</a>). The <a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C5&amp;q=Leveraging+Kullback%E2%80%93Leibler+divergence+measures+and+information-rich+cues+for+speech+summarization&amp;btnG=">Kullback–Leibler (KL)</a> divergence approach was used to determine the topic number <span class="math inline">\(T\)</span>. The results see Table 6.</p>
<center>
Table 6 Topic_KL divergence of topic numbers, ranging from 2 to 19.
</center>
<table border="1" class="dataframe">
<tbody>
<tr>
<td>
Number of topics
</td>
<td>
2
</td>
<td>
3
</td>
<td>
<b>4</b>
</td>
<td>
5
</td>
<td>
6
</td>
<td>
7
</td>
<td>
8
</td>
<td>
9
</td>
<td>
10
</td>
</tr>
<tr>
<td>
Topic_KL divergence
</td>
<td>
0.8879
</td>
<td>
1.0784
</td>
<td>
<b>1.0139<b/>
</td>
<td>
1.0088
</td>
<td>
0.9177
</td>
<td>
0.7942
</td>
<td>
0.7695
</td>
<td>
0.7423
</td>
<td>
0.627
</td>
</tr>
<tr>
<td>
Number of topics
</td>
<td>
11
</td>
<td>
12
</td>
<td>
13
</td>
<td>
14
</td>
<td>
15
</td>
<td>
16
</td>
<td>
17
</td>
<td>
18
</td>
<td>
19
</td>
</tr>
<tr>
<td>
Topic_KL divergence
</td>
<td>
0.5637
</td>
<td>
0.5432
</td>
<td>
0.5194
</td>
<td>
0.4878
</td>
<td>
0.5022
</td>
<td>
0.434
</td>
<td>
0.3936
</td>
<td>
0.3899
</td>
<td>
0.4147
</td>
</tr>
</tbody>
</table>
<p>It can be see that the maximum KL divergence metric value is 1.0139, where the number of topic is 4. Therefore, we believe that the optimal number of topics for LDA model is 4. For each topic during each transaction day, we compute average scores for the results of the sentimentanalysis and CNN classifications, to form sentiment-topic features and CNN-topic features.</p>
<p>These topic features are defined as follows:</p>
<ul>
<li><p>Sentiment-topic score of topic <span class="math inline">\(k\)</span> on day <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[SE_{k,t} = \frac{1}{n_{k,t}} \sum SE_i\]</span></p></li>
<li><p>Polarity-topic score of topic <span class="math inline">\(k\)</span> on day <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[P_{k,t} = \frac{1}{n_{k,t}} \sum P_i\]</span></p></li>
<li><p>Subjectivity-topic score of topic <span class="math inline">\(k\)</span> on day <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[SU_{k,t} = \frac{1}{n_{k,t}} \sum SU_i\]</span></p></li>
<li><p>CNN-topic score of topic <span class="math inline">\(k\)</span> on day <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[C_{k, t} = \frac{1}{n_{k,t}} \sum C_i\]</span></p>
<p>Where <span class="math inline">\(n_{k, t}\)</span> is the total number of news headlines (or full-text) from topic <span class="math inline">\(k\)</span> on day <span class="math inline">\(t\)</span>, <span class="math inline">\(SE_{k,t}\)</span> is the investor sentiment (including postive, negative and neutral) of news headline (or full-text) <span class="math inline">\(i\)</span> belonging to topic <span class="math inline">\(k\)</span> on day <span class="math inline">\(t\)</span>. <span class="math inline">\(P_i\)</span>, <span class="math inline">\(SU_i\)</span> are the polarity score and subjectivity score of news headline (or full-text) <span class="math inline">\(i\)</span> belonging to topic <span class="math inline">\(k\)</span> on day <span class="math inline">\(t\)</span>, respectively.</p></li>
</ul>
<h3 id="code-implementation-1">3.6.2 Code implementation</h3>
<h4 id="configurations">Configurations</h4>
<ol type="1">
<li>Import moduls</li>
<li>Stopwords</li>
<li>Load data</li>
<li>Load dataset</li>
<li>Build vocabulary (vocab size: 7653)</li>
</ol>
<h4 id="choosing-the-optimal-topic-numbers-with-octis">Choosing the optimal topic numbers with OCTIS</h4>
<ul>
<li><p>Calculate KL_divergences, see Table 7:</p>
<center>
<p>Table 7 KL_divergences for different numbers of topic models</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>0</p>
</th>
<th>
<p>1</p>
</th>
<th>
<p>2</p>
</th>
<th>
<p>3</p>
</th>
<th>
<p>4</p>
</th>
<th>
<p>5</p>
</th>
<th>
<p>6</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>Number of topics</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>4</p>
</td>
<td>
<p>5</p>
</td>
<td>
<p>6</p>
</td>
<td>
<p>7</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>Topic_KL divergence</p>
</td>
<td>
<p>0.8879</p>
</td>
<td>
<p>1.0784</p>
</td>
<td>
<p>1.0139</p>
</td>
<td>
<p>1.0088</p>
</td>
<td>
<p>0.9177</p>
</td>
<td>
<p>0.7942</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>Number of topics</p>
</td>
<td>
<p>8</p>
</td>
<td>
<p>9</p>
</td>
<td>
<p>10</p>
</td>
<td>
<p>11</p>
</td>
<td>
<p>12</p>
</td>
<td>
<p>13</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>Topic_KL divergence</p>
</td>
<td>
<p>0.7695</p>
</td>
<td>
<p>0.7423</p>
</td>
<td>
<p>0.627</p>
</td>
<td>
<p>0.5637</p>
</td>
<td>
<p>0.5432</p>
</td>
<td>
<p>0.5194</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>Number of topics</p>
</td>
<td>
<p>14</p>
</td>
<td>
<p>15</p>
</td>
<td>
<p>16</p>
</td>
<td>
<p>17</p>
</td>
<td>
<p>18</p>
</td>
<td>
<p>19</p>
</td>
</tr>
<tr>
<th>
<p>5</p>
</th>
<td>
<p>Topic_KL divergence</p>
</td>
<td>
<p>0.4878</p>
</td>
<td>
<p>0.5022</p>
</td>
<td>
<p>0.434</p>
</td>
<td>
<p>0.3936</p>
</td>
<td>
<p>0.3899</p>
</td>
<td>
<p>0.4147</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Conclusion</strong>: It can be see that the maximum KL divergence metric value is 1.0139, where the number of topic is 4. Therefore, we believe that the optimal number of topics for LDA model is 4.</p></li>
</ul>
<h4 id="topic-modelling-with-gensim">Topic modelling with gensim</h4>
<ol type="1">
<li><p>Participle</p></li>
<li><p>Lemmatization</p>
<p>Results see Table 8:</p>
<center>
<p>Table 8 An example of news after lemmatizing</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Date</p>
</th>
<th>
<p>Price</p>
</th>
<th>
<p>Movement</p>
</th>
<th>
<p>Title</p>
</th>
<th>
<p>Time</p>
</th>
<th>
<p>Trends</p>
</th>
<th>
<p>Title_senti</p>
</th>
<th>
<p>Title_Prediction</p>
</th>
<th>
<p>Title_Pos</p>
</th>
<th>
<p>Title_Neg</p>
</th>
<th>
<p>...</p>
</th>
<th>
<p>Content_Pos</p>
</th>
<th>
<p>Content_Neg</p>
</th>
<th>
<p>Content_Neutral</p>
</th>
<th>
<p>Polarity_score</p>
</th>
<th>
<p>Subjectivity_score</p>
</th>
<th>
<p>Content_Polarity_score</p>
</th>
<th>
<p>Content_Subjectivity_score</p>
</th>
<th>
<p>Title_tokenize</p>
</th>
<th>
<p>Title_tokenize_list</p>
</th>
<th>
<p>Lemmatization</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>8/2/2011</p>
</td>
<td>
<p>93.79</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>The Death of the Bond Vigilantes</p>
</td>
<td>
<p>8/1/2011 18:00</p>
</td>
<td>
<p>0.475409</p>
</td>
<td>
<p>-0.453832</p>
</td>
<td>
<p>negative</p>
</td>
<td>
<p>0.036499</p>
</td>
<td>
<p>0.490331</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.036499</p>
</td>
<td>
<p>0.490331</p>
</td>
<td>
<p>0.47317</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>0.0</p>
</td>
<td>
<p>0.006143</p>
</td>
<td>
<p>0.469498</p>
</td>
<td>
<p>The Death of the Bond Vigilantes</p>
</td>
<td>
<p>[The, Death, of, the, Bond, Vigilantes]</p>
</td>
<td>
<p>[Death, Bond, Vigilantes]</p>
</td>
</tr>
</tbody>
</table>
<p>
<p><b>Shape</b>: 1 rows × 23 columns</p>
</p></li>
<li><p>Remove stopwords (see Table 9)</p>
<center>
<p>Table 9 5 examples of news after removing stopwords</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Date</p>
</th>
<th>
<p>Price</p>
</th>
<th>
<p>Movement</p>
</th>
<th>
<p>Title</p>
</th>
<th>
<p>Time</p>
</th>
<th>
<p>Trends</p>
</th>
<th>
<p>Title_senti</p>
</th>
<th>
<p>Title_Prediction</p>
</th>
<th>
<p>Title_Pos</p>
</th>
<th>
<p>Title_Neg</p>
</th>
<th>
<p>...</p>
</th>
<th>
<p>Content_Neg</p>
</th>
<th>
<p>Content_Neutral</p>
</th>
<th>
<p>Polarity_score</p>
</th>
<th>
<p>Subjectivity_score</p>
</th>
<th>
<p>Content_Polarity_score</p>
</th>
<th>
<p>Content_Subjectivity_score</p>
</th>
<th>
<p>Title_tokenize</p>
</th>
<th>
<p>Title_tokenize_list</p>
</th>
<th>
<p>Lemmatization</p>
</th>
<th>
<p>Lemma_stopwords</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>8/2/2011</p>
</td>
<td>
<p>93.79</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>The Death of the Bond Vigilantes</p>
</td>
<td>
<p>8/1/2011 18:00</p>
</td>
<td>
<p>0.475409</p>
</td>
<td>
<p>-0.453832</p>
</td>
<td>
<p>negative</p>
</td>
<td>
<p>0.036499</p>
</td>
<td>
<p>0.490331</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.490331</p>
</td>
<td>
<p>0.473170</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.00</p>
</td>
<td>
<p>0.006143</p>
</td>
<td>
<p>0.469498</p>
</td>
<td>
<p>The Death of the Bond Vigilantes</p>
</td>
<td>
<p>[The, Death, of, the, Bond, Vigilantes]</p>
</td>
<td>
<p>[Death, Bond, Vigilantes]</p>
</td>
<td>
<p>[Death, Bond, Vigilantes]</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Debt Ceiling Agreement Pushes Crude Oil Prices...</p>
</td>
<td>
<p>8/1/2011 08:50</p>
</td>
<td>
<p>0.533262</p>
</td>
<td>
<p>-0.865410</p>
</td>
<td>
<p>negative</p>
</td>
<td>
<p>0.050545</p>
</td>
<td>
<p>0.915956</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.915956</p>
</td>
<td>
<p>0.033499</p>
</td>
<td>
<p>-0.225</p>
</td>
<td>
<p>0.75</p>
</td>
<td>
<p>-0.025652</p>
</td>
<td>
<p>0.416797</p>
</td>
<td>
<p>Debt Ceiling Agreement Pushes Crude Oil Prices...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, Pushes, Crude, Oil,...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, push, Crude, Oil, p...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, push, Crude, price,...</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Biofuels and Tequila: Agave May Make a Suitabl...</p>
</td>
<td>
<p>8/1/2011 07:12</p>
</td>
<td>
<p>0.426512</p>
</td>
<td>
<p>0.309331</p>
</td>
<td>
<p>neutral</p>
</td>
<td>
<p>0.316535</p>
</td>
<td>
<p>0.007204</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.007204</p>
</td>
<td>
<p>0.676260</p>
</td>
<td>
<p>0.550</p>
</td>
<td>
<p>0.75</p>
</td>
<td>
<p>0.150435</p>
</td>
<td>
<p>0.560072</p>
</td>
<td>
<p>Biofuels and Tequila : Agave May Make a Suitab...</p>
</td>
<td>
<p>[Biofuels, and, Tequila, :, Agave, May, Make, ...</p>
</td>
<td>
<p>[Biofuels, Tequila, Agave, May, make, suitable...</p>
</td>
<td>
<p>[Biofuels, Tequila, Agave, May, make, suitable...</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Jesters, Economics, and American Dollar Supremacy</p>
</td>
<td>
<p>8/1/2011 07:18</p>
</td>
<td>
<p>0.278523</p>
</td>
<td>
<p>0.001767</p>
</td>
<td>
<p>neutral</p>
</td>
<td>
<p>0.038573</p>
</td>
<td>
<p>0.036806</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.036806</p>
</td>
<td>
<p>0.924621</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.00</p>
</td>
<td>
<p>0.056149</p>
</td>
<td>
<p>0.392723</p>
</td>
<td>
<p>Jesters , Economics , and American Dollar Supr...</p>
</td>
<td>
<p>[Jesters, ,, Economics, ,, and, American, Doll...</p>
</td>
<td>
<p>[Jesters, Economics, American, Dollar, Supremacy]</p>
</td>
<td>
<p>[Jesters, Economics, American, Dollar, Supremacy]</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Natural Gas Analysis for the Week of August 1,...</p>
</td>
<td>
<p>8/1/2011 07:15</p>
</td>
<td>
<p>0.662444</p>
</td>
<td>
<p>-0.032567</p>
</td>
<td>
<p>neutral</p>
</td>
<td>
<p>0.020734</p>
</td>
<td>
<p>0.053301</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.053301</p>
</td>
<td>
<p>0.925965</p>
</td>
<td>
<p>0.100</p>
</td>
<td>
<p>0.40</p>
</td>
<td>
<p>0.099722</p>
</td>
<td>
<p>0.475185</p>
</td>
<td>
<p>Natural Gas Analysis for the Week of August 1 ...</p>
</td>
<td>
<p>[Natural, Gas, Analysis, for, the, Week, of, A...</p>
</td>
<td>
<p>[Natural, Gas, Analysis, Week, August]</p>
</td>
<td>
<p>[Natural, Gas, Analysis, Week, August]</p>
</td>
</tr>
</tbody>
</table>
<p>
<p><b>Shape</b>: 5 rows × 24 columns</p>
</p></li>
<li><p>Build the bigram</p>
<center>
<p>Table 10 5 examples of news after bigram processing</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Date</p>
</th>
<th>
<p>Price</p>
</th>
<th>
<p>Movement</p>
</th>
<th>
<p>Title</p>
</th>
<th>
<p>Time</p>
</th>
<th>
<p>Trends</p>
</th>
<th>
<p>Title_senti</p>
</th>
<th>
<p>Title_Prediction</p>
</th>
<th>
<p>Title_Pos</p>
</th>
<th>
<p>Title_Neg</p>
</th>
<th>
<p>...</p>
</th>
<th>
<p>Polarity_score</p>
</th>
<th>
<p>Subjectivity_score</p>
</th>
<th>
<p>Content_Polarity_score</p>
</th>
<th>
<p>Content_Subjectivity_score</p>
</th>
<th>
<p>Title_tokenize</p>
</th>
<th>
<p>Title_tokenize_list</p>
</th>
<th>
<p>Lemmatization</p>
</th>
<th>
<p>Lemma_stopwords</p>
</th>
<th>
<p>Bigrams</p>
</th>
<th>
<p>Trigrams</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>24037</p>
</th>
<td>
<p>7/1/2021</p>
</td>
<td>
<p>75.23</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Iraq Uses Controversial Oil Deal To Secure Fun...</p>
</td>
<td>
<p>6/30/2021 18:00</p>
</td>
<td>
<p>0.656656</p>
</td>
<td>
<p>0.642171</p>
</td>
<td>
<p>positive</p>
</td>
<td>
<p>0.657396</p>
</td>
<td>
<p>0.015225</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.475</p>
</td>
<td>
<p>0.775</p>
</td>
<td>
<p>0.037309</p>
</td>
<td>
<p>0.361200</p>
</td>
<td>
<p>Iraq Uses Controversial Oil Deal To Secure Fun...</p>
</td>
<td>
<p>[Iraq, Uses, Controversial, Oil, Deal, To, Sec...</p>
</td>
<td>
<p>[Iraq, use, Controversial, Oil, deal, secure, ...</p>
</td>
<td>
<p>[Iraq, use, Controversial, deal, secure, fundi...</p>
</td>
<td>
<p>[Iraq, use, Controversial, deal, secure, fundi...</p>
</td>
<td>
<p>[Iraq, use, Controversial, deal, secure, fundi...</p>
</td>
</tr>
<tr>
<th>
<p>8990</p>
</th>
<td>
<p>7/5/2016</p>
</td>
<td>
<p>46.60</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>U.S. Sees Largest Monthly Production Decline S...</p>
</td>
<td>
<p>7/2/2016 08:27</p>
</td>
<td>
<p>0.475362</p>
</td>
<td>
<p>-0.964390</p>
</td>
<td>
<p>negative</p>
</td>
<td>
<p>0.007528</p>
</td>
<td>
<p>0.971918</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.147672</p>
</td>
<td>
<p>0.551499</p>
</td>
<td>
<p>U.S. Sees Largest Monthly Production Decline S...</p>
</td>
<td>
<p>[U.S., Sees, Largest, Monthly, Production, Dec...</p>
</td>
<td>
<p>[U.S., see, large, monthly, production, declin...</p>
</td>
<td>
<p>[U.S., see, large, monthly, production, declin...</p>
</td>
<td>
<p>[U.S., see, large, monthly, production, declin...</p>
</td>
<td>
<p>[U.S., see, large, monthly, production, declin...</p>
</td>
</tr>
<tr>
<th>
<p>14319</p>
</th>
<td>
<p>5/7/2018</p>
</td>
<td>
<p>70.73</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>Banking Giants To Choose Sides In Saudi-Qatar ...</p>
</td>
<td>
<p>5/5/2018 16:00</p>
</td>
<td>
<p>0.713667</p>
</td>
<td>
<p>0.060967</p>
</td>
<td>
<p>neutral</p>
</td>
<td>
<p>0.080845</p>
</td>
<td>
<p>0.019878</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.063642</p>
</td>
<td>
<p>0.385634</p>
</td>
<td>
<p>Banking Giants To Choose Sides In Saudi-Qatar ...</p>
</td>
<td>
<p>[Banking, Giants, To, Choose, Sides, In, Saudi...</p>
</td>
<td>
<p>[banking, giant, choose, side, Saudi, Qatar, R...</p>
</td>
<td>
<p>[banking, giant, choose, side, Saudi, Qatar, R...</p>
</td>
<td>
<p>[banking, giant, choose, side, Saudi, Qatar, R...</p>
</td>
<td>
<p>[banking, giant, choose, side, Saudi, Qatar, R...</p>
</td>
</tr>
<tr>
<th>
<p>24237</p>
</th>
<td>
<p>7/22/2021</p>
</td>
<td>
<p>71.91</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>China Taps Into Crude Reserves To Curb Oil Pri...</p>
</td>
<td>
<p>7/22/2021 10:00</p>
</td>
<td>
<p>0.778163</p>
</td>
<td>
<p>0.539656</p>
</td>
<td>
<p>positive</p>
</td>
<td>
<p>0.599639</p>
</td>
<td>
<p>0.059983</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>-0.700</p>
</td>
<td>
<p>1.000</p>
</td>
<td>
<p>-0.088148</p>
</td>
<td>
<p>0.504259</p>
</td>
<td>
<p>China Taps Into Crude Reserves To Curb Oil Pri...</p>
</td>
<td>
<p>[China, Taps, Into, Crude, Reserves, To, Curb,...</p>
</td>
<td>
<p>[China, tap, crude, reserve, Curb, Oil, Price,...</p>
</td>
<td>
<p>[China, tap, crude, reserve, Curb, Price, Rally]</p>
</td>
<td>
<p>[China, tap, crude, reserve, Curb, Price, Rally]</p>
</td>
<td>
<p>[China, tap, crude, reserve, Curb, Price, Rally]</p>
</td>
</tr>
<tr>
<th>
<p>22368</p>
</th>
<td>
<p>12/17/2020</p>
</td>
<td>
<p>48.36</p>
</td>
<td>
<p>1</p>
</td>
<td>
<p>An Under-The-Radar Opportunity In LNG</p>
</td>
<td>
<p>12/17/2020 13:00</p>
</td>
<td>
<p>0.293937</p>
</td>
<td>
<p>0.543063</p>
</td>
<td>
<p>positive</p>
</td>
<td>
<p>0.559450</p>
</td>
<td>
<p>0.016386</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.000</p>
</td>
<td>
<p>0.109774</p>
</td>
<td>
<p>0.374197</p>
</td>
<td>
<p>An Under-The-Radar Opportunity In LNG</p>
</td>
<td>
<p>[An, Under-The-Radar, Opportunity, In, LNG]</p>
</td>
<td>
<p>[radar, opportunity, LNG]</p>
</td>
<td>
<p>[radar, opportunity, LNG]</p>
</td>
<td>
<p>[radar, opportunity, LNG]</p>
</td>
<td>
<p>[radar, opportunity, LNG]</p>
</td>
</tr>
</tbody>
</table>
<p>
<p><b>Shape</b>: 5 rows × 26 columns</p>
</p></li>
<li><p>Creat dictionary (Word2id &amp; id2word)</p></li>
<li><p>Build LDA model</p>
<p>We have determined the optimal topic_nums (4) with the help of <code>OCTIS</code> module. So we build a LDA model with 4 topics.</p>
<ul>
<li><p>Print topic information:</p>
<pre><code>[(0,
  &#39;0.070*&quot;U.S.&quot; + 0.040*&quot;Energy&quot; + 0.019*&quot;Saudi&quot; + 0.019*&quot;rise&quot; + &#39;
  &#39;0.018*&quot;Shale&quot; + 0.015*&quot;Crude&quot; + 0.014*&quot;Arabia&quot; + 0.014*&quot;become&quot; + &#39;
  &#39;0.013*&quot;New&quot; + 0.012*&quot;year&quot;&#39;),
 (1,
  &#39;0.039*&quot;demand&quot; + 0.025*&quot;China&quot; + 0.019*&quot;soar&quot; + 0.018*&quot;major&quot; + &#39;
  &#39;0.016*&quot;energy&quot; + 0.013*&quot;Russia&quot; + 0.012*&quot;cut&quot; + 0.012*&quot;Global&quot; + &#39;
  &#39;0.011*&quot;renewable&quot; + 0.010*&quot;large&quot;&#39;),
 (2,
  &#39;0.032*&quot;market&quot; + 0.030*&quot;big&quot; + 0.020*&quot;see&quot; + 0.017*&quot;production&quot; + &#39;
  &#39;0.017*&quot;stock&quot; + 0.016*&quot;gas&quot; + 0.015*&quot;Industry&quot; + 0.014*&quot;ev&quot; + 0.011*&quot;look&quot; &#39;
  &#39;+ 0.011*&quot;Boom&quot;&#39;),
 (3,
  &#39;0.081*&quot;price&quot; + 0.029*&quot;Gas&quot; + 0.020*&quot;OPEC&quot; + 0.018*&quot;Iran&quot; + 0.017*&quot;high&quot; + &#39;
  &#39;0.016*&quot;boom&quot; + 0.015*&quot;Rig&quot; + 0.014*&quot;Count&quot; + 0.012*&quot;Natural&quot; + &#39;
  &#39;0.012*&quot;fuel&quot;&#39;)]</code></pre></li>
</ul></li>
<li><p>Topic infomation</p>
<ul>
<li><p>View model imformation, see Table 11:</p>
<center>
<p>Table 11 Some samples of news and the topic they belong to</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Document_No</p>
</th>
<th>
<p>Dominant_Topic</p>
</th>
<th>
<p>Topic_Perc_Contrib</p>
</th>
<th>
<p>Keywords</p>
</th>
<th>
<p>Title</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>0</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2679</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>The Death of the Bond Vigilantes</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>1</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2828</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>Debt Ceiling Agreement Pushes Crude Oil Prices...</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>2</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>0.2836</p>
</td>
<td>
<p>price, Gas, OPEC, Iran, high, boom, Rig, Count...</p>
</td>
<td>
<p>Biofuels and Tequila: Agave May Make a Suitabl...</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>3</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2724</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>Jesters, Economics, and American Dollar Supremacy</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>4</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2646</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>Natural Gas Analysis for the Week of August 1,...</p>
</td>
</tr>
<tr>
<th>
<p>5</p>
</th>
<td>
<p>5</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>0.2902</p>
</td>
<td>
<p>price, Gas, OPEC, Iran, high, boom, Rig, Count...</p>
</td>
<td>
<p>The Quiet Revolution: Latin America Moving Awa...</p>
</td>
</tr>
<tr>
<th>
<p>6</p>
</th>
<td>
<p>6</p>
</td>
<td>
<p>2</p>
</td>
<td>
<p>0.2600</p>
</td>
<td>
<p>market, big, see, production, stock, gas, Indu...</p>
</td>
<td>
<p>Promising Economic and Environmental Developme...</p>
</td>
</tr>
<tr>
<th>
<p>7</p>
</th>
<td>
<p>7</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>0.2629</p>
</td>
<td>
<p>price, Gas, OPEC, Iran, high, boom, Rig, Count...</p>
</td>
<td>
<p>Are High Fuel Taxes the Answer to Solving our ...</p>
</td>
</tr>
<tr>
<th>
<p>8</p>
</th>
<td>
<p>8</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2719</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>Oil and Misinformation: The Truth about Oil Co...</p>
</td>
</tr>
<tr>
<th>
<p>9</p>
</th>
<td>
<p>9</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2545</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>Arab Spring Roils Israel's Energy Imports - an...</p>
</td>
</tr>
</tbody>
</table>
<p>Where,</p>
<ul>
<li>Document_No: The id for title;</li>
<li>Dominant_Topic: The topic to which this title most likely belongs</li>
<li>Topic_Perc_Contrib: The probability of being classified under this topic</li>
<li>Keywords: the keywords of the topic</li>
<li>Text: The title's content after participle</li>
</ul></li>
<li><p>Extract information, see Table 12:</p>
<center>
<p>Table 12 Concatenated table with all features</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Date</p>
</th>
<th>
<p>Price</p>
</th>
<th>
<p>Movement</p>
</th>
<th>
<p>Title</p>
</th>
<th>
<p>Time</p>
</th>
<th>
<p>Trends</p>
</th>
<th>
<p>Title_senti</p>
</th>
<th>
<p>Title_Prediction</p>
</th>
<th>
<p>Title_Pos</p>
</th>
<th>
<p>Title_Neg</p>
</th>
<th>
<p>...</p>
</th>
<th>
<p>Content_Subjectivity_score</p>
</th>
<th>
<p>Title_tokenize</p>
</th>
<th>
<p>Title_tokenize_list</p>
</th>
<th>
<p>Lemmatization</p>
</th>
<th>
<p>Lemma_stopwords</p>
</th>
<th>
<p>Bigrams</p>
</th>
<th>
<p>Trigrams</p>
</th>
<th>
<p>Dominant_Topic</p>
</th>
<th>
<p>Topic_Perc_Contrib</p>
</th>
<th>
<p>Keywords</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>8/2/2011</p>
</td>
<td>
<p>93.79</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>The Death of the Bond Vigilantes</p>
</td>
<td>
<p>8/1/2011 18:00</p>
</td>
<td>
<p>0.475409</p>
</td>
<td>
<p>-0.453832</p>
</td>
<td>
<p>negative</p>
</td>
<td>
<p>0.036499</p>
</td>
<td>
<p>0.490331</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.469498</p>
</td>
<td>
<p>The Death of the Bond Vigilantes</p>
</td>
<td>
<p>[The, Death, of, the, Bond, Vigilantes]</p>
</td>
<td>
<p>[Death, Bond, Vigilantes]</p>
</td>
<td>
<p>[Death, Bond, Vigilantes]</p>
</td>
<td>
<p>[Death, Bond, Vigilantes]</p>
</td>
<td>
<p>[Death, Bond, Vigilantes]</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2679</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Debt Ceiling Agreement Pushes Crude Oil Prices...</p>
</td>
<td>
<p>8/1/2011 08:50</p>
</td>
<td>
<p>0.533262</p>
</td>
<td>
<p>-0.865410</p>
</td>
<td>
<p>negative</p>
</td>
<td>
<p>0.050545</p>
</td>
<td>
<p>0.915956</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.416797</p>
</td>
<td>
<p>Debt Ceiling Agreement Pushes Crude Oil Prices...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, Pushes, Crude, Oil,...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, Pushes, Crude, Oil,...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, Pushes, Crude, pric...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, Pushes, Crude, pric...</p>
</td>
<td>
<p>[Debt, Ceiling, Agreement, Pushes, Crude, pric...</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2828</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Biofuels and Tequila: Agave May Make a Suitabl...</p>
</td>
<td>
<p>8/1/2011 07:12</p>
</td>
<td>
<p>0.426512</p>
</td>
<td>
<p>0.309331</p>
</td>
<td>
<p>neutral</p>
</td>
<td>
<p>0.316535</p>
</td>
<td>
<p>0.007204</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.560072</p>
</td>
<td>
<p>Biofuels and Tequila : Agave May Make a Suitab...</p>
</td>
<td>
<p>[Biofuels, and, Tequila, :, Agave, May, Make, ...</p>
</td>
<td>
<p>[biofuel, Tequila, Agave, make, suitable, etha...</p>
</td>
<td>
<p>[biofuel, Tequila, Agave, make, suitable, etha...</p>
</td>
<td>
<p>[biofuel, Tequila, Agave, make, suitable, etha...</p>
</td>
<td>
<p>[biofuel, Tequila, Agave, make, suitable, etha...</p>
</td>
<td>
<p>3</p>
</td>
<td>
<p>0.2836</p>
</td>
<td>
<p>price, Gas, OPEC, Iran, high, boom, Rig, Count...</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Jesters, Economics, and American Dollar Supremacy</p>
</td>
<td>
<p>8/1/2011 07:18</p>
</td>
<td>
<p>0.278523</p>
</td>
<td>
<p>0.001767</p>
</td>
<td>
<p>neutral</p>
</td>
<td>
<p>0.038573</p>
</td>
<td>
<p>0.036806</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.392723</p>
</td>
<td>
<p>Jesters , Economics , and American Dollar Supr...</p>
</td>
<td>
<p>[Jesters, ,, Economics, ,, and, American, Doll...</p>
</td>
<td>
<p>[Jesters, Economics, American, Dollar, Supremacy]</p>
</td>
<td>
<p>[Jesters, Economics, American, Dollar, Supremacy]</p>
</td>
<td>
<p>[Jesters, Economics, American, Dollar, Supremacy]</p>
</td>
<td>
<p>[Jesters, Economics, American, Dollar, Supremacy]</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2724</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>8/1/2011</p>
</td>
<td>
<p>94.89</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>Natural Gas Analysis for the Week of August 1,...</p>
</td>
<td>
<p>8/1/2011 07:15</p>
</td>
<td>
<p>0.662444</p>
</td>
<td>
<p>-0.032567</p>
</td>
<td>
<p>neutral</p>
</td>
<td>
<p>0.020734</p>
</td>
<td>
<p>0.053301</p>
</td>
<td>
<p>...</p>
</td>
<td>
<p>0.475185</p>
</td>
<td>
<p>Natural Gas Analysis for the Week of August 1 ...</p>
</td>
<td>
<p>[Natural, Gas, Analysis, for, the, Week, of, A...</p>
</td>
<td>
<p>[Natural, Gas, Analysis, Week, August]</p>
</td>
<td>
<p>[Natural, Gas, Analysis, Week, August]</p>
</td>
<td>
<p>[Natural, Gas, Analysis, Week, August]</p>
</td>
<td>
<p>[Natural, Gas, Analysis, Week, August]</p>
</td>
<td>
<p>0</p>
</td>
<td>
<p>0.2646</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
</tr>
</tbody>
</table>
<p>
<p><b>Shape</b>: 5 rows × 29 columns</p>
</p></li>
<li><p>Find the most representative document for each topic</p>
<center>
<p>Table 13 The most two representative document for each topic</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Topic_Num</p>
</th>
<th>
<p>Topic_Perc_Contrib</p>
</th>
<th>
<p>Keywords</p>
</th>
<th>
<p>Title</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>0.0</p>
</td>
<td>
<p>0.3072</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>U.S. Growth Fears Push Crude Oil Futures Close...</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>0.0</p>
</td>
<td>
<p>0.2951</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>Britain Opens its First Public Hydrogen Fillin...</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>1.0</p>
</td>
<td>
<p>0.2895</p>
</td>
<td>
<p>demand, China, soar, major, energy, Russia, cu...</p>
</td>
<td>
<p>UK's Largest Coal Power Plant to be Converted ...</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>1.0</p>
</td>
<td>
<p>0.2892</p>
</td>
<td>
<p>demand, China, soar, major, energy, Russia, cu...</p>
</td>
<td>
<p>Russia And Saudi Arabia Consider Even Deeper O...</p>
</td>
</tr>
<tr>
<th>
<p>4</p>
</th>
<td>
<p>2.0</p>
</td>
<td>
<p>0.2874</p>
</td>
<td>
<p>market, big, see, production, stock, gas, Indu...</p>
</td>
<td>
<p>Energy Storage Tech Finally Starting To Compet...</p>
</td>
</tr>
<tr>
<th>
<p>5</p>
</th>
<td>
<p>2.0</p>
</td>
<td>
<p>0.2840</p>
</td>
<td>
<p>market, big, see, production, stock, gas, Indu...</p>
</td>
<td>
<p>Is The Bottom Finally In Sight For U.S. Drilli...</p>
</td>
</tr>
<tr>
<th>
<p>6</p>
</th>
<td>
<p>3.0</p>
</td>
<td>
<p>0.2920</p>
</td>
<td>
<p>price, Gas, OPEC, Iran, high, boom, Rig, Count...</p>
</td>
<td>
<p>New Pipeline from Kurdistan to Turkey Poses Ri...</p>
</td>
</tr>
<tr>
<th>
<p>7</p>
</th>
<td>
<p>3.0</p>
</td>
<td>
<p>0.2902</p>
</td>
<td>
<p>price, Gas, OPEC, Iran, high, boom, Rig, Count...</p>
</td>
<td>
<p>The Quiet Revolution: Latin America Moving Awa...</p>
</td>
</tr>
</tbody>
</table></li>
<li><p>Topic distribution across documents, see Table 13:</p>
<center>
<p>Table 13 Topic distribution across documents</p>
</center>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
<p>Dominant_Topic</p>
</th>
<th>
<p>Topic_Keywords</p>
</th>
<th>
<p>Num_Documents</p>
</th>
<th>
<p>Perc_Documents</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
<p>0</p>
</th>
<td>
<p>0.0</p>
</td>
<td>
<p>U.S., Energy, Saudi, rise, Shale, Crude, Arabi...</p>
</td>
<td>
<p>10673</p>
</td>
<td>
<p>0.4391</p>
</td>
</tr>
<tr>
<th>
<p>1</p>
</th>
<td>
<p>3.0</p>
</td>
<td>
<p>price, Gas, OPEC, Iran, high, boom, Rig, Count...</p>
</td>
<td>
<p>4010</p>
</td>
<td>
<p>0.1650</p>
</td>
</tr>
<tr>
<th>
<p>2</p>
</th>
<td>
<p>2.0</p>
</td>
<td>
<p>market, big, see, production, stock, gas, Indu...</p>
</td>
<td>
<p>4030</p>
</td>
<td>
<p>0.1658</p>
</td>
</tr>
<tr>
<th>
<p>3</p>
</th>
<td>
<p>1.0</p>
</td>
<td>
<p>demand, China, soar, major, energy, Russia, cu...</p>
</td>
<td>
<p>5595</p>
</td>
<td>
<p>0.2302</p>
</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p>Evaluation</p>
<ul>
<li><p>Compute the perplexity.</p>
<pre><code>Perplexity:  -11.663989584579646</code></pre></li>
</ul></li>
<li><p>Visualization</p>
<p>We can visualize the LDA model with the help of <code>pyLDAvis</code> module, a Python library, see Fig. 5.</p>
<p><img src="https://z3.ax1x.com/2021/09/01/hwsPud.png" alt="png" style="zoom:80%;" /></p>
<center>
<p>Fig.5 Visualization of LDA model</p>
</center></li>
</ol>
]]></content>
      <categories>
        <category>Thesis</category>
        <category>Prediction</category>
      </categories>
      <tags>
        <tag>Prediction</tag>
        <tag>NLP</tag>
      </tags>
  </entry>
</search>
